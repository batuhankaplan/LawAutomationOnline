{% extends "layout.html" %}

{% block title %}Dosya Sorgula{% endblock %}

{% block content %}
<header>
    <div class="header-left">
        <h1>Dosya Sorgula</h1>
    </div>
</header>

<div class="inbox">
    <form method="POST" class="search-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-columns">
            <!-- Sol Sütun -->
            <div class="form-column">
                <div class="input-group">
                    <label for="file-type">Dosya Türü</label>
                    <select id="file-type" name="file-type" onchange="handleFileTypeChange()">
                        <option value="">Tümü</option>
                        <option value="hukuk" {{ 'selected' if request.args.get('file_type') == 'hukuk' else '' }}>Hukuk</option>
                        <option value="ceza" {{ 'selected' if request.args.get('file_type') == 'ceza' else '' }}>Ceza</option>
                        <option value="icra" {{ 'selected' if request.args.get('file_type') == 'icra' else '' }}>İcra</option>
                        <option value="savcilik" {{ 'selected' if request.args.get('file_type') == 'savcilik' else '' }}>Savcılık</option>
                        <option value="ARABULUCULUK" {{ 'selected' if request.args.get('file_type') == 'ARABULUCULUK' else '' }}>Arabuluculuk</option>
                        <option value="AİHM" {{ 'selected' if request.args.get('file_type') == 'AİHM' else '' }}>AİHM</option>
                        <option value="AYM" {{ 'selected' if request.args.get('file_type') == 'AYM' else '' }}>AYM</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="city">Şehir</label>
                    <select id="city" name="city" onchange="updateCourthouses()">
                        <option value="">Tümü</option>
                        {% for city_name in cities %}
                            <option value="{{ city_name }}">{{ city_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="courthouse">Adliye</label>
                    <select id="courthouse" name="courthouse">
                        <option value="">Tümü</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="department">Mahkeme</label>
                    <select id="department" name="department" onchange="updateCourtNumbers(this.value)">
                        <option value="">Tümü</option>
                    </select>
                </div>

                <div class="input-group" id="court-number-container">
                    <label for="court-number">Numaralı Mahkeme</label>
                    <select id="court-number" name="court-number">
                        <option value="">Tümü</option>
                    </select>
                </div>
            </div>
            
            <!-- Sağ Sütun -->
            <div class="form-column">
                <div class="form-row">
                    <div class="input-group">
                        <label for="year">Yıl</label>
                        <input type="number" id="year" name="year">
                    </div>
                    <div class="input-group">
                        <label for="case-number">Esas No</label>
                        <input type="text" id="case-number" name="case-number">
                    </div>
                </div>
                <div class="input-group">
                    <label for="client-name">Müvekkil Adı</label>
                    <input type="text" id="client-name" name="client-name">
                </div>
                <div class="input-group">
                    <label for="status">Dosya Durumu</label>
                    <select id="status" name="status">
                        <option value="">Tümü</option>
                        <option value="Aktif" {{ 'selected' if request.args.get('status') == 'Aktif' else '' }}>Aktif</option>
                        <option value="Kapalı" {{ 'selected' if request.args.get('status') == 'Kapalı' else '' }}>Kapalı</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="search-button-container">
            <button type="submit" class="btn">Ara</button>
        </div>
    </form>
</div>

<table class="modern-table" id="casesTable">
    <thead>
        <tr>
            <th class="sortable" data-sort="file_type">
                Dosya Türü
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="year">
                Yıl
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="case_number">
                Esas No
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="client_name">
                Müvekkil Adı
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="open_date">
                Açılış Tarihi
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="status">
                Durum
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th>İşlemler</th>
        </tr>
    </thead>
    <tbody>
        {% for case_file in case_files %}
        <tr data-case-id="{{ case_file.id }}">
            <td class="case-type">
                <div class="file-type-details">
                    <div class="main-type">{{ case_file.file_type|title }}</div>
                    <div class="sub-details">
                        {% if case_file.file_type not in ['AİHM', 'AYM', 'ARABULUCULUK'] and case_file.courthouse %}
                        <small>{{ case_file.courthouse }}</small>
                        {% endif %}
                        {% if case_file.file_type not in ['AİHM', 'AYM', 'ARABULUCULUK', 'savcilik'] and case_file.department %}
                        <small>{{ case_file.department }}</small>
                        {% endif %}
                    </div>
                </div>
            </td>
            <td>{{ case_file.year }}</td>
            <td class="case-number">{{ case_file.case_number }}</td>
            <td class="client-name">{{ case_file.client_name }}</td>
            <td class="open-date">
                {% if case_file.open_date %}
                    {{ case_file.open_date.strftime('%d.%m.%Y') }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                <span class="case-status status-text {% if case_file.status == 'Aktif' %}status-active{% else %}status-closed{% endif %}">
                    {{ case_file.status }}
                </span>
            </td>
            <td>
                <button class="action-btn view-btn" onclick="showDetails('{{ case_file.id }}')" title="Dosya Detayları">
                    <i class="material-icons">visibility</i>
                </button>
                {% if current_user.has_permission('dosya_sil') %}
                <span class="separator-line">|</span>
                <button class="action-btn delete-btn" onclick="deleteCase('{{ case_file.id }}')" title="Dosyayı Sil">
                    <i class="material-icons">delete</i>
                </button>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Dosya Detay Modalı -->
<div id="fileDetailModal" class="file-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Dosya Detayları</h2>
            <button class="close-btn" onclick="closeDetailModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Üst Bilgiler Container -->
            <div class="top-info-container">
                <!-- Dosya Bilgileri -->
                <div class="detail-section basic-info">
                    <div class="section-header">
                        <h3><i class="material-icons">folder</i> Dosya Bilgileri</h3>
                    </div>
                    <!-- Görüntüleme modu -->
                    <div id="fileInfoDisplay">
                        <div class="info-row">
                            <div class="info-group">
                                <label>DOSYA TÜRÜ</label>
                                <span id="detailFileType"></span>
                            </div>
                            <div class="info-group">
                                <label>YIL</label>
                                <span id="detailYear"></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>ESAS NO</label>
                                <span id="detailCaseNumber"></span>
                            </div>
                            <div class="info-group">
                                <label>AÇILIŞ TARİHİ</label>
                                <span id="detailOpenDate"></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>ŞEHİR</label>
                                <span id="detailCity"></span>
                            </div>
                            <div class="info-group">
                                <label>ADLİYE</label>
                                <span id="detailCourthouse"></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>MAHKEME</label>
                                <span id="detailDepartment"></span>
                            </div>
                            <div class="info-group">
                                <label>DURUM</label>
                                <span id="detailStatus"></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group full-width">
                                <label>SONRAKİ DURUŞMA</label>
                                <div class="hearing-info">
                                    <span id="detailNextHearing"></span>
                                    <span class="hearing-separator">-</span>
                                    <span id="detailHearingTime"></span>
                                    <span class="hearing-separator">-</span>
                                    <span id="detailHearingType"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Düzenleme modu -->
                    <div id="fileInfoEdit" class="hidden-edit-mode">
                        <div class="info-row">
                            <div class="info-group">
                                <label>DOSYA TÜRÜ</label>
                                <select id="editFileType" onchange="updateEditFileType()">
                                    <option value="hukuk">Hukuk</option>
                                    <option value="ceza">Ceza</option>
                                    <option value="icra">İcra</option>
                                    <option value="savcilik">Savcılık</option>
                                    <option value="ARABULUCULUK">Arabuluculuk</option>
                                    <option value="AİHM">AİHM</option>
                                    <option value="AYM">AYM</option>
                                </select>
                            </div>
                            <div class="info-group">
                                <label>YIL</label>
                                <input type="number" id="editYear" min="2000" max="2050">
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>ESAS NO</label>
                                <input type="text" id="editCaseNumber" placeholder="Esas numarası">
                            </div>
                            <div class="info-group">
                                <label>AÇILIŞ TARİHİ</label>
                                <input type="date" id="editOpenDate">
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>ŞEHİR</label>
                                <select id="editCity" onchange="updateEditCourthouse()">
                                    <option value="">Seçiniz</option>
                                </select>
                            </div>
                            <div class="info-group">
                                <label>ADLİYE</label>
                                <select id="editCourthouse">
                                    <option value="">Önce şehir seçiniz</option>
                                </select>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>MAHKEME</label>
                                <select id="editDepartment">
                                    <option value="">Seçiniz</option>
                                </select>
                            </div>
                            <div class="info-group">
                                <label>DURUM</label>
                                <select id="editStatus">
                                    <option value="Aktif">Aktif</option>
                                    <option value="Kapalı">Kapalı</option>
                                    <option value="Beklemede">Beklemede</option>
                                </select>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>SONRAKİ DURUŞMA</label>
                                <input type="date" id="editNextHearing">
                            </div>
                            <div class="info-group">
                                <label>DURUŞMA SAATİ</label>
                                <input type="time" id="editHearingTime">
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>DURUŞMA TÜRÜ</label>
                                <select id="editHearingType">
                                    <option value="durusma">Normal Duruşma</option>
                                    <option value="e-durusma">E-Duruşma</option>
                                </select>
                            </div>
                        </div>
                        <div class="file-info-actions">
                            <button class="btn secondary" onclick="cancelFileInfoEdit()">İptal</button>
                            {% if current_user.has_permission('dosya_duzenle') %}
                            <button class="btn primary" onclick="saveFileInfo()">Kaydet</button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Müvekkil Bilgileri -->
                <div class="detail-section client-info-compact">
                    <h3><i class="material-icons">person</i> Müvekkil Bilgileri</h3>
                    
                    <!-- Ana Müvekkil - Katlanabilir -->
                    <div class="collapsible-person-card">
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">person</i>
                                <div class="person-info">
                                    <div class="person-title main-client-title">Müvekkil Bilgileri</div>
                                    <div class="person-subtitle" id="mainClientSubtitle"></div>
                                </div>
                            </div>
                            <i class="material-icons collapse-arrow">expand_more</i>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value" id="detailClientEntityType"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value" id="detailClientCapacity"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value" id="detailPhoneNumber"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value" id="detailClientIdentityNumber"></span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value" id="detailClientAddress"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ek Müvekkiller -->
                    <div id="additionalClientsDisplay" class="additional-display">
                        <!-- Dinamik olarak eklenecek -->
                    </div>
                </div>

                <!-- Karşı Taraf Bilgileri -->
                <div class="detail-section">
                    <h3><i class="material-icons">group</i> Karşı Taraf Bilgileri</h3>
                    
                    <!-- Ana Karşı Taraf - Katlanabilir -->
                    <div class="collapsible-person-card">
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">group</i>
                                <div class="person-info">
                                    <div class="person-title main-opponent-title">Karşı Taraf Bilgileri</div>
                                    <div class="person-subtitle" id="mainOpponentSubtitle"></div>
                                </div>
                            </div>
                            <i class="material-icons collapse-arrow">expand_more</i>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value" id="detailOpponentEntityType"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value" id="detailOpponentCapacity"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value" id="detailOpponentPhone"></span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value" id="detailOpponentIdentityNumber"></span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value" id="detailOpponentAddress"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ek Karşı Taraflar -->
                    <div id="additionalOpponentsDisplay" class="additional-display">
                        <!-- Dinamik olarak eklenecek -->
                    </div>
                    
                    <!-- Vekil Bilgileri -->
                    <div id="lawyersDisplay" class="additional-display">
                        <!-- Dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Dosya Açıklaması -->
            <div class="detail-section description-section">
                <div class="section-header">
                    <h3>Dosya Açıklaması</h3>
                    {% if current_user.has_permission('dosya_duzenle') %}
                    <button class="edit-description-btn" onclick="editDescription()" title="Açıklamayı Düzenle">
                        <i class="material-icons">edit</i>
                    </button>
                    {% endif %}
                </div>
                <div class="description-container">
                    <div id="descriptionDisplay">
                        <div class="description-content">
                            <p id="detailDescription">Açıklama bulunmuyor.</p>
                        </div>
                    </div>
                    <div id="descriptionEdit" class="hidden-edit-mode">
                        <textarea id="editDescriptionText" rows="4" class="description-textarea"></textarea>
                        <div class="description-actions">
                            <button class="btn secondary" onclick="cancelEditDescription()">İptal</button>
                            {% if current_user.has_permission('dosya_duzenle') %}
                            <button class="btn primary" onclick="saveDescription()">Kaydet</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alt Bölümler Container - Yan Yana -->
            <div class="bottom-sections-container">
                <!-- Belgeler (Sol Taraf) -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>Belgeler</h3>
                        <button class="btn primary" onclick="showUploadModal()">
                            <i class="material-icons">upload</i> Belge Yükle
                        </button>
                    </div>

                    <!-- Belgeler kontrol paneli -->
                    <div class="documents-control-panel">
                        <!-- Sıralama seçenekleri -->
                        <div class="sorting-options">
                            <label for="documentSortBy">Sıralama:</label>
                            <select id="documentSortBy" onchange="sortDocuments()">
                                <option value="date">Tarihe Göre (Varsayılan)</option>
                                <option value="alphabetic">Alfabetik</option>
                            </select>
                        </div>
                    </div>

                    <!-- Son Yüklenen 10 Belge -->
                    <div class="recent-documents-section">
                        <div class="document-type-header-group" onclick="toggleRecentDocuments()">
                            <h4>Son Yüklenen 10 Belge</h4>
                            <span class="dropdown-arrow">▼</span>
                        </div>
                        <div class="document-type-content" id="recentDocuments" style="display: block;">
                            <!-- Son 10 belge buraya yüklenecek -->
                        </div>
                    </div>

                    <div id="documentsList" class="documents-list"></div>
                </div>

                <!-- Masraflar (Sağ Taraf) -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>Masraflar</h3>
                        <button class="btn primary" onclick="showExpenseModal()">
                            <i class="material-icons">add</i> Masraf Ekle
                        </button>
                    </div>

                    <!-- Masraflar sıralama seçenekleri -->
                    <div class="expenses-control-panel">
                        <div class="sorting-options">
                            <label for="expenseSortBy">Sıralama:</label>
                            <select id="expenseSortBy" onchange="sortExpenses()">
                                <option value="date">Tarihe Göre (Varsayılan)</option>
                                <option value="alphabetic">Alfabetik</option>
                            </select>
                        </div>
                    </div>

                    <div id="editExpensesList" class="expenses-list"></div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" onclick="closeDetailModal()">Kapat</button>
            {% if current_user.has_permission('dosya_duzenle') %}
            <button class="btn primary" onclick="editCase(currentCaseId)">Düzenle</button>
            {% endif %}
        </div>
    </div>
</div>

<style>
/* Inline stiller için CSS sınıfları */
.separator-line {
    color: #dee2e6;
    margin: 0 8px;
}

.hidden-edit-mode {
    display: none;
}

/* Modal ana stilleri */
.file-detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

/* Sadece alt modallar için animasyonlar */
@keyframes modalFadeIn {
    from {
        opacity: 0;
        -webkit-backdrop-filter: blur(0px);
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        -webkit-backdrop-filter: blur(8px);
        backdrop-filter: blur(8px);
    }
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Sadece expense ve upload modalları için animasyonlar */
.modal-content.expense-modal,
.modal-content.upload-modal {
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    transform-origin: center center;
}

/* Sadece expense ve upload modalları için hover efektleri */
.modal-content.expense-modal:hover,
.modal-content.upload-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
}

/* Masraf ve belge ekleme butonlarına özel animasyonlar */
.modal-content.expense-modal .expense-group,
.modal-content.upload-modal .detail-group {
    animation: slideInUp 0.3s ease-out;
    animation-fill-mode: both;
}

.modal-content.expense-modal .expense-group:nth-child(1) { animation-delay: 0.1s; }
.modal-content.expense-modal .expense-group:nth-child(2) { animation-delay: 0.15s; }
.modal-content.expense-modal .expense-group:nth-child(3) { animation-delay: 0.2s; }
.modal-content.expense-modal .expense-group:nth-child(4) { animation-delay: 0.25s; }
.modal-content.expense-modal .expense-group:nth-child(5) { animation-delay: 0.3s; }

.modal-content.upload-modal .detail-group:nth-child(1) { animation-delay: 0.1s; }
.modal-content.upload-modal .detail-group:nth-child(2) { animation-delay: 0.15s; }
.modal-content.upload-modal .detail-group:nth-child(3) { animation-delay: 0.2s; }

@keyframes slideInUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Loading animation for buttons */
@keyframes rotate {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

.rotating {
    animation: rotate 1s linear infinite;
}

.modal-content {
    background: white;
    width: 95%;
    max-width: 1400px;
    max-height: 90vh;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: #2c3e50;
    font-weight: 600;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Üst bilgiler container - yan yana yerleşim */
.top-info-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

@media (max-width: 1300px) {
    .top-info-container {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 768px) {
    .top-info-container {
        grid-template-columns: 1fr;
    }
}

/* Temel bilgiler bölümü */
.basic-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

.info-row {
    display: flex;
    gap: 15px;
    margin-bottom: 12px;
}

.info-row:last-child {
    margin-bottom: 0;
}

/* Yeni column yapısı */
.info-column-left,
.info-column-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.info-column-left {
    margin-right: 15px;
}

.info-column-right {
    margin-left: 15px;
}

.info-group {
    flex: 1;
    min-width: 0;
}

.info-group.full-width {
    flex: 2;
    grid-column: span 2;
}

.info-group.full-width span {
    white-space: normal;
    max-height: 3em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
}

.info-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-group span {
    display: block;
    font-size: 0.95rem;
    color: #2c3e50;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    word-wrap: break-word;
}

/* Duruşma bilgileri için özel stiller */
.hearing-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
    flex-wrap: nowrap;
}

.hearing-info span {
    color: #2c3e50;
    font-weight: normal;
    white-space: nowrap;
    flex-shrink: 0;
}

.hearing-separator {
    color: #6c757d !important;
    font-weight: normal !important;
    flex-shrink: 0;
}

/* Durum için özel stiller */
.file-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
}

.file-status.active {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.file-status.closed {
    background-color: #ffebee;
    color: #c62828;
}

/* Bölüm başlıkları */
.detail-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

/* Müvekkil bilgileri için kompakt stil */
.detail-section.client-info-compact {
    padding: 12px;
    max-width: 95%;
}

.detail-section.client-info-compact .info-row {
    margin-bottom: 10px;
}

.detail-section.client-info-compact .info-group {
    min-width: 0;
}

.detail-section.client-info-compact .info-group label {
    font-size: 0.75rem;
    margin-bottom: 3px;
}

.detail-section.client-info-compact .info-group span {
    font-size: 0.9rem;
    line-height: 1.3;
}

/* Açıklama bölümü için özel stil */
.detail-section.description-section {
    margin-bottom: 30px;
}

/* Alt bölümler için yan yana container */
.bottom-sections-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

/* Alt bölümlerde detail-section margin'larını düzenle */
.bottom-sections-container .detail-section {
    margin-bottom: 0;
}

/* Mobil responsive */
@media (max-width: 768px) {
    .info-column-left,
    .info-column-right {
        margin-left: 0;
        margin-right: 0;
        gap: 8px;
    }
    
    .info-row {
        flex-direction: column;
        gap: 0;
    }
}

@media (max-width: 1024px) {
    .bottom-sections-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}

/* EDIT MODAL İÇİN EK STİLLER */

/* Ana kişi kartları için özel stiller */
.main-person-card {
    border: 2px solid #e9ecef;
    margin-bottom: 15px;
}

.main-person-card .collapsible-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
}

/* Gizli edit formları */
.hidden-edit-form {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
}

.edit-form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #dee2e6;
}

/* Dosya bilgileri düzenleme stiller */
.file-info-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.file-info-actions .btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

.file-info-actions .btn.primary {
    background: #1a237e;
    color: white;
}

.file-info-actions .btn.primary:hover {
    background: #0d1b6e;
}

.file-info-actions .btn.secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 1px solid #dee2e6;
}

.file-info-actions .btn.secondary:hover {
    background: #e9ecef;
}

#fileInfoEdit .info-group input,
#fileInfoEdit .info-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9rem;
    background: white;
    transition: border-color 0.2s ease;
}

#fileInfoEdit .info-group input:focus,
#fileInfoEdit .info-group select:focus {
    outline: none;
    border-color: #1a237e;
    box-shadow: 0 0 0 2px rgba(26, 35, 126, 0.1);
}

/* Section header için stiller */
.basic-info .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.basic-info .section-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1.1rem;
    color: #2c3e50;
    font-weight: 600;
}

.basic-info .section-header .edit-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.basic-info .section-header .edit-btn:hover {
    background: rgba(26, 35, 126, 0.1);
    color: #1a237e;
}

.basic-info .section-header .edit-btn i {
    font-size: 18px;
}

/* Düzenleme modalı için özel buton stiller */
.btn-icon-small {
    background: none;
    border: none;
    padding: 4px;
    margin: 0 2px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.btn-icon-small:hover {
    background-color: rgba(0, 0, 0, 0.1);
}

.btn-icon-small.edit {
    color: #007bff;
}

.btn-icon-small.edit:hover {
    background-color: rgba(0, 123, 255, 0.1);
}

.btn-icon-small.delete {
    color: #dc3545;
}

.btn-icon-small.delete:hover {
    background-color: rgba(220, 53, 69, 0.1);
}

.btn-icon-small i {
    font-size: 16px;
}

/* Card actions container */
.card-actions {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Collapse arrow özel stil */
.collapse-arrow {
    transition: transform 0.3s ease;
    margin-left: 10px;
    color: #6c757d;
}

/* Editable person card özel stiller */
.editable-person-card .collapsible-content {
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
    padding: 0 18px;
}

.editable-person-card .collapsible-content.open {
    max-height: 400px;
    padding: 18px;
}

/* Lawyer card özel renk teması */
.lawyer-card {
    background: #fff9e6;
    border-color: #ffc107;
}

.lawyer-card .collapsible-header {
    background: linear-gradient(135deg, #fff9e6 0%, #ffecb3 100%);
    border-bottom-color: #ffc107;
}

.lawyer-card .person-icon.lawyer-icon {
    color: #ffc107;
}

/* Vekil ekleme butonu */
.add-lawyer-btn-container {
    text-align: center;
    padding: 20px;
}

.add-lawyer-btn-container .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

/* Edit section düzenlemesi */
.edit-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
}

.edit-info-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .edit-info-container {
        grid-template-columns: 1fr;
    }
}

/* YENİ - Katlanabilir Person Card Stilleri */
.collapsible-person-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 10px;
    margin-bottom: 12px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
    transition: all 0.3s ease;
}

.collapsible-person-card:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.12);
    transform: translateY(-1px);
}

.collapsible-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 14px 18px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.2s ease;
    border-bottom: 1px solid #e9ecef;
}

.collapsible-header:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
}

.collapsible-title {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
}

.person-icon {
    background: #1a237e;
    color: white;
    padding: 6px;
    border-radius: 6px;
    font-size: 18px !important;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.person-info {
    flex: 1;
}

.person-title {
    font-weight: 600;
    color: #2c3e50;
    font-size: 0.95rem;
    margin-bottom: 2px;
}

.person-subtitle {
    font-size: 0.8rem;
    color: #6c757d;
    font-style: italic;
}

.collapse-arrow {
    color: #6c757d;
    font-size: 20px;
    transition: all 0.3s ease;
}

.collapsible-content {
    max-height: 0;
    overflow: hidden;
    background: #fafbfc;
    transition: all 0.3s ease;
    padding: 0 18px;
}

.collapsible-content.open {
    max-height: 250px;
    padding: 18px;
}

.detail-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
}

.detail-info-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-info-item.full-width {
    grid-column: 1 / -1;
}

.detail-info-label {
    font-size: 0.7rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-info-value {
    font-size: 0.85rem;
    color: #2c3e50;
    word-wrap: break-word;
    line-height: 1.4;
}

/* Additional display container */
.additional-display {
    margin-top: 16px;
}

.additional-display:empty {
    display: none;
}

/* Vekil bilgileri için özel stil */
.lawyer-info-section {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.lawyer-info-section .detail-info-item:first-child {
    margin-top: 0;
}

.lawyer-info-section .detail-info-label {
    color: #856404;
    font-weight: 600;
}

.lawyer-info-section .detail-info-label::before {
    content: '⚖️ ';
    margin-right: 4px;
}

/* Vekil kartları için farklı renk teması */
.lawyer-card {
    border-color: #d4a574;
}

.lawyer-card .collapsible-header {
    background: linear-gradient(135deg, #fef7ef 0%, #f8ead4 100%);
    border-bottom-color: #d4a574;
}

.lawyer-card .collapsible-header:hover {
    background: linear-gradient(135deg, #f8ead4 0%, #f0d7a8 100%);
}

.lawyer-card .collapsible-content {
    background: #fefbf7;
}

.lawyer-card .lawyer-icon {
    background: #d4a574;
    color: white;
}

.lawyer-card:hover {
    box-shadow: 0 4px 10px rgba(212, 165, 116, 0.2);
}

/* Düzenlenebilir person card butonları */
.card-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-icon-small {
    background: none;
    border: none;
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    color: #6c757d;
}

.btn-icon-small:hover {
    background: #e9ecef;
    color: #495057;
}

.btn-icon-small.edit:hover {
    background: #e3f2fd;
    color: #1976d2;
}

.btn-icon-small.delete:hover {
    background: #ffebee;
    color: #d32f2f;
}

.btn-icon-small i {
    font-size: 16px;
}

.editable-person-card .collapsible-header {
    justify-content: space-between;
}

/* Responsive iyileştirmeler */
@media (max-width: 768px) {
    .detail-info-grid {
        grid-template-columns: 1fr;
    }
    
    .collapsible-header {
        padding: 12px 15px;
    }
    
    .collapsible-title {
        gap: 10px;
    }
    
    .person-icon {
        width: 26px;
        height: 26px;
        font-size: 16px !important;
    }
    
    .person-title {
        font-size: 0.9rem;
    }
    
    .person-subtitle {
        font-size: 0.75rem;
    }
}

/* Edit modal için bilgiler container */
.edit-info-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.edit-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

@media (max-width: 768px) {
    .edit-info-container {
        grid-template-columns: 1fr;
    }
}

/* Section header with add button */
.section-header-with-add {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.section-header-with-add h3 {
    margin: 0;
}

.btn-add-person {
    background: none;
    color: #1a237e;
    border: none;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.btn-add-person:hover {
    background: rgba(26, 35, 126, 0.1);
    transform: translateY(-1px);
    color: #0d1b6e;
}

.btn-add-person i {
    font-size: 20px;
    font-weight: bold;
}

.detail-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn.primary {
    background: #1a237e;
    color: white;
}

.btn.primary:hover {
    background: #0d1b6e;
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Modal footer */
.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* Butonlar için yeni renk */
:root {
    --primary-blue: #2d313c;  /* Ana tema rengi */
    --primary-hover: #3c404d;
    --light-blue-bg: #f5f5f6;
}

/* Düzenleme modalı için stiller - Dosya detayları gibi */
#editModal .modal-content {
    background: white;
    width: 95%;
    max-width: 1400px;
    max-height: 95vh;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    overflow: hidden;
}

/* Modal header - Dosya detayları modalı ile uyumlu */
#editModal .modal-header {
    background: #f8f9fa;
    color: #2c3e50;
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 12px 12px 0 0;
}

#editModal .modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: #2c3e50;
}

#editModal .modal-header .close-btn {
    background: #e9ecef;
    border: none;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

#editModal .modal-header .close-btn:hover {
    background: #dee2e6;
}

#editModal .modal-header .close-btn .material-icons {
    color: #6c757d;
    font-size: 20px;
}

#editModal .modal-body {
    padding: 25px 30px;
    overflow-y: auto;
    flex: 1;
    background: #f8f9fa;
}

#editModal .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#editModal .detail-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#editModal .detail-group.full-width {
    grid-column: span 2;
}

#editModal .detail-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

#editModal .detail-group input,
#editModal .detail-group select,
#editModal .detail-group textarea {
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #2c3e50;
    background: white;
    transition: all 0.2s ease;
}

#editModal .detail-group input:focus,
#editModal .detail-group select:focus,
#editModal .detail-group textarea:focus {
    border-color: #1a237e;
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

/* Edit sections styling */
#editModal .edit-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#editModal .edit-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal .edit-section h3 .material-icons {
    color: #1a237e;
    font-size: 20px;
}

#editModal textarea {
    min-height: 80px;
    resize: vertical;
}

/* Modal footer */
#editModal .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: white;
}

/* Dosya bilgileri bölümü için özel başlık */
#editModal h3:has(.material-icons) {
    font-size: 1.2rem;
    color: #2c3e50;
    margin: 25px 0 15px 0;
    padding: 15px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal h3 .material-icons {
    color: #1a237e;
    font-size: 24px;
}

/* Butonları güncelle */
.btn.primary {
    background: var(--primary-blue) !important;
    color: white !important;
}

.btn.primary:hover {
    background: var(--primary-hover) !important;
}

/* Masraf Ekle ve Belge Yükle butonlarındaki ikonları beyaz yap */
.btn.primary .material-icons {
    color: white !important;
}

/* Duruşma tarihi ve saati için özel stil */
.hearing-datetime {
    display: flex;
    gap: 10px;
}

.hearing-datetime input[type="date"] {
    flex: 2;
}

.hearing-datetime input[type="time"] {
    flex: 1;
}

/* Aktif/Kapalı durumu için badge stilleri */
.status-badge {
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-badge.active {
    background: #E8F5E9;
    color: #2E7D32;
}

.status-badge.closed {
    background: #FFEBEE;
    color: #C62828;
}

/* Modal header ve footer */
.modal-header, .modal-footer {
    background: #f8f9fa;
    padding: 20px 25px;
}

.modal-header {
    border-radius: 12px 12px 0 0;
}

.modal-footer {
    border-radius: 0 0 12px 12px;
}

/* Masraflar bölümü stilleri */
.expenses-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.expense-info {
    display: grid;
    grid-template-columns: auto auto auto 1fr;
    gap: 20px;
    align-items: start;
}

.expense-type {
    font-weight: 500;
    color: #2c3e50;
}

.expense-amount {
    color: #2d313c;
    font-weight: 600;
}

.expense-date {
    color: #6c757d;
    font-size: 0.9rem;
}

.expense-description {
    color: #495057;
    font-size: 0.9rem;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    line-height: 1.4;
}

/* Belge kontrol paneli stilleri */
.documents-control-panel {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

/* Masraflar kontrol paneli stilleri */
.expenses-control-panel {
    margin-bottom: 20px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.recent-documents-dropdown {
    position: relative;
}

.dropdown-toggle {
    width: 100%;
    padding: 10px 15px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #333;
    transition: all 0.3s ease;
}

.dropdown-toggle:hover {
    background: #f0f0f0;
    border-color: #3f51b5;
}

.dropdown-arrow {
    margin-left: auto;
    transition: transform 0.3s ease;
}

.dropdown-toggle.active .dropdown-arrow {
    transform: rotate(180deg);
}

.dropdown-content {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
}

.recent-document-item {
    padding: 10px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: background 0.2s ease;
}

.recent-document-item:hover {
    background: #f0f0f0;
}

.recent-document-item:last-child {
    border-bottom: none;
}

.sorting-options {
    display: flex;
    align-items: center;
    gap: 10px;
}

.sorting-options label {
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.sorting-options select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
    font-size: 14px;
    color: #333;
    cursor: pointer;
}

/* Son yüklenen belgeler bölümü */
.recent-documents-section {
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

/* Belge türü grupları stilleri */
.document-type-group {
    margin-bottom: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

.document-type-header-group {
    background: #3f51b5;
    color: white;
    padding: 12px 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    user-select: none;
    transition: background-color 0.2s ease;
}

.document-type-header-group:hover {
    background: #303f9f;
}

.document-type-header-group h4 {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
}

.document-type-content {
    background: white;
}

/* Belge listesi stilleri */
.documents-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.document-item {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    overflow: hidden;
    transition: background-color 0.2s ease;
}

.document-item:last-child {
    border-bottom: none;
}

.document-item:hover {
    background: #e3f2fd;
}


.document-content {
    padding: 15px;
}

.document-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
}

.document-info {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    min-width: 0;
    flex: 1;
}

.document-info i {
    color: #2196F3;
    font-size: 24px;
}

.document-details { 
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 0;
}

.document-name,
.document-original-name {
    font-weight: 500;
    color: #2c3e50;
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
    line-height: 1.4;
}


.document-actions {
    display: flex;
    gap: 8px;
}

.document-right-section {
    display: flex;
    align-items: center;
    gap: 15px;
}

.document-date {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    min-width: 80px;
    text-align: right;
}

.document-actions .btn {
    padding: 6px;
}

.document-actions .btn i {
    font-size: 20px;
}

/* Modern Tablo Stilleri */
.modern-table {
    width: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    overflow: hidden;
    margin-top: 20px;
    border-collapse: separate;
    border-spacing: 0;
}

.modern-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modern-table th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    border: none;
    position: relative;
}

.modern-table th.sortable {
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    transition: background-color 0.2s ease;
}

.modern-table th.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.modern-table th.sort-asc .sort-icon {
    transform: translateY(-50%) rotate(180deg);
    opacity: 1;
}

.modern-table th.sort-desc .sort-icon {
    transform: translateY(-50%) rotate(0deg);
    opacity: 1;
}

.modern-table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f1f5f9;
}

.modern-table tbody tr:hover {
    background-color: #f8fafc;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.modern-table tbody tr:last-child {
    border-bottom: none;
}

.modern-table td {
    padding: 16px 20px;
    vertical-align: middle;
    border: none;
    font-size: 14px;
    color: #1e293b;
}

.case-type .main-type {
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 4px;
}

.case-type .sub-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.case-type .sub-details small {
    color: #64748b;
    font-size: 12px;
}

.case-number {
    font-weight: 600;
    color: #059669;
    font-family: 'Courier New', monospace;
}

.client-name {
    font-weight: 500;
    color: #374151;
}

.status-text {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.status-closed {
    background: #fee2e2;
    color: #991b1b;
}

.action-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background-color: #f1f5f9;
    transform: scale(1.1);
}

.view-btn {
    color: #3b82f6;
}

.delete-btn {
    color: #ef4444;
}

/* Açıklama bölümü stilleri */
.description-container {
    position: relative;
}

.edit-btn {
    background: none;
    border: none;
    padding: 4px;
    color: #757575;
    transition: all 0.2s ease;
}

.edit-btn:hover {
    color: var(--primary-blue);
}

.edit-btn i {
    font-size: 20px;
}

.edit-description-btn {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.edit-description-btn:hover {
    background: rgba(26, 35, 126, 0.1);
    color: #1a237e;
}

.edit-description-btn i {
    font-size: 18px;
}

.description-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #2c3e50;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 10px;
}

.description-textarea:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.description-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}

#detailDescription {
    margin: 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    min-height: 100px;
}

.action-btn {
    background: none;
    border: none;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.action-btn i {
    font-size: 20px;
}

.view-btn {
    color: #2196F3;
}

.view-btn:hover {
    color: #1976D2;
}

.delete-btn {
    color: #757575;
}

.delete-btn:hover {
    color: #dc3545;
}

/* Masraf ve Belge Yükle Modalları - Sade Tasarım */
.modal-content.expense-modal,
.modal-content.upload-modal {
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    background: white;
}

/* Sadece alt modallar (expense ve upload) için header tasarımı */
.modal-content.expense-modal .modal-header,
.modal-content.upload-modal .modal-header {
    background: #f8fafc;
    color: #374151;
    padding: 20px 24px;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #e2e8f0;
}

.modal-content.expense-modal .modal-header h2,
.modal-content.upload-modal .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-blue);
}

.modal-content.expense-modal .modal-header .close-btn,
.modal-content.upload-modal .modal-header .close-btn {
    background: none;
    border: none;
    width: 32px;
    height: 32px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content.expense-modal .modal-header .close-btn:hover,
.modal-content.upload-modal .modal-header .close-btn:hover {
    background: #f1f5f9;
    color: #374151;
}

.modal-content.expense-modal .modal-body,
.modal-content.upload-modal .modal-body {
    padding: 24px;
    background: white;
}

.modal-content.expense-modal .modal-footer,
.modal-content.upload-modal .modal-footer {
    padding: 16px 24px;
    background: #f8fafc;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Sadece alt modalların butonları için sade tasarım */
.modal-content.expense-modal .modal-footer .btn,
.modal-content.upload-modal .modal-footer .btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 14px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-content.expense-modal .modal-footer .btn.secondary,
.modal-content.upload-modal .modal-footer .btn.secondary {
    background: white;
    color: #6b7280;
    border-color: #d1d5db;
}

.modal-content.expense-modal .modal-footer .btn.secondary:hover,
.modal-content.upload-modal .modal-footer .btn.secondary:hover {
    background: #f9fafb;
    color: #374151;
    border-color: #9ca3af;
}

.modal-content.expense-modal .modal-footer .btn.primary,
.modal-content.upload-modal .modal-footer .btn.primary {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.modal-content.expense-modal .modal-footer .btn.primary:hover,
.modal-content.upload-modal .modal-footer .btn.primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.expense-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
}

.expense-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-group.full-width {
    grid-column: 1 / -1;
}

.expense-group label,
.detail-group label {
    color: #374151;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 6px;
    display: block;
}

.expense-group input,
.expense-group select,
.expense-group textarea,
.detail-group input,
.detail-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
    background: white;
    font-family: inherit;
}

.expense-group input:focus,
.expense-group select:focus,
.expense-group textarea:focus,
.detail-group input:focus,
.detail-group select:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.expense-group textarea {
    resize: vertical;
    min-height: 80px;
}

.expense-group input[type="number"]::-webkit-outer-spin-button,
.expense-group input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.expense-type-wrapper {
    position: relative;
}

#otherExpenseType {
    margin-top: 8px;
    border-color: #facc15 !important;
    background: #fefce8 !important;
}

#otherExpenseType:focus {
    border-color: #eab308 !important;
    box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1) !important;
}

.amount-wrapper {
    position: relative;
}

.amount-wrapper input {
    padding-right: 32px !important;
}

.currency-symbol {
    position: absolute;
    right: 12px;
    color: #6b7280;
    font-weight: 500;
    font-size: 14px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

.status-toggle {
    position: relative;
    display: inline-block;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.toggle-label {
    display: block;
    width: 120px;
    height: 36px;
    background: #ef4444;
    border-radius: 18px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.toggle-input:checked + .toggle-label {
    background: #10b981;
}

.toggle-label::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 32px;
    height: 32px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-input:checked + .toggle-label::before {
    transform: translateX(84px);
}

.toggle-text-off,
.toggle-text-on {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    font-weight: 500;
    color: white;
    transition: opacity 0.3s ease;
}

.toggle-text-off {
    right: 8px;
    opacity: 1;
}

.toggle-text-on {
    left: 8px;
    opacity: 0;
}

.toggle-input:checked + .toggle-label .toggle-text-off {
    opacity: 0;
}

.toggle-input:checked + .toggle-label .toggle-text-on {
    opacity: 1;
}

.preview-modal-content {
    width: 95vw;
    height: 95vh;
    max-width: none;
}

.preview-modal-content .modal-header {
    display: flex;
    align-items: center;
    gap: 12px;
}

.preview-modal-content .modal-header h2 {
    margin: 0;
    font-size: 1.1rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: calc(100% - 56px);
}

.preview-modal-content .modal-header .close-btn {
    margin-left: auto;
    flex-shrink: 0;
    z-index: 1;
}

.preview-modal-body {
    padding: 0;
    height: calc(95vh - 120px);
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f5f5f5;
}

.document-preview-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
}

.document-preview-container iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.document-preview-container img {
    max-width: none;
    max-height: none;
    object-fit: contain;
}

.expense-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-right: 10px;
}

.status-paid {
    color: #2e7d32;
}

.status-unpaid {
    color: #c62828;
}

.expense-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.expense-actions .btn {
    padding: 4px;
    min-width: auto;
}

.expense-actions .btn i {
    font-size: 18px;
}

.document-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.document-original-name {
    font-size: 0.8rem;
    color: #666;
}

.document-name {
    font-weight: 500;
    color: #2c3e50;
}


/* Belge Yükle Modal Özel Tasarımları */
.modal-content.upload-modal {
    max-width: 600px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.modal-content.upload-modal .modal-header h2::before {
    content: '📎';
    font-size: 1.2rem;
}

.detail-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.detail-group label {
    color: #2c3e50;
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.detail-group label::before {
    content: '•';
    color: #3498db;
    font-weight: bold;
}

.detail-group input,
.detail-group select {
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
    font-family: inherit;
}

.detail-group input:focus,
.detail-group select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    outline: none;
    transform: translateY(-1px);
}

/* Yeni stil eklemeleri */
.detail-section h3 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-section h3 i {
    font-size: 18px;
    color: #3498db;
}

.additional-person {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.additional-person h5 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.additional-person h5 i {
    font-size: 16px;
    color: #3498db;
}

.lawyer-display {
    margin-top: 20px;
    padding: 15px;
    background: #fff3cd;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.lawyer-display h4 {
    margin: 0 0 15px 0;
    color: #856404;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.lawyer-display h4 i {
    font-size: 16px;
    color: #ffc107;
}

.info-group.full-width {
    grid-column: span 4;
}

.detail-group input[type="file"] {
    border: 2px dashed #bdc3c7;
    background: rgba(236, 240, 241, 0.3);
    padding: 16px;
    text-align: center;
    cursor: pointer;
    position: relative;
}

.detail-group input[type="file"]:hover {
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.05);
}

.detail-group input[type="file"]:focus {
    border-style: solid;
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.05);
}

/* Responsive Design İyileştirmeleri */
@media (max-width: 768px) {
    .expense-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .modal-content.expense-modal {
        max-width: 95vw;
        margin: 10px;
        border-radius: 12px;
    }
    
    .modal-header {
        padding: 16px 20px;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 16px 20px;
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
        min-width: auto;
    }
}

/* İşlem butonları için stil güncellemesi */
.actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    border: none;
    background: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Ayırıcı çizgiyi kaldır */
.actions span {
    display: none;
}

/* Duruşma türü için ek stil */
.hearing-type-group .radio-group {
    display: flex;
    gap: 15px;
    align-items: center;
    padding-top: 5px; /* Üstteki label ile hizalamak için */
}

.hearing-type-group .radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.95rem;
    font-weight: normal; /* Label'ı bold yapma */
    cursor: pointer;
    margin-bottom: 0; /* Alt boşluğu kaldır */
}

.hearing-type-group .radio-group input[type="radio"] {
    width: auto; /* Tarayıcı varsayılanını kullan */
    height: auto;
    margin-right: 3px;
    cursor: pointer;
}

/* Duruşma türü için ek stil */
.btn-outline-primary {
    color: #1a237e;
    border-color: #1a237e;
}
.btn-outline-primary:hover {
    background-color: #1a237e;
    color: white;
}
.btn-outline-danger {
    color: #dc3545;
    border-color: #dc3545;
}
.btn-outline-danger:hover {
    background-color: #dc3545;
    color: white;
}
.btn-sm {
    padding: 5px 10px;
    font-size: 0.8rem;
}
.btn-sm i {
    font-size: 16px; /* İkon boyutunu küçült */
    margin-right: 4px;
}

/* Duruşma türü seçim stili - E-duruşma tek satır düzeltmesi */
.hearing-type-inline {
    display: flex !important;
    align-items: center !important;
    gap: 15px !important;
    margin-top: 10px !important;
    flex-wrap: wrap !important;
}

.hearing-type-inline > div {
    display: flex !important;
    align-items: center !important;
    gap: 5px !important;
    white-space: nowrap !important;
}

.hearing-type-inline label {
    margin-bottom: 0 !important;
    font-weight: normal !important;
    white-space: nowrap !important;
}

.hearing-type-inline button {
    white-space: nowrap !important;
    flex-shrink: 0 !important;
}

/* Mobil responsive düzeltmeler */
@media (max-width: 768px) {
    .hearing-type-inline {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 10px !important;
    }
    
    .hearing-type-inline > div:first-child,
    .hearing-type-inline > div:nth-child(2) {
        display: inline-flex !important;
        margin-right: 15px !important;
    }
    
    .hearing-type-inline button {
        margin-left: 0 !important;
        margin-top: 5px !important;
        width: 100% !important;
    }
}
</style>

<!-- TIFF ve DOCX Önizleme Kütüphaneleri -->
<script src="https://cdn.jsdelivr.net/npm/tiff.js/tiff.min.js"></script>
{# <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.20/dist/docx-preview.min.js"></script> #}

<script>
// CSRF Token
const csrfToken = document.querySelector('input[name="csrf_token"]').value;

// Kullanıcı yetkileri
const hasFileDeletePermission = document.body.dataset.hasFileDeletePermission === 'true';
const hasFileEditPermission = document.body.dataset.hasFileEditPermission === 'true';

// Örnek Masraf Türleri (Bunları kendi türlerinizle değiştirin)
const expenseTypes = [
    "Dava Harcı", "Vekalet Ücreti", "Posta Gideri", "Yol Gideri",
    "Bilirkişi Ücreti", "Tebligat Gideri", "Keşif Harcı", "Diğer"
];

// Örnek Belge Türleri (Bunları kendi türlerinizle değiştirin)
const documentTypes = [
    "Adli Yardım",
    "Arabuluculuk",
    "Bilirkişi Raporu",
    "Diğer",
    "Dilekçe",
    "Duruşma Zaptı",
    "İhtarname",
    "İşçi Görüşme Formu",
    "İstinaf",
    "Karar",
    "Sözleşme",
    "Talep",
    "Tazminat Rapor",
    "Temyiz",
    "Vekaletname",
    "Yetki Belgesi"
];

let currentCaseId = null;
let currentExpenses = [];

// Backend'den gelen tüm adliye verisi
let allCourthousesData;
try {
    allCourthousesData = JSON.parse('{{ all_courthouses | safe }}');
} catch (e) {
    console.error('allCourthousesData parse hatası:', e);
    allCourthousesData = {};
}

// Dosya türüne göre sıfat seçenekleri
const capacityOptions = {
    hukuk: {
        client: ['Davacı', 'Davalı', 'Davalı-Karşı Davacı', 'Davacı Karşı Davalı', 'Talepte Bulunan', 'Muris', 'Kayyım', 'Dahili Davalı', 'Kısıtlı', 'Temsilci', 'Mirasçı'],
        opponent: ['Davalı', 'Davacı', 'Davalı-Karşı Davacı', 'Davacı Karşı Davalı', 'Talepte Bulunan', 'Muris', 'Kayyım', 'Dahili Davalı', 'Kısıtlı', 'Temsilci', 'Mirasçı']
    },
    ceza: {
        client: ['Mağdur', 'Müşteki', 'Sanık', 'Katılan', 'S.S.Ç.'],
        opponent: ['Mağdur', 'Müşteki', 'Sanık', 'Katılan', 'S.S.Ç.']
    },
    savcilik: {
        client: ['Mağdur', 'Müşteki', 'Sanık', 'Katılan', 'S.S.Ç.'],
        opponent: ['Mağdur', 'Müşteki', 'Sanık', 'Katılan', 'S.S.Ç.']
    },
    icra: {
        client: ['Alacaklı', 'Borçlu'],
        opponent: ['Alacaklı', 'Borçlu']
    },
    ARABULUCULUK: {
        client: ['Başvuran', 'Aleyhine Başvurulan'],
        opponent: ['Başvuran', 'Aleyhine Başvurulan']
    },
    AİHM: {
        client: ['Başvurucu'],
        opponent: []
    },
    AYM: {
        client: ['Başvurucu'],
        opponent: []
    }
};

// Orijinal Birim seçenekleri
const originalDepartments = [
    'Asliye Hukuk Mahkemesi', 'Sulh Hukuk Mahkemesi', 'İş Mahkemesi', 
    'Aile Mahkemesi', 'Ticaret Mahkemesi', 'İcra Hukuk Mahkemesi', 
    'Tüketici Mahkemesi', 'Fikri ve Sınai Haklar Mahkemesi',
    'Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği', 
    'İcra Dairesi'
];

// İstanbul'a özel adliyeler
const istanbulSpecificCourthouses = [
    "İstanbul Anadolu Adliyesi (Kartal)",
    "İstanbul Adliyesi (Çağlayan)",
    "Bakırköy Adliyesi",
    "Büyükçekmece Adliyesi",
    "Gaziosmanpaşa Adliyesi",
    "Küçükçekmece Adliyesi",
    "Silivri Adliyesi",
    "Çatalca Adliyesi",
    "Üsküdar Adliyesi",
    "Adalar Adliyesi",
    "Sarıyer Adliyesi"
];

// Hata mesajı gösterme işlevi 
function showError(message) {
    Swal.fire({
        icon: 'error',
        title: 'Hata Oluştu',
        text: message,
        confirmButtonText: 'Tamam'
    });
}


document.addEventListener('DOMContentLoaded', function() {
    // Sayfa yüklendiğinde başlangıç durumunu ayarla
    populateDepartments();
    handleFileTypeChange();
    
    // Eğer şehir seçiliyse adliye listesini güncelle
    const citySelect = document.getElementById('city');
    if (citySelect && citySelect.value) {
        updateCourthouses();
    }
    
    // URL'den parametreleri al
    const urlParams = new URLSearchParams(window.location.search);
    const showDetailsId = urlParams.get('show_details');
    const fileType = urlParams.get('file_type');
    const status = urlParams.get('status');
    
    // Eğer show_details parametresi varsa, dosya detaylarını göster
    if (showDetailsId) {
        showDetails(showDetailsId);
    }
    
    // URL'den gelen parametrelere göre otomatik arama yap
    if (fileType || status) {
        // Parametrelere göre form alanlarını doldur
        if (fileType) {
            const fileTypeSelect = document.getElementById('file-type');
            if (fileTypeSelect) {
                fileTypeSelect.value = fileType;
                handleFileTypeChange(); // Dosya türü değiştiğinde gerekli işlemleri yap
            }
        }
        
        if (status) {
            const statusSelect = document.getElementById('status');
            if (statusSelect) {
                statusSelect.value = status;
            }
        }
        
        // Otomatik aramayı bir süre bekleyerek yap (DOM güncellemelerinin tamamlanması için)
        setTimeout(function() {
            const searchForm = document.querySelector('.search-form');
            if (searchForm) {
                // Form submit event'ini tetikle
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                searchForm.dispatchEvent(submitEvent);
            }
        }, 500);
    }
    
    // Modal dışına tıklama event handler'ı
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('fileDetailModal');
        if (modal && modal.style.display === 'flex' && event.target === modal) {
            closeDetailModal();
        }
    });
    
    // ESC tuşu ile modal kapatma
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('fileDetailModal');
            if (modal && modal.style.display === 'flex') {
                closeDetailModal();
            }
        }
    });
});

function updateCourthouses() {
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    
    // Adliye listesini temizle, "Tümü" seçeneğini koru
    courthouseSelect.innerHTML = '<option value="">Tümü</option>';
    
    // Eğer İstanbul seçiliyse, özel İstanbul adliyelerini ekle
    if (selectedCity === 'İstanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
    
    // Seçili şehir için adliyeleri ekle (eğer İstanbul değilse veya İstanbul'a ek adliyeler varsa)
    if (selectedCity && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
}

function handleFileTypeChange() {
    const fileTypeSelect = document.getElementById('file-type');
    const selectedFileType = fileTypeSelect.value.toLowerCase();
    
    // Mahkeme listesini temizle ve yeniden doldur
    populateDepartments(selectedFileType);
    
    // Dosya türlerine göre alanları devre dışı bırak/etkinleştir
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const departmentSelect = document.getElementById('department');
    const courtNumberContainer = document.getElementById('court-number-container');
    
    // "Tümü" seçeneği için hepsini etkinleştir
    if (!selectedFileType) {
        citySelect.disabled = false;
        courthouseSelect.disabled = false;
        departmentSelect.disabled = false;
        return;
    }
    
    // ARABULUCULUK, AİHM ve AYM için şehir ve adliye devre dışı
    const disableCourthouseAndCity = ['arabuluculuk', 'aihm', 'aym'].includes(selectedFileType) || 
                                    ['ARABULUCULUK', 'AİHM', 'AYM'].includes(fileTypeSelect.value);
    // Savcılık için sadece mahkeme devre dışı
    const disableDepartment = ['arabuluculuk', 'aihm', 'aym', 'savcilik'].includes(selectedFileType) ||
                             ['ARABULUCULUK', 'AİHM', 'AYM', 'savcilik'].includes(fileTypeSelect.value);
    
    citySelect.disabled = disableCourthouseAndCity;
    courthouseSelect.disabled = disableCourthouseAndCity;
    departmentSelect.disabled = disableDepartment;
    
    // Alanlar devre dışı bırakıldıysa, değerlerini temizle
    if (disableCourthouseAndCity) {
        citySelect.value = '';
        courthouseSelect.innerHTML = '<option value="">Tümü</option>';
    }
    
    if (disableDepartment) {
        departmentSelect.value = '';
        courtNumberContainer.style.display = 'none';
    }
    
    // Şehir seçiliyse adliye listesini güncelle
    if (!disableCourthouseAndCity && citySelect.value) {
        updateCourthouses();
    }
    
    // Birim seçimi değiştiyse mahkeme numaralarını güncelle
    if (departmentSelect.value) {
        if (selectedFileType === 'icra' && departmentSelect.value === 'İcra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(departmentSelect.value);
        }
    } else {
        courtNumberContainer.style.display = 'none';
    }
}

function populateDepartments(fileType) {
    const departmentSelect = document.getElementById('department');
    
    // Listeyi temizle, "Tümü" seçeneğini koru
    departmentSelect.innerHTML = '<option value="">Tümü</option>';
    
    // Dosya türüne göre mahkemeleri ekle
    if (fileType === 'hukuk') {
        // Hukuk mahkemeleri
        const hukukMahkemeleri = [
            'Asliye Hukuk Mahkemesi',
            'Sulh Hukuk Mahkemesi',
            'İş Mahkemesi',
            'Aile Mahkemesi',
            'Ticaret Mahkemesi',
            'İcra Hukuk Mahkemesi',
            'Tüketici Mahkemesi',
            'Fikri ve Sınai Haklar Mahkemesi'
        ];
        
        hukukMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'ceza') {
        // Ceza mahkemeleri
        const cezaMahkemeleri = [
            'Asliye Ceza Mahkemesi',
            'Ağır Ceza Mahkemesi',
            'Sulh Ceza Hakimliği'
        ];
        
        cezaMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'icra') {
        // İcra Dairesi
        const option = document.createElement('option');
        option.value = 'İcra Dairesi';
        option.textContent = 'İcra Dairesi';
        departmentSelect.appendChild(option);
        
        // İcra Dairesi seçilirse numaralandırma değişir
        departmentSelect.onchange = function() {
            if (this.value === 'İcra Dairesi') {
                updateIcraDaireleri();
            } else {
                document.getElementById('court-number-container').style.display = 'none';
            }
        };
    } else if (!fileType || fileType === '') {
        // Hiçbir filtre seçilmediğinde tüm mahkemeleri göster
        originalDepartments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            departmentSelect.appendChild(option);
        });
    }
    
    // Mahkeme seçildiğinde numaralı mahkemeyi güncelle
    departmentSelect.onchange = function() {
        const fileType = document.getElementById('file-type').value.toLowerCase();
        if (fileType === 'icra' && this.value === 'İcra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(this.value);
        }
    };
}

// İcra dairelerini güncelle (1-30 arası)
function updateIcraDaireleri() {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // İcra daireleri listesini temizle
    courtNumberSelect.innerHTML = '<option value="">Tümü</option>';
    
    // İcra dairelerini ekle (1-30)
    for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = `${i}. İcra Dairesi`;
        option.textContent = `${i}. İcra Dairesi`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

function updateCourtNumbers(department) {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // Mahkeme numaralarını temizle
    courtNumberSelect.innerHTML = '<option value="">Tümü</option>';
    
    // İcra Dairesi zaten numaralı olduğu için dışarıda bırak
    if (!department || department === '' || department.includes('İcra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }
    
    // Adliye ve şehre göre mahkeme sayısını belirle
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    const selectedCourthouse = courthouseSelect.value;
    
    // Varsayılan olarak her mahkemeden 30 tane
    let maxCourtNumber = 30;
    
    // İstanbul ve belirli adliyeler için daha fazla mahkeme
    if (selectedCity === 'İstanbul') {
        if (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Çağlayan')) {
            if (department === 'Asliye Hukuk Mahkemesi' || 
                department === 'Asliye Ceza Mahkemesi' || 
                department === 'İş Mahkemesi') {
                maxCourtNumber = 50;
            } else if (department === 'Ağır Ceza Mahkemesi') {
                maxCourtNumber = 15;
            }
        } else if (selectedCourthouse.includes('Bakırköy')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'İzmir') {
        maxCourtNumber = 40;
    }
    
    // Birim adını ekle
    const baseOption = document.createElement('option');
    baseOption.value = department;
    baseOption.textContent = department;
    courtNumberSelect.appendChild(baseOption);
    
    // Numaralı mahkemeleri ekle
    for (let i = 1; i <= maxCourtNumber; i++) {
        const option = document.createElement('option');
        option.value = `${i}. ${department}`;
        option.textContent = `${i}. ${department}`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

// Diğer fonksiyonlar...

function showDetails(caseId) {
    currentCaseId = caseId;
    const modal = document.getElementById('fileDetailModal');
    
    fetch(`/case_details/${caseId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Sunucu yanıtı:', data);
                alert('Dosya detayları yüklenirken bir hata oluştu.');
                return;
            }

            // Temel bilgileri doldur
            document.getElementById('detailFileType').textContent = capitalizeFileType(data.file_type);
            
            // Dosya türüne göre adliye ve mahkeme bilgilerini göster/gizle
            const fileType = data.file_type;
            const shouldShowCourthouse = !['AİHM', 'AYM', 'ARABULUCULUK'].includes(fileType);
            const shouldShowDepartment = !['AİHM', 'AYM', 'ARABULUCULUK', 'savcilik'].includes(fileType);
            
            document.getElementById('detailCourthouse').textContent = shouldShowCourthouse ? (data.courthouse || '') : '';
            document.getElementById('detailDepartment').textContent = shouldShowDepartment ? (data.department || '') : '';
            document.getElementById('detailYear').textContent = data.year || '-';
            document.getElementById('detailCaseNumber').textContent = data.case_number || '-';
            document.getElementById('detailCity').textContent = data.city || '-';
            
            // Müvekkil Bilgileri
            document.getElementById('detailClientEntityType').textContent = 
                data.client_entity_type === 'company' ? 'Şirket' : 'Gerçek Kişi';
            document.getElementById('detailClientCapacity').textContent = data.client_capacity || '-';
            document.getElementById('detailClientIdentityNumber').textContent = data.client_identity_number || '-';
            document.getElementById('detailPhoneNumber').textContent = data.phone_number || '-';
            document.getElementById('detailClientAddress').textContent = data.client_address || '-';
            
            // Karşı Taraf Bilgileri
            document.getElementById('detailOpponentEntityType').textContent = 
                data.opponent_entity_type === 'company' ? 'Şirket' : 'Gerçek Kişi';
            document.getElementById('detailOpponentCapacity').textContent = data.opponent_capacity || '-';
            document.getElementById('detailOpponentIdentityNumber').textContent = data.opponent_identity_number || '-';
            document.getElementById('detailOpponentPhone').textContent = data.opponent_phone || '-';
            document.getElementById('detailOpponentAddress').textContent = data.opponent_address || '-';
            
            // Ana müvekkil başlık ve subtitle'ını güncelle
            const mainClientTitle = document.querySelector('.main-client-title');
            const mainClientSubtitle = document.getElementById('mainClientSubtitle');
            if (mainClientTitle && mainClientSubtitle) {
                const clientParts = [];
                if (data.client_capacity) clientParts.push(data.client_capacity);
                if (data.client_name) clientParts.push(data.client_name);
                
                if (clientParts.length > 0) {
                    mainClientTitle.textContent = clientParts.join(' - ');
                    mainClientSubtitle.textContent = data.client_identity_number || '';
                } else {
                    mainClientTitle.textContent = 'Müvekkil Bilgileri';
                    mainClientSubtitle.textContent = '';
                }
            }
            
            // Ana karşı taraf başlık ve subtitle'ını güncelle
            const mainOpponentTitle = document.querySelector('.main-opponent-title');
            const mainOpponentSubtitle = document.getElementById('mainOpponentSubtitle');
            if (mainOpponentTitle && mainOpponentSubtitle) {
                const opponentParts = [];
                if (data.opponent_capacity) opponentParts.push(data.opponent_capacity);
                if (data.opponent_name) opponentParts.push(data.opponent_name);
                
                if (opponentParts.length > 0) {
                    mainOpponentTitle.textContent = opponentParts.join(' - ');
                    mainOpponentSubtitle.textContent = data.opponent_identity_number || '';
                } else {
                    mainOpponentTitle.textContent = 'Karşı Taraf Bilgileri';
                    mainOpponentSubtitle.textContent = '';
                }
            }
            
            // Vekil bilgilerini göster - Tüm vekilleri ana vekil olarak göster
            const lawyersDisplay = document.getElementById('lawyersDisplay');
            lawyersDisplay.innerHTML = '';
            
            // Ana vekili listeye ekle
            const allLawyers = [];
            if (data.opponent_lawyer || data.opponent_lawyer_phone || data.opponent_lawyer_address) {
                allLawyers.push({
                    name: data.opponent_lawyer || 'Ad belirtilmemiş',
                    bar_number: data.opponent_lawyer_bar_number || '',
                    phone: data.opponent_lawyer_phone || '',
                    address: data.opponent_lawyer_address || ''
                });
            }
            
            // Ek vekilleri listeye ekle
            if (data.additional_lawyers && Array.isArray(data.additional_lawyers)) {
                data.additional_lawyers.forEach(lawyer => {
                    allLawyers.push({
                        name: lawyer.name || 'Ad belirtilmemiş',
                        bar_number: lawyer.bar_number || '',
                        phone: lawyer.phone || '',
                        address: lawyer.address || ''
                    });
                });
            }
            
            // Tüm vekilleri aynı formatta göster
            allLawyers.forEach((lawyer, index) => {
                const lawyerDiv = document.createElement('div');
                lawyerDiv.className = 'collapsible-person-card lawyer-card';
                lawyerDiv.innerHTML = `
                    <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                        <div class="collapsible-title">
                            <i class="material-icons person-icon lawyer-icon">account_balance</i>
                            <div class="person-info">
                                <div class="person-title">Vekil - ${lawyer.name}</div>
                                <div class="person-subtitle">Baro No: ${lawyer.bar_number || 'Belirtilmemiş'}</div>
                            </div>
                        </div>
                        <i class="material-icons collapse-arrow">expand_more</i>
                    </div>
                    <div class="collapsible-content">
                        <div class="detail-info-grid">
                            <div class="detail-info-item">
                                <span class="detail-info-label">BARO NUMARASI</span>
                                <span class="detail-info-value">${lawyer.bar_number || '-'}</span>
                            </div>
                            <div class="detail-info-item">
                                <span class="detail-info-label">TELEFON</span>
                                <span class="detail-info-value">${lawyer.phone || '-'}</span>
                            </div>
                            <div class="detail-info-item full-width">
                                <span class="detail-info-label">ADRES</span>
                                <span class="detail-info-value">${lawyer.address || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
                lawyersDisplay.appendChild(lawyerDiv);
            });
            
            // Ek Müvekkilleri göster - YENİ katlanabilir tasarım
            const additionalClientsDisplay = document.getElementById('additionalClientsDisplay');
            additionalClientsDisplay.innerHTML = '';
            if (data.additional_clients && data.additional_clients.length > 0) {
                data.additional_clients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'collapsible-person-card';
                    clientDiv.innerHTML = `
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">person_add</i>
                                <div class="person-info">
                                    <div class="person-title">${client.capacity ? client.capacity + ' - ' : ''}${client.name || 'Ad belirtilmemiş'}</div>
                                    <div class="person-subtitle">${client.identity_number || ''}</div>
                                </div>
                            </div>
                            <i class="material-icons collapse-arrow">expand_more</i>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value">${client.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value">${client.capacity || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value">${client.identity_number || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value">${client.phone || '-'}</span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value">${client.address || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    additionalClientsDisplay.appendChild(clientDiv);
                });
            }
            
            // Ek Karşı Tarafları göster - YENİ katlanabilir tasarım
            const additionalOpponentsDisplay = document.getElementById('additionalOpponentsDisplay');
            additionalOpponentsDisplay.innerHTML = '';
            if (data.additional_opponents && data.additional_opponents.length > 0) {
                data.additional_opponents.forEach((opponent, index) => {
                    const opponentDiv = document.createElement('div');
                    opponentDiv.className = 'collapsible-person-card';
                    opponentDiv.innerHTML = `
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">group_add</i>
                                <div class="person-info">
                                    <div class="person-title">${opponent.capacity ? opponent.capacity + ' - ' : ''}${opponent.name || 'Ad belirtilmemiş'}</div>
                                    <div class="person-subtitle">${opponent.identity_number || ''}</div>
                                </div>
                            </div>
                            <i class="material-icons collapse-arrow">expand_more</i>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value">${opponent.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value">${opponent.capacity || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value">${opponent.identity_number || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value">${opponent.phone || '-'}</span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value">${opponent.address || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    additionalOpponentsDisplay.appendChild(opponentDiv);
                });
            }
            
            // Durum bilgisini doldur
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = data.status || 'Aktif';
            statusElement.className = 'file-status ' + (data.status === 'Aktif' ? 'active' : 'closed');
            
            // Tarih bilgilerini doldur
            document.getElementById('detailOpenDate').textContent = data.open_date || '-';
            
            // Duruşma bilgilerini sadece duruşma varsa göster, yoksa gizle veya "-" göster
            if (data.next_hearing) {
            document.getElementById('detailNextHearing').textContent = data.next_hearing || '-';
            document.getElementById('detailHearingTime').textContent = data.hearing_time || '-';
                document.getElementById('detailHearingType').textContent = data.formatted_hearing_type || 'Duruşma';
                // Duruşma separatörleri görünür yap
                const separators = document.querySelectorAll('.hearing-separator');
                separators.forEach(sep => sep.style.display = 'inline');
            } else {
                document.getElementById('detailNextHearing').textContent = '-';
                document.getElementById('detailHearingTime').textContent = '';
                document.getElementById('detailHearingType').textContent = '';
                // Duruşma separatörleri gizle
                const separators = document.querySelectorAll('.hearing-separator');
                separators.forEach(sep => sep.style.display = 'none');
            }
            
            document.getElementById('detailDescription').textContent = data.description || 'Açıklama bulunmuyor.';

            // Masrafları göster
            if (data.expenses && Array.isArray(data.expenses)) {
                currentExpenses = data.expenses;
                currentExpensesData = data.expenses;
                displaySortedExpenses();
            } else {
                currentExpenses = [];
                currentExpensesData = [];
                const expensesList = document.getElementById('editExpensesList');
                if (expensesList) {
                    expensesList.innerHTML = '<p>Henüz masraf kaydı bulunmuyor.</p>';
                }
            }

            // Belgeleri göster
            if (data.documents) {
                currentDocuments = data.documents;
                displaySortedDocuments();
            } else {
                currentDocuments = [];
                const documentsList = document.getElementById('documentsList');
                if (documentsList) {
                    documentsList.innerHTML = '<p>Henüz belge yüklenmemiş.</p>';
                }
            }

            // Modalı göster
            modal.style.display = 'flex';
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Dosya detayları yüklenirken bir hata oluştu: ' + error.message);
        });
}

// Dosya türünü doğru şekilde büyük harfe çevir
function capitalizeFileType(fileType) {
    const typeMapping = {
        'hukuk': 'Hukuk',
        'ceza': 'Ceza', 
        'icra': 'İcra',
        'savcilik': 'Savcılık',
        'ARABULUCULUK': 'Arabuluculuk',
        'AİHM': 'AİHM',
        'AYM': 'AYM'
    };
    
    return typeMapping[fileType] || fileType.charAt(0).toUpperCase() + fileType.slice(1);
}

// Dosya uzantısına göre ikon seç
function getFileIcon(filename) {
    if (!filename) return 'insert_drive_file';
    
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'picture_as_pdf';
        case 'doc':
        case 'docx': return 'description';
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'tiff':
        case 'tif': return 'image';
        case 'txt': return 'article';
        case 'xls':
        case 'xlsx': return 'table_chart';
        case 'zip':
        case 'rar': return 'folder_zip';
        default: return 'insert_drive_file';
    }
}

// Modal kapatma fonksiyonu
function closeDetailModal() {
    const modal = document.getElementById('fileDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // URL'deki show_details parametresini temizle
    const url = new URL(window.location);
    url.searchParams.delete('show_details');
    
    // URL'yi güncelle (sayfa yeniden yüklenmeden)
    window.history.replaceState({}, '', url);
}

// Düzenle butonu için fonksiyon
function editCase(caseId) {
    const modal = document.getElementById('fileDetailModal');
    modal.style.display = 'none';
    
    fetch(`/case_details/${caseId}`)
        .then(response => {
            if (response.status === 403) {
                alert('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz. Dosya düzenleme yetkisi gereklidir.');
                modal.style.display = 'flex'; // Modalı tekrar göster
                return Promise.reject(new Error('Yetki hatası'));
            }
            
            if (!response.ok) {
                throw new Error('Sunucu hatası');
            }
            return response.json();
        })
        .then(data => {
            // Debug: Server'dan gelen data'yı logla
            console.log('DEBUG: Edit modal data from server:', data);
            console.log('DEBUG: file_type in modal data:', data.file_type);
            
            // Devam eden kod
            // Tarihi YYYY-MM-DD formatına çevir
            const openDate = data.open_date ? data.open_date.split('.').reverse().join('-') : '';
            const nextHearing = data.next_hearing ? data.next_hearing.split('.').reverse().join('-') : '';

            // Şehir ve adliye bilgilerini belirle
            let city = '';
            if (data.courthouse) {
                if (istanbulSpecificCourthouses.includes(data.courthouse)) {
                    city = 'İstanbul';
                } else {
                    for (const [cityName, courthouses] of Object.entries(allCourthousesData)) {
                        if (courthouses.includes(data.courthouse)) {
                            city = cityName;
                            break;
                        }
                    }
                }
            }

            const editHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Dosya Düzenle</h2>
                        <button class="close-btn" onclick="closeEditModal()">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Dosya Türü</label>
                                    <select id="editFileType" onchange="populateEditDepartments(this.value, document.getElementById('editDepartment'), null, document.getElementById('editCourthouse').value); updateEditCapacityOptions();">
                                        <option value="hukuk" ${data.file_type === 'hukuk' ? 'selected' : ''}>Hukuk</option>
                                        <option value="ceza" ${data.file_type === 'ceza' ? 'selected' : ''}>Ceza</option>
                                        <option value="icra" ${data.file_type === 'icra' ? 'selected' : ''}>İcra</option>
                                        <option value="savcilik" ${data.file_type === 'savcilik' ? 'selected' : ''}>Savcılık</option>
                                        <option value="ARABULUCULUK" ${data.file_type === 'ARABULUCULUK' ? 'selected' : ''}>Arabuluculuk</option>
                                        <option value="AİHM" ${data.file_type === 'AİHM' ? 'selected' : ''}>AİHM</option>
                                        <option value="AYM" ${data.file_type === 'AYM' ? 'selected' : ''}>AYM</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Şehir</label>
                                    <select id="editCity" onchange="updateEditCourthouses(); populateEditDepartments(document.getElementById('editFileType').value, document.getElementById('editDepartment'), null, document.getElementById('editCourthouse').value);" ${['ARABULUCULUK', 'AİHM', 'AYM'].includes(data.file_type) ? 'disabled' : ''}>
                                        <option value="">Seçiniz</option>
                                        ${Object.keys(allCourthousesData).map(cityName => 
                                            `<option value="${cityName}" ${city === cityName ? 'selected' : ''}>${cityName}</option>`
                                        ).join('')}
                                        <option value="İstanbul" ${city === 'İstanbul' ? 'selected' : ''}>İstanbul</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Adliye</label>
                                    <select id="editCourthouse" onchange="populateEditDepartments(document.getElementById('editFileType').value, document.getElementById('editDepartment'), null, this.value);" ${['ARABULUCULUK', 'AİHM', 'AYM'].includes(data.file_type) ? 'disabled' : ''}>
                                        <option value="">Seçiniz</option>
                                        ${city === 'İstanbul' ? 
                                            istanbulSpecificCourthouses.map(courthouse => 
                                                `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                            ).join('') : 
                                            (city && allCourthousesData[city] ? 
                                                allCourthousesData[city].map(courthouse => 
                                                    `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                                ).join('') : '')
                                        }
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Mahkeme</label>
                                    <select id="editDepartment" ${['ARABULUCULUK', 'AİHM', 'AYM', 'savcilik'].includes(data.file_type) ? 'disabled' : ''} onchange="updateEditNumberedDepartments(this.value, document.getElementById('editCity').value, document.getElementById('editCourthouse').value)">
                                        <option value="">Seçiniz</option>
                                    </select>
                                </div>
                                <div class="detail-group" id="editNumberedDepartmentContainer" style="display: none;">
                                    <label>Numaralı Mahkeme</label>
                                    <select id="editNumberedDepartment">
                                        <option value="">Seçiniz</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Bilgiler Container -->
                            <div class="edit-info-container">
                                <!-- Müvekkil Bilgileri -->
                                <div class="edit-section">
                                    <div class="section-header-with-add">
                                        <h3><i class="material-icons">person</i> Müvekkil Bilgileri</h3>
                                        <button type="button" class="btn-add-person" onclick="addNewClientInModal(${caseId}, '${data.file_type}')" title="Yeni Müvekkil Ekle">
                                            <i class="material-icons">add</i>
                                        </button>
                                    </div>
                                    
                                    <!-- Ana Müvekkil - Katlanabilir -->
                                    <div id="mainClientCard" class="collapsible-person-card editable-person-card main-person-card">
                                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                                            <div class="collapsible-title">
                                                <i class="material-icons person-icon">person</i>
                                                <div class="person-info">
                                                    <div class="person-title main-edit-client-title">${(data.client_capacity || 'Müvekkil') + ' - ' + (data.client_name || 'İsim belirtilmemiş')}</div>
                                                    <div class="person-subtitle">${data.client_identity_number || ''}</div>
                                                </div>
                                            </div>
                                            <div class="card-actions" onclick="event.stopPropagation()">
                                                <button type="button" class="btn-icon-small edit" onclick="editMainPersonInModal('client', ${caseId})" title="Düzenle">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                                <button type="button" class="btn-icon-small delete" onclick="deleteMainPersonInModal('client', ${caseId})" title="Sil">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                                <i class="material-icons collapse-arrow">expand_more</i>
                                            </div>
                                        </div>
                                        <div class="collapsible-content">
                                            <div class="detail-info-grid">
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">TİP</span>
                                                    <span class="detail-info-value">${(data.client_entity_type || 'person') === 'person' ? 'Gerçek Kişi' : 'Şirket'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">SIFAT</span>
                                                    <span class="detail-info-value">${data.client_capacity || '-'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">TELEFON</span>
                                                    <span class="detail-info-value">${data.phone_number || '-'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                                    <span class="detail-info-value">${data.client_identity_number || '-'}</span>
                                                </div>
                                                <div class="detail-info-item full-width">
                                                    <span class="detail-info-label">ADRES</span>
                                                    <span class="detail-info-value">${data.client_address || '-'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gizli Ana Müvekkil Edit Formu -->
                                    <div id="mainClientEditForm" style="display: none;" class="hidden-edit-form">
                                        <div class="detail-grid">
                                            <div class="detail-group">
                                                <label>Tip</label>
                                                <select id="editClientEntityType">
                                                    <option value="person" ${(data.client_entity_type || 'person') === 'person' ? 'selected' : ''}>Gerçek Kişi</option>
                                                    <option value="company" ${data.client_entity_type === 'company' ? 'selected' : ''}>Şirket</option>
                                                </select>
                                            </div>
                                            <div class="detail-group">
                                                <label>Sıfat</label>
                                                <select id="editClientCapacity">
                                                    <option value="">Seçiniz</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group full-width">
                                                <label>Ad Soyad / Unvan</label>
                                                <input type="text" id="editClientName" value="${data.client_name || ''}">
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group">
                                                <label>Telefon</label>
                                                <input type="text" id="editPhoneNumber" value="${data.phone_number || ''}">
                                            </div>
                                            <div class="detail-group">
                                                <label>Kimlik / Vergi No</label>
                                                <input type="text" id="editClientIdentityNumber" value="${data.client_identity_number || ''}">
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group full-width">
                                                <label>Adres</label>
                                                <textarea id="editClientAddress" rows="2">${data.client_address || ''}</textarea>
                                            </div>
                                        </div>
                                        <div class="edit-form-actions">
                                            <button type="button" class="btn secondary" onclick="cancelMainPersonEdit('client')">İptal</button>
                                            <button type="button" class="btn primary" onclick="saveMainPersonEdit('client', ${caseId})">Kaydet</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Ek Müvekkiller -->
                                    <div id="editAdditionalClientsDisplay" class="additional-display">
                                        <!-- Dinamik olarak eklenecek -->
                                    </div>
                                </div>
                                
                                <!-- Karşı Taraf Bilgileri -->
                                <div class="edit-section">
                                    <div class="section-header-with-add">
                                        <h3><i class="material-icons">group</i> Karşı Taraf Bilgileri</h3>
                                        <button type="button" class="btn-add-person" onclick="addNewOpponentInModal(${caseId}, '${data.file_type}')" title="Yeni Karşı Taraf Ekle">
                                            <i class="material-icons">add</i>
                                        </button>
                                    </div>
                                    
                                    <!-- Ana Karşı Taraf - Katlanabilir -->
                                    <div id="mainOpponentCard" class="collapsible-person-card editable-person-card main-person-card">
                                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                                            <div class="collapsible-title">
                                                <i class="material-icons person-icon">group</i>
                                                <div class="person-info">
                                                    <div class="person-title main-edit-opponent-title">${(data.opponent_capacity || 'Karşı Taraf') + ' - ' + (data.opponent_name || 'İsim belirtilmemiş')}</div>
                                                    <div class="person-subtitle">${data.opponent_identity_number || ''}</div>
                                                </div>
                                            </div>
                                            <div class="card-actions" onclick="event.stopPropagation()">
                                                <button type="button" class="btn-icon-small edit" onclick="editMainPersonInModal('opponent', ${caseId})" title="Düzenle">
                                                    <i class="material-icons">edit</i>
                                                </button>
                                                <button type="button" class="btn-icon-small delete" onclick="deleteMainPersonInModal('opponent', ${caseId})" title="Sil">
                                                    <i class="material-icons">delete</i>
                                                </button>
                                                <i class="material-icons collapse-arrow">expand_more</i>
                                            </div>
                                        </div>
                                        <div class="collapsible-content">
                                            <div class="detail-info-grid">
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">TİP</span>
                                                    <span class="detail-info-value">${(data.opponent_entity_type || 'person') === 'person' ? 'Gerçek Kişi' : 'Şirket'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">SIFAT</span>
                                                    <span class="detail-info-value">${data.opponent_capacity || '-'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">TELEFON</span>
                                                    <span class="detail-info-value">${data.opponent_phone || '-'}</span>
                                                </div>
                                                <div class="detail-info-item">
                                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                                    <span class="detail-info-value">${data.opponent_identity_number || '-'}</span>
                                                </div>
                                                <div class="detail-info-item full-width">
                                                    <span class="detail-info-label">ADRES</span>
                                                    <span class="detail-info-value">${data.opponent_address || '-'}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Gizli Ana Karşı Taraf Edit Formu -->
                                    <div id="mainOpponentEditForm" style="display: none;" class="hidden-edit-form">
                                        <div class="detail-grid">
                                            <div class="detail-group">
                                                <label>Tip</label>
                                                <select id="editOpponentEntityType">
                                                    <option value="person" ${(data.opponent_entity_type || 'person') === 'person' ? 'selected' : ''}>Gerçek Kişi</option>
                                                    <option value="company" ${data.opponent_entity_type === 'company' ? 'selected' : ''}>Şirket</option>
                                                </select>
                                            </div>
                                            <div class="detail-group">
                                                <label>Sıfat</label>
                                                <select id="editOpponentCapacity">
                                                    <option value="">Seçiniz</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group full-width">
                                                <label>Ad Soyad / Unvan</label>
                                                <input type="text" id="editOpponentName" value="${data.opponent_name || ''}">
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group">
                                                <label>Telefon</label>
                                                <input type="text" id="editOpponentPhone" value="${data.opponent_phone || ''}">
                                            </div>
                                            <div class="detail-group">
                                                <label>Kimlik / Vergi No</label>
                                                <input type="text" id="editOpponentIdentityNumber" value="${data.opponent_identity_number || ''}">
                                            </div>
                                        </div>
                                        <div class="detail-grid">
                                            <div class="detail-group full-width">
                                                <label>Adres</label>
                                                <textarea id="editOpponentAddress" rows="2">${data.opponent_address || ''}</textarea>
                                            </div>
                                        </div>
                                        <div class="edit-form-actions">
                                            <button type="button" class="btn secondary" onclick="cancelMainPersonEdit('opponent')">İptal</button>
                                            <button type="button" class="btn primary" onclick="saveMainPersonEdit('opponent', ${caseId})">Kaydet</button>
                                        </div>
                                    </div>
                                    
                                    <!-- Ek Karşı Taraflar -->
                                    <div id="editAdditionalOpponentsDisplay" class="additional-display">
                                        <!-- Dinamik olarak eklenecek -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vekil Bilgileri -->
                            <div class="edit-section vekil-section" id="editLawyerSection" style="margin-top: 15px;">
                                <div class="section-header-with-add">
                                    <h3><i class="material-icons">account_balance</i> Vekil Bilgileri (Opsiyonel)</h3>
                                    <button type="button" class="btn-add-person" onclick="addNewLawyerInModal(${caseId})" title="Yeni Vekil Ekle">
                                        <i class="material-icons">add</i>
                                    </button>
                                </div>
                                

                                
                                <!-- Vekil Ekleme Butonu (Hiç vekil yoksa göster) -->
                                <div class="add-lawyer-btn-container" style="${(data.opponent_lawyer || data.opponent_lawyer_phone || data.opponent_lawyer_address || (data.additional_lawyers && data.additional_lawyers.length > 0)) ? 'display: none;' : ''}">
                                    <button type="button" class="btn btn-outline-primary" onclick="showMainLawyerEditForm()">
                                        <i class="material-icons">add</i> Vekil Ekle
                                    </button>
                                </div>
                                
                                <!-- Gizli Vekil Edit Formu -->
                                <div id="mainLawyerEditForm" style="display: none;" class="hidden-edit-form">
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Vekil Adı Soyadı</label>
                                            <input type="text" id="editOpponentLawyer" value="${data.opponent_lawyer || ''}">
                                        </div>
                                        <div class="detail-group">
                                            <label>Baro Numarası</label>
                                            <input type="text" id="editOpponentLawyerBarNumber" value="${data.opponent_lawyer_bar_number || ''}">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Vekil Telefonu</label>
                                            <input type="text" id="editOpponentLawyerPhone" value="${data.opponent_lawyer_phone || ''}">
                                        </div>
                                        <div class="detail-group full-width">
                                            <label>Vekil Adresi</label>
                                            <textarea id="editOpponentLawyerAddress" rows="2">${data.opponent_lawyer_address || ''}</textarea>
                                        </div>
                                    </div>
                                    <div class="edit-form-actions">
                                        <button type="button" class="btn secondary" onclick="cancelMainLawyerEdit()">İptal</button>
                                        <button type="button" class="btn primary" onclick="saveMainLawyerEdit(${caseId})">Kaydet</button>
                                    </div>
                                </div>
                                
                                <!-- Ek Vekiller Gösterim Alanı -->
                                <div id="editAdditionalLawyersDisplay" class="additional-display">
                                    <!-- Dinamik olarak ek vekiller buraya eklenecek -->
                                </div>
                            </div>
                            
                            <!-- Dosya Bilgileri -->
                            <h3><i class="material-icons">folder</i> Dosya Bilgileri</h3>
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Dosya Durumu</label>
                                    <select id="editStatusModal">
                                        <option value="Aktif" ${data.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                        <option value="Kapalı" ${data.status === 'Kapalı' ? 'selected' : ''}>Kapalı</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Açılış Tarihi</label>
                                    <input type="date" id="editOpenDate" value="${openDate}" disabled>
                                </div>
                            </div>
                             <!-- Duruşma Bilgileri Başlığı -->
                            <div class="detail-grid" style="padding-bottom:0; margin-bottom:0; border:none; background: none; box-shadow: none;"> {# Kenarlık ve arkaplanı kaldırarak görünmez yap #}
                                 <div class="detail-group" style="grid-column: span 4;">
                                     <label id="hearingInfoLabel" style="margin-bottom:0; ${data.next_hearing ? 'display:none;' : ''}">DURUŞMA BİLGİLERİ</label>
                                     <button type="button" class="btn btn-outline-primary btn-sm" id="showHearingInputBtn" style="${data.next_hearing ? 'display:none;' : 'display:flex; width: fit-content;'} margin-top:10px;">
                                        <i class="material-icons">add</i> Duruşma Ekle/Güncelle
                                    </button>
                                </div>
                            </div>
                            <!-- Gizli Duruşma Giriş Alanı -->
                            <div class="detail-grid" id="editHearingSection" style="${data.next_hearing ? '' : 'display: none;'} border-top: 1px solid #e9ecef; padding-top: 15px; margin-top: -15px;"> {# Üstteki boşluğu azaltmak için margin-top ayarı #}
                                <div class="detail-group" style="grid-column: span 3;"> {# Buton için yer açmak amacıyla 3 sütun kaplasın #}
                                    <label>Sonraki Duruşma Tarihi</label>
                                    <div class="hearing-datetime" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="editNextHearing" value="${nextHearing}" style="flex-grow: 1; width: auto; min-width: 120px; max-width:150px;">
                                        <input type="time" id="editHearingTime" value="${data.hearing_time || '09:00'}" style="flex-shrink: 0; width: auto; max-width: 100px; padding: 8px 10px;"> {# Max-width ekledim #}
                                    </div>
                                    <div class="hearing-type-inline" style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="editHearingType" id="editHearingTypeDurusma" value="durusma" ${data.hearing_type === 'durusma' || !data.hearing_type ? 'checked' : ''}>
                                            <label for="editHearingTypeDurusma" style="margin-bottom: 0; font-weight: normal;">Duruşma</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="editHearingType" id="editHearingTypeEDurusma" value="e-durusma" ${data.hearing_type === 'e-durusma' ? 'checked' : ''}>
                                            <label for="editHearingTypeEDurusma" style="margin-bottom: 0; font-weight: normal;">E-Duruşma</label>
                                        </div>
                                        {# Duruşmayı Kaldır butonu buraya taşındı #}
                                        <button type="button" class="btn btn-outline-danger btn-sm" id="removeHearingBtn" style="height: 30px; margin-left: 20px;"> {# Yüksekliği ayarla ve sola boşluk ekle #}
                                            <i class="material-icons">delete_outline</i> Duruşmayı Kaldır
                                        </button>
                                    </div>
                                </div>
                                {# Eski buton yeri kaldırıldı #}
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn secondary" onclick="closeEditModal()">İptal</button>
                        ${hasPermission('dosya_duzenle') ? `<button class="btn primary" onclick="saveChanges(${caseId})">Kaydet</button>` : ''}
                    </div>
                </div>
            `;
            
            // Eski modal'ları temizle
            const existingModal = document.getElementById('editModal');
            if (existingModal) {
                existingModal.remove();
                console.log('DEBUG: Removed existing modal');
            }
            
            const editModal = document.createElement('div');
            editModal.id = 'editModal';
            editModal.className = 'file-detail-modal';
            editModal.innerHTML = editHtml;
            document.body.appendChild(editModal);
            // editModal.style.display = 'flex'; // Bu satırı aşağı taşıdık

            const editFileTypeSelect = editModal.querySelector('#editFileType');
            
            // Debug: Modal oluşturulduktan sonra seçili değeri kontrol et
            console.log('DEBUG: editFileType select value after modal creation:', editFileTypeSelect.value);
            console.log('DEBUG: editFileType select HTML:', editFileTypeSelect.outerHTML);
            const editCitySelect = editModal.querySelector('#editCity');
            const editCourthouseSelect = editModal.querySelector('#editCourthouse');
            const editDepartmentSelect = editModal.querySelector('#editDepartment');

            // İlk adliye ve departman yüklemesi için
            updateEditCourthouses(editCitySelect, editCourthouseSelect, data.courthouse); // Adliyeleri yükle ve seçili adliyeyi ayarla
            populateEditDepartments(data.file_type, editDepartmentSelect, data.department, editCourthouseSelect.value, editCitySelect.value); // Departmanları yükle, temel ve numaralıyı ayarla


            editFileTypeSelect.onchange = function() {
                const selectedFileType = this.value;
                const shouldDisableCityAndCourthouse = ['ARABULUCULUK', 'AİHM', 'AYM'].includes(selectedFileType);
                const shouldDisableDepartment = ['ARABULUCULUK', 'AİHM', 'AYM', 'savcilik'].includes(selectedFileType);
                
                // Şehir ve adliye alanlarını etkinleştir/devre dışı bırak
                editCitySelect.disabled = shouldDisableCityAndCourthouse;
                editCourthouseSelect.disabled = shouldDisableCityAndCourthouse;
                
                // Devre dışı bırakıldıysa değerleri temizle
                if (shouldDisableCityAndCourthouse) {
                    editCitySelect.value = '';
                    editCourthouseSelect.innerHTML = '<option value="">Seçiniz</option>';
                }
                
                populateEditDepartments(selectedFileType, editDepartmentSelect, null, editCourthouseSelect.value, editCitySelect.value);
            };
            editCitySelect.onchange = function() {
                updateEditCourthouses(this, editCourthouseSelect, null); // Adliyeleri güncelle
                populateEditDepartments(editFileTypeSelect.value, editDepartmentSelect, null, editCourthouseSelect.value, this.value); // Departmanları adliyeye göre güncelle
            };
            editCourthouseSelect.onchange = function() {
                populateEditDepartments(editFileTypeSelect.value, editDepartmentSelect, null, this.value, editCitySelect.value); // Departmanları adliyeye göre güncelle
            };
             editDepartmentSelect.onchange = function() {
                updateEditNumberedDepartments(this.value, document.getElementById('editCity').value, document.getElementById('editCourthouse').value, data.department);
            };


            const showHearingBtn = editModal.querySelector('#showHearingInputBtn');
            const removeHearingBtn = editModal.querySelector('#removeHearingBtn');
            const hearingSection = editModal.querySelector('#editHearingSection');
            const nextHearingInput = editModal.querySelector('#editNextHearing');
            const hearingTimeInput = editModal.querySelector('#editHearingTime');
            const hearingInfoLabel = editModal.querySelector('#hearingInfoLabel');

            showHearingBtn.onclick = function() {
                hearingSection.style.display = 'grid'; // detail-grid 2 column span yapar
                showHearingBtn.style.display = 'none';
                hearingInfoLabel.style.display = 'none';
            };

            removeHearingBtn.onclick = function() {
                nextHearingInput.value = ''; 
                hearingTimeInput.value = '09:00'; 
                const durusmaRadio = editModal.querySelector('input[name="editHearingType"][value="durusma"]');
                if (durusmaRadio) durusmaRadio.checked = true;
                hearingSection.style.display = 'none';
                showHearingBtn.style.display = 'flex';
                 hearingInfoLabel.style.display = 'block';
            };
            
            // Ek müvekkilleri ve karşı tarafları göster - edit modal için
            if (data.additional_clients && data.additional_clients.length > 0) {
                const editAdditionalClientsDisplay = editModal.querySelector('#editAdditionalClientsDisplay');
                data.additional_clients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'collapsible-person-card editable-person-card';
                    clientDiv.setAttribute('data-person-type', 'client');
                    clientDiv.setAttribute('data-person-index', index);
                    clientDiv.innerHTML = `
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">person_add</i>
                                <div class="person-info">
                                    <div class="person-title">${client.capacity || 'Müvekkil'} - ${client.name || 'İsim belirtilmemiş'}</div>
                                    <div class="person-subtitle">${client.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}${client.identity_number ? ' • ' + client.identity_number : ''}</div>
                                </div>
                            </div>
                            <div class="card-actions" onclick="event.stopPropagation()">
                                <button type="button" class="btn-icon-small edit" onclick="editPersonInModal('client', ${index}, ${caseId})" title="Düzenle">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" class="btn-icon-small delete" onclick="deletePersonInModal('client', ${index}, ${caseId})" title="Sil">
                                    <i class="material-icons">delete</i>
                                </button>
                                <i class="material-icons collapse-arrow">expand_more</i>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value">${client.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value">${client.capacity || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value">${client.identity_number || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value">${client.phone || '-'}</span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value">${client.address || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    editAdditionalClientsDisplay.appendChild(clientDiv);
                });
            }
            
            if (data.additional_opponents && data.additional_opponents.length > 0) {
                const editAdditionalOpponentsDisplay = editModal.querySelector('#editAdditionalOpponentsDisplay');
                data.additional_opponents.forEach((opponent, index) => {
                    const opponentDiv = document.createElement('div');
                    opponentDiv.className = 'collapsible-person-card editable-person-card';
                    opponentDiv.setAttribute('data-person-type', 'opponent');
                    opponentDiv.setAttribute('data-person-index', index);
                    opponentDiv.innerHTML = `
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">group_add</i>
                                <div class="person-info">
                                    <div class="person-title">${opponent.capacity || 'Karşı Taraf'} - ${opponent.name || 'İsim belirtilmemiş'}</div>
                                    <div class="person-subtitle">${opponent.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}${opponent.identity_number ? ' • ' + opponent.identity_number : ''}</div>
                                </div>
                            </div>
                            <div class="card-actions" onclick="event.stopPropagation()">
                                <button type="button" class="btn-icon-small edit" onclick="editPersonInModal('opponent', ${index}, ${caseId})" title="Düzenle">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" class="btn-icon-small delete" onclick="deletePersonInModal('opponent', ${index}, ${caseId})" title="Sil">
                                    <i class="material-icons">delete</i>
                                </button>
                                <i class="material-icons collapse-arrow">expand_more</i>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value">${opponent.entity_type === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value">${opponent.capacity || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value">${opponent.identity_number || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value">${opponent.phone || '-'}</span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value">${opponent.address || '-'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    editAdditionalOpponentsDisplay.appendChild(opponentDiv);
                });
            }
            
            // Tüm vekilleri göster - Ana vekil + ek vekilleri birlikte
            const editAdditionalLawyersDisplay = editModal.querySelector('#editAdditionalLawyersDisplay');
            editAdditionalLawyersDisplay.innerHTML = ''; // Önce temizle
            
            // Ana vekili de listeye ekle
            const allEditLawyers = [];
            if (data.opponent_lawyer || data.opponent_lawyer_phone || data.opponent_lawyer_address) {
                allEditLawyers.push({
                    name: data.opponent_lawyer || 'Ad belirtilmemiş',
                    bar_number: data.opponent_lawyer_bar_number || '',
                    phone: data.opponent_lawyer_phone || '',
                    address: data.opponent_lawyer_address || '',
                    isMain: true,
                    id: 'main'
                });
            }
            
            // Ek vekilleri de listeye ekle
            if (data.additional_lawyers && data.additional_lawyers.length > 0) {
                data.additional_lawyers.forEach((lawyer, index) => {
                    allEditLawyers.push({
                        name: lawyer.name || 'İsim belirtilmemiş',
                        bar_number: lawyer.bar_number || '',
                        phone: lawyer.phone || '',
                        address: lawyer.address || '',
                        isMain: false,
                        id: index
                    });
                });
            }
            
            // Tüm vekilleri aynı formatta göster
            allEditLawyers.forEach((lawyer, displayIndex) => {
                const lawyerDiv = document.createElement('div');
                lawyerDiv.className = 'collapsible-person-card editable-person-card';
                lawyerDiv.setAttribute('data-lawyer-id', lawyer.id);
                lawyerDiv.setAttribute('data-is-main', lawyer.isMain);
                lawyerDiv.innerHTML = `
                    <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                        <div class="collapsible-title">
                            <i class="material-icons person-icon lawyer-icon">account_balance</i>
                            <div class="person-info">
                                <div class="person-title">Vekil - ${lawyer.name}</div>
                                <div class="person-subtitle">Baro No: ${lawyer.bar_number || 'Belirtilmemiş'}</div>
                            </div>
                        </div>
                        <div class="card-actions" onclick="event.stopPropagation()">
                            <button type="button" class="btn-icon-small edit" onclick="${lawyer.isMain ? 'editMainPersonInModal(\'opponent_lawyer\', ' + currentCaseId + ')' : 'editAdditionalLawyer(' + lawyer.id + ', event)'}" title="Düzenle">
                                <i class="material-icons">edit</i>
                            </button>
                            <button type="button" class="btn-icon-small delete" onclick="${lawyer.isMain ? 'deleteMainPersonInModal(\'opponent_lawyer\', ' + currentCaseId + ')' : 'deleteAdditionalLawyer(' + lawyer.id + ', event)'}" title="Sil">
                                <i class="material-icons">delete</i>
                            </button>
                            <i class="material-icons collapse-arrow">expand_more</i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="detail-info-grid">
                            <div class="detail-info-item">
                                <span class="detail-info-label">BARO NUMARASI</span>
                                <span class="detail-info-value">${lawyer.bar_number || '-'}</span>
                            </div>
                            <div class="detail-info-item">
                                <span class="detail-info-label">TELEFON</span>
                                <span class="detail-info-value">${lawyer.phone || '-'}</span>
                            </div>
                            <div class="detail-info-item full-width">
                                <span class="detail-info-label">ADRES</span>
                                <span class="detail-info-value">${lawyer.address || '-'}</span>
                            </div>
                        </div>
                    </div>
                `;
                editAdditionalLawyersDisplay.appendChild(lawyerDiv);
            });
            
            // Sıfat seçeneklerini yükle
            updateEditCapacityOptions();
            
            // Mevcut değerleri set et
            if (data.client_capacity) {
                document.getElementById('editClientCapacity').value = data.client_capacity;
            }
            if (data.opponent_capacity) {
                document.getElementById('editOpponentCapacity').value = data.opponent_capacity;
            }
            
            // Debug: Capacity'ler set edildikten sonra file type'ı kontrol et
            const currentFileTypeValue = document.getElementById('editFileType')?.value;
            console.log('DEBUG: editFileType after setting capacities:', currentFileTypeValue);
            
            // Manuel olarak file type'ı set et - SADECE yanlış değer alınmışsa
            if (currentFileTypeValue !== data.file_type) {
                console.log('DEBUG: Select value mismatch! Expected:', data.file_type, 'Got:', currentFileTypeValue);
                console.log('DEBUG: Manually correcting file type to:', data.file_type);
                document.getElementById('editFileType').value = data.file_type;
                console.log('DEBUG: After manual correction, value is:', document.getElementById('editFileType').value);
            } else {
                console.log('DEBUG: Select value is correct, no manual correction needed');
            }
            
            editModal.style.display = 'flex'; // Modal'ı tüm kurulumlar bittikten sonra göster
            
            // Debug: Modal tamamen açıldıktan sonra select değerini kontrol et
            setTimeout(() => {
                const finalFileType = document.getElementById('editFileType')?.value;
                console.log('DEBUG: Final editFileType value after modal fully loaded:', finalFileType);
            }, 100);
        });
}

// Düzenleme modalında sıfat seçeneklerini güncelle
function updateEditCapacityOptions() {
    const fileType = document.getElementById('editFileType')?.value;
    const clientCapacitySelect = document.getElementById('editClientCapacity');
    const opponentCapacitySelect = document.getElementById('editOpponentCapacity');
    
    if (!fileType || !clientCapacitySelect || !opponentCapacitySelect) return;
    
    // Müvekkil sıfat seçeneklerini güncelle
    clientCapacitySelect.innerHTML = '<option value="">Seçiniz</option>';
    if (capacityOptions[fileType] && capacityOptions[fileType].client) {
        capacityOptions[fileType].client.forEach(capacity => {
            const option = document.createElement('option');
            option.value = capacity;
            option.textContent = capacity;
            clientCapacitySelect.appendChild(option);
        });
    }
    
    // Karşı taraf sıfat seçeneklerini güncelle
    opponentCapacitySelect.innerHTML = '<option value="">Seçiniz</option>';
    if (capacityOptions[fileType] && capacityOptions[fileType].opponent && capacityOptions[fileType].opponent.length > 0) {
        capacityOptions[fileType].opponent.forEach(capacity => {
            const option = document.createElement('option');
            option.value = capacity;
            option.textContent = capacity;
            opponentCapacitySelect.appendChild(option);
        });
        opponentCapacitySelect.disabled = false;
    } else {
        opponentCapacitySelect.disabled = true;
    }
}

function updateEditCourthouses(citySelectElement, courthouseSelectElement, selectedCourthouse) {
    const selectedCity = citySelectElement.value;
    courthouseSelectElement.innerHTML = '<option value="">Seçiniz</option>'; // Önceki adliyeleri temizle

    if (selectedCity === 'İstanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            if (selectedCourthouse === courthouse) option.selected = true;
            courthouseSelectElement.appendChild(option);
        });
    }
    
    if (selectedCity && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            // İstanbul adliyesiyse ve zaten eklendiyse tekrar ekleme
            if (selectedCity === 'İstanbul' && istanbulSpecificCourthouses.includes(courthouse)) {
                return;
            }
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            if (selectedCourthouse === courthouse) option.selected = true;
            courthouseSelectElement.appendChild(option);
        });
    }

    if (courthouseSelectElement.options.length <= 1) {
        if (selectedCity) {
            courthouseSelectElement.innerHTML = '<option value="">Bu şehir için adliye bulunamadı</option>';
        } else {
            courthouseSelectElement.innerHTML = '<option value="">Önce Şehir Seçiniz</option>';
        }
    }
}


// Düzenleme modalında birim seçeneklerini güncelle
function populateEditDepartments(fileType, departmentSelect, fullSelectedDepartment, selectedCourthouse, selectedCity) {
    departmentSelect.innerHTML = '<option value="">Seçiniz</option>';
        departmentSelect.disabled = false;

    let departmentsToShow = [];
    if (fileType === 'hukuk') {
        departmentsToShow = originalDepartments.filter(dept => ![
            'Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği', 'İcra Dairesi'
        ].includes(dept));
    } else if (fileType === 'ceza') {
        departmentsToShow = originalDepartments.filter(dept => [
            'Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği'
        ].includes(dept));
    } else if (fileType === 'icra') {
        departmentsToShow = ['İcra Dairesi'];
    } else if (['ARABULUCULUK', 'AİHM', 'AYM', 'savcilik'].includes(fileType)) {
        departmentSelect.disabled = true;
        updateEditNumberedDepartments(null, selectedCity, selectedCourthouse, null); // Numaralıyı da gizle
        return;
    } else { // Tümü veya bilinmeyen
        departmentsToShow = originalDepartments;
    }

    departmentsToShow.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
    });

    let baseDepartmentToSelect = null;
    if (fullSelectedDepartment) {
        const match = fullSelectedDepartment.match(/^(\d+\.\s+)?(.*)$/);
        if (match && match[2]) {
            baseDepartmentToSelect = match[2]; // "Asliye Hukuk Mahkemesi"
        }
    }
    
    if (baseDepartmentToSelect && Array.from(departmentSelect.options).some(opt => opt.value === baseDepartmentToSelect)) {
        departmentSelect.value = baseDepartmentToSelect;
    } else if (departmentSelect.options.length > 1 && !baseDepartmentToSelect && !fullSelectedDepartment) {
        // Eğer bir seçim yoksa ve seçenekler varsa ilkini seçme (Seçiniz kalsın)
    } else if (baseDepartmentToSelect) {
         console.warn(`populateEditDepartments: Temel departman "${baseDepartmentToSelect}" dropdown'da bulunamadı. Dosya türü: ${fileType}`);
    }
    
    updateEditNumberedDepartments(departmentSelect.value, selectedCity, selectedCourthouse, fullSelectedDepartment);
}

// Düzenleme modalında mahkeme numaralarını güncelle
function updateEditNumberedDepartments(baseDepartment, selectedCity, selectedCourthouse, fullSelectedDepartmentToSelect) {
    const numberedDepartmentContainer = document.getElementById('editNumberedDepartmentContainer');
    const numberedDepartmentSelect = document.getElementById('editNumberedDepartment');
    
    numberedDepartmentSelect.innerHTML = '<option value="">Seçiniz</option>'; // Her zaman temizle
    
    if (!baseDepartment || baseDepartment === '' || ['ARABULUCULUK', 'AİHM', 'AYM', 'savcilik'].includes(document.getElementById('editFileType').value)) {
        numberedDepartmentContainer.style.display = 'none';
        return;
    }

    // Tüm şehirler ve adliyeler için 70'e kadar mahkeme seçeneği
    let maxCourtNumber = 70; // 30'dan 70'e çıkarıldı - artık tüm lokasyonlar için geçerli
    
    if (baseDepartment === 'İcra Dairesi') { // İcra daireleri için özel numaralandırma
         for (let i = 1; i <= maxCourtNumber; i++) { // Genelde 30 olur ama dinamik olsun
            const optionValue = `${i}. ${baseDepartment}`;
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            numberedDepartmentSelect.appendChild(option);
        }
    } else {
        // Temel mahkeme adını da bir seçenek olarak ekle (Numarasız hali)
    const baseOption = document.createElement('option');
        baseOption.value = baseDepartment; 
        baseOption.textContent = baseDepartment;
        numberedDepartmentSelect.appendChild(baseOption);
    
    for (let i = 1; i <= maxCourtNumber; i++) {
            const optionValue = `${i}. ${baseDepartment}`;
        const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            numberedDepartmentSelect.appendChild(option);
    }
    }
    
    numberedDepartmentContainer.style.display = 'flex'; // block yerine flex daha iyi olabilir
    
    // Kaydedilmiş veya seçilmiş numaralı/temel değeri ayarla
    if (fullSelectedDepartmentToSelect && Array.from(numberedDepartmentSelect.options).some(opt => opt.value === fullSelectedDepartmentToSelect)) {
        numberedDepartmentSelect.value = fullSelectedDepartmentToSelect;
    } else if (baseDepartment && Array.from(numberedDepartmentSelect.options).some(opt => opt.value === baseDepartment) &&
               (!fullSelectedDepartmentToSelect || !fullSelectedDepartmentToSelect.match(/^\d+\.\s+(.*)$/))) {
        // Eğer fullSelectedDepartmentToSelect numarasızsa veya yoksa ve baseDepartment listede varsa onu seç
        numberedDepartmentSelect.value = baseDepartment;
    }
}

// Değişiklikleri kaydet
function saveChanges(caseId) {
    // Seçili departman değerini al (Önce numaralıdan, sonra temelden)
    const numberedDeptSelect = document.getElementById('editNumberedDepartment');
    const baseDeptSelect = document.getElementById('editDepartment');
    let finalDepartmentValue = baseDeptSelect.value; // Varsayılan olarak temel departman
    
    // Eğer numaralı departman görünür ve bir değer seçiliyse onu kullan
    if (numberedDeptSelect && getComputedStyle(numberedDeptSelect.parentElement).display !== 'none' && numberedDeptSelect.value) {
        finalDepartmentValue = numberedDeptSelect.value;
    } else if (!baseDeptSelect.disabled && baseDeptSelect.value) {
        // Numaralı görünür değilse veya seçilmemişse, temel departmanı kullan (eğer devre dışı değilse)
        finalDepartmentValue = baseDeptSelect.value;
    } else {
        // Hiçbiri uygun değilse (örn. Savcılık vs.) null yap
        finalDepartmentValue = null;
    }
    
    // Duruşma türünü al
    const hearingTypeRadios = document.querySelectorAll('input[name="editHearingType"]');
    let hearingType = 'durusma'; // varsayılan değer
    for (const radio of hearingTypeRadios) {
        if (radio.checked) {
            hearingType = radio.value;
            break;
        }
    }
    
    // Ek müvekkilleri topla
    const additionalClients = [];
    const additionalClientCards = document.querySelectorAll('#editAdditionalClientsDisplay .collapsible-person-card');
    additionalClientCards.forEach(card => {
        const personIndex = card.getAttribute('data-person-index');
        const titleText = card.querySelector('.person-title')?.textContent || '';
        const subtitleText = card.querySelector('.person-subtitle')?.textContent || '';
        const detailItems = card.querySelectorAll('.detail-info-item');
        
        const client = {
            name: titleText.includes(' - ') ? titleText.split(' - ')[1] : titleText,
            capacity: titleText.includes(' - ') ? titleText.split(' - ')[0] : '',
            entity_type: subtitleText.includes('Tüzel Kişi') ? 'company' : 'person'
        };
        
        // Detail bilgilerini al
        detailItems.forEach(item => {
            const label = item.querySelector('.detail-info-label')?.textContent;
            const value = item.querySelector('.detail-info-value')?.textContent;
            
            if (label && value && value !== '-') {
                switch(label) {
                    case 'KİMLİK / VERGİ NO':
                        client.identity_number = value;
                        break;
                    case 'TELEFON':
                        client.phone = value;
                        break;
                    case 'ADRES':
                        client.address = value;
                        break;
                }
            }
        });
        
        additionalClients.push(client);
    });
    
    // Ek karşı tarafları topla
    const additionalOpponents = [];
    const additionalOpponentCards = document.querySelectorAll('#editAdditionalOpponentsDisplay .collapsible-person-card');
    additionalOpponentCards.forEach(card => {
        const titleText = card.querySelector('.person-title')?.textContent || '';
        const subtitleText = card.querySelector('.person-subtitle')?.textContent || '';
        const detailItems = card.querySelectorAll('.detail-info-item');
        
        const opponent = {
            name: titleText.includes(' - ') ? titleText.split(' - ')[1] : titleText,
            capacity: titleText.includes(' - ') ? titleText.split(' - ')[0] : '',
            entity_type: subtitleText.includes('Tüzel Kişi') ? 'company' : 'person'
        };
        
        // Detail bilgilerini al
        detailItems.forEach(item => {
            const label = item.querySelector('.detail-info-label')?.textContent;
            const value = item.querySelector('.detail-info-value')?.textContent;
            
            if (label && value && value !== '-') {
                switch(label) {
                    case 'KİMLİK / VERGİ NO':
                        opponent.identity_number = value;
                        break;
                    case 'TELEFON':
                        opponent.phone = value;
                        break;
                    case 'ADRES':
                        opponent.address = value;
                        break;
                }
            }
        });
        
        additionalOpponents.push(opponent);
    });
    
    // Ek vekilleri topla
    const additionalLawyers = [];
    const additionalLawyerCards = document.querySelectorAll('#editAdditionalLawyersDisplay .collapsible-person-card[data-is-main="false"]');
    additionalLawyerCards.forEach(card => {
        const titleText = card.querySelector('.person-title')?.textContent || '';
        const detailItems = card.querySelectorAll('.detail-info-item');
        
        const lawyer = {
            name: titleText.includes(' - ') ? titleText.split(' - ')[1] : titleText.replace('Vekil - ', '')
        };
        
        // Detail bilgilerini al
        detailItems.forEach(item => {
            const label = item.querySelector('.detail-info-label')?.textContent;
            const value = item.querySelector('.detail-info-value')?.textContent;
            
            if (label && value && value !== '-') {
                switch(label) {
                    case 'BARO NUMARASI':
                        lawyer.bar_number = value;
                        break;
                    case 'TELEFON':
                        lawyer.phone = value;
                        break;
                    case 'ADRES':
                        lawyer.address = value;
                        break;
                }
            }
        });
        
        additionalLawyers.push(lawyer);
    });

    // Çoklu select sorunu için en son (aktif) olanı al
    const allFileTypeSelects = document.querySelectorAll('#editFileType');
    const fileTypeElement = allFileTypeSelects[allFileTypeSelects.length - 1]; // En son olanı al
    console.log('DEBUG: Using select index:', allFileTypeSelects.length - 1, 'out of', allFileTypeSelects.length);
    const fileTypeValue = fileTypeElement.value;
    const selectedOption = fileTypeElement.options[fileTypeElement.selectedIndex];
    
    console.log('DEBUG: saveChanges - editFileType element:', fileTypeElement);
    console.log('DEBUG: saveChanges - selected file_type value:', fileTypeValue);
    console.log('DEBUG: saveChanges - selectedIndex:', fileTypeElement.selectedIndex);
    console.log('DEBUG: saveChanges - selected option:', selectedOption);
    console.log('DEBUG: saveChanges - all select options:', Array.from(fileTypeElement.options).map(opt => ({value: opt.value, selected: opt.selected, text: opt.text})));
    
    // Manuel kontrol: Gerçekten hangi option seçili?
    const actuallySelectedOptions = Array.from(fileTypeElement.options).filter(opt => opt.selected);
    console.log('DEBUG: saveChanges - actually selected options:', actuallySelectedOptions);
    
    // Çoklu element kontrolü (artık düzeltildi ama debug için bırakıyoruz)
    console.log('DEBUG: saveChanges - found editFileType selects:', allFileTypeSelects.length);
    if (allFileTypeSelects.length > 1) {
        console.warn('DEBUG: Multiple selects found! Using the last one.');
        allFileTypeSelects.forEach((select, index) => {
            console.log(`DEBUG: Select ${index}:`, select.value, index === allFileTypeSelects.length - 1 ? '(USING THIS)' : '(ignored)');
        });
    }
    
    const data = {
        file_type: fileTypeValue,
        courthouse: document.getElementById('editCourthouse').value,
        department: finalDepartmentValue, // Güncellenmiş departman değeri
        
        // Müvekkil bilgileri
        client_entity_type: document.getElementById('editClientEntityType').value,
        client_name: document.getElementById('editClientName').value,
        client_capacity: document.getElementById('editClientCapacity').value,
        client_identity_number: document.getElementById('editClientIdentityNumber').value,
        client_address: document.getElementById('editClientAddress').value,
        phone_number: document.getElementById('editPhoneNumber').value,
        
        // Karşı taraf bilgileri
        opponent_entity_type: document.getElementById('editOpponentEntityType').value,
        opponent_name: document.getElementById('editOpponentName').value,
        opponent_capacity: document.getElementById('editOpponentCapacity').value,
        opponent_identity_number: document.getElementById('editOpponentIdentityNumber').value,
        opponent_phone: document.getElementById('editOpponentPhone').value,
        opponent_address: document.getElementById('editOpponentAddress').value,
        
        // Vekil bilgileri
        opponent_lawyer: document.getElementById('editOpponentLawyer').value,
        opponent_lawyer_bar_number: document.getElementById('editOpponentLawyerBarNumber').value,
        opponent_lawyer_phone: document.getElementById('editOpponentLawyerPhone').value,
        opponent_lawyer_address: document.getElementById('editOpponentLawyerAddress').value,
        
        // Ek kişiler
        additional_clients_json: additionalClients,
        additional_opponents_json: additionalOpponents,
        additional_lawyers_json: additionalLawyers,
        
        // Dosya bilgileri
        status: document.getElementById('editStatus').value,
    };

    // Debug: Status değerini özellikle kontrol et
    console.log('DEBUG: editStatusModal element:', document.getElementById('editStatusModal'));
    console.log('DEBUG: editStatusModal value:', document.getElementById('editStatusModal') ? document.getElementById('editStatusModal').value : 'BULUNAMADI');
    console.log('DEBUG: editStatus (old) element:', document.getElementById('editStatus'));
    console.log('DEBUG: editStatus (old) value:', document.getElementById('editStatus') ? document.getElementById('editStatus').value : 'BULUNAMADI');

    // Status'u mevcut data objesine ekle
    data.status = document.getElementById('editStatusModal') ? document.getElementById('editStatusModal').value : 'Aktif';
    data.next_hearing = document.querySelector('#editModal #editNextHearing').value || null;
    data.hearing_time = document.querySelector('#editModal #editHearingTime').value || null;
    data.hearing_type = hearingType;
    
    // Debug: Form verilerini konsola yazdır
    console.log('Form verileri:', {
        next_hearing: data.next_hearing,
        hearing_time: data.hearing_time,
        hearing_type: data.hearing_type,
        status: data.status
    });
    
    // Debug: Element kontrolü
    const nextHearingEl = document.querySelector('#editModal #editNextHearing');
    const hearingTimeEl = document.querySelector('#editModal #editHearingTime');
    console.log('Element değerleri:', {
        nextHearingElement: nextHearingEl,
        nextHearingValue: nextHearingEl ? nextHearingEl.value : 'Element bulunamadı',
        hearingTimeElement: hearingTimeEl,
        hearingTimeValue: hearingTimeEl ? hearingTimeEl.value : 'Element bulunamadı'
    });



    // Sadece müvekkil adı kontrolü yap
    if (!data.client_name || data.client_name.trim() === '') {
        alert('Lütfen müvekkil adını giriniz.');
        return;
    }

    // DEBUG LOGS - Status kontrolü
    const statusElement = document.getElementById('editStatusModal');
    const oldStatusElement = document.getElementById('editStatus');
    console.log('DEBUG: editStatusModal element found:', statusElement);
    console.log('DEBUG: editStatusModal value:', statusElement ? statusElement.value : 'ELEMENT BULUNAMADI');
    console.log('DEBUG: editStatusModal selectedIndex:', statusElement ? statusElement.selectedIndex : 'N/A');
    console.log('DEBUG: old editStatus element (should be different):', oldStatusElement ? oldStatusElement.value : 'N/A');
    console.log('DEBUG: Data being sent to server:', data);
    console.log('DEBUG: file_type in data:', data.file_type);
    console.log('DEBUG: status in data:', data.status);
    
    fetch(`/edit_case/${caseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 403) {
            alert('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz. Dosya düzenleme yetkisi gereklidir.');
            closeEditModal();
            return Promise.reject(new Error('Yetki hatası'));
        }
        
        // Yanıtı JSON olarak parse et
        return response.json().then(result => {
            if (!response.ok) {
                // Sunucudan gelen hata mesajını kullan
                throw new Error(result.message || `Sunucu hatası (${response.status})`);
            }
            return result;
        });
    })
    .then(result => {
        if (result.success) {
                            showGlobalNotification('Dosya başarıyla güncellendi!', 'success');
            
            // Takvim senkronizasyonu için dosya durumunu ve duruşma türünü gönder
            if (data.next_hearing) {
                console.log('Takvim senkronizasyonu başlatılıyor:', {
                    caseId: caseId,
                    next_hearing: data.next_hearing,
                    hearing_time: data.hearing_time,
                    status: data.status,
                    hearingType: hearingType
                });
                syncHearingToCalendar(caseId, data.next_hearing, data.hearing_time, data.status, hearingType);
            } else {
                console.log('Takvim senkronizasyonu atlandı - next_hearing yok:', data.next_hearing);
            }
            
            closeEditModal();
            // Detay modalını güncelle ve geri dön
            showDetails(caseId);
        } else {
            throw new Error(result.message || 'Güncelleme sırasında bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Dosya güncelleme hatası:', error);
        if (error.message !== 'Yetki hatası') {
            alert('Güncelleme sırasında bir hata oluştu: ' + error.message);
        }
    });
}

// Masraf ekle modalını güncelle
function showExpenseModal() {
    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf Ekle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf Türü</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">Seçiniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}">${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf türünü yazınız" 
                                       style="display: none;">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required>
                                <span class="currency-symbol">₺</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ödeme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input">
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ödenmedi</span>
                                    <span class="toggle-text-on">Ödendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>Açıklama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili açıklama ekleyin..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">İptal</button>
                <button class="btn primary" onclick="saveExpense()">Kaydet</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// Diğer seçeneği için input alanını göster/gizle
function handleExpenseTypeChange() {
    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    
    if (expenseType.value === 'Diğer') {
        otherExpenseType.style.display = 'block';
        otherExpenseType.required = true;
    } else {
        otherExpenseType.style.display = 'none';
        otherExpenseType.required = false;
    }
}

// Masraf kaydetme fonksiyonunu güncelle
let isSavingExpense = false; // Çift kayıt önleme flag'ı

function saveExpense() {
    // Zaten kaydetme işlemi devam ediyorsa çık
    if (isSavingExpense) {
        return;
    }

    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    const amount = document.getElementById('expenseAmount');
    const date = document.getElementById('expenseDate');
    const status = document.getElementById('expenseStatus');
    const description = document.getElementById('expenseDescription');

    // Form validasyonu
    if (!expenseType.value) {
        alert('Lütfen masraf türünü seçiniz.');
        return;
    }
    if (expenseType.value === 'Diğer' && !otherExpenseType.value) {
        alert('Lütfen masraf türünü yazınız.');
        return;
    }
    if (!amount.value || amount.value <= 0) {
        alert('Lütfen geçerli bir tutar giriniz.');
        return;
    }
    if (!date.value) {
        alert('Lütfen tarih seçiniz.');
        return;
    }

    // Kaydetme işlemini başlat
    isSavingExpense = true;

    const data = {
        expense_type: expenseType.value === 'Diğer' ? otherExpenseType.value : expenseType.value,
        amount: parseFloat(amount.value),
        date: date.value,
        is_paid: status.checked,
        description: description.value || ''
    };

    fetch(`/add_expense/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf eklenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf eklenirken bir hata oluştu: ' + error.message);
    })
    .finally(() => {
        // İşlem tamamlandığında flag'ı sıfırla
        isSavingExpense = false;
    });
}

// Belge yükle butonu için fonksiyon
function showUploadModal() {
    const uploadHtml = `
        <div class="modal-content upload-modal">
            <div class="modal-header">
                <h2>Belge Yükle</h2>
                <button class="close-btn" onclick="closeUploadModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="detail-group">
                        <label>Belge Türü</label>
                        <select id="documentType" required>
                            <option value="">Seçiniz</option>
                            ${documentTypes.map(type => 
                                `<option value="${type}">${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="detail-group">
                        <label>Belge</label>
                        <input type="file" id="documentFile" required>
                    </div>
                    <div class="detail-group">
                        <label>Belge Adı (Opsiyonel)</label>
                        <input type="text" id="documentName" placeholder="Belgeye özel bir isim verin">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeUploadModal()">İptal</button>
                <button class="btn primary" onclick="uploadDocument()">Yükle</button>
            </div>
        </div>
    `;
    
    const uploadModal = document.createElement('div');
    uploadModal.id = 'uploadModal';
    uploadModal.className = 'file-detail-modal';
    uploadModal.innerHTML = uploadHtml;
    document.body.appendChild(uploadModal);
    uploadModal.style.display = 'flex';
}

// Belge yükleme fonksiyonunu güncelle
function uploadDocument() {
    const documentType = document.getElementById('documentType');
    const fileInput = document.getElementById('documentFile');
    const documentName = document.getElementById('documentName');
    const uploadButton = document.querySelector('#uploadModal .btn.primary');

    if (!documentType.value) {
        showGlobalNotification('Lütfen belge türünü seçiniz.', 'error');
        return;
    }

    if (!fileInput.files.length) {
        showGlobalNotification('Lütfen bir belge seçiniz.', 'error');
        return;
    }

    // Yükleme butonu loading göstericisini aktif et
    const originalButtonText = uploadButton.textContent;
    uploadButton.textContent = 'Yükleniyor...';
    uploadButton.disabled = true;

    const formData = new FormData();
    formData.append('document', fileInput.files[0]);
    formData.append('document_type', documentType.value);
    formData.append('csrf_token', csrfToken);
    if (documentName.value) {
        formData.append('document_name', documentName.value);
    }

    fetch(`/upload_document/${parseInt(currentCaseId)}`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.status === 403) {
            throw new Error('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz.');
        }

        if (response.status === 413) {
            throw new Error('Dosya çok büyük. Lütfen daha küçük bir dosya seçin.');
        }

        if (response.status === 500) {
            throw new Error('Sunucu hatası - Lütfen yöneticinizle iletişime geçin');
        }

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        return response.json();
    })
    .then(result => {
        if (result.success) {
            showGlobalNotification('Belge başarıyla yüklendi!', 'success');
            closeUploadModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Belge yüklenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        showGlobalNotification('Belge yüklenirken bir hata oluştu: ' + error.message, 'error');
    })
    .finally(() => {
        // Butonu eski haline döndür
        uploadButton.textContent = originalButtonText;
        uploadButton.disabled = false;
    });
}

// Belge önizleme fonksiyonu
function previewDocument(docId, filename) {
    // Orijinal dosya uzantısını bul
    let ext = '';
    // Dosya adında nokta varsa son noktadan sonrasını al
    if (filename.includes('.')) {
        ext = filename.split('.').pop().toLowerCase();
    } else {
        // Eğer özel isim verilmiş ve uzantı yoksa, sunucudan dosya bilgisini al
        fetch(`/get_document_info/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.original_filename) {
                    ext = data.original_filename.split('.').pop().toLowerCase();
                    showPreviewModal(docId, filename, ext);
                } else {
                    alert('Dosya türü belirlenemedi.');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Dosya bilgisi alınırken bir hata oluştu.');
            });
        return;
    }
    
    showPreviewModal(docId, filename, ext);
}

// Önizleme modalını güncelle (TIFF ve DOCX desteği ekle)
function showPreviewModal(docId, filename, ext) {
    const previewUrl = `/preview_document/${docId}`;
    const modalContentElement = document.createElement('div');
    modalContentElement.className = 'modal-content preview-modal-content';

    const previewHtml = `
        <div class="modal-header">
            <h2>${filename}</h2>
            <button class="close-btn" onclick="closePreviewModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body preview-modal-body">
            <div class="document-preview-container" id="previewContainer-${docId}" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: white;">
                <p>Önizleme yükleniyor...</p> {# Initial loading message #}
            </div>
        </div>
    `;
    modalContentElement.innerHTML = previewHtml;

    const previewModal = document.createElement('div');
    previewModal.id = 'previewModal';
    previewModal.className = 'file-detail-modal';
    previewModal.appendChild(modalContentElement);
    document.body.appendChild(previewModal);
    previewModal.style.display = 'flex';

    const previewContainer = document.getElementById(`previewContainer-${docId}`);
    previewContainer.innerHTML = '<p>Önizleme yükleniyor...</p>'; // Reset content

    function showError(message) {
        previewContainer.style.background = 'white';
        previewContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="material-icons" style="font-size: 48px; color: #999;">error_outline</i>
                <p style="margin-top: 15px; font-size: 1.1rem; color: #555;">${message}</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #777;">Belgeyi görüntülemek için lütfen indirin.</p>
                <button class="btn primary" style="margin-top: 20px;" onclick="downloadDocument(${docId})">
                    <i class="material-icons" style="margin-right: 5px;">download</i> İndir
                </button>
            </div>
        `;
    }

    // UDF için özel görüntüleyici
    function showUdfHelp() {
        previewContainer.style.background = 'white';
        previewContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="material-icons" style="font-size: 48px; color: #3f51b5;">info</i>
                <p style="margin-top: 15px; font-size: 1.1rem; color: #555;">UDF Dosyası (Ulusal Yargı Ağı Projesi)</p>
                <p style="margin: 15px 0; color: #666; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                    UDF dosyaları, UYAP sistemine özgü belgelerdir ve özel UYAP Editör yazılımı ile açılmalıdır. 
                    Bu dosyaları görüntülemek için aşağıdaki adımları takip edebilirsiniz:
                </p>
                <ol style="text-align: left; max-width: 600px; margin: 15px auto; color: #666;">
                    <li>Dosyayı indirin</li>
                    <li>UYAP Editör programını açın (bilgisayarınızda yüklü değilse <a href="https://www.e-justice.gov.tr/indir" target="_blank">e-justice.gov.tr</a> adresinden edinebilirsiniz)</li>
                    <li>İndirdiğiniz UDF dosyasını UYAP Editör ile açın</li>
                </ol>
                <button class="btn primary" style="margin-top: 20px;" onclick="downloadDocument(${docId})">
                    <i class="material-icons" style="margin-right: 5px;">download</i> UDF Dosyasını İndir
                </button>
            </div>
        `;
    }

    if (ext === 'pdf' || ext === 'txt') {
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `<iframe id="previewFrame" src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%;"></iframe>`;
    } else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'].includes(ext)) {
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `<img src="${previewUrl}" alt="Belge önizleme" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
    } else if (ext === 'tiff' || ext === 'tif') {
        previewContainer.style.background = '#f5f5f5';
        fetch(previewUrl)
            .then(response => {
                if (!response.ok) throw new Error('TIFF dosyası yüklenemedi');
                return response.arrayBuffer();
            })
            .then(buffer => {
                Tiff.initialize({ TOTAL_MEMORY: 16777216 * 5 }); // Bellek ayır
                const tiff = new Tiff({ buffer: buffer });
                const canvas = tiff.toCanvas();
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
                canvas.style.objectFit = 'contain';
                previewContainer.innerHTML = ''; // Clear loading
                previewContainer.appendChild(canvas);
            })
            .catch(error => {
                console.error('TIFF Önizleme Hatası:', error);
                showError(`".${ext}" uzantılı dosya için önizleme yüklenirken hata oluştu.`);
            });
    } else if (ext === 'docx' || ext === 'doc') {
        // Varsayım: Backend bu dosyaları PDF'e çevirip sunacak
        // veya tarayıcının iframe'de gösterebileceği bir formata.
        previewContainer.style.background = '#f5f5f5'; // PDF'teki gibi
        previewContainer.innerHTML = `<iframe id="previewFrame" src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%;"></iframe>`;
        
        const iframe = previewContainer.querySelector('#previewFrame');
        if (iframe) {
            iframe.onload = () => {
                // Başarıyla yüklendiğinde, alttaki genel indirme mesajını gizleyebiliriz.
                console.log('DOC/DOCX (PDF olarak) iframe başarıyla yüklendi.');
                // İsteğe bağlı: Yükleme sonrası alttaki "Belge yüklenirken sorun yaşanırsa..." mesajını gizleyebilirsiniz.
                // Örnek:
                // const docxFooterMessage = document.querySelector('.preview-modal-content .modal-body > div[style*="background: #f0f0f0"]');
                // if (docxFooterMessage) {
                //     docxFooterMessage.style.display = 'none';
                // }
            };
            iframe.onerror = () => {
                // showError fonksiyonu zaten bir indirme butonu içeriyor.
                showError(`".${ext}" uzantılı dosya için önizleme yüklenemedi. Dosya formatı tarayıcıda doğrudan görüntülenemiyor veya sunucu PDF'e dönüştürme hatası oluştu. Lütfen dosyayı indirip görüntüleyin.`);
            };
        } else {
             showError(`".${ext}" uzantılı dosya için önizleme alanı (iframe) oluşturulamadı. Lütfen dosyayı indirip görüntüleyin.`);
        }
    } else if (ext === 'udf') {
        // UDF dosyasını doğrudan uygulama içinde görüntüle
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `
            <iframe src="/direct_view_udf/${docId}" frameborder="0" style="width: 100%; height: 100%;"></iframe>
        `;
    } else { // Diğer desteklenmeyenler
        showError(`".${ext}" uzantılı dosyalar için önizleme desteklenmiyor.`);
    }
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (modal) {
        modal.remove();
    }
}

// Belge indirme fonksiyonu
function downloadDocument(docId) {
    const link = document.createElement('a');
    link.href = `/download_document/${docId}`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Belge silme fonksiyonu
function deleteDocument(docId) {
    if (confirm('Bu belgeyi silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_document/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.status === 403) {
                showGlobalNotification('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz. Dosya silme yetkisi gereklidir.', 'error');
                return Promise.reject(new Error('Yetki hatası'));
            }

            if (response.status === 500) {
                throw new Error('Sunucu hatası - Lütfen yöneticinizle iletişime geçin');
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showGlobalNotification('Belge başarıyla silindi!', 'success');
                if (result.warning) {
                    showGlobalNotification(result.warning, 'warning');
                }
                showDetails(currentCaseId); // Belge listesini güncelle
            } else {
                throw new Error(result.message || 'Belge silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            if (error.message !== 'Yetki hatası') {
                showGlobalNotification('Belge silinirken bir hata oluştu: ' + error.message, 'error');
            }
        });
    }
}

// Modal kapatma fonksiyonları
function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.remove();
    }
}

// YENİ - Katlanabilir kart toggle fonksiyonu
function toggleCollapsibleCard(header) {
    const card = header.closest('.collapsible-person-card');
    const content = card.querySelector('.collapsible-content');
    const arrow = header.querySelector('.collapse-arrow');
    
    if (content.classList.contains('open')) {
        content.classList.remove('open');
        arrow.textContent = 'expand_more';
        arrow.style.transform = 'rotate(0deg)';
    } else {
        content.classList.add('open');
        arrow.textContent = 'expand_less';
        arrow.style.transform = 'rotate(180deg)';
    }
}

// Ana müvekkil/karşı taraf düzenleme fonksiyonu - ek kişi mantığıyla
function editMainPersonInModal(personType, caseId) {
    const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
    const personCard = document.getElementById(cardId);
    
    if (!personCard) return;
    
    // Mevcut card'ı gizle ve edit form'u göster
    const cardContent = personCard.querySelector('.collapsible-content');
    const editFormId = `mainEditForm_${personType}`;
    
    // Eğer edit form yoksa oluştur
    let editForm = document.getElementById(editFormId);
    if (!editForm) {
        createMainEditForm(personType, caseId);
        editForm = document.getElementById(editFormId);
    }
    
    // Card content'i gizle, edit form'u göster
    if (cardContent && editForm) {
        cardContent.style.display = 'none';
        editForm.style.display = 'block';
        
        // Mevcut değerleri forma yükle
        loadMainPersonDataToEditForm(personType);
    }
}

// Ana kişi düzenleme iptal fonksiyonu
function cancelMainPersonEdit(personType) {
    const editFormId = `mainEditForm_${personType}`;
    const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
    const personCard = document.getElementById(cardId);
    const editForm = document.getElementById(editFormId);
    
    if (personCard && editForm) {
        const cardContent = personCard.querySelector('.collapsible-content');
        editForm.style.display = 'none';
        if (cardContent) {
            cardContent.style.display = 'block';
        }
    }
}

// Ana kişi silme fonksiyonu
function deleteMainPersonInModal(personType, caseId) {
    const personTypeText = personType === 'client' ? 'müvekkil' : 'karşı taraf';
    
    if (confirm(`Ana ${personTypeText} bilgilerini silmek istediğinizden emin misiniz?`)) {
        // Backend'e silme isteği gönder
        const formData = new FormData();
        formData.append('case_id', caseId);
        formData.append('person_type', personType);
        formData.append('csrf_token', csrfToken);
        
        fetch('/delete_main_person', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Form alanlarını temizle
                const prefix = personType === 'client' ? 'Client' : 'Opponent';
                
                document.getElementById(`edit${prefix}EntityType`).value = 'person';
                document.getElementById(`edit${prefix}Capacity`).value = '';
                document.getElementById(`edit${prefix}Name`).value = '';
                document.getElementById(`edit${prefix}IdentityNumber`).value = '';
                
                if (personType === 'client') {
                    document.getElementById('editPhoneNumber').value = '';
                    document.getElementById('editClientAddress').value = '';
                } else {
                    document.getElementById('editOpponentPhone').value = '';
                    document.getElementById('editOpponentAddress').value = '';
                }
                
                // Card'ı güncelle
                const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
                const personCard = document.getElementById(cardId);
                
                if (personCard) {
                    const titleElement = personCard.querySelector('.person-title');
                    if (titleElement) {
                        titleElement.textContent = `${personType === 'client' ? 'Müvekkil' : 'Karşı Taraf'} - İsim belirtilmemiş`;
                    }
                    const subtitleElement = personCard.querySelector('.person-subtitle');
                    if (subtitleElement) {
                        subtitleElement.textContent = 'Gerçek Kişi';
                    }
                    
                    // Detail item'ları temizle
                    const detailItems = personCard.querySelectorAll('.detail-info-item');
                    detailItems.forEach(item => {
                        const label = item.querySelector('.detail-info-label')?.textContent;
                        const valueSpan = item.querySelector('.detail-info-value');
                        
                        if (label && valueSpan) {
                            switch(label) {
                                case 'TİP':
                                    valueSpan.textContent = 'Gerçek Kişi';
                                    break;
                                case 'SIFAT':
                                case 'TELEFON':
                                case 'KİMLİK / VERGİ NO':
                                case 'ADRES':
                                    valueSpan.textContent = '-';
                                    break;
                            }
                        }
                    });
                }
                
                alert(data.message || `${personType === 'client' ? 'Müvekkil' : 'Karşı taraf'} bilgileri başarıyla temizlendi.`);
            } else {
                alert('Hata: ' + (data.message || 'Bilgiler silinirken bir hata oluştu.'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bilgiler silinirken bir hata oluştu.');
        });
    }
}

// Ana kişi için dinamik form oluşturma
function createMainEditForm(personType, caseId) {
    const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
    const personCard = document.getElementById(cardId);
    
    if (!personCard) return;
    
    const editFormHtml = `
        <div id="mainEditForm_${personType}" class="hidden-edit-form" style="display: none;">
            <div class="detail-grid">
                <div class="detail-group">
                    <label>Tip</label>
                    <select id="mainEdit_${personType}_entityType" onchange="updateMainEditLabels('${personType}')">
                        <option value="person">Gerçek Kişi</option>
                        <option value="company">Tüzel Kişi</option>
                    </select>
                </div>
                <div class="detail-group">
                    <label>Sıfat</label>
                    <select id="mainEdit_${personType}_capacity">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group full-width">
                    <label id="mainEdit_${personType}_nameLabel">Ad Soyad</label>
                    <input type="text" id="mainEdit_${personType}_name">
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group">
                    <label>Telefon</label>
                    <input type="text" id="mainEdit_${personType}_phone">
                </div>
                <div class="detail-group">
                    <label id="mainEdit_${personType}_identityLabel">T.C. Kimlik No</label>
                    <input type="text" id="mainEdit_${personType}_identityNumber" maxlength="11">
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group full-width">
                    <label>Adres</label>
                    <textarea id="mainEdit_${personType}_address" rows="2"></textarea>
                </div>
            </div>
            <div class="edit-form-actions">
                <button type="button" class="btn secondary" onclick="cancelMainPersonEdit('${personType}')">İptal</button>
                <button type="button" class="btn primary" onclick="saveMainPersonEdit('${personType}', ${caseId})">Kaydet</button>
            </div>
        </div>
    `;
    
    // Form'u card'ın sonuna ekle
    personCard.insertAdjacentHTML('beforeend', editFormHtml);
    
    // Sıfat seçeneklerini yükle
    updateMainEditCapacityOptions(personType);
    
    // Radio button'ları için style ekle (sadece bir kez)
    if (!document.getElementById('edit-radio-styles')) {
        const style = document.createElement('style');
        style.id = 'edit-radio-styles';
        style.textContent = `
            .radio-group-edit {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
                padding: 8px 0;
            }
            .radio-option-edit {
                display: flex;
                align-items: center;
                gap: 6px;
                cursor: pointer;
                font-weight: 500;
                color: var(--text-color, #2c3e50);
            }
            .radio-option-edit input[type="radio"] {
                width: 16px;
                height: 16px;
                accent-color: var(--primary-color, #1a237e);
            }
            .radio-label-edit {
                font-size: 0.9rem;
            }
        `;
        document.head.appendChild(style);
    }
}

// Sıfat seçeneklerini güncelle
function updateMainEditCapacityOptions(personType) {
    const fileType = document.getElementById('editFileType').value;
    const capacitySelect = document.getElementById(`mainEdit_${personType}_capacity`);
    
    if (!capacitySelect) return;
    
    capacitySelect.innerHTML = '<option value="">Seçiniz</option>';
    
    if (capacityOptions[fileType]) {
        const optionsKey = personType === 'client' ? 'client' : 'opponent';
        const options = capacityOptions[fileType][optionsKey];
        
        if (options && options.length > 0) {
            options.forEach(capacity => {
                const option = document.createElement('option');
                option.value = capacity;
                option.textContent = capacity;
                capacitySelect.appendChild(option);
            });
        }
    }
}

// Entity type değişiminde label'ları güncelle
function updateMainEditLabels(personType) {
    const entityType = document.getElementById(`mainEdit_${personType}_entityType`)?.value;
    const nameLabel = document.getElementById(`mainEdit_${personType}_nameLabel`);
    const identityLabel = document.getElementById(`mainEdit_${personType}_identityLabel`);
    const identityInput = document.getElementById(`mainEdit_${personType}_identityNumber`);
    
    if (entityType === 'company') {
        nameLabel.textContent = 'Şirket Unvanı';
        identityLabel.textContent = 'Vergi/Mersis No';
        identityInput.maxLength = 20;
        identityInput.placeholder = 'Vergi/Mersis/Ticaret Sicil No';
    } else {
        nameLabel.textContent = 'Ad Soyad';
        identityLabel.textContent = 'T.C. Kimlik No';
        identityInput.maxLength = 11;
        identityInput.placeholder = '12345678901';
    }
}

function loadMainPersonDataToEditForm(personType) {
    const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
    const personCard = document.getElementById(cardId);
    
    if (!personCard) return;
    
    // Mevcut verileri card'dan al
    const nameElement = personCard.querySelector('.person-title');
    const detailItems = personCard.querySelectorAll('.detail-info-item');
    
    // Form alanlarına veriyi yükle
    const nameText = nameElement ? nameElement.textContent : '';
    const nameParts = nameText.includes(' - ') ? nameText.split(' - ') : ['', nameText];
    
    if (nameParts.length > 1) {
        document.getElementById(`mainEdit_${personType}_capacity`).value = nameParts[0] || '';
        document.getElementById(`mainEdit_${personType}_name`).value = nameParts[1] || '';
    }
    
    // Diğer alanları detail-info-item'lardan al
    detailItems.forEach(item => {
        const label = item.querySelector('.detail-info-label')?.textContent;
        const value = item.querySelector('.detail-info-value')?.textContent;
        
        if (label && value && value !== '-') {
            switch(label) {
                case 'TİP':
                    const entityValue = value === 'Tüzel Kişi' ? 'company' : 'person';
                    const entitySelect = document.getElementById(`mainEdit_${personType}_entityType`);
                    if (entitySelect) {
                        entitySelect.value = entityValue;
                        updateMainEditLabels(personType);
                    }
                    break;
                case 'TELEFON':
                    document.getElementById(`mainEdit_${personType}_phone`).value = value;
                    break;
                case 'KİMLİK / VERGİ NO':
                    document.getElementById(`mainEdit_${personType}_identityNumber`).value = value;
                    break;
                case 'ADRES':
                    document.getElementById(`mainEdit_${personType}_address`).value = value;
                    break;
            }
        }
    });
}

// Ana kişi düzenleme kaydet fonksiyonu - gerçekten çalışan versiyon
function saveMainPersonEdit(personType, caseId) {
    // Form verilerini al
    const capacity = document.getElementById(`mainEdit_${personType}_capacity`).value;
    const name = document.getElementById(`mainEdit_${personType}_name`).value;
    const entityType = document.getElementById(`mainEdit_${personType}_entityType`)?.value || 'person';
    const phone = document.getElementById(`mainEdit_${personType}_phone`).value;
    const identityNumber = document.getElementById(`mainEdit_${personType}_identityNumber`).value;
    const address = document.getElementById(`mainEdit_${personType}_address`).value;
    
    // Validasyon
    if (!name.trim()) {
        alert('Ad Soyad / Unvan alanı zorunludur.');
        return;
    }
    
    // Backend'e gönder
    const formData = new FormData();
    formData.append('case_id', caseId);
    formData.append('person_type', personType);
    formData.append('entity_type', entityType);
    formData.append('capacity', capacity);
    formData.append('name', name);
    formData.append('phone', phone);
    formData.append('identity_number', identityNumber);
    formData.append('address', address);
    formData.append('csrf_token', csrfToken);
    
    fetch('/update_main_person', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ana form alanlarını güncelle (gizli formda) - eğer edit modal açıksa
            const editModal = document.getElementById('editModal');
            if (editModal && editModal.style.display !== 'none') {
                const prefix = personType === 'client' ? 'Client' : 'Opponent';
                const entityTypeSelect = document.getElementById(`edit${prefix}EntityType`);
                const capacityInput = document.getElementById(`edit${prefix}Capacity`);
                const nameInput = document.getElementById(`edit${prefix}Name`);
                const identityInput = document.getElementById(`edit${prefix}IdentityNumber`);
                
                if (entityTypeSelect) entityTypeSelect.value = entityType;
                if (capacityInput) capacityInput.value = capacity;
                if (nameInput) nameInput.value = name;
                if (identityInput) identityInput.value = identityNumber;
                
                if (personType === 'client') {
                    const phoneInput = document.getElementById('editPhoneNumber');
                    const addressInput = document.getElementById('editClientAddress');
                    if (phoneInput) phoneInput.value = phone;
                    if (addressInput) addressInput.value = address;
                } else {
                    const phoneInput = document.getElementById('editOpponentPhone');
                    const addressInput = document.getElementById('editOpponentAddress');
                    if (phoneInput) phoneInput.value = phone;
                    if (addressInput) addressInput.value = address;
                }
            }
            
            // Card'ı güncelle
            const cardId = personType === 'client' ? 'mainClientCard' : 'mainOpponentCard';
            const personCard = document.getElementById(cardId);
            
            if (personCard) {
                // Başlığı güncelle
                const titleElement = personCard.querySelector('.person-title');
                if (titleElement) {
                    titleElement.textContent = `${capacity || (personType === 'client' ? 'Müvekkil' : 'Karşı Taraf')} - ${name || 'İsim belirtilmemiş'}`;
                }
                
                // Subtitle'ı güncelle
                const subtitleElement = personCard.querySelector('.person-subtitle');
                if (subtitleElement) {
                    const entityText = entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi';
                    const identityText = identityNumber ? ' • ' + identityNumber : '';
                    subtitleElement.textContent = entityText + identityText;
                }
                
                // Detail item'ları güncelle
                const detailItems = personCard.querySelectorAll('.detail-info-item');
                detailItems.forEach(item => {
                    const label = item.querySelector('.detail-info-label')?.textContent;
                    const valueSpan = item.querySelector('.detail-info-value');
                    
                    if (label && valueSpan) {
                        switch(label) {
                            case 'TİP':
                                valueSpan.textContent = entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi';
                                break;
                            case 'SIFAT':
                                valueSpan.textContent = capacity || '-';
                                break;
                            case 'TELEFON':
                                valueSpan.textContent = phone || '-';
                                break;
                            case 'KİMLİK / VERGİ NO':
                                valueSpan.textContent = identityNumber || '-';
                                break;
                            case 'ADRES':
                                valueSpan.textContent = address || '-';
                                break;
                        }
                    }
                });
            }
            
            cancelMainPersonEdit(personType);
            alert(data.message || `${personType === 'client' ? 'Müvekkil' : 'Karşı taraf'} bilgileri başarıyla güncellendi.`);
        } else {
            alert('Hata: ' + (data.message || 'Bilgiler güncellenirken bir hata oluştu.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bilgiler güncellenirken bir hata oluştu.');
    });
}

// Vekil düzenleme fonksiyonları
function editMainLawyerInModal(caseId) {
    const editForm = document.getElementById('mainLawyerEditForm');
    const lawyerCard = document.querySelector('.lawyer-card');
    
    if (editForm && lawyerCard) {
        lawyerCard.style.display = 'none';
        editForm.style.display = 'block';
    }
}

function showMainLawyerEditForm() {
    const editForm = document.getElementById('mainLawyerEditForm');
    const addButton = document.querySelector('.add-lawyer-btn-container');
    
    if (editForm && addButton) {
        addButton.style.display = 'none';
        editForm.style.display = 'block';
    }
}

function cancelMainLawyerEdit() {
    const editForm = document.getElementById('mainLawyerEditForm');
    const lawyerCard = document.querySelector('.lawyer-card');
    const addButton = document.querySelector('.add-lawyer-btn-container');
    
    if (editForm) {
        editForm.style.display = 'none';
        
        if (lawyerCard && lawyerCard.style.display !== 'none') {
            lawyerCard.style.display = 'block';
        } else if (addButton) {
            addButton.style.display = 'block';
        }
    }
}

function saveMainLawyerEdit(caseId) {
    // Form verilerini al
    const lawyerName = document.getElementById('editOpponentLawyer').value;
    const lawyerBarNumber = document.getElementById('editOpponentLawyerBarNumber').value;
    const lawyerPhone = document.getElementById('editOpponentLawyerPhone').value;
    const lawyerAddress = document.getElementById('editOpponentLawyerAddress').value;
    
    // Vekil bilgileri girildiyse card'ı göster, buton'u gizle
    const lawyerCard = document.querySelector('.lawyer-card');
    const addButton = document.querySelector('.add-lawyer-btn-container');
    
    if (lawyerName || lawyerPhone || lawyerAddress) {
        if (lawyerCard && addButton) {
            lawyerCard.style.display = 'block';
            addButton.style.display = 'none';
            
            // Card başlığını güncelle
            const titleElement = lawyerCard.querySelector('.main-edit-lawyer-title');
            const subtitleElement = lawyerCard.querySelector('.person-subtitle');
            if (titleElement) {
                titleElement.textContent = `Vekil - ${lawyerName || 'Ad belirtilmemiş'}`;
            }
            if (subtitleElement) {
                subtitleElement.textContent = `Baro No: ${lawyerBarNumber || 'Belirtilmemiş'}`;
            }
            
            // Detail item'ları güncelle
            const detailItems = lawyerCard.querySelectorAll('.detail-info-item');
            detailItems.forEach(item => {
                const label = item.querySelector('.detail-info-label')?.textContent;
                const valueSpan = item.querySelector('.detail-info-value');
                
                if (label && valueSpan) {
                    switch(label) {
                        case 'BARO NUMARASI':
                            valueSpan.textContent = lawyerBarNumber || '-';
                            break;
                        case 'TELEFON':
                            valueSpan.textContent = lawyerPhone || '-';
                            break;
                        case 'ADRES':
                            valueSpan.textContent = lawyerAddress || '-';
                            break;
                    }
                }
            });
        }
    } else {
        // Vekil bilgisi yoksa card'ı gizle, buton'u göster
        if (lawyerCard && addButton) {
            lawyerCard.style.display = 'none';
            addButton.style.display = 'block';
        }
    }
    
    cancelMainLawyerEdit();
    alert('Vekil bilgileri güncellendi. Tüm değişiklikleri kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.');
}

function deleteMainLawyerInModal(caseId) {
    if (confirm('Vekil bilgilerini silmek istediğinizden emin misiniz?')) {
        // Form alanlarını temizle
        document.getElementById('editOpponentLawyer').value = '';
        document.getElementById('editOpponentLawyerBarNumber').value = '';
        document.getElementById('editOpponentLawyerPhone').value = '';
        document.getElementById('editOpponentLawyerAddress').value = '';
        
        // Card'ı gizle, ekleme butonunu göster
        const lawyerCard = document.querySelector('.lawyer-card');
        const addButton = document.querySelector('.add-lawyer-btn-container');
        
        if (lawyerCard && addButton) {
            lawyerCard.style.display = 'none';
            addButton.style.display = 'block';
        }
        
        alert('Vekil bilgileri temizlendi. Kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.');
    }
}

// Yeni kişi ekleme fonksiyonları
function addNewClientInModal(caseId, fileType = 'hukuk') {
    showPersonAddModal('client', caseId, fileType);
}

function addNewOpponentInModal(caseId, fileType = 'hukuk') {
    showPersonAddModal('opponent', caseId, fileType);
}

function addNewLawyerInModal(caseId) {
    showLawyerAddModal(caseId);
}

// Kişi ekleme modalı göster
function showPersonAddModal(personType, caseId, fileType = 'hukuk') {
    const personTypeText = personType === 'client' ? 'Müvekkil' : 'Karşı Taraf';
    
    const modalHtml = `
        <div id="addPersonModal" class="file-detail-modal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Yeni ${personTypeText} Ekle</h2>
                    <button class="close-btn" onclick="closeAddPersonModal()">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addPersonForm">
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Tip</label>
                                <select id="addPersonEntityType" onchange="updateAddPersonModalLabels()">
                                    <option value="person">Gerçek Kişi</option>
                                    <option value="company">Şirket</option>
                                    <option value="public">Kamu Kurumu</option>
                                    <option value="legal_entity">Tüzel Kişi</option>
                                </select>
                            </div>
                            <div class="detail-group">
                                <label>Sıfat</label>
                                <select id="addPersonCapacity">
                                    <option value="">Seçiniz</option>
                                </select>
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-group full-width">
                                <label id="addPersonNameLabel">Ad Soyad</label>
                                <input type="text" id="addPersonName" required>
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Telefon</label>
                                <input type="text" id="addPersonPhone">
                            </div>
                            <div class="detail-group">
                                <label id="addPersonIdentityLabel">T.C. Kimlik No</label>
                                <input type="text" id="addPersonIdentityNumber" maxlength="11">
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-group full-width">
                                <label>Adres</label>
                                <textarea id="addPersonAddress" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn secondary" onclick="closeAddPersonModal()">İptal</button>
                    <button class="btn primary" onclick="saveNewPerson('${personType}', ${caseId})">Ekle</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Modal açıldıktan sonra sıfat seçeneklerini güncelle
    updateAddPersonModalCapacity(personType, fileType);
}

// Vekil ekleme modalı göster
function showLawyerAddModal(caseId) {
    const modalHtml = `
        <div id="addLawyerModal" class="file-detail-modal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Yeni Vekil Ekle</h2>
                    <button class="close-btn" onclick="closeAddLawyerModal()">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="addLawyerForm">
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Vekil Adı Soyadı</label>
                                <input type="text" id="addLawyerName" required>
                            </div>
                            <div class="detail-group">
                                <label>Baro Numarası</label>
                                <input type="text" id="addLawyerBarNumber">
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Telefon</label>
                                <input type="text" id="addLawyerPhone">
                            </div>
                            <div class="detail-group full-width">
                                <label>Adres</label>
                                <textarea id="addLawyerAddress" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn secondary" onclick="closeAddLawyerModal()">İptal</button>
                    <button class="btn primary" onclick="saveNewLawyer(${caseId})">Ekle</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Yeni kişi kaydet - direkt backend'e kaydeder
function saveNewPerson(personType, caseId) {
    const entityType = document.getElementById('addPersonEntityType').value;
    const capacity = document.getElementById('addPersonCapacity').value;
    const name = document.getElementById('addPersonName').value;
    const phone = document.getElementById('addPersonPhone').value;
    const identityNumber = document.getElementById('addPersonIdentityNumber').value;
    const address = document.getElementById('addPersonAddress').value;
    
    if (!name.trim()) {
        alert('Ad Soyad / Unvan alanı zorunludur.');
        return;
    }
    
    // Backend'e yeni kişi eklemek için API call
    const formData = new FormData();
    formData.append('case_id', caseId);
    formData.append('person_type', personType);
    formData.append('entity_type', entityType);
    formData.append('capacity', capacity);
    formData.append('name', name);
    formData.append('phone', phone);
    formData.append('identity_number', identityNumber);
    formData.append('address', address);
    formData.append('csrf_token', csrfToken);
    
    fetch('/add_person_to_case', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Başarılı - modalı kapat ve sayfayı yenile ya da card'ı dinamik ekle
            closeAddPersonModal();
            
            // Yeni kişi card'ını oluştur
            const displayArea = personType === 'client' ? 
                document.getElementById('editAdditionalClientsDisplay') : 
                document.getElementById('editAdditionalOpponentsDisplay');
            
            if (displayArea) {
                const personIndex = displayArea.children.length;
                const iconClass = personType === 'client' ? 'person_add' : 'group_add';
                
                const newPersonCardHtml = `
                    <div class="collapsible-person-card editable-person-card" data-person-type="${personType}" data-person-index="${personIndex}" data-person-id="${data.person_id}">
                        <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                            <div class="collapsible-title">
                                <i class="material-icons person-icon">${iconClass}</i>
                                <div class="person-info">
                                    <div class="person-title">${capacity || (personType === 'client' ? 'Müvekkil' : 'Karşı Taraf')} - ${name}</div>
                                    <div class="person-subtitle">${entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}${identityNumber ? ' • ' + identityNumber : ''}</div>
                                </div>
                            </div>
                            <div class="card-actions" onclick="event.stopPropagation()">
                                <button type="button" class="btn-icon-small edit" onclick="editPersonInModal('${personType}', ${personIndex}, ${caseId})" title="Düzenle">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button type="button" class="btn-icon-small delete" onclick="deletePersonInModal('${personType}', ${personIndex}, ${caseId})" title="Sil">
                                    <i class="material-icons">delete</i>
                                </button>
                                <i class="material-icons collapse-arrow">expand_more</i>
                            </div>
                        </div>
                        <div class="collapsible-content">
                            <div class="detail-info-grid">
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TİP</span>
                                    <span class="detail-info-value">${entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">SIFAT</span>
                                    <span class="detail-info-value">${capacity || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">KİMLİK / VERGİ NO</span>
                                    <span class="detail-info-value">${identityNumber || '-'}</span>
                                </div>
                                <div class="detail-info-item">
                                    <span class="detail-info-label">TELEFON</span>
                                    <span class="detail-info-value">${phone || '-'}</span>
                                </div>
                                <div class="detail-info-item full-width">
                                    <span class="detail-info-label">ADRES</span>
                                    <span class="detail-info-value">${address || '-'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                displayArea.insertAdjacentHTML('beforeend', newPersonCardHtml);
            }
        } else {
            alert('Hata: ' + (data.message || 'Kişi eklenirken bir hata oluştu.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Kişi eklenirken bir hata oluştu.');
    });
}

// Yeni vekil kaydet - direkt backend'e kaydeder
function saveNewLawyer(caseId) {
    const name = document.getElementById('addLawyerName').value;
    const barNumber = document.getElementById('addLawyerBarNumber').value;
    const phone = document.getElementById('addLawyerPhone').value;
    const address = document.getElementById('addLawyerAddress').value;
    
    if (!name.trim()) {
        alert('Vekil Adı Soyadı alanı zorunludur.');
        return;
    }
    
    // Backend'e yeni vekil eklemek için API call
    const formData = new FormData();
    formData.append('case_id', caseId);
    formData.append('name', name);
    formData.append('bar_number', barNumber);
    formData.append('phone', phone);
    formData.append('address', address);
    formData.append('csrf_token', csrfToken);
    
    fetch('/add_lawyer_to_case', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddLawyerModal();
            
            // lawyer_id 0 ise ana vekil olarak eklendi, değilse ek vekil
            if (data.lawyer_id === 0) {
                // Ana vekil olarak eklendi - mevcut alanları güncelle
                document.getElementById('editOpponentLawyer').value = name;
                document.getElementById('editOpponentLawyerBarNumber').value = barNumber;
                document.getElementById('editOpponentLawyerPhone').value = phone;
                document.getElementById('editOpponentLawyerAddress').value = address;
                
                // Vekil card'ını güncelle
                const lawyerCard = document.querySelector('.lawyer-card');
                const addButton = document.querySelector('.add-lawyer-btn-container');
                
                if (lawyerCard && addButton) {
                    lawyerCard.style.display = 'block';
                    addButton.style.display = 'none';
                    
                    // Card başlığını güncelle
                    const titleElement = lawyerCard.querySelector('.main-edit-lawyer-title');
                    const subtitleElement = lawyerCard.querySelector('.person-subtitle');
                    if (titleElement) {
                        titleElement.textContent = `Vekil - ${name}`;
                    }
                    if (subtitleElement) {
                        subtitleElement.textContent = `Baro No: ${barNumber || 'Belirtilmemiş'}`;
                    }
                    
                    // Detail item'ları güncelle
                    const detailItems = lawyerCard.querySelectorAll('.detail-info-item');
                    detailItems.forEach(item => {
                        const label = item.querySelector('.detail-info-label')?.textContent;
                        const valueSpan = item.querySelector('.detail-info-value');
                        
                        if (label && valueSpan) {
                            switch(label) {
                                case 'BARO NUMARASI':
                                    valueSpan.textContent = barNumber || '-';
                                    break;
                                case 'TELEFON':
                                    valueSpan.textContent = phone || '-';
                                    break;
                                case 'ADRES':
                                    valueSpan.textContent = address || '-';
                                    break;
                            }
                        }
                    });
                }
            } else {
                // Ek vekil olarak eklendi - yeni card oluştur
                addAdditionalLawyerCard(name, barNumber, phone, address, data.lawyer_id);
            }
            
            alert(data.message);
        } else {
            alert('Hata: ' + (data.message || 'Vekil eklenirken bir hata oluştu.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Vekil eklenirken bir hata oluştu.');
    });
}

// Ek vekil card'ı oluştur
function addAdditionalLawyerCard(name, barNumber, phone, address, lawyerId) {
    const lawyersDisplay = document.getElementById('editAdditionalLawyersDisplay');
    
    if (!lawyersDisplay) {
        // Eğer display area yoksa oluştur
        const vekilSection = document.querySelector('.vekil-section');
        if (vekilSection) {
            const displayDiv = document.createElement('div');
            displayDiv.id = 'editAdditionalLawyersDisplay';
            displayDiv.className = 'additional-display';
            vekilSection.appendChild(displayDiv);
        }
    }
    
    const finalDisplay = document.getElementById('editAdditionalLawyersDisplay');
    if (finalDisplay) {
        const lawyerCard = document.createElement('div');
        lawyerCard.className = 'collapsible-person-card editable-person-card';
        lawyerCard.setAttribute('data-lawyer-id', lawyerId);
        
        lawyerCard.innerHTML = `
            <div class="collapsible-header" onclick="toggleCollapsibleCard(this)">
                <div class="collapsible-title">
                    <i class="material-icons person-icon lawyer-icon">account_balance</i>
                    <div class="person-info">
                        <div class="person-title">Ek Vekil - ${name}</div>
                        <div class="person-subtitle">Baro No: ${barNumber || 'Belirtilmemiş'}</div>
                    </div>
                </div>
                <div class="card-actions" onclick="event.stopPropagation()">
                    <button type="button" class="btn-icon-small edit" onclick="editAdditionalLawyer(${lawyerId}, event)" title="Düzenle">
                        <i class="material-icons">edit</i>
                    </button>
                    <button type="button" class="btn-icon-small delete" onclick="deleteAdditionalLawyer(${lawyerId}, event)" title="Sil">
                        <i class="material-icons">delete</i>
                    </button>
                    <i class="material-icons collapse-arrow">expand_more</i>
                </div>
            </div>
            <div class="collapsible-content">
                <div class="detail-info-grid">
                    <div class="detail-info-item">
                        <span class="detail-info-label">BARO NUMARASI</span>
                        <span class="detail-info-value">${barNumber || '-'}</span>
                    </div>
                    <div class="detail-info-item">
                        <span class="detail-info-label">TELEFON</span>
                        <span class="detail-info-value">${phone || '-'}</span>
                    </div>
                    <div class="detail-info-item full-width">
                        <span class="detail-info-label">ADRES</span>
                        <span class="detail-info-value">${address || '-'}</span>
                    </div>
                </div>
            </div>
        `;
        
        finalDisplay.appendChild(lawyerCard);
    }
}

// Ek vekil düzenleme fonksiyonu
function editAdditionalLawyer(lawyerId, event) {
    if (event) event.stopPropagation();
    
    const lawyerCard = document.querySelector(`[data-lawyer-id="${lawyerId}"]`);
    if (!lawyerCard) return;
    
    // Mevcut bilgileri al
    const nameElement = lawyerCard.querySelector('.person-title');
    const barNumberElement = lawyerCard.querySelector('.person-subtitle');
    const detailItems = lawyerCard.querySelectorAll('.detail-info-item');
    
    const name = nameElement ? nameElement.textContent.replace('Vekil - ', '').replace('Ek Vekil - ', '') : '';
    const barNumber = barNumberElement ? barNumberElement.textContent.replace('Baro No: ', '').replace('Belirtilmemiş', '') : '';
    
    let phone = '';
    let address = '';
    
    detailItems.forEach(item => {
        const label = item.querySelector('.detail-info-label')?.textContent;
        const value = item.querySelector('.detail-info-value')?.textContent;
        
        if (label && value && value !== '-') {
            switch(label) {
                case 'TELEFON':
                    phone = value;
                    break;
                case 'ADRES':
                    address = value;
                    break;
            }
        }
    });
    
    // Düzenleme modalı aç
    const modalHtml = `
        <div id="editAdditionalLawyerModal" class="file-detail-modal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h2>Ek Vekil Düzenle</h2>
                    <button class="close-btn" onclick="closeEditAdditionalLawyerModal()">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="editAdditionalLawyerForm">
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Vekil Adı Soyadı</label>
                                <input type="text" id="editAdditionalLawyerName" value="${name}" required>
                            </div>
                            <div class="detail-group">
                                <label>Baro Numarası</label>
                                <input type="text" id="editAdditionalLawyerBarNumber" value="${barNumber}">
                            </div>
                        </div>
                        <div class="detail-grid">
                            <div class="detail-group">
                                <label>Telefon</label>
                                <input type="text" id="editAdditionalLawyerPhone" value="${phone}">
                            </div>
                            <div class="detail-group full-width">
                                <label>Adres</label>
                                <textarea id="editAdditionalLawyerAddress" rows="3">${address}</textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button class="btn secondary" onclick="closeEditAdditionalLawyerModal()">İptal</button>
                    <button class="btn primary" onclick="saveAdditionalLawyerEdit(${lawyerId})">Kaydet</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

// Ek vekil düzenleme modalını kapat
function closeEditAdditionalLawyerModal() {
    const modal = document.getElementById('editAdditionalLawyerModal');
    if (modal) {
        modal.remove();
    }
}

// Ek vekil düzenleme kaydet
function saveAdditionalLawyerEdit(lawyerId) {
    const name = document.getElementById('editAdditionalLawyerName').value;
    const barNumber = document.getElementById('editAdditionalLawyerBarNumber').value;
    const phone = document.getElementById('editAdditionalLawyerPhone').value;
    const address = document.getElementById('editAdditionalLawyerAddress').value;
    
    if (!name.trim()) {
        alert('Vekil Adı Soyadı alanı zorunludur.');
        return;
    }
    
    // Card'ı güncelle
    const lawyerCard = document.querySelector(`[data-lawyer-id="${lawyerId}"]`);
    if (lawyerCard) {
        // Başlığı güncelle
        const titleElement = lawyerCard.querySelector('.person-title');
        if (titleElement) {
            titleElement.textContent = `Vekil - ${name}`;
        }
        
        // Subtitle'ı güncelle
        const subtitleElement = lawyerCard.querySelector('.person-subtitle');
        if (subtitleElement) {
            subtitleElement.textContent = `Baro No: ${barNumber || 'Belirtilmemiş'}`;
        }
        
        // Detail item'ları güncelle
        const detailItems = lawyerCard.querySelectorAll('.detail-info-item');
        detailItems.forEach(item => {
            const label = item.querySelector('.detail-info-label')?.textContent;
            const valueSpan = item.querySelector('.detail-info-value');
            
            if (label && valueSpan) {
                switch(label) {
                    case 'BARO NUMARASI':
                        valueSpan.textContent = barNumber || '-';
                        break;
                    case 'TELEFON':
                        valueSpan.textContent = phone || '-';
                        break;
                    case 'ADRES':
                        valueSpan.textContent = address || '-';
                        break;
                }
            }
        });
    }
    
    closeEditAdditionalLawyerModal();
    alert('Ek vekil bilgileri güncellendi. Tüm değişiklikleri kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.');
}

// Ek vekil silme fonksiyonu
function deleteAdditionalLawyer(lawyerId, event) {
    if (event) event.stopPropagation();
    
    if (confirm('Bu ek vekili silmek istediğinizden emin misiniz?')) {
        const lawyerCard = document.querySelector(`[data-lawyer-id="${lawyerId}"]`);
        if (lawyerCard) {
            lawyerCard.remove();
            alert('Ek vekil kaldırıldı. Tüm değişiklikleri kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.');
        }
    }
}

// Modal için label güncelleme fonksiyonu
function updateAddPersonModalLabels() {
    const entityType = document.getElementById('addPersonEntityType').value;
    const nameLabel = document.getElementById('addPersonNameLabel');
    const identityLabel = document.getElementById('addPersonIdentityLabel');
    const identityInput = document.getElementById('addPersonIdentityNumber');
    
    switch(entityType) {
        case 'person':
            nameLabel.textContent = 'Ad Soyad';
            identityLabel.textContent = 'T.C. Kimlik No';
            identityInput.maxLength = 11;
            identityInput.placeholder = 'T.C. Kimlik No';
            break;
        case 'company':
            nameLabel.textContent = 'Şirket Unvanı';
            identityLabel.textContent = 'Vergi/Mersis No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Vergi numarası';
            break;
        case 'public':
            nameLabel.textContent = 'Kurum Adı';
            identityLabel.textContent = 'Vergi/Kurum No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Kurum vergi numarası';
            break;
        case 'legal_entity':
            nameLabel.textContent = 'Kuruluş Unvanı';
            identityLabel.textContent = 'Vergi/Sicil No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Sicil/Vergi numarası';
            break;
        default:
            nameLabel.textContent = 'Ad Soyad';
            identityLabel.textContent = 'T.C. Kimlik No';
            identityInput.maxLength = 11;
            identityInput.placeholder = 'T.C. Kimlik No';
    }
}

// Sıfat dropdown'ını güncelleme fonksiyonu
function updateAddPersonModalCapacity(personType, fileType = null) {
    // Dosya türünü parametre olarak al veya çeşitli kaynaklardan bul
    if (!fileType) {
        const editFileTypeElement = document.getElementById('editFileType');
        const detailFileTypeElement = document.getElementById('detailFileType');
        
        if (editFileTypeElement && editFileTypeElement.value) {
            fileType = editFileTypeElement.value;
        } else if (detailFileTypeElement && detailFileTypeElement.textContent) {
            fileType = detailFileTypeElement.textContent.toLowerCase();
        } else {
            fileType = 'hukuk'; // Default değer
        }
    }
    
    const capacitySelect = document.getElementById('addPersonCapacity');
    
    if (!capacitySelect) return;
    
    capacitySelect.innerHTML = '<option value="">Seçiniz</option>';
    
    if (capacityOptions[fileType]) {
        const optionsKey = personType === 'client' ? 'client' : 'opponent';
        const options = capacityOptions[fileType][optionsKey];
        
        if (options && options.length > 0) {
            options.forEach(capacity => {
                const option = document.createElement('option');
                option.value = capacity;
                option.textContent = capacity;
                capacitySelect.appendChild(option);
            });
        }
    }
}

// Modal kapatma fonksiyonları
function closeAddPersonModal() {
    const modal = document.getElementById('addPersonModal');
    if (modal) {
        modal.remove();
    }
}

function closeAddLawyerModal() {
    const modal = document.getElementById('addLawyerModal');
    if (modal) {
        modal.remove();
    }
}

// Ek kişi düzenleme sistemi
function editPersonInModal(personType, personIndex, caseId) {
    const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
    const personCard = document.querySelector(cardSelector);
    
    if (!personCard) return;
    
    // Mevcut card'ı gizle ve edit form'u göster
    const cardContent = personCard.querySelector('.collapsible-content');
    const editFormId = `editForm_${personType}_${personIndex}`;
    
    // Eğer edit form yoksa oluştur
    let editForm = document.getElementById(editFormId);
    if (!editForm) {
        createEditFormForPerson(personType, personIndex, caseId);
        editForm = document.getElementById(editFormId);
    }
    
    // Card content'i gizle, edit form'u göster
    if (cardContent && editForm) {
        cardContent.style.display = 'none';
        editForm.style.display = 'block';
        
        // Mevcut değerleri forma yükle
        loadPersonDataToEditForm(personType, personIndex);
    }
}

function createEditFormForPerson(personType, personIndex, caseId) {
    const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
    const personCard = document.querySelector(cardSelector);
    
    if (!personCard) return;
    
    const editFormHtml = `
        <div id="editForm_${personType}_${personIndex}" class="hidden-edit-form" style="display: none;">
            <div class="detail-grid">
                <div class="detail-group">
                    <label>Tip</label>
                                                    <select id="edit_${personType}_${personIndex}_entityType" onchange="updatePersonEditLabels('${personType}', ${personIndex})">
                                    <option value="person">Gerçek Kişi</option>
                                    <option value="company">Şirket</option>
                                    <option value="public">Kamu Kurumu</option>
                                    <option value="legal_entity">Tüzel Kişi</option>
                                </select>
                </div>
                <div class="detail-group">
                    <label>Sıfat</label>
                    <select id="edit_${personType}_${personIndex}_capacity">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group full-width">
                    <label id="edit_${personType}_${personIndex}_nameLabel">Ad Soyad</label>
                    <input type="text" id="edit_${personType}_${personIndex}_name">
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group">
                    <label>Telefon</label>
                    <input type="text" id="edit_${personType}_${personIndex}_phone">
                </div>
                <div class="detail-group">
                    <label id="edit_${personType}_${personIndex}_identityLabel">T.C. Kimlik No</label>
                    <input type="text" id="edit_${personType}_${personIndex}_identityNumber" maxlength="11">
                </div>
            </div>
            <div class="detail-grid">
                <div class="detail-group full-width">
                    <label>Adres</label>
                    <textarea id="edit_${personType}_${personIndex}_address" rows="2"></textarea>
                </div>
            </div>
            <div class="edit-form-actions">
                <button type="button" class="btn secondary" onclick="cancelPersonEdit('${personType}', ${personIndex})">İptal</button>
                <button type="button" class="btn primary" onclick="savePersonEdit('${personType}', ${personIndex}, ${caseId})">Kaydet</button>
            </div>
        </div>
    `;
    
    // Form'u card'ın sonuna ekle
    personCard.insertAdjacentHTML('beforeend', editFormHtml);
    
    // Sıfat seçeneklerini yükle
    updatePersonEditCapacityOptions(personType, personIndex);
}

// Ek kişi düzenleme için sıfat seçeneklerini güncelle
function updatePersonEditCapacityOptions(personType, personIndex) {
    const fileType = document.getElementById('editFileType')?.value || document.getElementById('detailFileType')?.textContent?.toLowerCase();
    const capacitySelect = document.getElementById(`edit_${personType}_${personIndex}_capacity`);
    
    if (!capacitySelect || !fileType) return;
    
    capacitySelect.innerHTML = '<option value="">Seçiniz</option>';
    
    if (capacityOptions[fileType]) {
        const optionsKey = personType === 'client' ? 'client' : 'opponent';
        const options = capacityOptions[fileType][optionsKey];
        
        if (options && options.length > 0) {
            options.forEach(capacity => {
                const option = document.createElement('option');
                option.value = capacity;
                option.textContent = capacity;
                capacitySelect.appendChild(option);
            });
        }
    }
}

// Ek kişi düzenleme için entity type değişiminde label'ları güncelle
function updatePersonEditLabels(personType, personIndex) {
    const entityType = document.getElementById(`edit_${personType}_${personIndex}_entityType`)?.value;
    const nameLabel = document.getElementById(`edit_${personType}_${personIndex}_nameLabel`);
    const identityLabel = document.getElementById(`edit_${personType}_${personIndex}_identityLabel`);
    const identityInput = document.getElementById(`edit_${personType}_${personIndex}_identityNumber`);
    
    switch(entityType) {
        case 'person':
            nameLabel.textContent = 'Ad Soyad';
            identityLabel.textContent = 'T.C. Kimlik No';
            identityInput.maxLength = 11;
            identityInput.placeholder = '12345678901';
            break;
        case 'company':
            nameLabel.textContent = 'Şirket Unvanı';
            identityLabel.textContent = 'Vergi/Mersis No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Vergi/Mersis/Ticaret Sicil No';
            break;
        case 'public':
            nameLabel.textContent = 'Kurum Adı';
            identityLabel.textContent = 'Vergi/Kurum No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Kurum vergi numarası';
            break;
        case 'legal_entity':
            nameLabel.textContent = 'Kuruluş Unvanı';
            identityLabel.textContent = 'Vergi/Sicil No';
            identityInput.maxLength = 20;
            identityInput.placeholder = 'Sicil/Vergi numarası';
            break;
        default:
            nameLabel.textContent = 'Ad Soyad';
            identityLabel.textContent = 'T.C. Kimlik No';
            identityInput.maxLength = 11;
            identityInput.placeholder = '12345678901';
    }
}

function loadPersonDataToEditForm(personType, personIndex) {
    const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
    const personCard = document.querySelector(cardSelector);
    
    if (!personCard) return;
    
    // Mevcut verileri card'dan al
    const nameElement = personCard.querySelector('.person-title');
    const subtitleElement = personCard.querySelector('.person-subtitle');
    const detailItems = personCard.querySelectorAll('.detail-info-item');
    
    // Form alanlarına veriyi yükle
    const nameText = nameElement ? nameElement.textContent : '';
    const nameParts = nameText.includes(' - ') ? nameText.split(' - ') : ['', nameText];
    
    if (nameParts.length > 1) {
        // Sıfat select'i için değeri al
        const capacitySelect = document.getElementById(`edit_${personType}_${personIndex}_capacity`);
        if (capacitySelect) {
            capacitySelect.value = nameParts[0] || '';
        }
        document.getElementById(`edit_${personType}_${personIndex}_name`).value = nameParts[1] || '';
    }
    
    let entityTypeFromCard = 'person';
    
    // Diğer alanları detail-info-item'lardan al
    detailItems.forEach(item => {
        const label = item.querySelector('.detail-info-label')?.textContent;
        const value = item.querySelector('.detail-info-value')?.textContent;
        
        if (label && value && value !== '-') {
            switch(label) {
                case 'TİP':
                    entityTypeFromCard = value === 'Tüzel Kişi' ? 'company' : 'person';
                    break;
                case 'TELEFON':
                    document.getElementById(`edit_${personType}_${personIndex}_phone`).value = value;
                    break;
                case 'KİMLİK / VERGİ NO':
                    document.getElementById(`edit_${personType}_${personIndex}_identityNumber`).value = value;
                    break;
                case 'ADRES':
                    document.getElementById(`edit_${personType}_${personIndex}_address`).value = value;
                    break;
            }
        }
    });
    
    // Entity type dropdown'ını set et
    const entitySelect = document.getElementById(`edit_${personType}_${personIndex}_entityType`);
    if (entitySelect) {
        entitySelect.value = entityTypeFromCard;
        updatePersonEditLabels(personType, personIndex);
    }
}

function cancelPersonEdit(personType, personIndex) {
    const editFormId = `editForm_${personType}_${personIndex}`;
    const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
    const personCard = document.querySelector(cardSelector);
    const editForm = document.getElementById(editFormId);
    
    if (personCard && editForm) {
        const cardContent = personCard.querySelector('.collapsible-content');
        editForm.style.display = 'none';
        if (cardContent) {
            cardContent.style.display = 'block';
        }
    }
}

function savePersonEdit(personType, personIndex, caseId) {
    // Form verilerini al
    const capacity = document.getElementById(`edit_${personType}_${personIndex}_capacity`).value;
    const name = document.getElementById(`edit_${personType}_${personIndex}_name`).value;
    const entityType = document.getElementById(`edit_${personType}_${personIndex}_entityType`)?.value || 'person';
    const phone = document.getElementById(`edit_${personType}_${personIndex}_phone`).value;
    const identityNumber = document.getElementById(`edit_${personType}_${personIndex}_identityNumber`).value;
    const address = document.getElementById(`edit_${personType}_${personIndex}_address`).value;
    
    // Card'ı güncelle
    const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
    const personCard = document.querySelector(cardSelector);
    
    if (personCard) {
        // Başlığı güncelle
        const titleElement = personCard.querySelector('.person-title');
        if (titleElement) {
            titleElement.textContent = `${capacity || (personType === 'client' ? 'Müvekkil' : 'Karşı Taraf')} - ${name || 'İsim belirtilmemiş'}`;
        }
        
        // Subtitle'ı güncelle
        const subtitleElement = personCard.querySelector('.person-subtitle');
        if (subtitleElement) {
            const entityText = entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi';
            const identityText = identityNumber ? ' • ' + identityNumber : '';
            subtitleElement.textContent = entityText + identityText;
        }
        
        // Detail item'ları güncelle
        const detailItems = personCard.querySelectorAll('.detail-info-item');
        detailItems.forEach(item => {
            const label = item.querySelector('.detail-info-label')?.textContent;
            const valueSpan = item.querySelector('.detail-info-value');
            
            if (label && valueSpan) {
                switch(label) {
                    case 'TİP':
                        valueSpan.textContent = entityType === 'company' ? 'Tüzel Kişi' : 'Gerçek Kişi';
                        break;
                    case 'SIFAT':
                        valueSpan.textContent = capacity || '-';
                        break;
                    case 'TELEFON':
                        valueSpan.textContent = phone || '-';
                        break;
                    case 'KİMLİK / VERGİ NO':
                        valueSpan.textContent = identityNumber || '-';
                        break;
                    case 'ADRES':
                        valueSpan.textContent = address || '-';
                        break;
                }
            }
        });
    }
    
    cancelPersonEdit(personType, personIndex);
    alert(`${personType === 'client' ? 'Müvekkil' : 'Karşı taraf'} bilgileri güncellendi. Kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.`);
}

// Edit modalda kişi silme fonksiyonu (ek kişiler için)
function deletePersonInModal(personType, personIndex, caseId) {
    const personTypeText = personType === 'client' ? 'müvekkili' : 'karşı tarafı';
    
    if (confirm(`Bu ${personTypeText} silmek istediğinizden emin misiniz?`)) {
        const cardSelector = `[data-person-type="${personType}"][data-person-index="${personIndex}"]`;
        const personCard = document.querySelector(cardSelector);
        
        if (personCard) {
            personCard.remove();
            alert(`${personType === 'client' ? 'Müvekkil' : 'Karşı taraf'} kaldırıldı. Kaydetmek için modal alt kısmındaki "Kaydet" butonunu kullanın.`);
        }
    }
}

function closeExpenseModal() {
    const modal = document.getElementById('expenseModal');
    if (modal) {
        modal.remove();
    }
    // Flag'ı sıfırla
    isSavingExpense = false;
}

function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.remove();
    }
}

// Belge yönetim fonksiyonları
let currentDocuments = [];
let sortBy = 'date';

// Masraf yönetim fonksiyonları
let currentExpensesData = [];
let expenseSortBy = 'date';

// Son yüklenen belgeleri toggle etme
function toggleRecentDocuments() {
    const dropdown = document.getElementById('recentDocuments');
    const arrow = document.querySelector('.recent-documents-section .dropdown-arrow');

    if (dropdown.style.display === 'none') {
        loadRecentDocuments();
        dropdown.style.display = 'block';
        arrow.textContent = '▼';
    } else {
        dropdown.style.display = 'none';
        arrow.textContent = '▶';
    }
}

// Son 10 belgeyi yükle
function loadRecentDocuments() {
    const recentDocuments = document.getElementById('recentDocuments');
    const arrow = document.querySelector('.recent-documents-section .dropdown-arrow');

    if (!recentDocuments) return;

    // Dropdown'ı açık yap ve ok ikonunu güncelle
    recentDocuments.style.display = 'block';
    if (arrow) arrow.textContent = '▼';

    if (!currentDocuments.length) {
        recentDocuments.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">Henüz belge yüklenmemiş</div>';
        return;
    }

    let recentDocs = [...currentDocuments];

    // Debug: belgeleri console'da göster
    console.log('All documents before sorting:', currentDocuments.map(doc => ({
        id: doc.id,
        filename: doc.filename,
        upload_date: doc.upload_date,
        upload_datetime: doc.upload_datetime
    })));

    // Sıralama seçeneğine göre sırala
    if (sortBy === 'alphabetic') {
        recentDocs.sort((a, b) => {
            const nameA = a.filename ? a.filename.split('.').slice(0, -1).join('.') : '';
            const nameB = b.filename ? b.filename.split('.').slice(0, -1).join('.') : '';
            return nameA.localeCompare(nameB, 'tr');
        });
    } else {
        // Tarihe göre sıralama - en basit yöntem: ID'ye göre ters sırala (büyük ID = daha yeni)
        recentDocs.sort((a, b) => {
            return (b.id || 0) - (a.id || 0);
        });
    }

    // Debug: sıralama sonrası
    console.log('Documents after sorting:', recentDocs.map(doc => ({
        id: doc.id,
        filename: doc.filename,
        upload_date: doc.upload_date
    })));

    recentDocs = recentDocs.slice(0, 10);

    // Debug: son 10 belge
    console.log('Recent 10 documents:', recentDocs.map(doc => ({
        id: doc.id,
        filename: doc.filename
    })));

    recentDocuments.innerHTML = recentDocs.map(doc => createDocumentItemHTML(doc)).join('') ||
        '<div style="padding: 15px; text-align: center; color: #666;">Henüz belge yüklenmemiş</div>';
}

// Belgeye kaydır
function scrollToDocument(docId) {
    const documentElement = document.querySelector(`[data-doc-id="${docId}"]`);
    if (documentElement) {
        documentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        documentElement.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            documentElement.style.backgroundColor = '';
        }, 2000);
    }

    // Dropdown'ı kapat
    const dropdown = document.getElementById('recentDocuments');
    const toggle = document.getElementById('recentDocsToggle');
    dropdown.style.display = 'none';
    toggle.classList.remove('active');
}

// Belgeleri sırala
function sortDocuments() {
    const selectElement = document.getElementById('documentSortBy');
    sortBy = selectElement.value;
    displaySortedDocuments();

    // Son yüklenen belgeleri de güncelle
    const recentDocuments = document.getElementById('recentDocuments');
    if (recentDocuments && recentDocuments.style.display !== 'none') {
        loadRecentDocuments();
    }
}

// Sıralanmış belgeleri göster
function displaySortedDocuments() {
    if (!currentDocuments.length) return;

    let sortedDocuments = [...currentDocuments];

    if (sortBy === 'alphabetic') {
        // Alfabetik sıralama - önce türe göre, sonra isime göre
        sortedDocuments.sort((a, b) => {
            const typeCompare = a.document_type.localeCompare(b.document_type, 'tr');
            if (typeCompare !== 0) return typeCompare;

            const nameA = a.filename ? a.filename.split('.').slice(0, -1).join('.') : '';
            const nameB = b.filename ? b.filename.split('.').slice(0, -1).join('.') : '';
            return nameA.localeCompare(nameB, 'tr');
        });
    } else {
        // Tarihe göre sıralama - en yeni en üstte
        sortedDocuments.sort((a, b) => {
            // Önce upload_datetime, sonra upload_date, son olarak ID'ye göre sırala
            if (a.upload_datetime && b.upload_datetime) {
                const dateA = new Date(a.upload_datetime);
                const dateB = new Date(b.upload_datetime);
                return dateB - dateA;
            }

            // upload_datetime yoksa upload_date kullan
            if (a.upload_date && b.upload_date) {
                const dateA = new Date(a.upload_date);
                const dateB = new Date(b.upload_date);
                return dateB - dateA;
            }

            // Son çare olarak ID'ye göre sırala (büyük ID = daha yeni)
            return (b.id || 0) - (a.id || 0);
        });
    }

    displayDocumentsByType(sortedDocuments);
    loadRecentDocuments(); // Son yüklenen 10 belgeyi yükle
}

// Belgeleri türe göre grupla ve göster
function displayDocumentsByType(documents) {
    const documentsList = document.getElementById('documentsList');
    if (!documentsList) return;

    // Belgeleri türe göre grupla
    const groupedDocs = {};
    documents.forEach(doc => {
        const type = doc.document_type || 'Diğer';
        if (!groupedDocs[type]) {
            groupedDocs[type] = [];
        }
        groupedDocs[type].push(doc);
    });

    // Türleri her zaman alfabetik sırala (sabit)
    const typeKeys = Object.keys(groupedDocs).sort((a, b) => a.localeCompare(b, 'tr'));

    // Her türün içindeki belgeleri sıralama seçeneğine göre sırala
    typeKeys.forEach(type => {
        if (sortBy === 'alphabetic') {
            groupedDocs[type].sort((a, b) => {
                const nameA = a.filename ? a.filename.split('.').slice(0, -1).join('.') : '';
                const nameB = b.filename ? b.filename.split('.').slice(0, -1).join('.') : '';
                return nameA.localeCompare(nameB, 'tr');
            });
        } else {
            // Tarihe göre sıralama - en yeni en üstte
            groupedDocs[type].sort((a, b) => {
                // Önce upload_datetime, sonra upload_date, son olarak ID'ye göre sırala
                if (a.upload_datetime && b.upload_datetime) {
                    const dateA = new Date(a.upload_datetime);
                    const dateB = new Date(b.upload_datetime);
                    return dateB - dateA;
                }

                // upload_datetime yoksa upload_date kullan
                if (a.upload_date && b.upload_date) {
                    const dateA = new Date(a.upload_date);
                    const dateB = new Date(b.upload_date);
                    return dateB - dateA;
                }

                // Son çare olarak ID'ye göre sırala (büyük ID = daha yeni)
                return (b.id || 0) - (a.id || 0);
            });
        }
    });

    // HTML oluştur
    documentsList.innerHTML = typeKeys.map(type => {
        const typeDocs = groupedDocs[type];
        const typeId = `type-${type.replace(/\s+/g, '-').toLowerCase()}`;

        return `
            <div class="document-type-group">
                <div class="document-type-header-group" onclick="toggleDocumentType('${typeId}')">
                    <h4>${type} (${typeDocs.length})</h4>
                    <span class="dropdown-arrow">▶</span>
                </div>
                <div class="document-type-content" id="${typeId}" style="display: none;">
                    ${typeDocs.map(doc => createDocumentItemHTML(doc)).join('')}
                </div>
            </div>
        `;
    }).join('') || '<p>Henüz belge yüklenmemiş.</p>';
}

// Belge türü grubunu aç/kapat
function toggleDocumentType(typeId) {
    const content = document.getElementById(typeId);
    const header = content.previousElementSibling;
    const arrow = header.querySelector('.dropdown-arrow');

    if (content.style.display === 'none') {
        content.style.display = 'block';
        arrow.textContent = '▼';
    } else {
        content.style.display = 'none';
        arrow.textContent = '▶';
    }
}

// Belge item HTML'ini oluştur
function createDocumentItemHTML(doc) {
    const fileNameParts = doc.filename ? doc.filename.split('.') : ['', ''];
    const fileName = fileNameParts.slice(0, -1).join('.');
    const originalName = doc.filepath ? doc.filepath.split('_').slice(2).join('_') : '';

    return `
        <div class="document-item" data-doc-id="${doc.id}">
            <div class="document-content">
                <div class="document-main">
                    <div class="document-info">
                        <i class="material-icons">${getFileIcon(doc.filename || '')}</i>
                        <div class="document-details">
                            <span class="document-name">${fileName}</span>
                            <span class="document-original-name">${originalName}</span>
                        </div>
                    </div>
                    <div class="document-right-section">
                        <span class="document-date">${doc.upload_date}</span>
                        <div class="document-actions">
                            <button class="btn small" onclick="previewDocument(${doc.id}, '${doc.filename || ''}')" title="Önizle">
                                <i class="material-icons">visibility</i>
                            </button>
                            <button class="btn small" onclick="downloadDocument(${doc.id})" title="İndir">
                                <i class="material-icons">download</i>
                            </button>
                            ${hasFileDeletePermission ? `
                            <button class="btn danger small" onclick="deleteDocument(${doc.id})" title="Sil">
                                <i class="material-icons">delete</i>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

// Masraf sıralama fonksiyonları
function sortExpenses() {
    const selectElement = document.getElementById('expenseSortBy');
    expenseSortBy = selectElement.value;
    displaySortedExpenses();
}

function displaySortedExpenses() {
    if (!currentExpensesData.length) return;

    let sortedExpenses = [...currentExpensesData];

    // Debug: masrafları console'da göster
    console.log('All expenses before sorting:', currentExpensesData.map(expense => ({
        id: expense.id,
        expense_type: expense.expense_type,
        amount: expense.amount,
        date: expense.date
    })));

    if (expenseSortBy === 'alphabetic') {
        // Alfabetik sıralama - türe göre
        sortedExpenses.sort((a, b) => a.expense_type.localeCompare(b.expense_type, 'tr'));
    } else {
        // Tarihe göre sıralama - en basit yöntem: ID'ye göre ters sırala (büyük ID = daha yeni)
        sortedExpenses.sort((a, b) => {
            return (b.id || 0) - (a.id || 0);
        });
    }

    // Debug: sıralama sonrası masraflar
    console.log('Expenses after sorting:', sortedExpenses.map(expense => ({
        id: expense.id,
        expense_type: expense.expense_type,
        date: expense.date
    })));

    const expensesList = document.getElementById('editExpensesList');
    if (expensesList) {
        expensesList.innerHTML = sortedExpenses.map(expense => `
            <div class="expense-item">
                <div class="expense-info">
                    <div class="expense-type">${expense.expense_type}</div>
                    <div class="expense-amount">₺${expense.amount}</div>
                    <div class="expense-date">${expense.date}</div>
                    <div class="expense-description">${expense.description || ''}</div>
                </div>
                <div class="expense-actions">
                    <div class="expense-status ${expense.is_paid ? 'status-paid' : 'status-unpaid'}">
                        ${expense.is_paid ? 'Ödendi' : 'Ödenmedi'}
                    </div>
                    <button type="button" class="btn small" onclick="editExpense(${expense.id})">
                        <i class="material-icons">edit</i>
                    </button>
                    <button type="button" class="btn small danger" onclick="deleteExpense(${expense.id})">
                        <i class="material-icons">delete</i>
                    </button>
                </div>
            </div>
        `).join('') || '<p>Henüz masraf kaydı bulunmuyor.</p>';
    }
}

// Masraf silme fonksiyonu
function deleteExpense(expenseId) {
    if (confirm('Bu masrafı silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_expense/${expenseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Masraf listesini güncelle
                showDetails(currentCaseId);
            } else {
                throw new Error(result.message || 'Masraf silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Masraf silinirken bir hata oluştu: ' + error.message);
        });
    }
}

// Açıklama düzenleme fonksiyonlarını ekle
function editDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    const textarea = document.getElementById('editDescriptionText');
    const currentText = document.getElementById('detailDescription').textContent;
    
    textarea.value = currentText === 'Açıklama bulunmuyor.' ? '' : currentText;
    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';
    textarea.focus();
}

function cancelEditDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function saveDescription() {
    const newDescription = document.getElementById('editDescriptionText').value;
    
    fetch(`/update_description/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            description: newDescription
        })
    })
    .then(response => {
        if (response.status === 403) {
            alert('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz. Dosya düzenleme yetkisi gereklidir.');
            cancelEditDescription();
            return Promise.reject(new Error('Yetki hatası'));
        }
        
        if (!response.ok) {
            throw new Error('Sunucu hatası');
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            document.getElementById('detailDescription').textContent = 
                newDescription || 'Açıklama bulunmuyor.';
            cancelEditDescription();
        } else {
            throw new Error(result.message || 'Açıklama güncellenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        if (error.message !== 'Yetki hatası') {
            alert('Açıklama güncellenirken bir hata oluştu: ' + error.message);
        }
    });
}

// Duruşma bilgilerini takvime senkronize et
function syncHearingToCalendar(caseId, hearingDate, hearingTime, status, hearingType = 'durusma') {
    console.log('syncHearingToCalendar çağrıldı:', {
        caseId: caseId,
        hearingDate: hearingDate,
        hearingTime: hearingTime,
        status: status,
        hearingType: hearingType
    });
    
    fetch('/sync_hearing_to_calendar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            case_id: caseId,
            hearing_date: hearingDate,
            hearing_time: hearingTime || '09:00',
            status: status,
            hearing_type: hearingType // Duruşma türünü ekle
        })
    })
    .then(response => {
        console.log('Takvim senkronizasyonu yanıtı:', response.status);
        return response.json();
    })
    .then(result => {
        console.log('Takvim senkronizasyonu sonucu:', result);
        if (!result.success) {
            throw new Error(result.message || 'Takvim senkronizasyonu başarısız');
        } else {
            console.log('Takvim senkronizasyonu başarılı:', result.message);
        }
    })
    .catch(error => {
        console.error('Takvim senkronizasyonu hatası:', error);
        alert('Duruşma bilgileri güncellenirken bir hata oluştu: ' + error.message);
    });
}

// Dosya silme fonksiyonu
function deleteCase(caseId) {
    if (confirm('Bu dosyayı ve tüm ilişkili bilgileri silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
        // Delete butonunu bul ve loading göstericisini aktif et
        const deleteButton = document.querySelector(`[onclick="deleteCase(${caseId})"]`);
        let originalContent;
        if (deleteButton) {
            originalContent = deleteButton.innerHTML;
            deleteButton.innerHTML = '<i class="material-icons rotating">refresh</i>';
            deleteButton.disabled = true;
        }

        fetch(`/delete_case/${caseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.status === 403) {
                showGlobalNotification('Bu işlemi yapmak için gerekli yetkiye sahip değilsiniz. Dosya silme yetkisi gereklidir.', 'error');
                return Promise.reject(new Error('Yetki hatası'));
            }

            if (response.status === 500) {
                throw new Error('Sunucu hatası - Lütfen yöneticinizle iletişime geçin');
            }

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showGlobalNotification('Dosya başarıyla silindi!', 'success');
                if (result.warning) {
                    showGlobalNotification(result.warning, 'warning');
                }
                // Tablodan ilgili satırı kaldır
                const row = document.querySelector(`tr[data-case-id="${caseId}"]`);
                if (row) {
                    row.remove();
                }
                // Sayfa boşsa sayfayı yenile
                const remainingRows = document.querySelectorAll('table tbody tr');
                if (remainingRows.length === 0) {
                    location.reload();
                }
            } else {
                throw new Error(result.message || 'Dosya silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            if (error.message !== 'Yetki hatası') {
                showGlobalNotification('Dosya silinirken bir hata oluştu: ' + error.message, 'error');
            }
        })
        .finally(() => {
            // Butonu eski haline döndür
            if (deleteButton && originalContent) {
                deleteButton.innerHTML = originalContent;
                deleteButton.disabled = false;
            }
        });
    }
}

// Masraf düzenleme fonksiyonunu ekle
function editExpense(expenseId) {
    const expense = currentExpenses.find(e => e.id === expenseId);
    if (!expense) return;

    // Tarihi YYYY-MM-DD formatına çevir
    const formattedDate = expense.date.split('.').reverse().join('-');

    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf Düzenle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf Türü</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">Seçiniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}" ${expense.expense_type === type ? 'selected' : ''}>${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf türünü yazınız" 
                                       style="display: none;"
                                       value="${expense.expense_type}">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required value="${expense.amount}">
                                <span class="currency-symbol">₺</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required value="${formattedDate}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ödeme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input" ${expense.is_paid ? 'checked' : ''}>
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ödenmedi</span>
                                    <span class="toggle-text-on">Ödendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>Açıklama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili açıklama ekleyin...">${expense.description || ''}</textarea>
                    </div>
                    <input type="hidden" id="expenseId" value="${expense.id}">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">İptal</button>
                <button class="btn primary" onclick="updateExpense()">Güncelle</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// Masraf güncelleme fonksiyonu
function updateExpense() {
    const expenseId = document.getElementById('expenseId').value;
    const data = {
        expense_type: document.getElementById('expenseType').value === 'Diğer' ? 
                     document.getElementById('otherExpenseType').value : 
                     document.getElementById('expenseType').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        is_paid: document.getElementById('expenseStatus').checked,
        description: document.getElementById('expenseDescription').value || ''
    };

    fetch(`/update_expense/${expenseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf güncellenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf güncellenirken bir hata oluştu: ' + error.message);
    });
}

// Tablo Sıralama Fonksiyonları
let currentSort = { column: '', direction: '' };

function initializeTableSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortColumn = this.getAttribute('data-sort');
            sortTable(sortColumn);
        });
    });
}

function sortTable(column) {
    const table = document.getElementById('casesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Sıralama yönünü belirle
    let direction = 'asc';
    if (currentSort.column === column && currentSort.direction === 'asc') {
        direction = 'desc';
    }
    
    // Önceki sıralama ikonlarını temizle
    document.querySelectorAll('.sortable').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Aktif header'ı işaretle
    const activeHeader = document.querySelector(`[data-sort="${column}"]`);
    activeHeader.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
    
    // Satırları sırala
    rows.sort((a, b) => {
        let aValue = getCellValue(a, column);
        let bValue = getCellValue(b, column);
        
        // Numerik değerler için
        if (column === 'year' || column === 'case_number') {
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
        } else if (column === 'open_date') {
            // Tarihi YYYY-MM-DD formatına çevir
            aValue = convertDateForSort(aValue);
            bValue = convertDateForSort(bValue);
        } else {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (direction === 'asc') {
            return aValue > bValue ? 1 : (aValue < bValue ? -1 : 0);
        } else {
            return aValue < bValue ? 1 : (aValue > bValue ? -1 : 0);
        }
    });
    
    // Sıralanan satırları tbody'e geri ekle
    rows.forEach(row => tbody.appendChild(row));
    
    // Mevcut sıralama durumunu kaydet
    currentSort = { column, direction };
}

function getCellValue(row, column) {
    switch(column) {
        case 'file_type':
            return row.querySelector('.main-type')?.textContent || '';
        case 'year':
            return row.cells[1]?.textContent || '';
        case 'case_number':
            return row.cells[2]?.textContent || '';
        case 'client_name':
            return row.cells[3]?.textContent || '';
        case 'open_date':
            return row.cells[4]?.textContent || '';
        case 'status':
            return row.querySelector('.status-text')?.textContent || '';
        default:
            return '';
    }
}

function convertDateForSort(dateString) {
    if (!dateString || dateString === '-') {
        return '0000-00-00'; // Boş tarihler en alta
    }
    
    // DD.MM.YYYY formatından YYYY-MM-DD formatına çevir
    const parts = dateString.split('.');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    }
    
    return dateString;
}

// Sayfa yüklendiğinde sıralama özelliğini başlat
document.addEventListener('DOMContentLoaded', function() {
    initializeTableSorting();
});

// Dosya bilgileri düzenleme fonksiyonları
function toggleFileInfoEdit() {
    const displayDiv = document.getElementById('fileInfoDisplay');
    const editDiv = document.getElementById('fileInfoEdit');
    
    if (editDiv.style.display === 'none') {
        // Düzenleme moduna geç
        displayDiv.style.display = 'none';
        editDiv.style.display = 'block';
        
        // Mevcut değerleri forma yükle
        loadFileInfoToEdit();
    } else {
        // Görüntüleme moduna geç
        cancelFileInfoEdit();
    }
}

function loadFileInfoToEdit() {
    // Mevcut değerleri düzenleme formuna yükle
    const fileType = document.getElementById('detailFileType').textContent;
    const year = document.getElementById('detailYear').textContent;
    const caseNumber = document.getElementById('detailCaseNumber').textContent;
    const openDate = document.getElementById('detailOpenDate').textContent;
    const status = document.getElementById('detailStatus').textContent;
    const nextHearing = document.getElementById('detailNextHearing').textContent;
    const hearingTime = document.getElementById('detailHearingTime').textContent;
    const hearingType = document.getElementById('detailHearingType').textContent;
    
    // Dosya türünü doğru şekilde eşleştir - büyük harfli değerler olduğu gibi kalsın
    console.log('DEBUG: Original fileType from DOM:', fileType);
    let normalizedFileType = fileType.toLowerCase();
    
    // Türkçe büyük harf -> option value mapping
    if (fileType === 'Hukuk') {
        normalizedFileType = 'hukuk';
    } else if (fileType === 'Ceza') {
        normalizedFileType = 'ceza';
    } else if (fileType === 'İcra') {
        normalizedFileType = 'icra';
    } else if (fileType === 'Savcılık') {
        normalizedFileType = 'savcilik';
    } else if (fileType === 'Arabuluculuk') {
        normalizedFileType = 'ARABULUCULUK';
    } else if (fileType === 'Aihm' || fileType === 'AİHM') {
        normalizedFileType = 'AİHM';
    } else if (fileType === 'Aym' || fileType === 'AYM') {
        normalizedFileType = 'AYM';
    } else {
        // Eğer hiçbirine uymuyorsa, mevcut değer olduğu gibi kalsın
        console.warn('DEBUG: Unknown file type for mapping:', fileType);
    }
    
    console.log('DEBUG: Normalized fileType for select:', normalizedFileType);
    
    // Form alanlarını doldur
    document.getElementById('editFileType').value = normalizedFileType;
    document.getElementById('editYear').value = year;
    document.getElementById('editCaseNumber').value = caseNumber;
    document.getElementById('editStatus').value = status;
    
    // Tarihi DD.MM.YYYY'den YYYY-MM-DD'ye çevir
    if (openDate && openDate !== '-') {
        const parts = openDate.split('.');
        if (parts.length === 3) {
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            document.getElementById('editOpenDate').value = formattedDate;
        }
    }
    
    // Duruşma tarihi
    if (nextHearing && nextHearing !== '-') {
        const parts = nextHearing.split('.');
        if (parts.length === 3) {
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            document.getElementById('editNextHearing').value = formattedDate;
        }
    }
    
    // Duruşma saati
    if (hearingTime && hearingTime !== '-') {
        document.getElementById('editHearingTime').value = hearingTime;
    }
    
    // Duruşma türü
    if (hearingType && hearingType !== '-') {
        const typeValue = hearingType.includes('E-Duruşma') ? 'e-durusma' : 'durusma';
        document.getElementById('editHearingType').value = typeValue;
    }
    
    // Şehir ve adliye listelerini yükle
    loadEditCityOptions();
}

function loadEditCityOptions() {
    const citySelect = document.getElementById('editCity');
    citySelect.innerHTML = '<option value="">Seçiniz</option>';
    
    // cities_list global değişkeni varsa kullan
    if (typeof cities_list !== 'undefined') {
        cities_list.forEach(city => {
            const option = document.createElement('option');
            option.value = city;
            option.textContent = city;
            citySelect.appendChild(option);
        });
    }
    
    // Mevcut şehri seç
    const currentCity = document.getElementById('detailCity').textContent;
    if (currentCity && currentCity !== '-') {
        citySelect.value = currentCity;
        updateEditCourthouse();
    }
}

function updateEditCourthouse() {
    const citySelect = document.getElementById('editCity');
    const courthouseSelect = document.getElementById('editCourthouse');
    const selectedCity = citySelect.value;
    
    courthouseSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    if (!selectedCity) {
        courthouseSelect.innerHTML = '<option value="">Önce şehir seçiniz</option>';
        return;
    }
    
    // all_courthouses_data global değişkeni varsa kullan
    if (typeof all_courthouses_data !== 'undefined' && all_courthouses_data[selectedCity]) {
        all_courthouses_data[selectedCity].forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
    
    // Mevcut adliyeyi seç
    const currentCourthouse = document.getElementById('detailCourthouse').textContent;
    if (currentCourthouse && currentCourthouse !== '-') {
        courthouseSelect.value = currentCourthouse;
    }
    
    // Mahkeme seçeneklerini güncelle
    updateEditDepartment();
}

function updateEditDepartment() {
    const fileType = document.getElementById('editFileType').value.toLowerCase();
    const departmentSelect = document.getElementById('editDepartment');
    
    // Mevcut seçenekleri temizle
    departmentSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    let departments = [];
    if (fileType === 'hukuk') {
        departments = [
            'Asliye Hukuk Mahkemesi', 'Sulh Hukuk Mahkemesi', 'İş Mahkemesi', 'Aile Mahkemesi',
            'Ticaret Mahkemesi', 'İcra Hukuk Mahkemesi', 'Tüketici Mahkemesi', 'Fikri ve Sınai Haklar Mahkemesi'
        ];
    } else if (fileType === 'ceza') {
        departments = ['Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği'];
    } else if (fileType === 'icra') {
        departments = ['İcra Dairesi'];
    }
    
    departments.forEach(dept => {
        const option = document.createElement('option');
        option.value = dept;
        option.textContent = dept;
        departmentSelect.appendChild(option);
    });
    
    // Mevcut mahkemeyi seç
    const currentDepartment = document.getElementById('detailDepartment').textContent;
    if (currentDepartment && currentDepartment !== '-') {
        departmentSelect.value = currentDepartment;
    }
}

function updateEditFileType() {
    // Dosya türü değiştiğinde mahkeme seçeneklerini güncelle
    updateEditDepartment();
}

function cancelFileInfoEdit() {
    const displayDiv = document.getElementById('fileInfoDisplay');
    const editDiv = document.getElementById('fileInfoEdit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function saveFileInfo() {
    // Form verilerini al
    const fileType = document.getElementById('editFileType').value;
    console.log('DEBUG: Saving fileType:', fileType);
    const year = document.getElementById('editYear').value;
    const caseNumber = document.getElementById('editCaseNumber').value;
    const openDate = document.getElementById('editOpenDate').value;
    const city = document.getElementById('editCity').value;
    const courthouse = document.getElementById('editCourthouse').value;
    const department = document.getElementById('editDepartment').value;
    const status = document.getElementById('editStatus').value;
    const nextHearing = document.getElementById('editNextHearing').value;
    const hearingTime = document.getElementById('editHearingTime').value;
    const hearingType = document.getElementById('editHearingType').value;
    
    // Validasyon
    if (!fileType || !year || !caseNumber || !status) {
        alert('Dosya türü, yıl, esas no ve durum alanları zorunludur.');
        return;
    }
    
    // Backend'e gönder
    const formData = new FormData();
    formData.append('case_id', currentCaseId);
    formData.append('file_type', fileType);
    formData.append('year', year);
    formData.append('case_number', caseNumber);
    formData.append('open_date', openDate);
    formData.append('city', city);
    formData.append('courthouse', courthouse);
    formData.append('department', department);
    formData.append('status', status);
    formData.append('next_hearing', nextHearing);
    formData.append('hearing_time', hearingTime);
    formData.append('hearing_type', hearingType);
    formData.append('csrf_token', csrfToken);
    
    fetch('/update_case_basic_info', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('DEBUG: Server response for file update:', data);
        if (data.success) {
            // Görüntüleme alanlarını güncelle
            updateFileInfoDisplay({
                file_type: fileType,
                year: year,
                case_number: caseNumber,
                open_date: openDate,
                city: city,
                courthouse: courthouse,
                department: department,
                status: status,
                next_hearing: nextHearing,
                hearing_time: hearingTime,
                hearing_type: hearingType
            });
            
            cancelFileInfoEdit();
            alert('Dosya bilgileri başarıyla güncellendi.');
        } else {
            alert('Hata: ' + (data.message || 'Dosya bilgileri güncellenirken bir hata oluştu.'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Dosya bilgileri güncellenirken bir hata oluştu.');
    });
}

function updateFileInfoDisplay(data) {
    // Görüntüleme alanlarını güncelle
    document.getElementById('detailFileType').textContent = capitalizeFileType(data.file_type);
    document.getElementById('detailYear').textContent = data.year;
    document.getElementById('detailCaseNumber').textContent = data.case_number;
    document.getElementById('detailStatus').textContent = data.status;
    document.getElementById('detailCity').textContent = data.city || '-';
    document.getElementById('detailCourthouse').textContent = data.courthouse || '-';
    document.getElementById('detailDepartment').textContent = data.department || '-';
    
    // Tarihleri formatla
    if (data.open_date) {
        const date = new Date(data.open_date);
        const formatted = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
        document.getElementById('detailOpenDate').textContent = formatted;
    } else {
        document.getElementById('detailOpenDate').textContent = '-';
    }
    
    // Duruşma bilgileri
    if (data.next_hearing) {
        const date = new Date(data.next_hearing);
        const formatted = `${date.getDate().toString().padStart(2, '0')}.${(date.getMonth() + 1).toString().padStart(2, '0')}.${date.getFullYear()}`;
        document.getElementById('detailNextHearing').textContent = formatted;
    } else {
        document.getElementById('detailNextHearing').textContent = '-';
    }
    
    document.getElementById('detailHearingTime').textContent = data.hearing_time || '-';
    
    const hearingTypeText = data.hearing_type === 'e-durusma' ? 'E-Duruşma' : 'Normal Duruşma';
    document.getElementById('detailHearingType').textContent = hearingTypeText;
}



// ... existing code ...
</script>
{% endblock %}