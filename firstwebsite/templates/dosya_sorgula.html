{% extends "layout.html" %}

{% block title %}Dosya Sorgula{% endblock %}

{% block content %}
<header>
    <div class="header-left">
        <h1>Dosya Sorgula</h1>
    </div>
</header>

<div class="inbox">
    <form method="POST" class="search-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-columns">
            <!-- Sol SÃ¼tun -->
            <div class="form-column">
                <div class="input-group">
                    <label for="file-type">Dosya TÃ¼rÃ¼</label>
                    <select id="file-type" name="file-type" onchange="handleFileTypeChange()">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="hukuk">Hukuk</option>
                        <option value="ceza">Ceza</option>
                        <option value="icra">Ä°cra</option>
                        <option value="savcilik">SavcÄ±lÄ±k</option>
                        <option value="ARABULUCULUK">Arabuluculuk</option>
                        <option value="AÄ°HM">AÄ°HM</option>
                        <option value="AYM">AYM</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="city">Åžehir</label>
                    <select id="city" name="city" onchange="updateCourthouses()">
                        <option value="">TÃ¼mÃ¼</option>
                        {% for city_name in cities %}
                            <option value="{{ city_name }}">{{ city_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="courthouse">Adliye</label>
                    <select id="courthouse" name="courthouse">
                        <option value="">TÃ¼mÃ¼</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="department">Mahkeme</label>
                    <select id="department" name="department" onchange="updateCourtNumbers(this.value)">
                        <option value="">TÃ¼mÃ¼</option>
                    </select>
                </div>

                <div class="input-group" id="court-number-container">
                    <label for="court-number">NumaralÄ± Mahkeme</label>
                    <select id="court-number" name="court-number">
                        <option value="">TÃ¼mÃ¼</option>
                    </select>
                </div>
            </div>
            
            <!-- SaÄŸ SÃ¼tun -->
            <div class="form-column">
                <div class="form-row">
                    <div class="input-group">
                        <label for="year">YÄ±l</label>
                        <input type="number" id="year" name="year">
                    </div>
                    <div class="input-group">
                        <label for="case-number">Esas No</label>
                        <input type="text" id="case-number" name="case-number">
                    </div>
                </div>
                <div class="input-group">
                    <label for="client-name">MÃ¼vekkil AdÄ±</label>
                    <input type="text" id="client-name" name="client-name">
                </div>
                <div class="input-group">
                    <label for="status">Dosya Durumu</label>
                    <select id="status" name="status">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="Aktif">Aktif</option>
                        <option value="KapalÄ±">KapalÄ±</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="search-button-container">
            <button type="submit" class="btn">Ara</button>
        </div>
    </form>
</div>

<table class="modern-table" id="casesTable">
    <thead>
        <tr>
            <th class="sortable" data-sort="file_type">
                Dosya TÃ¼rÃ¼
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="year">
                YÄ±l
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="case_number">
                Esas No
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="client_name">
                MÃ¼vekkil AdÄ±
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="open_date">
                AÃ§Ä±lÄ±ÅŸ Tarihi
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th class="sortable" data-sort="status">
                Durum
                <i class="sort-icon material-icons">swap_vert</i>
            </th>
            <th>Ä°ÅŸlemler</th>
        </tr>
    </thead>
    <tbody>
        {% for case_file in case_files %}
        <tr data-case-id="{{ case_file.id }}">
            <td class="case-type">
                <div class="file-type-details">
                    <div class="main-type">{{ case_file.file_type|title }}</div>
                    <div class="sub-details">
                        {% if case_file.file_type not in ['AÄ°HM', 'AYM', 'ARABULUCULUK'] and case_file.courthouse %}
                        <small>{{ case_file.courthouse }}</small>
                        {% endif %}
                        {% if case_file.file_type not in ['AÄ°HM', 'AYM', 'ARABULUCULUK', 'savcilik'] and case_file.department %}
                        <small>{{ case_file.department }}</small>
                        {% endif %}
                    </div>
                </div>
            </td>
            <td>{{ case_file.year }}</td>
            <td class="case-number">{{ case_file.case_number }}</td>
            <td class="client-name">{{ case_file.client_name }}</td>
            <td class="open-date">
                {% if case_file.open_date %}
                    {{ case_file.open_date.strftime('%d.%m.%Y') }}
                {% else %}
                    -
                {% endif %}
            </td>
            <td>
                <span class="case-status status-text {% if case_file.status == 'Aktif' %}status-active{% else %}status-closed{% endif %}">
                    {{ case_file.status }}
                </span>
            </td>
            <td>
                <button class="action-btn view-btn" onclick="showDetails('{{ case_file.id }}')" title="Dosya DetaylarÄ±">
                    <i class="material-icons">visibility</i>
                </button>
                <span style="color: #dee2e6; margin: 0 8px;">|</span>
                <button class="action-btn delete-btn" onclick="deleteCase('{{ case_file.id }}')" title="DosyayÄ± Sil">
                    <i class="material-icons">delete</i>
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Dosya Detay ModalÄ± -->
<div id="fileDetailModal" class="file-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Dosya DetaylarÄ±</h2>
            <button class="close-btn" onclick="closeDetailModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Ãœst Bilgiler Container -->
            <div class="top-info-container">
                <!-- Dosya Bilgileri -->
                <div class="detail-section basic-info">
                    <h3><i class="material-icons">folder</i> Dosya Bilgileri</h3>
                    <div class="info-row">
                        <div class="info-group">
                            <label>DOSYA TÃœRÃœ</label>
                            <span id="detailFileType"></span>
                        </div>
                        <div class="info-group">
                            <label>YIL</label>
                            <span id="detailYear"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group">
                            <label>ESAS NO</label>
                            <span id="detailCaseNumber"></span>
                        </div>
                        <div class="info-group">
                            <label>AÃ‡ILIÅž TARÄ°HÄ°</label>
                            <span id="detailOpenDate"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group">
                            <label>ÅžEHÄ°R</label>
                            <span id="detailCity"></span>
                        </div>
                        <div class="info-group">
                            <label>ADLÄ°YE</label>
                            <span id="detailCourthouse"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group">
                            <label>MAHKEME</label>
                            <span id="detailDepartment"></span>
                        </div>
                        <div class="info-group">
                            <label>DURUM</label>
                            <span id="detailStatus"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group full-width">
                            <label>SONRAKÄ° DURUÅžMA</label>
                            <div class="hearing-info">
                                <span id="detailNextHearing"></span>
                                <span class="hearing-separator">-</span>
                                <span id="detailHearingTime"></span>
                                <span class="hearing-separator">-</span>
                                <span id="detailHearingType"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MÃ¼vekkil Bilgileri -->
                <div class="detail-section">
                    <h3><i class="material-icons">person</i> MÃ¼vekkil Bilgileri</h3>
                    <div class="info-row">
                        <div class="info-group">
                            <label>TÄ°P</label>
                            <span id="detailClientEntityType"></span>
                        </div>
                        <div class="info-group">
                            <label>SIFAT</label>
                            <span id="detailClientCapacity"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group full-width">
                            <label>AD SOYAD / UNVAN</label>
                            <span id="detailClientName"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group full-width">
                            <label>KÄ°MLÄ°K / VERGÄ° NO</label>
                            <span id="detailClientIdentityNumber"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group">
                            <label>TELEFON</label>
                            <span id="detailPhoneNumber"></span>
                        </div>
                        <div class="info-group">
                            <label>ADRES</label>
                            <span id="detailClientAddress"></span>
                        </div>
                    </div>
                    <!-- Ek MÃ¼vekkiller -->
                    <div id="additionalClientsDisplay" class="additional-display">
                        <!-- Dinamik olarak eklenecek -->
                    </div>
                </div>

                <!-- KarÅŸÄ± Taraf Bilgileri -->
                <div class="detail-section">
                    <h3><i class="material-icons">group</i> KarÅŸÄ± Taraf Bilgileri</h3>
                    <div class="info-row">
                        <div class="info-group">
                            <label>TÄ°P</label>
                            <span id="detailOpponentEntityType"></span>
                        </div>
                        <div class="info-group">
                            <label>SIFAT</label>
                            <span id="detailOpponentCapacity"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group full-width">
                            <label>AD SOYAD / UNVAN</label>
                            <span id="detailOpponentName"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group full-width">
                            <label>KÄ°MLÄ°K / VERGÄ° NO</label>
                            <span id="detailOpponentIdentityNumber"></span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-group">
                            <label>TELEFON</label>
                            <span id="detailOpponentPhone"></span>
                        </div>
                        <div class="info-group">
                            <label>ADRES</label>
                            <span id="detailOpponentAddress"></span>
                        </div>
                    </div>
                    
                    <!-- Vekil Bilgileri -->
                    <div id="opponentLawyerDisplay" class="lawyer-display" style="display: none;">
                        <h4><i class="material-icons">account_balance</i> Vekil Bilgileri</h4>
                        <div class="info-row">
                            <div class="info-group">
                                <label>VEKÄ°L ADI SOYADI</label>
                                <span id="detailOpponentLawyer"></span>
                            </div>
                            <div class="info-group">
                                <label>VEKÄ°L TELEFONU</label>
                                <span id="detailOpponentLawyerPhone"></span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group full-width">
                                <label>VEKÄ°L ADRESÄ°</label>
                                <span id="detailOpponentLawyerAddress"></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ek KarÅŸÄ± Taraflar -->
                    <div id="additionalOpponentsDisplay" class="additional-display">
                        <!-- Dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>

            <!-- Dosya AÃ§Ä±klamasÄ± -->
            <div class="detail-section description-section">
                <div class="section-header">
                    <h3>Dosya AÃ§Ä±klamasÄ±</h3>
                    <button class="btn edit-btn" onclick="editDescription()" title="AÃ§Ä±klama DÃ¼zenle">
                        <i class="material-icons">edit</i>
                    </button>
                </div>
                <div class="description-container">
                    <div id="descriptionDisplay">
                        <p id="detailDescription">AÃ§Ä±klama bulunmuyor.</p>
                    </div>
                    <div id="descriptionEdit" style="display: none;">
                        <textarea id="editDescriptionText" rows="4" class="description-textarea"></textarea>
                        <div class="description-actions">
                            <button class="btn secondary" onclick="cancelEditDescription()">Ä°ptal</button>
                            <button class="btn primary" onclick="saveDescription()">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Alt BÃ¶lÃ¼mler Container - Yan Yana -->
            <div class="bottom-sections-container">
                <!-- Masraflar -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>Masraflar</h3>
                        <button class="btn primary" onclick="showExpenseModal()">
                            <i class="material-icons">add</i> Masraf Ekle
                        </button>
                    </div>
                    <div id="editExpensesList" class="expenses-list"></div>
                </div>

                <!-- Belgeler -->
                <div class="detail-section">
                    <div class="section-header">
                        <h3>Belgeler</h3>
                        <button class="btn primary" onclick="showUploadModal()">
                            <i class="material-icons">upload</i> Belge YÃ¼kle
                        </button>
                    </div>
                    <div id="documentsList" class="documents-list"></div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" onclick="closeDetailModal()">Kapat</button>
            <button class="btn primary" onclick="editCase(currentCaseId)">DÃ¼zenle</button>
        </div>
    </div>
</div>

<style>
/* Modal ana stilleri */
.file-detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

/* Sadece alt modallar iÃ§in animasyonlar */
@keyframes modalFadeIn {
    from {
        opacity: 0;
        backdrop-filter: blur(0px);
    }
    to {
        opacity: 1;
        backdrop-filter: blur(8px);
    }
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

/* Sadece expense ve upload modallarÄ± iÃ§in animasyonlar */
.modal-content.expense-modal,
.modal-content.upload-modal {
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
    transform-origin: center center;
}

/* Sadece expense ve upload modallarÄ± iÃ§in hover efektleri */
.modal-content.expense-modal:hover,
.modal-content.upload-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 25px 70px rgba(0, 0, 0, 0.2);
}

/* Masraf ve belge ekleme butonlarÄ±na Ã¶zel animasyonlar */
.modal-content.expense-modal .expense-group,
.modal-content.upload-modal .detail-group {
    animation: slideInUp 0.3s ease-out;
    animation-fill-mode: both;
}

.modal-content.expense-modal .expense-group:nth-child(1) { animation-delay: 0.1s; }
.modal-content.expense-modal .expense-group:nth-child(2) { animation-delay: 0.15s; }
.modal-content.expense-modal .expense-group:nth-child(3) { animation-delay: 0.2s; }
.modal-content.expense-modal .expense-group:nth-child(4) { animation-delay: 0.25s; }
.modal-content.expense-modal .expense-group:nth-child(5) { animation-delay: 0.3s; }

.modal-content.upload-modal .detail-group:nth-child(1) { animation-delay: 0.1s; }
.modal-content.upload-modal .detail-group:nth-child(2) { animation-delay: 0.15s; }
.modal-content.upload-modal .detail-group:nth-child(3) { animation-delay: 0.2s; }

@keyframes slideInUp {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.modal-content {
    background: white;
    width: 95%;
    max-width: 1400px;
    max-height: 90vh;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: #2c3e50;
    font-weight: 600;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
}

/* Ãœst bilgiler container - yan yana yerleÅŸim */
.top-info-container {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

@media (max-width: 1300px) {
    .top-info-container {
        grid-template-columns: 1fr 1fr;
    }
}

@media (max-width: 768px) {
    .top-info-container {
        grid-template-columns: 1fr;
    }
}

/* Temel bilgiler bÃ¶lÃ¼mÃ¼ */
.basic-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

.info-row {
    display: flex;
    gap: 15px;
    margin-bottom: 12px;
}

.info-row:last-child {
    margin-bottom: 0;
}

.info-group {
    flex: 1;
    min-width: 0;
}

.info-group.full-width {
    flex: 2;
    grid-column: span 2;
}

.info-group.full-width span {
    white-space: normal;
    max-height: 3em;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.info-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-group span {
    display: block;
    font-size: 0.95rem;
    color: #2c3e50;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.4;
    word-wrap: break-word;
}

/* DuruÅŸma bilgileri iÃ§in Ã¶zel stiller */
.hearing-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
    flex-wrap: nowrap;
}

.hearing-info span {
    color: #2c3e50;
    font-weight: normal;
    white-space: nowrap;
    flex-shrink: 0;
}

.hearing-separator {
    color: #6c757d !important;
    font-weight: normal !important;
    flex-shrink: 0;
}

/* Durum iÃ§in Ã¶zel stiller */
.file-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
}

.file-status.active {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.file-status.closed {
    background-color: #ffebee;
    color: #c62828;
}

/* BÃ¶lÃ¼m baÅŸlÄ±klarÄ± */
.detail-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 0;
    border: 1px solid #e9ecef;
}

/* AÃ§Ä±klama bÃ¶lÃ¼mÃ¼ iÃ§in Ã¶zel stil */
.detail-section.description-section {
    margin-bottom: 30px;
}

/* Alt bÃ¶lÃ¼mler iÃ§in yan yana container */
.bottom-sections-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 30px;
}

/* Alt bÃ¶lÃ¼mlerde detail-section margin'larÄ±nÄ± dÃ¼zenle */
.bottom-sections-container .detail-section {
    margin-bottom: 0;
}

/* Mobil responsive */
@media (max-width: 1024px) {
    .bottom-sections-container {
        grid-template-columns: 1fr;
        gap: 15px;
    }
}

/* Edit modal iÃ§in bilgiler container */
.edit-info-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.edit-section {
    background: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

@media (max-width: 768px) {
    .edit-info-container {
        grid-template-columns: 1fr;
    }
}

.detail-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn.primary {
    background: #1a237e;
    color: white;
}

.btn.primary:hover {
    background: #0d1b6e;
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Modal footer */
.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* Butonlar iÃ§in yeni renk */
:root {
    --primary-blue: #2d313c;  /* Ana tema rengi */
    --primary-hover: #3c404d;
    --light-blue-bg: #f5f5f6;
}

/* DÃ¼zenleme modalÄ± iÃ§in stiller - Dosya detaylarÄ± gibi */
#editModal .modal-content {
    background: white;
    width: 95%;
    max-width: 1400px;
    max-height: 95vh;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    overflow: hidden;
}

/* Modal header */
#editModal .modal-header {
    background: linear-gradient(135deg, #1a237e 0%, #2d313c 100%);
    color: white;
    padding: 25px 30px;
    border-bottom: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#editModal .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
}

#editModal .modal-header .close-btn {
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 8px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

#editModal .modal-header .close-btn:hover {
    background: rgba(255,255,255,0.3);
}

#editModal .modal-header .close-btn .material-icons {
    color: white;
    font-size: 20px;
}

#editModal .modal-body {
    padding: 25px 30px;
    overflow-y: auto;
    flex: 1;
    background: #f8f9fa;
}

#editModal .detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 20px;
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#editModal .detail-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#editModal .detail-group.full-width {
    grid-column: span 2;
}

#editModal .detail-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

#editModal .detail-group input,
#editModal .detail-group select,
#editModal .detail-group textarea {
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #2c3e50;
    background: white;
    transition: all 0.2s ease;
}

#editModal .detail-group input:focus,
#editModal .detail-group select:focus,
#editModal .detail-group textarea:focus {
    border-color: #1a237e;
    outline: none;
    box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1);
}

/* Edit sections styling */
#editModal .edit-section {
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

#editModal .edit-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal .edit-section h3 .material-icons {
    color: #1a237e;
    font-size: 20px;
}

#editModal textarea {
    min-height: 80px;
    resize: vertical;
}

/* Modal footer */
#editModal .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: white;
}

/* Dosya bilgileri bÃ¶lÃ¼mÃ¼ iÃ§in Ã¶zel baÅŸlÄ±k */
#editModal h3:has(.material-icons) {
    font-size: 1.2rem;
    color: #2c3e50;
    margin: 25px 0 15px 0;
    padding: 15px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

#editModal h3 .material-icons {
    color: #1a237e;
    font-size: 24px;
}

/* ButonlarÄ± gÃ¼ncelle */
.btn.primary {
    background: var(--primary-blue) !important;
    color: white !important;
}

.btn.primary:hover {
    background: var(--primary-hover) !important;
}

/* Masraf Ekle ve Belge YÃ¼kle butonlarÄ±ndaki ikonlarÄ± beyaz yap */
.btn.primary .material-icons {
    color: white !important;
}

/* DuruÅŸma tarihi ve saati iÃ§in Ã¶zel stil */
.hearing-datetime {
    display: flex;
    gap: 10px;
}

.hearing-datetime input[type="date"] {
    flex: 2;
}

.hearing-datetime input[type="time"] {
    flex: 1;
}

/* Aktif/KapalÄ± durumu iÃ§in badge stilleri */
.status-badge {
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-badge.active {
    background: #E8F5E9;
    color: #2E7D32;
}

.status-badge.closed {
    background: #FFEBEE;
    color: #C62828;
}

/* Modal header ve footer */
.modal-header, .modal-footer {
    background: #f8f9fa;
    padding: 20px 25px;
}

.modal-header {
    border-radius: 12px 12px 0 0;
}

.modal-footer {
    border-radius: 0 0 12px 12px;
}

/* Masraflar bÃ¶lÃ¼mÃ¼ stilleri */
.expenses-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.expense-info {
    display: grid;
    grid-template-columns: repeat(4, auto);
    gap: 20px;
    align-items: center;
}

.expense-type {
    font-weight: 500;
    color: #2c3e50;
}

.expense-amount {
    color: #2d313c;
    font-weight: 600;
}

.expense-date {
    color: #6c757d;
    font-size: 0.9rem;
}

.expense-description {
    color: #495057;
    font-size: 0.9rem;
}

/* Belge listesi stilleri */
.documents-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.document-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

.document-type-header {
    background: #e3f2fd;
    color: #1976d2;
    padding: 8px 15px;
    font-weight: 500;
    font-size: 0.9rem;
}

.document-content {
    padding: 15px;
}

.document-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.document-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.document-info i {
    color: #2196F3;
    font-size: 24px;
}

.document-name {
    font-weight: 500;
    color: #2c3e50;
}

.document-date {
    color: #6c757d;
    font-size: 0.9rem;
}

.document-actions {
    display: flex;
    gap: 8px;
}

.document-actions .btn {
    padding: 6px;
}

.document-actions .btn i {
    font-size: 20px;
}

/* Modern Tablo Stilleri */
.modern-table {
    width: 100%;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    overflow: hidden;
    margin-top: 20px;
    border-collapse: separate;
    border-spacing: 0;
}

.modern-table thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modern-table th {
    padding: 16px 20px;
    text-align: left;
    font-weight: 600;
    font-size: 14px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    border: none;
    position: relative;
}

.modern-table th.sortable {
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s ease;
}

.modern-table th.sortable:hover {
    background-color: rgba(255, 255, 255, 0.1);
}

.sort-icon {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0.7;
    transition: all 0.2s ease;
}

.modern-table th.sort-asc .sort-icon {
    transform: translateY(-50%) rotate(180deg);
    opacity: 1;
}

.modern-table th.sort-desc .sort-icon {
    transform: translateY(-50%) rotate(0deg);
    opacity: 1;
}

.modern-table tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid #f1f5f9;
}

.modern-table tbody tr:hover {
    background-color: #f8fafc;
    transform: scale(1.01);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.modern-table tbody tr:last-child {
    border-bottom: none;
}

.modern-table td {
    padding: 16px 20px;
    vertical-align: middle;
    border: none;
    font-size: 14px;
    color: #1e293b;
}

.case-type .main-type {
    font-weight: 600;
    color: #1e40af;
    margin-bottom: 4px;
}

.case-type .sub-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.case-type .sub-details small {
    color: #64748b;
    font-size: 12px;
}

.case-number {
    font-weight: 600;
    color: #059669;
    font-family: 'Courier New', monospace;
}

.client-name {
    font-weight: 500;
    color: #374151;
}

.status-text {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.status-closed {
    background: #fee2e2;
    color: #991b1b;
}

.action-btn {
    background: none;
    border: none;
    padding: 8px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background-color: #f1f5f9;
    transform: scale(1.1);
}

.view-btn {
    color: #3b82f6;
}

.delete-btn {
    color: #ef4444;
}

/* AÃ§Ä±klama bÃ¶lÃ¼mÃ¼ stilleri */
.description-container {
    position: relative;
}

.edit-btn {
    background: none;
    border: none;
    padding: 4px;
    color: #757575;
    transition: all 0.2s ease;
}

.edit-btn:hover {
    color: var(--primary-blue);
}

.edit-btn i {
    font-size: 20px;
}

.description-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #2c3e50;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 10px;
}

.description-textarea:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.description-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}

#detailDescription {
    margin: 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    min-height: 100px;
}

.action-btn {
    background: none;
    border: none;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.action-btn i {
    font-size: 20px;
}

.view-btn {
    color: #2196F3;
}

.view-btn:hover {
    color: #1976D2;
}

.delete-btn {
    color: #757575;
}

.delete-btn:hover {
    color: #dc3545;
}

/* Masraf ve Belge YÃ¼kle ModallarÄ± - Sade TasarÄ±m */
.modal-content.expense-modal,
.modal-content.upload-modal {
    max-width: 600px;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    border: 1px solid #e2e8f0;
    background: white;
}

/* Sadece alt modallar (expense ve upload) iÃ§in header tasarÄ±mÄ± */
.modal-content.expense-modal .modal-header,
.modal-content.upload-modal .modal-header {
    background: #f8fafc;
    color: #374151;
    padding: 20px 24px;
    border-radius: 8px 8px 0 0;
    border-bottom: 1px solid #e2e8f0;
}

.modal-content.expense-modal .modal-header h2,
.modal-content.upload-modal .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-blue);
}

.modal-content.expense-modal .modal-header .close-btn,
.modal-content.upload-modal .modal-header .close-btn {
    background: none;
    border: none;
    width: 32px;
    height: 32px;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-content.expense-modal .modal-header .close-btn:hover,
.modal-content.upload-modal .modal-header .close-btn:hover {
    background: #f1f5f9;
    color: #374151;
}

.modal-content.expense-modal .modal-body,
.modal-content.upload-modal .modal-body {
    padding: 24px;
    background: white;
}

.modal-content.expense-modal .modal-footer,
.modal-content.upload-modal .modal-footer {
    padding: 16px 24px;
    background: #f8fafc;
    border-radius: 0 0 8px 8px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

/* Sadece alt modallarÄ±n butonlarÄ± iÃ§in sade tasarÄ±m */
.modal-content.expense-modal .modal-footer .btn,
.modal-content.upload-modal .modal-footer .btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    font-size: 14px;
    border: 1px solid;
    cursor: pointer;
    transition: all 0.2s ease;
}

.modal-content.expense-modal .modal-footer .btn.secondary,
.modal-content.upload-modal .modal-footer .btn.secondary {
    background: white;
    color: #6b7280;
    border-color: #d1d5db;
}

.modal-content.expense-modal .modal-footer .btn.secondary:hover,
.modal-content.upload-modal .modal-footer .btn.secondary:hover {
    background: #f9fafb;
    color: #374151;
    border-color: #9ca3af;
}

.modal-content.expense-modal .modal-footer .btn.primary,
.modal-content.upload-modal .modal-footer .btn.primary {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.modal-content.expense-modal .modal-footer .btn.primary:hover,
.modal-content.upload-modal .modal-footer .btn.primary:hover {
    background: #2563eb;
    border-color: #2563eb;
}

.expense-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 24px;
    margin-bottom: 24px;
}

.expense-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-group.full-width {
    grid-column: 1 / -1;
}

.expense-group label,
.detail-group label {
    color: #374151;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 6px;
    display: block;
}

.expense-group input,
.expense-group select,
.expense-group textarea,
.detail-group input,
.detail-group select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s ease;
    background: white;
    font-family: inherit;
}

.expense-group input:focus,
.expense-group select:focus,
.expense-group textarea:focus,
.detail-group input:focus,
.detail-group select:focus {
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    outline: none;
}

.expense-group textarea {
    resize: vertical;
    min-height: 80px;
}

.expense-group input[type="number"]::-webkit-outer-spin-button,
.expense-group input[type="number"]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

.expense-type-wrapper {
    position: relative;
}

#otherExpenseType {
    margin-top: 8px;
    border-color: #facc15 !important;
    background: #fefce8 !important;
}

#otherExpenseType:focus {
    border-color: #eab308 !important;
    box-shadow: 0 0 0 3px rgba(234, 179, 8, 0.1) !important;
}

.amount-wrapper {
    position: relative;
}

.amount-wrapper input {
    padding-right: 32px !important;
}

.currency-symbol {
    position: absolute;
    right: 12px;
    color: #6b7280;
    font-weight: 500;
    font-size: 14px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
}

.status-toggle {
    position: relative;
    display: inline-block;
}

.toggle-input {
    opacity: 0;
    width: 0;
    height: 0;
    position: absolute;
}

.toggle-label {
    display: block;
    width: 120px;
    height: 36px;
    background: #ef4444;
    border-radius: 18px;
    position: relative;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.toggle-input:checked + .toggle-label {
    background: #10b981;
}

.toggle-label::before {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 32px;
    height: 32px;
    background: white;
    border-radius: 50%;
    transition: transform 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.toggle-input:checked + .toggle-label::before {
    transform: translateX(84px);
}

.toggle-text-off,
.toggle-text-on {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    font-weight: 500;
    color: white;
    transition: opacity 0.3s ease;
}

.toggle-text-off {
    right: 8px;
    opacity: 1;
}

.toggle-text-on {
    left: 8px;
    opacity: 0;
}

.toggle-input:checked + .toggle-label .toggle-text-off {
    opacity: 0;
}

.toggle-input:checked + .toggle-label .toggle-text-on {
    opacity: 1;
}

.preview-modal-content {
    width: 95vw;
    height: 95vh;
    max-width: none;
}

.preview-modal-body {
    padding: 0;
    height: calc(95vh - 120px);
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f5f5f5;
}

.document-preview-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
}

.document-preview-container iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.document-preview-container img {
    max-width: none;
    max-height: none;
    object-fit: contain;
}

.expense-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-right: 10px;
}

.status-paid {
    color: #2e7d32;
}

.status-unpaid {
    color: #c62828;
}

.expense-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.expense-actions .btn {
    padding: 4px;
    min-width: auto;
}

.expense-actions .btn i {
    font-size: 18px;
}

.document-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.document-original-name {
    font-size: 0.8rem;
    color: #666;
}

.document-name {
    font-weight: 500;
    color: #2c3e50;
}

.document-date {
    font-size: 0.85rem;
    color: #666;
}

/* Belge YÃ¼kle Modal Ã–zel TasarÄ±mlarÄ± */
.modal-content.upload-modal {
    max-width: 600px;
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.modal-content.upload-modal .modal-header h2::before {
    content: 'ðŸ“Ž';
    font-size: 1.2rem;
}

.detail-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.detail-group label {
    color: #2c3e50;
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.detail-group label::before {
    content: 'â€¢';
    color: #3498db;
    font-weight: bold;
}

.detail-group input,
.detail-group select {
    padding: 12px 16px;
    border: 2px solid #e1e8ed;
    border-radius: 12px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: rgba(255, 255, 255, 0.9);
    font-family: inherit;
}

.detail-group input:focus,
.detail-group select:focus {
    border-color: #3498db;
    box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
    outline: none;
    transform: translateY(-1px);
}

/* Yeni stil eklemeleri */
.detail-section h3 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 16px;
    font-weight: 600;
    border-bottom: 2px solid #3498db;
    padding-bottom: 5px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.detail-section h3 i {
    font-size: 18px;
    color: #3498db;
}

.additional-person {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #3498db;
}

.additional-person h5 {
    margin: 0 0 15px 0;
    color: #2c3e50;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.additional-person h5 i {
    font-size: 16px;
    color: #3498db;
}

.lawyer-display {
    margin-top: 20px;
    padding: 15px;
    background: #fff3cd;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
}

.lawyer-display h4 {
    margin: 0 0 15px 0;
    color: #856404;
    font-size: 14px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
}

.lawyer-display h4 i {
    font-size: 16px;
    color: #ffc107;
}

.info-group.full-width {
    grid-column: span 4;
}

.detail-group input[type="file"] {
    border: 2px dashed #bdc3c7;
    background: rgba(236, 240, 241, 0.3);
    padding: 16px;
    text-align: center;
    cursor: pointer;
    position: relative;
}

.detail-group input[type="file"]:hover {
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.05);
}

.detail-group input[type="file"]:focus {
    border-style: solid;
    border-color: #3498db;
    background: rgba(52, 152, 219, 0.05);
}

/* Responsive Design Ä°yileÅŸtirmeleri */
@media (max-width: 768px) {
    .expense-grid {
        grid-template-columns: 1fr;
        gap: 16px;
    }
    
    .modal-content.expense-modal {
        max-width: 95vw;
        margin: 10px;
        border-radius: 12px;
    }
    
    .modal-header {
        padding: 16px 20px;
    }
    
    .modal-body {
        padding: 20px;
    }
    
    .modal-footer {
        padding: 16px 20px;
        flex-direction: column;
    }
    
    .modal-footer .btn {
        width: 100%;
        min-width: auto;
    }
}

/* Ä°ÅŸlem butonlarÄ± iÃ§in stil gÃ¼ncellemesi */
.actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    border: none;
    background: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* AyÄ±rÄ±cÄ± Ã§izgiyi kaldÄ±r */
.actions span {
    display: none;
}

/* DuruÅŸma tÃ¼rÃ¼ iÃ§in ek stil */
.hearing-type-group .radio-group {
    display: flex;
    gap: 15px;
    align-items: center;
    padding-top: 5px; /* Ãœstteki label ile hizalamak iÃ§in */
}

.hearing-type-group .radio-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.95rem;
    font-weight: normal; /* Label'Ä± bold yapma */
    cursor: pointer;
    margin-bottom: 0; /* Alt boÅŸluÄŸu kaldÄ±r */
}

.hearing-type-group .radio-group input[type="radio"] {
    width: auto; /* TarayÄ±cÄ± varsayÄ±lanÄ±nÄ± kullan */
    height: auto;
    margin-right: 3px;
    cursor: pointer;
}

/* DuruÅŸma tÃ¼rÃ¼ iÃ§in ek stil */
+.btn-outline-primary {
+    color: #1a237e;
+    border-color: #1a237e;
+}
+.btn-outline-primary:hover {
+    background-color: #1a237e;
+    color: white;
+}
+.btn-outline-danger {
+    color: #dc3545;
+    border-color: #dc3545;
+}
+.btn-outline-danger:hover {
+    background-color: #dc3545;
+    color: white;
+}
+.btn-sm {
+    padding: 5px 10px;
+    font-size: 0.8rem;
+}
+.btn-sm i {
+    font-size: 16px; /* Ä°kon boyutunu kÃ¼Ã§Ã¼lt */
+    margin-right: 4px;
+}
</style>

<!-- TIFF ve DOCX Ã–nizleme KÃ¼tÃ¼phaneleri -->
<script src="https://cdn.jsdelivr.net/npm/tiff.js/tiff.min.js"></script>
{# <script src="https://cdn.jsdelivr.net/npm/docx-preview@0.1.20/dist/docx-preview.min.js"></script> #}

<script>
// CSRF Token
const csrfToken = document.querySelector('input[name="csrf_token"]').value;

// Ã–rnek Masraf TÃ¼rleri (BunlarÄ± kendi tÃ¼rlerinizle deÄŸiÅŸtirin)
const expenseTypes = [
    "Dava HarcÄ±", "Vekalet Ãœcreti", "Posta Gideri", "Yol Gideri",
    "BilirkiÅŸi Ãœcreti", "Tebligat Gideri", "KeÅŸif HarcÄ±", "DiÄŸer"
];

// Ã–rnek Belge TÃ¼rleri (BunlarÄ± kendi tÃ¼rlerinizle deÄŸiÅŸtirin)
const documentTypes = [
    "DilekÃ§e", "Vekaletname", "Fatura", "Makbuz", "Karar",
    "Tutanak", "Ä°htarname", "SÃ¶zleÅŸme", "Delil", "DiÄŸer"
];

let currentCaseId = null;
let currentExpenses = [];

// Backend'den gelen tÃ¼m adliye verisi
const allCourthousesData = JSON.parse('{{ all_courthouses | safe }}');

// Orijinal Birim seÃ§enekleri
const originalDepartments = [
    'Asliye Hukuk Mahkemesi', 'Sulh Hukuk Mahkemesi', 'Ä°ÅŸ Mahkemesi', 
    'Aile Mahkemesi', 'Ticaret Mahkemesi', 'Ä°cra Hukuk Mahkemesi', 
    'TÃ¼ketici Mahkemesi', 'Fikri ve SÄ±nai Haklar Mahkemesi',
    'Asliye Ceza Mahkemesi', 'AÄŸÄ±r Ceza Mahkemesi', 'Sulh Ceza HakimliÄŸi', 
    'Ä°cra Dairesi'
];

// Ä°stanbul'a Ã¶zel adliyeler
const istanbulSpecificCourthouses = [
    "Ä°stanbul Anadolu Adliyesi (Kartal)",
    "Ä°stanbul Adliyesi (Ã‡aÄŸlayan)",
    "BakÄ±rkÃ¶y Adliyesi",
    "BÃ¼yÃ¼kÃ§ekmece Adliyesi",
    "GaziosmanpaÅŸa Adliyesi",
    "KÃ¼Ã§Ã¼kÃ§ekmece Adliyesi",
    "Silivri Adliyesi",
    "Ã‡atalca Adliyesi",
    "ÃœskÃ¼dar Adliyesi",
    "Adalar Adliyesi",
    "SarÄ±yer Adliyesi"
];

// Hata mesajÄ± gÃ¶sterme iÅŸlevi 
function showError(message) {
    Swal.fire({
        icon: 'error',
        title: 'Hata OluÅŸtu',
        text: message,
        confirmButtonText: 'Tamam'
    });
}

// docx-preview kÃ¼tÃ¼phanesinin varlÄ±ÄŸÄ±nÄ± kontrol etme fonksiyonu kaldÄ±rÄ±ldÄ±/yorumlandÄ±.
{# function checkDocxPreviewAvailability() {
    if (typeof window.docx === 'undefined') {
        console.error('docx-preview kÃ¼tÃ¼phanesi bulunamadÄ±');
        return false;
    }
    return true;
} #}

document.addEventListener('DOMContentLoaded', function() {
    // Sayfa yÃ¼klendiÄŸinde baÅŸlangÄ±Ã§ durumunu ayarla
    populateDepartments();
    handleFileTypeChange();
    
    // EÄŸer ÅŸehir seÃ§iliyse adliye listesini gÃ¼ncelle
    const citySelect = document.getElementById('city');
    if (citySelect && citySelect.value) {
        updateCourthouses();
    }
    
    // URL'den show_details parametresini al
    const urlParams = new URLSearchParams(window.location.search);
    const showDetailsId = urlParams.get('show_details');
    
    // EÄŸer show_details parametresi varsa, dosya detaylarÄ±nÄ± gÃ¶ster
    if (showDetailsId) {
        showDetails(showDetailsId);
    }
    
    // Modal dÄ±ÅŸÄ±na tÄ±klama event handler'Ä±
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('fileDetailModal');
        if (modal && modal.style.display === 'flex' && event.target === modal) {
            closeDetailModal();
        }
    });
    
    // ESC tuÅŸu ile modal kapatma
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            const modal = document.getElementById('fileDetailModal');
            if (modal && modal.style.display === 'flex') {
                closeDetailModal();
            }
        }
    });
});

function updateCourthouses() {
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    
    // Adliye listesini temizle, "TÃ¼mÃ¼" seÃ§eneÄŸini koru
    courthouseSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    
    // EÄŸer Ä°stanbul seÃ§iliyse, Ã¶zel Ä°stanbul adliyelerini ekle
    if (selectedCity === 'Ä°stanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
    
    // SeÃ§ili ÅŸehir iÃ§in adliyeleri ekle (eÄŸer Ä°stanbul deÄŸilse veya Ä°stanbul'a ek adliyeler varsa)
    if (selectedCity && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
}

function handleFileTypeChange() {
    const fileTypeSelect = document.getElementById('file-type');
    const selectedFileType = fileTypeSelect.value.toLowerCase();
    
    // Mahkeme listesini temizle ve yeniden doldur
    populateDepartments(selectedFileType);
    
    // Dosya tÃ¼rlerine gÃ¶re alanlarÄ± devre dÄ±ÅŸÄ± bÄ±rak/etkinleÅŸtir
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const departmentSelect = document.getElementById('department');
    const courtNumberContainer = document.getElementById('court-number-container');
    
    // "TÃ¼mÃ¼" seÃ§eneÄŸi iÃ§in hepsini etkinleÅŸtir
    if (!selectedFileType) {
        citySelect.disabled = false;
        courthouseSelect.disabled = false;
        departmentSelect.disabled = false;
        return;
    }
    
    // ARABULUCULUK, AÄ°HM ve AYM iÃ§in ÅŸehir ve adliye devre dÄ±ÅŸÄ±
    const disableCourthouseAndCity = ['arabuluculuk', 'aihm', 'aym'].includes(selectedFileType) || 
                                    ['ARABULUCULUK', 'AÄ°HM', 'AYM'].includes(fileTypeSelect.value);
    // SavcÄ±lÄ±k iÃ§in sadece mahkeme devre dÄ±ÅŸÄ±
    const disableDepartment = ['arabuluculuk', 'aihm', 'aym', 'savcilik'].includes(selectedFileType) ||
                             ['ARABULUCULUK', 'AÄ°HM', 'AYM', 'savcilik'].includes(fileTypeSelect.value);
    
    citySelect.disabled = disableCourthouseAndCity;
    courthouseSelect.disabled = disableCourthouseAndCity;
    departmentSelect.disabled = disableDepartment;
    
    // Alanlar devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ysa, deÄŸerlerini temizle
    if (disableCourthouseAndCity) {
        citySelect.value = '';
        courthouseSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    }
    
    if (disableDepartment) {
        departmentSelect.value = '';
        courtNumberContainer.style.display = 'none';
    }
    
    // Åžehir seÃ§iliyse adliye listesini gÃ¼ncelle
    if (!disableCourthouseAndCity && citySelect.value) {
        updateCourthouses();
    }
    
    // Birim seÃ§imi deÄŸiÅŸtiyse mahkeme numaralarÄ±nÄ± gÃ¼ncelle
    if (departmentSelect.value) {
        if (selectedFileType === 'icra' && departmentSelect.value === 'Ä°cra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(departmentSelect.value);
        }
    } else {
        courtNumberContainer.style.display = 'none';
    }
}

function populateDepartments(fileType) {
    const departmentSelect = document.getElementById('department');
    
    // Listeyi temizle, "TÃ¼mÃ¼" seÃ§eneÄŸini koru
    departmentSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    
    // Dosya tÃ¼rÃ¼ne gÃ¶re mahkemeleri ekle
    if (fileType === 'hukuk') {
        // Hukuk mahkemeleri
        const hukukMahkemeleri = [
            'Asliye Hukuk Mahkemesi',
            'Sulh Hukuk Mahkemesi',
            'Ä°ÅŸ Mahkemesi',
            'Aile Mahkemesi',
            'Ticaret Mahkemesi',
            'Ä°cra Hukuk Mahkemesi',
            'TÃ¼ketici Mahkemesi',
            'Fikri ve SÄ±nai Haklar Mahkemesi'
        ];
        
        hukukMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'ceza') {
        // Ceza mahkemeleri
        const cezaMahkemeleri = [
            'Asliye Ceza Mahkemesi',
            'AÄŸÄ±r Ceza Mahkemesi',
            'Sulh Ceza HakimliÄŸi'
        ];
        
        cezaMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'icra') {
        // Ä°cra Dairesi
        const option = document.createElement('option');
        option.value = 'Ä°cra Dairesi';
        option.textContent = 'Ä°cra Dairesi';
        departmentSelect.appendChild(option);
        
        // Ä°cra Dairesi seÃ§ilirse numaralandÄ±rma deÄŸiÅŸir
        departmentSelect.onchange = function() {
            if (this.value === 'Ä°cra Dairesi') {
                updateIcraDaireleri();
            } else {
                document.getElementById('court-number-container').style.display = 'none';
            }
        };
    } else if (!fileType || fileType === '') {
        // HiÃ§bir filtre seÃ§ilmediÄŸinde tÃ¼m mahkemeleri gÃ¶ster
        originalDepartments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            departmentSelect.appendChild(option);
        });
    }
    
    // Mahkeme seÃ§ildiÄŸinde numaralÄ± mahkemeyi gÃ¼ncelle
    departmentSelect.onchange = function() {
        const fileType = document.getElementById('file-type').value.toLowerCase();
        if (fileType === 'icra' && this.value === 'Ä°cra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(this.value);
        }
    };
}

// Ä°cra dairelerini gÃ¼ncelle (1-30 arasÄ±)
function updateIcraDaireleri() {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // Ä°cra daireleri listesini temizle
    courtNumberSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    
    // Ä°cra dairelerini ekle (1-30)
    for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = `${i}. Ä°cra Dairesi`;
        option.textContent = `${i}. Ä°cra Dairesi`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

function updateCourtNumbers(department) {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // Mahkeme numaralarÄ±nÄ± temizle
    courtNumberSelect.innerHTML = '<option value="">TÃ¼mÃ¼</option>';
    
    // Ä°cra Dairesi zaten numaralÄ± olduÄŸu iÃ§in dÄ±ÅŸarÄ±da bÄ±rak
    if (!department || department === '' || department.includes('Ä°cra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }
    
    // Adliye ve ÅŸehre gÃ¶re mahkeme sayÄ±sÄ±nÄ± belirle
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    const selectedCourthouse = courthouseSelect.value;
    
    // VarsayÄ±lan olarak her mahkemeden 30 tane
    let maxCourtNumber = 30;
    
    // Ä°stanbul ve belirli adliyeler iÃ§in daha fazla mahkeme
    if (selectedCity === 'Ä°stanbul') {
        if (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Ã‡aÄŸlayan')) {
            if (department === 'Asliye Hukuk Mahkemesi' || 
                department === 'Asliye Ceza Mahkemesi' || 
                department === 'Ä°ÅŸ Mahkemesi') {
                maxCourtNumber = 50;
            } else if (department === 'AÄŸÄ±r Ceza Mahkemesi') {
                maxCourtNumber = 15;
            }
        } else if (selectedCourthouse.includes('BakÄ±rkÃ¶y')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'Ä°zmir') {
        maxCourtNumber = 40;
    }
    
    // Birim adÄ±nÄ± ekle
    const baseOption = document.createElement('option');
    baseOption.value = department;
    baseOption.textContent = department;
    courtNumberSelect.appendChild(baseOption);
    
    // NumaralÄ± mahkemeleri ekle
    for (let i = 1; i <= maxCourtNumber; i++) {
        const option = document.createElement('option');
        option.value = `${i}. ${department}`;
        option.textContent = `${i}. ${department}`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

// DiÄŸer fonksiyonlar...

function showDetails(caseId) {
    currentCaseId = caseId;
    const modal = document.getElementById('fileDetailModal');
    
    fetch(`/case_details/${caseId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Sunucu yanÄ±tÄ±:', data);
                alert('Dosya detaylarÄ± yÃ¼klenirken bir hata oluÅŸtu.');
                return;
            }

            // Temel bilgileri doldur
            document.getElementById('detailFileType').textContent = capitalizeFileType(data.file_type);
            
            // Dosya tÃ¼rÃ¼ne gÃ¶re adliye ve mahkeme bilgilerini gÃ¶ster/gizle
            const fileType = data.file_type;
            const shouldShowCourthouse = !['AÄ°HM', 'AYM', 'ARABULUCULUK'].includes(fileType);
            const shouldShowDepartment = !['AÄ°HM', 'AYM', 'ARABULUCULUK', 'savcilik'].includes(fileType);
            
            document.getElementById('detailCourthouse').textContent = shouldShowCourthouse ? (data.courthouse || '') : '';
            document.getElementById('detailDepartment').textContent = shouldShowDepartment ? (data.department || '') : '';
            document.getElementById('detailYear').textContent = data.year || '-';
            document.getElementById('detailCaseNumber').textContent = data.case_number || '-';
            document.getElementById('detailCity').textContent = data.city || '-';
            
            // MÃ¼vekkil Bilgileri
            document.getElementById('detailClientEntityType').textContent = 
                data.client_entity_type === 'company' ? 'Åžirket' : 'GerÃ§ek KiÅŸi';
            document.getElementById('detailClientName').textContent = data.client_name || '-';
            document.getElementById('detailClientCapacity').textContent = data.client_capacity || '-';
            document.getElementById('detailClientIdentityNumber').textContent = data.client_identity_number || '-';
            document.getElementById('detailPhoneNumber').textContent = data.phone_number || '-';
            document.getElementById('detailClientAddress').textContent = data.client_address || '-';
            
            // KarÅŸÄ± Taraf Bilgileri
            document.getElementById('detailOpponentEntityType').textContent = 
                data.opponent_entity_type === 'company' ? 'Åžirket' : 'GerÃ§ek KiÅŸi';
            document.getElementById('detailOpponentName').textContent = data.opponent_name || '-';
            document.getElementById('detailOpponentCapacity').textContent = data.opponent_capacity || '-';
            document.getElementById('detailOpponentIdentityNumber').textContent = data.opponent_identity_number || '-';
            document.getElementById('detailOpponentPhone').textContent = data.opponent_phone || '-';
            document.getElementById('detailOpponentAddress').textContent = data.opponent_address || '-';
            
            // Vekil bilgileri kontrolÃ¼ ve gÃ¶sterimi
            const opponentLawyerDisplay = document.getElementById('opponentLawyerDisplay');
            if (data.opponent_lawyer || data.opponent_lawyer_phone || data.opponent_lawyer_address) {
                document.getElementById('detailOpponentLawyer').textContent = data.opponent_lawyer || '-';
                document.getElementById('detailOpponentLawyerPhone').textContent = data.opponent_lawyer_phone || '-';
                document.getElementById('detailOpponentLawyerAddress').textContent = data.opponent_lawyer_address || '-';
                opponentLawyerDisplay.style.display = 'block';
            } else {
                opponentLawyerDisplay.style.display = 'none';
            }
            
            // Ek MÃ¼vekkilleri gÃ¶ster
            const additionalClientsDisplay = document.getElementById('additionalClientsDisplay');
            additionalClientsDisplay.innerHTML = '';
            if (data.additional_clients && data.additional_clients.length > 0) {
                data.additional_clients.forEach((client, index) => {
                    const clientDiv = document.createElement('div');
                    clientDiv.className = 'additional-person';
                    clientDiv.innerHTML = `
                        <h5><i class="material-icons">person_add</i> Ek MÃ¼vekkil ${index + 1}</h5>
                        <div class="info-row">
                            <div class="info-group">
                                <label>TÄ°P</label>
                                <span>${client.entity_type === 'company' ? 'Åžirket' : 'GerÃ§ek KiÅŸi'}</span>
                            </div>
                            <div class="info-group">
                                <label>AD SOYAD / UNVAN</label>
                                <span>${client.name || '-'}</span>
                            </div>
                            <div class="info-group">
                                <label>SIFAT</label>
                                <span>${client.capacity || '-'}</span>
                            </div>
                            <div class="info-group">
                                <label>KÄ°MLÄ°K / VERGÄ° NO</label>
                                <span>${client.identity_number || '-'}</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>TELEFON</label>
                                <span>${client.phone || '-'}</span>
                            </div>
                            <div class="info-group full-width">
                                <label>ADRES</label>
                                <span>${client.address || '-'}</span>
                            </div>
                        </div>
                    `;
                    additionalClientsDisplay.appendChild(clientDiv);
                });
            }
            
            // Ek KarÅŸÄ± TaraflarÄ± gÃ¶ster
            const additionalOpponentsDisplay = document.getElementById('additionalOpponentsDisplay');
            additionalOpponentsDisplay.innerHTML = '';
            if (data.additional_opponents && data.additional_opponents.length > 0) {
                data.additional_opponents.forEach((opponent, index) => {
                    const opponentDiv = document.createElement('div');
                    opponentDiv.className = 'additional-person';
                    opponentDiv.innerHTML = `
                        <h5><i class="material-icons">group_add</i> Ek KarÅŸÄ± Taraf ${index + 1}</h5>
                        <div class="info-row">
                            <div class="info-group">
                                <label>TÄ°P</label>
                                <span>${opponent.entity_type === 'company' ? 'Åžirket' : 'GerÃ§ek KiÅŸi'}</span>
                            </div>
                            <div class="info-group">
                                <label>AD SOYAD / UNVAN</label>
                                <span>${opponent.name || '-'}</span>
                            </div>
                            <div class="info-group">
                                <label>SIFAT</label>
                                <span>${opponent.capacity || '-'}</span>
                            </div>
                            <div class="info-group">
                                <label>KÄ°MLÄ°K / VERGÄ° NO</label>
                                <span>${opponent.identity_number || '-'}</span>
                            </div>
                        </div>
                        <div class="info-row">
                            <div class="info-group">
                                <label>TELEFON</label>
                                <span>${opponent.phone || '-'}</span>
                            </div>
                            <div class="info-group full-width">
                                <label>ADRES</label>
                                <span>${opponent.address || '-'}</span>
                            </div>
                        </div>
                    `;
                    additionalOpponentsDisplay.appendChild(opponentDiv);
                });
            }
            
            // Durum bilgisini doldur
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = data.status || 'Aktif';
            statusElement.className = 'file-status ' + (data.status === 'Aktif' ? 'active' : 'closed');
            
            // Tarih bilgilerini doldur
            document.getElementById('detailOpenDate').textContent = data.open_date || '-';
            
            // DuruÅŸma bilgilerini sadece duruÅŸma varsa gÃ¶ster, yoksa gizle veya "-" gÃ¶ster
            if (data.next_hearing) {
            document.getElementById('detailNextHearing').textContent = data.next_hearing || '-';
            document.getElementById('detailHearingTime').textContent = data.hearing_time || '-';
                document.getElementById('detailHearingType').textContent = data.formatted_hearing_type || 'DuruÅŸma';
                // DuruÅŸma separatÃ¶rleri gÃ¶rÃ¼nÃ¼r yap
                const separators = document.querySelectorAll('.hearing-separator');
                separators.forEach(sep => sep.style.display = 'inline');
            } else {
                document.getElementById('detailNextHearing').textContent = '-';
                document.getElementById('detailHearingTime').textContent = '';
                document.getElementById('detailHearingType').textContent = '';
                // DuruÅŸma separatÃ¶rleri gizle
                const separators = document.querySelectorAll('.hearing-separator');
                separators.forEach(sep => sep.style.display = 'none');
            }
            
            document.getElementById('detailDescription').textContent = data.description || 'AÃ§Ä±klama bulunmuyor.';

            // MasraflarÄ± gÃ¶ster
            if (data.expenses && Array.isArray(data.expenses)) {
                currentExpenses = data.expenses;
                const expensesList = document.getElementById('editExpensesList');
                expensesList.innerHTML = data.expenses.map(expense => `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-type">${expense.expense_type}</div>
                            <div class="expense-amount">â‚º${expense.amount}</div>
                            <div class="expense-date">${expense.date}</div>
                            <div class="expense-description">${expense.description || ''}</div>
                        </div>
                        <div class="expense-actions">
                            <div class="expense-status ${expense.is_paid ? 'status-paid' : 'status-unpaid'}">
                                ${expense.is_paid ? 'Ã–dendi' : 'Ã–denmedi'}
                            </div>
                            <button type="button" class="btn small" onclick="editExpense(${expense.id})">
                                <i class="material-icons">edit</i>
                            </button>
                            <button type="button" class="btn small danger" onclick="deleteExpense(${expense.id})">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </div>
                `).join('') || '<p>HenÃ¼z masraf kaydÄ± bulunmuyor.</p>';
            }

            // Belgeleri gÃ¶ster
            const documentsList = document.getElementById('documentsList');
            if (documentsList && data.documents) {
                documentsList.innerHTML = data.documents.map(doc => {
                    // Dosya adÄ± ve uzantÄ±yÄ± ayÄ±r
                    const fileNameParts = doc.filename ? doc.filename.split('.') : ['', ''];
                    const fileName = fileNameParts.slice(0, -1).join('.');
                    const fileExt = fileNameParts[fileNameParts.length - 1];
                    
                    // Orijinal dosya adÄ±nÄ± al
                    const originalName = doc.filepath ? doc.filepath.split('_').slice(2).join('_') : '';
                    
                    return `
                        <div class="document-item">
                            <div class="document-type-header">
                                ${doc.document_type}
                            </div>
                            <div class="document-content">
                                <div class="document-main">
                                    <div class="document-info">
                                        <i class="material-icons">${getFileIcon(doc.filename || '')}</i>
                                        <div class="document-details">
                                            <span class="document-name">${fileName}</span>
                                            <span class="document-original-name">${originalName}</span>
                                            <span class="document-date">${doc.upload_date}</span>
                                        </div>
                                    </div>
                                    <div class="document-actions">
                                        <button class="btn small" onclick="previewDocument(${doc.id}, '${doc.filename || ''}')" title="Ã–nizle">
                                            <i class="material-icons">visibility</i>
                                        </button>
                                        <button class="btn small" onclick="downloadDocument(${doc.id})" title="Ä°ndir">
                                            <i class="material-icons">download</i>
                                        </button>
                                        <button class="btn danger small" onclick="deleteDocument(${doc.id})" title="Sil">
                                            <i class="material-icons">delete</i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') || '<p>HenÃ¼z belge yÃ¼klenmemiÅŸ.</p>';
            }

            // ModalÄ± gÃ¶ster
            modal.style.display = 'flex';
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Dosya detaylarÄ± yÃ¼klenirken bir hata oluÅŸtu: ' + error.message);
        });
}

// Dosya tÃ¼rÃ¼nÃ¼ bÃ¼yÃ¼k harfe Ã§evir
function capitalizeFileType(fileType) {
    return fileType.charAt(0).toUpperCase() + fileType.slice(1);
}

// Dosya uzantÄ±sÄ±na gÃ¶re ikon seÃ§
function getFileIcon(filename) {
    if (!filename) return 'insert_drive_file';
    
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'picture_as_pdf';
        case 'doc':
        case 'docx': return 'description';
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'tiff':
        case 'tif': return 'image';
        case 'txt': return 'article';
        case 'xls':
        case 'xlsx': return 'table_chart';
        case 'zip':
        case 'rar': return 'folder_zip';
        default: return 'insert_drive_file';
    }
}

// Modal kapatma fonksiyonu
function closeDetailModal() {
    const modal = document.getElementById('fileDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // URL'deki show_details parametresini temizle
    const url = new URL(window.location);
    url.searchParams.delete('show_details');
    
    // URL'yi gÃ¼ncelle (sayfa yeniden yÃ¼klenmeden)
    window.history.replaceState({}, '', url);
}

// DÃ¼zenle butonu iÃ§in fonksiyon
function editCase(caseId) {
    const modal = document.getElementById('fileDetailModal');
    modal.style.display = 'none';
    
    fetch(`/case_details/${caseId}`)
        .then(response => {
            if (response.status === 403) {
                alert('Bu iÅŸlemi yapmak iÃ§in gerekli yetkiye sahip deÄŸilsiniz. Dosya dÃ¼zenleme yetkisi gereklidir.');
                modal.style.display = 'flex'; // ModalÄ± tekrar gÃ¶ster
                return Promise.reject(new Error('Yetki hatasÄ±'));
            }
            
            if (!response.ok) {
                throw new Error('Sunucu hatasÄ±');
            }
            return response.json();
        })
        .then(data => {
            // Devam eden kod
            // Tarihi YYYY-MM-DD formatÄ±na Ã§evir
            const openDate = data.open_date ? data.open_date.split('.').reverse().join('-') : '';
            const nextHearing = data.next_hearing ? data.next_hearing.split('.').reverse().join('-') : '';

            // Åžehir ve adliye bilgilerini belirle
            let city = '';
            if (data.courthouse) {
                if (istanbulSpecificCourthouses.includes(data.courthouse)) {
                    city = 'Ä°stanbul';
                } else {
                    for (const [cityName, courthouses] of Object.entries(allCourthousesData)) {
                        if (courthouses.includes(data.courthouse)) {
                            city = cityName;
                            break;
                        }
                    }
                }
            }

            const editHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Dosya DÃ¼zenle</h2>
                        <button class="close-btn" onclick="closeEditModal()">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Dosya TÃ¼rÃ¼</label>
                                    <select id="editFileType" onchange="populateEditDepartments(this.value, document.getElementById('editDepartment'), null, document.getElementById('editCourthouse').value);">
                                        <option value="hukuk" ${data.file_type === 'hukuk' ? 'selected' : ''}>Hukuk</option>
                                        <option value="ceza" ${data.file_type === 'ceza' ? 'selected' : ''}>Ceza</option>
                                        <option value="icra" ${data.file_type === 'icra' ? 'selected' : ''}>Ä°cra</option>
                                        <option value="savcilik" ${data.file_type === 'savcilik' ? 'selected' : ''}>SavcÄ±lÄ±k</option>
                                        <option value="ARABULUCULUK" ${data.file_type === 'ARABULUCULUK' ? 'selected' : ''}>Arabuluculuk</option>
                                        <option value="AÄ°HM" ${data.file_type === 'AÄ°HM' ? 'selected' : ''}>AÄ°HM</option>
                                        <option value="AYM" ${data.file_type === 'AYM' ? 'selected' : ''}>AYM</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Åžehir</label>
                                    <select id="editCity" onchange="updateEditCourthouses(); populateEditDepartments(document.getElementById('editFileType').value, document.getElementById('editDepartment'), null, document.getElementById('editCourthouse').value);" ${['ARABULUCULUK', 'AÄ°HM', 'AYM'].includes(data.file_type) ? 'disabled' : ''}>
                                        <option value="">SeÃ§iniz</option>
                                        ${Object.keys(allCourthousesData).map(cityName => 
                                            `<option value="${cityName}" ${city === cityName ? 'selected' : ''}>${cityName}</option>`
                                        ).join('')}
                                        <option value="Ä°stanbul" ${city === 'Ä°stanbul' ? 'selected' : ''}>Ä°stanbul</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Adliye</label>
                                    <select id="editCourthouse" onchange="populateEditDepartments(document.getElementById('editFileType').value, document.getElementById('editDepartment'), null, this.value);" ${['ARABULUCULUK', 'AÄ°HM', 'AYM'].includes(data.file_type) ? 'disabled' : ''}>
                                        <option value="">SeÃ§iniz</option>
                                        ${city === 'Ä°stanbul' ? 
                                            istanbulSpecificCourthouses.map(courthouse => 
                                                `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                            ).join('') : 
                                            (city && allCourthousesData[city] ? 
                                                allCourthousesData[city].map(courthouse => 
                                                    `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                                ).join('') : '')
                                        }
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Mahkeme</label>
                                    <select id="editDepartment" ${['ARABULUCULUK', 'AÄ°HM', 'AYM', 'savcilik'].includes(data.file_type) ? 'disabled' : ''} onchange="updateEditNumberedDepartments(this.value, document.getElementById('editCity').value, document.getElementById('editCourthouse').value)">
                                        <option value="">SeÃ§iniz</option>
                                    </select>
                                </div>
                                <div class="detail-group" id="editNumberedDepartmentContainer" style="display: none;">
                                    <label>NumaralÄ± Mahkeme</label>
                                    <select id="editNumberedDepartment">
                                        <option value="">SeÃ§iniz</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Bilgiler Container -->
                            <div class="edit-info-container">
                                <!-- MÃ¼vekkil Bilgileri -->
                                <div class="edit-section">
                                    <h3><i class="material-icons">person</i> MÃ¼vekkil Bilgileri</h3>
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Tip</label>
                                            <select id="editClientEntityType">
                                                <option value="person" ${(data.client_entity_type || 'person') === 'person' ? 'selected' : ''}>GerÃ§ek KiÅŸi</option>
                                                <option value="company" ${data.client_entity_type === 'company' ? 'selected' : ''}>Åžirket</option>
                                            </select>
                                        </div>
                                        <div class="detail-group">
                                            <label>SÄ±fat</label>
                                            <input type="text" id="editClientCapacity" value="${data.client_capacity || ''}" placeholder="MÃ¼vekkil, DavacÄ±, DavalÄ± vs.">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group full-width">
                                            <label>Ad Soyad / Unvan</label>
                                            <input type="text" id="editClientName" value="${data.client_name || ''}">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group full-width">
                                            <label>Kimlik / Vergi No</label>
                                            <input type="text" id="editClientIdentityNumber" value="${data.client_identity_number || ''}">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Telefon</label>
                                            <input type="text" id="editPhoneNumber" value="${data.phone_number || ''}">
                                        </div>
                                        <div class="detail-group">
                                            <label>Adres</label>
                                            <textarea id="editClientAddress" rows="2">${data.client_address || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- KarÅŸÄ± Taraf Bilgileri -->
                                <div class="edit-section">
                                    <h3><i class="material-icons">group</i> KarÅŸÄ± Taraf Bilgileri</h3>
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Tip</label>
                                            <select id="editOpponentEntityType">
                                                <option value="person" ${(data.opponent_entity_type || 'person') === 'person' ? 'selected' : ''}>GerÃ§ek KiÅŸi</option>
                                                <option value="company" ${data.opponent_entity_type === 'company' ? 'selected' : ''}>Åžirket</option>
                                            </select>
                                        </div>
                                        <div class="detail-group">
                                            <label>SÄ±fat</label>
                                            <input type="text" id="editOpponentCapacity" value="${data.opponent_capacity || ''}" placeholder="DavalÄ±, DavacÄ± vs.">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group full-width">
                                            <label>Ad Soyad / Unvan</label>
                                            <input type="text" id="editOpponentName" value="${data.opponent_name || ''}">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group full-width">
                                            <label>Kimlik / Vergi No</label>
                                            <input type="text" id="editOpponentIdentityNumber" value="${data.opponent_identity_number || ''}">
                                        </div>
                                    </div>
                                    <div class="detail-grid">
                                        <div class="detail-group">
                                            <label>Telefon</label>
                                            <input type="text" id="editOpponentPhone" value="${data.opponent_phone || ''}">
                                        </div>
                                        <div class="detail-group">
                                            <label>Adres</label>
                                            <textarea id="editOpponentAddress" rows="2">${data.opponent_address || ''}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vekil Bilgileri -->
                            <div class="detail-grid" id="editLawyerSection" style="margin-top: 15px;">
                                <div class="detail-group" style="grid-column: span 4;">
                                    <label style="font-weight: 600; color: #856404;">
                                        <i class="material-icons" style="vertical-align: middle; margin-right: 5px;">account_balance</i>
                                        Vekil Bilgileri (Opsiyonel)
                                    </label>
                                </div>
                                <div class="detail-group">
                                    <label>Vekil AdÄ± SoyadÄ±</label>
                                    <input type="text" id="editOpponentLawyer" value="${data.opponent_lawyer || ''}">
                                </div>
                                <div class="detail-group">
                                    <label>Vekil Telefonu</label>
                                    <input type="text" id="editOpponentLawyerPhone" value="${data.opponent_lawyer_phone || ''}">
                                </div>
                                <div class="detail-group full-width" style="grid-column: span 2;">
                                    <label>Vekil Adresi</label>
                                    <textarea id="editOpponentLawyerAddress" rows="2">${data.opponent_lawyer_address || ''}</textarea>
                                </div>
                            </div>
                            
                            <!-- Dosya Bilgileri -->
                            <h3><i class="material-icons">folder</i> Dosya Bilgileri</h3>
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Dosya Durumu</label>
                                    <select id="editStatus">
                                        <option value="Aktif" ${data.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                        <option value="KapalÄ±" ${data.status === 'KapalÄ±' ? 'selected' : ''}>KapalÄ±</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>AÃ§Ä±lÄ±ÅŸ Tarihi</label>
                                    <input type="date" id="editOpenDate" value="${openDate}" disabled>
                                </div>
                            </div>
                             <!-- DuruÅŸma Bilgileri BaÅŸlÄ±ÄŸÄ± -->
                            <div class="detail-grid" style="padding-bottom:0; margin-bottom:0; border:none; background: none; box-shadow: none;"> {# KenarlÄ±k ve arkaplanÄ± kaldÄ±rarak gÃ¶rÃ¼nmez yap #}
                                 <div class="detail-group" style="grid-column: span 4;">
                                     <label id="hearingInfoLabel" style="margin-bottom:0; ${data.next_hearing ? 'display:none;' : ''}">DURUÅžMA BÄ°LGÄ°LERÄ°</label>
                                     <button type="button" class="btn btn-outline-primary btn-sm" id="showHearingInputBtn" style="${data.next_hearing ? 'display:none;' : 'display:flex; width: fit-content;'} margin-top:10px;">
                                        <i class="material-icons">add</i> DuruÅŸma Ekle/GÃ¼ncelle
                                    </button>
                                </div>
                            </div>
                            <!-- Gizli DuruÅŸma GiriÅŸ AlanÄ± -->
                            <div class="detail-grid" id="editHearingSection" style="${data.next_hearing ? '' : 'display: none;'} border-top: 1px solid #e9ecef; padding-top: 15px; margin-top: -15px;"> {# Ãœstteki boÅŸluÄŸu azaltmak iÃ§in margin-top ayarÄ± #}
                                <div class="detail-group" style="grid-column: span 3;"> {# Buton iÃ§in yer aÃ§mak amacÄ±yla 3 sÃ¼tun kaplasÄ±n #}
                                    <label>Sonraki DuruÅŸma Tarihi</label>
                                    <div class="hearing-datetime" style="display: flex; align-items: center; gap: 10px;">
                                        <input type="date" id="editNextHearing" value="${nextHearing}" style="flex-grow: 1; width: auto; min-width: 120px; max-width:150px;">
                                        <input type="time" id="editHearingTime" value="${data.hearing_time || '09:00'}" style="flex-shrink: 0; width: auto; max-width: 100px; padding: 8px 10px;"> {# Max-width ekledim #}
                                    </div>
                                    <div class="hearing-type-inline" style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="editHearingType" id="editHearingTypeDurusma" value="durusma" ${data.hearing_type === 'durusma' || !data.hearing_type ? 'checked' : ''}>
                                            <label for="editHearingTypeDurusma" style="margin-bottom: 0; font-weight: normal;">DuruÅŸma</label>
                                        </div>
                                        <div style="display: flex; align-items: center; gap: 5px;">
                                            <input type="radio" name="editHearingType" id="editHearingTypeEDurusma" value="e-durusma" ${data.hearing_type === 'e-durusma' ? 'checked' : ''}>
                                            <label for="editHearingTypeEDurusma" style="margin-bottom: 0; font-weight: normal;">E-DuruÅŸma</label>
                                        </div>
                                        {# DuruÅŸmayÄ± KaldÄ±r butonu buraya taÅŸÄ±ndÄ± #}
                                        <button type="button" class="btn btn-outline-danger btn-sm" id="removeHearingBtn" style="height: 30px; margin-left: 20px;"> {# YÃ¼ksekliÄŸi ayarla ve sola boÅŸluk ekle #}
                                            <i class="material-icons">delete_outline</i> DuruÅŸmayÄ± KaldÄ±r
                                        </button>
                                    </div>
                                </div>
                                {# Eski buton yeri kaldÄ±rÄ±ldÄ± #}
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn secondary" onclick="closeEditModal()">Ä°ptal</button>
                        <button class="btn primary" onclick="saveChanges(${caseId})">Kaydet</button>
                    </div>
                </div>
            `;
            
            const editModal = document.createElement('div');
            editModal.id = 'editModal';
            editModal.className = 'file-detail-modal';
            editModal.innerHTML = editHtml;
            document.body.appendChild(editModal);
            // editModal.style.display = 'flex'; // Bu satÄ±rÄ± aÅŸaÄŸÄ± taÅŸÄ±dÄ±k

            const editFileTypeSelect = editModal.querySelector('#editFileType');
            const editCitySelect = editModal.querySelector('#editCity');
            const editCourthouseSelect = editModal.querySelector('#editCourthouse');
            const editDepartmentSelect = editModal.querySelector('#editDepartment');

            // Ä°lk adliye ve departman yÃ¼klemesi iÃ§in
            updateEditCourthouses(editCitySelect, editCourthouseSelect, data.courthouse); // Adliyeleri yÃ¼kle ve seÃ§ili adliyeyi ayarla
            populateEditDepartments(data.file_type, editDepartmentSelect, data.department, editCourthouseSelect.value, editCitySelect.value); // DepartmanlarÄ± yÃ¼kle, temel ve numaralÄ±yÄ± ayarla


            editFileTypeSelect.onchange = function() {
                const selectedFileType = this.value;
                const shouldDisableCityAndCourthouse = ['ARABULUCULUK', 'AÄ°HM', 'AYM'].includes(selectedFileType);
                const shouldDisableDepartment = ['ARABULUCULUK', 'AÄ°HM', 'AYM', 'savcilik'].includes(selectedFileType);
                
                // Åžehir ve adliye alanlarÄ±nÄ± etkinleÅŸtir/devre dÄ±ÅŸÄ± bÄ±rak
                editCitySelect.disabled = shouldDisableCityAndCourthouse;
                editCourthouseSelect.disabled = shouldDisableCityAndCourthouse;
                
                // Devre dÄ±ÅŸÄ± bÄ±rakÄ±ldÄ±ysa deÄŸerleri temizle
                if (shouldDisableCityAndCourthouse) {
                    editCitySelect.value = '';
                    editCourthouseSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
                }
                
                populateEditDepartments(selectedFileType, editDepartmentSelect, null, editCourthouseSelect.value, editCitySelect.value);
            };
            editCitySelect.onchange = function() {
                updateEditCourthouses(this, editCourthouseSelect, null); // Adliyeleri gÃ¼ncelle
                populateEditDepartments(editFileTypeSelect.value, editDepartmentSelect, null, editCourthouseSelect.value, this.value); // DepartmanlarÄ± adliyeye gÃ¶re gÃ¼ncelle
            };
            editCourthouseSelect.onchange = function() {
                populateEditDepartments(editFileTypeSelect.value, editDepartmentSelect, null, this.value, editCitySelect.value); // DepartmanlarÄ± adliyeye gÃ¶re gÃ¼ncelle
            };
             editDepartmentSelect.onchange = function() {
                updateEditNumberedDepartments(this.value, document.getElementById('editCity').value, document.getElementById('editCourthouse').value, data.department);
            };


            const showHearingBtn = editModal.querySelector('#showHearingInputBtn');
            const removeHearingBtn = editModal.querySelector('#removeHearingBtn');
            const hearingSection = editModal.querySelector('#editHearingSection');
            const nextHearingInput = editModal.querySelector('#editNextHearing');
            const hearingTimeInput = editModal.querySelector('#editHearingTime');
            const hearingInfoLabel = editModal.querySelector('#hearingInfoLabel');

            showHearingBtn.onclick = function() {
                hearingSection.style.display = 'grid'; // detail-grid 2 column span yapar
                showHearingBtn.style.display = 'none';
                hearingInfoLabel.style.display = 'none';
            };

            removeHearingBtn.onclick = function() {
                nextHearingInput.value = ''; 
                hearingTimeInput.value = '09:00'; 
                const durusmaRadio = editModal.querySelector('input[name="editHearingType"][value="durusma"]');
                if (durusmaRadio) durusmaRadio.checked = true;
                hearingSection.style.display = 'none';
                showHearingBtn.style.display = 'flex';
                 hearingInfoLabel.style.display = 'block';
            };
            
            editModal.style.display = 'flex'; // Modal'Ä± tÃ¼m kurulumlar bittikten sonra gÃ¶ster
        });
}

function updateEditCourthouses(citySelectElement, courthouseSelectElement, selectedCourthouse) {
    const selectedCity = citySelectElement.value;
    courthouseSelectElement.innerHTML = '<option value="">SeÃ§iniz</option>'; // Ã–nceki adliyeleri temizle

    if (selectedCity === 'Ä°stanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            if (selectedCourthouse === courthouse) option.selected = true;
            courthouseSelectElement.appendChild(option);
        });
    }
    
    if (selectedCity && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            // Ä°stanbul adliyesiyse ve zaten eklendiyse tekrar ekleme
            if (selectedCity === 'Ä°stanbul' && istanbulSpecificCourthouses.includes(courthouse)) {
                return;
            }
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            if (selectedCourthouse === courthouse) option.selected = true;
            courthouseSelectElement.appendChild(option);
        });
    }

    if (courthouseSelectElement.options.length <= 1) {
        if (selectedCity) {
            courthouseSelectElement.innerHTML = '<option value="">Bu ÅŸehir iÃ§in adliye bulunamadÄ±</option>';
        } else {
            courthouseSelectElement.innerHTML = '<option value="">Ã–nce Åžehir SeÃ§iniz</option>';
        }
    }
}


// DÃ¼zenleme modalÄ±nda birim seÃ§eneklerini gÃ¼ncelle
function populateEditDepartments(fileType, departmentSelect, fullSelectedDepartment, selectedCourthouse, selectedCity) {
    departmentSelect.innerHTML = '<option value="">SeÃ§iniz</option>';
        departmentSelect.disabled = false;

    let departmentsToShow = [];
    if (fileType === 'hukuk') {
        departmentsToShow = originalDepartments.filter(dept => ![
            'Asliye Ceza Mahkemesi', 'AÄŸÄ±r Ceza Mahkemesi', 'Sulh Ceza HakimliÄŸi', 'Ä°cra Dairesi'
        ].includes(dept));
    } else if (fileType === 'ceza') {
        departmentsToShow = originalDepartments.filter(dept => [
            'Asliye Ceza Mahkemesi', 'AÄŸÄ±r Ceza Mahkemesi', 'Sulh Ceza HakimliÄŸi'
        ].includes(dept));
    } else if (fileType === 'icra') {
        departmentsToShow = ['Ä°cra Dairesi'];
    } else if (['ARABULUCULUK', 'AÄ°HM', 'AYM', 'savcilik'].includes(fileType)) {
        departmentSelect.disabled = true;
        updateEditNumberedDepartments(null, selectedCity, selectedCourthouse, null); // NumaralÄ±yÄ± da gizle
        return;
    } else { // TÃ¼mÃ¼ veya bilinmeyen
        departmentsToShow = originalDepartments;
    }

    departmentsToShow.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
    });

    let baseDepartmentToSelect = null;
    if (fullSelectedDepartment) {
        const match = fullSelectedDepartment.match(/^(\d+\.\s+)?(.*)$/);
        if (match && match[2]) {
            baseDepartmentToSelect = match[2]; // "Asliye Hukuk Mahkemesi"
        }
    }
    
    if (baseDepartmentToSelect && Array.from(departmentSelect.options).some(opt => opt.value === baseDepartmentToSelect)) {
        departmentSelect.value = baseDepartmentToSelect;
    } else if (departmentSelect.options.length > 1 && !baseDepartmentToSelect && !fullSelectedDepartment) {
        // EÄŸer bir seÃ§im yoksa ve seÃ§enekler varsa ilkini seÃ§me (SeÃ§iniz kalsÄ±n)
    } else if (baseDepartmentToSelect) {
         console.warn(`populateEditDepartments: Temel departman "${baseDepartmentToSelect}" dropdown'da bulunamadÄ±. Dosya tÃ¼rÃ¼: ${fileType}`);
    }
    
    updateEditNumberedDepartments(departmentSelect.value, selectedCity, selectedCourthouse, fullSelectedDepartment);
}

// DÃ¼zenleme modalÄ±nda mahkeme numaralarÄ±nÄ± gÃ¼ncelle
function updateEditNumberedDepartments(baseDepartment, selectedCity, selectedCourthouse, fullSelectedDepartmentToSelect) {
    const numberedDepartmentContainer = document.getElementById('editNumberedDepartmentContainer');
    const numberedDepartmentSelect = document.getElementById('editNumberedDepartment');
    
    numberedDepartmentSelect.innerHTML = '<option value="">SeÃ§iniz</option>'; // Her zaman temizle
    
    if (!baseDepartment || baseDepartment === '' || ['ARABULUCULUK', 'AÄ°HM', 'AYM', 'savcilik'].includes(document.getElementById('editFileType').value)) {
        numberedDepartmentContainer.style.display = 'none';
        return;
    }

    let maxCourtNumber = 30; // VarsayÄ±lan
    if (selectedCity === 'Ä°stanbul') {
        if (selectedCourthouse && (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Ã‡aÄŸlayan'))) {
            if (baseDepartment === 'Asliye Hukuk Mahkemesi' || baseDepartment === 'Asliye Ceza Mahkemesi' || baseDepartment === 'Ä°ÅŸ Mahkemesi') maxCourtNumber = 50;
            else if (baseDepartment === 'AÄŸÄ±r Ceza Mahkemesi') maxCourtNumber = 15;
        } else if (selectedCourthouse && selectedCourthouse.includes('BakÄ±rkÃ¶y')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'Ä°zmir') {
        maxCourtNumber = 40;
    }
    
    if (baseDepartment === 'Ä°cra Dairesi') { // Ä°cra daireleri iÃ§in Ã¶zel numaralandÄ±rma
         for (let i = 1; i <= maxCourtNumber; i++) { // Genelde 30 olur ama dinamik olsun
            const optionValue = `${i}. ${baseDepartment}`;
            const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            numberedDepartmentSelect.appendChild(option);
        }
    } else {
        // Temel mahkeme adÄ±nÄ± da bir seÃ§enek olarak ekle (NumarasÄ±z hali)
    const baseOption = document.createElement('option');
        baseOption.value = baseDepartment; 
        baseOption.textContent = baseDepartment;
        numberedDepartmentSelect.appendChild(baseOption);
    
    for (let i = 1; i <= maxCourtNumber; i++) {
            const optionValue = `${i}. ${baseDepartment}`;
        const option = document.createElement('option');
            option.value = optionValue;
            option.textContent = optionValue;
            numberedDepartmentSelect.appendChild(option);
    }
    }
    
    numberedDepartmentContainer.style.display = 'flex'; // block yerine flex daha iyi olabilir
    
    // KaydedilmiÅŸ veya seÃ§ilmiÅŸ numaralÄ±/temel deÄŸeri ayarla
    if (fullSelectedDepartmentToSelect && Array.from(numberedDepartmentSelect.options).some(opt => opt.value === fullSelectedDepartmentToSelect)) {
        numberedDepartmentSelect.value = fullSelectedDepartmentToSelect;
    } else if (baseDepartment && Array.from(numberedDepartmentSelect.options).some(opt => opt.value === baseDepartment) && !fullSelectedDepartmentToSelect.match(/^\d+\.\s+(.*)$/)) {
        // EÄŸer fullSelectedDepartmentToSelect numarasÄ±zsa ve baseDepartment listede varsa onu seÃ§
        numberedDepartmentSelect.value = baseDepartment;
    } else if (numberedDepartmentSelect.options.length > 1) {
        // Otomatik bir ÅŸey seÃ§me, "SeÃ§iniz" kalsÄ±n
    }
}

// DeÄŸiÅŸiklikleri kaydet
function saveChanges(caseId) {
    // SeÃ§ili departman deÄŸerini al (Ã–nce numaralÄ±dan, sonra temelden)
    const numberedDeptSelect = document.getElementById('editNumberedDepartment');
    const baseDeptSelect = document.getElementById('editDepartment');
    let finalDepartmentValue = baseDeptSelect.value; // VarsayÄ±lan olarak temel departman
    
    // EÄŸer numaralÄ± departman gÃ¶rÃ¼nÃ¼r ve bir deÄŸer seÃ§iliyse onu kullan
    if (numberedDeptSelect && getComputedStyle(numberedDeptSelect.parentElement).display !== 'none' && numberedDeptSelect.value) {
        finalDepartmentValue = numberedDeptSelect.value;
    } else if (!baseDeptSelect.disabled && baseDeptSelect.value) {
        // NumaralÄ± gÃ¶rÃ¼nÃ¼r deÄŸilse veya seÃ§ilmemiÅŸse, temel departmanÄ± kullan (eÄŸer devre dÄ±ÅŸÄ± deÄŸilse)
        finalDepartmentValue = baseDeptSelect.value;
    } else {
        // HiÃ§biri uygun deÄŸilse (Ã¶rn. SavcÄ±lÄ±k vs.) null yap
        finalDepartmentValue = null;
    }
    
    // DuruÅŸma tÃ¼rÃ¼nÃ¼ al
    const hearingTypeRadios = document.querySelectorAll('input[name="editHearingType"]');
    let hearingType = 'durusma'; // varsayÄ±lan deÄŸer
    for (const radio of hearingTypeRadios) {
        if (radio.checked) {
            hearingType = radio.value;
            break;
        }
    }
    
    const data = {
        file_type: document.getElementById('editFileType').value,
        courthouse: document.getElementById('editCourthouse').value,
        department: finalDepartmentValue, // GÃ¼ncellenmiÅŸ departman deÄŸeri
        
        // MÃ¼vekkil bilgileri
        client_entity_type: document.getElementById('editClientEntityType').value,
        client_name: document.getElementById('editClientName').value,
        client_capacity: document.getElementById('editClientCapacity').value,
        client_identity_number: document.getElementById('editClientIdentityNumber').value,
        client_address: document.getElementById('editClientAddress').value,
        phone_number: document.getElementById('editPhoneNumber').value,
        
        // KarÅŸÄ± taraf bilgileri
        opponent_entity_type: document.getElementById('editOpponentEntityType').value,
        opponent_name: document.getElementById('editOpponentName').value,
        opponent_capacity: document.getElementById('editOpponentCapacity').value,
        opponent_identity_number: document.getElementById('editOpponentIdentityNumber').value,
        opponent_phone: document.getElementById('editOpponentPhone').value,
        opponent_address: document.getElementById('editOpponentAddress').value,
        
        // Vekil bilgileri
        opponent_lawyer: document.getElementById('editOpponentLawyer').value,
        opponent_lawyer_phone: document.getElementById('editOpponentLawyerPhone').value,
        opponent_lawyer_address: document.getElementById('editOpponentLawyerAddress').value,
        
        // Dosya bilgileri
        status: document.getElementById('editStatus').value,
        next_hearing: document.getElementById('editNextHearing').value || null,
        hearing_time: document.getElementById('editHearingTime').value || null,
        hearing_type: hearingType
    };



    // Sadece mÃ¼vekkil adÄ± kontrolÃ¼ yap
    if (!data.client_name || data.client_name.trim() === '') {
        alert('LÃ¼tfen mÃ¼vekkil adÄ±nÄ± giriniz.');
        return;
    }

    fetch(`/edit_case/${caseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (response.status === 403) {
            alert('Bu iÅŸlemi yapmak iÃ§in gerekli yetkiye sahip deÄŸilsiniz. Dosya dÃ¼zenleme yetkisi gereklidir.');
            closeEditModal();
            return Promise.reject(new Error('Yetki hatasÄ±'));
        }
        
        // YanÄ±tÄ± JSON olarak parse et
        return response.json().then(result => {
            if (!response.ok) {
                // Sunucudan gelen hata mesajÄ±nÄ± kullan
                throw new Error(result.message || `Sunucu hatasÄ± (${response.status})`);
            }
            return result;
        });
    })
    .then(result => {
        if (result.success) {
                            showGlobalNotification('Dosya baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
            
            // Takvim senkronizasyonu iÃ§in dosya durumunu ve duruÅŸma tÃ¼rÃ¼nÃ¼ gÃ¶nder
            if (data.next_hearing) {
                syncHearingToCalendar(caseId, data.next_hearing, data.hearing_time, data.status, hearingType);
            }
            
            closeEditModal();
            showDetails(caseId);
        } else {
            throw new Error(result.message || 'GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu');
        }
    })
    .catch(error => {
        console.error('Dosya gÃ¼ncelleme hatasÄ±:', error);
        if (error.message !== 'Yetki hatasÄ±') {
            alert('GÃ¼ncelleme sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message);
        }
    });
}

// Masraf ekle modalÄ±nÄ± gÃ¼ncelle
function showExpenseModal() {
    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf Ekle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf TÃ¼rÃ¼</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">SeÃ§iniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}">${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf tÃ¼rÃ¼nÃ¼ yazÄ±nÄ±z" 
                                       style="display: none;">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required>
                                <span class="currency-symbol">â‚º</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ã–deme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input">
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ã–denmedi</span>
                                    <span class="toggle-text-on">Ã–dendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>AÃ§Ä±klama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili aÃ§Ä±klama ekleyin..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">Ä°ptal</button>
                <button class="btn primary" onclick="saveExpense()">Kaydet</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// DiÄŸer seÃ§eneÄŸi iÃ§in input alanÄ±nÄ± gÃ¶ster/gizle
function handleExpenseTypeChange() {
    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    
    if (expenseType.value === 'DiÄŸer') {
        otherExpenseType.style.display = 'block';
        otherExpenseType.required = true;
    } else {
        otherExpenseType.style.display = 'none';
        otherExpenseType.required = false;
    }
}

// Masraf kaydetme fonksiyonunu gÃ¼ncelle
let isSavingExpense = false; // Ã‡ift kayÄ±t Ã¶nleme flag'Ä±

function saveExpense() {
    // Zaten kaydetme iÅŸlemi devam ediyorsa Ã§Ä±k
    if (isSavingExpense) {
        return;
    }

    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    const amount = document.getElementById('expenseAmount');
    const date = document.getElementById('expenseDate');
    const status = document.getElementById('expenseStatus');
    const description = document.getElementById('expenseDescription');

    // Form validasyonu
    if (!expenseType.value) {
        alert('LÃ¼tfen masraf tÃ¼rÃ¼nÃ¼ seÃ§iniz.');
        return;
    }
    if (expenseType.value === 'DiÄŸer' && !otherExpenseType.value) {
        alert('LÃ¼tfen masraf tÃ¼rÃ¼nÃ¼ yazÄ±nÄ±z.');
        return;
    }
    if (!amount.value || amount.value <= 0) {
        alert('LÃ¼tfen geÃ§erli bir tutar giriniz.');
        return;
    }
    if (!date.value) {
        alert('LÃ¼tfen tarih seÃ§iniz.');
        return;
    }

    // Kaydetme iÅŸlemini baÅŸlat
    isSavingExpense = true;

    const data = {
        expense_type: expenseType.value === 'DiÄŸer' ? otherExpenseType.value : expenseType.value,
        amount: parseFloat(amount.value),
        date: date.value,
        is_paid: status.checked,
        description: description.value || ''
    };

    fetch(`/add_expense/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf eklenirken bir hata oluÅŸtu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf eklenirken bir hata oluÅŸtu: ' + error.message);
    })
    .finally(() => {
        // Ä°ÅŸlem tamamlandÄ±ÄŸÄ±nda flag'Ä± sÄ±fÄ±rla
        isSavingExpense = false;
    });
}

// Belge yÃ¼kle butonu iÃ§in fonksiyon
function showUploadModal() {
    const uploadHtml = `
        <div class="modal-content upload-modal">
            <div class="modal-header">
                <h2>Belge YÃ¼kle</h2>
                <button class="close-btn" onclick="closeUploadModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="detail-group">
                        <label>Belge TÃ¼rÃ¼</label>
                        <select id="documentType" required>
                            <option value="">SeÃ§iniz</option>
                            ${documentTypes.map(type => 
                                `<option value="${type}">${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="detail-group">
                        <label>Belge</label>
                        <input type="file" id="documentFile" required>
                    </div>
                    <div class="detail-group">
                        <label>Belge AdÄ± (Opsiyonel)</label>
                        <input type="text" id="documentName" placeholder="Belgeye Ã¶zel bir isim verin">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeUploadModal()">Ä°ptal</button>
                <button class="btn primary" onclick="uploadDocument()">YÃ¼kle</button>
            </div>
        </div>
    `;
    
    const uploadModal = document.createElement('div');
    uploadModal.id = 'uploadModal';
    uploadModal.className = 'file-detail-modal';
    uploadModal.innerHTML = uploadHtml;
    document.body.appendChild(uploadModal);
    uploadModal.style.display = 'flex';
}

// Belge yÃ¼kleme fonksiyonunu gÃ¼ncelle
function uploadDocument() {
    const documentType = document.getElementById('documentType');
    const fileInput = document.getElementById('documentFile');
    const documentName = document.getElementById('documentName');
    
    if (!documentType.value) {
        showGlobalNotification('LÃ¼tfen belge tÃ¼rÃ¼nÃ¼ seÃ§iniz.', 'error');
        return;
    }
    
    if (!fileInput.files.length) {
        showGlobalNotification('LÃ¼tfen bir belge seÃ§iniz.', 'error');
        return;
    }

    const formData = new FormData();
    formData.append('document', fileInput.files[0]);
    formData.append('document_type', documentType.value);
    formData.append('csrf_token', csrfToken);
    if (documentName.value) {
        formData.append('document_name', documentName.value);
    }

    fetch(`/upload_document/${currentCaseId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            showGlobalNotification('Belge baÅŸarÄ±yla yÃ¼klendi!', 'success');
            closeUploadModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Belge yÃ¼klenirken bir hata oluÅŸtu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        showGlobalNotification('Belge yÃ¼klenirken bir hata oluÅŸtu: ' + error.message, 'error');
    });
}

// Belge Ã¶nizleme fonksiyonu
function previewDocument(docId, filename) {
    // Orijinal dosya uzantÄ±sÄ±nÄ± bul
    let ext = '';
    // Dosya adÄ±nda nokta varsa son noktadan sonrasÄ±nÄ± al
    if (filename.includes('.')) {
        ext = filename.split('.').pop().toLowerCase();
    } else {
        // EÄŸer Ã¶zel isim verilmiÅŸ ve uzantÄ± yoksa, sunucudan dosya bilgisini al
        fetch(`/get_document_info/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.original_filename) {
                    ext = data.original_filename.split('.').pop().toLowerCase();
                    showPreviewModal(docId, filename, ext);
                } else {
                    alert('Dosya tÃ¼rÃ¼ belirlenemedi.');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Dosya bilgisi alÄ±nÄ±rken bir hata oluÅŸtu.');
            });
        return;
    }
    
    showPreviewModal(docId, filename, ext);
}

// Ã–nizleme modalÄ±nÄ± gÃ¼ncelle (TIFF ve DOCX desteÄŸi ekle)
function showPreviewModal(docId, filename, ext) {
    const previewUrl = `/preview_document/${docId}`;
    const modalContentElement = document.createElement('div');
    modalContentElement.className = 'modal-content preview-modal-content';

    const previewHtml = `
        <div class="modal-header">
            <h2>${filename}</h2>
            <button class="close-btn" onclick="closePreviewModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body preview-modal-body">
            <div class="document-preview-container" id="previewContainer-${docId}" style="width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: white;">
                <p>Ã–nizleme yÃ¼kleniyor...</p> {# Initial loading message #}
            </div>
        </div>
    `;
    modalContentElement.innerHTML = previewHtml;

    const previewModal = document.createElement('div');
    previewModal.id = 'previewModal';
    previewModal.className = 'file-detail-modal';
    previewModal.appendChild(modalContentElement);
    document.body.appendChild(previewModal);
    previewModal.style.display = 'flex';

    const previewContainer = document.getElementById(`previewContainer-${docId}`);
    previewContainer.innerHTML = '<p>Ã–nizleme yÃ¼kleniyor...</p>'; // Reset content

    function showError(message) {
        previewContainer.style.background = 'white';
        previewContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="material-icons" style="font-size: 48px; color: #999;">error_outline</i>
                <p style="margin-top: 15px; font-size: 1.1rem; color: #555;">${message}</p>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #777;">Belgeyi gÃ¶rÃ¼ntÃ¼lemek iÃ§in lÃ¼tfen indirin.</p>
                <button class="btn primary" style="margin-top: 20px;" onclick="downloadDocument(${docId})">
                    <i class="material-icons" style="margin-right: 5px;">download</i> Ä°ndir
                </button>
            </div>
        `;
    }

    // UDF iÃ§in Ã¶zel gÃ¶rÃ¼ntÃ¼leyici
    function showUdfHelp() {
        previewContainer.style.background = 'white';
        previewContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <i class="material-icons" style="font-size: 48px; color: #3f51b5;">info</i>
                <p style="margin-top: 15px; font-size: 1.1rem; color: #555;">UDF DosyasÄ± (Ulusal YargÄ± AÄŸÄ± Projesi)</p>
                <p style="margin: 15px 0; color: #666; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
                    UDF dosyalarÄ±, UYAP sistemine Ã¶zgÃ¼ belgelerdir ve Ã¶zel UYAP EditÃ¶r yazÄ±lÄ±mÄ± ile aÃ§Ä±lmalÄ±dÄ±r. 
                    Bu dosyalarÄ± gÃ¶rÃ¼ntÃ¼lemek iÃ§in aÅŸaÄŸÄ±daki adÄ±mlarÄ± takip edebilirsiniz:
                </p>
                <ol style="text-align: left; max-width: 600px; margin: 15px auto; color: #666;">
                    <li>DosyayÄ± indirin</li>
                    <li>UYAP EditÃ¶r programÄ±nÄ± aÃ§Ä±n (bilgisayarÄ±nÄ±zda yÃ¼klÃ¼ deÄŸilse <a href="https://www.e-justice.gov.tr/indir" target="_blank">e-justice.gov.tr</a> adresinden edinebilirsiniz)</li>
                    <li>Ä°ndirdiÄŸiniz UDF dosyasÄ±nÄ± UYAP EditÃ¶r ile aÃ§Ä±n</li>
                </ol>
                <button class="btn primary" style="margin-top: 20px;" onclick="downloadDocument(${docId})">
                    <i class="material-icons" style="margin-right: 5px;">download</i> UDF DosyasÄ±nÄ± Ä°ndir
                </button>
            </div>
        `;
    }

    if (ext === 'pdf' || ext === 'txt') {
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `<iframe id="previewFrame" src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%;"></iframe>`;
    } else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'].includes(ext)) {
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `<img src="${previewUrl}" alt="Belge Ã¶nizleme" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
    } else if (ext === 'tiff' || ext === 'tif') {
        previewContainer.style.background = '#f5f5f5';
        fetch(previewUrl)
            .then(response => {
                if (!response.ok) throw new Error('TIFF dosyasÄ± yÃ¼klenemedi');
                return response.arrayBuffer();
            })
            .then(buffer => {
                Tiff.initialize({ TOTAL_MEMORY: 16777216 * 5 }); // Bellek ayÄ±r
                const tiff = new Tiff({ buffer: buffer });
                const canvas = tiff.toCanvas();
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
                canvas.style.objectFit = 'contain';
                previewContainer.innerHTML = ''; // Clear loading
                previewContainer.appendChild(canvas);
            })
            .catch(error => {
                console.error('TIFF Ã–nizleme HatasÄ±:', error);
                showError(`".${ext}" uzantÄ±lÄ± dosya iÃ§in Ã¶nizleme yÃ¼klenirken hata oluÅŸtu.`);
            });
    } else if (ext === 'docx' || ext === 'doc') {
        // VarsayÄ±m: Backend bu dosyalarÄ± PDF'e Ã§evirip sunacak
        // veya tarayÄ±cÄ±nÄ±n iframe'de gÃ¶sterebileceÄŸi bir formata.
        previewContainer.style.background = '#f5f5f5'; // PDF'teki gibi
        previewContainer.innerHTML = `<iframe id="previewFrame" src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%;"></iframe>`;
        
        const iframe = previewContainer.querySelector('#previewFrame');
        if (iframe) {
            iframe.onload = () => {
                // BaÅŸarÄ±yla yÃ¼klendiÄŸinde, alttaki genel indirme mesajÄ±nÄ± gizleyebiliriz.
                console.log('DOC/DOCX (PDF olarak) iframe baÅŸarÄ±yla yÃ¼klendi.');
                // Ä°steÄŸe baÄŸlÄ±: YÃ¼kleme sonrasÄ± alttaki "Belge yÃ¼klenirken sorun yaÅŸanÄ±rsa..." mesajÄ±nÄ± gizleyebilirsiniz.
                // Ã–rnek:
                // const docxFooterMessage = document.querySelector('.preview-modal-content .modal-body > div[style*="background: #f0f0f0"]');
                // if (docxFooterMessage) {
                //     docxFooterMessage.style.display = 'none';
                // }
            };
            iframe.onerror = () => {
                // showError fonksiyonu zaten bir indirme butonu iÃ§eriyor.
                showError(`".${ext}" uzantÄ±lÄ± dosya iÃ§in Ã¶nizleme yÃ¼klenemedi. Dosya formatÄ± tarayÄ±cÄ±da doÄŸrudan gÃ¶rÃ¼ntÃ¼lenemiyor veya sunucu PDF'e dÃ¶nÃ¼ÅŸtÃ¼rme hatasÄ± oluÅŸtu. LÃ¼tfen dosyayÄ± indirip gÃ¶rÃ¼ntÃ¼leyin.`);
            };
        } else {
             showError(`".${ext}" uzantÄ±lÄ± dosya iÃ§in Ã¶nizleme alanÄ± (iframe) oluÅŸturulamadÄ±. LÃ¼tfen dosyayÄ± indirip gÃ¶rÃ¼ntÃ¼leyin.`);
        }
    } else if (ext === 'udf') {
        // UDF dosyasÄ±nÄ± doÄŸrudan uygulama iÃ§inde gÃ¶rÃ¼ntÃ¼le
        previewContainer.style.background = '#f5f5f5';
        previewContainer.innerHTML = `
            <iframe src="/direct_view_udf/${docId}" frameborder="0" style="width: 100%; height: 100%;"></iframe>
        `;
    } else { // DiÄŸer desteklenmeyenler
        showError(`".${ext}" uzantÄ±lÄ± dosyalar iÃ§in Ã¶nizleme desteklenmiyor.`);
    }
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (modal) {
        modal.remove();
    }
}

// Belge indirme fonksiyonu
function downloadDocument(docId) {
    const link = document.createElement('a');
    link.href = `/download_document/${docId}`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Belge silme fonksiyonu
function deleteDocument(docId) {
    if (confirm('Bu belgeyi silmek istediÄŸinizden emin misiniz?')) {
        fetch(`/delete_document/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.status === 403) {
                alert('Bu iÅŸlemi yapmak iÃ§in gerekli yetkiye sahip deÄŸilsiniz. Dosya silme yetkisi gereklidir.');
                return Promise.reject(new Error('Yetki hatasÄ±'));
            }
            
            if (!response.ok) {
                throw new Error('Sunucu hatasÄ±');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showDetails(currentCaseId); // Belge listesini gÃ¼ncelle
            } else {
                throw new Error(result.message || 'Belge silinirken bir hata oluÅŸtu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            if (error.message !== 'Yetki hatasÄ±') {
                alert('Belge silinirken bir hata oluÅŸtu: ' + error.message);
            }
        });
    }
}

// Modal kapatma fonksiyonlarÄ±
function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.remove();
    }
}

function closeExpenseModal() {
    const modal = document.getElementById('expenseModal');
    if (modal) {
        modal.remove();
    }
    // Flag'Ä± sÄ±fÄ±rla
    isSavingExpense = false;
}

function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.remove();
    }
}

// Masraf silme fonksiyonu
function deleteExpense(expenseId) {
    if (confirm('Bu masrafÄ± silmek istediÄŸinizden emin misiniz?')) {
        fetch(`/delete_expense/${expenseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Masraf listesini gÃ¼ncelle
                showDetails(currentCaseId);
            } else {
                throw new Error(result.message || 'Masraf silinirken bir hata oluÅŸtu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Masraf silinirken bir hata oluÅŸtu: ' + error.message);
        });
    }
}

// AÃ§Ä±klama dÃ¼zenleme fonksiyonlarÄ±nÄ± ekle
function editDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    const textarea = document.getElementById('editDescriptionText');
    const currentText = document.getElementById('detailDescription').textContent;
    
    textarea.value = currentText === 'AÃ§Ä±klama bulunmuyor.' ? '' : currentText;
    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';
    textarea.focus();
}

function cancelEditDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function saveDescription() {
    const newDescription = document.getElementById('editDescriptionText').value;
    
    fetch(`/update_description/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            description: newDescription
        })
    })
    .then(response => {
        if (response.status === 403) {
            alert('Bu iÅŸlemi yapmak iÃ§in gerekli yetkiye sahip deÄŸilsiniz. Dosya dÃ¼zenleme yetkisi gereklidir.');
            cancelEditDescription();
            return Promise.reject(new Error('Yetki hatasÄ±'));
        }
        
        if (!response.ok) {
            throw new Error('Sunucu hatasÄ±');
        }
        return response.json();
    })
    .then(result => {
        if (result.success) {
            document.getElementById('detailDescription').textContent = 
                newDescription || 'AÃ§Ä±klama bulunmuyor.';
            cancelEditDescription();
        } else {
            throw new Error(result.message || 'AÃ§Ä±klama gÃ¼ncellenirken bir hata oluÅŸtu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        if (error.message !== 'Yetki hatasÄ±') {
            alert('AÃ§Ä±klama gÃ¼ncellenirken bir hata oluÅŸtu: ' + error.message);
        }
    });
}

// DuruÅŸma bilgilerini takvime senkronize et
function syncHearingToCalendar(caseId, hearingDate, hearingTime, status, hearingType = 'durusma') {
    fetch('/sync_hearing_to_calendar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            case_id: caseId,
            hearing_date: hearingDate,
            hearing_time: hearingTime || '09:00',
            status: status,
            hearing_type: hearingType // DuruÅŸma tÃ¼rÃ¼nÃ¼ ekle
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            throw new Error(result.message || 'Takvim senkronizasyonu baÅŸarÄ±sÄ±z');
        }
    })
    .catch(error => {
        console.error('Takvim senkronizasyonu hatasÄ±:', error);
        alert('DuruÅŸma bilgileri gÃ¼ncellenirken bir hata oluÅŸtu: ' + error.message);
    });
}

// Dosya silme fonksiyonu
function deleteCase(caseId) {
    if (confirm('Bu dosyayÄ± silmek istediÄŸinizden emin misiniz?')) {
        fetch(`/delete_case/${caseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (response.status === 403) {
                alert('Bu iÅŸlemi yapmak iÃ§in gerekli yetkiye sahip deÄŸilsiniz. Dosya silme yetkisi gereklidir.');
                return Promise.reject(new Error('Yetki hatasÄ±'));
            }
            
            if (!response.ok) {
                throw new Error('Sunucu hatasÄ±');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Tablodan ilgili satÄ±rÄ± kaldÄ±r
                const row = document.querySelector(`tr[data-case-id="${caseId}"]`);
                if (row) {
                    row.remove();
                }
            } else {
                throw new Error(result.message || 'Dosya silinirken bir hata oluÅŸtu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            if (error.message !== 'Yetki hatasÄ±') {
                alert('Dosya silinirken bir hata oluÅŸtu: ' + error.message);
            }
        });
    }
}

// Masraf dÃ¼zenleme fonksiyonunu ekle
function editExpense(expenseId) {
    const expense = currentExpenses.find(e => e.id === expenseId);
    if (!expense) return;

    // Tarihi YYYY-MM-DD formatÄ±na Ã§evir
    const formattedDate = expense.date.split('.').reverse().join('-');

    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf DÃ¼zenle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf TÃ¼rÃ¼</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">SeÃ§iniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}" ${expense.expense_type === type ? 'selected' : ''}>${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf tÃ¼rÃ¼nÃ¼ yazÄ±nÄ±z" 
                                       style="display: none;"
                                       value="${expense.expense_type}">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required value="${expense.amount}">
                                <span class="currency-symbol">â‚º</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required value="${formattedDate}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ã–deme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input" ${expense.is_paid ? 'checked' : ''}>
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ã–denmedi</span>
                                    <span class="toggle-text-on">Ã–dendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>AÃ§Ä±klama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili aÃ§Ä±klama ekleyin...">${expense.description || ''}</textarea>
                    </div>
                    <input type="hidden" id="expenseId" value="${expense.id}">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">Ä°ptal</button>
                <button class="btn primary" onclick="updateExpense()">GÃ¼ncelle</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// Masraf gÃ¼ncelleme fonksiyonu
function updateExpense() {
    const expenseId = document.getElementById('expenseId').value;
    const data = {
        expense_type: document.getElementById('expenseType').value === 'DiÄŸer' ? 
                     document.getElementById('otherExpenseType').value : 
                     document.getElementById('expenseType').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        is_paid: document.getElementById('expenseStatus').checked,
        description: document.getElementById('expenseDescription').value || ''
    };

    fetch(`/update_expense/${expenseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf gÃ¼ncellenirken bir hata oluÅŸtu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf gÃ¼ncellenirken bir hata oluÅŸtu: ' + error.message);
    });
}

// Tablo SÄ±ralama FonksiyonlarÄ±
let currentSort = { column: '', direction: '' };

function initializeTableSorting() {
    const sortableHeaders = document.querySelectorAll('.sortable');
    
    sortableHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const sortColumn = this.getAttribute('data-sort');
            sortTable(sortColumn);
        });
    });
}

function sortTable(column) {
    const table = document.getElementById('casesTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // SÄ±ralama yÃ¶nÃ¼nÃ¼ belirle
    let direction = 'asc';
    if (currentSort.column === column && currentSort.direction === 'asc') {
        direction = 'desc';
    }
    
    // Ã–nceki sÄ±ralama ikonlarÄ±nÄ± temizle
    document.querySelectorAll('.sortable').forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Aktif header'Ä± iÅŸaretle
    const activeHeader = document.querySelector(`[data-sort="${column}"]`);
    activeHeader.classList.add(direction === 'asc' ? 'sort-asc' : 'sort-desc');
    
    // SatÄ±rlarÄ± sÄ±rala
    rows.sort((a, b) => {
        let aValue = getCellValue(a, column);
        let bValue = getCellValue(b, column);
        
        // Numerik deÄŸerler iÃ§in
        if (column === 'year' || column === 'case_number') {
            aValue = parseInt(aValue) || 0;
            bValue = parseInt(bValue) || 0;
        } else if (column === 'open_date') {
            // Tarihi YYYY-MM-DD formatÄ±na Ã§evir
            aValue = convertDateForSort(aValue);
            bValue = convertDateForSort(bValue);
        } else {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        if (direction === 'asc') {
            return aValue > bValue ? 1 : (aValue < bValue ? -1 : 0);
        } else {
            return aValue < bValue ? 1 : (aValue > bValue ? -1 : 0);
        }
    });
    
    // SÄ±ralanan satÄ±rlarÄ± tbody'e geri ekle
    rows.forEach(row => tbody.appendChild(row));
    
    // Mevcut sÄ±ralama durumunu kaydet
    currentSort = { column, direction };
}

function getCellValue(row, column) {
    switch(column) {
        case 'file_type':
            return row.querySelector('.main-type')?.textContent || '';
        case 'year':
            return row.cells[1]?.textContent || '';
        case 'case_number':
            return row.cells[2]?.textContent || '';
        case 'client_name':
            return row.cells[3]?.textContent || '';
        case 'open_date':
            return row.cells[4]?.textContent || '';
        case 'status':
            return row.querySelector('.status-text')?.textContent || '';
        default:
            return '';
    }
}

function convertDateForSort(dateString) {
    if (!dateString || dateString === '-') {
        return '0000-00-00'; // BoÅŸ tarihler en alta
    }
    
    // DD.MM.YYYY formatÄ±ndan YYYY-MM-DD formatÄ±na Ã§evir
    const parts = dateString.split('.');
    if (parts.length === 3) {
        return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
    }
    
    return dateString;
}

// Sayfa yÃ¼klendiÄŸinde sÄ±ralama Ã¶zelliÄŸini baÅŸlat
document.addEventListener('DOMContentLoaded', function() {
    initializeTableSorting();
});
</script>
{% endblock %}