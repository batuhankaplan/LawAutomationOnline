{% extends "layout.html" %}

{% block title %}Admin Panel - Kullanıcı Yönetimi{% endblock %}

{% block content %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<div class="admin-container">
    <!-- Header -->
    <div class="admin-header">
        <div class="header-content">
            <h1><i class="material-icons">admin_panel_settings</i> Sistem Yönetimi</h1>
            <p>Kullanıcı yetkilendirme ve sistem kontrolü</p>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number">{{ active_users|length }}</span>
                <span class="stat-label">Aktif Kullanıcı</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ pending_users|length }}</span>
                <span class="stat-label">Onay Bekleyen</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">{{ (active_users|length + pending_users|length) }}</span>
                <span class="stat-label">Toplam</span>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="search-section">
            <div class="search-box">
                <i class="material-icons">search</i>
                <input type="text" id="userSearch" placeholder="Kullanıcı ara...">
            </div>
            <select id="roleFilter" class="filter-select" title="Rol filtresi seçiniz">
                <option value="all">Tüm Roller</option>
                <option value="Yönetici Avukat">Yönetici Avukat</option>
                <option value="Avukat">Avukat</option>
                <option value="Stajyer Avukat">Stajyer Avukat</option>
                <option value="Takip Elemanı">Takip Elemanı</option>
                <option value="Muhasebe">Muhasebe</option>
                <option value="Ulaşım">Ulaşım</option>
                <option value="Sekreter">Sekreter</option>
            </select>
        </div>
        <div class="action-buttons">
            <button class="btn btn-primary" onclick="approveSelectedUsers()">
                <i class="material-icons">check_circle</i> Seçilenleri Onayla
            </button>
        </div>
    </div>

    <!-- Active Users -->
    <div class="data-section">
        <div class="section-header">
            <h2><i class="material-icons">verified_user</i> Aktif Kullanıcılar ({{ active_users|length }})</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="50"><input type="checkbox" id="selectAllActive" title="Tüm aktif kullanıcıları seç/seçme"></th>
                        <th>Kullanıcı</th>
                        <th>İletişim</th>
                        <th>Rol</th>
                        <th>Onay Tarihi</th>
                        <th width="100">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in active_users %}
                    <tr data-role="{{ user.role }}">
                        <td><input type="checkbox" name="selectedUsers" value="{{ user.id }}" title="Kullanıcıyı seç"></td>
                        <td>
                            <div class="user-cell">
                                <img src="{{ url_for('static', filename='images/pp.png') }}" class="user-avatar" alt="Kullanıcı profil resmi">
                                <div>
                                    <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                                    <div class="user-username">@{{ user.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-cell">
                                <div><i class="material-icons">email</i> {{ user.email }}</div>
                                {% if user.phone %}<div><i class="material-icons">phone</i> {{ user.phone }}</div>{% endif %}
                            </div>
                        </td>
                        <td>
                            <span class="role-badge role-{{ user.role.replace(' ', '-').lower() }}">{{ user.role }}</span>
                            {% if user.is_admin %}<span class="admin-badge">Admin</span>{% endif %}
                        </td>
                        <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-icon edit" onclick="editUser({{ user.id }})" title="Düzenle">
                                    <i class="material-icons">edit</i>
                                </button>
                                <button class="btn-icon delete" onclick="deleteUser({{ user.id }})" title="Sil">
                                    <i class="material-icons">delete</i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pending Users -->
    <div class="data-section">
        <div class="section-header">
            <h2><i class="material-icons">pending</i> Onay Bekleyen Kullanıcılar ({{ pending_users|length }})</h2>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="50"><input type="checkbox" id="selectAllPending" title="Tüm bekleyen kullanıcıları seç/seçme"></th>
                        <th>Kullanıcı</th>
                        <th>İletişim</th>
                        <th>Rol</th>
                        <th>Kayıt Tarihi</th>
                        <th width="120">İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in pending_users %}
                    <tr data-role="{{ user.role }}" class="pending-row">
                        <td><input type="checkbox" name="selectedPendingUsers" value="{{ user.id }}" title="Kullanıcıyı seç"></td>
                        <td>
                            <div class="user-cell">
                                <img src="{{ url_for('static', filename='images/pp.png') }}" class="user-avatar" alt="Kullanıcı profil resmi">
                                <div>
                                    <div class="user-name">{{ user.first_name }} {{ user.last_name }}</div>
                                    <div class="user-username">@{{ user.username }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="contact-cell">
                                <div><i class="material-icons">email</i> {{ user.email }}</div>
                                {% if user.phone %}<div><i class="material-icons">phone</i> {{ user.phone }}</div>{% endif %}
                            </div>
                        </td>
                        <td><span class="role-badge role-{{ user.role.replace(' ', '-').lower() }}">{{ user.role }}</span></td>
                        <td>{{ user.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn-icon approve" onclick="approveUser({{ user.id }})" title="Onayla">
                                    <i class="material-icons">check</i>
                                </button>
                                <button class="btn-icon reject" onclick="rejectUser({{ user.id }})" title="Reddet">
                                    <i class="material-icons">close</i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
.admin-container {
    max-width: 100%;
    margin: 0;
    padding: 0;
    background: #f5f7fa;
    min-height: 100vh;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

.admin-header {
    background: linear-gradient(135deg, #2d313b 0%, #3a4149 100%);
    color: white;
    padding: 2rem 3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-content h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.header-content p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
    font-size: 1.1rem;
}

.stats-grid {
    display: flex;
    gap: 1.5rem;
}

.stat-card {
    background: rgba(255,255,255,0.15);
    padding: 1rem 1.5rem;
    border-radius: 8px;
    text-align: center;
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
}

.stat-number {
    display: block;
    font-size: 2rem;
    font-weight: 700;
}

.stat-label {
    display: block;
    font-size: 0.9rem;
    opacity: 0.8;
    margin-top: 0.25rem;
}

.control-panel {
    background: white;
    padding: 1.5rem 3rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e1e8ed;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.search-section {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-box .material-icons {
    position: absolute;
    left: 1rem;
    color: #657786;
}

.search-box input {
    padding: 0.75rem 1rem 0.75rem 3rem;
    border: 1px solid #e1e8ed;
    border-radius: 20px;
    width: 300px;
    font-size: 0.95rem;
    transition: all 0.2s;
}

.search-box input:focus {
    outline: none;
    border-color: #2d313b;
    box-shadow: 0 0 0 3px rgba(45,49,59,0.1);
}

.filter-select {
    padding: 0.75rem 1rem;
    border: 1px solid #e1e8ed;
    border-radius: 8px;
    background: white;
    font-size: 0.95rem;
    min-width: 150px;
}

.action-buttons {
    display: flex;
    gap: 1rem;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s;
}

.btn-primary {
    background: #2d313b;
    color: white;
}

.btn-primary:hover {
    background: #3a4149;
    transform: translateY(-1px);
}

.data-section {
    margin: 2rem 3rem;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.section-header {
    background: #f8fafc;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e1e8ed;
}

.section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #2d3748;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.table-container {
    overflow-x: auto;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.95rem;
}

.data-table th {
    background: #f8fafc;
    padding: 1rem 1.5rem;
    text-align: left;
    font-weight: 600;
    color: #4a5568;
    border-bottom: 1px solid #e1e8ed;
}

.data-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f7fafc;
    vertical-align: middle;
}

.data-table tr:hover {
    background: #f8fafc;
}

.pending-row {
    background: rgba(255,193,7,0.05);
}

.user-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
}

.user-name {
    font-weight: 600;
    color: #2d3748;
}

.user-username {
    color: #718096;
    font-size: 0.875rem;
}

.contact-cell div {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.contact-cell .material-icons {
    font-size: 1rem;
    color: #718096;
}

.role-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.role-yönetici-avukat { background: #fed7d7; color: #c53030; }
.role-avukat { background: #bee3f8; color: #2b6cb0; }
.role-stajyer-avukat { background: #c6f6d5; color: #276749; }
.role-takip-elemanı { background: #faf089; color: #744210; }
.role-muhasebe { background: #e9d8fd; color: #553c9a; }
.role-ulaşım { background: #fed7d7; color: #c53030; }
.role-sekreter { background: #fbb6ce; color: #97266d; }

.admin-badge {
    display: inline-block;
    background: #2d3748;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: 0.5rem;
}

.action-btns {
    display: flex;
    gap: 0.5rem;
}

.btn-icon {
    background: none;
    border: 1px solid #e1e8ed;
    width: 32px;
    height: 32px;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.btn-icon .material-icons {
    font-size: 1rem;
}

.btn-icon.edit { color: #2d313b; border-color: #2d313b; }
.btn-icon.edit:hover { background: #2d313b; color: white; }

.btn-icon.delete { color: #e53e3e; border-color: #e53e3e; }
.btn-icon.delete:hover { background: #e53e3e; color: white; }

.btn-icon.approve { color: #38a169; border-color: #38a169; }
.btn-icon.approve:hover { background: #38a169; color: white; }

.btn-icon.reject { color: #e53e3e; border-color: #e53e3e; }
.btn-icon.reject:hover { background: #e53e3e; color: white; }

@media (max-width: 1024px) {
    .admin-header {
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
        padding: 1.5rem;
    }
    
    .stats-grid {
        justify-content: center;
    }
    
    .control-panel {
        flex-direction: column;
        gap: 1rem;
        padding: 1.5rem;
    }
    
    .data-section {
        margin: 1rem;
    }
    
    .search-box input {
        width: 100%;
    }
}
</style>

<script>
// Search and filter functionality for admin panel
document.addEventListener('DOMContentLoaded', function() {
    const adminSearchInput = document.getElementById('userSearch');
    const adminRoleFilter = document.getElementById('roleFilter');
    
    function filterUsers() {
        if (!adminSearchInput) return; // Guard clause
        
        const searchTerm = adminSearchInput.value.toLowerCase();
        const selectedRole = adminRoleFilter ? adminRoleFilter.value : 'all';
        
        document.querySelectorAll('.data-table tbody tr').forEach(row => {
            const userNameElement = row.querySelector('.user-name');
            const contactElement = row.querySelector('.contact-cell');
            
            if (!userNameElement || !contactElement) return;
            
            const userName = userNameElement.textContent.toLowerCase();
            const userEmail = contactElement.textContent.toLowerCase();
            const userRole = row.dataset.role;
            
            const matchesSearch = userName.includes(searchTerm) || userEmail.includes(searchTerm);
            const matchesRole = selectedRole === 'all' || userRole === selectedRole;
            
            row.style.display = matchesSearch && matchesRole ? '' : 'none';
        });
    }
    
    if (adminSearchInput) {
        adminSearchInput.addEventListener('input', filterUsers);
    }
    if (adminRoleFilter) {
        adminRoleFilter.addEventListener('change', filterUsers);
    }
});

// Select all functionality
document.getElementById('selectAllActive')?.addEventListener('change', function() {
    document.querySelectorAll('input[name="selectedUsers"]').forEach(cb => {
        cb.checked = this.checked;
    });
});

document.getElementById('selectAllPending')?.addEventListener('change', function() {
    document.querySelectorAll('input[name="selectedPendingUsers"]').forEach(cb => {
        cb.checked = this.checked;
    });
});

// Get CSRF token
function getCSRFToken() {
    return document.querySelector('meta[name=csrf-token]').getAttribute('content');
}

// User management functions
function editUser(userId) {
    // Backend'den kullanıcı bilgilerini al
    fetch(`/admin/get_user_details/${userId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showEditUserModal(data.user);
            } else {
                showToast('Kullanıcı bilgileri alınamadı', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Bir hata oluştu', 'error');
        });
}

function approveUser(userId) {
    if (confirm('Bu kullanıcıyı onaylamak istediğinizden emin misiniz?')) {
        fetch(`/admin/approve_user/${userId}`, { 
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Kullanıcı başarıyla onaylandı', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Bir hata oluştu', 'error');
            }
        })
        .catch(error => showToast('Bir hata oluştu', 'error'));
    }
}

function rejectUser(userId) {
    if (confirm('Bu kullanıcıyı reddetmek istediğinizden emin misiniz?')) {
        fetch(`/admin/reject_user/${userId}`, { 
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Kullanıcı reddedildi', 'warning');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Bir hata oluştu', 'error');
            }
        })
        .catch(error => showToast('Bir hata oluştu', 'error'));
    }
}

function deleteUser(userId) {
    if (confirm('Bu kullanıcıyı kalıcı olarak silmek istediğinizden emin misiniz?')) {
        fetch(`/admin/delete_user/${userId}`, { 
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('Kullanıcı başarıyla silindi', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Bir hata oluştu', 'error');
            }
        })
        .catch(error => showToast('Bir hata oluştu', 'error'));
    }
}

function approveSelectedUsers() {
    const selectedUsers = document.querySelectorAll('input[name="selectedPendingUsers"]:checked');
    
    if (selectedUsers.length === 0) {
        showToast('Lütfen onaylanacak kullanıcıları seçin', 'warning');
        return;
    }
    
    if (confirm(`${selectedUsers.length} kullanıcıyı onaylamak istediğinizden emin misiniz?`)) {
        const userIds = Array.from(selectedUsers).map(cb => cb.value);
        
        fetch('/admin/approve_multiple_users', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            },
            body: JSON.stringify({ user_ids: userIds })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`${data.approved_count} kullanıcı başarıyla onaylandı`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast(data.message || 'Bir hata oluştu', 'error');
            }
        })
        .catch(error => showToast('Bir hata oluştu', 'error'));
    }
}

function showToast(message, type = 'success') {
    const colors = {
        'success': '#38a169',
        'error': '#e53e3e',
        'warning': '#d69e2e',
        'info': '#3182ce'
    };

    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type]};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        font-weight: 500;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;

    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

// User edit modal with advanced permissions
function showEditUserModal(user) {
    // Önce kullanıcının mevcut yetkilerini al
    fetch(`/admin/get_user_permissions/${user.id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createAdvancedModal(user, data.permissions);
            } else {
                showToast('Kullanıcı yetkileri alınamadı', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Bir hata oluştu', 'error');
        });
}

function createAdvancedModal(user, userPermissions = {}) {
    const modalHTML = `
        <div id="editUserModal" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(8px);
            overflow-y: auto;
            padding: 2rem;
        ">
            <div style="
                background: white;
                border-radius: 20px;
                padding: 2.5rem;
                width: 100%;
                max-width: 1400px;
                box-shadow: 0 25px 80px rgba(0,0,0,0.15);
                max-height: 95vh;
                overflow-y: auto;
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                    <h2 style="margin: 0; color: #2d3748; font-size: 1.5rem; font-weight: 700;">
                        <i class="material-icons" style="margin-right: 0.5rem; vertical-align: middle;">admin_panel_settings</i>
                        Kullanıcı Yetkilendirme
                    </h2>
                    <button onclick="closeEditUserModal()" style="
                        background: #dc3545;
                        border: none;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        color: white;
                    ">
                        <i class="material-icons">close</i>
                    </button>
                </div>
                
                <form id="editUserForm">
                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem; margin-bottom: 2rem;">
                        <!-- Sol Kolon: Kullanıcı Bilgileri -->
                        <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 12px;">
                            <h3 style="margin: 0 0 1rem 0; color: #2d3748; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                                <i class="material-icons">person</i> Kullanıcı Bilgileri
                            </h3>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748; font-size: 0.95rem;">Ad Soyad:</label>
                                <input type="text" value="${user.first_name} ${user.last_name}" readonly style="
                                    width: 100%;
                                    padding: 0.75rem;
                                    border: 1px solid #e9ecef;
                                    border-radius: 8px;
                                    background: #f8f9fa;
                                    color: #6c757d;
                                    font-size: 0.9rem;
                                ">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748; font-size: 0.95rem;">E-posta:</label>
                                <input type="text" value="${user.email}" readonly style="
                                    width: 100%;
                                    padding: 0.75rem;
                                    border: 1px solid #e9ecef;
                                    border-radius: 8px;
                                    background: #f8f9fa;
                                    color: #6c757d;
                                    font-size: 0.9rem;
                                ">
                            </div>

                            <div style="margin-bottom: 1.5rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #2d3748; font-size: 0.95rem;">Kullanıcı Rolü:</label>
                                <select id="userRole" onchange="applyRoleTemplate()" style="
                                    width: 100%;
                                    padding: 0.75rem;
                                    border: 2px solid #e9ecef;
                                    border-radius: 10px;
                                    font-size: 0.95rem;
                                    background: white;
                                ">
                                    <option value="Sekreter" ${user.role === 'Sekreter' ? 'selected' : ''}>📋 Sekreter</option>
                                    <option value="Takip Elemanı" ${user.role === 'Takip Elemanı' ? 'selected' : ''}>📊 Takip Elemanı</option>
                                    <option value="Muhasebe" ${user.role === 'Muhasebe' ? 'selected' : ''}>💰 Muhasebe</option>
                                    <option value="Ulaşım" ${user.role === 'Ulaşım' ? 'selected' : ''}>🚗 Ulaşım</option>
                                    <option value="Stajyer Avukat" ${user.role === 'Stajyer Avukat' ? 'selected' : ''}>🎓 Stajyer Avukat</option>
                                    <option value="Avukat" ${user.role === 'Avukat' ? 'selected' : ''}>⚖️ Avukat</option>
                                    <option value="Yönetici Avukat" ${user.role === 'Yönetici Avukat' ? 'selected' : ''}>👨‍💼 Yönetici Avukat</option>
                                </select>
                            </div>

                            <div style="margin-bottom: 1rem;">
                                <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 10px;">
                                    <input type="checkbox" id="isAdmin" ${user.is_admin ? 'checked' : ''} style="
                                        width: 20px;
                                        height: 20px;
                                        accent-color: #2d3748;
                                        cursor: pointer;
                                    ">
                                    <div>
                                        <span style="font-weight: 600; color: #2d3748; display: block;">🔐 Süper Admin Yetkisi</span>
                                        <small style="color: #6c757d;">Tüm sistem özelliklerine sınırsız erişim</small>
                                    </div>
                                </label>
                            </div>

                            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                                <button type="button" onclick="toggleAllPermissions(false)" style="
                                    padding: 0.875rem 2rem;
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 1rem;
                                ">
                                    Tümünü Kapat
                                </button>
                                <button type="button" onclick="toggleAllPermissions(true)" style="
                                    padding: 0.875rem 2rem;
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    border-radius: 10px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    font-size: 1rem;
                                ">
                                    Tümünü Aç
                                </button>
                            </div>
                        </div>

                        <!-- Sağ Kolon: Detaylı Yetki Ayarları -->
                        <div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <h3 style="margin: 0; color: #2d3748; display: flex; align-items: center; gap: 0.5rem; font-size: 1.2rem;">
                                    <i class="material-icons">security</i> Detaylı Yetki Ayarları
                                </h3>
                            </div>
                            
                            <div id="permissionsContainer" style="
                                max-height: 60vh;
                                overflow-y: auto;
                                padding-right: 1rem;
                                scrollbar-width: thin;
                                scrollbar-color: #2d3748 #f1f1f1;
                            ">
                                ${createPermissionsHTML(userPermissions)}
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1.5rem; border-top: 2px solid #e9ecef;">
                        <button type="button" onclick="closeEditUserModal()" style="
                            padding: 0.875rem 2rem;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1rem;
                        ">
                            İptal
                        </button>
                        <button type="button" onclick="saveUserSettings(${user.id})" style="
                            padding: 0.875rem 2rem;
                            background: #2d3748;
                            color: white;
                            border: none;
                            border-radius: 10px;
                            cursor: pointer;
                            font-weight: 600;
                            font-size: 1rem;
                        ">
                            Değişiklikleri Kaydet
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // CSS ekle
    const style = document.createElement('style');
    style.textContent = `
        #permissionsContainer::-webkit-scrollbar {
            width: 8px;
        }
        #permissionsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        #permissionsContainer::-webkit-scrollbar-thumb {
            background: #2d3748;
            border-radius: 4px;
        }
        #permissionsContainer::-webkit-scrollbar-thumb:hover {
            background: #1a202c;
        }
    `;
    document.head.appendChild(style);
}

function createPermissionsHTML(userPermissions) {
    const permissionCategories = {
        'Temel Erişim': [
            { key: 'ayarlar', label: 'Ayarlar', desc: 'Kullanıcı ayarları sayfasına erişebilir' },
            { key: 'iletisim', label: 'İletişim', desc: 'İletişim sayfasına erişebilir' },
            { key: 'veritabani_yonetimi', label: 'Veritabanı Yönetimi', desc: 'Veritabanı yönetimi işlemlerini yapabilir' },
            { key: 'admin_panel', label: 'Admin Panel', desc: 'Admin paneline erişebilir' },
            { key: 'kullanici_yonetimi', label: 'Kullanıcı Yönetimi', desc: 'Kullanıcıları onaylayabilir ve yönetebilir' },
            { key: 'anasayfa_son_islemler', label: 'Son İşlemler', desc: 'Anasayfa son işlemler yönetimi' }
        ],
        'Dosya Yönetimi': [
            { key: 'dosya_sorgula', label: 'Dosya Sorgulama', desc: 'Dosyaları arayabilir ve görüntüleyebilir' },
            { key: 'dosya_ekle', label: 'Dosya Ekleme', desc: 'Yeni dosya ekleyebilir' },
            { key: 'dosya_duzenle', label: 'Dosya Düzenleme', desc: 'Mevcut dosyaları düzenleyebilir' },
            { key: 'dosya_sil', label: 'Dosya Silme', desc: 'Dosyaları silebilir' }
        ],
        'Takvim ve Etkinlik Yönetimi': [
            { key: 'takvim_goruntule', label: 'Takvim Görüntüleme', desc: 'Takvim sayfasını görüntüleyebilir' },
            { key: 'etkinlik_goruntule', label: 'Etkinlik Görüntüleme', desc: 'Takvim etkinliklerini görüntüleyebilir' },
            { key: 'etkinlik_ekle', label: 'Etkinlik Ekleme', desc: 'Takvime yeni etkinlik ekleyebilir' },
            { key: 'etkinlik_duzenle', label: 'Etkinlik Düzenleme', desc: 'Mevcut etkinlikleri düzenleyebilir' },
            { key: 'etkinlik_sil', label: 'Etkinlik Silme', desc: 'Etkinlikleri silebilir' }
        ],
        'Duyuru Yönetimi': [
            { key: 'duyuru_goruntule', label: 'Duyuru Görüntüleme', desc: 'Anasayfada duyuruları görüntüleyebilir' },
            { key: 'duyuru_ekle', label: 'Duyuru Ekleme', desc: 'Yeni duyuru ekleyebilir' },
            { key: 'duyuru_duzenle', label: 'Duyuru Düzenleme', desc: 'Mevcut duyuruları düzenleyebilir' },
            { key: 'duyuru_sil', label: 'Duyuru Silme', desc: 'Duyuruları silebilir' }
        ],
        'Hesaplamalar': [
            { key: 'faiz_hesaplama', label: 'Faiz Hesaplama', desc: 'Faiz hesaplaması yapabilir' },
            { key: 'harc_hesaplama', label: 'Harç Hesaplama', desc: 'Harç hesaplaması yapabilir' },
            { key: 'isci_hesaplama', label: 'İşçi Alacağı Hesaplama', desc: 'İşçi alacağı hesaplaması yapabilir' },
            { key: 'vekalet_hesaplama', label: 'Vekalet Ücreti Hesaplama', desc: 'Vekalet ücreti hesaplaması yapabilir' },
            { key: 'ceza_infaz_hesaplama', label: 'Ceza İnfaz Hesaplama', desc: 'Ceza infaz hesaplaması yapabilir' }
        ],
        'Formlar/Dilekçeler': [
            { key: 'ornek_dilekceler', label: 'Dilekçe Şablonları', desc: 'Dilekçe şablonlarına erişebilir ve yönetebilir' },
            { key: 'isci_gorusme_goruntule', label: 'İşçi Görüşme Formu', desc: 'İşçi görüşme formlarına erişebilir, ekleyebilir, düzenleyebilir ve silebilir' },
            { key: 'ornek_sozlesmeler', label: 'Avukatlık Sözleşmesi', desc: 'Avukatlık sözleşmelerine erişebilir ve yönetebilir' },
            { key: 'vekaletname', label: 'Vekaletname', desc: 'Vekaletname örneğine erişebilir ve yönetebilir' }
        ],
        'Sistem Araçları': [
            { key: 'ai_avukat', label: 'AI Avukat', desc: 'AI Avukat sistemini kullanabilir' },
            { key: 'yargi_kararlari_arama', label: 'Yargı Kararları Arama', desc: 'Yargı kararlarında arama yapabilir' },
            { key: 'ucret_tarifeleri', label: 'Ücret Tarifelerine Erişim', desc: 'Ücret tarifelerine erişebilir' }
        ],
        'Müvekkil Ödeme Yönetimi': [
            { key: 'odeme_goruntule', label: 'Müvekkil Ödeme Görüntüleme', desc: 'Ödemeler sayfasını görüntüleyebilir, işçi görüşme formlarına erişebilir, ödeme detayları görebilir, müvekkil arama yapabilir' },
            { key: 'odeme_ekle', label: 'Müvekkil Ödeme Ekleme', desc: 'Yeni müvekkil ödemesi ekleyebilir' },
            { key: 'odeme_duzenle', label: 'Müvekkil Ödeme Düzenleme', desc: 'Mevcut müvekkil ödeme kayıtlarını düzenleyebilir' },
            { key: 'odeme_sil', label: 'Müvekkil Ödeme Silme', desc: 'Müvekkil ödeme kayıtlarını silebilir' },
            { key: 'odeme_istatistik_goruntule', label: 'Müvekkil Ödeme İstatistikleri', desc: 'Ödeme istatistiklerini görüntüleyebilir' }
        ]
    };

    let html = '';
    
    Object.entries(permissionCategories).forEach(([categoryName, permissions]) => {
        const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_').replace(/ü/g, 'u').replace(/ğ/g, 'g').replace(/ı/g, 'i').replace(/ö/g, 'o').replace(/ç/g, 'c').replace(/ş/g, 's');
        html += `
            <div style="
                background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
                border: 2px solid #dee2e6;
                border-radius: 15px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: #2d3748; font-size: 1.1rem; font-weight: 700;">
                        ${getCategoryIcon(categoryName)} ${categoryName}
                    </h4>
                    <div>
                        <button type="button" onclick="toggleGroupPermissions('${categoryKey}', true)" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            margin-right: 0.5rem;
                            cursor: pointer;
                            font-size: 0.85rem;
                            font-weight: 600;
                        ">Tümü</button>
                        <button type="button" onclick="toggleGroupPermissions('${categoryKey}', false)" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 0.5rem 1rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 0.85rem;
                            font-weight: 600;
                        ">Hiçbiri</button>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                    ${permissions.map(perm => `
                        <label style="
                            display: flex;
                            align-items: flex-start;
                            gap: 0.75rem;
                            padding: 0.75rem;
                            background: white;
                            border: 1px solid #dee2e6;
                            border-radius: 10px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                        " onmouseover="this.style.borderColor='#2d3748'; this.style.transform='translateY(-2px)'" onmouseout="this.style.borderColor='#dee2e6'; this.style.transform='translateY(0)'">
                            <input type="checkbox" 
                                   name="permission_${perm.key}" 
                                   data-category="${categoryKey}"
                                   ${userPermissions[perm.key] ? 'checked' : ''} 
                                   style="
                                       width: 18px;
                                       height: 18px;
                                       accent-color: #2d3748;
                                       cursor: pointer;
                                       margin-top: 2px;
                                   ">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2d3748; margin-bottom: 0.25rem; font-size: 0.9rem;">
                                    ${perm.label}
                                </div>
                                <div style="font-size: 0.8rem; color: #6c757d; line-height: 1.4;">
                                    ${perm.desc}
                                </div>
                            </div>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    });
    
    return html;
}

function getCategoryIcon(categoryName) {
    const icons = {
        'Temel Erişim': '🏠',
        'Dosya Yönetimi': '📁',
        'Takvim ve Etkinlik Yönetimi': '📅',
        'Duyuru Yönetimi': '📢',
        'Hesaplamalar': '🧮',
        'Formlar/Dilekçeler': '📝',
        'Sistem Araçları': '🛠️',
        'Müvekkil Ödeme Yönetimi': '💰'
    };
    return icons[categoryName] || '📋';
}

function closeEditUserModal() {
    document.getElementById('editUserModal')?.remove();
}

// Rol şablonu uygulama fonksiyonu
function applyRoleTemplate() {
    const selectedRole = document.getElementById('userRole').value;
    
    // Önce tüm yetkileri temizle
    document.querySelectorAll('input[name^="permission_"]').forEach(cb => {
        cb.checked = false;
    });
    
    // Rol bazında yetki şablonları
    const roleTemplates = {
        'Sekreter': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'etkinlik_goruntule',
            'etkinlik_ekle', 'etkinlik_duzenle', 'duyuru_ekle', 'duyuru_duzenle', 
            'odeme_goruntule', 'odeme_ekle', 'dosya_sorgula', 'faiz_hesaplama', 
            'harc_hesaplama', 'ornek_dilekceler', 'ornek_sozlesmeler', 'ucret_tarifeleri',
            'isci_gorusme_goruntule', 'isci_gorusme_ekle', 'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Takip Elemanı': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'etkinlik_goruntule',
            'dosya_sorgula', 'dosya_ekle', 'dosya_duzenle', 'etkinlik_ekle', 'etkinlik_duzenle', 
            'odeme_goruntule', 'odeme_ekle', 'odeme_duzenle', 'faiz_hesaplama', 
            'harc_hesaplama', 'vekalet_hesaplama', 'isci_hesaplama', 'ornek_dilekceler', 
            'ornek_sozlesmeler', 'ucret_tarifeleri', 'isci_gorusme_goruntule', 'isci_gorusme_ekle',
            'isci_gorusme_duzenle', 'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Muhasebe': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'etkinlik_goruntule',
            'odeme_goruntule', 'odeme_ekle', 'odeme_duzenle', 'odeme_sil', 'odeme_istatistik_goruntule',
            'dosya_sorgula', 'faiz_hesaplama', 'harc_hesaplama', 'vekalet_hesaplama', 
            'isci_hesaplama', 'ucret_tarifeleri', 'rapor_goruntule', 'rapor_olustur',
            'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Ulaşım': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'etkinlik_goruntule',
            'etkinlik_ekle', 'etkinlik_duzenle', 'dosya_sorgula', 'ucret_tarifeleri',
            'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Stajyer Avukat': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'etkinlik_goruntule',
            'odeme_goruntule', 'dosya_sorgula', 'dosya_ekle', 'etkinlik_ekle', 
            'faiz_hesaplama', 'harc_hesaplama', 'vekalet_hesaplama', 'isci_hesaplama', 
            'ceza_infaz_hesaplama', 'ornek_dilekceler', 'ornek_sozlesmeler', 'yargi_kararlari_arama', 
            'ucret_tarifeleri', 'isci_gorusme_goruntule', 'isci_gorusme_ekle', 'ai_avukat',
            'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Avukat': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'duyuru_ekle', 'duyuru_duzenle',
            'etkinlik_goruntule', 'etkinlik_ekle', 'etkinlik_duzenle', 'etkinlik_sil',
            'odeme_goruntule', 'odeme_ekle', 'odeme_duzenle', 'dosya_sorgula', 'dosya_ekle', 
            'dosya_duzenle', 'dosya_sil', 'dosyalarim', 'faiz_hesaplama', 'harc_hesaplama', 
            'vekalet_hesaplama', 'isci_hesaplama', 'ceza_infaz_hesaplama', 'ornek_dilekceler', 
            'ornek_sozlesmeler', 'yargi_kararlari_arama', 'ucret_tarifeleri', 'ai_avukat',
            'isci_gorusme_goruntule', 'isci_gorusme_ekle', 'isci_gorusme_duzenle', 'isci_gorusme_sil',
            'musteri_goruntule', 'musteri_ekle', 'musteri_duzenle', 'rapor_goruntule',
            'ayarlar', 'iletisim', 'bildirimler'
        ],
        'Yönetici Avukat': [
            'panel_goruntule', 'takvim_goruntule', 'duyuru_goruntule', 'duyuru_ekle', 'duyuru_duzenle', 'duyuru_sil',
            'etkinlik_goruntule', 'etkinlik_ekle', 'etkinlik_duzenle', 'etkinlik_sil',
            'odeme_goruntule', 'odeme_ekle', 'odeme_duzenle', 'odeme_sil', 'odeme_istatistik_goruntule',
            'dosya_sorgula', 'dosya_ekle', 'dosya_duzenle', 'dosya_sil', 'dosyalarim',
            'faiz_hesaplama', 'harc_hesaplama', 'vekalet_hesaplama', 'isci_hesaplama', 'ceza_infaz_hesaplama',
            'ornek_dilekceler', 'ornek_sozlesmeler', 'yargi_kararlari_arama', 'ucret_tarifeleri', 'ai_avukat',
            'isci_gorusme_goruntule', 'isci_gorusme_ekle', 'isci_gorusme_duzenle', 'isci_gorusme_sil',
            'musteri_goruntule', 'musteri_ekle', 'musteri_duzenle', 'musteri_sil',
            'rapor_goruntule', 'rapor_olustur', 'kullanici_yonetimi', 'bildirimler',
            'veritabani_yonetimi', 'admin_panel', 'kullanici_onaylama', 'ayarlar', 'iletisim'
        ]
    };
    
    const rolePermissions = roleTemplates[selectedRole] || [];
    
    // Seçili role ait yetkileri işaretle
    rolePermissions.forEach(permission => {
        const checkbox = document.querySelector(`input[name="permission_${permission}"]`);
        if (checkbox) {
            checkbox.checked = true;
        }
    });
    
    showToast(`${selectedRole} rol şablonu uygulandı`, 'success');
}

// Tüm yetkileri aç/kapat
function toggleAllPermissions(enable) {
    document.querySelectorAll('input[name^="permission_"]').forEach(cb => {
        cb.checked = enable;
    });
    
    showToast(enable ? 'Tüm yetkiler açıldı' : 'Tüm yetkiler kapatıldı', 'info');
}

// Kategori bazında yetki aç/kapat
function toggleGroupPermissions(categoryKey, enable) {
    document.querySelectorAll(`input[data-category="${categoryKey}"]`).forEach(cb => {
        cb.checked = enable;
    });
    
    const categoryName = categoryKey.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    showToast(`${categoryName} kategorisi ${enable ? 'açıldı' : 'kapatıldı'}`, 'info');
}

// Kullanıcı ayarlarını kaydet
function saveUserSettings(userId) {
    const role = document.getElementById('userRole').value;
    const isAdmin = document.getElementById('isAdmin').checked;
    
    // Tüm yetkileri topla
    const permissions = {};
    document.querySelectorAll('input[name^="permission_"]').forEach(cb => {
        const permissionKey = cb.name.replace('permission_', '');
        permissions[permissionKey] = cb.checked;
    });
    
    const data = {
        role: role,
        is_admin: isAdmin,
        permissions: permissions
    };
    
    fetch(`/admin/update_user_permissions/${userId}`, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Kullanıcı yetkileri başarıyla güncellendi', 'success');
            closeEditUserModal();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.message || 'Bir hata oluştu', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Bir hata oluştu', 'error');
    });
}

// Animation styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %} 