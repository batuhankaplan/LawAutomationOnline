{% extends "layout.html" %}

{% block title %}Takvim{% endblock %}

{% block content %}
<script>
// Verileri global kapsama yakın tanımla
    const events = {{ events|tojson|safe }};
    const allCourthousesData = {{ all_courthouses | tojson | safe }};
const userPermissions = {{ user_permissions | tojson | safe }}; // Yetkileri de alalım

document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    
    const months = [
        'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
        'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
    ];

    const eventTypes = {
        'durusma': 'Duruşma',
        'e-durusma': 'E-Duruşma',
        'tahliye': 'Tahliye',
        'is': 'Yapılacak İş',
        'randevu': 'Randevu',
        'gunluk-kayit': 'Günlük Kayıt',
        'diger': 'Diğer'
    };

    // DOM Elementleri
    const eventTypeSelect = document.getElementById('eventType');
        const hearingDetailsSection = document.getElementById('hearingDetailsSection');
    const fileTypeSelect = document.getElementById('fileType');
    const citySelect = document.getElementById('city'); // Şehir select'i eklenecek
    const courthouseSelect = document.getElementById('courthouse');
    const departmentSelect = document.getElementById('department');
    const eventModal = document.getElementById('eventModal');
    const eventForm = document.getElementById('eventForm');
    const selectedDateInput = document.getElementById('selectedDate');
        const assignedToGroup = document.getElementById('assignedToGroup');
        const isCompletedGroup = document.getElementById('isCompletedGroup');
    const modalTitle = document.getElementById('modalTitle');
    const eventDetailModal = document.getElementById('eventDetailModal');
    const eventListModal = document.getElementById('eventListModal');
    const calendarGrid = document.getElementById('calendar-grid');
    const currentMonthLabel = document.getElementById('currentMonth');
    const currentYearLabel = document.getElementById('currentYear');

    // İstanbul'a özel adliyeler
    const istanbulSpecificCourthouses = [
        "İstanbul Anadolu Adliyesi (Kartal)",
        "İstanbul Adliyesi (Çağlayan)",
        "Bakırköy Adliyesi",
        "Büyükçekmece Adliyesi",
        "Gaziosmanpaşa Adliyesi",
        "Küçükçekmece Adliyesi",
        "Silivri Adliyesi",
        "Çatalca Adliyesi",
        "Üsküdar Adliyesi", // Bu adliyeler genellikle ayrıdır, kontrol edilebilir
        "Adalar Adliyesi",
        "Sarıyer Adliyesi" // Ekstra kontrol edilebilir
    ];

    // Resmi tatiller ve özel günler
    const holidays = {
        '2024-01-01': 'Yılbaşı',
        '2024-04-10': 'Ramazan Bayramı',
        '2024-04-11': 'Ramazan Bayramı',
        '2024-04-12': 'Ramazan Bayramı',
        '2024-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2024-05-01': 'Emek ve Dayanışma Günü',
        '2024-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2024-06-15': 'Kurban Bayramı Arefesi',
        '2024-06-16': 'Kurban Bayramı',
        '2024-06-17': 'Kurban Bayramı',
        '2024-06-18': 'Kurban Bayramı',
        '2024-06-19': 'Kurban Bayramı',
        '2024-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2024-08-30': 'Zafer Bayramı',
        '2024-10-29': 'Cumhuriyet Bayramı',
        '2025-01-01': 'Yılbaşı',
        '2025-03-31': 'Ramazan Bayramı',
        '2025-04-01': 'Ramazan Bayramı',
        '2025-04-02': 'Ramazan Bayramı',
        '2025-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2025-05-01': 'Emek ve Dayanışma Günü',
        '2025-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2025-06-06': 'Kurban Bayramı Arefesi',
        '2025-06-07': 'Kurban Bayramı',
        '2025-06-08': 'Kurban Bayramı',
        '2025-06-09': 'Kurban Bayramı',
        '2025-06-10': 'Kurban Bayramı',
        '2025-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2025-08-30': 'Zafer Bayramı',
        '2025-10-29': 'Cumhuriyet Bayramı',
        // 2026 yılı resmi tatilleri
        '2026-01-01': 'Yılbaşı Tatili',
        '2026-03-19': 'Ramazan Bayramı Arifesi (Yarım Gün)',
        '2026-03-20': 'Ramazan Bayramı 1. Gün',
        '2026-03-21': 'Ramazan Bayramı 2. Gün',
        '2026-03-22': 'Ramazan Bayramı 3. Gün',
        '2026-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2026-05-01': 'Emek ve Dayanışma Günü',
        '2026-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2026-05-26': 'Kurban Bayramı Arifesi (Yarım Gün)',
        '2026-05-27': 'Kurban Bayramı 1. Gün',
        '2026-05-28': 'Kurban Bayramı 2. Gün',
        '2026-05-29': 'Kurban Bayramı 3. Gün',
        '2026-05-30': 'Kurban Bayramı 4. Gün',
        '2026-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2026-08-30': 'Zafer Bayramı',
        '2026-10-28': 'Cumhuriyet Bayramı Arifesi',
        '2026-10-29': 'Cumhuriyet Bayramı',
        // Diğer yıllar için de eklenebilir
    };

    // --- Yardımcı Fonksiyonlar ---

    function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function isAdliTatil(date) {
        const month = date.getMonth();
        const day = date.getDate();
        // Temmuz 20'den 31 Ağustos'a kadar (dahil)
        return (month === 6 && day >= 20) || (month === 7);
    }

    // Adliyeye göre şehri bulma fonksiyonu
    function findCityForCourthouse(courthouseName) {
        if (!courthouseName) return null;
        // Önce İstanbul özel listesini kontrol et
        if (istanbulSpecificCourthouses.includes(courthouseName)) {
            return 'İstanbul';
        }
        // Sonra genel listede ara
        for (const city in allCourthousesData) {
            if (allCourthousesData[city].includes(courthouseName)) {
                return city;
            }
        }
        return null; // Bulunamadı
    }

    // --- Form Alanı Yönetimi ---

    // Şehir select elementini oluştur ve ekle
    function addCitySelect() {
        if (document.getElementById('citySelectGroup')) return; // Zaten varsa ekleme

        const cityOptions = Object.keys(allCourthousesData)
                                .sort((a, b) => a.localeCompare(b, 'tr')) // Alfabetik sırala
                                .map(city => `<option value="${city}">${city}</option>`)
                                .join('');

        const citySelectHtml = `
            <div class="form-group full-width hidden-section" id="citySelectGroup"> <!-- Başlangıçta gizli -->
                <label for="city">Şehir</label>
                <div class="select-wrapper">
                    <select id="city" name="city">
                        <option value="">Seçiniz</option>
                        ${cityOptions}
                    </select>
                </div>
            </div>
        `;
        // Adliye grubundan önce ekle
        const courthouseGroup = courthouseSelect.closest('.form-group');
        if (courthouseGroup) {
            courthouseGroup.insertAdjacentHTML('beforebegin', citySelectHtml);
            // Yeni eklenen city elementini değişkene ata
            const newCitySelect = document.getElementById('city');
            if (newCitySelect) {
                newCitySelect.addEventListener('change', handleCityChange);
            }
            } else {
            console.error("Adliye formu grubu bulunamadı!");
        }
    }

    function toggleFormFields() {
        const eventType = eventTypeSelect.value;
        const isHearing = eventType === 'durusma' || eventType === 'e-durusma';
        const isGunlukKayit = eventType === 'gunluk-kayit';
        const citySelectGroup = document.getElementById('citySelectGroup');
        const gunlukKayitDetailsSection = document.getElementById('gunlukKayitDetailsSection');

        console.log('toggleFormFields called with eventType:', eventType, 'isGunlukKayit:', isGunlukKayit);

        hearingDetailsSection.style.display = isHearing ? 'block' : 'none';
        if (gunlukKayitDetailsSection) {
            gunlukKayitDetailsSection.style.display = isGunlukKayit ? 'block' : 'none';
        }
        if (citySelectGroup) {
            citySelectGroup.style.display = isHearing ? 'block' : 'none';
        }

        fileTypeSelect.required = isHearing;
        // citySelect ve courthouseSelect şehir seçimine göre required olacak
        courthouseSelect.required = isHearing; // Şimdilik true, şehir seçimi bunu etkileyebilir
        departmentSelect.required = isHearing;

        // Günlük Kayıt için gereksiz alanları gizle/göster
        const titleGroup = document.getElementById('eventTitle').closest('.form-group');
        const timeGroup = document.getElementById('eventTime').closest('.form-group');
        const assignedToGroup = document.getElementById('assignedToGroup');
        const isCompletedGroup = document.getElementById('isCompletedGroup');
        
        console.log('DOM elements found - assignedToGroup:', !!assignedToGroup, 'isCompletedGroup:', !!isCompletedGroup);
        
        if (isGunlukKayit) {
            console.log('Hiding fields for Günlük Kayıt');
            // Günlük Kayıt seçildiğinde bu alanları gizle
            if (titleGroup) {
                titleGroup.style.setProperty('display', 'none', 'important');
                console.log('Title group hidden');
            }
            if (timeGroup) {
                timeGroup.style.setProperty('display', 'none', 'important');
                console.log('Time group hidden');
            }
            if (assignedToGroup) {
                assignedToGroup.style.setProperty('display', 'none', 'important');
                console.log('AssignedTo group hidden');
            }
            if (isCompletedGroup) {
                isCompletedGroup.style.setProperty('display', 'none', 'important');
                console.log('IsCompleted group hidden');
            }
            
            // Required alanları kaldır
            document.getElementById('eventTitle').required = false;
            document.getElementById('eventTime').required = false;
            // AssignedTo artık hiçbir zaman required değil
        } else {
            console.log('Showing fields for other event types');
            // Diğer etkinlik türlerinde bu alanları göster
            if (titleGroup) titleGroup.style.setProperty('display', 'block', 'important');
            if (timeGroup) timeGroup.style.setProperty('display', 'block', 'important');
            if (assignedToGroup) assignedToGroup.style.setProperty('display', 'block', 'important');
            if (isCompletedGroup) isCompletedGroup.style.setProperty('display', 'block', 'important');
            
            // Required alanları geri koy
            document.getElementById('eventTitle').required = true;
            document.getElementById('eventTime').required = true;
            // AssignedTo artık hiçbir zaman required değil
        }

        // Arabuluculuk, AİHM, AYM kontrolü
        const fileType = fileTypeSelect.value.toLowerCase();
        const disableCourthouseAndCity = ['arabuluculuk', 'aihm', 'aym'].includes(fileType);

        if (citySelectGroup) {
            citySelectGroup.style.display = isHearing && !disableCourthouseAndCity ? 'block' : 'none';
            const cityElement = document.getElementById('city');
            if (cityElement) {
                 cityElement.required = isHearing && !disableCourthouseAndCity;
                 cityElement.disabled = !isHearing || disableCourthouseAndCity;
            }
        }
        const courthouseGroup = courthouseSelect.closest('.form-group');
        if(courthouseGroup) {
            courthouseGroup.style.display = isHearing && !disableCourthouseAndCity ? 'block' : 'none';
            courthouseSelect.required = isHearing && !disableCourthouseAndCity;
            courthouseSelect.disabled = !isHearing || disableCourthouseAndCity;
        }
         const departmentGroup = departmentSelect.closest('.form-group');
        if(departmentGroup) {
            departmentGroup.style.display = isHearing && !disableCourthouseAndCity ? 'block' : 'none';
             departmentSelect.required = isHearing && !disableCourthouseAndCity;
             departmentSelect.disabled = !isHearing || disableCourthouseAndCity;
        }


        if (disableCourthouseAndCity) {
            const cityElement = document.getElementById('city');
            if (cityElement) cityElement.value = '';
            courthouseSelect.value = '';
            departmentSelect.value = '';
        }


        // Atanan Kişi ve Tamamlandı alanlarını yalnızca Günlük Kayıt değilse göster
        assignedToGroup.style.display = isGunlukKayit ? 'none' : 'block';
        isCompletedGroup.style.display = isGunlukKayit ? 'none' : 'block';
    }


    // --- Dropdown Güncelleme Fonksiyonları ---

    function updateCourthouses() {
        const citySelect = document.getElementById('city'); // Elementi tekrar al
        if (!citySelect) return;

        const selectedCity = citySelect.value;
        
        // Adliye seçeneklerini temizle
        courthouseSelect.innerHTML = '<option value="">Seçiniz</option>';
        departmentSelect.innerHTML = '<option value="">Seçiniz</option>'; // Birimleri de temizle
        
        if (!selectedCity) return;

        let cityCourthouses = [];
        // İstanbul özel durumu
        if (selectedCity === 'İstanbul') {
            cityCourthouses = [...istanbulSpecificCourthouses];
            // allCourthousesData'daki İstanbul adliyelerini de ekleyebiliriz, eğer varsa ve farklıysa
            if (allCourthousesData[selectedCity]) {
                 allCourthousesData[selectedCity].forEach(ch => {
                     if (!cityCourthouses.includes(ch)) {
                         cityCourthouses.push(ch);
                     }
                 });
            }
        } else if (allCourthousesData[selectedCity]) {
            cityCourthouses = allCourthousesData[selectedCity];
        }

        cityCourthouses.sort((a,b) => a.localeCompare(b, 'tr')); // Alfabetik sırala

        cityCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });

         if (courthouseSelect.options.length <= 1) {
             courthouseSelect.innerHTML = '<option value="">Bu şehir için adliye bulunamadı</option>';
         }
    }

    function updateDepartments() {
        const citySelect = document.getElementById('city');
        if (!citySelect) return;
        const selectedCity = citySelect.value;
        const selectedCourthouse = courthouseSelect.value;
        const selectedFileType = fileTypeSelect.value.toLowerCase();
        
        departmentSelect.innerHTML = '<option value="">Seçiniz</option>';
        
        if (!selectedCity || !selectedCourthouse || !selectedFileType) {
            departmentSelect.innerHTML = '<option value="">Önce Dosya Türü, Şehir ve Adliye Seçiniz</option>';
            return;
        }

        let departments = [];
        if (selectedFileType === 'hukuk') {
            departments = [
                'Asliye Hukuk Mahkemesi', 'Sulh Hukuk Mahkemesi', 'İş Mahkemesi',
                'Aile Mahkemesi', 'Ticaret Mahkemesi', 'İcra Hukuk Mahkemesi',
                'Tüketici Mahkemesi', 'Fikri ve Sınai Haklar Mahkemesi'
            ];
        } else if (selectedFileType === 'ceza') {
            departments = [
                'Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği'
            ];
        } else if (selectedFileType === 'icra') {
            departments = ['İcra Dairesi'];
        }

        departments.forEach(dep => {
                const option = document.createElement('option');
            option.value = dep;
            option.textContent = dep;
                departmentSelect.appendChild(option);
            });

        // Numaralı mahkeme/daire ekleme (Opsiyonel, geliştirilebilir)
        // Örnek: İstanbul, Ankara, İzmir için
        const majorCities = ['İstanbul', 'Ankara', 'İzmir'];
        if (majorCities.includes(selectedCity)) {
             let maxNumber = 30; // Varsayılan
            // Adliyeye göre maxNumber ayarlanabilir (örn. Çağlayan, Anadolu için daha fazla)
             if (selectedFileType !== 'icra') { // Ceza ve Hukuk için
                 for (let i = 1; i <= maxNumber; i++) {
                     departments.forEach(baseDep => {
                const option = document.createElement('option');
                         option.value = `${i}. ${baseDep}`;
                         option.textContent = `${i}. ${baseDep}`;
                departmentSelect.appendChild(option);
            });
                 }
             } else { // İcra için
                 for (let i = 1; i <= maxNumber; i++) {
            const option = document.createElement('option');
                     option.value = `${i}. İcra Dairesi`;
                     option.textContent = `${i}. İcra Dairesi`;
            departmentSelect.appendChild(option);
                 }
             }
        }
    }

    // --- Olay Dinleyici Handler Fonksiyonları ---

    function handleCityChange() {
        updateCourthouses();
    }

    function handleCourthouseChange() {
        updateDepartments();
    }

    function handleFileTypeChange() {
         toggleFormFields(); // Şehir/Adliye görünürlüğünü ayarla
         updateDepartments();
    }

    function handleEventTypeChange() {
        toggleFormFields();
        
        // Update title placeholder based on event type
        const titleInput = document.getElementById('eventTitle');
        if (eventTypeSelect.value === 'durusma' || eventTypeSelect.value === 'e-durusma') {
            titleInput.placeholder = 'Müvekkil (Esas Numarası)';
        } else if (eventTypeSelect.value === 'gunluk-kayit') {
            titleInput.placeholder = 'Günlük kayıt başlığı';
        } else {
            titleInput.placeholder = 'Etkinlik başlığı';
        }
        
        // Duruşma/E-Duruşma seçilince şehir/adliye/birim doldurma mantığı gerekirse buraya eklenebilir
        if (eventTypeSelect.value === 'durusma' || eventTypeSelect.value === 'e-durusma') {
            // updateCourthouses(); // Şehir seçilmeden adliye güncellenmez
        } else {
            // Diğer etkinlik türleri için dosya bilgilerini temizle (opsiyonel)
             fileTypeSelect.value = '';
             const cityElement = document.getElementById('city');
             if (cityElement) cityElement.value = '';
             courthouseSelect.value = '';
             departmentSelect.value = '';
        }
    }


    // --- Takvim Oluşturma ---

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        currentMonthLabel.textContent = months[month];
        currentYearLabel.textContent = year;
        
        calendarGrid.innerHTML = ''; // Takvimi temizle
        
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        
        let startDayOfWeek = firstDayOfMonth.getDay(); // 0 (Pazar) - 6 (Cumartesi)
        if (startDayOfWeek === 0) startDayOfWeek = 7; // Pazartesi 1 olsun
        startDayOfWeek--; // Pazartesi 0 olsun
        
        // Önceki ayın günleri için boş hücreler
        for (let i = 0; i < startDayOfWeek; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendarGrid.appendChild(emptyDiv);
        }
        
        // Bu ayın günleri
        for (let day = 1; day <= lastDayOfMonth.getDate(); day++) {
            const date = new Date(year, month, day);
            calendarGrid.appendChild(createDayElement(date));
        }

        // Sonraki ayın günleri için boş hücreler
        const totalCells = startDayOfWeek + lastDayOfMonth.getDate();
        const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
        for (let i = 0; i < remainingCells; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendarGrid.appendChild(emptyDiv);
        }
    }

    function createDayElement(date) {
        const div = document.createElement('div');
        div.className = 'calendar-day';
        const dateStr = formatDateForAPI(date);
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        div.appendChild(dayNumber);
        
        // Görüntüle Butonu (Belge ikonu)
        const viewEventsBtn = document.createElement('button');
        viewEventsBtn.className = 'view-events-btn';
        viewEventsBtn.innerHTML = '<i class="material-icons">description</i>';
        viewEventsBtn.onclick = (e) => { e.stopPropagation(); showEventList(date); };
        div.appendChild(viewEventsBtn);
        
        // Ekle Butonu (Artı ikonu) - Sadece yetkisi varsa
        if (hasPermission('etkinlik_ekle')) {
        const addEventBtn = document.createElement('button');
        addEventBtn.className = 'add-day-event-btn';
        addEventBtn.innerHTML = '<i class="material-icons">add</i>';
            addEventBtn.onclick = (e) => { e.stopPropagation(); showModal(date, false); };
        div.appendChild(addEventBtn);
        }


        // CSS Sınıfları
        const dayOfWeek = date.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) div.classList.add('weekend');
        if (date.toDateString() === new Date().toDateString()) div.classList.add('today');
        if (holidays[dateStr]) {
            div.classList.add('holiday');
            const holidayName = document.createElement('div');
            holidayName.className = 'holiday-name';
            holidayName.textContent = holidays[dateStr];
            div.appendChild(holidayName);
        }
        if (isAdliTatil(date)) {
            div.classList.add('adli-tatil');
             if (!holidays[dateStr]) { // Eğer resmi tatil değilse 'Adli Tatil' yaz
                const adliTatilText = document.createElement('div');
                 adliTatilText.className = 'holiday-name'; // Aynı stili kullanabiliriz
                adliTatilText.textContent = 'Adli Tatil';
                div.appendChild(adliTatilText);
            }
        }


        // Etkinlikleri listele
        const dayEvents = events.filter(e => e.date === dateStr);
        if (dayEvents.length > 0) {
            const eventListDiv = document.createElement('div');
            eventListDiv.className = 'event-list';
            
            dayEvents.sort((a, b) => (a.time || '').localeCompare(b.time || '')); // Saate göre sırala
            
            dayEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'calendar-event';
                eventDiv.setAttribute('data-type', event.event_type);
                if (event.is_completed) eventDiv.classList.add('completed');
                
                const eventContent = document.createElement('div');
                eventContent.className = 'event-content';
                
                const timeAndType = document.createElement('div');
                timeAndType.className = 'time-and-type';
                if (event.event_type === 'gunluk-kayit') {
                    timeAndType.textContent = `${eventTypes[event.event_type] || 'Bilinmeyen'}`;
                } else {
                    timeAndType.textContent = `${event.time || ''} / ${eventTypes[event.event_type] || 'Bilinmeyen'}`;
                }

                const assignedToDiv = document.createElement('div');
                assignedToDiv.className = 'assigned-to';
                if (event.event_type === 'gunluk-kayit') {
                    assignedToDiv.textContent = ''; // Günlük Kayıt için atanan kişi gösterme
                } else {
                    assignedToDiv.textContent = event.assigned_to || '';
                }
                
                eventContent.appendChild(timeAndType);
                eventContent.appendChild(assignedToDiv);
                eventDiv.appendChild(eventContent);
                
                // Detayları göstermek için tıklama olayı - Sadece görüntüleme yetkisi varsa
                if(hasPermission('etkinlik_goruntule')) {
                    eventDiv.onclick = (e) => { e.stopPropagation(); showEventDetail(event); };
                } else {
                    eventDiv.style.cursor = 'default'; // Tıklanamaz göster
                }


                eventListDiv.appendChild(eventDiv);
            });
            div.appendChild(eventListDiv);
        }

        // Güne tıklayınca modal açma (ekleme yetkisi varsa)
        if (hasPermission('etkinlik_ekle')) {
            div.onclick = () => showModal(date, false);
        }

        
        return div;
    }

    // --- Modal Yönetimi ---

    function showModal(date, showDatePicker = false, eventToEdit = null) {
        eventForm.reset(); // Formu temizle
        eventForm.removeAttribute('data-event-id');
        modalTitle.textContent = eventToEdit ? 'Etkinliği Düzenle' : 'Yeni Etkinlik';

        // Tarih ayarla
        selectedDateInput.value = formatDateForAPI(date || new Date());

        // Tarih seçici görünürlüğü
        selectedDateInput.closest('.form-group').style.display = showDatePicker ? 'block' : 'none';
        selectedDateInput.required = showDatePicker;
        
        // Saat ayarla (varsayılan veya düzenlenecek etkinlikten)
        document.getElementById('eventTime').value = eventToEdit?.time || '09:00';

        if (eventToEdit) {
            // Düzenleme modunda formu doldur
            eventForm.setAttribute('data-event-id', eventToEdit.id);
            document.getElementById('eventType').value = eventToEdit.event_type;
            document.getElementById('eventTitle').value = eventToEdit.title;
            document.getElementById('eventDescription').value = eventToEdit.description || '';
            document.getElementById('assignedTo').value = eventToEdit.assigned_to || ''; // Varsayılan olarak atanmamış
            document.getElementById('isCompleted').checked = eventToEdit.is_completed;

            // Duruşma bilgileri (eğer varsa)
             if (eventToEdit.event_type === 'durusma' || eventToEdit.event_type === 'e-durusma') {
                 document.getElementById('fileType').value = eventToEdit.file_type || '';

                 // 1. Şehri Bul ve Seç
                 const city = findCityForCourthouse(eventToEdit.courthouse);
                 const cityElement = document.getElementById('city');
                 if (city && cityElement) {
                     cityElement.value = city;
                     // Şehir değiştiğinde adliyelerin güncellenmesi için olayı tetikle
                     // updateCourthouses fonksiyonunu doğrudan çağırmak daha güvenli olabilir
                     updateCourthouses(); // Fonksiyonu çağır
                     // cityElement.dispatchEvent(new Event('change')); 
                 } else {
                     // Şehir bulunamadıysa veya element yoksa adliye/birim seçilemez
                      if (cityElement) cityElement.value = ''; // Şehri temizle
                      courthouseSelect.innerHTML = '<option value="">Şehir Seçiniz</option>';
                      departmentSelect.innerHTML = '<option value="">Adliye Seçiniz</option>';
                 }

                 // 2. Adliyeyi Seç (Adliye listesi güncellendikten sonra)
                 if (eventToEdit.courthouse) {
                     // Seçeneğin listede olduğundan emin ol
                     let courthouseOptionExists = Array.from(courthouseSelect.options).some(opt => opt.value === eventToEdit.courthouse);
                     if (!courthouseOptionExists) {
                         const newOption = document.createElement('option');
                         newOption.value = eventToEdit.courthouse;
                         newOption.textContent = eventToEdit.courthouse;
                         courthouseSelect.appendChild(newOption);
                     }
                     courthouseSelect.value = eventToEdit.courthouse;
                     // Adliye değiştiğinde birimlerin güncellenmesi için olayı tetikle
                     // updateDepartments fonksiyonunu doğrudan çağırmak daha güvenli olabilir
                     updateDepartments(); // Fonksiyonu çağır
                     // courthouseSelect.dispatchEvent(new Event('change'));
                 } else {
                      courthouseSelect.value = ''; // Adliye yoksa temizle
                      departmentSelect.innerHTML = '<option value="">Adliye Seçiniz</option>';
                 }


                 // 3. Mahkeme/Birimi Seç (Birim listesi güncellendikten sonra)
                  if (eventToEdit.department) {
                     // Numaralı mahkeme/birim listede olmayabilir, kontrol edip ekleyelim
                     let departmentOptionExists = Array.from(departmentSelect.options).some(opt => opt.value === eventToEdit.department);
                     if (!departmentOptionExists) {
                         const newOption = document.createElement('option');
                         newOption.value = eventToEdit.department;
                         newOption.textContent = eventToEdit.department;
                         departmentSelect.appendChild(newOption);
                         console.warn(`"${eventToEdit.department}" seçeneği dinamik olarak eklendi.`);
                     }
                      departmentSelect.value = eventToEdit.department;
                 } else {
                     departmentSelect.value = ''; // Birim yoksa temizle
                 }
             }
            
            // Günlük Kayıt bilgileri (eğer varsa)
            if (eventToEdit.event_type === 'gunluk-kayit') {
                if (document.getElementById('muvekkilIsim')) {
                    document.getElementById('muvekkilIsim').value = eventToEdit.muvekkil_isim || '';
                }
                if (document.getElementById('muvekkilTelefon')) {
                    document.getElementById('muvekkilTelefon').value = eventToEdit.muvekkil_telefon || '';
                }
            }
            
            // Düzenleme modunda etkinlik türüne göre form alanlarını güncelle
            toggleFormFields();
        } else {
            // Yeni etkinlik modu - tüm değerleri sıfırla
            document.getElementById('eventType').value = 'diger'; // Default event type
            document.getElementById('assignedTo').value = ''; // Varsayılan olarak atanmamış
            document.getElementById('isCompleted').checked = false;
            // Yeni etkinlik eklerken şehir/adliye/birim dropdownlarını sıfırla/ayarla
            const cityElement = document.getElementById('city');
            if(cityElement) cityElement.value = '';
            courthouseSelect.innerHTML = '<option value="">Önce Şehir Seçiniz</option>';
            departmentSelect.innerHTML = '<option value="">Önce Adliye Seçiniz</option>';
            // Günlük kayıt alanlarını temizle
            if (document.getElementById('muvekkilIsim')) {
                document.getElementById('muvekkilIsim').value = '';
            }
            if (document.getElementById('muvekkilTelefon')) {
                document.getElementById('muvekkilTelefon').value = '';
            }
        }

        // DOM güncellenmesi için kısa bir gecikme ekle, sonra form alanlarını ayarla
        setTimeout(() => {
            toggleFormFields(); // Form alanlarının görünürlüğünü ayarla
        }, 10);
        
        // Set title placeholder based on event type
        const titleInput = document.getElementById('eventTitle');
        const eventType = document.getElementById('eventType').value;
        if (eventType === 'durusma' || eventType === 'e-durusma') {
            titleInput.placeholder = 'Müvekkil (Esas Numarası)';
        } else {
            titleInput.placeholder = 'Etkinlik başlığı';
        }
        
        eventModal.style.display = 'flex';
    }

    function closeModal(modalElement) {
         if (modalElement) {
             modalElement.style.display = 'none';
         }
         // Eğer ana etkinlik modalı kapatılıyorsa formu sıfırla
         if (modalElement === eventModal) {
             eventForm.reset();
             eventForm.removeAttribute('data-event-id');
         }
    }

    function showEventDetail(event) {
        if (!hasPermission('etkinlik_goruntule')) {
            showGlobalNotification('Etkinlik görüntüleme yetkiniz bulunmamaktadır.', 'error');
            return;
        }

        document.getElementById('detailTitle').textContent = event.title;
        const eventTypeBadge = document.getElementById('detailEventType');
        eventTypeBadge.textContent = eventTypes[event.event_type] || 'Bilinmeyen';
        eventTypeBadge.className = `event-type-badge ${event.event_type}`; // CSS sınıfı için

        document.getElementById('detailDate').textContent = new Date(event.date + 'T00:00:00').toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('detailTime').textContent = event.event_type === 'gunluk-kayit' ? '-' : (event.time || '-');
        document.getElementById('detailAssignedTo').textContent = event.event_type === 'gunluk-kayit' ? '-' : (event.assigned_to || '-');
        document.getElementById('detailStatus').textContent = event.event_type === 'gunluk-kayit' ? '-' : (event.is_completed ? 'Tamamlandı' : 'Bekliyor');

        // Günlük kayıt için Saat/Atanan Kişi/Durum bloklarını gizle
        const timeItem = document.getElementById('detailTimeItem');
        const assignedItem = document.getElementById('detailAssignedToItem');
        const statusItem = document.getElementById('detailStatusItem');
        if (event.event_type === 'gunluk-kayit') {
            if (timeItem) timeItem.style.display = 'none';
            if (assignedItem) assignedItem.style.display = 'none';
            if (statusItem) statusItem.style.display = 'none';
        } else {
            if (timeItem) timeItem.style.display = 'flex';
            if (assignedItem) assignedItem.style.display = 'flex';
            if (statusItem) statusItem.style.display = 'flex';
        }
        document.getElementById('detailDescription').textContent = event.description || 'Açıklama yok.';

         // Adliye ve Mahkeme/Birim bilgilerini göster/gizle
         const courthouseItem = document.getElementById('detailCourthouseItem');
         const departmentItem = document.getElementById('detailDepartmentItem');
         const courthouseSpan = document.getElementById('detailCourthouse');
         const departmentSpan = document.getElementById('detailDepartment');

         if ((event.event_type === 'durusma' || event.event_type === 'e-durusma') && courthouseItem && departmentItem) {
             // Dosya türüne göre adliye ve mahkeme bilgilerini göster/gizle
             const fileType = event.file_type;
             const shouldShowCourthouse = fileType && !['AİHM', 'AYM', 'ARABULUCULUK'].includes(fileType);
             const shouldShowDepartment = fileType && !['AİHM', 'AYM', 'ARABULUCULUK', 'savcilik'].includes(fileType);
             
             if (shouldShowCourthouse && event.courthouse && event.courthouse !== 'Uygulanamaz') {
                 courthouseSpan.textContent = event.courthouse;
                 courthouseItem.style.display = 'flex';
             } else {
                 courthouseItem.style.display = 'none';
             }
             
             if (shouldShowDepartment && event.department && event.department !== 'Uygulanamaz') {
                 departmentSpan.textContent = event.department;
                 departmentItem.style.display = 'flex';
             } else {
                 departmentItem.style.display = 'none';
             }
         } else if (courthouseItem && departmentItem) {
             courthouseItem.style.display = 'none';
             departmentItem.style.display = 'none';
         }

         // Günlük Kayıt bilgilerini göster/gizle
         const muvekkilItem = document.getElementById('detailMuvekkilItem');
         const telefonItem = document.getElementById('detailTelefonItem');
         const muvekkilSpan = document.getElementById('detailMuvekkil');
         const telefonSpan = document.getElementById('detailTelefon');

         if (event.event_type === 'gunluk-kayit' && muvekkilItem && telefonItem) {
             if (event.muvekkil_isim) {
                 muvekkilSpan.textContent = event.muvekkil_isim;
                 muvekkilItem.style.display = 'flex';
             } else {
                 muvekkilItem.style.display = 'none';
             }
             
             if (event.muvekkil_telefon) {
                 telefonSpan.textContent = event.muvekkil_telefon;
                 telefonItem.style.display = 'flex';
             } else {
                 telefonItem.style.display = 'none';
             }
         } else if (muvekkilItem && telefonItem) {
             muvekkilItem.style.display = 'none';
             telefonItem.style.display = 'none';
         }


         // Düzenle ve Sil butonlarının görünürlüğü
         const editBtn = document.getElementById('editDetailBtn');
         const deleteBtn = document.getElementById('deleteDetailBtn');

         editBtn.style.display = hasPermission('etkinlik_duzenle') ? 'inline-flex' : 'none';
         deleteBtn.style.display = hasPermission('etkinlik_sil') ? 'inline-flex' : 'none';

         editBtn.onclick = () => {
             if (hasPermission('etkinlik_duzenle')) {
                 closeModal(eventDetailModal);
                 showModal(new Date(event.date + 'T00:00:00'), true, event); // Düzenleme modunda aç
             } else {
                 showGlobalNotification('Etkinlik düzenleme yetkiniz bulunmamaktadır.', 'error');
             }
         };
         deleteBtn.onclick = () => {
             if (hasPermission('etkinlik_sil')) {
                 deleteEvent(event.id, event.title);
             } else {
                 showGlobalNotification('Etkinlik silme yetkiniz bulunmamaktadır.', 'error');
             }
         };


        eventDetailModal.style.display = 'flex';
    }

    function showEventList(date) {
        if (!hasPermission('etkinlik_goruntule')) return; // Görüntüleme yetkisi yoksa gösterme

        const dateStr = formatDateForAPI(date);
        const dayEvents = events.filter(e => e.date === dateStr)
                                .sort((a, b) => (a.time || '').localeCompare(b.time || ''));

        const listModalTitle = document.getElementById('listModalTitle');
        const listContentDiv = document.getElementById('eventListContent');

        listModalTitle.textContent = `${date.toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric', weekday: 'long' })} Etkinlikleri`;
        listContentDiv.innerHTML = ''; // Önceki listeyi temizle

        if (dayEvents.length === 0) {
            listContentDiv.innerHTML = '<div class="no-events">Bu gün için etkinlik bulunmuyor.</div>';
        } else {
            dayEvents.forEach(event => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `event-list-item ${event.event_type}`;
                if (event.is_completed) itemDiv.classList.add('completed');

                const timeText = event.event_type === 'gunluk-kayit' ? '' : (event.time || '');
                const assignedToText = event.event_type === 'gunluk-kayit' ? '' : event.assigned_to;
                
                itemDiv.innerHTML = `
                    <div class="time-and-type event-type-${event.event_type}">
                       ${timeText ? `${timeText} - ` : ''}${eventTypes[event.event_type] || 'Bilinmeyen'}
            </div>
                    <div class="event-title">${event.title}</div>
                    ${assignedToText ? `<div class="assigned-to">${assignedToText}</div>` : ''}
                    ${(() => {
                        // Dosya türüne göre konum bilgisi göster
                        if (event.event_type === 'durusma' || event.event_type === 'e-durusma') {
                            const fileType = event.file_type;
                            const shouldShowCourthouse = fileType && !['AİHM', 'AYM', 'ARABULUCULUK'].includes(fileType);
                            const shouldShowDepartment = fileType && !['AİHM', 'AYM', 'ARABULUCULUK', 'savcilik'].includes(fileType);
                            
                            let locationText = '';
                            if (shouldShowCourthouse && event.courthouse && event.courthouse !== 'Uygulanamaz') {
                                locationText = event.courthouse;
                                if (shouldShowDepartment && event.department && event.department !== 'Uygulanamaz') {
                                    locationText += ` - ${event.department}`;
                                }
                            }
                            
                            if (locationText) {
                                return `<div class="event-location">${locationText.substring(0, 50)}...</div>`;
                            }
                        }
                        
                        // Duruşma değilse veya konum bilgisi yoksa açıklama göster
                        return event.description ? `<div class="event-location">${(event.description || '').substring(0, 50)}...</div>` : '';
                    })()}
                 `;
                 // Tıklayınca detay modalını aç
                 itemDiv.onclick = () => {
                     closeModal(eventListModal);
                     showEventDetail(event);
                 };
                listContentDiv.appendChild(itemDiv);
            });
        }

        eventListModal.style.display = 'flex';
    }


    // --- API İstekleri ve Form Gönderme ---

    eventForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Double submission koruması
        const submitButton = eventForm.querySelector('button[type="submit"]');
        if (submitButton.disabled) {
            return; // Zaten işlem devam ediyor
        }
        
        // Submit butonunu disable et
        submitButton.disabled = true;
        submitButton.textContent = 'Kaydediliyor...';

        const eventId = eventForm.getAttribute('data-event-id');
        const isEditing = !!eventId;

        // Yetki kontrolü
         if (isEditing && !hasPermission('etkinlik_duzenle')) {
             showGlobalNotification('Etkinlik düzenleme yetkiniz yok.', 'warning');
             // Butonları yeniden enable et
             submitButton.disabled = false;
             submitButton.textContent = 'Kaydet';
             return;
         }
         if (!isEditing && !hasPermission('etkinlik_ekle')) {
             showGlobalNotification('Etkinlik ekleme yetkiniz yok.', 'warning');
             // Butonları yeniden enable et
             submitButton.disabled = false;
             submitButton.textContent = 'Kaydet';
             return;
        }
        
        // Günlük Kayıt için başlık oluştur
        let eventTitle = document.getElementById('eventTitle').value;
        if (eventTypeSelect.value === 'gunluk-kayit') {
            const muvekkilIsim = document.getElementById('muvekkilIsim').value;
            eventTitle = muvekkilIsim || 'Günlük Kayıt';
        }
        
        const formData = {
            id: isEditing ? parseInt(eventId) : undefined,
            title: eventTitle,
            date: selectedDateInput.value,
            time: (eventTypeSelect.value === 'gunluk-kayit') ? '00:00' : document.getElementById('eventTime').value,
            event_type: eventTypeSelect.value,
            description: document.getElementById('eventDescription').value,
            assigned_to: (eventTypeSelect.value === 'gunluk-kayit') ? '' : document.getElementById('assignedTo').value,
            is_completed: (eventTypeSelect.value === 'gunluk-kayit') ? false : document.getElementById('isCompleted').checked,
            // Duruşma bilgileri (sadece duruşma/e-duruşma ise gönder)
             file_type: (eventTypeSelect.value === 'durusma' || eventTypeSelect.value === 'e-durusma') ? fileTypeSelect.value : null,
             courthouse: (eventTypeSelect.value === 'durusma' || eventTypeSelect.value === 'e-durusma') ? courthouseSelect.value : null,
             department: (eventTypeSelect.value === 'durusma' || eventTypeSelect.value === 'e-durusma') ? departmentSelect.value : null,
            // Günlük Kayıt bilgileri (sadece günlük-kayit ise gönder)
            muvekkil_isim: (eventTypeSelect.value === 'gunluk-kayit') ? document.getElementById('muvekkilIsim').value : null,
            muvekkil_telefon: (eventTypeSelect.value === 'gunluk-kayit') ? document.getElementById('muvekkilTelefon').value : null,
            // Şehir bilgisi frontend'de kullanıldı, backend'e göndermeye gerek yok (şimdilik)
        };

        // API endpoint
        const url = isEditing ? `/update_event` : '/add_event';

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': CSRF_TOKEN
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
            }
            return response.json();
        })
        .then(data => {
            console.log("Sunucudan gelen yanıt:", data);
             // Başarılı yanıtı işle
             if (isEditing) {
                 // Mevcut etkinliği güncelle
                 const index = events.findIndex(ev => ev.id === formData.id);
                 if (index > -1) {
                     // events[index] = { ...events[index], ...formData }; // Sadece form verisiyle değil, sunucudan dönen event ile güncellemek daha iyi
                      events[index] = data.event || data; // Sunucudan dönen güncel event verisi
                 }
             } else {
                 // Yeni etkinliği ekle (sunucudan dönen ID ile)
                 events.push(data); // Sunucudan dönen tam event objesini ekle
             }
             renderCalendar(); // Takvimi yeniden çiz
             closeModal(eventModal);
             showGlobalNotification(`Etkinlik başarıyla ${isEditing ? 'güncellendi' : 'kaydedildi'}.`, 'success');
             
             // Butonları yeniden enable et
             submitButton.disabled = false;
             submitButton.textContent = 'Kaydet';
        })
        .catch(error => {
            console.error('Etkinlik kaydetme/güncelleme hatası:', error);
            showGlobalNotification(`Bir hata oluştu: ${error.message}`, 'error');
            
            // Butonları yeniden enable et
            submitButton.disabled = false;
            submitButton.textContent = 'Kaydet';
        });
    });

    function deleteEvent(eventId, eventTitle) {
                  if (!hasPermission('etkinlik_sil')) {
              showGlobalNotification('Etkinlik silme yetkiniz yok.', 'warning');
              return;
          }

        if (confirm(`'${eventTitle}' başlıklı etkinliği silmek istediğinizden emin misiniz?`)) {
            fetch(`/delete_event/${eventId}`, {
                method: 'POST', // veya DELETE, API endpoint'ine göre
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `HTTP error! status: ${response.status}`) });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Etkinliği events array'inden çıkar
                    const index = events.findIndex(ev => ev.id === eventId);
                    if (index > -1) {
                        events.splice(index, 1);
                    }
                    renderCalendar(); // Takvimi güncelle
                    closeModal(eventDetailModal); // Detay modalını kapat
                    showGlobalNotification('Etkinlik başarıyla silindi.', 'success');
                } else {
                    throw new Error(data.error || 'Silme işlemi başarısız.');
                }
            })
            .catch(error => {
                console.error('Etkinlik silme hatası:', error);
                showGlobalNotification(`Etkinlik silinirken bir hata oluştu: ${error.message}`, 'error');
            });
        }
    }

    // --- Başlangıç Ayarları ve Olay Dinleyicileri ---

    addCitySelect(); // Şehir select'i HTML'e ekle

    // Modal kapatma butonları
    eventModal.querySelector('.close-btn').onclick = () => closeModal(eventModal);
    document.getElementById('cancelBtn').onclick = () => closeModal(eventModal);
    document.getElementById('closeDetailModal').onclick = () => closeModal(eventDetailModal);
    document.getElementById('closeListModal').onclick = () => closeModal(eventListModal);

    // Takvim navigasyon butonları
    document.getElementById('todayBtn').onclick = () => { currentDate = new Date(); renderCalendar(); };
    document.getElementById('prevMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); };
    document.getElementById('nextMonth').onclick = () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); };

    // Ana "Yeni Etkinlik" butonu (Yetki kontrolü ile)
    const addEventHeaderBtn = document.getElementById('addEventBtn');
    if (hasPermission('etkinlik_ekle')) {
        addEventHeaderBtn.onclick = () => showModal(new Date(), true); // Tarih seçici görünsün
    } else {
        addEventHeaderBtn.style.display = 'none'; // Ekleme yetkisi yoksa butonu gizle
    }


    // Form içindeki select değişiklikleri için olay dinleyicileri
    eventTypeSelect.addEventListener('change', handleEventTypeChange);
    fileTypeSelect.addEventListener('change', handleFileTypeChange);
    // citySelect dinamik eklendiği için listener eklenmişti.
    courthouseSelect.addEventListener('change', handleCourthouseChange);


    // İlk takvim görünümünü oluştur
    renderCalendar();
    toggleFormFields(); // Form alanlarının başlangıç durumunu ayarla

}); // DOMContentLoaded Sonu
</script>

<style>
/* Inline stiller için CSS sınıfları */
.hidden-section {
    display: none;
}

.modal-content {
    background: white;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
}

.modal-header {
    padding: 1.5rem 2rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 1.5rem 2rem;
}

.modal-footer {
    padding: 1rem 2rem 1.5rem;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

/* Event type renkleri */
.event-type-durusma {
    color: var(--durusma-color, #6c757d);
    border-left-color: var(--durusma-color, #6c757d);
}

.event-type-e-durusma {
    color: var(--e-durusma-color, #6c757d);
    border-left-color: var(--e-durusma-color, #6c757d);
}

.event-type-gunluk-kayit {
    color: var(--gunluk-kayit-color, #6c757d);
    border-left-color: var(--gunluk-kayit-color, #6c757d);
}

.optional-text {
    color: #666;
    font-size: 0.9em;
}

.page-container {
    padding: 1rem;
    min-height: 0;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    box-sizing: border-box;
    margin-bottom: 0;
}

.calendar-wrapper {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 90%;
    margin: 0 auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-top: 0.5rem;
    margin-bottom: 0;
}

#calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    grid-template-rows: repeat(6, minmax(170px, 170px));
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
    min-width: min-content;
}

.calendar-day {
    position: relative;
    background: white;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    height: 170px;
    min-width: 120px;
    box-sizing: border-box;
    padding-bottom: 30px; /* Artı ikonu için alt boşluk */
}

.weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #f5f5f5;
    padding: 0.5rem 0;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
}

.calendar-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 20px;
}

.current-month {
    text-align: center;
}

.current-month h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
    color: #2c3e50;
}

.current-month span {
    color: #95a5a6;
    font-size: 1.1rem;
}

.nav-btn, .tool-btn {
    background: none;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #2c3e50;
    transition: all 0.2s ease;
}

.nav-btn:hover {
    background: #e9ecef;
}

.tool-btn {
    padding: 8px 16px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tool-btn:hover {
    background: #e9ecef;
    border-color: #ced4da;
}

.tool-btn.primary {
    background: var(--primary-color);
    color: white;
    border: none;
}

.tool-btn.primary:hover {
    background: var(--hover-color);
}

.tool-btn.today-active {
    background: #e3f2fd;
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.calendar-tools {
    display: flex;
    gap: 10px;
}

.calendar-day {
    min-height: 150px;
    padding: 10px;
    background: white;
}

.calendar-day:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.calendar-day.today {
    background-color: #e3f2fd !important;
    color: #1976d2 !important;
    font-weight: bold;
}

.calendar-day.today .day-number {
    color: #1976d2 !important;
}

.calendar-day.other-month {
    background: #f8f9fa;
    border-color: #f1f3f5;
}

.day-number {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    flex-shrink: 0;
    height: 20px;
}

.add-event-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
}

.calendar-day:hover .add-event-btn {
    display: flex;
}

.add-event-btn:hover {
    background: var(--hover-color);
    transform: scale(1.1);
}

.event-list {
    flex: 1;
    overflow-y: auto;
    margin-top: 4px;
    padding-right: 4px;
    max-height: calc(100% - 25px);
}

.calendar-event {
    padding: 4px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    background: #f8f9fa;
    border-left: 3px solid;
    font-size: 0.8em;
    cursor: pointer;
    height: 45px;
}

.calendar-event .time-and-type {
    font-weight: 500;
    font-size: 0.85em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.calendar-event .assigned-to {
    font-size: 0.8em;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.event-durusma { background: #e74c3c; }
.event-e-durusma { background: #FF9800; }
.event-tahliye { background: #3498db; }
.event-is { background: #2ecc71; }
.event-randevu { background: #9b59b6; }
.event-diger { background: #f1c40f; }

/* Modal Stilleri - Dinamik Responsive */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    justify-content: center;
    align-items: flex-start;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
}

.modal-content {
    background: white;
    border-radius: 10px;
    position: relative;
    width: 100%;
    max-width: 500px;
    margin: 20px auto;
    display: flex;
    flex-direction: column;
    min-height: fit-content;
    max-height: none;
}

/* Modal başlık - sabit */
.modal-header {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
    border-radius: 10px 10px 0 0;
}

/* Modal body - içerik boyutuna göre */
.modal-body {
    padding: 20px;
    flex: 1;
    min-height: fit-content;
}

/* Modal footer - sabit, her zaman görünür */
.modal-footer {
    padding: 15px 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    flex-shrink: 0;
    background: #f8f9fa;
    border-radius: 0 0 10px 10px;
}

/* Responsive Modal - Mobil Optimizasyonu */
@media (max-width: 768px) {
    .modal {
        padding: 10px;
    }
    
    .modal-content {
        width: calc(100% - 20px);
        margin: 10px auto;
        max-width: none;
    }
    
    .modal-header {
        padding: 15px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .modal-footer {
        padding: 12px 15px;
    }
}

/* Kısa Ekranlar için - Max Height Kontrolü */
@media (max-height: 700px) {
    .modal {
        align-items: flex-start;
        padding-top: 10px;
        padding-bottom: 10px;
    }
    
    .modal-content {
        margin-top: 10px;
        margin-bottom: 10px;
        max-height: calc(100vh - 20px);
        overflow-y: auto;
    }
    
    .modal-body {
        max-height: none;
        overflow-y: visible;
    }
}

/* Çok Kısa Ekranlar (Tablet Landscape vb.) */
@media (max-height: 500px) {
    .modal {
        padding: 5px;
    }
    
    .modal-content {
        margin: 5px auto;
        max-height: calc(100vh - 10px);
    }
    
    .modal-header {
        padding: 10px 15px;
    }
    
    .modal-body {
        padding: 10px 15px;
    }
    
    .modal-footer {
        padding: 8px 15px 10px;
    }
}

.modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
}

/* Form grupları için grid layout */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

/* Input ve Select wrapper */
.input-wrapper, .select-wrapper {
    position: relative;
    width: 100%;
    box-sizing: border-box;
}

.input-wrapper input,
.input-wrapper textarea,
.select-wrapper select {
    width: 100%;
    padding: 8px 12px;
    padding-right: 35px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #2c3e50;
    background: white;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.input-wrapper input:focus,
.input-wrapper textarea:focus,
.select-wrapper select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* İkonlar */
.input-wrapper i,
.select-wrapper i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #95a5a6;
    pointer-events: none;
}

.input-wrapper textarea {
    min-height: 60px;
    max-height: 60px;
    resize: none;
}

/* Chrome'un kendi saat ikonunu gizle */
input[type="time"]::-webkit-calendar-picker-indicator {
    opacity: 1;
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin-right: 8px;
}

/* Chrome'un varsayılan saat ikonunu gizle */
.input-wrapper input[type="time"]::-webkit-calendar-picker-indicator {
    display: block;
    opacity: 1;
    width: 20px;
    height: 20px;
    cursor: pointer;
    margin-right: 8px;
}

/* Modal footer */
.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn.primary {
    background: var(--primary-color);
    color: white;
}

.btn.primary:hover {
    background: var(--hover-color);
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Responsive düzenlemeler */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
}

.event-actions {
    display: none;
    gap: 4px;
}

.event-item:hover .event-actions {
    display: flex;
}

.event-action-btn {
    padding: 2px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-action-btn:hover {
    background: rgba(255,255,255,0.3);
}

@media (max-width: 768px) {
    .calendar-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .calendar-tools {
        width: 100%;
        justify-content: center;
    }
    
    .weekdays div {
        font-size: 0.9rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .calendar-day {
        padding: 5px;
    }
    
    .event-item {
        font-size: 0.7rem;
    }
}

/* Detay modalı için yeni stiller */
.detail-modal {
    max-width: 550px;
    background: white;
    border-radius: 15px;
    overflow: hidden;
}

.detail-modal .modal-header {
    padding: 25px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    position: relative;
}

.event-type-badge {
    padding: 8px 16px;
    border-radius: 25px;
    color: white;
    font-size: 0.95rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.event-type-badge::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    background: rgba(255,255,255,0.8);
    border-radius: 50%;
}

.detail-modal .modal-body {
    padding: 25px;
}

.event-detail-content {
    padding: 0;
}

.event-detail-content h3 {
    margin: 0 0 20px 0;
    font-size: 1.6rem;
    color: #2c3e50;
    font-weight: 600;
    line-height: 1.4;
}

.event-meta {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
    background: #f8f9fa;
    padding: 20px;
    border-radius: 12px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 12px;
    color: #2c3e50;
}

.meta-item i {
    font-size: 22px;
    color: #6c757d;
    background: #fff;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.meta-item .meta-label {
    font-size: 0.85rem;
    color: #6c757d;
    display: block;
    margin-bottom: 2px;
}

.meta-item .meta-value {
    font-size: 0.95rem;
    color: #2c3e50;
    font-weight: 500;
}

.event-description {
    background: #fff;
    padding: 20px;
    border-radius: 12px;
    margin-top: 20px;
    border: 1px solid #e9ecef;
}

.event-description h4 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin: 0 0 15px 0;
    display: flex;
    align-items: center;
    gap: 8px;
}

.event-description h4 i {
    font-size: 20px;
    color: #6c757d;
}

.event-description p {
    margin: 0;
    line-height: 1.6;
    color: #2c3e50;
    white-space: pre-wrap;
}

.detail-modal .modal-footer {
    padding: 20px 25px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.detail-modal .btn {
    padding: 10px 20px;
    font-size: 0.95rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
}

.detail-modal .btn i {
    font-size: 20px;
}

.detail-modal .btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.detail-modal .btn.secondary:hover {
    background: #dee2e6;
}

.detail-modal .btn.danger {
    background: #dc3545;
    color: white;
}

.detail-modal .btn.danger:hover {
    background: #c82333;
}

/* Etkinlik türlerine göre badge renkleri */
.event-type-badge.durusma { background: #dc3545; }
.event-type-badge.e-durusma { background: #0d6efd; }
.event-type-badge.tahliye { background: #198754; }
.event-type-badge.is { background: #ffc107; color: #000; }
.event-type-badge.randevu { background: #9b59b6; }
.event-type-badge.diger { background: #6c757d; }
.event-type-badge.gunluk-kayit { background: #fd7e14; color: #fff; }

.event-list {
    flex: 1;
    overflow-y: auto;
    margin-top: 4px;
    padding-right: 4px;
    max-height: calc(100% - 25px);
}

.calendar-event {
    padding: 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    background: #f8f9fa;
    border-left: 3px solid;
    font-size: 0.8em;
    cursor: pointer;
    min-height: 40px;
}

.calendar-event .time-and-type {
    font-weight: 500;
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calendar-event .assigned-to {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calendar-event.completed {
    opacity: 0.7;
    text-decoration: line-through;
}

.calendar-event[data-type="durusma"] { color: #dc3545; }
.calendar-event[data-type="e-durusma"] { color: #0d6efd; }
.calendar-event[data-type="tahliye"] { color: #198754; }
.calendar-event[data-type="is"] { color: #ffc107; }
.calendar-event[data-type="randevu"] { color: #9b59b6; }
.calendar-event[data-type="gunluk-kayit"] { color: #fd7e14; }
.calendar-event[data-type="diger"] { color: #6c757d; }

.calendar-day.empty {
    background: #f8f9fa;
    border: none;
    pointer-events: none;
}

.holiday {
    background-color: #ffebee;
}

.holiday .holiday-name {
    color: #e53935;
    font-size: 0.7rem;
    margin-top: 4px;
    font-weight: 500;
}

.adli-tatil {
    background-color: rgba(76, 175, 80, 0.1);
}

.adli-tatil .holiday-name {
    color: #4CAF50;
    font-size: 0.7rem;
    margin-top: 4px;
    font-weight: 500;
}

.view-events-btn {
    position: absolute;
    top: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: none;
    color: #666;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
    opacity: 0;
}

.add-day-event-btn {
    position: absolute;
    bottom: 6px;
    right: 6px;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: none;
    color: #666;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s ease;
    opacity: 0;
    z-index: 2;
}

.calendar-day:hover .view-events-btn,
.calendar-day:hover .add-day-event-btn {
    opacity: 1;
}

.view-events-btn:hover,
.add-day-event-btn:hover {
    color: var(--primary-color);
    transform: scale(1.1);
}

.list-modal {
    max-width: 600px;
    background: white;
    border-radius: 15px;
    overflow: hidden;
}

.list-modal .modal-header {
    background: #f8f9fa;
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
}

.list-modal .modal-header h3 {
    font-size: 1.4rem;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 10px;
}

.list-modal .modal-header h3:before {
    content: '';
    display: inline-block;
    width: 6px;
    height: 24px;
    background: var(--primary-color);
    border-radius: 3px;
    margin-right: 5px;
}

.list-modal .modal-body {
    padding: 20px 25px;
    max-height: 70vh;
    overflow-y: auto;
}

.event-list-content {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.event-list-item {
    background: #fff;
    border: 1px solid #e9ecef;
    border-left-width: 4px;
    border-radius: 10px;
    padding: 15px;
    transition: all 0.2s ease;
    cursor: pointer;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.event-list-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.event-list-item .time-and-type {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
}

.event-list-item .time-and-type:before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
}

.event-list-item .event-title {
    font-size: 1.1rem;
    font-weight: 500;
    color: #2c3e50;
    margin-bottom: 8px;
}

.event-list-item .assigned-to {
    display: flex;
    align-items: center;
    gap: 6px;
    color: #6c757d;
    font-size: 0.9rem;
}

.event-list-item .assigned-to:before {
    content: 'person';
    font-family: 'Material Icons';
    font-size: 16px;
}

.event-list-item.completed {
    opacity: 0.7;
    background: #f8f9fa;
}

.event-list-item.completed .event-title,
.event-list-item.completed .time-and-type {
    text-decoration: line-through;
}

.no-events {
    text-align: center;
    padding: 30px;
    color: #6c757d;
    font-size: 1.1rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.no-events:before {
    content: 'event_busy';
    font-family: 'Material Icons';
    font-size: 48px;
    color: #dee2e6;
}

/* Scrollbar stilleri */
.list-modal .modal-body::-webkit-scrollbar {
    width: 6px;
}

.list-modal .modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.list-modal .modal-body::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 3px;
}

.list-modal .modal-body::-webkit-scrollbar-thumb:hover {
    background: #999;
}

/* Sadece tarih ve saat input'ları için ek özel stiller */
.input-wrapper input[type="date"],
.input-wrapper input[type="time"] {
    height: 38px;
    padding-right: 30px;
}

.input-wrapper input[type="date"]::-webkit-calendar-picker-indicator,
.input-wrapper input[type="time"]::-webkit-calendar-picker-indicator {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 18px;
    height: 18px;
    cursor: pointer;
    opacity: 1;
}
</style>

<div class="page-container">
    <div class="calendar-wrapper">
        <!-- Takvim Başlığı -->
        <div class="calendar-header">
            <div class="calendar-nav">
                <button id="prevMonth" class="nav-btn">
                    <i class="material-icons">chevron_left</i>
                </button>
                <div class="current-month">
                    <h2 id="currentMonth"></h2>
                    <span id="currentYear"></span>
                </div>
                <button id="nextMonth" class="nav-btn">
                    <i class="material-icons">chevron_right</i>
                </button>
            </div>
            <div class="calendar-tools">
                <button id="todayBtn" class="tool-btn">
                    <i class="material-icons">today</i>
                    <span>Bugün</span>
                </button>
                <button id="addEventBtn" class="tool-btn primary">
                    <i class="material-icons">add</i>
                    <span>Yeni Etkinlik</span>
                </button>
            </div>
        </div>

        <!-- Takvim Grid -->
        <div class="calendar-container">
            <div class="weekdays">
                <div>Pazartesi</div>
                <div>Salı</div>
                <div>Çarşamba</div>
                <div>Perşembe</div>
                <div>Cuma</div>
                <div>Cumartesi</div>
                <div>Pazar</div>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>
</div>

<!-- Etkinlik Modalı -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Yeni Etkinlik</h3>
            <button class="close-btn">
                <i class="material-icons">close</i>
            </button>
        </div>
        <form id="eventForm" data-event-id="">
            <div class="modal-body">
                <div class="form-group full-width">
                    <label>Etkinlik Türü</label>
                    <div class="select-wrapper">
                        <select id="eventType" name="event_type" required>
                            <option value="">Seçiniz</option>
                            <option value="durusma">Duruşma</option>
                            <option value="e-durusma">E-Duruşma</option>
                            <option value="tahliye">Tahliye</option>
                            <option value="is">Yapılacak İş</option>
                            <option value="randevu">Randevu</option>
                            <option value="gunluk-kayit">Günlük Kayıt</option>
                            <option value="diger">Diğer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Duruşma ve E-Duruşma için dosya bilgileri -->
                <div id="hearingDetailsSection" class="hidden-section">
                    <div class="form-group full-width">
                        <label>Dosya Türü</label>
                        <div class="select-wrapper">
                            <select id="fileType" name="file_type" required>
                                <option value="">Seçiniz</option>
                                <option value="hukuk">Hukuk</option>
                                <option value="ceza">Ceza</option>
                                <option value="icra">İcra</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Adliye</label>
                        <div class="select-wrapper">
                            <select id="courthouse" name="courthouse" required>
                                <option value="">Seçiniz</option>
                                <option value="İstanbul Anadolu Adliyesi (Kartal)">İstanbul Anadolu Adliyesi (Kartal)</option>
                                <option value="İstanbul Adliyesi (Çağlayan)">İstanbul Adliyesi (Çağlayan)</option>
                                <option value="Bakırköy Adliyesi">Bakırköy Adliyesi</option>
                                <option value="Büyükçekmece Adliyesi">Büyükçekmece Adliyesi</option>
                                <option value="Gaziosmanpaşa Adliyesi">Gaziosmanpaşa Adliyesi</option>
                                <option value="Küçükçekmece Adliyesi">Küçükçekmece Adliyesi</option>
                                <option value="Silivri Adliyesi">Silivri Adliyesi</option>
                                <option value="Çatalca Adliyesi">Çatalca Adliyesi</option>
                                <option value="Üsküdar Adliyesi">Üsküdar Adliyesi</option>
                                <option value="Adalar Adliyesi">Adalar Adliyesi</option>
                                <option value="Sarıyer Adliyesi">Sarıyer Adliyesi</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Mahkeme/Birim</label>
                        <div class="select-wrapper">
                            <select id="department" name="department" required>
                                <option value="">Seçiniz</option>
                                <!-- Birimler dinamik olarak JavaScript ile doldurulacak -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Günlük Kayıt için özel alanlar -->
                <div id="gunlukKayitDetailsSection" class="hidden-section">
                    <div class="form-group full-width">
                        <label>Müvekkil İsim Soyisim</label>
                        <div class="input-wrapper">
                            <input type="text" id="muvekkilIsim" name="muvekkil_isim" placeholder="Müvekkil adı soyadı">
                            <i class="material-icons">person</i>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label>Telefon Numarası <span class="optional-text">(isteğe bağlı)</span></label>
                        <div class="input-wrapper">
                            <input type="tel" id="muvekkilTelefon" name="muvekkil_telefon" placeholder="Telefon numarası">
                            <i class="material-icons">phone</i>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tarih</label>
                        <div class="input-wrapper">
                            <input type="date" id="selectedDate" name="date" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Saat</label>
                        <div class="input-wrapper">
                            <input type="time" id="eventTime" name="time" required>
                        </div>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Başlık</label>
                    <div class="input-wrapper">
                        <input type="text" id="eventTitle" name="title" required placeholder="Etkinlik başlığı">
                        <i class="material-icons">title</i>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Açıklama</label>
                    <div class="input-wrapper">
                        <textarea id="eventDescription" name="description" rows="2" placeholder="Etkinlik detayları"></textarea>
                        <i class="material-icons">description</i>
                    </div>
                </div>
                <div class="form-group full-width" id="assignedToGroup">
                    <label>Atanan Kişi</label>
                    <div class="select-wrapper">
                        <select id="assignedTo" name="assigned_to">
                            <option value="">Atanmamış</option>
                            {% for user in approved_users %}
                            <option value="{{ user.full_name }}">{{ user.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group" id="isCompletedGroup">
                    <label>
                        <input type="checkbox" id="isCompleted" name="is_completed">
                        Tamamlandı
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn secondary" id="cancelBtn">İptal</button>
                <button type="submit" class="btn primary">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<!-- Etkinlik Detay Modalı -->
<div id="eventDetailModal" class="modal">
    <div class="modal-content detail-modal">
        <div class="modal-header">
            <div class="event-type-badge" id="detailEventType"></div>
            <button class="close-btn" id="closeDetailModal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body">
            <div class="event-detail-content">
                <h3 id="detailTitle"></h3>
                <div class="event-meta">
                    <div class="meta-item">
                        <i class="material-icons">event</i>
                        <div>
                            <span class="meta-label">Tarih</span>
                            <span class="meta-value" id="detailDate"></span>
                        </div>
                    </div>
                    <div class="meta-item" id="detailTimeItem">
                        <i class="material-icons">schedule</i>
                        <div>
                            <span class="meta-label">Saat</span>
                            <span class="meta-value" id="detailTime"></span>
                        </div>
                    </div>
                    <!-- Yeni Adliye ve Mahkeme Kutucukları -->
                    <div class="meta-item hidden-section" id="detailCourthouseItem">
                         <i class="material-icons">account_balance</i>
                         <div>
                             <span class="meta-label">Adliye</span>
                             <span class="meta-value" id="detailCourthouse"></span>
                         </div>
                     </div>
                     <div class="meta-item hidden-section" id="detailDepartmentItem">
                         <i class="material-icons">gavel</i>
                         <div>
                             <span class="meta-label">Mahkeme/Birim</span>
                             <span class="meta-value" id="detailDepartment"></span>
                         </div>
                     </div>
                    <!-- Günlük Kayıt bilgileri -->
                    <div class="meta-item hidden-section" id="detailMuvekkilItem">
                        <i class="material-icons">person_outline</i>
                        <div>
                            <span class="meta-label">Müvekkil</span>
                            <span class="meta-value" id="detailMuvekkil"></span>
                        </div>
                    </div>
                    <div class="meta-item hidden-section" id="detailTelefonItem">
                        <i class="material-icons">phone</i>
                        <div>
                            <span class="meta-label">Telefon</span>
                            <span class="meta-value" id="detailTelefon"></span>
                        </div>
                    </div>
                    <!-- Mevcut Atanan Kişi ve Durum -->
                    <div class="meta-item" id="detailAssignedToItem">
                        <i class="material-icons">person</i>
                        <div>
                            <span class="meta-label">Atanan Kişi</span>
                            <span class="meta-value" id="detailAssignedTo"></span>
                        </div>
                    </div>
                    <div class="meta-item" id="detailStatusItem">
                        <i class="material-icons">check_circle</i>
                        <div>
                            <span class="meta-label">Durum</span>
                            <span class="meta-value" id="detailStatus"></span>
                        </div>
                    </div>
                </div>
                <div class="event-description">
                    <h4>
                        <i class="material-icons">description</i>
                        Açıklama
                    </h4>
                    <p id="detailDescription"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn secondary" id="editDetailBtn">
                <i class="material-icons">edit</i>
                Düzenle
            </button>
            <button class="btn danger" id="deleteDetailBtn">
                <i class="material-icons">delete</i>
                Sil
            </button>
        </div>
    </div>
</div>

<!-- Etkinlik Listesi Modalı -->
<div id="eventListModal" class="modal">
    <div class="modal-content list-modal">
        <div class="modal-header">
            <h3 id="listModalTitle"></h3>
            <button class="close-btn" id="closeListModal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body">
            <div id="eventListContent" class="event-list-content">
            </div>
        </div>
    </div>
</div>
{% endblock %} 