{% extends "layout.html" %}

{% block title %}Avukatlık Sözleşmeleri{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Ana düzen */
    .sozlesme-container {
        display: flex;
        flex-direction: column; /* Ana konteyneri dikey yaptık */
        gap: 1.5rem;
        padding: 1.5rem;
        min-height: calc(100vh - 80px);
    }
    
    /* Form Paneli */
    .sozlesme-form-panel {
        width: 100%; /* Form panelini tam genişlik yaptık */
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
        /* max-height: calc(100vh - 110px); // Artık bu kısıtlamaya gerek yok veya ayarlanabilir */
    }
    
    .sozlesme-form-header {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .sozlesme-form-content {
        flex: 1;
        overflow-y: auto; /* Form içeriği uzunsa scroll edilebilir */
        padding: 1.5rem;
    }
    
    .form-section {
        background-color: #f8f9fa;
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .form-section-header {
        border-bottom: 1px solid #e9ecef;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
    }

    /* Tablo Stilleri */
    th[data-sort-key] {
        cursor: pointer;
    }
    th[data-sort-key]:hover {
        background-color: #e9ecef !important;
    }
    th .material-icons {
        font-size: 1rem;
        vertical-align: middle;
    }
    .btn-group-sm .btn {
        padding: 0.2rem 0.4rem;
    }
    .btn-group-sm .material-icons {
        font-size: 1rem;
    }

    /* PDF Önizleme */
    .pdf-viewer {
        height: 100%; 
        width: 100%;
        background-color: #f5f5f5;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }
    
    .pdf-viewer iframe {
        width: 100%;
        height: 100%;
        border: none;
    }
    
    /* PDF Modal için temel stiller - Bootstrap modal olmadığı için gereksiz */
    
    /* Modal z-index ayarları */
    .modal {
        z-index: 9999999 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        overflow: auto !important;
        pointer-events: auto !important;
    }
    .modal-backdrop { 
        z-index: 9999998 !important;
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        pointer-events: auto !important;
    }
    
    /* Modal content area tıklanabilir yap */
    .modal.show {
        display: block !important;
        pointer-events: auto !important;
    }
    
    .modal-dialog {
        position: relative !important;
        z-index: inherit !important;
        pointer-events: auto !important;
    }
    
    .modal-content {
        pointer-events: auto !important;
        z-index: inherit !important;
    }
    
    /* Modal açık olduğunda body'yi düzelt */
    body.modal-open {
        overflow: hidden !important;
    }
    
    body.modal-open .modal-backdrop {
        opacity: 0.5 !important;
        background-color: rgba(0, 0, 0, 0.5) !important;
    }

    /* Yardımcı Stiller */
    .loading-spinner-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        color: #6c757d;
    }
    
    .empty-state {
        text-align: center;
        padding: 2rem;
        color: #6c757d;
    }
    .empty-state .material-icons {
        font-size: 3rem;
        margin-bottom: 0.5rem;
    }

    /* Buton hover efektleri */
    #yeniSozlesmeModalBtn:hover,
    #tabloBosBtnYeniEkle:hover {
        background-color: #3c404d !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    /* KUSURSUZ MODAL CSS - YENİ VE TEMİZ */
    #sozlesmeFormModal .form-control,
    #taslakDuzenleModal .form-control {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #sozlesmeFormModal .form-control:focus,
    #taslakDuzenleModal .form-control:focus {
        border-color: #16181e;
        box-shadow: 0 0 0 0.25rem rgba(22, 24, 30, 0.15);
    }

    #sozlesmeFormModal .card,
    #taslakDuzenleModal .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    #sozlesmeFormModal .card:hover,
    #yeniSozlesmeModal .card:hover,
    #taslakDuzenleModal .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
    }

    /* Focus stili tema renginde */
    #sozlesmeFormModal .form-control:focus,
    #sozlesmeFormModal .form-select:focus,
    #yeniSozlesmeModal .form-control:focus,
    #yeniSozlesmeModal .form-select:focus,
    #taslakDuzenleModal .form-control:focus,
    #taslakDuzenleModal .form-select:focus {
        border-color: #2d313c;
        box-shadow: 0 0 0 0.2rem rgba(45, 49, 60, 0.25);
    }

    /* Responsive design */
    @media (max-width: 992px) {
        #sozlesmeFormModal .modal-dialog,
        #yeniSozlesmeModal .modal-dialog,
        #taslakDuzenleModal .modal-dialog {
            max-width: 95vw;
        }
        #sozlesmeFormModal .row > div,
        #yeniSozlesmeModal .row > div,
        #taslakDuzenleModal .row > div {
            margin-bottom: 1rem;
        }
    }

    /* Responsive mobile davranış */
    @media (max-width: 768px) {
        .custom-wide-modal {
            max-width: 100vw !important;
            width: 100vw !important;
            margin: 0 !important;
        }
        
        .custom-wide-modal .modal-content {
            height: 100vh !important;
            border-radius: 0 !important;
        }
        
        .custom-wide-modal .modal-body {
            padding: 1rem !important;
            max-height: calc(100vh - 160px) !important;
        }
    }
    
</style>
{% endblock %}

{% block content %}
<!-- Modal Stillerini Geçersiz Kılacak Özel CSS -->
<style>
/* Bu stiller tüm diğer CSS'leri geçersiz kılacak */
#pdfOnizlemeModal {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    padding: 0 !important;
    margin: 0 !important;
    z-index: 9999999 !important;
}

#pdfOnizlemeModal .modal-dialog {
    width: 100% !important;
    max-width: 100% !important;
    height: 100% !important;
    max-height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    transform: none !important;
}

#pdfOnizlemeModal .modal-content {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
}

#pdfOnizlemeModal .modal-body {
    padding: 0 !important;
    height: calc(100vh - 130px) !important;
    overflow: hidden !important;
}

#pdfOnizlemeModal .pdf-viewer {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

#pdfOnizlemeModal .pdf-viewer iframe {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
}


</style>

<div class="container-fluid mt-4">
    <!-- Sayfa Başlığı -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-light p-4 rounded shadow-sm">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="display-6 mb-2"><i class="material-icons align-middle me-2" style="font-size: 36px;">description</i>Avukatlık Sözleşmeleri</h1>
                        <p class="text-muted lead mb-0">Avukatlık ücret sözleşmelerinizi yönetin, yeni sözleşme oluşturun.</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn" style="background-color: #2d313c; color: white; border: none;" id="yeniSozlesmeModalBtn">
                            <i class="material-icons align-middle me-2" style="color: white;">add</i>Yeni Sözleşme
                        </button>
                        <button class="btn btn-outline-primary" id="taslakDuzenleBtn">
                            <i class="material-icons align-middle me-2">edit_note</i>Taslak Düzenle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kayıtlı Sözleşmeler Tablosu -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light" style="padding: 1rem 1.25rem;">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <h5 class="mb-0 flex-shrink-0"><i class="material-icons align-middle me-2">list_alt</i> Kayıtlı Sözleşmeler</h5>
                        <div class="search-box-container d-flex align-items-center" style="position: relative; min-width: 250px; max-width: 350px; flex: 0 1 auto;">
                            <input type="text" id="contractsSearchInput" class="form-control form-control-sm" placeholder="Müvekkil adı ile arayınız..." style="padding-right: 35px; border-radius: 20px; border: 1px solid #ddd;">
                            <button type="button" id="clearContractsSearchBtn" class="btn btn-sm" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; padding: 2px 5px; display: none; z-index: 10;">
                                <i class="material-icons" style="font-size: 16px; color: #666;">close</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="kayitliSozlesmelerTablosu">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" style="cursor:pointer;" data-sort-key="muvekkil_adi">İş Sahibi <i class="material-icons align-middle">unfold_more</i></th>
                                    <th scope="col" style="cursor:pointer;" data-sort-key="avukatlik_ucreti">Av. Ücreti <i class="material-icons align-middle">unfold_more</i></th>
                                    <th scope="col" style="cursor:pointer;" data-sort-key="sozlesme_tarihi">Tarih <i class="material-icons align-middle">unfold_more</i></th>
                                    <th scope="col" class="text-center">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="sozlesmeTableBody">
                                <!-- JS ile doldurulacak -->
                            </tbody>
                        </table>
                    </div>
                    <div id="tabloYukleniyor" class="loading-spinner-container" style="display:none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-3">Sözleşmeler yükleniyor...</p>
                    </div>
                    <div id="tabloBos" class="empty-state" style="display:none;">
                        <i class="material-icons">description_off</i>
                        <p>Henüz kayıtlı bir sözleşme bulunmuyor.</p>
                        <button class="btn" style="background-color: #2d313c; color: white; border: none;" id="tabloBosBtnYeniEkle">
                            <i class="material-icons align-middle me-2" style="color: white;">add</i>İlk Sözleşmenizi Oluşturun
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- KUSURSUZ SÖZLEŞME DÜZENLEME MODAL - YENI TASARIM -->
<div class="modal fade" id="sozlesmeFormModal" tabindex="-1" aria-labelledby="sozlesmeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <!-- HEADER -->
            <div class="modal-header" style="background: #16181e; color: white; border: none; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-bold" id="sozlesmeModalLabel">
                    <i class="material-icons align-middle me-2" style="font-size: 1.5rem;">edit</i>
                    <span id="formBaslik">Sözleşme Düzenle</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            
            <!-- BODY -->
            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Bilgi Kartı -->
                <div class="alert alert-light d-flex align-items-center mb-4" role="alert" style="border: 1px solid #dee2e6; border-radius: 10px; background: #f8f9fa;">
                    <i class="material-icons me-3" style="font-size: 2rem; color: #16181e;">edit_note</i>
                    <div>
                        <h6 class="mb-1 fw-bold" id="formAltBaslik">Mevcut sözleşme bilgilerini düzenleyebilirsiniz.</h6>
                        <small class="text-muted">Değişiklikler kaydedildikten sonra yeni PDF oluşturulacaktır. Zorunlu alanlar * ile işaretlenmiştir.</small>
                    </div>
                </div>

                <!-- FORM -->
                <form id="sozlesmeForm" class="needs-validation" novalidate>
                    <input type="hidden" id="sozlesmeId">
                    
                    <!-- MODERN 4 KOLONLU GRID LAYOUT -->
                    <div class="row g-4">
                        <!-- 1. MÜVEKKİL BİLGİLERİ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #495057; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">person</i>Müvekkil
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="isSahibiAdi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">person</i>Ad/Ünvan *
                                        </label>
                                        <input type="text" class="form-control" id="isSahibiAdi" placeholder="Müvekkil adı giriniz" required>
                                        <div class="invalid-feedback">Ad/Ünvan gerekli</div>
                                    </div>
                                    <div class="mb-0">
                                        <label for="isSahibiTc" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">badge</i>T.C. Kimlik No
                                        </label>
                                        <input type="text" class="form-control" id="isSahibiTc" placeholder="T.C. Kimlik numarası giriniz" maxlength="11">
                                    </div>
                                    <div class="mb-0">
                                        <label for="isSahibiAdresi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">location_on</i>Adres *
                                        </label>
                                        <textarea class="form-control" id="isSahibiAdresi" rows="4" placeholder="Tam adres giriniz" required></textarea>
                                        <div class="invalid-feedback">Adres gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. ANA ÜCRET -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6c757d; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">attach_money</i>Ana Ücret
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="avukatlikUcreti" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">attach_money</i>Avukatlık Ücreti *
                                        </label>
                                        <input type="text" class="form-control" id="avukatlikUcreti" placeholder="15.000 TL" required>
                                        <div class="invalid-feedback">Ücret gerekli</div>
                                    </div>
                                    <div class="mb-0">
                                        <label for="sozlesmeTarihi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">event</i>Tarih *
                                        </label>
                                        <input type="date" class="form-control" id="sozlesmeTarihi" required>
                                        <div class="invalid-feedback">Tarih gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. EK ÜCRETLER -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6f7681; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">payments</i>Ek Ücretler
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="giderAvansi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">account_balance_wallet</i>Gider Avansı
                                        </label>
                                        <input type="text" class="form-control" id="giderAvansi" placeholder="1000 (veya - yazın)">
                                    </div>
                                    <div class="mb-3">
                                        <label for="gunlukUcret" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">today</i>Günlük Ücret
                                        </label>
                                        <input type="text" class="form-control" id="gunlukUcret" placeholder="500 (veya - yazın)">
                                    </div>
                                    <div class="mb-0">
                                        <label for="durusmaUcreti" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">gavel</i>Duruşma Ücreti
                                        </label>
                                        <input type="text" class="form-control" id="durusmaUcreti" placeholder="2000 (veya - yazın)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. İŞ AÇIKLAMASI -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #5a6268; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">description</i>İş Açıklaması
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-0">
                                        <label for="alinanIs" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">work</i>Üzerine Alınan İş *
                                        </label>
                                        <textarea class="form-control" id="alinanIs" rows="8" placeholder="Avukatın hangi işi üzerine aldığını detaylı olarak açıklayın..." required></textarea>
                                        <div class="invalid-feedback">İş açıklaması gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- FOOTER -->
            <div class="modal-footer" style="background: white; border-top: 1px solid #dee2e6; padding: 1.5rem 2rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="material-icons align-middle me-1">close</i>İptal
                </button>
                <button type="button" class="btn btn-outline-warning" id="formSifirlaBtn">
                    <i class="material-icons align-middle me-1">refresh</i>Temizle
                </button>
                <button type="button" class="btn btn-success" id="sozlesmeGuncelleBtn" style="display: none;">
                    <i class="material-icons align-middle me-1">save</i>Güncelle ve Kaydet
                </button>
                <button type="submit" form="sozlesmeForm" class="btn btn-primary" id="sozlesmeOlusturBtn">
                    <i class="material-icons align-middle me-1">add</i>Yeni Sözleşme Oluştur
                </button>
            </div>
        </div>
    </div>
</div>

<!-- KUSURSUZ YENİ SÖZLEŞME MODAL - TAMAMEN AYRI -->
<div class="modal fade" id="yeniSozlesmeModal" tabindex="-1" aria-labelledby="yeniSozlesmeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <!-- HEADER -->
            <div class="modal-header" style="background: #16181e; color: white; border: none; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-bold" id="yeniSozlesmeModalLabel">
                    <i class="material-icons align-middle me-2" style="font-size: 1.5rem;">description</i>
                    Yeni Avukatlık Sözleşmesi
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            
            <!-- BODY -->
            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Bilgi Kartı -->
                <div class="alert alert-light d-flex align-items-center mb-4" role="alert" style="border: 1px solid #dee2e6; border-radius: 10px; background: #f8f9fa;">
                    <i class="material-icons me-3" style="font-size: 2rem; color: #16181e;">info</i>
                    <div>
                        <h6 class="mb-1 fw-bold">Aşağıdaki formu doldurarak avukatlık ücret sözleşmesini oluşturabilirsiniz.</h6>
                        <small class="text-muted">Tüm alanları dikkatlice doldurun. Zorunlu alanlar * ile işaretlenmiştir.</small>
                    </div>
                </div>

                <!-- FORM -->
                <form id="yeniSozlesmeForm" class="needs-validation" novalidate>
                    
                    <!-- MODERN 4 KOLONLU GRID LAYOUT -->
                    <div class="row g-4">
                        <!-- 1. MÜVEKKİL BİLGİLERİ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #495057; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">person</i>Müvekkil
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="yeniIsSahibiAdi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">person</i>Ad/Ünvan *
                                        </label>
                                        <input type="text" class="form-control" id="yeniIsSahibiAdi" placeholder="Müvekkil adı giriniz" required>
                                        <div class="invalid-feedback">Ad/Ünvan gerekli</div>
                                    </div>
                                    <div class="mb-0">
                                        <label for="yeniIsSahibiTc" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">badge</i>T.C. Kimlik No
                                        </label>
                                        <input type="text" class="form-control" id="yeniIsSahibiTc" placeholder="T.C. Kimlik numarası giriniz" maxlength="11">
                                    </div>
                                    <div class="mb-0">
                                        <label for="yeniIsSahibiAdresi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">location_on</i>Adres *
                                        </label>
                                        <textarea class="form-control" id="yeniIsSahibiAdresi" rows="4" placeholder="Tam adres giriniz" required></textarea>
                                        <div class="invalid-feedback">Adres gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. ANA ÜCRET -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6c757d; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">attach_money</i>Ana Ücret
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="yeniAvukatlikUcreti" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">attach_money</i>Avukatlık Ücreti *
                                        </label>
                                        <input type="text" class="form-control" id="yeniAvukatlikUcreti" placeholder="15.000 TL" required>
                                        <div class="invalid-feedback">Ücret gerekli</div>
                                    </div>
                                    <div class="mb-0">
                                        <label for="yeniSozlesmeTarihi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">event</i>Tarih *
                                        </label>
                                        <input type="date" class="form-control" id="yeniSozlesmeTarihi" required>
                                        <div class="invalid-feedback">Tarih gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. EK ÜCRETLER -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6f7681; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">payments</i>Ek Ücretler
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="yeniGiderAvansi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">account_balance_wallet</i>Gider Avansı
                                        </label>
                                        <input type="text" class="form-control" id="yeniGiderAvansi" placeholder="1000 (veya - yazın)">
                                    </div>
                                    <div class="mb-3">
                                        <label for="yeniGunlukUcret" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">today</i>Günlük Ücret
                                        </label>
                                        <input type="text" class="form-control" id="yeniGunlukUcret" placeholder="500 (veya - yazın)">
                                    </div>
                                    <div class="mb-0">
                                        <label for="yeniDurusmaUcreti" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">gavel</i>Duruşma Ücreti
                                        </label>
                                        <input type="text" class="form-control" id="yeniDurusmaUcreti" placeholder="2000 (veya - yazın)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. İŞ AÇIKLAMASI -->
                        <div class="col-lg-3 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #5a6268; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">description</i>İş Açıklaması
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-0">
                                        <label for="yeniAlinanIs" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">work</i>Üzerine Alınan İş *
                                        </label>
                                        <textarea class="form-control" id="yeniAlinanIs" rows="8" placeholder="Avukatın hangi işi üzerine aldığını detaylı olarak açıklayın..." required></textarea>
                                        <div class="invalid-feedback">İş açıklaması gerekli</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- FOOTER -->
            <div class="modal-footer" style="background: white; border-top: 1px solid #dee2e6; padding: 1.5rem 2rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="material-icons align-middle me-1">close</i>İptal
                </button>
                <button type="button" class="btn btn-outline-warning" id="yeniFormSifirlaBtn">
                    <i class="material-icons align-middle me-1">refresh</i>Temizle
                </button>
                <button type="submit" form="yeniSozlesmeForm" class="btn btn-success">
                    <i class="material-icons align-middle me-1">save</i>Oluştur ve Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Önizleme Modal - Bootstrap Modal Kullanmıyoruz -->
<div id="pdfOnizlemeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999999; background-color: #fff; overflow: hidden;">
    <div style="width: 100%; height: 60px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;">
        <h5 style="margin: 0; font-size: 1.25rem;">
            <i class="material-icons align-middle me-2">visibility</i>Sözleşme Önizleme
        </h5>
        <button type="button" id="modalCloseBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;" onclick="window.closeFullscreenPdfModal()">×</button>
    </div>
    <div style="height: calc(100vh - 120px); width: 100%; padding: 0; overflow: hidden;">
        <div id="pdfGoruntuleyici" style="width: 100%; height: 100%; background-color: #f5f5f5; display: flex; align-items: center; justify-content: center;">
            <div class="loading-spinner-container h-100">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3">PDF oluşturuluyor...</p>
            </div>
        </div>
    </div>
    <div style="height: 60px; border-top: 1px solid #dee2e6; display: flex; justify-content: center; align-items: center; padding: 0 20px;">
        <button type="button" id="modalBackBtn" class="btn btn-outline-secondary" onclick="window.closeFullscreenPdfModal()">
            <i class="material-icons align-middle me-1">arrow_back</i>Forma Dön
        </button>
        <small class="text-muted ms-3">PDF indirmek için sağ tıklayıp "Kaydet" seçeneğini kullanabilirsiniz.</small>
    </div>
</div>

<!-- Silme Onay Modalı -->
<div class="modal fade" id="sozlesmeSilModal" tabindex="-1" aria-labelledby="sozlesmeSilModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sozlesmeSilModalLabel">
            <i class="material-icons align-middle me-2 text-danger">warning</i>Sözleşme Silme Onayı
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <p id="sozlesmeSilMesaj">Bu sözleşmeyi silmek istediğinize emin misiniz? Bu işlem geri alınamaz.</p>
        <input type="hidden" id="silinecekSozlesmeId">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">İptal</button>
        <button id="sozlesmeSilOnayBtn" type="button" class="btn btn-danger">
            <i class="material-icons align-middle me-1">delete</i>Sil
        </button>
      </div>
    </div>
  </div>
</div>

<!-- KUSURSUZ TASLAK DÜZENLEME MODAL - YENI TASARIM -->
<div class="modal fade" id="taslakDuzenleModal" tabindex="-1" aria-labelledby="taslakModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <!-- HEADER -->
            <div class="modal-header" style="background: #16181e; color: white; border: none; padding: 1.5rem 2rem;">
                <h5 class="modal-title fw-bold" id="taslakModalLabel">
                    <i class="material-icons align-middle me-2" style="font-size: 1.5rem;">edit_note</i>
                    Taslak Sözleşme Düzenle
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            
            <!-- BODY -->
            <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Bilgi Kartı -->
                <div class="alert alert-light d-flex align-items-center mb-4" role="alert" style="border: 1px solid #dee2e6; border-radius: 10px; background: #f8f9fa;">
                    <i class="material-icons me-3" style="font-size: 2rem; color: #16181e;">settings</i>
                    <div>
                        <h6 class="mb-1 fw-bold">Bu sayfada yeni sözleşmelerde kullanılacak varsayılan şablonu düzenleyebilirsiniz.</h6>
                        <small class="text-muted">Değişiklikler otomatik olarak kaydedilecektir. Tüm yeni sözleşmeler bu bilgileri kullanacaktır.</small>
                    </div>
                </div>

                <!-- FORM -->
                <form id="taslakDuzenleForm" class="needs-validation" novalidate>
                    
                    <!-- MODERN 3 KOLONLU GRID LAYOUT -->
                    <div class="row g-4 mb-4">
                        <!-- 1. AVUKAT BİLGİLERİ -->
                        <div class="col-lg-4 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #495057; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">account_circle</i>Avukat Bilgileri
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="taslakAvukatAdi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">person</i>Avukat Adı
                                        </label>
                                        <input type="text" class="form-control" id="taslakAvukatAdi" value="Av. Mustafa KAPLAN">
                                    </div>
                                    <div class="mb-0">
                                        <label for="taslakAvukatAdres" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">location_on</i>Avukat Adresi
                                        </label>
                                        <textarea class="form-control" id="taslakAvukatAdres" rows="4">Güneşli Meydanı Cumhuriyet Cd. No.47 K.3 D.8 (AKBANK ÜSTÜ) GÜNEŞLİ/İST.</textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. BANKA BİLGİLERİ -->
                        <div class="col-lg-4 col-md-6">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6c757d; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">account_balance</i>Banka Bilgileri
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="taslakBankaBilgisi" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">business</i>Banka ve Şube
                                        </label>
                                        <input type="text" class="form-control" id="taslakBankaBilgisi" value="Garanti Bankası Güneşli Şubesi">
                                    </div>
                                    <div class="mb-0">
                                        <label for="taslakIbanNo" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">credit_card</i>İban Numarası
                                        </label>
                                        <input type="text" class="form-control" id="taslakIbanNo" value="TR930006200029500006684655">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. MAHKEME BİLGİLERİ -->
                        <div class="col-lg-4 col-md-12">
                            <div class="card h-100 border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #6f7681; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">gavel</i>Mahkeme Bilgileri
                                    </h6>
                                </div>
                                <div class="card-body p-3">
                                    <div class="mb-3">
                                        <label for="taslakYetkiliMahkeme" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">gavel</i>Yetkili Mahkeme
                                        </label>
                                        <input type="text" class="form-control" id="taslakYetkiliMahkeme" value="Bakırköy Mahkemeleri ve icra daireleri">
                                    </div>
                                    <div class="mb-0">
                                        <label for="taslakKanunNo" class="form-label fw-semibold">
                                            <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">book</i>Kanun Numarası
                                        </label>
                                        <input type="text" class="form-control" id="taslakKanunNo" value="1136 sayılı Avukatlık Kanunu">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SÖZLEŞME MADDELERİ - TEK KOLON -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-0 shadow-sm" style="border-radius: 12px; overflow: hidden;">
                                <div class="card-header text-white text-center py-3" style="background: #5a6268; border: none;">
                                    <h6 class="mb-0 fw-bold">
                                        <i class="material-icons align-middle me-2">description</i>Sözleşme Maddeleri Metinleri
                                    </h6>
                                </div>
                                <div class="card-body p-4">
                                    <div class="row g-4">
                                        <!-- Giriş Metni -->
                                        <div class="col-12">
                                            <label for="taslakGirisMetni" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">start</i>Giriş Metni
                                            </label>
                                            <textarea class="form-control" id="taslakGirisMetni" rows="3">Yukarıda adı, soyadı (veya ünvanı) ile tebligata elverişli adresleri belirtilen taraflar arasında aşağıda yazılı şartlarla AVUKATLIK ÜCRET SÖZLEŞMESİ yapılmıştır. Bu sözleşmede iş sahibi MÜVEKKİL ve işi üzerine alan AVUKAT diye adlandırılmıştır.</textarea>
                                        </div>
                                        
                                        <!-- Madde 2 -->
                                        <div class="col-12">
                                            <label for="taslakMadde2" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">account_balance_wallet</i>Madde 2) Sözleşme Konusu ve Avukatlık Ücreti
                                            </label>
                                            <textarea class="form-control" id="taslakMadde2" rows="4">Sözleşme konusu olan işten dolayı, Avukat'a {avukatlikUcreti} avukatlık ücreti ödenecektir.
Bu ücret {avukatAdi}'a ait {bankaBilgisi} {ibanNo} İban nolu hesaba ödenecektir. Belirli sürelerde yapılması gereken ödemelerden herhangi biri yapılmadığı takdirde ücretin tamamı muaccel olur. İş sahibinin birden çok olması halinde sözleşmeyi birlikte imzalayanlar, Avukatlık Ücretinin ödenmesinde Avukata karşı müteselsilen borçlu ve sorumludurlar.</textarea>
                                        </div>
                                        
                                        <!-- Madde 3 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde3" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">attach_money</i>Madde 3) Ücret Koşulları
                                            </label>
                                            <textarea class="form-control" id="taslakMadde3" rows="6">Tespit olunan ücret yalnız bu sözleşmede yazılı işin ve işlerin karşılığıdır. Bunlar dışında kalacak takipler ve bu işle ilgili bağlantılı bulunsa dahi karşı taraf veya üçüncü bir şahıs tarafından karşılıklı dava veya ayrı davalar şeklinde açılacak davalar bu sözleşme ücretin dışındadır. Avukat, bu sözleşmeye göre peşin verilmesi gerekli ücret ve aşağıda yazılı gider avansı kendisine ödenmediği sürece işe başlamak zorunluluğunda değildir. İş sahibi ile ilgili yapılacak hukuki, idari ve adli işlemlerden kaynaklanacak masraflar iş sahibine aittir.</textarea>
                                        </div>
                                        
                                        <!-- Madde 4 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde4" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">verified_user</i>Madde 4) Avukat Yetkileri
                                            </label>
                                            <textarea class="form-control" id="taslakMadde4" rows="6">Avukat üzerine aldığı işi kanun ve bu sözleşme hükümleri uyarınca sonuna kadar takip edecektir. Avukat, verilen vekaletname ile başkasını tevkile yetkili bulunduğu takdirde, üzerine aldığı işi uygun göreceği diğer Avukatlarla birlikte takip edebileceği gibi, takibi tamamen onlara bırakabilecektir. Müvekkil de, Avukatın yazılı iznini almak şartı ile başka Avukatlara vekalet verebilir. Bu hallerde 1136 sayılı Kanunun 171 ve 172. Maddeleri hükmü uygulanır.</textarea>
                                        </div>
                                        
                                        <!-- Madde 5 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde5" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">payment</i>Madde 5) Gider ve Masraflar
                                            </label>
                                            <textarea class="form-control" id="taslakMadde5" rows="6">İşin yapılması için gerekli bütün vergi, resim, harç gibi giderler müvekkile ait olup, Avukatın ilk isteminde Müvekkil tarafından Avukata veya merciine ödenmesi gerekir. Verilen iş için yapılacak giderlerin tümü müvekkile aittir ve bu giderler ödenmedikçe Avukat işi yapmak zorunda değildir. Müvekkil bu iş için Avukata {giderAvansi}-TL gider avansını peşin olarak verecektir. Müvekkil yolculuk giderlerinden başka, Avukatın bürosundan ayrı kaldığı her gün için {gunlukUcret}-TL ödemeyi kabul etmiştir. Duruşma için {durusmaUcreti}-TL verilecektir.</textarea>
                                        </div>
                                        
                                        <!-- Madde 6 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde6" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">cancel</i>Madde 6) Sözleşme Feshi
                                            </label>
                                            <textarea class="form-control" id="taslakMadde6" rows="6">Müvekkilin bu sözleşmenin akdinden sonra vekalet vermemesi, dosyasını geri alması, Avukatın yazılı iznini almadan başka Avukatları teşrik etmesi veya bir başka Avukata işini vermesi, istenen giderleri ödememesi, iddia veya savunma için gerekli bilgi, belge ve delilleri vermemesi, değiştirdiği halde yeni adresini yazılı olarak bildirmeyip işin takibini bu suretle imkansız hale getirmesi durumlarında Avukat sözleşmeyi bozabilir.</textarea>
                                        </div>
                                        
                                        <!-- Madde 7 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde7" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">mail</i>Madde 7) Tebligat Adresi
                                            </label>
                                            <textarea class="form-control" id="taslakMadde7" rows="6">Yukarıda yazılı adres müvekkilin tebligat adresidir. Avukat tarafından bu adrese yapılacak bütün ihbar ve tebliğlerin şahsına yapılmış olduğunu kabul eder. Müvekkil adresini değiştirdiği takdirde yeni adresini Avukata derhal bildirmek zorundadır. Yukarıda yazılı adrese gönderilecek yazıların tebliğ edilmesinden ve yeni adresini bildirmemesinden doğacak sonuçları müvekkil şimdiden kabul eder.</textarea>
                                        </div>
                                        
                                        <!-- Madde 8 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde8" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">schedule</i>Madde 8) Sözleşme Süresi
                                            </label>
                                            <textarea class="form-control" id="taslakMadde8" rows="6">İş bu sözleşmenin süresi sözleşmenin imzalandığı tarihten itibaren 1 yıldır. Taraflar anlaşarak 1 yılın sonunda sözleşmeyi karşılıklı olarak feshetmezler ise Avukatlık ücreti 1(bir) yılın sonunda TEFE/TÜFE ortalaması alınarak resen artar.</textarea>
                                        </div>
                                        
                                        <!-- Madde 9 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde9" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">book</i>Madde 9) Uygulanacak Kanun
                                            </label>
                                            <textarea class="form-control" id="taslakMadde9" rows="6">İş bu sözleşmede açıklık bulunmayan durumlarda {kanunNo} hükümleri uygulanır.</textarea>
                                        </div>
                                        
                                        <!-- Madde 10 -->
                                        <div class="col-md-6">
                                            <label for="taslakMadde10" class="form-label fw-semibold">
                                                <i class="material-icons me-1 text-secondary" style="font-size: 1rem;">location_city</i>Madde 10) Yetkili Mahkeme
                                            </label>
                                            <textarea class="form-control" id="taslakMadde10" rows="6">Bu sözleşmeden doğacak anlaşmazlıklarda yetkili mercii {yetkiliMahkeme}dir.</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- FOOTER -->
            <div class="modal-footer" style="background: white; border-top: 1px solid #dee2e6; padding: 1.5rem 2rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="material-icons align-middle me-1">close</i>İptal
                </button>
                <button type="button" class="btn btn-outline-warning" id="taslakVarsayilanBtn">
                    <i class="material-icons align-middle me-1">restore</i>Varsayılana Dön
                </button>
                <button type="button" class="btn btn-success" id="taslakKaydetBtn">
                    <i class="material-icons align-middle me-1">save</i>Değişiklikleri Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Bildirimleri -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>
{% endblock %}

{% block scripts %}
{{ super() }}
<!-- pdfMake zaten layout.html'de yüklendiği için tekrar yüklemeye gerek yok -->

<script>
    // CSRF Token kontrolü
    if (typeof CSRF_TOKEN === 'undefined') {
        console.warn("CSRF_TOKEN tanımlı değil. Güvenlik için layout.html kontrol edilmeli.");
        const CSRF_TOKEN = "{{ csrf_token() }}";
    }
    
    // TÜM KRİTİK FONKSİYONLAR - EN BAŞTA TANıMLANDI (ACİL ERİŞİM İÇİN)
    
    // ÜCRET ALANI VALIDASYON FONKSİYONU - EN BAŞTA
    window.ucretAlaniniTemizle = function(deger) {
        if (!deger || deger.toString().trim() === '') {
            return '';
        }
        if (deger.toString().trim() === '-') {
            return '-';
        }
        return deger.toString().trim();
    };

    // Ücret metni oluştur - sadece değer varsa göster
    window.ucretMetniOlustur = function(formVerileri) {
        let giderAvansiMetni = '';
        let gunlukUcretMetni = '';
        let durusmaUcretiMetni = '';

        if (formVerileri.giderAvansi && formVerileri.giderAvansi.trim() !== '') {
            giderAvansiMetni = `Müvekkil bu iş için Avukata ${formVerileri.giderAvansi}-TL gider avansını peşin olarak verecektir. `;
        }

        if (formVerileri.gunlukUcret && formVerileri.gunlukUcret.trim() !== '') {
            gunlukUcretMetni = `Müvekkil yolculuk giderlerinden başka, Avukatın bürosundan ayrı kaldığı her gün için ${formVerileri.gunlukUcret}-TL ödemeyi kabul etmiştir. `;
        }

        if (formVerileri.durusmaUcreti && formVerileri.durusmaUcreti.trim() !== '') {
            durusmaUcretiMetni = `Yargıtay, Danıştay ve Vergi Temyiz Komisyonları huzurunda duruşma ayrı ücrete tabidir. Bu takdirde yukarıda sayılan yol giderlerinden başka Avukata ${formVerileri.durusmaUcreti}-TL verilecektir. Bu paralar peşin ödenmedikçe Avukat duruşmada bulunmak zorunda değildir.`;
        }

        return `İşin yapılması için gerekli bütün vergi, resim, harç gibi giderler müvekkile ait olup, Avukatın ilk isteminde Müvekkil tarafından Avukata veya merciine ödenmesi gerekir. Verilen iş için yapılacak giderlerin tümü müvekkile aittir ve bu giderler ödenmedikçe Avukat işi yapmak zorunda değildir. Yukarıda sayılan giderlerin Avukat tarafından yapılabilmesini Sağlamak için müvekkil, giderleri karşılayacak avansı Zamanında vermek zorunluluğundadır. ${giderAvansiMetni}İş seyahati gerektiğinde uçak 1. mevki yataklı tarifesine göre tren, vapur ve bilet ücretleri müvekkil tarafından ücretten ayrı olarak ödenecektir. Bu giderler verilmeksizin Avukat seyahati yapmak zorunda değildir. ${gunlukUcretMetni}${durusmaUcretiMetni}`;
    };

    // Bildirim göster fonksiyonu - EN ÖNCE TANıMLANDI
    window.bildirimGoster = function(baslik, mesaj, tip = 'info') {
        try {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                console.warn("Toast container bulunamadı, console'a yazılıyor:", baslik, mesaj);
                return;
            }
            const toastId = `toast-${Date.now()}`;
            const bgClass = tip === 'success' ? 'bg-success' : tip === 'warning' ? 'bg-warning' : tip === 'error' ? 'bg-danger' : 'bg-info';
            const textClass = ['warning'].includes(tip) ? 'text-dark' : 'text-white';
            const toastHtml = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} ${textClass}">
                        <i class="material-icons me-2">${tip === 'success' ? 'check_circle' : tip === 'warning' ? 'warning' : tip === 'error' ? 'error' : 'info'}</i>
                        <strong class="me-auto">${baslik}</strong>
                        <button type="button" class="btn-close ${['warning'].includes(tip) ? '' : 'btn-close-white'}" data-bs-dismiss="toast" aria-label="Kapat"></button>
                    </div><div class="toast-body">${mesaj}</div></div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = document.getElementById(toastId);
            if (typeof bootstrap !== 'undefined' && bootstrap.Toast) {
                const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 5000 });
                toast.show();
                toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
            } else {
                console.warn("Bootstrap Toast bulunamadı:", baslik, mesaj);
            }
        } catch (error) {
            console.error("bildirimGoster hatası:", error, baslik, mesaj);
        }
    };
    
    // PDF MODAL FONKSİYONLARI - HEMEN BAŞTA TANıMLANDI (ACİL ERİŞİM İÇİN)
    window.openFullscreenPdfModal = function() {
        console.log("PDF modal açılıyor...");
        try {
            const pdfModalElement = document.getElementById('pdfOnizlemeModal');
            if (!pdfModalElement) {
                console.error("PDF modal element bulunamadı!");
                if (typeof window.bildirimGoster === 'function') {
                    window.bildirimGoster('Hata', 'PDF önizleme modal element bulunamadı.', 'error');
                }
                return;
            }

            // Modalı göster - Bootstrap olmayan basit modal
            pdfModalElement.style.display = 'block';
            pdfModalElement.style.opacity = '1';
            document.body.style.overflow = 'hidden';
            
            console.log("PDF modal başarıyla açıldı");
            
        } catch (error) {
            console.error('PDF modal açma hatası:', error);
            if (typeof window.bildirimGoster === 'function') {
                window.bildirimGoster('Hata', 'PDF modal açılırken hata oluştu: ' + error.message, 'error');
            }
        }
    };
    
    window.closeFullscreenPdfModal = function() {
        console.log("PDF modal kapatılıyor...");
        try {
            const pdfModalElement = document.getElementById('pdfOnizlemeModal');
            if (pdfModalElement) {
                pdfModalElement.style.display = 'none';
                pdfModalElement.style.opacity = '0';
                document.body.style.overflow = '';
                console.log("PDF modal başarıyla kapatıldı");
            }
        } catch (error) {
            console.error('PDF modal kapatma hatası:', error);
        }
    };

    // KUSURSUZ MODAL - EKSTRA FONKSİYON GEREKMİYOR

    // Global değişkenler - fonksiyonlar bu değişkenlere erişebilsin diye global scope'ta tanımlandı
    let olusturulanPdfBelgesi = null;
    let aktifSozlesmeId = null;
    let allContractsData = []; // Sıralama için tüm sözleşme verilerini tutar
    let filteredContractsData = []; // Arama sonuçları için filtrelenmiş veriler
    let sortState = {}; // Aktif sıralama durumunu tutar: { key: 'muvekkil_adi', order: 'asc' }
    
    // Global DOM element referansları
    let sozlesmeIdInput;
    let pdfGoruntuleyici;
    let sozlesmeFormModal;
    let sozlesmeForm;
    let sozlesmeSilModal;
    
    // Özel modal kontrolleri
    let openFullscreenPdfModal, closeFullscreenPdfModal;
    
    // icerik_json'ı güvenli bir şekilde parse etmek için yardımcı fonksiyon
    function getParsedIcerikJson(icerikJsonData, contractIdForLog = 'N/A') {
        if (typeof icerikJsonData === 'string') {
            try {
                return JSON.parse(icerikJsonData);
            } catch (e) {
                console.error(`Failed to parse icerik_json for contract ID: ${contractIdForLog}`, e, "Raw data:", icerikJsonData);
                return null; 
            }
        }
        return icerikJsonData; // Zaten obje veya null/undefined ise olduğu gibi döndür
    }

    // Sayfa yüklendiğinde
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOMContentLoaded fired - Initializing...");
        
        // Modal'ları body'nin sonuna taşı - Bootstrap best practice
        const modalsToMove = [
            'sozlesmeFormModal',
            'yeniSozlesmeModal', 
            'sozlesmeSilModal',
            'taslakDuzenleModal'
        ];
        
        modalsToMove.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                document.body.appendChild(modal);
                console.log(`Modal ${modalId} body'ye taşındı`);
            }
        });
        
        // DOM elementlerini global değişkenlere ata
        sozlesmeIdInput = document.getElementById('sozlesmeId');
        const pdfOnizlemeModalElement = document.getElementById('pdfOnizlemeModal');
        pdfGoruntuleyici = document.getElementById('pdfGoruntuleyici');
        
        // Modal ve form referanslarını global değişkenlere ata
        sozlesmeForm = document.getElementById('sozlesmeForm');
        
        // Modal referanslarını global değişkenlere ata - Element kontrolü ekle
        
        // Düzenleme modalı
        const sozlesmeFormModalElement = document.getElementById('sozlesmeFormModal');
        if (sozlesmeFormModalElement) {
            sozlesmeFormModal = new bootstrap.Modal(sozlesmeFormModalElement, {
                backdrop: false,
                keyboard: false
            });
            window.sozlesmeFormModal = sozlesmeFormModal; // Global olarak ata
            console.log("sozlesmeFormModal (düzenleme) başarıyla oluşturuldu");
        } else {
            console.error("sozlesmeFormModal element bulunamadı!");
        }
        
        // Yeni sözleşme modalı
        const yeniSozlesmeModalElement = document.getElementById('yeniSozlesmeModal');
        if (yeniSozlesmeModalElement) {
            window.yeniSozlesmeModal = new bootstrap.Modal(yeniSozlesmeModalElement, {
                backdrop: false,
                keyboard: false
            });
            console.log("yeniSozlesmeModal başarıyla oluşturuldu");
        } else {
            console.error("yeniSozlesmeModal element bulunamadı!");
        }
        
        // Silme modalını da initialize et
        sozlesmeSilModal = new bootstrap.Modal(document.getElementById('sozlesmeSilModal'));
        
        // Taslak düzenleme modalı
        const taslakDuzenleModalElement = document.getElementById('taslakDuzenleModal');
        if (taslakDuzenleModalElement) {
            window.taslakDuzenleModal = new bootstrap.Modal(taslakDuzenleModalElement, {
                backdrop: false,
                keyboard: false
            });
            console.log("taslakDuzenleModal başarıyla oluşturuldu");
        } else {
            console.error("taslakDuzenleModal element bulunamadı!");
        }
        
        // PDF modal fonksiyonları artık global olarak tanımlandı
        
        // Global erişim için - Gelişmiş kontrol
        if (sozlesmeFormModal) {
            window.sozlesmeFormModal = sozlesmeFormModal;
            console.log("sozlesmeFormModal global olarak atandı");
        } else {
            console.error("sozlesmeFormModal instance oluşturulamadı!");
        }
        
        if (sozlesmeSilModal) {
            window.sozlesmeSilModal = sozlesmeSilModal;
            console.log("sozlesmeSilModal global olarak atandı");
        } else {
            console.error("sozlesmeSilModal instance oluşturulamadı!");
        }
        
        // İlk yüklemede test et
        console.log("=== SAYFA YÜKLENİYOR - DEBUG ===");
        console.log("Bootstrap mevcut:", typeof bootstrap !== 'undefined');
        console.log("sozlesmeFormModal element:", document.getElementById('sozlesmeFormModal'));
        console.log("yeniSozlesmeModalBtn element:", document.getElementById('yeniSozlesmeModalBtn'));
        console.log("pdfMake mevcut:", typeof pdfMake !== 'undefined');
        
        window.kayitliSozlesmeleriTabloyaListele();
        document.getElementById('sozlesmeTarihi').valueAsDate = new Date();
        
        console.log("Tüm elementler ve event listener'lar başarıyla yüklendi!");
        console.log("=== SAYFA YÜKLENDİ - DEBUG SONU ===");

        // YENİ SÖZLEŞME MODAL FONKSİYONU - YENİ MODAL İÇİN GÜNCELLENDİ
        window.yeniSozlesmeAc = function() {
            console.log("=== YENİ SÖZLEŞME MODAL AÇMA ===");
            console.log("yeniSozlesmeAc çağrıldı - Yeni sözleşme butonu tıklandı");
            
            try {
                // Önce bootstrap'ın yüklenip yüklenmediğini kontrol et
                if (typeof bootstrap === 'undefined') {
                    console.error("Bootstrap yüklenmemiş!");
                    window.bildirimGoster('Hata', 'Bootstrap kütüphanesi yüklenmemiş.', 'error');
                    return;
                }
                
                console.log("Yeni sözleşme formu sıfırlanıyor...");
                // Yeni sözleşme formunu sıfırla
                if (typeof window.yeniSozlesmeFormunuSifirla === 'function') {
                    window.yeniSozlesmeFormunuSifirla();
                } else {
                    // Form manuel olarak sıfırla
                    const yeniForm = document.getElementById('yeniSozlesmeForm');
                    if (yeniForm) {
                        yeniForm.reset();
                        yeniForm.classList.remove('was-validated');
                        document.getElementById('yeniSozlesmeTarihi').valueAsDate = new Date();
                    }
                }
                
                // Yeni sözleşme modal element kontrolü
                const yeniModalElement = document.getElementById('yeniSozlesmeModal');
                console.log("Yeni modal element:", yeniModalElement);
                
                if (!yeniModalElement) {
                    console.error("yeniSozlesmeModal HTML elementi bulunamadı!");
                    window.bildirimGoster('Hata', 'Modal HTML elementi bulunamadı.', 'error');
                    return;
                }
                
                // Modal instance'ı kontrol et ve oluştur
                if (window.yeniSozlesmeModal) {
                    console.log("Mevcut yeni modal instance kullanılıyor");
                    window.yeniSozlesmeModal.show();
                    
                    // Modal'ı en üstte tut (backdrop yok artık)
                    setTimeout(() => {
                        yeniModalElement.style.zIndex = '9999999';
                        yeniModalElement.style.position = 'fixed';
                    }, 50);
                } else {
                    console.log("Yeni modal instance oluşturuluyor...");
                    try {
                        const modal = new bootstrap.Modal(yeniModalElement, {
                            backdrop: false,
                            keyboard: false
                        });
                        window.yeniSozlesmeModal = modal;
                        modal.show();
                        console.log("Yeni modal instance oluşturuldu ve açıldı");
                        
                        // Modal'ı en üstte tut (backdrop yok artık)
                        setTimeout(() => {
                            yeniModalElement.style.zIndex = '9999999';
                            yeniModalElement.style.position = 'fixed';
                        }, 50);
                    } catch (modalError) {
                        console.error("Modal oluşturma hatası:", modalError);
                        // Son çare olarak modalı direkt göster
                        yeniModalElement.style.display = 'block';
                        yeniModalElement.classList.add('show');
                        document.body.classList.add('modal-open');
                        console.log("Modal manuel olarak gösterildi");
                    }
                }
                
                // İlk input'a focus ver (yeni modal için)
                setTimeout(() => {
                    const firstInput = document.getElementById('yeniIsSahibiAdi');
                    if (firstInput) {
                        firstInput.focus();
                        console.log("Yeni modal'da ilk input'a focus verildi");
                    }
                }, 300);
                
                console.log("=== YENİ SÖZLEŞME MODAL AÇMA TAMAMLANDI ===");
                
            } catch (error) {
                console.error('Yeni sözleşme modal açma genel hatası:', error);
                window.bildirimGoster('Hata', 'Modal açılırken bir hata oluştu: ' + error.message, 'error');
            }
        };

        // Event listener'ları ekle
        const yeniSozlesmeBtn = document.getElementById('yeniSozlesmeModalBtn');
        if (yeniSozlesmeBtn) {
            yeniSozlesmeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("Yeni sözleşme butonu tıklandı - event listener");
                window.yeniSozlesmeAc();
            });
            console.log("Yeni sözleşme butonu event listener eklendi");
        } else {
            console.error("yeniSozlesmeModalBtn elementi bulunamadı!");
        }

        const tabloBosBtnYeniEkle = document.getElementById('tabloBosBtnYeniEkle');
        if (tabloBosBtnYeniEkle) {
            tabloBosBtnYeniEkle.addEventListener('click', function(e) {
                e.preventDefault();
                console.log("Tablo boş yeni ekle butonu tıklandı - event listener");
                window.yeniSozlesmeAc();
            });
            console.log("Tablo boş butonu event listener eklendi");
        }

        // Tablo butonları için event delegation kullan (dinamik içerik için)
        document.getElementById('sozlesmeTableBody').addEventListener('click', function(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const sozlesmeId = target.dataset.sozlesmeId;
            
            if (target.classList.contains('preview-btn')) {
                console.log("Önizleme butonu tıklandı, ID:", sozlesmeId);
                window.sozlesmeDetayiYukle(parseInt(sozlesmeId), true);
            } else if (target.classList.contains('edit-btn')) {
                console.log("Düzenleme butonu tıklandı, ID:", sozlesmeId);
                window.sozlesmeDetayiYukle(parseInt(sozlesmeId), false);
            } else if (target.classList.contains('delete-btn')) {
                const sozlesmeName = target.dataset.sozlesmeName;
                console.log("Silme butonu tıklandı, ID:", sozlesmeId, "İsim:", sozlesmeName);
                window.sozlesmeSilModalGoster(parseInt(sozlesmeId), sozlesmeName);
            }
        });

        // Form sıfırlama butonu (düzenleme modalı)
        const formSifirlaBtn = document.getElementById('formSifirlaBtn');
        if (formSifirlaBtn) {
            formSifirlaBtn.addEventListener('click', function() {
                window.sozlesmeFormunuSifirla();
            });
        }

        // Yeni form sıfırlama butonu
        const yeniFormSifirlaBtn = document.getElementById('yeniFormSifirlaBtn');
        if (yeniFormSifirlaBtn) {
            yeniFormSifirlaBtn.addEventListener('click', function() {
                if (typeof window.yeniSozlesmeFormunuSifirla === 'function') {
                    window.yeniSozlesmeFormunuSifirla();
                } else {
                    const yeniForm = document.getElementById('yeniSozlesmeForm');
                    if (yeniForm) {
                        yeniForm.reset();
                        yeniForm.classList.remove('was-validated');
                        document.getElementById('yeniSozlesmeTarihi').valueAsDate = new Date();
                    }
                }
            });
        }

        // Yeni sözleşme form submit
        const yeniSozlesmeForm = document.getElementById('yeniSozlesmeForm');
        if (yeniSozlesmeForm) {
            yeniSozlesmeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log("Yeni sözleşme formu submit edildi");
                
                // Özel validasyon - opsiyonel ücret alanlarını temizle ve validasyondan çıkar
                const ucretAlanlari = ['yeniGiderAvansi', 'yeniGunlukUcret', 'yeniDurusmaUcreti'];
                ucretAlanlari.forEach(alanId => {
                    const alan = document.getElementById(alanId);
                    if (alan) {
                        // "-" karakterini ve boş değerleri temizle
                        if (alan.value.trim() === '-' || alan.value.trim() === '') {
                            alan.value = '0'; // Sayı alanları için "0" değeri ver
                        }
                        // Bu alanları validasyondan çıkar
                        alan.removeAttribute('required');
                        alan.setCustomValidity(''); // Özel hata mesajlarını temizle
                    }
                });

                if (!this.checkValidity()) {
                    this.classList.add('was-validated');
                    const ilkHataliAlan = this.querySelector(':invalid');
                    if (ilkHataliAlan) {
                        ilkHataliAlan.focus();
                        window.bildirimGoster('Uyarı', 'Lütfen tüm zorunlu alanları doldurun.', 'warning');
                    }
                    return;
                }

                // Yeni sözleşme oluşturma işlemi - formdan verileri al
                const formVerileri = {
                    isSahibiAdi: document.getElementById('yeniIsSahibiAdi').value,
                    isSahibiTc: document.getElementById('yeniIsSahibiTc').value,
                    isSahibiAdresi: document.getElementById('yeniIsSahibiAdresi').value,
                    alinanIs: document.getElementById('yeniAlinanIs').value,
                    avukatlikUcreti: document.getElementById('yeniAvukatlikUcreti').value,
                    giderAvansi: document.getElementById('yeniGiderAvansi').value || '',
                    gunlukUcret: document.getElementById('yeniGunlukUcret').value || '',
                    durusmaUcreti: document.getElementById('yeniDurusmaUcreti').value || '',
                    sozlesmeTarihi: document.getElementById('yeniSozlesmeTarihi').value
                };

                console.log("Yeni sözleşme form verileri:", formVerileri);

                // Mevcut sözleşme oluşturma fonksiyonunu çağır
                if (typeof window.yeniSozlesmeOlustur === 'function') {
                    await window.yeniSozlesmeOlustur(formVerileri);
                } else {
                    console.error("yeniSozlesmeOlustur fonksiyonu bulunamadı!");
                    window.bildirimGoster('Hata', 'Sözleşme oluşturma fonksiyonu bulunamadı.', 'error');
                }
            });
        }

        // Taslak düzenleme butonu
        const taslakDuzenleBtn = document.getElementById('taslakDuzenleBtn');
        if (taslakDuzenleBtn) {
            taslakDuzenleBtn.addEventListener('click', function() {
                window.taslakDuzenleModalAc();
            });
        }

        // Taslak kaydet butonu
        const taslakKaydetBtn = document.getElementById('taslakKaydetBtn');
        if (taslakKaydetBtn) {
            taslakKaydetBtn.addEventListener('click', function() {
                window.taslakKaydet();
            });
        }

        // Taslak varsayılana dön butonu
        const taslakVarsayilanBtn = document.getElementById('taslakVarsayilanBtn');
        if (taslakVarsayilanBtn) {
            taslakVarsayilanBtn.addEventListener('click', function() {
                window.taslakVarsayilanaGetir();
            });
        }

        // Sözleşme güncelleme butonu
        const sozlesmeGuncelleBtn = document.getElementById('sozlesmeGuncelleBtn');
        if (sozlesmeGuncelleBtn) {
            sozlesmeGuncelleBtn.addEventListener('click', async function() {
                // Özel validasyon - opsiyonel ücret alanlarını temizle ve validasyondan çıkar
                const ucretAlanlari = ['giderAvansi', 'gunlukUcret', 'durusmaUcreti'];
                ucretAlanlari.forEach(alanId => {
                    const alan = document.getElementById(alanId);
                    if (alan) {
                        // "-" karakterini ve boş değerleri temizle
                        if (alan.value.trim() === '-' || alan.value.trim() === '') {
                            alan.value = '0'; // Sayı alanları için "0" değeri ver
                        }
                        // Bu alanları validasyondan çıkar
                        alan.removeAttribute('required');
                        alan.setCustomValidity(''); // Özel hata mesajlarını temizle
                    }
                });

                if (!sozlesmeForm.checkValidity()) {
                    sozlesmeForm.classList.add('was-validated');
                    const ilkHataliAlan = sozlesmeForm.querySelector(':invalid');
                    if (ilkHataliAlan) {
                        ilkHataliAlan.focus();
                        window.bildirimGoster('Uyarı', 'Lütfen tüm zorunlu alanları doldurun.', 'warning');
                    }
                    return;
                }

                const butonOrijinal = this.innerHTML;
                this.disabled = true;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Güncelleniyor...';

                // Formdaki verileri toplayıp PDF oluştur ve kaydet
                const formVerileri = {
                    isSahibiAdi: document.getElementById('isSahibiAdi').value,
                    isSahibiTc: document.getElementById('isSahibiTc').value,
                    isSahibiAdresi: document.getElementById('isSahibiAdresi').value,
                    alinanIs: document.getElementById('alinanIs').value,
                    avukatlikUcreti: document.getElementById('avukatlikUcreti').value,
                    giderAvansi: document.getElementById('giderAvansi').value || '',
                    gunlukUcret: document.getElementById('gunlukUcret').value || '',
                    durusmaUcreti: document.getElementById('durusmaUcreti').value || '',
                    sozlesmeTarihi: document.getElementById('sozlesmeTarihi').value
                };

                const tarihParcalari = formVerileri.sozlesmeTarihi.split('-');
                const formatliTarih = `${tarihParcalari[2]}.${tarihParcalari[1]}.${tarihParcalari[0]}`;
                
                // PDF içeriğini oluştur
                // sozlesmePdfIcerigiOlustur fonksiyonunu kontrol et
                if (typeof window.sozlesmePdfIcerigiOlustur !== 'function') {
                    throw new Error('sozlesmePdfIcerigiOlustur fonksiyonu tanımlı değil');
                }
                
                const pdfBelgesi = window.sozlesmePdfIcerigiOlustur(formVerileri, formatliTarih);

                const guncellenecekVeri = {
                    muvekkil_adi: formVerileri.isSahibiAdi,
                    sozlesme_tarihi_str: formVerileri.sozlesmeTarihi,
                    icerik_json: pdfBelgesi
                };

                try {
                    const response = await fetch(`/api/ornek_sozlesmeler/guncelle/${aktifSozlesmeId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': CSRF_TOKEN
                        },
                        body: JSON.stringify(guncellenecekVeri)
                    });

                    const sonuc = await response.json();
                    if (sonuc.success) {
                        window.bildirimGoster('Başarılı', 'Sözleşme başarıyla güncellendi.', 'success');
                        sozlesmeFormModal.hide();
                        kayitliSozlesmeleriTabloyaListele();
                    } else {
                        window.bildirimGoster('Hata', sonuc.message || 'Sözleşme güncellenirken bir hata oluştu.', 'error');
                    }
                } catch (error) {
                    console.error('Sözleşme güncelleme hatası:', error);
                    window.bildirimGoster('Hata', 'Sözleşme güncellenirken bir ağ hatası oluştu.', 'error');
                } finally {
                    this.innerHTML = butonOrijinal;
                    this.disabled = false;
                }
            });
        }

        // Tablo sıralama işlemleri
        const headers = document.querySelectorAll('#kayitliSozlesmelerTablosu thead th[data-sort-key]');
        headers.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.dataset.sortKey;
                sortTableByColumn(sortKey);
            });
        });

        // Form submit event listener
        sozlesmeForm.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        // Özel validasyon - opsiyonel ücret alanlarını temizle ve validasyondan çıkar
        const ucretAlanlari = ['giderAvansi', 'gunlukUcret', 'durusmaUcreti'];
        ucretAlanlari.forEach(alanId => {
            const alan = document.getElementById(alanId);
            if (alan) {
                // "-" karakterini ve boş değerleri temizle
                if (alan.value.trim() === '-' || alan.value.trim() === '') {
                    alan.value = '0'; // Sayı alanları için "0" değeri ver
                }
                // Bu alanları validasyondan çıkar
                alan.removeAttribute('required');
                alan.setCustomValidity(''); // Özel hata mesajlarını temizle
            }
        });
        
        if (!sozlesmeForm.checkValidity()) {
            event.stopPropagation();
            sozlesmeForm.classList.add('was-validated');
            const ilkHataliAlan = sozlesmeForm.querySelector(':invalid');
            if (ilkHataliAlan) {
                ilkHataliAlan.focus();
                                        window.bildirimGoster('Uyarı', 'Lütfen tüm zorunlu alanları doldurun.', 'warning');
            }
            return;
        }

        const formVerileri = {
            isSahibiAdi: document.getElementById('isSahibiAdi').value,
            isSahibiAdresi: document.getElementById('isSahibiAdresi').value,
            alinanIs: document.getElementById('alinanIs').value,
            avukatlikUcreti: document.getElementById('avukatlikUcreti').value,
            giderAvansi: window.ucretAlaniniTemizle(document.getElementById('giderAvansi').value),
            gunlukUcret: window.ucretAlaniniTemizle(document.getElementById('gunlukUcret').value),
            durusmaUcreti: window.ucretAlaniniTemizle(document.getElementById('durusmaUcreti').value),
            sozlesmeTarihi: document.getElementById('sozlesmeTarihi').value
        };

        pdfGoruntuleyici.innerHTML = '<div class="loading-spinner-container h-100"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">PDF oluşturuluyor...</p></div>';
        // Form modalını kapat ve PDF modalını göster
        if (window.sozlesmeFormModal) {
            window.sozlesmeFormModal.hide();
        }
        
        // Güvenli modal açma - Form submit olayında
        console.log("Form submit: Modal açılıyor...");
        if (typeof window.openFullscreenPdfModal === 'function') {
            console.log("Form submit: openFullscreenPdfModal fonksiyonu mevcut");
            window.openFullscreenPdfModal();
        } else {
            console.error("Form submit: openFullscreenPdfModal fonksiyonu bulunamadı! Fallback kullanılıyor...");
            // Fallback modal açma
            const pdfModalElement = document.getElementById('pdfOnizlemeModal');
            if (pdfModalElement) {
                pdfModalElement.style.display = 'block';
                pdfModalElement.style.opacity = '1';
                document.body.style.overflow = 'hidden';
                console.log("Form submit: Modal fallback ile açıldı");
            } else {
                console.error("Form submit: PDF modal elementi de bulunamadı!");
            }
        }
        
        const tarihParcalari = formVerileri.sozlesmeTarihi.split('-');
        const formatliTarih = `${tarihParcalari[2]}.${tarihParcalari[1]}.${tarihParcalari[0]}`;
        
        try {
            console.log("PDF oluşturma başlatılıyor...");
            console.log("Form verileri:", formVerileri);
            
            // sozlesmePdfIcerigiOlustur fonksiyonunu kontrol et
            if (typeof window.sozlesmePdfIcerigiOlustur !== 'function') {
                throw new Error('sozlesmePdfIcerigiOlustur fonksiyonu tanımlı değil');
            }
            
            olusturulanPdfBelgesi = window.sozlesmePdfIcerigiOlustur(formVerileri, formatliTarih);
            console.log("PDF içeriği oluşturuldu:", olusturulanPdfBelgesi ? "Başarılı" : "Hata");
            
            if (!olusturulanPdfBelgesi) {
                throw new Error('PDF içeriği oluşturulamadı - sozlesmePdfIcerigiOlustur null döndürdü');
            }
            
            setTimeout(() => {
                try {
                    console.log("pdfMake kontrolü yapılıyor...");
                    if (typeof pdfMake === 'undefined') {
                        throw new Error('pdfMake kütüphanesi yüklenmemiş');
                    }
                    
                    console.log("PDF oluşturuluyor...");
                    const pdfDoc = pdfMake.createPdf(olusturulanPdfBelgesi);
                    
                    console.log("PDF dataUrl alınıyor...");
                    
                    // PDF dataUrl alma fonksiyonu - sadece callback (eski pdfMake versiyonları için)
                    function getPdfDataUrl(pdfDoc) {
                        return new Promise((resolve, reject) => {
                            try {
                                console.log("getDataUrl callback yöntemi kullanılıyor");
                                pdfDoc.getDataUrl(function(dataUrl) {
                                    console.log("Callback çalıştı, dataUrl:", dataUrl ? "Alındı (" + dataUrl.length + " karakter)" : "Boş");
                                    if (dataUrl && typeof dataUrl === 'string') {
                                        resolve(dataUrl);
                                    } else {
                                        reject(new Error('Callback geçersiz dataUrl döndürdü: ' + typeof dataUrl));
                                    }
                                });
                            } catch (callbackError) {
                                console.error('getDataUrl callback hatası:', callbackError);
                                reject(callbackError);
                            }
                        });
                    }
                    
                    getPdfDataUrl(pdfDoc).then(function(dataUrl) {
                        console.log("PDF dataUrl başarıyla alındı, uzunluk:", dataUrl ? dataUrl.length : 'null');
                        console.log("PDF dataUrl prefix:", dataUrl ? dataUrl.substring(0, 50) : 'null');
                        
                        if (!dataUrl || typeof dataUrl !== 'string') {
                            throw new Error('Geçersiz PDF dataUrl: ' + typeof dataUrl);
                        }
                        
                        if (!dataUrl.startsWith('data:application/pdf')) {
                            console.warn("PDF dataUrl beklenmeyen format:", dataUrl.substring(0, 100));
                            // Yine de iframe'e yükle, belki çalışır
                        }
                        
                        const iframe = document.createElement('iframe');
                        iframe.src = dataUrl;
                        // Tam ekran iframe stilleri
                        iframe.style.width = '100%';
                        iframe.style.height = '100%';
                        iframe.style.border = 'none';
                        iframe.style.margin = '0';
                        iframe.style.padding = '0';
                        iframe.style.display = 'block';
                        iframe.title = 'PDF Önizleme';
                        
                        if (pdfGoruntuleyici) {
                            pdfGoruntuleyici.innerHTML = '';
                            pdfGoruntuleyici.appendChild(iframe);
                            console.log("PDF iframe'e başarıyla yerleştirildi");
                        }
                        
                        // PDF başarıyla oluştu - OTOMATİK KAYDETME BAŞLAT
                        console.log("PDF oluşturuldu, otomatik kaydetme başlatılıyor...");
                        otomatikSozlesmeKaydet(formVerileri);
                    }).catch(function(pdfError) { 
                        console.error('PDF dataUrl alma hatası:', pdfError); 
                        pdfGoruntuleyici.innerHTML = `
                            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                                <i class="material-icons" style="font-size: 48px;">error</i>
                                <h4 class="mt-3">PDF Önizleme Hatası</h4>
                                <p>PDF oluşturulurken bir hata oluştu: ${pdfError.message}</p>
                                <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                            </div>
                        `;
                    });
                } catch (pdfError) { 
                    console.error('PDF oluşturma genel hatası:', pdfError); 
                    pdfGoruntuleyici.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                            <i class="material-icons" style="font-size: 48px;">error</i>
                            <h4 class="mt-3">PDF Oluşturma Hatası</h4>
                            <p>PDF hazırlanırken bir hata oluştu: ${pdfError.message}</p>
                            <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                        </div>
                    `;
                }
            }, 500);
        } catch (error) { 
            console.error('PDF verilerini hazırlama hatası:', error); 
            pdfGoruntuleyici.innerHTML = `
                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                    <i class="material-icons" style="font-size: 48px;">error</i>
                    <h4 class="mt-3">PDF Hazırlama Hatası</h4>
                    <p>PDF verileri hazırlanırken bir hata oluştu: ${error.message}</p>
                    <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                </div>
            `;
        }
        });

        // Eski PDF İndir ve Sisteme Kaydet butonları kaldırıldı - Otomatik kaydetme kullanılıyor

        // Modal kapatma düğmelerine event listener ekle
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', window.closeFullscreenPdfModal);
        }
        
        const modalBackBtn = document.getElementById('modalBackBtn');
        if (modalBackBtn) {
            modalBackBtn.addEventListener('click', function() {
                window.closeFullscreenPdfModal();
                // Modal kapatıldığında form modalını da sıfırla
                if (typeof window.sozlesmeFormunuSifirla === 'function') {
                    window.sozlesmeFormunuSifirla();
                }
            });
        }

        // PDF Modal stilleri inline style olarak zaten tanımlandı

    }); // DOMContentLoaded sonunu kapat
    
    // OTOMATİK KAYDETME FONKSİYONU - PDF oluştuktan sonra çağrılır
    async function otomatikSozlesmeKaydet(formVerileri) {
        console.log("=== OTOMATİK KAYDETME BAŞLADI ===");
        
        if (!olusturulanPdfBelgesi) {
            console.error("Kaydedilecek PDF belgesi bulunamadı!");
            window.bildirimGoster('Hata', 'Kaydedilecek PDF belgesi bulunamadı.', 'error');
            return;
        }
        
        try {
            console.log("Otomatik kaydetme başlatılıyor...");
            
            // API isteği hazırla
            const apiMethod = sozlesmeIdInput.value ? 'PUT' : 'POST';
            const apiUrl = sozlesmeIdInput.value ? 
                `/api/ornek_sozlesmeler/kayitli/${sozlesmeIdInput.value}` : 
                '/api/ornek_sozlesmeler/kaydet';
            
            console.log("API URL:", apiUrl);
            console.log("Method:", apiMethod);
            
            const kayitVerisi = {
                muvekkil_adi: formVerileri.isSahibiAdi,
                sozlesme_tarihi_str: formVerileri.sozlesmeTarihi,
                icerik_json: olusturulanPdfBelgesi
            };
            
            console.log("Kayıt verisi:", {
                muvekkil_adi: kayitVerisi.muvekkil_adi,
                sozlesme_tarihi_str: kayitVerisi.sozlesme_tarihi_str,
                icerik_json_size: kayitVerisi.icerik_json ? "Var" : "Yok"
            });
            
            const response = await fetch(apiUrl, {
                method: apiMethod,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(kayitVerisi)
            });
            
            console.log("API response status:", response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("API error response:", errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const sonuc = await response.json();
            console.log("API response sonuc:", sonuc);
            
            if (sonuc.success) {
                console.log("Sözleşme başarıyla kaydedildi!");
                window.bildirimGoster('Başarılı', 'Sözleşme sisteme başarıyla kaydedildi ve önizleniyor.', 'success');
                
                // Liste yenile (background'ta)
                setTimeout(() => {
                    if (typeof window.kayitliSozlesmeleriTabloyaListele === 'function') {
                        window.kayitliSozlesmeleriTabloyaListele();
                        console.log("Sözleşme listesi yenilendi");
                    }
                }, 1000);
                
                // Form sıfırla (aktif modal kapatılmaz, sadece form)
                if (typeof window.sozlesmeFormunuSifirla === 'function') {
                    window.sozlesmeFormunuSifirla();
                }
                
                console.log("=== OTOMATİK KAYDETME BAŞARILI ===");
                
            } else {
                throw new Error(sonuc.message || 'Bilinmeyen hata');
            }
            
        } catch (error) {
            console.error('Otomatik kaydetme hatası:', error);
            window.bildirimGoster('Hata', `Sözleşme kaydedilirken hata oluştu: ${error.message}`, 'error');
            console.log("=== OTOMATİK KAYDETME HATALI ===");
        }
    }
    
    // Global fonksiyon - Sözleşme kayıt işlemi (Manuel - şimdilik kullanılmıyor)
    window.sozlesmeKaydet = async function() {
        const formVerileri = {
            isSahibiAdi: document.getElementById('isSahibiAdi').value,
            isSahibiAdresi: document.getElementById('isSahibiAdresi').value,
            alinanIs: document.getElementById('alinanIs').value,
            avukatlikUcreti: document.getElementById('avukatlikUcreti').value,
            giderAvansi: window.ucretAlaniniTemizle(document.getElementById('giderAvansi').value),
            gunlukUcret: window.ucretAlaniniTemizle(document.getElementById('gunlukUcret').value),
            durusmaUcreti: window.ucretAlaniniTemizle(document.getElementById('durusmaUcreti').value),
            sozlesmeTarihi: document.getElementById('sozlesmeTarihi').value
        };
        
        if (!olusturulanPdfBelgesi) {
            window.bildirimGoster('Hata', 'Kaydedilecek PDF belgesi bulunamadı.', 'error');
            return;
        }
        
        try {
            // Sunucuya gönderilecek verileri hazırla
            const apiMethod = sozlesmeIdInput.value ? 'PUT' : 'POST';
            const apiUrl = `/api/ornek_sozlesmeler${sozlesmeIdInput.value ? '/guncelle/' + sozlesmeIdInput.value : '/kaydet'}`;
            
            console.log("API çağrısı yapılıyor:", apiMethod, apiUrl);
            console.log("Form verileri:", formVerileri);
            
            // PDF verilerini aktarmak için kullanılacak veriler
            const kayitVerisi = {
                muvekkil_adi: formVerileri.isSahibiAdi,
                sozlesme_tarihi_str: formVerileri.sozlesmeTarihi,
                icerik_json: olusturulanPdfBelgesi
            };
            
            console.log("Kayıt verisi hazırlandı:", Object.keys(kayitVerisi));
            
            const response = await fetch(apiUrl, {
                method: apiMethod,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(kayitVerisi)
            });
            
            console.log("API response status:", response.status);
            console.log("API response OK:", response.ok);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("API error response:", errorText);
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const sonuc = await response.json();
            console.log("API response:", sonuc);
            
            if (sonuc.success) {
                window.bildirimGoster('Başarılı', sonuc.message || 'Sözleşme başarıyla kaydedildi.', 'success');
                
                // Modal kapat
                if (window.closeFullscreenPdfModal) {
                    window.closeFullscreenPdfModal();
                }
                if (window.sozlesmeFormModal) {
                    window.sozlesmeFormModal.hide();
                }
                
                // Tabloyu güncelle ve formu sıfırla
                window.kayitliSozlesmeleriTabloyaListele();
                if (apiMethod === 'POST' || (aktifSozlesmeId && parseInt(sozlesmeIdInput.value) !== aktifSozlesmeId)) { 
                    window.sozlesmeFormunuSifirla();
                }
            } else {
                console.error("API başarısız:", sonuc);
                window.bildirimGoster('Hata', sonuc.message || 'Sözleşme kaydedilirken bir hata oluştu.', 'error');
            }
        } catch (error) {
            console.error('Sözleşme kaydetme hatası:', error);
            window.bildirimGoster('Hata', 'Sözleşme kaydedilirken bir hata oluştu: ' + error.message, 'error');
        }
    }

    // Global fonksiyon - Kayıtlı sözleşmeleri tabloya listele
    window.kayitliSozlesmeleriTabloyaListele = async function() {
        const tableBody = document.getElementById('sozlesmeTableBody');
        const yukleniyorDiv = document.getElementById('tabloYukleniyor');
        const tabloBosDiv = document.getElementById('tabloBos');

        tableBody.innerHTML = ''; 
        yukleniyorDiv.style.display = 'flex';
        tabloBosDiv.style.display = 'none';

        try {
            const response = await fetch('/api/ornek_sozlesmeler/kayitli');
            if (!response.ok) throw new Error(`HTTP hata kodu: ${response.status}`);
            const sonuc = await response.json();
            yukleniyorDiv.style.display = 'none';

            if (sonuc.success && Array.isArray(sonuc.sozlesmeler)) {
                allContractsData = sonuc.sozlesmeler;
                filteredContractsData = [...allContractsData]; // Başlangıçta tüm veriler görünür
                console.log("Kayıtlı Sözleşmeler Listelendi:", JSON.stringify(allContractsData, null, 2)); // LOG 3
                if (allContractsData.length === 0) {
                    tabloBosDiv.style.display = 'block';
                } else {
                    // Başlangıçta sıralama olmadan render et
                    renderTableRows(filteredContractsData); 
                }
            } else {
                throw new Error('API yanıtı geçersiz format içeriyor.');
            }
        } catch (error) {
            console.error('Sözleşme tablosu yükleme hatası:', error);
            yukleniyorDiv.style.display = 'none';
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Sözleşmeler yüklenirken bir hata oluştu: ${error.message}</td></tr>`;
        }
    }

    // Global fonksiyon - Tablo satırlarını render et
    window.renderTableRows = function(contracts) {
        const tableBody = document.getElementById('sozlesmeTableBody');
        tableBody.innerHTML = '';

        contracts.forEach(sozlesme => {
            const row = tableBody.insertRow();
            const isSahibiAdi = sozlesme.muvekkil_adi || 'N/A';
            let avukatlikUcretiText = 'N/A';
            let avukatlikUcretiValue = 0;

            const currentIcerikJson = getParsedIcerikJson(sozlesme.icerik_json, sozlesme.id);

            try {
                // 1. Öncelikli olarak avukatlikUcretiRaw alanını kontrol et
                if (currentIcerikJson && typeof currentIcerikJson.avukatlikUcretiRaw !== 'undefined' && currentIcerikJson.avukatlikUcretiRaw !== null && currentIcerikJson.avukatlikUcretiRaw.toString().trim() !== '') {
                    avukatlikUcretiText = currentIcerikJson.avukatlikUcretiRaw.toString().trim();
                }
                // 2. Eğer avukatlikUcretiRaw yoksa veya boşsa, eski avukatlikUcreti alanını kontrol et
                else if (currentIcerikJson && typeof currentIcerikJson.avukatlikUcreti !== 'undefined' && currentIcerikJson.avukatlikUcreti !== null && currentIcerikJson.avukatlikUcreti.toString().trim() !== '') {
                    avukatlikUcretiText = currentIcerikJson.avukatlikUcreti.toString().trim();
                }
                // 3. Eğer hala N/A ise ve content varsa, content içinden çıkarmaya çalış
                else if (currentIcerikJson && currentIcerikJson.content) {
                    // MADDE 2 içinde avukatlık ücreti bilgisini ara
                    const ucretMadde = currentIcerikJson.content.find(c =>
                        c.text && typeof c.text === 'string' &&
                        (c.text.includes("MADDE 2)") || c.text.includes("Avukat'a")) &&
                        c.text.includes("avukatlık ücreti"));

                    if (ucretMadde && ucretMadde.text) {
                        const match = ucretMadde.text.match(/Avukat'a\\s*([^a-zA-Z]+?)\\s*avukatlık ücreti/i);
                        if (match && match[1]) {
                            avukatlikUcretiText = match[1].trim();
                        } else {
                            const altMatch = ucretMadde.text.match(/([0-9.,]+\\s*(?:TL|USD|EUR)?)\\s*avukatlık ücreti/i);
                            if (altMatch && altMatch[1]) {
                                avukatlikUcretiText = altMatch[1].trim();
                            }
                        }
                    }
                }

                // Sayısal değer için parse işlemi
                if (avukatlikUcretiText !== 'N/A') {
                    const numericMatch = avukatlikUcretiText.match(/([0-9.,]+)/);
                    if (numericMatch && numericMatch[1]) {
                        avukatlikUcretiValue = parseFloat(numericMatch[1].replace(/\./g, '').replace(',', '.')) || 0;
                    }
                }
            } catch (e) { 
                console.error("RenderTableRows - Ücret parse/işleme hatası id " + sozlesme.id + ":", e); 
                avukatlikUcretiText = 'Hata'; // Hata durumunda bunu göster
            }

            const tarih = sozlesme.sozlesme_tarihi || 'N/A'; 

            row.insertCell().textContent = isSahibiAdi;
            const ucretCell = row.insertCell();
            ucretCell.textContent = avukatlikUcretiText; 
            ucretCell.dataset.sortValue = avukatlikUcretiValue; 

            const tarihCell = row.insertCell();
            tarihCell.textContent = tarih; // "DD.MM.YYYY"
            // Sıralama için YYYY-MM-DD formatında sakla
            const tarihParts = tarih.split('.');
            if (tarihParts.length === 3) {
                tarihCell.dataset.sortValue = `${tarihParts[2]}-${tarihParts[1]}-${tarihParts[0]}`;
            } else {
                tarihCell.dataset.sortValue = tarih; // Hatalı formatta ise olduğu gibi bırak
            }

            const actionsCell = row.insertCell();
            actionsCell.className = 'text-center';
            actionsCell.innerHTML = `
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-sm btn-outline-dark preview-btn" data-sozlesme-id="${sozlesme.id}" title="Önizle"><i class="material-icons">visibility</i></button>
                    <button type="button" class="btn btn-sm btn-outline-dark edit-btn" data-sozlesme-id="${sozlesme.id}" title="Düzenle"><i class="material-icons">edit</i></button>
                    <button type="button" class="btn btn-sm btn-outline-dark delete-btn" data-sozlesme-id="${sozlesme.id}" data-sozlesme-name="${isSahibiAdi.replace(/'/g, "\\'")}" title="Sil"><i class="material-icons">delete</i></button>
                </div>
            `;
        });
    }

    // Global fonksiyon - Tabloyu sırala
    window.sortTableByColumn = function(sortKey) {
        const currentOrder = (sortState.key === sortKey && sortState.order === 'asc') ? 'desc' : 'asc';
        sortState = { key: sortKey, order: currentOrder };

        filteredContractsData.sort((a, b) => {
            let valA, valB;

            if (sortKey === 'muvekkil_adi') {
                valA = a.muvekkil_adi?.toLowerCase() || '';
                valB = b.muvekkil_adi?.toLowerCase() || '';
            } else if (sortKey === 'sozlesme_tarihi') {
                const dateA = (a.sozlesme_tarihi?.split('.').reverse().join('') || '').replace(/-/g, '');
                const dateB = (b.sozlesme_tarihi?.split('.').reverse().join('') || '').replace(/-/g, '');
                valA = dateA;
                valB = dateB;
            } else if (sortKey === 'avukatlik_ucreti') {
                let feeA = 0;
                let feeB = 0;
                const icerikJsonA = getParsedIcerikJson(a.icerik_json, a.id);
                const icerikJsonB = getParsedIcerikJson(b.icerik_json, b.id);

                try {
                    // A için ücret belirleme
                    if (icerikJsonA && typeof icerikJsonA.avukatlikUcretiRaw !== 'undefined' && icerikJsonA.avukatlikUcretiRaw !== null && icerikJsonA.avukatlikUcretiRaw.toString().trim() !== '') {
                        const textA = icerikJsonA.avukatlikUcretiRaw.toString().trim();
                        const numericMatchA = textA.match(/([0-9.,]+)/);
                        if (numericMatchA && numericMatchA[1]) {
                            feeA = parseFloat(numericMatchA[1].replace(/\./g, '').replace(',', '.')) || 0;
                        }
                    } else if (icerikJsonA && typeof icerikJsonA.avukatlikUcreti !== 'undefined' && icerikJsonA.avukatlikUcreti !== null && icerikJsonA.avukatlikUcreti.toString().trim() !== '') {
                        const textA = icerikJsonA.avukatlikUcreti.toString().trim();
                        const numericMatchA = textA.match(/([0-9.,]+)/);
                        if (numericMatchA && numericMatchA[1]) {
                            feeA = parseFloat(numericMatchA[1].replace(/\./g, '').replace(',', '.')) || 0;
                        }
                    } else if (icerikJsonA && icerikJsonA.content) {
                        const ucretMaddeA = icerikJsonA.content.find(c =>
                            c.text && typeof c.text === 'string' &&
                            (c.text.includes("MADDE 2)") || c.text.includes("Avukat'a")) &&
                            c.text.includes("avukatlık ücreti"));
                        if (ucretMaddeA && ucretMaddeA.text) {
                            const matchA = ucretMaddeA.text.match(/([0-9.,]+)/);
                            if (matchA && matchA[1]) {
                                feeA = parseFloat(matchA[1].replace(/\./g, '').replace(',', '.')) || 0;
                            }
                        }
                    }
                } catch (e) { console.error('SortTable - Ücret A parse hatası', e); }
                
                try {
                    // B için ücret belirleme
                    if (icerikJsonB && typeof icerikJsonB.avukatlikUcretiRaw !== 'undefined' && icerikJsonB.avukatlikUcretiRaw !== null && icerikJsonB.avukatlikUcretiRaw.toString().trim() !== '') {
                        const textB = icerikJsonB.avukatlikUcretiRaw.toString().trim();
                        const numericMatchB = textB.match(/([0-9.,]+)/);
                        if (numericMatchB && numericMatchB[1]) {
                            feeB = parseFloat(numericMatchB[1].replace(/\./g, '').replace(',', '.')) || 0;
                        }
                    } else if (icerikJsonB && typeof icerikJsonB.avukatlikUcreti !== 'undefined' && icerikJsonB.avukatlikUcreti !== null && icerikJsonB.avukatlikUcreti.toString().trim() !== '') {
                        const textB = icerikJsonB.avukatlikUcreti.toString().trim();
                        const numericMatchB = textB.match(/([0-9.,]+)/);
                        if (numericMatchB && numericMatchB[1]) {
                            feeB = parseFloat(numericMatchB[1].replace(/\./g, '').replace(',', '.')) || 0;
                        }
                    } else if (icerikJsonB && icerikJsonB.content) {
                        const ucretMaddeB = icerikJsonB.content.find(c =>
                            c.text && typeof c.text === 'string' &&
                            (c.text.includes("MADDE 2)") || c.text.includes("Avukat'a")) &&
                            c.text.includes("avukatlık ücreti"));
                        if (ucretMaddeB && ucretMaddeB.text) {
                            const matchB = ucretMaddeB.text.match(/([0-9.,]+)/);
                            if (matchB && matchB[1]) {
                                feeB = parseFloat(matchB[1].replace(/\./g, '').replace(',', '.')) || 0;
                            }
                        }
                    }
                } catch (e) { console.error('SortTable - Ücret B parse hatası', e); }
                
                valA = feeA;
                valB = feeB;
            }

            if (valA < valB) return currentOrder === 'asc' ? -1 : 1;
            if (valA > valB) return currentOrder === 'asc' ? 1 : -1;
            return 0;
        });
        renderTableRows(filteredContractsData);
        updateSortIcons(sortKey, currentOrder);
    }

    // Global fonksiyon - Sözleşmeleri filtrele
    window.filterContracts = function(searchTerm) {
        if (!searchTerm || searchTerm.trim() === '') {
            filteredContractsData = [...allContractsData];
        } else {
            const term = searchTerm.toLowerCase().trim();
            filteredContractsData = allContractsData.filter(sozlesme => {
                const isSahibiAdi = (sozlesme.muvekkil_adi || '').toLowerCase();
                return isSahibiAdi.includes(term);
            });
        }
        
        // Filtrelenmiş veriyi render et
        const tabloBosDiv = document.getElementById('tabloBos');
        if (filteredContractsData.length === 0) {
            if (searchTerm && searchTerm.trim() !== '') {
                // Arama sonucu boş
                document.getElementById('sozlesmeTableBody').innerHTML = 
                    `<tr><td colspan="4" class="text-center text-muted">
                        <i class="material-icons" style="font-size: 48px; opacity: 0.5;">search_off</i>
                        <p class="mt-2">Arama kriterlerinize uygun sözleşme bulunamadı.</p>
                        <small>Farklı bir arama terimi deneyin.</small>
                    </td></tr>`;
                tabloBosDiv.style.display = 'none';
            } else {
                // Hiç sözleşme yok
                tabloBosDiv.style.display = 'block';
                document.getElementById('sozlesmeTableBody').innerHTML = '';
            }
        } else {
            tabloBosDiv.style.display = 'none';
            renderTableRows(filteredContractsData);
        }
    }

    // Global fonksiyon - Sıralama ikonlarını güncelle
    window.updateSortIcons = function(activeSortKey, order) {
        document.querySelectorAll('#kayitliSozlesmelerTablosu thead th i').forEach(icon => {
            icon.textContent = 'unfold_more';
        });
        const activeIcon = document.querySelector(`#kayitliSozlesmelerTablosu thead th[data-sort-key="${activeSortKey}"] i`);
        if (activeIcon) {
            activeIcon.textContent = order === 'asc' ? 'arrow_upward' : 'arrow_downward';
        }
    }
    
    // Global fonksiyon - HTML onclick'lerden çağrılacak
    window.sozlesmeDetayiYukle = async function(sozlesmeId, onizle = false) {
        console.log("sozlesmeDetayiYukle çağrıldı - ID:", sozlesmeId, "Önizle:", onizle);
        
        document.querySelectorAll('#sozlesmeTableBody tr').forEach(row => row.classList.remove('table-active'));
        const secilenSatir = document.querySelector(`#sozlesmeTableBody tr td button[data-sozlesme-id="${sozlesmeId}"]`)?.closest('tr');
        if (secilenSatir) secilenSatir.classList.add('table-active');

        try {
            console.log("API'ye istek gönderiliyor...");
            const response = await fetch(`/api/ornek_sozlesmeler/kayitli/${sozlesmeId}`);
            if (!response.ok) throw new Error(`HTTP hata kodu: ${response.status}`);
            const sonuc = await response.json();
            console.log("API yanıtı alındı:", sonuc);
            
            if (sonuc.success && sonuc.sozlesme) {
                const sozlesme = sonuc.sozlesme;
                console.log("Sözleşme Detayı Yüklendi - Alınan Veri:", JSON.stringify(sozlesme, null, 2)); // LOG 4
                sozlesmeIdInput.value = sozlesme.id;
                aktifSozlesmeId = sozlesme.id;
                
                document.getElementById('isSahibiAdi').value = sozlesme.muvekkil_adi || '';
                
                const icerikJson = getParsedIcerikJson(sozlesme.icerik_json, sozlesme.id);

                try {
                    if (icerikJson) { 
                        // Raw verilerden formu doldurmaya çalış (öncelikli)
                        if (icerikJson.rawFormData) {
                            // Raw form verilerinden doldur
                            document.getElementById('isSahibiTc').value = icerikJson.rawFormData.isSahibiTc || '';
                            document.getElementById('isSahibiAdresi').value = icerikJson.rawFormData.isSahibiAdresi || '';
                            document.getElementById('alinanIs').value = icerikJson.rawFormData.alinanIs || '';
                            document.getElementById('avukatlikUcreti').value = icerikJson.rawFormData.avukatlikUcreti || '';
                            document.getElementById('giderAvansi').value = icerikJson.rawFormData.giderAvansi || '';
                            document.getElementById('gunlukUcret').value = icerikJson.rawFormData.gunlukUcret || '';
                            document.getElementById('durusmaUcreti').value = icerikJson.rawFormData.durusmaUcreti || '';
                        } else {
                            // Fallback: PDF içeriğinden parse etmeye çalış
                            // Avukatlık ücreti için önce avukatlikUcretiRaw'ı kontrol et
                            let avUcretiForm = '';
                            if (icerikJson.avukatlikUcretiRaw) {
                                avUcretiForm = icerikJson.avukatlikUcretiRaw.toString().trim();
                            }
                            document.getElementById('avukatlikUcreti').value = avUcretiForm;

                            // Diğer alanları PDF'den parse etmeye çalış
                            if (icerikJson.content) {
                                // İş sahibi adresi
                                const adresColumn = icerikJson.content.find(c =>
                                    c.columns && c.columns[0] && c.columns[0].text && c.columns[0].text.includes('ADRESİ:'));
                                if (adresColumn && adresColumn.columns[0].text) {
                                    const adresParts = adresColumn.columns[0].text.split('ADRESİ: ');
                                    if (adresParts.length > 1) {
                                        document.getElementById('isSahibiAdresi').value = adresParts[1];
                                    }
                                }

                                // Alınan iş
                                const isMadde = icerikJson.content.find(c =>
                                    c.text && c.text.includes('MADDE 1)'));
                                if (isMadde && isMadde.text) {
                                    const isParts = isMadde.text.split('İŞ: ');
                                    if (isParts.length > 1) {
                                        const isMetni = isParts[1].split('\\n\\n')[0];
                                        document.getElementById('alinanIs').value = isMetni.replace(/\\n/g, ' ').trim();
                                    }
                                }

                                // Gider avansı
                                const giderMadde = icerikJson.content.find(c =>
                                    c.text && c.text.includes('gider avansını'));
                                if (giderMadde && giderMadde.text) {
                                    const giderMatch = giderMadde.text.match(/Avukata\\s+([^-]+)-TL gider avansını/);
                                    if (giderMatch && giderMatch[1]) {
                                        document.getElementById('giderAvansi').value = giderMatch[1].trim();
                                    }
                                }

                                // Günlük ücret
                                const gunlukMadde = icerikJson.content.find(c =>
                                    c.text && c.text.includes('ödemeyi kabul etmiştir'));
                                if (gunlukMadde && gunlukMadde.text) {
                                    const gunlukMatch = gunlukMadde.text.match(/her gün için\\s+([^-]+)-TL ödemeyi/);
                                    if (gunlukMatch && gunlukMatch[1]) {
                                        document.getElementById('gunlukUcret').value = gunlukMatch[1].trim();
                                    }
                                }

                                // Duruşma ücreti
                                const durusmaMadde = icerikJson.content.find(c =>
                                    c.text && c.text.includes('başka Avukata '));
                                if (durusmaMadde && durusmaMadde.text) {
                                    const durusmaMatch = durusmaMadde.text.match(/başka Avukata\\s+([^-]+)-TL verilecektir/);
                                    if (durusmaMatch && durusmaMatch[1]) {
                                        document.getElementById('durusmaUcreti').value = durusmaMatch[1].trim();
                                    }
                                }
                            }
                        }
                    } else {
                        console.warn("icerikJson parse edilemediği için form alanları doldurulamadı, ID:", sozlesme.id);
                    }
                } catch (parseError) {
                    console.error('Sözleşme içeriği (form için) ayrıştırma hatası:', parseError);
                }
                
                document.getElementById('sozlesmeTarihi').value = sozlesme.sozlesme_tarihi_str || (sozlesme.sozlesme_tarihi ? sozlesme.sozlesme_tarihi.split('.').reverse().join('-') : '');

                document.getElementById('formBaslik').textContent = 'Sözleşme Düzenle';
                document.getElementById('formAltBaslik').textContent = `"${sozlesme.sozlesme_adi || sozlesme.muvekkil_adi}" (ID: ${sozlesme.id})`;
                
                // Düzenleme modunu ayarla
                if (!onizle) {
                    // Güncelleme butonu göster, oluşturma butonu gizle
                    document.getElementById('sozlesmeGuncelleBtn').style.display = 'inline-block';
                    document.getElementById('sozlesmeOlusturBtn').style.display = 'none';
                    
                    // Modal'ı güvenli şekilde aç
                    try {
                        if (window.sozlesmeFormModal) {
                            window.sozlesmeFormModal.show();
                        } else {
                            // Fallback: Modal elementi kontrol et ve yeni instance oluştur
                            const modalElement = document.getElementById('sozlesmeFormModal');
                            if (modalElement) {
                                const modal = new bootstrap.Modal(modalElement, {
                                    backdrop: false,
                                    keyboard: false
                                });
                                window.sozlesmeFormModal = modal;
                                modal.show();
                                console.log("Modal fallback ile oluşturuldu ve açıldı");
                            } else {
                                console.error("Modal elementi bulunamadı!");
                                window.bildirimGoster('Hata', 'Modal açılamadı.', 'error');
                                return;
                            }
                        }
                        setTimeout(() => document.getElementById('isSahibiAdi').focus(), 300);
                    } catch (modalError) {
                        console.error("Modal açma hatası:", modalError);
                        window.bildirimGoster('Hata', 'Modal açılırken hata oluştu: ' + modalError.message, 'error');
                    }
                }

                if (onizle) {
                    console.log("Önizleme modunda - PDF oluşturuluyor...");
                    
                    // pdfMake kütüphanesinin yüklenip yüklenmediğini kontrol et
                    if (typeof pdfMake === 'undefined') {
                        console.error("pdfMake kütüphanesi yüklenmemiş!");
                        window.bildirimGoster('Hata', 'PDF kütüphanesi yüklenmemiş. Sayfayı yenileyin.', 'error');
                        return;
                    }
                    
                    // PDF görüntüleyici elementi kontrol et
                    if (!pdfGoruntuleyici) {
                        pdfGoruntuleyici = document.getElementById('pdfGoruntuleyici');
                        if (!pdfGoruntuleyici) {
                            console.error("PDF görüntüleyici element bulunamadı!");
                            window.bildirimGoster('Hata', 'PDF görüntüleyici bulunamadı.', 'error');
                            return;
                        }
                    }
                    
                    // Loading göster
                    pdfGoruntuleyici.innerHTML = '<div class="loading-spinner-container h-100"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">PDF önizleme yükleniyor...</p></div>';
                    
                    // Modal'ı aç - Güvenli fonksiyon çağrısı
                    try {
                        console.log("openFullscreenPdfModal fonksiyonu kontrol ediliyor...");
                        if (typeof window.openFullscreenPdfModal === 'function') {
                            console.log("openFullscreenPdfModal fonksiyonu mevcut, çağrılıyor...");
                            window.openFullscreenPdfModal();
                        } else {
                            console.error("openFullscreenPdfModal fonksiyonu tanımlı değil! typeof:", typeof window.openFullscreenPdfModal);
                            // Fallback - doğrudan element manipülasyonu
                            const pdfModalElement = document.getElementById('pdfOnizlemeModal');
                            if (pdfModalElement) {
                                console.log("Fallback modal açma kullanılıyor...");
                                pdfModalElement.style.display = 'block';
                                pdfModalElement.style.opacity = '1';
                                document.body.style.overflow = 'hidden';
                                console.log("Modal fallback ile açıldı");
                            } else {
                                throw new Error("PDF modal element bulunamadı ve fonksiyon da yok!");
                            }
                        }
                    } catch (modalError) {
                        console.error('Modal açma hatası:', modalError);
                        if (typeof window.bildirimGoster === 'function') {
                            window.bildirimGoster('Hata', 'PDF modal açılamadı: ' + modalError.message, 'error');
                        }
                        return;
                    }
                    
                    // PDF oluştur ve göster
                    setTimeout(() => {
                        try {
                            console.log("Önizleme için PDF oluşturma başlatılıyor...");
                            const pdfBelgesi = getParsedIcerikJson(sozlesme.icerik_json, sozlesme.id);
                            console.log("PDF belgesi parse edildi:", pdfBelgesi ? "Başarılı" : "Hata");
                            
                            if (pdfBelgesi) {
                                console.log("pdfMake ile PDF oluşturuluyor...");
                                // PDF oluşturma fonksiyonunu güvenli şekilde çağır
                                const pdfDoc = pdfMake.createPdf(pdfBelgesi);
                                
                                console.log("PDF dataUrl alınıyor...");
                                
                                // PDF dataUrl alma fonksiyonu - sadece callback (önizleme)
                                function getPdfDataUrlPreview(pdfDoc) {
                                    return new Promise((resolve, reject) => {
                                        try {
                                            console.log("getDataUrl callback yöntemi kullanılıyor (önizleme)");
                                            pdfDoc.getDataUrl(function(dataUrl) {
                                                console.log("Callback çalıştı (önizleme), dataUrl:", dataUrl ? "Alındı (" + dataUrl.length + " karakter)" : "Boş");
                                                if (dataUrl && typeof dataUrl === 'string') {
                                                    resolve(dataUrl);
                                                } else {
                                                    reject(new Error('Callback geçersiz dataUrl döndürdü (önizleme): ' + typeof dataUrl));
                                                }
                                            });
                                        } catch (callbackError) {
                                            console.error('getDataUrl callback hatası (önizleme):', callbackError);
                                            reject(callbackError);
                                        }
                                    });
                                }
                                
                                getPdfDataUrlPreview(pdfDoc).then(function(dataUrl) {
                                    console.log("PDF dataUrl başarıyla alındı (önizleme), uzunluk:", dataUrl ? dataUrl.length : 'null');
                                    console.log("PDF dataUrl prefix (önizleme):", dataUrl ? dataUrl.substring(0, 50) : 'null');
                                    
                                    if (!dataUrl || typeof dataUrl !== 'string') {
                                        throw new Error('Geçersiz PDF dataUrl (önizleme): ' + typeof dataUrl);
                                    }
                                    
                                    if (!dataUrl.startsWith('data:application/pdf')) {
                                        console.warn("PDF dataUrl beklenmeyen format (önizleme):", dataUrl.substring(0, 100));
                                    }
                                    
                                    // PDF'i backend'e gönder ve kaydet
                                    console.log("PDF backend'e kaydediliyor...");
                                    pdfGoruntuleyici.innerHTML = '<div class="loading-spinner-container h-100"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">PDF kaydediliyor...</p></div>';
                                    
                                    fetch(`/save_ornek_sozlesme_pdf/${sozlesme.id}`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            pdf_data: dataUrl
                                        })
                                    })
                                    .then(response => response.json())
                                    .then(result => {
                                        if (result.success) {
                                            console.log('PDF başarıyla kaydedildi:', result.filename);
                                            
                                            // Kaydedilen PDF'i yeni sekmede aç
                                            const pdfUrl = result.file_url;
                                            const newWindow = window.open(pdfUrl, '_blank');
                                            if (!newWindow) {
                                                alert('Pop-up engelleyici açık olabilir. Lütfen bu site için pop-up\'lara izin verin.');
                                            }
                                            
                                            // Modal'ı kapat
                                            if (typeof window.closeFullscreenPdfModal === 'function') {
                                                window.closeFullscreenPdfModal();
                                            }
                                        } else {
                                            console.error('PDF kaydetme hatası:', result.error);
                                            if (pdfGoruntuleyici) {
                                                pdfGoruntuleyici.innerHTML = `
                                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                                                        <i class="material-icons" style="font-size: 48px;">error</i>
                                                        <h4 class="mt-3">PDF Kaydetme Hatası</h4>
                                                        <p>PDF kaydedilemedi: ${result.error}</p>
                                                        <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                                                    </div>
                                                `;
                                            }
                                        }
                                    })
                                    .catch(error => {
                                        console.error('PDF kaydetme hatası:', error);
                                        if (pdfGoruntuleyici) {
                                            pdfGoruntuleyici.innerHTML = `
                                                <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                                                    <i class="material-icons" style="font-size: 48px;">error</i>
                                                    <h4 class="mt-3">PDF Kaydetme Hatası</h4>
                                                    <p>PDF kaydedilirken bir hata oluştu: ${error.message}</p>
                                                    <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                                                </div>
                                            `;
                                        }
                                    });
                                }).catch(function(pdfCreateError) {
                                    console.error('PDF dataUrl alma hatası (önizleme):', pdfCreateError);
                                    if (pdfGoruntuleyici) {
                                        pdfGoruntuleyici.innerHTML = `
                                            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                                                <i class="material-icons" style="font-size: 48px;">error</i>
                                                <h4 class="mt-3">PDF Oluşturma Hatası</h4>
                                                <p>PDF oluşturulurken bir hata oluştu: ${pdfCreateError.message}</p>
                                                <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                                            </div>
                                        `;
                                    }
                                });
                            } else {
                                throw new Error('PDF içeriği bulunamadı veya parse edilemedi');
                            }
                        } catch (pdfError) { 
                            console.error('PDF önizleme genel hatası:', pdfError); 
                            if (pdfGoruntuleyici) {
                                pdfGoruntuleyici.innerHTML = `
                                    <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                                        <i class="material-icons" style="font-size: 48px;">error</i>
                                        <h4 class="mt-3">PDF Önizleme Hatası</h4>
                                        <p>Dosya önizlenirken bir hata oluştu: ${pdfError.message}</p>
                                        <button class="btn btn-outline-secondary mt-3" onclick="window.closeFullscreenPdfModal()">Kapat</button>
                                    </div>
                                `;
                            }
                        }
                    }, 300);
                }
            } else {
                window.bildirimGoster('Hata', sonuc.message || 'Sözleşme detayları alınamadı.', 'error');
            }
        } catch (error) {
            console.error('Sözleşme detayı yükleme hatası:', error);
            window.bildirimGoster('Hata', `Sözleşme detayları yüklenirken bir hata oluştu: ${error.message}`, 'error');
        }
    }

    // Global fonksiyon - HTML onclick'lerden çağrılacak
    window.sozlesmeSilModalGoster = function(sozlesmeId, sozlesmeAdi) {
        document.getElementById('silinecekSozlesmeId').value = sozlesmeId;
        document.getElementById('sozlesmeSilMesaj').textContent = `"${sozlesmeAdi}" sözleşmesini silmek istediğinize emin misiniz? Bu işlem geri alınamaz.`;
        sozlesmeSilModal.show();
    }
    
    document.getElementById('sozlesmeSilOnayBtn').addEventListener('click', async function() {
        const silinecekId = document.getElementById('silinecekSozlesmeId').value;
        const butonIcerik = this.innerHTML;
        this.disabled = true;
        this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Siliniyor...';
        try {
            const response = await fetch(`/api/ornek_sozlesmeler/kayitli/${silinecekId}`, {
                method: 'DELETE', headers: { 'X-CSRFToken': CSRF_TOKEN }
            });
            if (!response.ok) throw new Error(`HTTP hata kodu: ${response.status}`);
            const sonuc = await response.json();
            if (sonuc.success) {
                window.bildirimGoster('Başarılı', sonuc.message || 'Sözleşme başarıyla silindi.', 'success');
                sozlesmeSilModal.hide();
                if (aktifSozlesmeId === parseInt(silinecekId)) {
                    window.sozlesmeFormunuSifirla();
                }
                window.kayitliSozlesmeleriTabloyaListele();
            } else {
                window.bildirimGoster('Hata', sonuc.message || 'Sözleşme silinirken bir hata oluştu.', 'error');
            }
        } catch (error) {
            console.error('Sözleşme silme hatası:', error);
            window.bildirimGoster('Hata', `Sözleşme silinirken bir hata oluştu: ${error.message}`, 'error');
        } finally {
            this.innerHTML = butonIcerik; this.disabled = false;
        }
    });

    // Global fonksiyon - Sözleşme formunu sıfırla
    window.sozlesmeFormunuSifirla = function() {
        sozlesmeForm.reset();
        sozlesmeForm.classList.remove('was-validated');
        sozlesmeIdInput.value = ''; 
        aktifSozlesmeId = null;    
        document.getElementById('formBaslik').textContent = 'Yeni Avukatlık Sözleşmesi';
        document.getElementById('formAltBaslik').textContent = 'Aşağıdaki formu doldurarak avukatlık ücret sözleşmesini oluşturabilirsiniz.';
        document.getElementById('sozlesmeTarihi').valueAsDate = new Date();
        document.querySelectorAll('#sozlesmeTableBody tr.table-active').forEach(row => row.classList.remove('table-active'));
        
        // Butonları yeni oluşturma moduna ayarla
        document.getElementById('sozlesmeGuncelleBtn').style.display = 'none';
        const olusturBtn = document.getElementById('sozlesmeOlusturBtn');
        if (olusturBtn) {
            olusturBtn.style.display = 'inline-block';
        } else {
            // Fallback - form submit butonunu bul
            const submitBtn = document.getElementById('sozlesmeForm').querySelector('button[type="submit"]');
            if (submitBtn) submitBtn.style.display = 'inline-block';
        }
    }
    
    // Global fonksiyon - PDF oluşturma hatası
    window.pdfOlusturmaHatasi = function() {
        pdfGoruntuleyici.innerHTML = `
            <div class="d-flex flex-column align-items-center justify-content-center h-100 text-danger">
                <i class="material-icons" style="font-size: 4rem;">error_outline</i>
                <h4 class="mt-3">PDF Oluşturulamadı</h4>
                <p class="text-center">PDF oluşturma işlemi sırasında bir hata oluştu.</p>
                <button class="btn btn-outline-secondary mt-3" data-bs-dismiss="modal">Kapat</button>
            </div>
        `;
        pdfIndirBtn.disabled = true; sozlesmeKaydetBtn.disabled = true;
    }
    
    // Global fonksiyon - Sözleşme kaydet
    window.sozlesmeKaydet = async function() {
        if (!olusturulanPdfBelgesi) {
            window.bildirimGoster('Hata', 'Kaydedilecek sözleşme verisi bulunamadı.', 'error');
            return;
        }

        const formVerileri = {
            isSahibiAdi: document.getElementById('isSahibiAdi').value,
            isSahibiAdresi: document.getElementById('isSahibiAdresi').value,
            alinanIs: document.getElementById('alinanIs').value,
            avukatlikUcreti: document.getElementById('avukatlikUcreti').value,
            giderAvansi: window.ucretAlaniniTemizle(document.getElementById('giderAvansi').value),
            gunlukUcret: window.ucretAlaniniTemizle(document.getElementById('gunlukUcret').value),
            durusmaUcreti: window.ucretAlaniniTemizle(document.getElementById('durusmaUcreti').value),
            sozlesmeTarihi: document.getElementById('sozlesmeTarihi').value
        };

        const kaydetBtn = document.getElementById('sozlesmeKaydetBtn');
        const originalText = kaydetBtn ? kaydetBtn.innerHTML : '';
        
        try {
            if (kaydetBtn) {
                kaydetBtn.disabled = true;
                kaydetBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Kaydediliyor...';
            }

            const response = await fetch('/api/ornek_sozlesmeler/kayitli', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify({
                    muvekkil_adi: formVerileri.isSahibiAdi,
                    sozlesme_tarihi_str: formVerileri.sozlesmeTarihi,
                    icerik_json: olusturulanPdfBelgesi
                })
            });

            const sonuc = await response.json();
            if (sonuc.success) {
                window.bildirimGoster('Başarılı', 'Sözleşme başarıyla kaydedildi.', 'success');
                window.closeFullscreenPdfModal();
                window.kayitliSozlesmeleriTabloyaListele();
                window.sozlesmeFormunuSifirla();
            } else {
                window.bildirimGoster('Hata', sonuc.message || 'Sözleşme kaydedilirken bir hata oluştu.', 'error');
            }
        } catch (error) {
            console.error('Sözleşme kaydetme hatası:', error);
            window.bildirimGoster('Hata', 'Sözleşme kaydedilirken bir ağ hatası oluştu.', 'error');
        } finally {
            if (kaydetBtn) {
                kaydetBtn.innerHTML = originalText;
                kaydetBtn.disabled = false;
            }
        }
    }

    // YENİ SÖZLEŞME OLUŞTURMA FONKSİYONU
    window.yeniSozlesmeOlustur = async function(formVerileri) {
        console.log("=== YENİ SÖZLEŞME OLUŞTURMA BAŞLADI ===");
        console.log("Form verileri:", formVerileri);
        
        try {
            // Tarihi formatla
            const tarihParcalari = formVerileri.sozlesmeTarihi.split('-');
            const formatliTarih = `${tarihParcalari[2]}.${tarihParcalari[1]}.${tarihParcalari[0]}`;
            
            // PDF içeriğini oluştur
            if (typeof window.sozlesmePdfIcerigiOlustur !== 'function') {
                throw new Error('sozlesmePdfIcerigiOlustur fonksiyonu tanımlı değil');
            }
            
            const pdfBelgesi = window.sozlesmePdfIcerigiOlustur(formVerileri, formatliTarih);
            console.log("PDF belgesi oluşturuldu:", pdfBelgesi ? "Başarılı" : "Hata");
            
            if (!pdfBelgesi) {
                throw new Error('PDF içeriği oluşturulamadı');
            }
            
            // API'ye kaydetme isteği gönder
            const kayitVerisi = {
                muvekkil_adi: formVerileri.isSahibiAdi,
                sozlesme_tarihi_str: formVerileri.sozlesmeTarihi,
                icerik_json: pdfBelgesi
            };
            
            console.log("API'ye gönderilecek veri:", kayitVerisi);
            
            const response = await fetch('/api/ornek_sozlesmeler/kaydet', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN
                },
                body: JSON.stringify(kayitVerisi)
            });
            
            console.log("API response status:", response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error("API error response:", errorText);
                
                // UNIQUE constraint hatası için özel mesaj
                if (errorText.includes('UNIQUE constraint') || errorText.includes('IntegrityError')) {
                    throw new Error('Bu müvekkil ve tarih kombinasyonu zaten mevcut. Lütfen farklı bir tarih seçin veya müvekkil adını değiştirin.');
                }
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const sonuc = await response.json();
            console.log("API response:", sonuc);
            
            if (sonuc.success) {
                window.bildirimGoster('Başarılı', 'Yeni sözleşme başarıyla oluşturuldu ve kaydedildi.', 'success');
                
                // Yeni sözleşme modalını kapat
                if (window.yeniSozlesmeModal) {
                    window.yeniSozlesmeModal.hide();
                }
                
                // Tabloyu güncelle
                window.kayitliSozlesmeleriTabloyaListele();
                
                // Formu sıfırla
                const yeniForm = document.getElementById('yeniSozlesmeForm');
                if (yeniForm) {
                    yeniForm.reset();
                    yeniForm.classList.remove('was-validated');
                    document.getElementById('yeniSozlesmeTarihi').valueAsDate = new Date();
                }
            } else {
                console.error("API başarısız:", sonuc);
                window.bildirimGoster('Hata', sonuc.message || 'Sözleşme kaydedilirken bir hata oluştu.', 'error');
            }
        } catch (error) {
            console.error('Yeni sözleşme oluşturma hatası:', error);
            window.bildirimGoster('Hata', 'Sözleşme oluşturulurken bir hata oluştu: ' + error.message, 'error');
        }
    };

    // YENİ SÖZLEŞME FORMU SIFIRLAMA FONKSİYONU
    window.yeniSozlesmeFormunuSifirla = function() {
        console.log("Yeni sözleşme formu sıfırlanıyor...");
        
        const yeniForm = document.getElementById('yeniSozlesmeForm');
        if (yeniForm) {
            yeniForm.reset();
            yeniForm.classList.remove('was-validated');
            
            // Bugünün tarihini set et
            document.getElementById('yeniSozlesmeTarihi').valueAsDate = new Date();
            
            console.log("Yeni sözleşme formu sıfırlandı");
        } else {
            console.error("Yeni sözleşme formu bulunamadı!");
        }
    };

    // bildirimGoster fonksiyonu artık dosyanın başında tanımlandı

    // Global fonksiyon - Sözleşme PDF içeriği oluştur
    window.sozlesmePdfIcerigiOlustur = function(formVerileri, formatliTarih) {
        // Avukatlık ücretini doğrudan JSON'a ekle
        const avukatlikUcretiHam = formVerileri.avukatlikUcreti.toString().trim();
        console.log("sozlesmePdfIcerigiOlustur - formVerileri.avukatlikUcreti:", formVerileri.avukatlikUcreti, "Ham:", avukatlikUcretiHam);

        return {
            avukatlikUcretiRaw: avukatlikUcretiHam,
            rawFormData: formVerileri,
                            content: [
                    { text: 'AVUKATLIK ÜCRET SÖZLEŞMESİ', style: 'header', alignment: 'center' },
                    { text: '\n' },
                    {
                        columns: [
                            { width: '*', text: `İŞ SAHİBİ: ${formVerileri.isSahibiAdi}${formVerileri.isSahibiTc ? '\nT.C. Kimlik No: ' + formVerileri.isSahibiTc : ''}\nADRESİ: ${formVerileri.isSahibiAdresi}`},
                            { width: '*', text: `AVUKAT: Av. Mustafa KAPLAN\nADRESİ: Güneşli Meydanı Cumhuriyet Cd. No.47 K.3 D.8 (AKBANK ÜSTÜ) GÜNEŞLİ/İST.`}
                        ], columnGap: 20
                    },
                    { text: '\nYukarıda adı, soyadı (veya ünvanı) ile tebligata elverişli adresleri belirtilen taraflar arasında aşağıda yazılı şartlarla AVUKATLIK ÜCRET SÖZLEŞMESİ yapılmıştır. Bu sözleşmede iş sahibi MÜVEKKİL ve işi üzerine alan AVUKAT diye adlandırılmıştır.\n', style: 'paragraph'},
                    { text: `MADDE 1) AVUKATIN ÜZERİNE ALDIĞI İŞ: \n${formVerileri.alinanIs}\n`, style: 'paragraph'},
                    { text: taslakVerileri.madde2.replace('{avukatlikUcreti}', formVerileri.avukatlikUcreti).replace('{avukatAdi}', taslakVerileri.avukatAdi).replace('{bankaBilgisi}', taslakVerileri.bankaBilgisi).replace('{ibanNo}', taslakVerileri.ibanNo), style: 'paragraph'},
                    { text: 'MADDE 3) Tespit olunan ücret yalnız bu sözleşmede yazılı işin ve işlerin karşılığıdır. Bunlar dışında kalacak takipler ve bu işle ilgili bağlantılı bulunsa dahi karşı taraf veya üçüncü bir şahıs tarafından karşılıklı dava veya ayrı davalar şeklinde açılacak davalar bu sözleşme ücretin dışındadır. Avukat, bu sözleşmeye göre peşin verilmesi gerekli ücret ve aşağıda yazılı gider avansı kendisine ödenmediği sürece işe başlamak zorunluluğunda değildir. İş sahibi ile ilgili yapılacak hukuki, idari ve adli işlemlerden kaynaklanacak masraflar iş sahibine aittir.\n', style: 'paragraph'},
                    { text: 'MADDE 4) Avukat üzerine aldığı işi kanun ve bu sözleşme hükümleri uyarınca sonuna kadar takip edecektir. Avukat, verilen vekaletname ile başkasını tevkile yetkili bulunduğu takdirde, üzerine aldığı işi uygun göreceği diğer Avukatlarla birlikte takip edebileceği gibi, takibi tamamen onlara bırakabilecektir. Müvekkil de, Avukatın yazılı iznini almak şartı ile başka Avukatlara vekalet verebilir. Bu hallerde 1136 sayılı Kanunun 171 ve 172. Maddeleri hükmü uygulanır.\n', style: 'paragraph'},
                    { text: `MADDE 5) ${(() => {
                        // Boş alanlar için "-" göster
                        let giderAvansi = (formVerileri.giderAvansi && formVerileri.giderAvansi.trim() !== '' && formVerileri.giderAvansi.trim() !== '0') ? formVerileri.giderAvansi : '-';
                        let gunlukUcret = (formVerileri.gunlukUcret && formVerileri.gunlukUcret.trim() !== '' && formVerileri.gunlukUcret.trim() !== '0') ? formVerileri.gunlukUcret : '-';
                        let durusmaUcreti = (formVerileri.durusmaUcreti && formVerileri.durusmaUcreti.trim() !== '' && formVerileri.durusmaUcreti.trim() !== '0') ? formVerileri.durusmaUcreti : '-';

                        return `İşin yapılması için gerekli bütün vergi, resim, harç gibi giderler müvekkile ait olup, Avukatın ilk isteminde Müvekkil tarafından Avukata veya merciine ödenmesi gerekir. Verilen iş için yapılacak giderlerin tümü müvekkile aittir ve bu giderler ödenmedikçe Avukat işi yapmak zorunda değildir. Yukarıda sayılan giderlerin Avukat tarafından yapılabilmesini Sağlamak için müvekkil, giderleri karşılayacak avansı Zamanında vermek zorunluluğundadır. Müvekkil bu iş için Avukata ${giderAvansi}-TL gider avansını peşin olarak verecektir. İş seyahati gerektiğinde uçak 1. mevki yataklı tarifesine göre tren, vapur ve bilet ücretleri müvekkil tarafından ücretten ayrı olarak ödenecektir. Bu giderler verilmeksizin Avukat seyahati yapmak zorunda değildir. Müvekkil yolculuk giderlerinden başka, Avukatın bürosundan ayrı kaldığı her gün için ${gunlukUcret}-TL ödemeyi kabul etmiştir. Yargıtay, Danıştay ve Vergi Temyiz Komisyonları huzurunda duruşma ayrı ücrete tabidir. Bu takdirde yukarıda sayılan yol giderlerinden başka Avukata ${durusmaUcreti}-TL verilecektir. Bu paralar peşin ödenmedikçe Avukat duruşmada bulunmak zorunda değildir.`;
                    })()}\n`, style: 'paragraph'},
                    { text: 'MADDE 6) Müvekkilin bu sözleşmenin akdinden sonra vekalet vermemesi, dosyasını geri alması, Avukatın yazılı iznini almadan başka Avukatları teşrik etmesi veya bir başka Avukata işini vermesi, istenen giderleri ödememesi, iddia veya savunma için gerekli bilgi, belge ve delilleri vermemesi, değiştirdiği halde yeni adresini yazılı olarak bildirmeyip işin takibini bu suretle imkansız hale getirmesi, Avukatın rızası olmadan davanın veya alacağın takibinden kısmen veya tamamen vazgeçmesi, karşı taraf ile sulh olması veya karşı tarafı ibra etmesi veya haklı bir sebep yokken Avukatı engellediği durumlarda Avukat sözleşmeyi bozabilir. Bu durumda sözleşmede belirtilen ücretin tamamı Avukatın ilk isteminde derhal ve bir defada ödenmesi gerekir.\n', style: 'paragraph'},
                    { text: 'MADDE 7) Yukarıda yazılı adres müvekkilin tebligat adresidir. Avukat tarafından bu adrese yapılacak bütün ihbar ve tebliğlerin şahsına yapılmış olduğunu kabul eder. Müvekkil adresini değiştirdiği takdirde yeni adresini Avukata derhal bildirmek zorundadır. Yukarıda yazılı adrese gönderilecek yazıların tebliğ edilmesinden ve yeni adresini bildirmemesinden doğacak sonuç 6. maddenin 2.fıkrasında yazılı olup, müvekkil bunları şimdiden kabul eder.\n', style: 'paragraph'},
                    { text: 'MADDE 8) İş bu sözleşmenin süresi sözleşmenin imzalandığı tarihten itibaren 1 yıldır. Taraflar anlaşarak 1 yılın sonunda sözleşmeyi karşılıklı olarak feshetmezler ise Avukatlık ücreti 1(bir) yılın sonunda TEFE/TÜFE ortalaması alınarak resen artar.\n', style: 'paragraph'},
                    { text: 'MADDE 9) İş bu sözleşmede açıklık bulunmayan durumlarda 1136 sayılı Avukatlık Kanunu hükümleri uygulanır.\n', style: 'paragraph'},
                    { text: 'MADDE 10) Bu sözleşmeden doğacak anlaşmazlıklarda yetkili mercii Bakırköy Mahkemeleri ve icra daireleridir.\n', style: 'paragraph'},
                    { text: formatliTarih, alignment: 'right', style: 'paragraph' },
                    { text: '\n' },
                    {
                        columns: [
                            { width: '*', text: `MÜVEKKİL\n\n${formVerileri.isSahibiAdi}${formVerileri.isSahibiTc ? '\nT.C. Kimlik No: ' + formVerileri.isSahibiTc : ''}\n___________________` },
                            { width: '*', text: 'AVUKAT\n\n\nAv. Mustafa KAPLAN\n___________________', alignment: 'right' }
                        ], columnGap: 20, style: 'signature'
                    }
                ],
            styles: {
                header: { fontSize: 14, bold: true, margin: [0, 0, 0, 10] },
                paragraph: { fontSize: 9, alignment: 'justify', margin: [0, 2, 0, 2], lineHeight: 1.1 },
                signature: { fontSize: 9, bold: true, margin: [0, 10, 0, 0] }
            },
            defaultStyle: { font: 'Roboto', fontSize: 9, lineHeight: 1.1 }
        };
    }

    // TASLAK DÜZENLEME FONKSİYONLARI
    window.taslakDuzenleModalAc = function() {
        console.log("Taslak düzenleme modal açılıyor...");
        
        try {
            // Mevcut taslak verilerini yükle
            window.taslakVerileriniYukle();
            
            // Modal aç
            const taslakModal = new bootstrap.Modal(document.getElementById('taslakDuzenleModal'), {
                backdrop: false,
                keyboard: false
            });
            taslakModal.show();
            
            console.log("Taslak düzenleme modal açıldı");
        } catch (error) {
            console.error('Taslak modal açma hatası:', error);
            window.bildirimGoster('Hata', 'Taslak düzenleme modal açılırken hata oluştu.', 'error');
        }
    };

    window.taslakVerileriniYukle = function() {
        // Veritabanından taslak verilerini yükle
        fetch('/api/contract_template')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.template) {
                const taslakVerileri = data.template;
        
        document.getElementById('taslakAvukatAdi').value = taslakVerileri.avukatAdi || 'Av. Mustafa KAPLAN';
        document.getElementById('taslakAvukatAdres').value = taslakVerileri.avukatAdres || 'Güneşli Meydanı Cumhuriyet Cd. No.47 K.3 D.8 (AKBANK ÜSTÜ) GÜNEŞLİ/İST.';
        document.getElementById('taslakBankaBilgisi').value = taslakVerileri.bankaBilgisi || 'Garanti Bankası Güneşli Şubesi';
        document.getElementById('taslakIbanNo').value = taslakVerileri.ibanNo || 'TR930006200029500006684655';
        document.getElementById('taslakYetkiliMahkeme').value = taslakVerileri.yetkiliMahkeme || 'Bakırköy Mahkemesi ve İcra Daireleri';
        document.getElementById('taslakKanunNo').value = taslakVerileri.kanunNo || '1136 sayılı Avukatlık Kanunu';
        document.getElementById('taslakGirisMetni').value = taslakVerileri.girisMetni || 'Yukarıda adı, soyadı (veya ünvanı) ile tebligata elverişli adresleri belirtilen taraflar arasında aşağıda yazılı şartlarla AVUKATLIK ÜCRET SÖZLEŞMESİ yapılmıştır. Bu sözleşmede iş sahibi MÜVEKKİL ve işi üzerine alan AVUKAT diye adlandırılmıştır.';
        document.getElementById('taslakMadde2').value = taslakVerileri.madde2 || 'MADDE 2) Sözleşme konusu olan işten dolayı, Avukat\'a {avukatlikUcreti} avukatlık ücreti ödenecektir.\nBu ücret {avukatAdi}\'a ait {bankaBilgisi} {ibanNo} İban nolu hesaba ödenecektir. Belirli sürelerde yapılması gereken ödemelerden herhangi biri yapılmadığı takdirde ücretin tamamı muaccel olur. İş sahibinin birden çok olması halinde sözleşmeyi birlikte imzalayanlar, Avukatlık Ücretinin ödenmesinde Avukata karşı müteselsilen borçlu ve sorumludurlar.';
        document.getElementById('taslakMadde3').value = taslakVerileri.madde3 || 'Tespit olunan ücret yalnız bu sözleşmede yazılı işin ve işlerin karşılığıdır. Bunlar dışında kalacak takipler ve bu işle ilgili bağlantılı bulunsa dahi karşı taraf veya üçüncü bir şahıs tarafından karşılıklı dava veya ayrı davalar şeklinde açılacak davalar bu sözleşme ücretin dışındadır. Avukat, bu sözleşmeye göre peşin verilmesi gerekli ücret ve aşağıda yazılı gider avansı kendisine ödenmediği sürece işe başlamak zorunluluğunda değildir. İş sahibi ile ilgili yapılacak hukuki, idari ve adli işlemlerden kaynaklanacak masraflar iş sahibine aittir.';
        document.getElementById('taslakMadde4').value = taslakVerileri.madde4 || 'Avukat üzerine aldığı işi kanun ve bu sözleşme hükümleri uyarınca sonuna kadar takip edecektir. Avukat, verilen vekaletname ile başkasını tevkile yetkili bulunduğu takdirde, üzerine aldığı işi uygun göreceği diğer Avukatlarla birlikte takip edebileceği gibi, takibi tamamen onlara bırakabilecektir. Müvekkil de, Avukatın yazılı iznini almak şartı ile başka Avukatlara vekalet verebilir. Bu hallerde 1136 sayılı Kanunun 171 ve 172. Maddeleri hükmü uygulanır.';
        
        // Yeni eklenen Madde 5-10
        document.getElementById('taslakMadde5').value = taslakVerileri.madde5 || 'İşin yapılması için gerekli bütün vergi, resim, harç gibi giderler müvekkile ait olup, Avukatın ilk isteminde Müvekkil tarafından Avukata veya merciine ödenmesi gerekir. Verilen iş için yapılacak giderlerin tümü müvekkile aittir ve bu giderler ödenmedikçe Avukat işi yapmak zorunda değildir. Müvekkil bu iş için Avukata {giderAvansi}-TL gider avansını peşin olarak verecektir. Müvekkil yolculuk giderlerinden başka, Avukatın bürosundan ayrı kaldığı her gün için {gunlukUcret}-TL ödemeyi kabul etmiştir. Duruşma için {durusmaUcreti}-TL verilecektir.';
        document.getElementById('taslakMadde6').value = taslakVerileri.madde6 || 'Müvekkilin bu sözleşmenin akdinden sonra vekalet vermemesi, dosyasını geri alması, Avukatın yazılı iznini almadan başka Avukatları teşrik etmesi veya bir başka Avukata işini vermesi, istenen giderleri ödememesi, iddia veya savunma için gerekli bilgi, belge ve delilleri vermemesi, değiştirdiği halde yeni adresini yazılı olarak bildirmeyip işin takibini bu suretle imkansız hale getirmesi durumlarında Avukat sözleşmeyi bozabilir.';
        document.getElementById('taslakMadde7').value = taslakVerileri.madde7 || 'Yukarıda yazılı adres müvekkilin tebligat adresidir. Avukat tarafından bu adrese yapılacak bütün ihbar ve tebliğlerin şahsına yapılmış olduğunu kabul eder. Müvekkil adresini değiştirdiği takdirde yeni adresini Avukata derhal bildirmek zorundadır. Yukarıda yazılı adrese gönderilecek yazıların tebliğ edilmesinden ve yeni adresini bildirmemesinden doğacak sonuçları müvekkil şimdiden kabul eder.';
        document.getElementById('taslakMadde8').value = taslakVerileri.madde8 || 'İş bu sözleşmenin süresi sözleşmenin imzalandığı tarihten itibaren 1 yıldır. Taraflar anlaşarak 1 yılın sonunda sözleşmeyi karşılıklı olarak feshetmezler ise Avukatlık ücreti 1(bir) yılın sonunda TEFE/TÜFE ortalaması alınarak resen artar.';
        document.getElementById('taslakMadde9').value = taslakVerileri.madde9 || 'İş bu sözleşmede açıklık bulunmayan durumlarda {kanunNo} hükümleri uygulanır.';
        document.getElementById('taslakMadde10').value = taslakVerileri.madde10 || 'Bu sözleşmeden doğacak anlaşmazlıklarda yetkili mercii {yetkiliMahkeme}dir.';
            } else {
                console.error('Taslak veriler yüklenemedi:', data.error);
                window.bildirimGoster('Uyarı', 'Taslak veriler yüklenemedi, varsayılan değerler kullanılıyor.', 'warning');
            }
        })
        .catch(error => {
            console.error('API hatası:', error);
            window.bildirimGoster('Uyarı', 'Taslak veriler yüklenemedi, varsayılan değerler kullanılıyor.', 'warning');
        });
    };

    window.taslakKaydet = function() {
        console.log("Taslak veriler kaydediliyor...");
        
        try {
            const taslakVerileri = {
                avukatAdi: document.getElementById('taslakAvukatAdi').value,
                avukatAdres: document.getElementById('taslakAvukatAdres').value,
                bankaBilgisi: document.getElementById('taslakBankaBilgisi').value,
                ibanNo: document.getElementById('taslakIbanNo').value,
                yetkiliMahkeme: document.getElementById('taslakYetkiliMahkeme').value,
                kanunNo: document.getElementById('taslakKanunNo').value,
                girisMetni: document.getElementById('taslakGirisMetni').value,
                madde2: document.getElementById('taslakMadde2').value,
                madde3: document.getElementById('taslakMadde3').value,
                madde4: document.getElementById('taslakMadde4').value,
                madde5: document.getElementById('taslakMadde5').value,
                madde6: document.getElementById('taslakMadde6').value,
                madde7: document.getElementById('taslakMadde7').value,
                madde8: document.getElementById('taslakMadde8').value,
                madde9: document.getElementById('taslakMadde9').value,
                madde10: document.getElementById('taslakMadde10').value,
                kaydetmeTarihi: new Date().toISOString()
            };
            
            // Veritabanına kaydet (tüm kullanıcılar için)
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            fetch('/api/contract_template', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(taslakVerileri)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mevcut sozlesmePdfIcerigiOlustur fonksiyonunu güncelle
                    window.sozlesmePdfIcerigiOlusturGuncelle(taslakVerileri);
                    
                    window.bildirimGoster('Başarılı', 'Taslak sözleşme değişiklikleri kaydedildi. Tüm kullanıcılar için güncellenmiş şablon aktif edildi.', 'success');
                } else {
                    window.bildirimGoster('Hata', 'Taslak kaydedilirken hata oluştu: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                window.bildirimGoster('Hata', 'Taslak kaydedilirken hata oluştu: ' + error.message, 'error');
            });
            
            // Modal kapat
            const modalElement = document.getElementById('taslakDuzenleModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
            
            console.log("Taslak kaydedildi:", taslakVerileri);
        } catch (error) {
            console.error('Taslak kaydetme hatası:', error);
            window.bildirimGoster('Hata', 'Taslak kaydedilirken hata oluştu.', 'error');
        }
    };

    window.taslakVarsayilanaGetir = function() {
        if (confirm('Tüm değişiklikler silinecek ve varsayılan değerler geri yüklenecek. Emin misiniz?')) {
            localStorage.removeItem('avukatTaslakSozlesme');
            window.taslakVerileriniYukle();
            window.bildirimGoster('Bilgi', 'Taslak varsayılan değerlere sıfırlandı.', 'info');
        }
    };

    // PDF oluşturma fonksiyonunu güncelle
    window.sozlesmePdfIcerigiOlusturGuncelle = function(taslakVerileri) {
        window.sozlesmePdfIcerigiOlustur = function(formVerileri, formatliTarih) {
            const avukatlikUcretiHam = formVerileri.avukatlikUcreti.toString().trim();
            
            return {
                avukatlikUcretiRaw: avukatlikUcretiHam,
                rawFormData: formVerileri,
                content: [
                    { text: 'AVUKATLIK ÜCRET SÖZLEŞMESİ', style: 'header', alignment: 'center' },
                    { text: '\n' },
                    {
                        columns: [
                            { width: '*', text: `İŞ SAHİBİ: ${formVerileri.isSahibiAdi}${formVerileri.isSahibiTc ? '\nT.C. Kimlik No: ' + formVerileri.isSahibiTc : ''}\nADRESİ: ${formVerileri.isSahibiAdresi}`},
                            { width: '*', text: `AVUKAT: ${taslakVerileri.avukatAdi}\nADRESİ: ${taslakVerileri.avukatAdres}`}
                        ], columnGap: 20
                    },
                    { text: `\n${taslakVerileri.girisMetni}\n`, style: 'paragraph'},
                    { text: `MADDE 1) AVUKATIN ÜZERİNE ALDIĞI İŞ: \n${formVerileri.alinanIs}\n`, style: 'paragraph'},
                    { text: taslakVerileri.madde2.replace('{avukatlikUcreti}', formVerileri.avukatlikUcreti).replace('{avukatAdi}', taslakVerileri.avukatAdi).replace('{bankaBilgisi}', taslakVerileri.bankaBilgisi).replace('{ibanNo}', taslakVerileri.ibanNo), style: 'paragraph'},
                    { text: `MADDE 3) ${taslakVerileri.madde3}\n`, style: 'paragraph'},
                    { text: `MADDE 4) ${taslakVerileri.madde4}\n`, style: 'paragraph'},
                    { text: `MADDE 5) ${(() => {
                        // Boş alanlar için "-" göster
                        let giderAvansi = (formVerileri.giderAvansi && formVerileri.giderAvansi.trim() !== '' && formVerileri.giderAvansi.trim() !== '0') ? formVerileri.giderAvansi : '-';
                        let gunlukUcret = (formVerileri.gunlukUcret && formVerileri.gunlukUcret.trim() !== '' && formVerileri.gunlukUcret.trim() !== '0') ? formVerileri.gunlukUcret : '-';
                        let durusmaUcreti = (formVerileri.durusmaUcreti && formVerileri.durusmaUcreti.trim() !== '' && formVerileri.durusmaUcreti.trim() !== '0') ? formVerileri.durusmaUcreti : '-';

                        return `İşin yapılması için gerekli bütün vergi, resim, harç gibi giderler müvekkile ait olup, Avukatın ilk isteminde Müvekkil tarafından Avukata veya merciine ödenmesi gerekir. Verilen iş için yapılacak giderlerin tümü müvekkile aittir ve bu giderler ödenmedikçe Avukat işi yapmak zorunda değildir. Yukarıda sayılan giderlerin Avukat tarafından yapılabilmesini Sağlamak için müvekkil, giderleri karşılayacak avansı Zamanında vermek zorunluluğundadır. Müvekkil bu iş için Avukata ${giderAvansi}-TL gider avansını peşin olarak verecektir. İş seyahati gerektiğinde uçak 1. mevki yataklı tarifesine göre tren, vapur ve bilet ücretleri müvekkil tarafından ücretten ayrı olarak ödenecektir. Bu giderler verilmeksizin Avukat seyahati yapmak zorunda değildir. Müvekkil yolculuk giderlerinden başka, Avukatın bürosundan ayrı kaldığı her gün için ${gunlukUcret}-TL ödemeyi kabul etmiştir. Yargıtay, Danıştay ve Vergi Temyiz Komisyonları huzurunda duruşma ayrı ücrete tabidir. Bu takdirde yukarıda sayılan yol giderlerinden başka Avukata ${durusmaUcreti}-TL verilecektir. Bu paralar peşin ödenmedikçe Avukat duruşmada bulunmak zorunda değildir.`;
                    })()}\n`, style: 'paragraph'},
                    { text: `MADDE 6) ${taslakVerileri.madde6}\n`, style: 'paragraph'},
                    { text: `MADDE 7) ${taslakVerileri.madde7}\n`, style: 'paragraph'},
                    { text: `MADDE 8) ${taslakVerileri.madde8}\n`, style: 'paragraph'},
                    { text: `MADDE 9) ${taslakVerileri.madde9.replace('{kanunNo}', taslakVerileri.kanunNo)}\n`, style: 'paragraph'},
                    { text: `MADDE 10) ${taslakVerileri.madde10.replace('{yetkiliMahkeme}', taslakVerileri.yetkiliMahkeme)}\n`, style: 'paragraph'},
                    { text: formatliTarih, alignment: 'right', style: 'paragraph' },
                    { text: '\n' },
                    {
                        columns: [
                            { width: '*', text: `MÜVEKKİL\n\n${formVerileri.isSahibiAdi}${formVerileri.isSahibiTc ? '\nT.C. Kimlik No: ' + formVerileri.isSahibiTc : ''}\n___________________` },
                            { width: '*', text: `AVUKAT\n\n\n${taslakVerileri.avukatAdi}\n___________________`, alignment: 'right' }
                        ], columnGap: 20, style: 'signature'
                    }
                ],
                styles: {
                    header: { fontSize: 14, bold: true, margin: [0, 0, 0, 10] },
                    paragraph: { fontSize: 9, alignment: 'justify', margin: [0, 2, 0, 2], lineHeight: 1.1 },
                    signature: { fontSize: 9, bold: true, margin: [0, 10, 0, 0] }
                },
                defaultStyle: { font: 'Roboto', fontSize: 9, lineHeight: 1.1 }
            };
        };
    };

    // Sayfa yüklendiğinde taslak verilerini kontrol et ve uygula
    window.addEventListener('DOMContentLoaded', function() {
        // Veritabanından taslak verilerini yükle ve uygula
        fetch('/api/contract_template')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.template) {
                console.log("Global taslak veriler yüklendi:", data.template);
                window.sozlesmePdfIcerigiOlusturGuncelle(data.template);
            }
        })
        .catch(error => {
            console.error('Taslak veriler yüklenirken hata:', error);
        });

        // Arama kutusu event listener'ları
        const searchInput = document.getElementById('contractsSearchInput');
        const clearSearchBtn = document.getElementById('clearContractsSearchBtn');
        
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value;
                filterContracts(searchTerm);
                
                // Temizle butonunu göster/gizle
                if (clearSearchBtn) {
                    clearSearchBtn.style.display = searchTerm ? 'block' : 'none';
                }
            });
        }
        
        if (clearSearchBtn) {
            clearSearchBtn.addEventListener('click', function() {
                if (searchInput) {
                    searchInput.value = '';
                    filterContracts('');
                    this.style.display = 'none';
                    searchInput.focus();
                }
            });
        }
    });

    // Periyodik tablo yenileme (ilk yükleme zaten DOMContentLoaded içinde yapılıyor)
    setInterval(() => {
        if (!document.querySelector('.modal.show')) { // Modal açık değilse yenile
            kayitliSozlesmeleriTabloyaListele();
        }
    }, 30000);
    
</script>
{% endblock %} 