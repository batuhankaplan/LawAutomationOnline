{% extends "layout.html" %}

{% block title %}Ödemeler{% endblock %}

{% block content %}
    <!-- Chart.js kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <div class="header-left">
        <h1>Ödemeler</h1>
    </div>

    <div class="form-container">
        <form method="POST" id="paymentForm">
            <div class="input-group">
                <label for="name">Ad</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="input-group">
                <label for="surname">Soyad</label>
                <input type="text" id="surname" name="surname" required>
            </div>
            <div class="input-group">
                <label for="tc">TC Kimlik No</label>
                <input type="text" id="tc" name="tc" required>
            </div>
            <div class="input-group">
                <label for="amount">Tutar</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="amount" name="amount" required style="flex: 1;" placeholder="Örn: 1000.50">
                    <select id="currency" name="currency" required>
                        <option value="TL">TL</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <label for="installments">Taksit Sayısı</label>
                <select id="installments" name="installments" required>
                    {% for i in range(1, 13) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <label for="registration_date">Borç Kayıt Tarihi</label>
                <input type="date" id="registration_date" name="registration_date" value="{{ today_date if today_date else '' }}">
            </div>
            <div class="input-group">
                <label for="due_date">Son Ödeme Tarihi</label>
                <input type="date" id="due_date" name="due_date">
            </div>
            <button type="button" onclick="savePayment(event)">Kaydet</button>
        </form>
    </div>

    <div class="table-container">
        <div class="table-header">
        <h2>Müvekkil Ödeme Listesi</h2>
            {% if current_user.has_permission('odeme_istatistik_goruntule') %}
            <button id="statsButton" class="stats-btn" title="İstatistikleri Görüntüle">
                <i class="material-icons">insert_chart</i>
            </button>
            {% endif %}
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th id="sort-name">Ad <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-surname">Soyad <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-tc">TC Kimlik No <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-amount">Tutar <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-installments">Taksit Sayısı <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-registration-date">Borç Tarihi <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-due-date">Son Ödeme Tarihi <i class="material-icons sort-icon">unfold_more</i></th>
                    <th id="sort-status">Durum <i class="material-icons sort-icon">unfold_more</i></th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr data-client-id="{{ client.id }}" data-description="{{ client.description }}">
                    <td contenteditable="false">{{ client.name }}</td>
                    <td contenteditable="false">{{ client.surname }}</td>
                    <td contenteditable="false">{{ client.tc }}</td>
                    <td contenteditable="false">{{ client.amount }} {{ client.currency }}</td>
                    <td contenteditable="false">{{ client.installments }}</td>
                    <td contenteditable="false">{{ client.registration_date.strftime('%d.%m.%Y') if client.registration_date else '-' }}</td>
                    <td contenteditable="false">{{ client.due_date.strftime('%d.%m.%Y') if client.due_date else '-' }}</td>
                    <td>
                        {% if client.status == 'Ödendi' %}
                            <span class="status-badge status-paid">Ödendi</span>
                        {% else %}
                            <span class="status-badge status-unpaid">Ödenmedi</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="view-btn" title="Detayları Görüntüle" 
                                    data-payment-id="{{ client.id }}">
                                <i class="material-icons">visibility</i>
                            </button>
                            <button class="delete-btn" onclick="deletePayment(this)">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Düzenleme Modalı -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ödeme Düzenle</h2>
                <span class="close">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editClientId" name="editClientId">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editName">Ad</label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editSurname">Soyad</label>
                            <input type="text" id="editSurname" name="surname" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group tc-group">
                            <label for="editTc">TC Kimlik No</label>
                            <input type="text" id="editTc" name="tc" class="form-control" required maxlength="11">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group amount-group">
                            <label for="editAmount">Tutar</label>
                            <div class="amount-input">
                                <input type="text" id="editAmount" name="amount" class="form-control" required placeholder="Örn: 1000.50">
                                <select id="editCurrency" name="currency" class="form-control currency-select" required>
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editInstallments">Taksit Sayısı</label>
                            <select id="editInstallments" name="installments" class="form-control" required>
                                {% for i in range(1, 13) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group date-group">
                            <label for="editRegistrationDate">Borç Kayıt Tarihi</label>
                            <input type="date" id="editRegistrationDate" name="registration_date" class="form-control">
                        </div>
                        <div class="form-group date-group">
                            <label for="editDueDate">Son Ödeme Tarihi</label>
                            <input type="date" id="editDueDate" name="due_date" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ödeme Durumu</label>
                            <div class="toggle-container">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="editStatus" name="status">
                                    <label for="editStatus"></label>
                                </div>
                                <span class="status-text">Ödenmedi</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDescription">Açıklama</label>
                            <div class="textarea-container">
                                <textarea id="editDescription" name="description" class="form-control" rows="3" placeholder="Açıklama bulunmuyor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="saveEditBtn">Kaydet</button>
                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Kapat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- İstatistik Modalı -->
    <div id="statsModal" class="modal">
        <div class="modal-content stats-modal-content">
            <div class="modal-header">
                <h2>Ödeme İstatistikleri</h2>
                <span class="close" id="closeStatsModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stats-tabs">
                    <button class="stats-tab-btn active" data-tab="summary"><i class="material-icons">dashboard</i> Özet</button>
                    <button class="stats-tab-btn" data-tab="monthly"><i class="material-icons">date_range</i> Aylık Analiz</button>
                    <button class="stats-tab-btn" data-tab="yearly"><i class="material-icons">calendar_today</i> Yıllık Analiz</button>
                    <button class="stats-tab-btn" data-tab="status"><i class="material-icons">assignment</i> Durum Analizi</button>
                    <button class="stats-tab-btn" data-tab="currency"><i class="material-icons">currency_exchange</i> Para Birimi Analizi</button>
                    <button class="stats-tab-btn" data-tab="predictions"><i class="material-icons">analytics</i> Tahminler</button>
                </div>
                
                <div class="stats-content">
                    <!-- ÖZET SEKMESİ -->
                    <div class="stats-tab-content active" id="summary-tab">
                        <div class="stats-summary-grid">
                            <!-- Ana Kartlar -->
                            <div class="summary-main-cards">
                                <div class="summary-card total-amount">
                                    <div class="card-icon"><i class="material-icons">payments</i></div>
                                    <div class="card-content">
                                        <h3>Toplam Alacak (TL)</h3>
                                        <p id="totalAmount">0 TL</p>
                                    </div>
                                </div>
                                <div class="summary-card total-paid">
                                    <div class="card-icon"><i class="material-icons">check_circle</i></div>
                                    <div class="card-content">
                                        <h3>Ödenen Tutar (TL)</h3>
                                        <p id="totalPaid">0 TL</p>
                                    </div>
                                </div>
                                <div class="summary-card total-unpaid">
                                    <div class="card-icon"><i class="material-icons">error</i></div>
                                    <div class="card-content">
                                        <h3>Ödenmemiş Tutar (TL)</h3>
                                        <p id="totalUnpaid">0 TL</p>
                                    </div>
                                </div>
                                <div class="summary-card client-count">
                                    <div class="card-icon"><i class="material-icons">people</i></div>
                                    <div class="card-content">
                                        <h3>Toplam Müvekkil</h3>
                                        <p id="clientCount">0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Detay Kartları -->
                            <div class="summary-detail-cards">
                                <div class="summary-card detail-card expected-next-year">
                                    <div class="card-icon"><i class="material-icons">event_available</i></div>
                                    <div class="card-content">
                                        <h4>Gelecek Yıl Beklenen (TL)</h4>
                                        <p id="expectedNextYear">0 TL</p>
                                    </div>
                                </div>
                                <div class="summary-card detail-card highest-payment">
                                    <div class="card-icon"><i class="material-icons">star</i></div>
                                    <div class="card-content">
                                        <h4>En Yüksek Ödeme</h4>
                                        <p id="highestPaymentInfo">-</p>
                                    </div>
                                </div>
                                <div class="summary-card detail-card overdue-payments">
                                    <div class="card-icon"><i class="material-icons">warning</i></div>
                                    <div class="card-content">
                                        <h4>Vadesi Geçmiş Ödeme Sayısı</h4>
                                        <p id="overdueCount">0</p>
                                    </div>
                                </div>
                                <div class="summary-card detail-card avg-installments">
                                    <div class="card-icon"><i class="material-icons">format_list_numbered</i></div>
                                    <div class="card-content">
                                        <h4>Ort. Taksit Sayısı / Ödenen</h4>
                                        <p id="avgInstallmentInfo">0 / 0</p>
                                    </div>
                                </div>
                                <div class="summary-card detail-card currency-breakdown-usd">
                                    <div class="card-icon"><i class="material-icons">attach_money</i></div>
                                    <div class="card-content">
                                        <h4>USD İşlem Özeti</h4>
                                        <p id="totalAmountUSD">Toplam: 0 USD</p>
                                        <p id="totalPaidUSD">Ödenen: 0 USD</p>
                                        <p id="totalUnpaidUSD">Beklenen: 0 USD</p>
                                    </div>
                                </div>
                                <div class="summary-card detail-card currency-breakdown-eur">
                                    <div class="card-icon"><i class="material-icons">euro_symbol</i></div>
                                    <div class="card-content">
                                        <h4>EUR İşlem Özeti</h4>
                                        <p id="totalAmountEUR">Toplam: 0 EUR</p>
                                        <p id="totalPaidEUR">Ödenen: 0 EUR</p>
                                        <p id="totalUnpaidEUR">Beklenen: 0 EUR</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ödeme Durumu Grafiği -->
                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">pie_chart</i> Ödeme Durumu Dağılımı</h3>
                            </div>
                            <div class="status-summary">
                                <div class="status-card paid">
                                    <div class="status-card-title">Ödenmiş Alacaklar</div>
                                    <div class="status-card-value" id="paidPercentage">0%</div>
                                    <div class="status-card-percentage" id="paidClients">0 Müvekkil</div>
                                </div>
                                <div class="status-card unpaid">
                                    <div class="status-card-title">Ödenmemiş Alacaklar</div>
                                    <div class="status-card-value" id="unpaidPercentage">0%</div>
                                    <div class="status-card-percentage" id="unpaidClients">0 Müvekkil</div>
                                </div>
                                <div class="status-card overdue">
                                    <div class="status-card-title">Vadesi Geçmiş Ödemeler</div>
                                    <div class="status-card-value" id="overduePercentage">0%</div>
                                    <div class="status-card-percentage" id="overdueAmount">0 TL</div>
                                </div>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="summaryChart"></canvas>
                            </div>
                        </div>

                        <!-- Yıllara Göre Beklenen Ödemeler Tablosu -->
                        <div class="summary-extra-info">
                            <h4>Yıllara Göre Beklenen Ödemeler (Ödenmemiş)</h4>
                            <div id="expectedPaymentsByYearTableContainer">
                                <!-- Tablo JavaScript ile eklenecek -->
                                <canvas id="expectedPaymentsByYearChart" style="height: 300px; min-height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- AYLIK ANALİZ SEKMESİ -->
                    <div class="stats-tab-content" id="monthly-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">date_range</i> Aylık Ödeme Analizi</h3>
                            <div class="chart-filters">
                                <select id="monthlyYearFilter" class="chart-filter">
                                    <!-- Yıllar JavaScript ile eklenecek -->
                                </select>
                                <select id="monthlyCurrencyFilter" class="chart-filter">
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="ALL">Tüm Para Birimleri</option>
                                </select>
                            </div>
                        </div>

                        <div class="monthly-distribution">
                            <div class="chart-container medium-chart">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Ayı</div>
                                    <div class="data-card-value" id="highestMonth">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Düşük Ay</div>
                                    <div class="data-card-value" id="lowestMonth">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Aylık Ortalama</div>
                                    <div class="data-card-value" id="monthlyAverage">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Toplam Tahsilat</div>
                                    <div class="data-card-value" id="monthlyTotalCollection">0 TL</div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="table-title"><i class="material-icons">table_chart</i> Aylık Detay Tablosu</h3>
                        <div class="detail-table-container" id="monthlyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>
                    
                    <!-- YILLIK ANALİZ SEKMESİ -->
                    <div class="stats-tab-content" id="yearly-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">calendar_today</i> Yıllık Ödeme Analizi</h3>
                            <div class="chart-filters">
                                <select id="yearlyCurrencyFilter" class="chart-filter">
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="ALL">Tüm Para Birimleri</option>
                                </select>
                                <select id="yearlyChartType" class="chart-filter">
                                    <option value="bar">Sütun Grafik</option>
                                    <option value="line">Çizgi Grafik</option>
                                    <option value="area">Alan Grafik</option>
                                </select>
                            </div>
                        </div>

                        <div class="yearly-distribution">
                            <div class="chart-container medium-chart">
                                <canvas id="yearlyChart"></canvas>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Yıl</div>
                                    <div class="data-card-value" id="highestYear">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Yıllık Ortalama</div>
                                    <div class="data-card-value" id="yearlyAverage">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Son Yıl Artış</div>
                                    <div class="data-card-value" id="yearlyGrowth">0%</div>
                                    <div class="trend-indicator">
                                        <i class="material-icons trend-positive">trending_up</i>
                                        <span>Önceki yıla göre</span>
                                    </div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Gelecek Yıl Tahmin</div>
                                    <div class="data-card-value" id="nextYearForecast">0 TL</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Yıllık Detay Tablosu</h3>
                        <div class="detail-table-container" id="yearlyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>
                    
                    <!-- DURUM ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="status-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">assignment</i> Ödeme Durumu Analizi</h3>
                        </div>

                        <div class="analysis-section">
                            <div class="status-summary">
                                <div class="status-card paid">
                                    <div class="status-card-title">Ödenmiş İşlemler</div>
                                    <div class="status-card-value" id="paidTransCount">0</div>
                                    <div class="status-card-percentage" id="paidTransPercentage">0%</div>
                                </div>
                                <div class="status-card unpaid">
                                    <div class="status-card-title">Ödenmemiş İşlemler</div>
                                    <div class="status-card-value" id="unpaidTransCount">0</div>
                                    <div class="status-card-percentage" id="unpaidTransPercentage">0%</div>
                                </div>
                                <div class="status-card overdue">
                                    <div class="status-card-title">Vadesi Geçmiş İşlemler</div>
                                    <div class="status-card-value" id="overdueTransCount">0</div>
                                    <div class="status-card-percentage" id="overdueTransPercentage">0%</div>
                                </div>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">hourglass_empty</i> Vade Durumu Analizi</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">Ortalama Vade Süresi</div>
                                    <div class="data-card-value" id="avgDueTime">0 Gün</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Yakın Ödemeler</div>
                                    <div class="data-card-value" id="nextDueCount">0 Ödeme</div>
                                    <div class="trend-indicator">
                                        <span id="nextDueDate">30 gün içinde</span>
                                    </div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Vadesi En Uzun Geçmiş</div>
                                    <div class="data-card-value" id="mostOverdueInfo">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Toplam Gecikme Süresi</div>
                                    <div class="data-card-value" id="totalOverdueDays">0 Gün</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Durum Özeti Tablosu</h3>
                        <div class="detail-table-container" id="statusTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <!-- PARA BİRİMİ ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="currency-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">currency_exchange</i> Para Birimi Analizi</h3>
                        </div>

                        <div class="currency-distribution">
                            <div class="currency-chart">
                                <div class="chart-container medium-chart">
                                    <canvas id="currencyDistributionChart"></canvas>
                                </div>
                            </div>
                            <div class="currency-chart">
                                <div class="chart-container medium-chart">
                                    <canvas id="currencyStatusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">assessment</i> Para Birimi Karşılaştırması</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">TL İşlem Sayısı</div>
                                    <div class="data-card-value" id="tryTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">USD İşlem Sayısı</div>
                                    <div class="data-card-value" id="usdTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">EUR İşlem Sayısı</div>
                                    <div class="data-card-value" id="eurTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Sık Kullanılan</div>
                                    <div class="data-card-value" id="mostUsedCurrency">-</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Para Birimi Detay Tablosu</h3>
                        <div class="detail-table-container" id="currencyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <!-- TAHMİNLER SEKMESİ -->
                    <div class="stats-tab-content" id="predictions-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">analytics</i> Gelecek Tahminleri ve Analizler</h3>
                        </div>

                        <div class="payment-predictions">
                            <h3 class="prediction-title"><i class="material-icons">trending_up</i> Ödeme Tahminleri</h3>
                            <div class="prediction-items">
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 30 Gün</div>
                                    <div class="prediction-value" id="prediction30Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 90 Gün</div>
                                    <div class="prediction-value" id="prediction90Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 180 Gün</div>
                                    <div class="prediction-value" id="prediction180Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 365 Gün</div>
                                    <div class="prediction-value" id="prediction365Days">0 TL</div>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">show_chart</i> Tahsilat Trendi</h3>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="collectionTrendChart"></canvas>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">compare_arrows</i> Müvekkil Başına Ödeme</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">Müvekkil Başına Ortalama</div>
                                    <div class="data-card-value" id="avgPerClient">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Müvekkil</div>
                                    <div class="data-card-value" id="highestClientValue">0 TL</div>
                                    <div class="trend-indicator" id="highestClientName">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Düşük Müvekkil</div>
                                    <div class="data-card-value" id="lowestClientValue">0 TL</div>
                                    <div class="trend-indicator" id="lowestClientName">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Müvekkil Varyasyon</div>
                                    <div class="data-card-value" id="clientVariation">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .status-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-container label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Durum rozeti stilleri */
        .status-badge {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 20px;
            font-weight: 600;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .status-paid {
            background-color: rgba(76, 175, 80, 0.7) !important; /* Yeşilimsi arka plan */
            color: white !important;                             /* Beyaz metin */
            border: 1px solid rgb(34, 87, 36) !important;      /* Daha koyu tok yeşil çerçeve */
        }
        
        .status-unpaid {
            background-color: rgba(244, 67, 54, 0.7) !important; /* Kırmızımsı arka plan */
            color: white !important;                              /* Beyaz metin */
            border: 1px solid rgb(139, 23, 19) !important;       /* Daha koyu tok kırmızı çerçeve */
        }
        
        .status-badge.status-paid:hover {
            background-color: rgba(76, 175, 80, 0.9);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .status-badge.status-unpaid:hover {
            background-color: rgba(244, 67, 54, 0.9);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        /* Diğer stiller devam ediyor */
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .edit-btn i {
            color: #2196F3;
        }
        .delete-btn i {
            color: #000;
        }
        
        /* Modern Modal Stilleri */
        .modal {
            display: none;
            position: fixed;
            /* z-index: 1000; */ /* Bootstrap'in kendi z-index'ini kullanmasına izin ver */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: visible;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close {
            font-size: 24px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        /* Form Stilleri */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group.tc-group {
            flex: 0 0 200px;
        }
        
        .form-group.date-group {
            flex: 0 0 200px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        /* Tutar Input Grubu */
        .amount-group {
            flex: 2;
            min-width: 250px;
        }
        
        .amount-input {
            display: flex;
            gap: 10px;
        }
        
        .currency-select {
            width: 80px;
            flex-shrink: 0;
        }
        
        /* Toggle Switch Stilleri */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-top: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            display: none;
        }
        
        .toggle-switch label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ff4444;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch label:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + label {
            background-color: #4CAF50;
        }
        
        .toggle-switch input:checked + label:after {
            transform: translateX(30px);
        }
        
        .status-text {
            font-weight: 500;
            color: #666;
        }
        
        /* Buton Stilleri */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d5d5d5;
        }
        
        /* Textarea placeholder stili */
        textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        /* Textarea Stili */
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-header h2 {
            margin: 0;
        }

        .stats-btn {
            margin-left: auto; /* Butonu sağa yasla */
            background-color: #4CAF50; /* Yeşil arka plan */
            color: white; /* Beyaz ikon */
            border: none;
            border-radius: 50%; /* Tamamen yuvarlak */
            width: 40px; /* Genişlik */
            height: 40px; /* Yükseklik */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        .stats-btn:hover {
            background-color: #367c39; /* Hoverda koyu yeşil */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .action-buttons .view-btn {
            background-color: #17a2b8; /* Info mavisi */
            color: white;
        }
        .action-buttons .view-btn:hover {
            background-color: #138496;
        }

        #odemeDetayModalBody .detail-group {
            margin-bottom: 1rem;
        }
        #odemeDetayModalBody .detail-label {
            font-weight: bold;
            color: #555;
            margin-bottom: 0.3rem;
        }
        #odemeDetayModalBody .detail-value {
            padding: 0.5rem;
            background-color: #f8f9fa;
            border-radius: 0.25rem;
            border: 1px solid #e9ecef;
            word-wrap: break-word;
        }
        #odemeDetayModalBody .status-paid {
            color: #28a745;
            font-weight: bold;
        }
        #odemeDetayModalBody .status-unpaid {
            color: #dc3545;
            font-weight: bold;
        }

        .sort-icon {
            font-size: 16px;
            margin-left: 4px;
            vertical-align: middle;
        }

        th {
            cursor: pointer;
            user-select: none;
        }

        /* İstatistik Modalı Stilleri */
        .stats-modal-content {
            max-width: 90%;
            width: 1200px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .stats-modal-content .modal-header {
            flex-shrink: 0;
            background-color: #2c3e50;
            color: #fff;
            border-radius: 10px 10px 0 0;
            border-bottom: none;
            position: relative;
        }

        .stats-modal-content .modal-header h2 {
            color: #fff;
            font-weight: 600;
        }

        .stats-modal-content .modal-header .close {
            color: #fff;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .stats-modal-content .modal-header .close:hover {
            opacity: 1;
        }

        .stats-modal-content .modal-body {
            overflow-y: auto;
            padding: 20px;
            flex-grow: 1;
            background-color: #f8f9fa;
        }

        .stats-tabs {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .stats-tab-btn {
            padding: 10px 15px;
            font-size: 0.95rem;
            font-weight: 500;
            background: none;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #495057;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .stats-tab-btn:hover {
            background-color: #e9ecef;
        }

        .stats-tab-btn.active {
            background-color: #4361ee;
            color: white;
        }

        /* Dashboard Style Container */
        .stats-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 992px) {
            .stats-summary-grid {
                grid-template-columns: 1fr;
            }
        }

        .summary-main-cards, 
        .summary-detail-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
        }

        .summary-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 16px;
            display: flex;
            align-items: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .summary-card .card-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .summary-card .card-icon i {
            font-size: 28px;
            color: white;
        }

        .summary-card .card-content {
            flex-grow: 1;
        }

        .summary-card h3, .summary-card h4 {
            margin: 0 0 5px 0;
            font-weight: 600;
            color: #343a40;
        }

        .summary-card h3 {
            font-size: 0.9rem;
        }

        .summary-card h4 {
            font-size: 0.85rem;
        }

        .summary-card p {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: #212529;
        }

        .detail-card p {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 2px;
            color: #495057;
        }

        /* Kart özel stilleri */
        .summary-card.total-amount .card-icon { background-color: #4361ee; }
        .summary-card.total-paid .card-icon { background-color: #4caf50; }
        .summary-card.total-unpaid .card-icon { background-color: #f44336; }
        .summary-card.client-count .card-icon { background-color: #2196f3; }
        .summary-card.detail-card.expected-next-year .card-icon { background-color: #3f51b5; }
        .summary-card.detail-card.highest-payment .card-icon { background-color: #ff9800; }
        .summary-card.detail-card.overdue-payments .card-icon { background-color: #e91e63; }
        .summary-card.detail-card.avg-installments .card-icon { background-color: #009688; }
        .summary-card.detail-card.currency-breakdown-usd .card-icon { background-color: #9c27b0; }
        .summary-card.detail-card.currency-breakdown-eur .card-icon { background-color: #673ab7; }

        /* Tablolar için stil */
        .summary-extra-info {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .expected-by-year-section h4 {
            margin: 0 0 15px 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .detail-table-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            background-color: #fff;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .detail-table th, .detail-table td {
            padding: 10px 12px;
            text-align: left;
        }

        .detail-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #dee2e6;
        }

        .detail-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }

        .detail-table tbody tr:hover {
            background-color: #f1f3f5;
        }

        .detail-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Grafik stilleri */
        .chart-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .chart-container.large-chart {
            height: 45vh;
        }

        .chart-container.medium-chart {
            height: 40vh;
        }

        .chart-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chart-filter {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            background-color: #fff;
            font-size: 0.9rem;
            color: #495057;
        }

        /* Tab içerik stilleri */
        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .table-title {
            margin: 25px 0 15px 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-title i {
            color: #4361ee;
        }

        /* Yeni veri kartları için stil */
        .data-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .data-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .data-card-title {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .data-card-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #212529;
        }

        /* Trend göstergeleri için stil */
        .trend-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .trend-indicator i {
            font-size: 16px;
        }

        .trend-positive {
            color: #4caf50;
        }

        .trend-negative {
            color: #f44336;
        }

        .trend-neutral {
            color: #ff9800;
        }

        /* Yeni analiz kartları */
        .analysis-section {
            margin-top: 30px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-title i {
            color: #4361ee;
        }

        .analysis-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 5px 0 15px 0;
        }

        .monthly-distribution, .yearly-distribution {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .currency-distribution {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .currency-chart {
            flex: 1;
        }

        @media (max-width: 992px) {
            .monthly-distribution, .yearly-distribution {
                grid-template-columns: 1fr;
            }
            
            .currency-distribution {
                flex-direction: column;
            }
        }
        
        /* Scrollbar stil */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c9d6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8b1c1;
        }

        /* Durum kartları */
        .status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .status-card.paid::before {
            background-color: #4caf50;
        }

        .status-card.unpaid::before {
            background-color: #f44336;
        }

        .status-card.overdue::before {
            background-color: #e91e63;
        }

        .status-card-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .status-card-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #212529;
        }

        .status-card-percentage {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Ödeme tahminleri */
        .payment-predictions {
            background: linear-gradient(135deg, #4361ee 0%, #3f51b5 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .prediction-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prediction-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .prediction-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.2s, background-color 0.2s;
        }

        .prediction-item:hover {
            transform: translateY(-3px);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .prediction-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .prediction-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Göz ikonunun rengini ve görünürlüğünü belirginleştir */
        .action-buttons .view-btn {
            background-color: #17a2b8; /* Info mavisi - Zaten tanımlı olmalı, emin olalım */
            /* color: white; Bu satır ikona doğrudan uygulanacağı için kaldırılabilir veya kalabilir */
        }

        .action-buttons .view-btn .material-icons {
            color: white;   /* İkon rengi beyaz */
            opacity: 1;     /* İkonun tamamen görünür olmasını sağla */
        }

        /* odemeler.html - Göz ikonu için daha spesifik stil */
        body .content .table-container .data-table .action-buttons .view-btn {
            background-color: transparent !important; /* Arka planı kaldır */
            box-shadow: none !important;
            border: none !important;
            padding: 0.4rem !important;
        }

        body .content .table-container .data-table .action-buttons .view-btn .material-icons {
            color: #007bff !important; /* Mavi renk */
            opacity: 1 !important;
            font-size: 1.2rem !important;
        }

        body .content .table-container .data-table .action-buttons .view-btn:hover .material-icons {
            color: #0056b3 !important; /* Hover durumunda koyu mavi */
        }

        /* Ödeme Detay Modalını en üste taşı */
        #paymentDetailModal {
            z-index: 1060 !important; /* Diğer bootstrap modallarının ve backdrop'un üzerinde olmalı */
        }

        /* Yeni Ödeme Detayları Modal Stilleri - Basitleştirilmiş */
        #paymentDetailModal .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            padding: 1rem 1.5rem;
        }
        
        #paymentDetailModal .modal-title {
            color: #343a40;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        #paymentDetailModal .modal-body {
            padding: 1.5rem;
            background-color: #fff;
        }
        
        /* Detay tablo stilleri */
        .payment-detail-table {
            width: 100%;
            margin-bottom: 1rem;
        }
        
        .payment-detail-table th {
            width: 40%;
            text-align: left;
            padding: 0.5rem;
            font-weight: 600;
            color: #495057;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
        }
        
        .payment-detail-table td {
            width: 60%;
            text-align: left;
            padding: 0.5rem;
            color: #212529;
            border: 1px solid #dee2e6;
        }
        
        .payment-detail-section {
            margin-bottom: 1.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        .payment-detail-section h6 {
            margin: 0;
            padding: 0.75rem;
            background-color: #e9ecef;
            font-weight: 600;
            color: #343a40;
            border-bottom: 1px solid #dee2e6;
        }
        
        .status-paid {
            background-color: #d4edda;
            color: #155724;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }
        
        .status-unpaid {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 600;
        }

        /* Modal içeriğinin taşması durumunda düzgün görünmesi */
        #paymentDetailModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        #paymentDetailModal .modal-footer {
            position: sticky;
            bottom: 0;
            background-color: #fff;
            border-top: 1px solid #dee2e6;
            z-index: 1;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Diğer özel modalları başlangıçta gizle (önlem olarak)
            const editModalElement = document.getElementById('editModal');
            if (editModalElement) editModalElement.style.display = 'none';
            const statsModalElement = document.getElementById('statsModal');
            if (statsModalElement) statsModalElement.style.display = 'none';

            // LocalStorage'dan açılması gereken bir müvekkil ID'si var mı kontrol et
            const clientIdToOpen = localStorage.getItem('openClientDetailId');
            if (clientIdToOpen) {
                // ID'yi kullandıktan sonra localStorage'dan temizle
                localStorage.removeItem('openClientDetailId');
                
                // İlgili müvekkilin detay butonunu bul ve tıkla
                setTimeout(() => {
                    const viewBtn = document.querySelector(`.view-btn[data-payment-id="${clientIdToOpen}"]`);
                    if (viewBtn) {
                        viewBtn.click();
                    }
                }, 500);
            }

            // Ödeme formunu dinle
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.onsubmit = function(event) {
                    event.preventDefault();
                    savePayment(event);
                };
            }
            
            // Düzenleme formunu dinle
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.onsubmit = function(event) {
                    event.preventDefault();
                    const clientIdToUpdate = document.getElementById('editClientId').value;
                    window.updateClient(clientIdToUpdate);
                };
            }
            
            // Modal kapatma butonları için event listener'lar ekle
            if (editModalElement) { 
                const closeBtn = editModalElement.querySelector('.close');
                const closeModalBtn = editModalElement.querySelector('.btn-secondary');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        editModalElement.style.display = 'none';
                    });
                }
                
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', function() {
                        editModalElement.style.display = 'none';
                    });
                }
                
                // Modalın dışına tıklandığında kapanması için
                window.addEventListener('click', function(event) {
                    if (event.target === editModalElement) {
                        editModalElement.style.display = 'none';
                    }
                });

                // Düzenleme Modalı içindeki Ödeme Durumu geçiş anahtarını dinle
                const editStatusCheckbox = editModalElement.querySelector('#editStatus');
                const statusTextSpan = editModalElement.querySelector('.status-text'); // Daha spesifik seçici
                
                if (editStatusCheckbox && statusTextSpan) {
                    editStatusCheckbox.addEventListener('change', function() {
                        statusTextSpan.textContent = this.checked ? 'Ödendi' : 'Ödenmedi';
                    });
                }
            }
            
            // İstatistik butonuna tıklandığında modalı aç
            const statsBtn = document.getElementById('statsButton');
            if (statsBtn) {
                statsBtn.addEventListener('click', function() {
                    const statsModal = document.getElementById('statsModal');
                    if (statsModal) {
                        statsModal.style.display = 'block';
                        generateStats();
                    }
                });
            }

            // Modal kapatma butonları
            const statsModal = document.getElementById('statsModal');
            if (statsModal) {
                const closeStatsModalBtn = document.getElementById('closeStatsModal');
                if (closeStatsModalBtn) {
                    closeStatsModalBtn.addEventListener('click', function() {
                        statsModal.style.display = 'none';
                    });
                }
                
                // Modalın dışına tıklandığında kapanması için
                window.addEventListener('click', function(event) {
                    if (event.target === statsModal) {
                        statsModal.style.display = 'none';
                    }
                });
            }

            // Tab butonları için event listener'lar
            document.querySelectorAll('.stats-tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Aktif tab butonunu değiştir
                    document.querySelectorAll('.stats-tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // İlgili içeriği göster
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.stats-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + '-tab').classList.add('active');
                    
                    // İlgili grafiği ve içeriği güncelle
                    updateActiveTab(tabName);
                });
            });

            // TABLO SIRALAMA İŞLEVSELLİĞİ
            const getCellValue = (row, headerId) => {
                let cellIndex;
                switch (headerId) {
                    case 'sort-name': cellIndex = 0; break;
                    case 'sort-surname': cellIndex = 1; break;
                    case 'sort-tc': cellIndex = 2; break;
                    case 'sort-amount': cellIndex = 3; break;
                    case 'sort-installments': cellIndex = 4; break;
                    case 'sort-registration-date': cellIndex = 5; break;
                    case 'sort-due-date': cellIndex = 6; break;
                    case 'sort-status': cellIndex = 7; break;
                    default: return '';
                }
                const cell = row.cells[cellIndex];
                return cell ? cell.innerText || cell.textContent : '';
            };

            const parseValue = (value, headerId) => {
                if (headerId === 'sort-amount') {
                    // "10000.0 TL" formatından sayıyı ve para birimini ayır
                    const parts = value.split(' ');
                    const amount = parseFloat(parts[0].replace(/\./g, '').replace(',', '.')); // 10.000,50 -> 10000.50
                    return isNaN(amount) ? 0 : amount; 
                }
                if (headerId === 'sort-installments' || headerId === 'sort-tc') {
                    return parseInt(value, 10) || 0;
                }
                if (headerId === 'sort-registration-date' || headerId === 'sort-due-date') {
                    if (value === '-' || !value) return null; // veya çok eski bir tarih
                    const parts = value.split('.'); // GG.AA.YYYY
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return value.toLowerCase(); // Metinler için küçük harfe çevir
            };

            document.querySelectorAll('.data-table th[id^="sort-"]').forEach(headerCell => {
                let currentSortOrder = 'asc'; // Varsayılan sıralama yönü

                headerCell.addEventListener('click', () => {
                    const tableElement = headerCell.closest('table');
                    const tbody = tableElement.querySelector('tbody');
                    const headerId = headerCell.id;
                    const sortIcon = headerCell.querySelector('.sort-icon');

                    // Diğer başlıklardaki sıralama ikonlarını sıfırla
                    document.querySelectorAll('.data-table th[id^="sort-"]').forEach(th => {
                        if (th !== headerCell) {
                            const icon = th.querySelector('.sort-icon');
                            if (icon) icon.textContent = 'unfold_more';
                        }
                    });

                    Array.from(tbody.querySelectorAll('tr'))
                        .sort((rowA, rowB) => {
                            const valA = parseValue(getCellValue(rowA, headerId), headerId);
                            const valB = parseValue(getCellValue(rowB, headerId), headerId);

                            if (valA === null && valB === null) return 0;
                            if (valA === null) return currentSortOrder === 'asc' ? 1 : -1; // Null'ları sona at
                            if (valB === null) return currentSortOrder === 'asc' ? -1 : 1; // Null'ları sona at


                            if (typeof valA === 'number' && typeof valB === 'number') {
                                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
                            } else if (valA instanceof Date && valB instanceof Date) {
                                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
                            } else {
                                // String karşılaştırması
                                if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                                if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                                return 0;
                            }
                        })
                        .forEach(sortedRow => tbody.appendChild(sortedRow));

                    // Sıralama ikonunu ve yönünü güncelle
                    if (currentSortOrder === 'asc') {
                        currentSortOrder = 'desc';
                        if (sortIcon) sortIcon.textContent = 'expand_more'; // Aşağı ok
                    } else {
                        currentSortOrder = 'asc';
                        if (sortIcon) sortIcon.textContent = 'expand_less'; // Yukarı ok
                    }
                });
            });

            // Ödeme Detay Modal'ı açıldığında içeriği yükle
            // const odemeDetayModalElement = document.getElementById('odemeDetayModal'); // ESKİ EVENT LISTENER SİLİNDİ
            // if (odemeDetayModalElement) {
            //     odemeDetayModalElement.addEventListener('shown.bs.modal', async function (event) {
            //         // Tetikleyici butonu al (event.relatedTarget)
            //         const button = event.relatedTarget;
            //         if (button) {
            //             const paymentId = button.getAttribute('data-payment-id');
            //             await loadPaymentDetails(paymentId); 
            //         }
            //     });
            // }
        });

        function deletePayment(button) {
            if (confirm('Bu ödemeyi silmek istediğinizden emin misiniz?')) {
                const row = button.closest('tr');
                const clientId = row.getAttribute('data-client-id');
                
                fetch(`/delete_client/${clientId}`, {
                    method: 'DELETE',  
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Ödeme başarıyla silindi!');
                          row.remove();
                      } else {
                          alert('Silme işlemi başarısız: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
                      }
                  })
                  .catch(error => {
                      alert('Silme işlemi sırasında bir hata oluştu: ' + error.message);
                  });
            }
        }

        // Yeni basitleştirilmiş ödeme kaydetme fonksiyonu
        function savePayment(event) {
            event.preventDefault();
            
            // Tarih alanlarının dolu olup olmadığını kontrol et
            const registrationDate = document.querySelector('[name="registration_date"]').value;
            const dueDate = document.querySelector('[name="due_date"]').value;
            
            if (!registrationDate || !dueDate) {
                alert('Lütfen tarih alanlarını doldurun.');
                return;
            }
            
            // Form verilerini al
            const formElement = document.getElementById('paymentForm');
            const amountInput = document.getElementById('amount');
            let amountValue = amountInput.value.trim();
            
            // Basit sayısal kontrol
            if (amountValue === '' || isNaN(parseFloat(amountValue))) {
                alert('Lütfen geçerli bir sayı girin.');
                return;
            }
            
            // Form verisini oluştur
            const formData = new FormData(formElement);
            
            // Form verisini gönder - değerleri olduğu gibi bırakıyoruz
            fetch('/odemeler', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Başarılı olduysa sayfayı yenile
                    window.location.reload();
                } else {
                    // Hata mesajını göster
                    alert('Ödeme kaydedilemedi: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ödeme kaydedilemedi: ' + error);
            });
        }

        // Önemli: Düzenleme modalını açma fonksiyonu - formatlamayı yeniden düzenleme
        function openEditModal(button) {
            const modal = document.getElementById('editModal');
            if (!modal) {
                console.error("Düzenleme modalı bulunamadı!");
                return;
            }

            const row = button.closest('tr');
            const clientId = row.getAttribute('data-client-id');
            
            // Form alanlarını doldur
            document.getElementById('editClientId').value = clientId;
            document.getElementById('editName').value = row.querySelector('td:nth-child(1)').innerText;
            document.getElementById('editSurname').value = row.querySelector('td:nth-child(2)').innerText;
            document.getElementById('editTc').value = row.querySelector('td:nth-child(3)').innerText;
            
            // Para miktarı ve para birimini ayır
            const amountCellText = row.querySelector('td:nth-child(4)').innerText;
            const parts = amountCellText.split(' ');
            
            // Sadece ilk kısmı tutar olarak al (boşluğa kadar olan kısım)
            const amount = parts[0];
            document.getElementById('editAmount').value = amount;
            
            // Son kısmı para birimi olarak al (TRY, USD, EUR gibi)
            if (parts.length > 1) {
                document.getElementById('editCurrency').value = parts[parts.length - 1];
            }
            
            document.getElementById('editInstallments').value = row.querySelector('td:nth-child(5)').innerText;
            
            // Tarihleri oku ve YYYY-MM-DD formatına çevir
            const registrationDate = row.querySelector('td:nth-child(6)').innerText;
            const dueDate = row.querySelector('td:nth-child(7)').innerText;
            
            // Tarihleri formatla (DD.MM.YYYY -> YYYY-MM-DD)
            if (registrationDate && registrationDate !== '-') {
                const [day, month, year] = registrationDate.split('.');
                document.getElementById('editRegistrationDate').value = `${year}-${month}-${day}`;
            }
            
            if (dueDate && dueDate !== '-') {
                const [day, month, year] = dueDate.split('.');
                document.getElementById('editDueDate').value = `${year}-${month}-${day}`;
            }
            
            const isPaid = row.querySelector('td:nth-child(8)').textContent.trim() === 'Ödendi';
            document.getElementById('editStatus').checked = isPaid;
            document.querySelector('.status-text').textContent = isPaid ? 'Ödendi' : 'Ödenmedi';

            // Açıklama alanını doldur (eğer varsa)
            const description = row.getAttribute('data-description');
            const descriptionArea = document.getElementById('editDescription');
            descriptionArea.value = description === 'None' ? '' : (description || '');
            
            modal.style.display = 'block';
        }
        
        // Global fonksiyonları tanımla
        window.savePayment = savePayment;
        window.updateClient = updateClient;
        window.openEditModal = openEditModal;
        window.deletePayment = deletePayment;

        // Müşteri verilerini topla ve özet istatistikleri oluştur
        function generateStats() {
            console.log("İstatistikler hesaplanıyor...");
            const clients = Array.from(document.querySelectorAll('.data-table tbody tr'));
            
            // Temel değişkenleri başlat
            const currencyTotals = {
                'TL': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 },
                'USD': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 },
                'EUR': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 }
            };

            const monthlyData = {};
            const yearlyData = {};
            const expectedPaymentsByYear = {};
            const clientTotals = {}; // Müvekkil bazlı toplamlar
            
            let highestPayment = { amount: 0, clientName: '-', date: '-', currency: 'TL' };
            let mostOverdue = { days: 0, clientName: '-', amount: 0, currency: 'TL', dueDate: '-' };
            let totalOverdueAmountTL = 0; // *** YENİ: Vadesi geçmiş TL tutarı için ***
            
            // İstatistik sayaçları
            let paidCount = 0;
            let unpaidCount = 0;
            let overdueCount = 0;
            let totalInstallments = 0;
            let paidInstallments = 0;
            let totalOverdueDays = 0;
            
            // Tarih hesaplamaları için
            const years = new Set();
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const nextYear = currentYear + 1;
            
            // Önümüzdeki dönemler için tahminler
            const predictions = {
                days30: 0,
                days90: 0,
                days180: 0,
                days365: 0
            };
            
            // Son 5 yılı ekle
            for (let i = 0; i < 5; i++) {
                years.add(currentYear - i);
            }
            years.add(nextYear);
            
            // Her bir müvekkil için verileri topla
            clients.forEach(client => {
                const clientId = client.getAttribute('data-client-id');
                const clientName = client.querySelector('td:nth-child(1)').textContent.trim() + ' ' + 
                                client.querySelector('td:nth-child(2)').textContent.trim();
                const tcNo = client.querySelector('td:nth-child(3)').textContent.trim();
                
                // Para bilgilerini al ve parse et
                const amountText = client.querySelector('td:nth-child(4)').textContent.trim();
                const parts = amountText.split(' ');
                const amount = parseFloat(parts[0]); // Önceki hatalı parse düzeltildi
                const currency = parts[1] || 'TL'; // Para birimini al, yoksa TL varsay

                console.log(`[generateStats] İşlenen Kayıt: Ad: ${clientName}, Tutar Yazısı: '${amountText}', Parse Edilen Tutar: ${amount}, Para Birimi: ${currency}`); // YENİ LOG

                // currencyTotals içinde para birimi yoksa, tüm alanlarla birlikte başlat
                if (!currencyTotals[currency]) {
                    currencyTotals[currency] = { 
                        total: 0, 
                        paid: 0, 
                        unpaid: 0, 
                        expectedNextYear: 0, // Bu önemli
                        transactions: 0 
                    };
                }

                // Taksit bilgisini al
                const installments = parseInt(client.querySelector('td:nth-child(5)').textContent.trim());
                totalInstallments += installments;
                
                // Ödeme durumu
                const statusText = client.querySelector('td:nth-child(8)').textContent.trim();
                const isPaid = statusText.includes('Ödendi');
                
                // Tarih bilgilerini al
                const registrationDateText = client.querySelector('td:nth-child(6)').textContent.trim();
                const dueDateText = client.querySelector('td:nth-child(7)').textContent.trim();
                
                let registrationDate = null;
                let dueDate = null;
                
                if (registrationDateText !== '-') {
                    const [day, month, year] = registrationDateText.split('.').map(Number);
                    registrationDate = new Date(year, month - 1, day);
                }
                
                if (dueDateText !== '-') {
                    const [day, month, year] = dueDateText.split('.').map(Number);
                    dueDate = new Date(year, month - 1, day);
                }
                
                // Müvekkil başına toplam hesapla
                if (!clientTotals[clientId]) {
                    clientTotals[clientId] = {
                        name: clientName,
                        tcNo: tcNo,
                        totalAmount: 0,
                        currency: currency
                    };
                }
                clientTotals[clientId].totalAmount += amount;
                
                // Geçerli para birimi yoksa oluştur
                if (!currencyTotals[currency]) {
                    currencyTotals[currency] = { 
                        total: 0, paid: 0, unpaid: 0, 
                        expectedNextYear: 0, transactions: 0 
                    };
                }
                
                // İşlem sayısını artır
                currencyTotals[currency].transactions++;
                
                // Para birimi bazında istatistikleri güncelle
                if (!isNaN(amount)) {
                    currencyTotals[currency].total += amount;
                    
                    if (isPaid) {
                        currencyTotals[currency].paid += amount;
                        paidCount++;
                        paidInstallments += installments;
                    } else {
                        currencyTotals[currency].unpaid += amount;
                        unpaidCount++;
                        
                        // Vadesi geçmiş ödemeler
                        if (dueDate && dueDate < currentDate) {
                            overdueCount++;
                            
                            // Gecikme süresi (gün)
                            const overdueDays = Math.floor((currentDate - dueDate) / (1000 * 60 * 60 * 24));
                            totalOverdueDays += overdueDays;
                            
                            // En uzun vadesi geçmiş ödemeyi bul
                            if (overdueDays > mostOverdue.days) {
                                mostOverdue = {
                                    days: overdueDays,
                                    clientName: clientName,
                                    amount: amount,
                                    currency: currency,
                                    dueDate: dueDateText
                                };
                            }
                            
                            // *** YENİ: Vadesi geçmiş TL tutarını topla ***
                            if (currency === 'TL') {
                                totalOverdueAmountTL += amount;
                            }
                            // *** BİTTİ: Vadesi geçmiş TL tutarını topla ***
                        }
                        
                        // Gelecek tahminleri için - vadesi yaklaşan ödemeler
                        if (dueDate && dueDate > currentDate) {
                            const daysUntilDue = Math.floor((dueDate - currentDate) / (1000 * 60 * 60 * 24));
                            
                            if (daysUntilDue <= 30) predictions.days30 += amount;
                            if (daysUntilDue <= 90) predictions.days90 += amount;
                            if (daysUntilDue <= 180) predictions.days180 += amount;
                            if (daysUntilDue <= 365) predictions.days365 += amount;
                        }
                        
                        // Yıla göre beklenen ödemeler
                        if (dueDate) {
                            const dueYear = dueDate.getFullYear();
                            if (!expectedPaymentsByYear[dueYear]) {
                                expectedPaymentsByYear[dueYear] = { 
                                    'TL': 0, 'USD': 0, 'EUR': 0 
                                };
                            }
                            expectedPaymentsByYear[dueYear][currency] = 
                                (expectedPaymentsByYear[dueYear][currency] || 0) + amount;
                            
                            if (dueYear === nextYear) {
                                currencyTotals[currency].expectedNextYear += amount;
                            }
                        }
                    }
                    
                    // En yüksek ödemeyi bul
                    let comparisonAmount = amount;
                    if (currency === 'USD') comparisonAmount *= 30; // Örnek kur
                    if (currency === 'EUR') comparisonAmount *= 32; // Örnek kur
                    
                    if (comparisonAmount > highestPayment.amount) {
                        highestPayment = {
                            amount: amount,
                            clientName: clientName,
                            date: dueDate ? dueDateText : registrationDateText,
                            currency: currency,
                            displayAmount: comparisonAmount
                        };
                    }
                }
                
                // Aylık ve yıllık verileri güncelle
                if (dueDate) { // registrationDate yerine dueDate kullanılıyor
                    const year = dueDate.getFullYear(); // dueDate kullanılıyor
                    const month = dueDate.getMonth() + 1; // dueDate kullanılıyor
                    years.add(year);
                    
                    // Yıllık veriler
                    if (!yearlyData[year]) {
                        yearlyData[year] = {
                            amount: 0, paid: 0, unpaid: 0,
                            currencies: { 
                                'TL': { total: 0, paid: 0, unpaid: 0 }, 
                                'USD': { total: 0, paid: 0, unpaid: 0 }, 
                                'EUR': { total: 0, paid: 0, unpaid: 0 } 
                            }
                        };
                    }
                    
                    if (!isNaN(amount)) {
                        yearlyData[year].currencies[currency].total += amount;
                        
                        if (isPaid) {
                            yearlyData[year].currencies[currency].paid += amount;
                        } else {
                            yearlyData[year].currencies[currency].unpaid += amount;
                        }
                        
                        // Yıllık genel toplamlar için sadece TL'yi değil,
                        // seçilen para birimine göre veya "ALL" ise tümünü çevirerek hesapla.
                        // Bu kısım createYearlyChart ve updateYearlyCards içinde daha doğru yönetilecek.
                        // Şimdilik TL bazlı bırakıyorum, ancak bu genel mantık ileride değişebilir.
                        if (currency === 'TL') { // Bu koşul daha sonra kaldırılabilir/genelleştirilebilir.
                            yearlyData[year].amount += amount;
                            if (isPaid) yearlyData[year].paid += amount;
                            else yearlyData[year].unpaid += amount;
                        }
                    }
                    
                    // Aylık veriler
                    const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
                    if (!monthlyData[yearMonth]) {
                        monthlyData[yearMonth] = {
                            amount: 0, paid: 0, unpaid: 0,
                            currencies: { 
                                'TL': { total: 0, paid: 0, unpaid: 0 }, 
                                'USD': { total: 0, paid: 0, unpaid: 0 }, 
                                'EUR': { total: 0, paid: 0, unpaid: 0 } 
                            }
                        };
                    }
                    
                    if (!isNaN(amount)) {
                        monthlyData[yearMonth].currencies[currency].total += amount;
                        console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].total güncellendi: ${monthlyData[yearMonth].currencies[currency].total}`); 
                        
                        if (isPaid) {
                            monthlyData[yearMonth].currencies[currency].paid += amount;
                            console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].paid güncellendi: ${monthlyData[yearMonth].currencies[currency].paid}`); 
                        } else {
                            monthlyData[yearMonth].currencies[currency].unpaid += amount;
                            console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].unpaid güncellendi: ${monthlyData[yearMonth].currencies[currency].unpaid}`); 
                        }
                        
                        // Aylık genel toplamlar için de benzer şekilde, TL bazlı bırakıyorum.
                        // Bu da createMonthlyChart ve updateMonthlyCards içinde daha doğru yönetilecek.
                         if (currency === 'TL') { // Bu koşul daha sonra kaldırılabilir/genelleştirilebilir.
                            monthlyData[yearMonth].amount += amount;
                            if (isPaid) monthlyData[yearMonth].paid += amount;
                            else monthlyData[yearMonth].unpaid += amount;
                        }
                    }
                }
            });
            
            // Müvekkil başına ortalama ve varyasyon hesapla
            let highestClient = { id: null, amount: 0, name: '-' };
            let lowestClient = { id: null, amount: Infinity, name: '-' };
            let totalClientAmount = 0;
            
            // Müvekkil istatistiklerini hesapla
            Object.keys(clientTotals).forEach(clientId => {
                const client = clientTotals[clientId];
                totalClientAmount += client.totalAmount;
                
                if (client.totalAmount > highestClient.amount) {
                    highestClient = { 
                        id: clientId, 
                        amount: client.totalAmount, 
                        name: client.name,
                        currency: client.currency
                    };
                }
                
                if (client.totalAmount < lowestClient.amount && client.totalAmount > 0) {
                    lowestClient = { 
                        id: clientId, 
                        amount: client.totalAmount, 
                        name: client.name,
                        currency: client.currency
                    };
                }
            });
            
            const avgPerClient = clients.length > 0 ? totalClientAmount / clients.length : 0;
            const clientVariation = avgPerClient > 0 ? 
                Math.abs((highestClient.amount - lowestClient.amount) / avgPerClient) * 100 : 0;
            
            // Analiz değerlerini hesapla
            const paidPercentage = (paidCount / (paidCount + unpaidCount)) * 100 || 0;
            const unpaidPercentage = 100 - paidPercentage;
            const overduePercentage = unpaidCount > 0 ? (overdueCount / unpaidCount) * 100 : 0;
            
            const avgDueTime = overdueCount > 0 ? totalOverdueDays / overdueCount : 0;
            
            // HTML elementlerine verileri aktar
            document.getElementById('totalAmount').textContent = `${formatCurrency(currencyTotals.TL.total)} TL`;
            document.getElementById('totalPaid').textContent = `${formatCurrency(currencyTotals.TL.paid)} TL`;
            document.getElementById('totalUnpaid').textContent = `${formatCurrency(currencyTotals.TL.unpaid)} TL`;
            document.getElementById('clientCount').textContent = clients.length;
            
            // Ekstra detay alanları
            document.getElementById('expectedNextYear').textContent = `${formatCurrency(currencyTotals.TL.expectedNextYear)} TL`;
            document.getElementById('highestPaymentInfo').textContent = `${highestPayment.clientName} - ${formatCurrency(highestPayment.amount)} ${highestPayment.currency} (${highestPayment.date})`;
            document.getElementById('overdueCount').textContent = overdueCount;
            
            const avgInstallments = clients.length > 0 ? (totalInstallments / clients.length).toFixed(1) : 0;
            const avgPaidInstallments = paidCount > 0 ? (paidInstallments / paidCount).toFixed(1) : 0;
            document.getElementById('avgInstallmentInfo').textContent = `${avgInstallments} / ${avgPaidInstallments}`;
            
            // Para birimi özetleri
            document.getElementById('totalAmountUSD').textContent = `Toplam: ${formatCurrency(currencyTotals.USD.total)} USD`;
            document.getElementById('totalPaidUSD').textContent = `Ödenen: ${formatCurrency(currencyTotals.USD.paid)} USD`;
            document.getElementById('totalUnpaidUSD').textContent = `Beklenen: ${formatCurrency(currencyTotals.USD.unpaid)} USD`;
            
            document.getElementById('totalAmountEUR').textContent = `Toplam: ${formatCurrency(currencyTotals.EUR.total)} EUR`;
            document.getElementById('totalPaidEUR').textContent = `Ödenen: ${formatCurrency(currencyTotals.EUR.paid)} EUR`;
            document.getElementById('totalUnpaidEUR').textContent = `Beklenen: ${formatCurrency(currencyTotals.EUR.unpaid)} EUR`;
            
            // Durum kartları
            document.getElementById('paidPercentage').textContent = `${Math.round(paidPercentage)}%`;
            document.getElementById('unpaidPercentage').textContent = `${Math.round(unpaidPercentage)}%`;
            document.getElementById('overduePercentage').textContent = `${Math.round(overduePercentage)}%`;
            
            document.getElementById('paidClients').textContent = `${paidCount} Müvekkil`;
            document.getElementById('unpaidClients').textContent = `${unpaidCount} Müvekkil`;
            // *** DÜZELTİLDİ: overdueAmount artık hesaplanan toplamı kullanıyor ***
            document.getElementById('overdueAmount').textContent = `${typeof formatCurrency === 'function' ? formatCurrency(totalOverdueAmountTL) : totalOverdueAmountTL} TL`;
            
            // Ödeme durumu istatistikleri
            document.getElementById('paidTransCount').textContent = paidCount;
            document.getElementById('unpaidTransCount').textContent = unpaidCount;
            document.getElementById('overdueTransCount').textContent = overdueCount;
            
            document.getElementById('paidTransPercentage').textContent = `${Math.round(paidPercentage)}%`;
            document.getElementById('unpaidTransPercentage').textContent = `${Math.round(unpaidPercentage)}%`;
            document.getElementById('overdueTransPercentage').textContent = `${Math.round(overduePercentage)}%`;
            
            // Vade durumu istatistikleri
            document.getElementById('avgDueTime').textContent = `${Math.round(avgDueTime)} Gün`;
            document.getElementById('totalOverdueDays').textContent = `${totalOverdueDays} Gün`;
            
            if (mostOverdue.days > 0) {
                document.getElementById('mostOverdueInfo').textContent = 
                    `${mostOverdue.clientName} - ${mostOverdue.days} gün`;
            }
            
            // Para birimi analizi
            document.getElementById('tryTransactionCount').textContent = currencyTotals.TL.transactions;
            document.getElementById('usdTransactionCount').textContent = currencyTotals.USD.transactions;
            document.getElementById('eurTransactionCount').textContent = currencyTotals.EUR.transactions;
            
            // En çok kullanılan para birimi
            const mostUsedCurrency = Object.keys(currencyTotals).reduce((a, b) => 
                currencyTotals[a].transactions > currencyTotals[b].transactions ? a : b);
            document.getElementById('mostUsedCurrency').textContent = mostUsedCurrency;
            
            // Tahminler
            document.getElementById('prediction30Days').textContent = `${formatCurrency(predictions.days30)} TL`;
            document.getElementById('prediction90Days').textContent = `${formatCurrency(predictions.days90)} TL`;
            document.getElementById('prediction180Days').textContent = `${formatCurrency(predictions.days180)} TL`;
            document.getElementById('prediction365Days').textContent = `${formatCurrency(predictions.days365)} TL`;
            
            // Müvekkil analizi
            document.getElementById('avgPerClient').textContent = `${formatCurrency(avgPerClient)} TL`;
            document.getElementById('clientVariation').textContent = `${Math.round(clientVariation)}%`;
            
            if (highestClient.id) {
                document.getElementById('highestClientValue').textContent = 
                    `${formatCurrency(highestClient.amount)} ${highestClient.currency}`;
                document.getElementById('highestClientName').textContent = highestClient.name;
            }
            
            if (lowestClient.id && lowestClient.amount < Infinity) {
                document.getElementById('lowestClientValue').textContent = 
                    `${formatCurrency(lowestClient.amount)} ${lowestClient.currency}`;
                document.getElementById('lowestClientName').textContent = lowestClient.name;
            }
            
            // Yıl filtresi güncelle
            const yearFilter = document.getElementById('monthlyYearFilter');
            const existingSelectedYear = yearFilter.value;
            yearFilter.innerHTML = '';
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            if (sortedYears.includes(parseInt(existingSelectedYear))) {
                yearFilter.value = existingSelectedYear;
            }
            
            // Filtre olaylarını güncelle
            const listenerUpdate = (elementId, handler) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.removeEventListener('change', handler);
                    element.addEventListener('change', handler);
                }
            };
            
            listenerUpdate('monthlyYearFilter', createMonthlyChart);
            listenerUpdate('monthlyCurrencyFilter', createMonthlyChart);
            listenerUpdate('yearlyCurrencyFilter', createYearlyChart);
            listenerUpdate('yearlyChartType', createYearlyChart);
            
            // Verileri global olarak tut
            window.statsData = {
                currencyTotals,
                monthlyData,
                yearlyData,
                expectedPaymentsByYear,
                paidCount,
                unpaidCount,
                overdueCount,
                years: sortedYears,
                highestPayment,
                mostOverdue,
                totalInstallments,
                paidInstallments,
                predictions,
                clientTotals,
                highestClient,
                lowestClient,
                avgPerClient,
                clientVariation,
                totalOverdueAmountTL, // *** YENİ: Hesaplanan değeri ekle ***
                clients: clients.length
            };
            
            // Aktif sekmeye göre ilgili grafik ve tabloyu oluştur
            // const activeTab = document.querySelector('.stats-tab-btn.active').getAttribute('data-tab'); // ESKİ SATIR
            // updateActiveTab(activeTab); // ESKİ SATIR

            // Doğrudan özet sekmesi fonksiyonlarını çağır
            populateSummaryTab(window.statsData);
            // createExpectedPaymentsByYearChart(); // ÇAĞRI BURADAN KALDIRILDI
            createSummaryChart(window.statsData);
            
            console.log("İstatistikler hesaplandı:", window.statsData);
        }
        
        // Aktif sekmeye göre ilgili içeriği güncelle
        function updateActiveTab(tabName) {
            console.log("[updateActiveTab] Aktif sekme:", tabName, "Veri:", window.statsData);
            if (!window.statsData) {
                console.warn("Genel istatistik verisi (window.statsData) bulunamadı. Sekme güncellemeleri sınırlı olabilir.");
            }

            const clearAndShowMessage = (chartInstanceOrInstances, canvasIdOrIds, tableContainerId, message) => {
                const chartInstances = Array.isArray(chartInstanceOrInstances) ? chartInstanceOrInstances : [chartInstanceOrInstances];
                const canvasIds = Array.isArray(canvasIdOrIds) ? canvasIdOrIds : [canvasIdOrIds];

                canvasIds.forEach((canvasId, index) => {
                    const canvas = document.getElementById(canvasId);
                    const chartInstance = chartInstances[index];
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (chartInstance && typeof chartInstance.destroy === 'function') {
                            chartInstance.destroy();
                             // Global referansları da null yapalım
                            if (canvasId === 'monthlyChart') window.monthlyChart = null;
                            else if (canvasId === 'yearlyChart') window.yearlyChart = null;
                            else if (canvasId === 'statusChart') window.statusChart = null;
                            else if (canvasId === 'expectedPaymentsByYearChart') expectedPaymentsChartInstance = null;
                            else if (canvasId === 'currencyDistributionChart') currencyDistributionChartInstance = null;
                            else if (canvasId === 'currencyStatusChart') currencyStatusChartInstance = null;
                            else if (canvasId === 'collectionTrendChart') collectionTrendChartInstance = null;
                        }
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.textAlign = 'center';
                        ctx.font = '14px Segoe UI'; // Mesaj için font ayarı
                        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
                    }
                });
                
                if (tableContainerId) {
                    const tableContainer = document.getElementById(tableContainerId);
                    if (tableContainer) {
                        tableContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${message}</p>`;
                    }
                }
            };
            
            const resetCards = (cardIdsValues) => { 
                Object.keys(cardIdsValues).forEach(cardId => {
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.textContent = cardIdsValues[cardId];
                    }
                });
            };
            
            switch(tabName) {
                case 'summary':
                    populateSummaryTab(window.statsData); 
                    createSummaryChart(window.statsData); 
                    createExpectedPaymentsByYearChart(); // ÇAĞRI BURAYA EKLENDİ
                    break;
                case 'monthly':
                    // Aylık analiz için gerekli verileri doğrudan geçir
                    if (window.statsData) {
                        const yearFilter = document.getElementById('monthlyYearFilter');
                        const currencyFilter = document.getElementById('monthlyCurrencyFilter');
                        
                        // Yıl ve para birimi filtrelerinin değerlerini al
                        const yearVal = yearFilter ? yearFilter.value : undefined;
                        const currencyVal = currencyFilter ? currencyFilter.value : undefined;

                        // Değerlerin tanımsız olmadığından emin ol
                        if (typeof yearVal !== 'undefined' && typeof currencyVal !== 'undefined') {
                            createMonthlyChart(window.statsData.monthlyData, yearVal, currencyVal);
                            populateMonthlyTable(window.statsData.monthlyData, yearVal);
                            updateMonthlyCards(window.statsData.monthlyData, yearVal, currencyVal);
                        } else {
                            console.warn("[updateActiveTab - monthly] Yıl veya para birimi filtresi tanımsız.");
                        }
                    }
                    break;
                case 'yearly':
                    createYearlyChart();
                    populateYearlyTable();
                    updateYearlyCards();
                    break;
                case 'status':
                    createStatusChart();
                    populateStatusTable();
                    break;
                case 'currency':
                    if (window.statsData && window.statsData.currencyTotals && Object.keys(window.statsData.currencyTotals).length > 0) {
                        createCurrencyCharts();
                        populateCurrencyTable();
                    } else {
                        clearAndShowMessage(
                            [currencyDistributionChartInstance, currencyStatusChartInstance],
                            ['currencyDistributionChart', 'currencyStatusChart'], 
                            'currencyTableContainer', 
                            'Para birimi verisi bulunamadı.'
                        );
                         resetCards({
                            'tryTransactionCount': '0', 'usdTransactionCount': '0', 'eurTransactionCount': '0', 'mostUsedCurrency': '-'
                         });
                    }
                    break;
                case 'predictions':
                    createCollectionTrendChart();
                    break;
            }
        }

        // Para birimi biçimlendirme fonksiyonu
        function formatCurrency(amount) {
            amount = parseFloat(amount);
            if (isNaN(amount)) { 
                amount = 0;
            }
            
            // Sayıyı iki ondalık basamağa yuvarla ve string'e çevir
            let parts = amount.toFixed(2).split('.');
            let wholePart = parts[0];
            let decimalPart = parts[1] || '00'; // Ondalık kısım yoksa '00' ekle
            
            // Binlik ayırıcı olarak nokta ekle
            wholePart = wholePart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Ondalık ayırıcı olarak virgül kullan
            return wholePart + ',' + decimalPart;
        }

        // Özet grafiği oluştur
        function createSummaryChart(data) {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            if (window.summaryChart && typeof window.summaryChart.destroy === 'function') {
                window.summaryChart.destroy();
            }
            
            if (!data || !data.currencyTotals || !data.currencyTotals.TL) { // Daha detaylı kontrol
                console.error("Özet grafik için istatistik verileri (currencyTotals.TL) bulunamadı", data);
                // Grafik alanını temizle ve mesaj göster
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Özet grafik için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const { currencyTotals } = data;
            const paidAmount = currencyTotals.TL.paid;
            const unpaidAmount = currencyTotals.TL.unpaid;
            const overdueAmount = data.totalOverdueAmountTL || 0;
            
            window.summaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ödenen', 'Vadesi Gelmemiş', 'Vadesi Geçmiş'],
                    datasets: [{
                        data: [paidAmount, Math.max(0, unpaidAmount - overdueAmount), overdueAmount], // Negatif değer olmaması için Math.max
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(244, 67, 54, 0.8)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(33, 150, 243, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Ödeme Durumu Dağılımı (TL)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0; // total 0 kontrolü
                                        label += `${formatCurrency(value)} TL (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Aylık grafik oluştur
        function createMonthlyChart() { 
            const monthlyDataLocal = window.statsData && window.statsData.monthlyData;
            const selectedYear = document.getElementById('monthlyYearFilter').value;
            const selectedCurrency = document.getElementById('monthlyCurrencyFilter').value;
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            if (window.monthlyChart && typeof window.monthlyChart.destroy === 'function') {
                window.monthlyChart.destroy();
                window.monthlyChart = null;
            }

            if (typeof selectedYear === 'undefined' || selectedYear === '' || typeof selectedCurrency === 'undefined' || !monthlyDataLocal) {
                console.warn("[createMonthlyChart] Yıl, para birimi veya aylık veri tanımsız/eksik. Grafik oluşturulmayacak.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Grafik için lütfen yıl ve para birimi seçin veya veri mevcut değil.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                updateMonthlyCards(); 
                populateMonthlyTable(); // Tabloyu da boşalt/güncelle
                return;
            }
            
            console.log("[createMonthlyChart] Seçilen Yıl:", selectedYear, "Seçilen Para Birimi:", selectedCurrency); 
            
            const months = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];
            
            // Veri setlerini doğrudan aylık veriden dolduracağız
            const monthlyPaidData = Array(12).fill(0);
            const monthlyUnpaidData = Array(12).fill(0);
            // Toplam tutar için ayrı bir diziye gerek yok, paid ve unpaid toplanarak bulunabilir
            // Ancak grafik için ayrı tutmak daha iyi olabilir, bu yüzden onu da ekliyorum:
            const monthlyTotalData = Array(12).fill(0); 
            let dataFoundForSelectedParameters = false;
            
            for (const key in monthlyDataLocal) {
                // Anahtarın formatı YYYY-AA olmalı
                const parts = key.split('-');
                if (parts.length !== 2) continue;

                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);

                if (year == selectedYear && month >= 1 && month <= 12) {
                    const monthEntry = monthlyDataLocal[key];
                    if (!monthEntry || !monthEntry.currencies) continue;
                    dataFoundForSelectedParameters = true; 
                    
                    let currentMonthPaid = 0;
                    let currentMonthUnpaid = 0;
                    let currentMonthTotal = 0;

                    if (selectedCurrency === 'ALL') {
                        Object.keys(monthEntry.currencies).forEach(currency => {
                            const currencyData = monthEntry.currencies[currency];
                            let multiplier = 1;
                            // TODO: Dinamik kur alınabilir veya sabit bir varsayım kullanılabilir. Şimdilik sabit.
                            if (currency === 'USD') multiplier = 30; 
                            if (currency === 'EUR') multiplier = 32; 
                            
                            currentMonthPaid += (currencyData.paid || 0) * multiplier;
                            currentMonthUnpaid += (currencyData.unpaid || 0) * multiplier;
                            currentMonthTotal += (currencyData.total || 0) * multiplier;
                        });
                    } else {
                        const currencyData = monthEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentMonthPaid = currencyData.paid || 0;
                            currentMonthUnpaid = currencyData.unpaid || 0;
                            currentMonthTotal = currencyData.total || 0;
                        }
                    }
                    monthlyPaidData[month-1] = currentMonthPaid;
                    monthlyUnpaidData[month-1] = currentMonthUnpaid;
                    monthlyTotalData[month-1] = currentMonthTotal; 
                }
            }

            if (!dataFoundForSelectedParameters) {
                 console.warn(`[createMonthlyChart] ${selectedYear} yılı için veri bulunamadı.`);
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText(`${selectedYear} yılı için veri bulunamadı.`, ctx.canvas.width / 2, ctx.canvas.height / 2);
                 updateMonthlyCards(); 
                 populateMonthlyTable(); // Tabloyu da boşalt/güncelle
                 return;
            }
            
            console.log("[createMonthlyChart] Grafik için veri dizileri:", 
                        "Toplam:", monthlyTotalData, 
                        "Ödenen:", monthlyPaidData, 
                        "Ödenmemiş:", monthlyUnpaidData);

            const colors = {
                total: { bg: 'rgba(54, 162, 235, 0.5)', border: 'rgba(54, 162, 235, 1)' },
                paid: { bg: 'rgba(75, 192, 192, 0.5)', border: 'rgba(75, 192, 192, 1)' },
                unpaid: { bg: 'rgba(255, 99, 132, 0.5)', border: 'rgba(255, 99, 132, 1)' }
            };
            
            window.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Toplam Tutar',
                            data: monthlyTotalData, // monthlyAmountData -> monthlyTotalData
                            backgroundColor: colors.total.bg,
                            borderColor: colors.total.border,
                            borderWidth: 1
                        },
                        {
                            label: 'Ödenen',
                            data: monthlyPaidData,
                            backgroundColor: colors.paid.bg,
                            borderColor: colors.paid.border,
                            borderWidth: 1
                        },
                        {
                            label: 'Ödenmemiş',
                            data: monthlyUnpaidData,
                            backgroundColor: colors.unpaid.bg,
                            borderColor: colors.unpaid.border,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Tutar (${selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency})`,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ay',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectedYear} Yılı Aylık Ödeme Analizi (${selectedCurrency === 'ALL' ? 'Tüm Para Birimleri (TL Yaklaşık)' : selectedCurrency})`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y) + ' ' + 
                                            (selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            updateMonthlyCards();
            populateMonthlyTable(); // Grafik güncellendikten sonra tabloyu da güncelle
        }

        // Aylık analiz kartlarını güncelle
        function updateMonthlyCards() { 
            const monthlyDataLocal = window.statsData && window.statsData.monthlyData;
            const selectedYear = document.getElementById('monthlyYearFilter').value;
            const selectedCurrency = document.getElementById('monthlyCurrencyFilter').value;
            
            const highestMonthEl = document.getElementById('highestMonth');
            const lowestMonthEl = document.getElementById('lowestMonth');
            const monthlyAverageEl = document.getElementById('monthlyAverage');
            const monthlyTotalCollectionEl = document.getElementById('monthlyTotalCollection'); // Bu "Toplam Tahsilat" (Ödenenler)

            if (!highestMonthEl || !lowestMonthEl || !monthlyAverageEl || !monthlyTotalCollectionEl) {
                console.warn("[updateMonthlyCards] Gerekli kart elementleri bulunamadı.");
                return;
            }

            if (!monthlyDataLocal || typeof selectedYear === 'undefined' || selectedYear === '' || typeof selectedCurrency === 'undefined') {
                console.warn("[updateMonthlyCards] Aylık veri, yıl veya para birimi bulunamadı/seçilmedi.");
                highestMonthEl.textContent = '-';
                lowestMonthEl.textContent = '-';
                monthlyAverageEl.textContent = '0 TL'; // Varsayılan para birimi
                monthlyTotalCollectionEl.textContent = '0 TL'; // Varsayılan para birimi
                return;
            }
            
            console.log("[updateMonthlyCards] Seçilen Yıl:", selectedYear, "Seçilen Para Birimi:", selectedCurrency);

            let highestMonthStats = { month: 0, amount: -Infinity }; 
            let lowestMonthStats = { month: 0, amount: Infinity };
            let totalAmountAllMonthsForAverage = 0; // Ortalama için toplam tutar
            let totalPaidAllMonths = 0; // Toplam tahsilat (ödenen)
            let monthsWithDataCount = 0;
            let dataFoundForYear = false;
            
            for (let m = 1; m <= 12; m++) {
                const yearMonthKey = `${selectedYear}-${String(m).padStart(2, '0')}`;
                const monthEntry = monthlyDataLocal[yearMonthKey];
                
                if (!monthEntry || !monthEntry.currencies) continue;
                dataFoundForYear = true;
                
                let currentMonthTotalAmount = 0; // İlgili ayın toplam tutarı (ödenen + ödenmeyen)
                let currentMonthPaidAmount = 0;  // İlgili ayın ödenen tutarı
                
                if (selectedCurrency === 'ALL') {
                    Object.keys(monthEntry.currencies).forEach(currency => {
                        const currencyData = monthEntry.currencies[currency];
                        let multiplier = 1;
                        if (currency === 'USD') multiplier = 30; 
                        if (currency === 'EUR') multiplier = 32; 
                        
                        currentMonthTotalAmount += (currencyData.total || 0) * multiplier;
                        currentMonthPaidAmount += (currencyData.paid || 0) * multiplier;
                    });
                } else {
                    if (monthEntry.currencies[selectedCurrency]) {
                        currentMonthTotalAmount = monthEntry.currencies[selectedCurrency].total || 0;
                        currentMonthPaidAmount = monthEntry.currencies[selectedCurrency].paid || 0;
                    }
                }
                
                // Ay için veri varsa say ve toplamları güncelle
                monthsWithDataCount++; // Veri olan ay sayısını artır
                totalAmountAllMonthsForAverage += currentMonthTotalAmount;
                totalPaidAllMonths += currentMonthPaidAmount;
                
                // En yüksek ve en düşük ay (toplam tutara göre)
                if (currentMonthTotalAmount > highestMonthStats.amount) {
                    highestMonthStats = { month: m, amount: currentMonthTotalAmount };
                }
                if (currentMonthTotalAmount < lowestMonthStats.amount) {
                    lowestMonthStats = { month: m, amount: currentMonthTotalAmount };
                }
            }
            
            const monthsNames = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];
            
            const monthlyAverageCalculated = monthsWithDataCount > 0 ? totalAmountAllMonthsForAverage / monthsWithDataCount : 0;
            const displayCurrency = selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency;

            if (!dataFoundForYear) {
                highestMonthEl.textContent = '-';
                lowestMonthEl.textContent = '-';
                monthlyAverageEl.textContent = `0 ${displayCurrency}`;
                monthlyTotalCollectionEl.textContent = `0 ${displayCurrency}`;
                return;
            }

            highestMonthEl.textContent = 
                highestMonthStats.amount > -Infinity && highestMonthStats.month > 0 ? 
                `${monthsNames[highestMonthStats.month-1]} - ${formatCurrency(highestMonthStats.amount)} ${displayCurrency}` : 
                '-';
                
            lowestMonthEl.textContent = 
                lowestMonthStats.amount < Infinity && lowestMonthStats.month > 0 ?
                `${monthsNames[lowestMonthStats.month-1]} - ${formatCurrency(lowestMonthStats.amount)} ${displayCurrency}` : 
                '-';
                
            monthlyAverageEl.textContent = 
                `${formatCurrency(monthlyAverageCalculated)} ${displayCurrency}`;
                
            monthlyTotalCollectionEl.textContent = // Toplam Tahsilat (Ödenenler)
                `${formatCurrency(totalPaidAllMonths)} ${displayCurrency}`;
        }

        // Aylık Analiz Tablosunu Doldur
        function populateMonthlyTable() { 
            const monthlyDataLocal = window.statsData && window.statsData.monthlyData;
            const year = document.getElementById('monthlyYearFilter').value; // Yıl filtresinden al
            const tableContainer = document.getElementById('monthlyTableContainer'); // ID düzeltildi

            if (!tableContainer) {
                console.error("[populateMonthlyTable] Tablo konteyneri 'monthlyTableContainer' bulunamadı.");
                return;
            }
            tableContainer.innerHTML = ''; // Önceki tabloyu temizle

            if (!monthlyDataLocal || typeof year === 'undefined' || year === '') {
                console.warn("[populateMonthlyTable] Aylık veri veya seçili yıl bulunamadı.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Lütfen bir yıl seçin veya veri mevcut değil.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            console.log("[populateMonthlyTable] Seçilen Yıl:", year); 

            ['Ay', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            let dataFoundForTable = false;
            for (let i = 0; i < 12; i++) {
                const monthKey = `${year}-${String(i + 1).padStart(2, '0')}`;
                const monthEntry = monthlyDataLocal[monthKey];
                // console.log(`[populateMonthlyTable] Ay: ${months[i]}, Veri Anahtarı: ${monthKey}, Veri:`, monthEntry ? JSON.stringify(monthEntry.currencies) : "Veri Yok"); 

                const row = tbody.insertRow();
                row.insertCell().textContent = months[i];

                // Her para birimi için varsayılan boş değerler
                let tlTotal = 0, tlPaid = 0, tlUnpaid = 0;
                let usdTotal = 0, usdPaid = 0, usdUnpaid = 0;
                let eurTotal = 0, eurPaid = 0, eurUnpaid = 0;

                if (monthEntry && monthEntry.currencies) {
                    dataFoundForTable = true; // En az bir ay için veri var
                    const currencies = monthEntry.currencies;
                    if (currencies.TL) {
                        tlTotal = currencies.TL.total || 0;
                        tlPaid = currencies.TL.paid || 0;
                        tlUnpaid = currencies.TL.unpaid || 0;
                    }
                    if (currencies.USD) {
                        usdTotal = currencies.USD.total || 0;
                        usdPaid = currencies.USD.paid || 0;
                        usdUnpaid = currencies.USD.unpaid || 0;
                    }
                    if (currencies.EUR) {
                        eurTotal = currencies.EUR.total || 0;
                        eurPaid = currencies.EUR.paid || 0;
                        eurUnpaid = currencies.EUR.unpaid || 0;
                    }
                }
                
                row.insertCell().textContent = formatCurrency(tlTotal);
                row.insertCell().textContent = formatCurrency(tlPaid);
                row.insertCell().textContent = formatCurrency(tlUnpaid);
                row.insertCell().textContent = formatCurrency(usdTotal);
                row.insertCell().textContent = formatCurrency(usdPaid);
                row.insertCell().textContent = formatCurrency(usdUnpaid);
                row.insertCell().textContent = formatCurrency(eurTotal);
                row.insertCell().textContent = formatCurrency(eurPaid);
                row.insertCell().textContent = formatCurrency(eurUnpaid);
            }
            
            if (!dataFoundForTable) {
                 tableContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${year} yılı için gösterilecek aylık detay bulunmamaktadır.</p>`;
            } else {
                tableContainer.appendChild(table);
            }
        }

        // Yıllık grafik oluştur
        function createYearlyChart() {
            const ctx = document.getElementById('yearlyChart').getContext('2d');
            const currencyFilterElement = document.getElementById('yearlyCurrencyFilter');
            const chartTypeElement = document.getElementById('yearlyChartType');
            
            if (window.yearlyChart && typeof window.yearlyChart.destroy === 'function') {
                window.yearlyChart.destroy();
                window.yearlyChart = null;
            }

            if (!window.statsData || !window.statsData.yearlyData || !window.statsData.years || window.statsData.years.length === 0) {
                console.warn("Yıllık grafik için yıllık istatistik verileri veya yıl listesi bulunamadı/boş.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Yıllık grafik için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                updateYearlyCards(); 
                populateYearlyTable(); 
                return;
            }

            const selectedCurrency = currencyFilterElement ? currencyFilterElement.value : 'TL'; // Varsayılan TL
            const chartType = chartTypeElement ? chartTypeElement.value : 'bar'; // Varsayılan bar
            
            // Yılları küçükten büyüğe sırala, böylece grafik soldan sağa doğru zamanla ilerler
            const years = [...window.statsData.years].sort((a,b) => a-b); 
            
            const yearlyTotalData = []; // Toplam tutar (ödenen + ödenmemiş)
            const yearlyPaidData = [];  // Ödenen tutar
            const yearlyUnpaidData = []; // Ödenmemiş (beklenen) tutar
            
            years.forEach(year => {
                const yearEntry = window.statsData.yearlyData[year.toString()]; // Yıl string olmalı
                
                let currentYearTotal = 0;
                let currentYearPaid = 0;
                let currentYearUnpaid = 0;

                if (yearEntry && yearEntry.currencies) {
                    if (selectedCurrency === 'ALL') {
                        Object.keys(yearEntry.currencies).forEach(currency => {
                            const currencyData = yearEntry.currencies[currency];
                            let multiplier = 1;
                            if (currency === 'USD') multiplier = 30; 
                            if (currency === 'EUR') multiplier = 32; 
                            
                            currentYearTotal += (currencyData.total || 0) * multiplier;
                            currentYearPaid += (currencyData.paid || 0) * multiplier;
                            currentYearUnpaid += (currencyData.unpaid || 0) * multiplier;
                        });
                    } else {
                        const currencyData = yearEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentYearTotal = currencyData.total || 0;
                            currentYearPaid = currencyData.paid || 0;
                            currentYearUnpaid = currencyData.unpaid || 0;
                        }
                    }
                }
                yearlyTotalData.push(currentYearTotal);
                yearlyPaidData.push(currentYearPaid);
                yearlyUnpaidData.push(currentYearUnpaid);
            });
            
            const colors = {
                total: { bg: 'rgba(33, 150, 243, 0.5)', border: 'rgba(33, 150, 243, 1)' },
                paid: { bg: 'rgba(76, 175, 80, 0.5)', border: 'rgba(76, 175, 80, 1)' },
                unpaid: { bg: 'rgba(239, 83, 80, 0.5)', border: 'rgba(239, 83, 80, 1)' }
            };
            
            let chartConfig = {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Toplam Tutar',
                            data: yearlyTotalData, // yearlyAmountData -> yearlyTotalData
                            backgroundColor: colors.total.bg,
                            borderColor: colors.total.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        },
                        {
                            label: 'Ödenen',
                            data: yearlyPaidData,
                            backgroundColor: colors.paid.bg,
                            borderColor: colors.paid.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        },
                        {
                            label: 'Ödenmemiş',
                            data: yearlyUnpaidData,
                            backgroundColor: colors.unpaid.bg,
                            borderColor: colors.unpaid.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Tutar (${selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency})`,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Yıl',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Yıllık Ödeme Analizi (${selectedCurrency === 'ALL' ? 'Tüm Para Birimleri (TL Yaklaşık)' : selectedCurrency})`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y) + ' ' + 
                                            (selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
            
            window.yearlyChart = new Chart(ctx, chartConfig);
            updateYearlyCards(); 
            populateYearlyTable(); 
        }

        // Yıllık analiz kartlarını güncelle
        function updateYearlyCards() {
            const highestYearEl = document.getElementById('highestYear');
            const yearlyAverageEl = document.getElementById('yearlyAverage');
            const yearlyGrowthEl = document.getElementById('yearlyGrowth');
            const nextYearForecastEl = document.getElementById('nextYearForecast'); // Bu "Gelecek Yıl Tahmin" (Ödenmemişler)
            const trendIconEl = document.querySelector('#yearlyGrowth + .trend-indicator i');

            // Kritik DOM elementlerinin varlığını kontrol et
            if (!highestYearEl || !yearlyAverageEl || !yearlyGrowthEl || !nextYearForecastEl || !trendIconEl) {
                console.error("[updateYearlyCards] Kritik kart veya trend ikonu elementleri DOM'da bulunamadı. Kart güncellemesi iptal ediliyor.");
                return; 
            }
            
            // Kartları varsayılan boş/sıfır durumuna ayarla
            highestYearEl.textContent = '-';
            yearlyAverageEl.textContent = '0 TL';
            yearlyGrowthEl.textContent = '0%';
            nextYearForecastEl.textContent = '0 TL';
            trendIconEl.className = 'material-icons trend-neutral';
            trendIconEl.textContent = 'trending_flat';

            // window.statsData varlığını ve gerekli alt özellikleri kontrol et
            if (!window.statsData) {
                console.warn("[updateYearlyCards] window.statsData mevcut değil. Kartlar varsayılan boş durumda kalacak.");
                return;
            }
            if (!window.statsData.yearlyData || typeof window.statsData.yearlyData !== 'object') {
                console.warn("[updateYearlyCards] window.statsData.yearlyData mevcut değil veya bir nesne değil. Kartlar varsayılan boş durumda kalacak.", window.statsData.yearlyData);
                return;
            }
            // window.statsData.years boş bir dizi olabilir, bu bir hata değil, veri olmadığı anlamına gelir.
            if (!window.statsData.years || !Array.isArray(window.statsData.years)) {
                console.warn("[updateYearlyCards] window.statsData.years mevcut değil veya bir dizi değil. Kartlar varsayılan boş durumda kalacak.", window.statsData.years);
                return;
            }
            // Eğer yıllar dizisi boşsa, veri yoktur, bu yüzden varsayılan değerler kalır.
             if (window.statsData.years.length === 0) {
                console.log("[updateYearlyCards] window.statsData.years dizisi boş. Yıllık veri yok, kartlar varsayılan durumda kalacak.");
                return;
            }

            console.log("[updateYearlyCards] Kart güncellemeleri için devam ediliyor. yearlyData:", JSON.parse(JSON.stringify(window.statsData.yearlyData)), "years:", window.statsData.years);

            const { yearlyData, years } = window.statsData;
            const selectedCurrency = document.getElementById('yearlyCurrencyFilter').value;
            const displayCurrency = selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency;

            let highestYearAmount = -Infinity; 
            let highestYearVal = '-';
            let totalAmountForAllYearsForAverage = 0; 
            let totalPaidLastYear = 0; 
            let totalPaidPreviousYear = 0; 
            let totalUnpaidNextYearForecast = 0; 
            let yearCountForAverage = 0;

            const sortedYears = [...years].sort((a, b) => a - b); 

            sortedYears.forEach((year, index) => {
                const yearEntry = yearlyData[year.toString()];
                if (yearEntry && yearEntry.currencies) {
                    yearCountForAverage++;
                    let currentYearTotalAmount = 0; 
                    let currentYearPaidAmount = 0;  
                    let currentYearUnpaidAmount = 0; 

                    if (selectedCurrency === 'ALL') {
                        Object.keys(yearEntry.currencies).forEach(c => {
                            const currencyData = yearEntry.currencies[c];
                            let multiplier = 1;
                            if (c === 'USD') multiplier = 30;
                            if (c === 'EUR') multiplier = 32;
                            currentYearTotalAmount += (currencyData.total || 0) * multiplier;
                            currentYearPaidAmount += (currencyData.paid || 0) * multiplier;
                            currentYearUnpaidAmount += (currencyData.unpaid || 0) * multiplier;
                        });
                    } else {
                        const currencyData = yearEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentYearTotalAmount = currencyData.total || 0;
                            currentYearPaidAmount = currencyData.paid || 0;
                            currentYearUnpaidAmount = currencyData.unpaid || 0;
                        }
                    }
                    
                    totalAmountForAllYearsForAverage += currentYearTotalAmount;

                    if (currentYearTotalAmount > highestYearAmount) {
                        highestYearAmount = currentYearTotalAmount;
                        highestYearVal = year.toString();
                    }

                    if (index === sortedYears.length - 1) { 
                        totalPaidLastYear = currentYearPaidAmount;
                        totalUnpaidNextYearForecast = currentYearUnpaidAmount; 
                    }
                    if (index === sortedYears.length - 2) { 
                        totalPaidPreviousYear = currentYearPaidAmount;
                    }
                }
            });

            const yearlyAverageCalculated = yearCountForAverage > 0 ? totalAmountForAllYearsForAverage / yearCountForAverage : 0;
            highestYearEl.textContent = highestYearVal !== '-' ? `${highestYearVal} - ${formatCurrency(highestYearAmount)} ${displayCurrency}` : '-';
            yearlyAverageEl.textContent = `${formatCurrency(yearlyAverageCalculated)} ${displayCurrency}`;
            nextYearForecastEl.textContent = `${formatCurrency(totalUnpaidNextYearForecast)} ${displayCurrency}`;

            let yearlyGrowthPercentage = 0;
            if (totalPaidPreviousYear > 0) {
                yearlyGrowthPercentage = ((totalPaidLastYear - totalPaidPreviousYear) / totalPaidPreviousYear) * 100;
            } else if (totalPaidLastYear > 0) { 
                yearlyGrowthPercentage = 100;
            } else if (totalPaidLastYear === 0 && totalPaidPreviousYear === 0) { 
                 yearlyGrowthPercentage = 0;
            }

            yearlyGrowthEl.textContent = `${yearlyGrowthPercentage.toFixed(1)}%`;
            
            if (yearlyGrowthPercentage > 0.1) { 
                trendIconEl.className = 'material-icons trend-positive';
                trendIconEl.textContent = 'trending_up';
            } else if (yearlyGrowthPercentage < -0.1) {
                trendIconEl.className = 'material-icons trend-negative';
                trendIconEl.textContent = 'trending_down';
            } else {
                trendIconEl.className = 'material-icons trend-neutral';
                trendIconEl.textContent = 'trending_flat';
            }
            console.log("[updateYearlyCards] Kartlar güncellendi.");
        }

        // Yıllık Analiz Tablosunu Doldur
        function populateYearlyTable() {
            const tableContainer = document.getElementById('yearlyTableContainer'); 
            if (!tableContainer) {
                 console.error("[populateYearlyTable] Tablo konteyneri 'yearlyTableContainer' bulunamadı.");
                 return;
            }
            tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık detay tablosu yükleniyor...</p>'; 

            if (!window.statsData) {
                 console.warn("[populateYearlyTable] window.statsData mevcut değil. Tablo doldurulmayacak.");
                 tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Genel istatistik verisi bulunamadı.</p>';
                 return;
            }
            if (!window.statsData.yearlyData || typeof window.statsData.yearlyData !== 'object') {
                console.warn("[populateYearlyTable] window.statsData.yearlyData mevcut değil veya bir nesne değil. Tabloda veri gösterilmeyecek.", window.statsData.yearlyData);
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık veri bulunamadı (yearlyData eksik veya hatalı).</p>';
                return;
            }
            if (!window.statsData.years || !Array.isArray(window.statsData.years)) { 
                console.warn("[populateYearlyTable] window.statsData.years mevcut değil veya bir dizi değil. Tablo boş olabilir veya veri gösterilmeyebilir.", window.statsData.years);
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık veri bulunamadı (years listesi eksik veya hatalı).</p>';
                return;
            }

            console.log("[populateYearlyTable] Dolduruluyor. yearlyData:", JSON.parse(JSON.stringify(window.statsData.yearlyData)), "years:", window.statsData.years);

            const { yearlyData, years } = window.statsData;
            
            if (years.length === 0) {
                console.log("[populateYearlyTable] 'years' dizisi boş. Gösterilecek yıllık detay yok.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek yıllık detay bulunmamaktadır.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Yıl', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const sortedYears = [...years].sort((a,b) => b-a); 
            let dataFoundForTable = false;

            sortedYears.forEach(year => {
                const yearKey = year.toString();
                const yearEntry = yearlyData[yearKey];
                const row = tbody.insertRow();
                row.insertCell().textContent = year;

                let tlTotal = 0, tlPaid = 0, tlUnpaid = 0;
                let usdTotal = 0, usdPaid = 0, usdUnpaid = 0;
                let eurTotal = 0, eurPaid = 0, eurUnpaid = 0;

                if (yearEntry && yearEntry.currencies) {
                    dataFoundForTable = true; // Bu yıl için veri bulundu olarak işaretle
                    const currencies = yearEntry.currencies;
                    if (currencies.TL) {
                        tlTotal = currencies.TL.total || 0;
                        tlPaid = currencies.TL.paid || 0;
                        tlUnpaid = currencies.TL.unpaid || 0;
                    }
                    if (currencies.USD) {
                        usdTotal = currencies.USD.total || 0;
                        usdPaid = currencies.USD.paid || 0;
                        usdUnpaid = currencies.USD.unpaid || 0;
                    }
                    if (currencies.EUR) {
                        eurTotal = currencies.EUR.total || 0;
                        eurPaid = currencies.EUR.paid || 0;
                        eurUnpaid = currencies.EUR.unpaid || 0;
                    }
                }
                
                row.insertCell().textContent = formatCurrency(tlTotal);
                row.insertCell().textContent = formatCurrency(tlPaid);
                row.insertCell().textContent = formatCurrency(tlUnpaid);
                row.insertCell().textContent = formatCurrency(usdTotal);
                row.insertCell().textContent = formatCurrency(usdPaid);
                row.insertCell().textContent = formatCurrency(usdUnpaid);
                row.insertCell().textContent = formatCurrency(eurTotal);
                row.insertCell().textContent = formatCurrency(eurPaid);
                row.insertCell().textContent = formatCurrency(eurUnpaid);
            });
            
            if (!dataFoundForTable) { // Eğer döngü boyunca hiçbir yıl için veri bulunamadıysa
                 console.log("[populateYearlyTable] Sıralı yıl listesindeki hiçbir yıl için veri bulunamadı.");
                 tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek yıllık detay bulunmamaktadır.</p>';
            } else {
                tableContainer.appendChild(table);
                console.log("[populateYearlyTable] Tablo başarıyla dolduruldu.");
            }
        }

        // Durum analizi grafiği oluştur
        function createStatusChart() {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }
            
            if (!window.statsData) {
                console.warn("Durum analizi için istatistik verileri bulunamadı");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Durum analizi için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const paidCount = window.statsData.paidCount || 0;
            const unpaidCount = window.statsData.unpaidCount || 0;
            
            // Eğer her ikisi de 0 ise grafik boş görünecek, bu genelde istenen bir durumdur.
            // Eğer 0 olduğunda bile bir şey göstermek isteniyorsa (örn: "Veri Yok" dilimi),
            // `datasets.data` içine [0,0] yerine özel bir değer ve label eklenebilir.
            if (paidCount === 0 && unpaidCount === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText('Ödeme durumu için işlem bulunmuyor.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                 return;
            }

            window.statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ödendi', 'Ödenmedi'],
                    datasets: [{
                        data: [paidCount, unpaidCount], // Gerçek değerler
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(239, 83, 80, 0.7)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(239, 83, 80, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Ödeme Durumuna Göre İşlem Sayısı' 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                    const value = context.parsed || 0;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `${value} işlem (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Özet sekmesini detaylı verilerle doldur
        function populateSummaryTab(data) {
            if (!data) return;

            const { currencyTotals, highestPayment, overdueCount, expectedPaymentsByYear, totalInstallments, paidInstallments, clientCount, paidCount } = data; // paidCount eklendi

            // Ana TL kartları zaten generateStats içinde güncelleniyor.
            document.getElementById('expectedNextYear').textContent = `${formatCurrency(currencyTotals.TL.expectedNextYear)} TL`; // TRY -> TL olarak düzeltildi
            document.getElementById('highestPaymentInfo').textContent = `${highestPayment.clientName} - ${formatCurrency(highestPayment.amount)} ${highestPayment.currency} (${highestPayment.date})`;
            document.getElementById('overdueCount').textContent = overdueCount;
            const avgInstallments = clientCount > 0 ? (totalInstallments / clientCount).toFixed(1) : 0;
            const avgPaidInstallments = paidCount > 0 ? (paidInstallments / paidCount).toFixed(1) : 0;
            document.getElementById('avgInstallmentInfo').textContent = `${avgInstallments} / ${avgPaidInstallments}`;

            // Diğer para birimleri için özetler
            document.getElementById('totalAmountUSD').textContent = `Toplam: ${formatCurrency(currencyTotals.USD.total)} USD`;
            document.getElementById('totalPaidUSD').textContent = `Ödenen: ${formatCurrency(currencyTotals.USD.paid)} USD`;
            document.getElementById('totalUnpaidUSD').textContent = `Beklenen: ${formatCurrency(currencyTotals.USD.unpaid)} USD`;

            document.getElementById('totalAmountEUR').textContent = `Toplam: ${formatCurrency(currencyTotals.EUR.total)} EUR`;
            document.getElementById('totalPaidEUR').textContent = `Ödenen: ${formatCurrency(currencyTotals.EUR.paid)} EUR`;
            document.getElementById('totalUnpaidEUR').textContent = `Beklenen: ${formatCurrency(currencyTotals.EUR.unpaid)} EUR`;

            // Yıllara Göre Beklenen Ödemeler Tablosu
            const tableContainer = document.getElementById('expectedPaymentsByYearTableContainer');
            tableContainer.innerHTML = ''; // Önceki tabloyu temizle
            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Yıl', 'TL', 'USD', 'EUR'].forEach(text => { // TRY -> TL olarak güncellendi
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const sortedYears = Object.keys(expectedPaymentsByYear).sort((a, b) => b - a); // Yılları büyükten küçüğe sırala
            sortedYears.forEach(year => {
                const row = tbody.insertRow();
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatCurrency(expectedPaymentsByYear[year].TL || 0) + ' TL'; // TRY -> TL olarak güncellendi
                row.insertCell().textContent = formatCurrency(expectedPaymentsByYear[year].USD || 0) + ' USD';
                row.insertCell().textContent = formatCurrency(expectedPaymentsByYear[year].EUR || 0) + ' EUR';
            });
            tableContainer.appendChild(table);
        }

        // Yıllık Analiz Tablosunu Doldur
        function populateYearlyTable() {
            if (!window.statsData || !window.statsData.yearlyData || !window.statsData.years) return;
            const { yearlyData, years } = window.statsData;
            const tableContainer = document.getElementById('yearly-tab').querySelector('.detail-table-container');
            if (!tableContainer) return;

            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Yıl', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            years.forEach(year => {
                const data = yearlyData[year] || { currencies: { TL: {}, USD: {}, EUR: {} } };
                const row = tbody.insertRow();
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatCurrency(data.currencies.TL.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.TL.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.TL.unpaid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.unpaid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.unpaid || 0);
            });
            tableContainer.appendChild(table);
        }

        // Durum Analizi Tablosunu Doldur
        function populateStatusTable() {
            if (!window.statsData) return;
            const { paidCount, unpaidCount, currencyTotals, overdueCount } = window.statsData;
            const tableContainer = document.getElementById('status-tab').querySelector('.detail-table-container');
            if (!tableContainer) return;

            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'detail-table';
            const tbody = table.createTBody();

            function addRow(label, value) {
                const row = tbody.insertRow();
                row.insertCell().textContent = label;
                row.insertCell().textContent = value;
            }

            addRow('Ödenen Müvekkil Sayısı', paidCount);
            addRow('Ödenmemiş Müvekkil Sayısı', unpaidCount);
            addRow('Vadesi Geçmiş Ödeme Sayısı', overdueCount);
            addRow('Toplam TL Alacak', formatCurrency(currencyTotals.TL.total) + ' TL');
            addRow('Ödenen TL Tutar', formatCurrency(currencyTotals.TL.paid) + ' TL');
            addRow('Beklenen TL Tutar', formatCurrency(currencyTotals.TL.unpaid) + ' TL');
            addRow('Toplam USD Alacak', formatCurrency(currencyTotals.USD.total) + ' USD');
            addRow('Ödenen USD Tutar', formatCurrency(currencyTotals.USD.paid) + ' USD');
            addRow('Beklenen USD Tutar', formatCurrency(currencyTotals.USD.unpaid) + ' USD');
            addRow('Toplam EUR Alacak', formatCurrency(currencyTotals.EUR.total) + ' EUR');
            addRow('Ödenen EUR Tutar', formatCurrency(currencyTotals.EUR.paid) + ' EUR');
            addRow('Beklenen EUR Tutar', formatCurrency(currencyTotals.EUR.unpaid) + ' EUR');

            tableContainer.appendChild(table);
        }

        // *** YENİ FONKSİYON: Yıllara Göre Beklenen Ödemeler Grafiği ***
        let expectedPaymentsChartInstance = null; // Grafik örneğini takip etmek için

        function createExpectedPaymentsByYearChart() {
            const canvasElement = document.getElementById('expectedPaymentsByYearChart'); 
            if (!canvasElement) {
                console.warn("[createExpectedPaymentsByYearChart] Canvas elementi bulunamadı.");
                return; 
            }
            const ctx = canvasElement.getContext('2d');

            if (expectedPaymentsChartInstance && typeof expectedPaymentsChartInstance.destroy === 'function') {
                expectedPaymentsChartInstance.destroy();
                expectedPaymentsChartInstance = null;
            }

            if (!window.statsData || !window.statsData.expectedPaymentsByYear || Object.keys(window.statsData.expectedPaymentsByYear).length === 0) {
                console.log("Yıllara göre beklenen ödeme verisi bulunamadı veya boş.");
                ctx.clearRect(0, 0, canvasElement.width, canvasElement.height); 
                ctx.textAlign = 'center';
                ctx.fillText('Ödenmemiş beklenen ödeme verisi bulunmuyor.', canvasElement.width / 2, canvasElement.height / 2);
                return; 
            }

            const expectedData = window.statsData.expectedPaymentsByYear;
            const years = Object.keys(expectedData).map(Number).sort((a, b) => a - b); 
            
            const amountsTL = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['TL']) || 0); 
            const amountsUSD = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['USD']) || 0); 
            const amountsEUR = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['EUR']) || 0); 

            const formatFunc = typeof formatCurrency === 'function' ? formatCurrency : (val) => val;

            expectedPaymentsChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: years, 
                    datasets: [
                        {
                            label: 'TL', 
                            data: amountsTL, 
                            backgroundColor: 'rgba(244, 67, 54, 0.7)', 
                            borderColor: 'rgba(211, 47, 47, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'USD', 
                            data: amountsUSD, 
                            backgroundColor: 'rgba(33, 150, 243, 0.7)', 
                            borderColor: 'rgba(25, 118, 210, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'EUR', 
                            data: amountsEUR, 
                            backgroundColor: 'rgba(76, 175, 80, 0.7)', 
                            borderColor: 'rgba(56, 142, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { 
                                    return formatFunc(value); 
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tutar'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Yıl'
                            }
                        }
                    },
                    plugins: {
                        title: { 
                            display: true,
                            text: 'Yıllara Göre Beklenen Ödenmemiş Ödemeler',
                            font: { size: 14 }
                        },
                        legend: { display: true, position: 'top' }, 
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatFunc(context.parsed.y) + ' ' + context.dataset.label; 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log("Yıllara göre beklenen ödemeler grafiği oluşturuldu/güncellendi.");
        }
        // *** BİTTİ: Yeni Fonksiyon ***

        // EKSİK FONKSİYON TANIMLARI EKLENİYOR
        function createCurrencyCharts() {
            if (!window.statsData || !window.statsData.currencyTotals) {
                console.warn("[createCurrencyCharts] Para birimi istatistik verileri bulunamadı.");
                // Grafik alanlarını temizle ve mesaj göster
                const ctxDist = document.getElementById('currencyDistributionChart')?.getContext('2d');
                const ctxStatus = document.getElementById('currencyStatusChart')?.getContext('2d');
                if (ctxDist) {
                    ctxDist.clearRect(0, 0, ctxDist.canvas.width, ctxDist.canvas.height);
                    ctxDist.textAlign = 'center';
                    ctxDist.fillText('Dağılım grafiği için veri yok.', ctxDist.canvas.width / 2, ctxDist.canvas.height / 2);
                }
                if (ctxStatus) {
                    ctxStatus.clearRect(0, 0, ctxStatus.canvas.width, ctxStatus.canvas.height);
                    ctxStatus.textAlign = 'center';
                    ctxStatus.fillText('Durum grafiği için veri yok.', ctxStatus.canvas.width / 2, ctxStatus.canvas.height / 2);
                }
                return;
            }

            const { currencyTotals } = window.statsData;
            const currencies = Object.keys(currencyTotals).filter(c => currencyTotals[c] && (currencyTotals[c].total > 0 || currencyTotals[c].transactions > 0)); // Sadece işlem görmüş para birimleri

            // 1. Para Birimi Dağılım Grafiği (Toplam Alacaklara Göre - TL Bazında Yaklaşık)
            const ctxDistribution = document.getElementById('currencyDistributionChart').getContext('2d');
            if (window.currencyDistributionChartInstance) {
                window.currencyDistributionChartInstance.destroy();
            }

            const distributionLabels = [];
            const distributionData = [];
            const distributionColors = [];
            const currencyColorMap = {
                'TL': 'rgba(33, 150, 243, 0.7)',  // Mavi
                'USD': 'rgba(76, 175, 80, 0.7)',  // Yeşil
                'EUR': 'rgba(255, 152, 0, 0.7)', // Turuncu
                'OTHER': 'rgba(158, 158, 158, 0.7)' // Gri
            };

            currencies.forEach(currency => {
                let totalInTL = currencyTotals[currency].total;
                // USD ve EUR'yu yaklaşık TL'ye çevir (varsayımsal kurlar)
                if (currency === 'USD') totalInTL *= 30; 
                if (currency === 'EUR') totalInTL *= 32;
                
                distributionLabels.push(currency);
                distributionData.push(totalInTL);
                distributionColors.push(currencyColorMap[currency] || currencyColorMap['OTHER']);
            });
            
            if (distributionData.every(val => val === 0)) {
                 ctxDistribution.clearRect(0, 0, ctxDistribution.canvas.width, ctxDistribution.canvas.height);
                 ctxDistribution.textAlign = 'center';
                 ctxDistribution.fillText('Para birimi dağılımı için veri yok.', ctxDistribution.canvas.width / 2, ctxDistribution.canvas.height / 2);
            } else {
                window.currencyDistributionChartInstance = new Chart(ctxDistribution, {
                    type: 'doughnut',
                    data: {
                        labels: distributionLabels,
                        datasets: [{
                            data: distributionData,
                            backgroundColor: distributionColors,
                            borderColor: distributionColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Para Birimi Dağılımı (Toplam Alacak - Yaklaşık TL)' },
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        // Orijinal tutarı ve para birimini göstermek daha iyi olabilir.
                                        // Ancak pasta grafik yüzdelerle çalıştığı için TL çevrimi yapıldı.
                                        // Şimdilik TL karşılığını gösteriyoruz.
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed) + ' TL (Yaklaşık)';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 2. Para Birimi Durum Grafiği (Ödenen vs Ödenmemiş)
            const ctxStatus = document.getElementById('currencyStatusChart').getContext('2d');
            if (window.currencyStatusChartInstance) {
                window.currencyStatusChartInstance.destroy();
            }

            const statusLabels = currencies;
            const paidData = currencies.map(c => currencyTotals[c].paid);
            const unpaidData = currencies.map(c => currencyTotals[c].unpaid);

            if (paidData.every(val => val === 0) && unpaidData.every(val => val === 0) ) {
                 ctxStatus.clearRect(0, 0, ctxStatus.canvas.width, ctxStatus.canvas.height);
                 ctxStatus.textAlign = 'center';
                 ctxStatus.fillText('Para birimi durumu için veri yok.', ctxStatus.canvas.width / 2, ctxStatus.canvas.height / 2);
            } else {
                window.currencyStatusChartInstance = new Chart(ctxStatus, {
                    type: 'bar',
                    data: {
                        labels: statusLabels,
                        datasets: [
                            {
                                label: 'Ödenen',
                                data: paidData,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Ödenmemiş',
                                data: unpaidData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Tutar' }, ticks: { callback: formatCurrency }},
                            x: { title: { display: true, text: 'Para Birimi' }}
                        },
                        plugins: {
                            title: { display: true, text: 'Para Birimi Bazında Ödeme Durumları' },
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y) + ' ' + context.label;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Para Birimi Detay Tablosunu Doldur
        function populateCurrencyTable() {
            const tableContainer = document.getElementById('currencyTableContainer');
            if (!tableContainer) {
                console.error("[populateCurrencyTable] Tablo konteyneri 'currencyTableContainer' bulunamadı.");
                return;
            }
            tableContainer.innerHTML = '';

            if (!window.statsData || !window.statsData.currencyTotals) {
                console.warn("[populateCurrencyTable] Para birimi istatistik verileri bulunamadı.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Para birimi detay verisi bulunmamaktadır.</p>';
                return;
            }

            const { currencyTotals } = window.statsData;
            const currencies = Object.keys(currencyTotals).filter(c => currencyTotals[c] && (currencyTotals[c].total > 0 || currencyTotals[c].transactions > 0));

            if (currencies.length === 0) {
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek para birimi detayı bulunmamaktadır.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Para Birimi', 'Toplam Alacak', 'Ödenen Tutar', 'Beklenen Tutar', 'İşlem Sayısı'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            currencies.forEach(currency => {
                const data = currencyTotals[currency];
                const row = tbody.insertRow();
                row.insertCell().textContent = currency;
                row.insertCell().textContent = formatCurrency(data.total || 0);
                row.insertCell().textContent = formatCurrency(data.paid || 0);
                row.insertCell().textContent = formatCurrency(data.unpaid || 0);
                row.insertCell().textContent = data.transactions || 0;
            });
            tableContainer.appendChild(table);
        }

        // Tahsilat Trendi Grafiğini Oluştur
        function createCollectionTrendChart() {
            const ctx = document.getElementById('collectionTrendChart')?.getContext('2d');
            if (!ctx) {
                console.warn("[createCollectionTrendChart] Tahsilat trendi için canvas bulunamadı.");
                return;
            }
            if (window.collectionTrendChartInstance) {
                window.collectionTrendChartInstance.destroy();
            }

            if (!window.statsData || !window.statsData.monthlyData) { // Aylık ödenen verilerini kullanacağız
                console.warn("[createCollectionTrendChart] Tahsilat trendi için aylık veri bulunamadı.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Tahsilat trendi için veri yok.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const { monthlyData, years } = window.statsData;
            const sortedYears = [...years].sort((a,b) => a-b); // Yılları sırala
            
            const labels = []; // YYYY-AA formatında
            const paidDataTL = []; // Sadece TL ödemeleri veya tümü TL'ye çevrilmiş
            let dataFound = false;

            sortedYears.forEach(year => {
                for (let month = 1; month <= 12; month++) {
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    const monthEntry = monthlyData[monthKey];
                    let monthPaidAmountTL = 0;

                    if (monthEntry && monthEntry.currencies) {
                        dataFound = true;
                        // Tüm para birimlerindeki ödenenleri TL'ye çevirerek topla
                        Object.keys(monthEntry.currencies).forEach(currency => {
                            const currencyData = monthEntry.currencies[currency];
                            let multiplier = 1;
                            if (currency === 'USD') multiplier = 30;
                            if (currency === 'EUR') multiplier = 32;
                            monthPaidAmountTL += (currencyData.paid || 0) * multiplier;
                        });
                    }
                     // Sadece veri olan ayları ekleyebiliriz veya tüm ayları 0 ile gösterebiliriz.
                     // Şimdilik, içinde bulunduğumuz yıla kadar tüm ayları gösterelim.
                    if (dataFound || (year <= new Date().getFullYear())) { // Eğer geçmişte veri varsa veya mevcut/geçmiş bir yılsa etiketi ekle
                        labels.push(monthKey);
                        paidDataTL.push(monthPaidAmountTL);
                    }
                }
            });
            
            // Eğer hiç veri bulunamadıysa grafiği boş göster
            if (!dataFound || paidDataTL.every(val => val === 0)) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Tahsilat trendi için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            window.collectionTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Tahsilat (Yaklaşık TL)',
                        data: paidDataTL,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Tutar (Yaklaşık TL)' }, ticks: { callback: formatCurrency }},
                        x: { title: { display: true, text: 'Dönem (Yıl-Ay)' }}
                    },
                    plugins: {
                        title: { display: true, text: 'Aylık Tahsilat Trendi' },
                        legend: { display: false } // Tek dataset olduğu için legend gereksiz olabilir
                    }
                }
            });
        }

        // Yeni Ödeme Detayları Modalını Yönetmek İçin Event Listener
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function() {
                console.log("[.view-btn Click] View button clicked for paymentId:", this.getAttribute('data-payment-id'));
                
                // Diğer modalları kesin olarak gizle (önlem olarak)
                const editModalElement = document.getElementById('editModal');
                if (editModalElement) editModalElement.style.display = 'none';
                const statsModalElement = document.getElementById('statsModal');
                if (statsModalElement) statsModalElement.style.display = 'none';
                
                // Modal'ı göster
                const paymentId = this.getAttribute('data-payment-id');
                
                // API'den detayları yükle
                const modalBody = document.getElementById('odemeDetayModalBody');
                const modalLabel = document.getElementById('paymentDetailModalLabel');
                
                if (!modalBody) {
                    console.error("Modal body elemanı bulunamadı: odemeDetayModalBody");
                    return;
                }
                
                // Yükleniyor animasyonu göster
                modalBody.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Yükleniyor...</span></div></div>';
                
                // Modal'ı göster
                const paymentDetailModal = new bootstrap.Modal(document.getElementById('paymentDetailModal'));
                // Modalın data-current-payment-id özelliğini ayarla
                document.getElementById('paymentDetailModal').setAttribute('data-current-payment-id', paymentId);
                paymentDetailModal.show();
                
                // API'den verileri çek
                fetch(`/api/odeme_detay/${paymentId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("API yanıtı:", data);
                        
                        if (data.error) {
                            modalBody.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                            return;
                        }
                        
                        // Başlık güncelleme
                        if (modalLabel) {
                            modalLabel.textContent = `Ödeme Detayları: ${data.name || 'N/A'} ${data.surname || ''}`;
                        }
                        
                        // Para birimi düzeltme (TL -> TRY)
                        let displayCurrency = data.currency || 'TL';
                        if (displayCurrency.toUpperCase() === 'TL') {
                            displayCurrency = 'TRY';
                        }
                        
                        // İçerik oluşturma - Basit tablo yapısı
                        let html = '';
                        
                        // Müvekkil Bilgileri Bölümü
                        html += `
                        <div class="payment-detail-section">
                            <h6>Müvekkil Bilgileri</h6>
                            <table class="payment-detail-table">
                                <tr>
                                    <th>Ad Soyad</th>
                                    <td>${data.name || '-'} ${data.surname || ''}</td>
                                </tr>
                                <tr>
                                    <th>TC Kimlik No</th>
                                    <td>${data.tc || '-'}</td>
                                </tr>
                            </table>
                        </div>`;
                        
                        // Borç Bilgileri Bölümü
                        html += `
                        <div class="payment-detail-section">
                            <h6>Borç Bilgileri</h6>
                            <table class="payment-detail-table">
                                <tr>
                                    <th>Tutar</th>
                                    <td>${parseFloat(data.amount || 0).toLocaleString('tr-TR', {
                                        style: 'currency',
                                        currency: displayCurrency
                                    })}</td>
                                </tr>
                                <tr>
                                    <th>Taksit Sayısı</th>
                                    <td>${data.installments || '1'}</td>
                                </tr>
                                <tr>
                                    <th>Borç Kayıt Tarihi</th>
                                    <td>${data.registration_date || '-'}</td>
                                </tr>
                                <tr>
                                    <th>Son Ödeme Tarihi</th>
                                    <td>${data.due_date || '-'}</td>
                                </tr>
                            </table>
                        </div>`;
                        
                        // Durum ve Açıklama Bölümü
                        html += `
                        <div class="payment-detail-section">
                            <h6>Durum ve Açıklama</h6>
                            <table class="payment-detail-table">
                                <tr>
                                    <th>Ödeme Durumu</th>
                                    <td>${data.status === 'Ödendi' 
                                        ? '<span class="status-paid">Ödendi</span>' 
                                        : '<span class="status-unpaid">Ödenmedi</span>'}</td>
                                </tr>
                                <tr>
                                    <th>Açıklama</th>
                                    <td>${data.description || 'Açıklama bulunmuyor.'}</td>
                                </tr>
                            </table>
                        </div>`;
                        
                        // Ödeme Geçmişi Bölümü (varsa)
                        if (data.payment_history && data.payment_history.length > 0) {
                            html += `
                            <div class="payment-detail-section">
                                <h6>Ödeme Geçmişi</h6>
                                <table class="payment-detail-table">
                                    <thead>
                                        <tr>
                                            <th>Tarih</th>
                                            <th>Tutar</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;
                            
                            data.payment_history.forEach(payment => {
                                html += `
                                        <tr>
                                            <td>${payment.date || '-'}</td>
                                            <td>${parseFloat(payment.amount || 0).toLocaleString('tr-TR', {
                                                style: 'currency',
                                                currency: displayCurrency
                                            })}</td>
                                        </tr>`;
                            });
                            
                            html += `
                                    </tbody>
                                </table>
                            </div>`;
                        }
                        
                        modalBody.innerHTML = html;
                        console.log("Modal içeriği güncellendi");
                        
                        // Düzenle butonuna olay dinleyici ekle
                        const editBtn = document.getElementById('detailsEditBtn');
                        if (editBtn) {
                            // Eski event listener'ları temizle
                            const newEditBtn = editBtn.cloneNode(true);
                            editBtn.parentNode.replaceChild(newEditBtn, editBtn);
                            
                            // Yeni event listener ekle
                            newEditBtn.addEventListener('click', function() {
                                console.log("Düzenle butonuna tıklandı, paymentId:", paymentId);
                                
                                // Mevcut modalı kapat
                                const detailModalInstance = bootstrap.Modal.getInstance(document.getElementById('paymentDetailModal'));
                                if (detailModalInstance) {
                                    detailModalInstance.hide();
                                    console.log("Detay modalı kapatıldı");
                                } else {
                                    console.error("Detay modal instance bulunamadı!");
                                }
                                
                                // Düzenleme modalını aç ve doldur
                                editModalElement.style.display = 'block';
                                console.log("Düzenleme modalı açıldı");
                                
                                // Uygun satırı bul - Hem data-client-id hem de data-id özniteliklerini kontrol et
                                let targetRow = document.querySelector(`tr[data-client-id="${paymentId}"]`);
                                if (!targetRow) {
                                    // data-client-id bulunamadıysa data-id'yi dene
                                    targetRow = document.querySelector(`tr[data-id="${paymentId}"]`);
                                    console.log("data-id ile satır bulundu:", targetRow ? "Evet" : "Hayır");
                                } else {
                                    console.log("data-client-id ile satır bulundu");
                                }
                                
                                if (!targetRow) {
                                    console.error("Müvekkil satırı bulunamadı! Satır ID:", paymentId);
                                    alert("Müvekkil satırı bulunamadı! Lütfen sayfayı yenileyip tekrar deneyin.");
                                    return;
                                }
                                
                                // Form alanlarını doldur
                                document.getElementById('editClientId').value = paymentId;
                                document.getElementById('editName').value = targetRow.cells[0].textContent.trim();
                                document.getElementById('editSurname').value = targetRow.cells[1].textContent.trim();
                                document.getElementById('editTc').value = targetRow.cells[2].textContent.trim();
                                
                                // Tutar ve para birimi
                                const amountText = targetRow.cells[3].textContent.trim();
                                const amountParts = amountText.split(' ');
                                document.getElementById('editAmount').value = amountParts[0] || '';
                                if (amountParts.length > 1) {
                                    document.getElementById('editCurrency').value = amountParts[amountParts.length - 1];
                                }
                                
                                document.getElementById('editInstallments').value = targetRow.cells[4].textContent.trim();
                                
                                // Tarihler
                                const regDateText = targetRow.cells[5].textContent.trim();
                                if (regDateText && regDateText !== '-') {
                                    const dateParts = regDateText.split('.');
                                    if (dateParts.length === 3) {
                                        document.getElementById('editRegistrationDate').value = 
                                            `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                                    }
                                }
                                
                                const dueDateText = targetRow.cells[6].textContent.trim();
                                if (dueDateText && dueDateText !== '-') {
                                    const dateParts = dueDateText.split('.');
                                    if (dateParts.length === 3) {
                                        document.getElementById('editDueDate').value = 
                                            `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                                    }
                                }
                                
                                // Status değeri
                                const isPaid = targetRow.cells[7].textContent.trim().includes('Ödendi');
                                const editStatusCheckbox = document.getElementById('editStatus');
                                const statusTextSpan = editModalElement.querySelector('.status-text');
                                
                                if (editStatusCheckbox) editStatusCheckbox.checked = isPaid;
                                if (statusTextSpan) statusTextSpan.textContent = isPaid ? 'Ödendi' : 'Ödenmedi';
                                
                                // Açıklama
                                const description = targetRow.getAttribute('data-description');
                                document.getElementById('editDescription').value = 
                                    description === 'None' || !description ? '' : description;
                                
                                // Form submit işlemi
                                const editForm = document.getElementById('editForm');
                                if (editForm) {
                                    editForm.onsubmit = function(event) {
                                        event.preventDefault();
                                        const clientIdToUpdate = document.getElementById('editClientId').value;
                                        window.updateClient(clientIdToUpdate);
                                    };
                                }
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Ödeme detayları yüklenirken hata:", error);
                        modalBody.innerHTML = `<div class="alert alert-danger">Ödeme detayları yüklenirken bir hata oluştu: ${error.message}</div>`;
                    });
            });
        });

        // Yeni yardımcı fonksiyon
        function newCreateDetailGroup(title, items, customHtmlContent = '') {
            let groupHtml = `<div class="detail-section">
                            <h6 class="detail-section-title">${title}</h6>
                            <div class="detail-section-content">`;
            if (items.length > 0) {
                groupHtml += '<dl>'; // dl elementinden class="row" kaldırıldı
                items.forEach(item => {
                    // dt ve dd'den col-sm-* sınıfları kaldırıldı, detail-item div'i eklendi
                    groupHtml += `<div class="detail-item">
                                     <dt>${item.label}:</dt>
                                     <dd>${item.value}</dd>
                                 </div>`;
                });
                groupHtml += '</dl>';
            }
            if (customHtmlContent) {
                groupHtml += `<div class="mt-2">${customHtmlContent}</div>`;
            }
            groupHtml += '   </div>\n                      </div>';
            return groupHtml;
        }

        // Diğer event listener'lar ve fonksiyonlar burada kalacak (savePayment, updateClient, openEditModal, deletePayment, generateStats vb.)
        window.savePayment = savePayment;
        window.updateClient = updateClient;
        window.openEditModal = openEditModal;
        window.deletePayment = deletePayment;
        // generateStats ve ilgili fonksiyonlar burada tanımlı olmalı
        // ...

        // Ödeme düzenlemesi tamamlandıktan sonra tekrar detay modalını açmak için
        async function updateClient(client_id) {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            
            // Form verilerini JSON'a dönüştür
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'amount') {
                    // Tutar alanında TL, € veya $ sembollerini ve binlik ayırıcıları kaldır
                    data[key] = value.replace(/[^\d,.]/g, '').replace(/\./g, '').replace(',', '.');
                } else {
                    data[key] = value;
                }
            });

            // Ödeme durumunu manuel olarak al ve ekle
            const editStatusCheckbox = document.getElementById('editStatus');
            if (editStatusCheckbox) {
                data['status'] = editStatusCheckbox.checked ? 'Ödendi' : 'Ödenmedi';
            }
            
            try {
                const response = await fetch(`/update_client/${client_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Düzenleme modalını kapat
                    closeModal();
                    
                    // İlgili satırı güncelle
                    let row = document.querySelector(`tr[data-client-id="${client_id}"]`);
                    if (!row) {
                        // data-client-id bulunamadıysa data-id'yi dene
                        row = document.querySelector(`tr[data-id="${client_id}"]`);
                    }
                    
                    if (row) {
                        row.querySelector('td:nth-child(1)').textContent = data.name;
                        row.querySelector('td:nth-child(2)').textContent = data.surname;
                        row.querySelector('td:nth-child(3)').textContent = data.tc;
                        
                        // Para birimini belirle
                        let currencySymbol = '';
                        if (data.currency === 'TL') currencySymbol = 'TL';
                        else if (data.currency === 'USD') currencySymbol = 'USD';
                        else if (data.currency === 'EUR') currencySymbol = 'EUR';
                        
                        row.querySelector('td:nth-child(4)').textContent = `${parseFloat(data.amount).toFixed(1)} ${currencySymbol}`;
                        row.querySelector('td:nth-child(5)').textContent = data.installments;
                        
                        // Durum güncelleme
                        const statusCell = row.querySelector('td:nth-child(8)');
                        if (statusCell) {
                            const statusButton = statusCell.querySelector('button');
                            if (statusButton) {
                                if (data.status === 'Ödendi') {
                                    statusButton.className = 'odendi-btn';
                                    statusButton.textContent = 'Ödendi';
                                } else {
                                    statusButton.className = 'odenmedi-btn';
                                    statusButton.textContent = 'Ödenmedi';
                                }
                            }
                        }
                    }
                    
                    // Başarı mesajı göster
                    alert('Müvekkil bilgileri güncellendi');
                    
                    // Sayfa yenilenmeden detay modalını aç
                    setTimeout(() => {
                        const viewBtn = document.querySelector(`.view-btn[data-payment-id="${client_id}"]`);
                        if (viewBtn) {
                            viewBtn.click();
                        }
                    }, 500); // Kısa bir gecikme ekleyerek UI'nin güncellenmesine zaman tanıyoruz
                    
                } else {
                    alert('Hata: ' + (result.error || 'Güncelleme sırasında bir hata oluştu'));
                }
            } catch (error) {
                console.error('Güncelleme hatası:', error);
                alert('Hata: Sunucu iletişim hatası');
            }
        }

        // Modal kapatma fonksiyonu
        function closeModal() {
            // Normal modalı kapat
            const editModalElement = document.getElementById('editModal');
            if (editModalElement) {
                editModalElement.style.display = 'none';
            }
            
            // Bootstrap modalını kapat
            const detailModalElement = document.getElementById('paymentDetailModal');
            if (detailModalElement) {
                const detailModalInstance = bootstrap.Modal.getInstance(detailModalElement);
                if (detailModalInstance) {
                    detailModalInstance.hide();
                }
            }
        }

    </script>

    <!-- YENİ ÖDEME DETAY MODALI -->
    <div class="modal fade" id="paymentDetailModal" tabindex="-1" aria-labelledby="paymentDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentDetailModalLabel">Ödeme Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
                </div>
                <div class="modal-body" id="odemeDetayModalBody">
                    <!-- İçerik JavaScript ile doldurulacak -->
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="detailsEditBtn">Düzenle</button>
                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}