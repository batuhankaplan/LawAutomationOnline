{% extends "layout.html" %}

{% block title %}Ödemeler{% endblock %}

{% block content %}
    <!-- Chart.js kütüphanesi -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

    <!-- jQuery (Select2 için gerekli) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <div class="table-container">
        <div class="table-header">
            <h2>Müvekkil Ödeme Kayıtları</h2>
            <div style="display: flex; gap: 10px;">
                {% if current_user.has_permission('odeme_ekle') %}
                <button id="addPaymentBtn" class="modern-add-btn" title="Yeni Ödeme Ekle">
                    <i class="material-icons">add</i>
                    Yeni Ödeme Ekle
                </button>
                {% endif %}
            {% if current_user.has_permission('odeme_istatistik_goruntule') %}
            <button id="statsButton" class="stats-btn" title="İstatistikleri Görüntüle" style="background-color: #1565C0;">
                <i class="material-icons">insert_chart</i>
            </button>
            {% endif %}
            {% if current_user.has_permission('odeme_goruntule') %}
            <button id="exportButton" class="stats-btn" title="Ödeme Kayıtlarını Dışa Aktar" style="background-color: #4CAF50;">
                <i class="material-icons">file_download</i>
            </button>
            {% endif %}
            </div>
        </div>

        <!-- Filtreleme Bölümü -->
        <div class="filter-section" style="background: white; padding: 16px 20px; border-radius: 8px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.08);">
            <div style="display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end;">
                <!-- Kişi/Kurum Filtresi -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #555;">
                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">business</i>
                        Kişi/Kurum
                    </label>
                    <select id="filterEntityType" class="form-control" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                        <option value="all">Tümü</option>
                        <option value="person">Kişi</option>
                        <option value="company">Kurum</option>
                    </select>
                </div>

                <!-- Ödeme Durumu Filtresi -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #555;">
                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">payment</i>
                        Ödeme Durumu
                    </label>
                    <select id="filterPaymentStatus" class="form-control" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd;">
                        <option value="all">Tümü</option>
                        <option value="paid">Ödendi</option>
                        <option value="unpaid">Ödenmedi</option>
                    </select>
                </div>

                <!-- Kayıtlı Müvekkil Filtresi -->
                <div style="flex: 2; min-width: 250px;">
                    <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 500; color: #555;">
                        <i class="material-icons" style="font-size: 16px; vertical-align: middle; margin-right: 4px;">contacts</i>
                        Kayıtlı Müvekkil
                    </label>
                    <select id="filterRegisteredClient" class="form-control" style="width: 100%;">
                        <option value="">Tüm Müvekkiller</option>
                    </select>
                </div>

                <!-- Filtreleri Temizle Butonu -->
                <div>
                    <button id="clearFiltersBtn" class="btn" style="padding: 8px 16px; background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%); border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px; font-weight: 500; color: #555; transition: all 0.3s ease;">
                        <i class="material-icons" style="font-size: 18px;">clear_all</i>
                        Temizle
                    </button>
                </div>
            </div>
        </div>

        <table class="data-table modern-table">
            <thead class="modern-header">
                <tr>
                    <th id="sort-payment-type" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">category</i>
                            <span>Ödeme Türü</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-name" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">person</i>
                            <span>Ad</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-surname" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">person_outline</i>
                            <span>Soyad</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-tc" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">badge</i>
                            <span>TC Kimlik No</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-amount" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">payments</i>
                            <span>Tutar</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-installments" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">schedule</i>
                            <span>Taksit Sayısı</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-registration-date" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">event</i>
                            <span>Borç Tarihi</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-due-date" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">event_note</i>
                            <span>Son Ödeme Tarihi</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-payment-date" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">event_available</i>
                            <span>Ödeme Tarihi</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th id="sort-status" class="sortable-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">info</i>
                            <span>Durum</span>
                            <i class="material-icons sort-icon">unfold_more</i>
                        </div>
                    </th>
                    <th class="action-header">
                        <div class="header-content">
                            <i class="material-icons text-secondary me-1">settings</i>
                            <span>İşlemler</span>
                        </div>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr data-client-id="{{ client.id }}"
                    data-description="{{ client.description }}"
                    data-payment-type="{{ client.payment_type if client.payment_type else '' }}"
                    data-entity-type="{{ client.entity_type }}"
                    data-status="{{ client.status }}"
                    data-payment-client-id="{{ client.payment_client_id if client.payment_client_id else '' }}"
                    data-amount="{{ client.amount }}"
                    data-currency="{{ client.currency }}">
                    <td contenteditable="false">
                        {% if client.payment_type %}
                            {% set type_class = '' %}
                            {% if client.payment_type == 'Aylık Danışmanlık Ücreti' %}
                                {% set type_class = 'payment-type-aylik-danismanlik' %}
                            {% elif 'Danışma' in client.payment_type %}
                                {% set type_class = 'payment-type-danisma' %}
                            {% elif 'İhtarname' in client.payment_type %}
                                {% set type_class = 'payment-type-ihtarname' %}
                            {% elif 'Dilekçe' in client.payment_type %}
                                {% set type_class = 'payment-type-dilekce' %}
                            {% elif 'Dosya' in client.payment_type %}
                                {% set type_class = 'payment-type-dosya' %}
                            {% elif 'Sözleşme' in client.payment_type %}
                                {% set type_class = 'payment-type-sozlesme' %}
                            {% elif 'Mahkeme' in client.payment_type %}
                                {% set type_class = 'payment-type-mahkeme' %}
                            {% elif 'Diğer' in client.payment_type %}
                                {% set type_class = 'payment-type-diger' %}
                            {% endif %}
                            <span class="payment-type-badge {{ type_class }}">{{ client.payment_type }}</span>
                        {% else %}
                            <span class="payment-type-badge-empty">-</span>
                        {% endif %}
                    </td>
                    <td contenteditable="false">{{ client.name }}</td>
                    <td contenteditable="false">{{ client.surname if client.surname else '' }}</td>
                    <td contenteditable="false">{{ client.tc if client.tc else '-' }}</td>
                    <td contenteditable="false">{{ "{:,.2f}".format(client.amount).replace(',', 'X').replace('.', ',').replace('X', '.') }} {{ client.currency }}</td>
                    <td contenteditable="false">{{ client.installments if client.installments and client.installments > 0 else '-' }}</td>
                    <td contenteditable="false">{{ client.registration_date.strftime('%d.%m.%Y') if client.registration_date else '-' }}</td>
                    <td contenteditable="false">{{ client.due_date.strftime('%d.%m.%Y') if client.due_date else '-' }}</td>
                    <td contenteditable="false">{{ client.payment_date.strftime('%d.%m.%Y') if client.payment_date else '-' }}</td>
                    <td>
                        {% if client.status == 'Ödendi' %}
                            <span class="status-badge status-paid">Ödendi</span>
                        {% else %}
                            <span class="status-badge status-unpaid">Ödenmedi</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="view-btn" title="Detayları Görüntüle" 
                                    data-payment-id="{{ client.id }}">
                                <i class="material-icons">visibility</i>
                            </button>
                            {% if current_user.has_permission('odeme_sil') %}
                            <button class="delete-btn" onclick="deletePayment(this)">
                                <i class="material-icons">delete</i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Ödeme Kayıtları Dışa Aktarma Modalı -->
    <div id="exportModal" class="modal">
        <div class="modal-content modern-edit-modal" style="max-width: 650px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header modern-edit-header" style="position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; padding: 20px 24px;">
                <div class="modal-title-container">
                    <h2 style="color: white; margin: 0; font-size: 20px; font-weight: 600;">Ödeme Kayıtları Tablosu Oluştur</h2>
                </div>
                <span class="close" id="closeExportModal" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer; transition: all 0.3s ease;">&times;</span>
            </div>
            <form id="exportForm" style="padding: 20px;">
                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group" style="width: 100%;">
                        <label for="exportFormat">Dosya Formatı</label>
                        <select id="exportFormat" name="format" class="form-control" required>
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group" style="width: 100%;">
                        <label for="exportEntityFilter">Kişi/Kurum Filtresi</label>
                        <select id="exportEntityFilter" name="entity_filter" class="form-control" required>
                            <option value="all">Tümü (Kişi + Kurum)</option>
                            <option value="person">Sadece Kişi</option>
                            <option value="company">Sadece Kurum</option>
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 16px;">
                    <div class="form-group" style="width: 100%;">
                        <label for="exportFilterType">Filtreleme Tipi</label>
                        <select id="exportFilterType" name="filter_type" class="form-control" required>
                            <option value="date_range">Tarih Aralığı</option>
                            <option value="specific_client">Belirli Müvekkil/Kurum</option>
                            <option value="all_records">Tüm Kayıtlar</option>
                        </select>
                    </div>
                </div>

                <div id="exportDateRangeGroup" class="form-row" style="margin-bottom: 16px; display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="exportStartDate">Başlangıç Tarihi</label>
                        <input type="date" id="exportStartDate" name="start_date" class="form-control">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="exportEndDate">Bitiş Tarihi</label>
                        <input type="date" id="exportEndDate" name="end_date" class="form-control">
                    </div>
                </div>

                <div id="exportClientGroup" class="form-row" style="display: none; margin-bottom: 16px;">
                    <div class="form-group" style="width: 100%;">
                        <label for="exportClientSelect">Müvekkil/Kurum Seçin</label>
                        <select id="exportClientSelect" name="client_id" class="form-control">
                            <option value="">Seçiniz...</option>
                            {% for client in clients %}
                            <option value="{{ client.id }}">
                                {{ client.name }} {% if client.surname and client.surname != '-' %}{{ client.surname }}{% endif %}
                                {% if client.entity_type == 'company' %}(Kurum){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 12px;">
                    <div class="form-group" style="width: 100%;">
                        <label>
                            <input type="checkbox" id="exportIncludeInstallments" name="include_installments" checked>
                            Taksit Detaylarını Dahil Et
                        </label>
                    </div>
                </div>

                <div class="form-row" style="margin-bottom: 20px;">
                    <div class="form-group" style="width: 100%;">
                        <label>
                            <input type="checkbox" id="exportIncludePaymentDates" name="include_payment_dates" checked>
                            Ödeme Tarihlerini Dahil Et
                        </label>
                    </div>
                </div>

                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                    <button type="button" class="btn btn-secondary" id="cancelExportBtn">İptal</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="material-icons">download</i> Oluştur ve İndir
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Yeni Ödeme Ekle Modalı -->
    <div id="addPaymentModal" class="modal">
        <div class="modal-content modern-edit-modal">
            <div class="modal-header modern-edit-header">
                <div class="modal-title-container">
                    <h2>Yeni Ödeme Ekle</h2>
                </div>
                <span class="close modern-edit-close" id="closeAddPaymentModal">&times;</span>
            </div>
            <form id="addPaymentForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body modern-edit-body">
                    <!-- Müvekkil Seçim Tipi -->
                    <div class="form-row" style="margin-bottom: 24px;">
                        <div class="client-type-selector">
                            <button type="button" class="client-type-btn active" data-type="new" id="newClientBtn">
                                <i class="material-icons">person_add</i>
                                <span>Yeni Müvekkil</span>
                            </button>
                            <button type="button" class="client-type-btn" data-type="registered" id="registeredClientBtn">
                                <i class="material-icons">contacts</i>
                                <span>Kayıtlı Müvekkil</span>
                            </button>
                        </div>
                    </div>

                    <!-- Kayıtlı Müvekkil Dropdown -->
                    <div id="registeredClientSection" class="form-row" style="display: none; margin-bottom: 20px;">
                        <div class="form-group full-width">
                            <label for="registeredClientSelect">Kayıtlı Müvekkil Seçin</label>
                            <select id="registeredClientSelect" class="form-control" style="width: 100%;">
                                <option value="">Müvekkil seçiniz veya arayın...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Ödeme Türü - Her zaman görünür -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="paymentType">Ödeme Türü</label>
                            <select id="paymentType" name="payment_type" class="form-control" required>
                                <option value="">Ödeme türü seçiniz</option>
                                <option value="Danışma Ücreti">Danışma Ücreti</option>
                                <option value="Aylık Danışmanlık Ücreti">Aylık Danışmanlık Ücreti</option>
                                <option value="İhtarname Ücreti">İhtarname Ücreti</option>
                                <option value="Dilekçe Ücreti">Dilekçe Ücreti</option>
                                <option value="Dosya Masrafı">Dosya Masrafı</option>
                                <option value="Sözleşme Vekalet Ücreti">Sözleşme Vekalet Ücreti</option>
                                <option value="Yasal Mahkeme Vekalet Ücreti">Yasal Mahkeme Vekalet Ücreti</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                    </div>

                    <!-- Müvekkil Bilgileri - Kayıtlı müvekkil seçildiğinde disabled, yeni müvekkilde editable -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="addEntityType">Kişi/Kurum</label>
                            <select id="addEntityType" name="entity_type" class="form-control" required>
                                <option value="person">Kişi</option>
                                <option value="company">Kurum</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="addNameSurnameRow">
                        <div class="form-group" id="addNameGroup">
                            <label for="addName" id="addNameLabel">Ad</label>
                            <input type="text" id="addName" name="name" class="form-control" required>
                        </div>
                        <div class="form-group" id="addSurnameGroup">
                            <label for="addSurname" id="addSurnameLabel">Soyad</label>
                            <input type="text" id="addSurname" name="surname" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group tc-group">
                            <label for="addTc" id="addTcLabel">TC Kimlik No (İsteğe Bağlı)</label>
                            <input type="text" id="addTc" name="tc" class="form-control" maxlength="20">
                        </div>
                    </div>

                    <!-- Ödeme Detayları - Her zaman görünür -->
                    <div class="form-row">
                        <div class="form-group amount-group">
                            <label for="addAmount">Tutar</label>
                            <div class="amount-input">
                                <input type="number" id="addAmount" name="amount" class="form-control amount-input-field" required placeholder="0" step="0.01" min="0">
                                <select id="addCurrency" name="currency" class="form-control currency-select" required>
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="addInstallments">Taksit Sayısı</label>
                            <select id="addInstallments" name="installments" class="form-control" required>
                                <option value="0">Taksit Yok</option>
                                {% for i in range(1, 13) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group date-group">
                            <label for="addRegistrationDate">Borç Kayıt Tarihi</label>
                            <input type="date" id="addRegistrationDate" name="registration_date" class="form-control" value="{{ today_date if today_date else '' }}">
                        </div>
                        <div class="form-group date-group">
                            <label for="addDueDate">Son Ödeme Tarihi (İsteğe Bağlı)</label>
                            <input type="date" id="addDueDate" name="due_date" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ödeme Durumu</label>
                            <div class="toggle-container">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="addStatus" name="status">
                                    <label for="addStatus"></label>
                                </div>
                                <span class="status-text-add">Ödenmedi</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row" id="addPaymentDateRow" style="display: none;">
                        <div class="form-group date-group">
                            <label for="addPaymentDate">Ödeme Tarihi</label>
                            <input type="date" id="addPaymentDate" name="payment_date" class="form-control" value="{{ today_date if today_date else '' }}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="addDescription">Açıklama (İsteğe Bağlı)</label>
                            <div class="textarea-container">
                                <textarea id="addDescription" name="description" class="form-control" rows="3" placeholder="Açıklama giriniz"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Kayıtlı Müvekkile Ekle Seçeneği - Sadece Yeni Müvekkil modunda görünür -->
                    <div id="saveToRegisteredSection" class="form-row" style="margin-top: 16px;">
                        <div class="form-group full-width" style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="saveToRegistered" name="save_to_registered" style="width: auto; margin: 0;">
                            <label for="saveToRegistered" style="margin: 0; font-weight: 500; cursor: pointer;">Bu müvekkili kayıtlı müvekkillere ekle</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modern-edit-footer">
                    <button type="submit" class="btn modern-save-btn" id="saveAddPaymentBtn">
                        <i class="material-icons">save</i>
                        Kaydet
                    </button>
                    <button type="button" class="btn modern-cancel-btn" id="cancelAddPaymentBtn">
                        <i class="material-icons">close</i>
                        Kapat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Düzenleme Modalı -->
    <div id="editModal" class="modal">
        <div class="modal-content modern-edit-modal">
            <div class="modal-header modern-edit-header">
                <div class="modal-title-container">
                    <h2>Ödeme Düzenle</h2>
                </div>
                <span class="close modern-edit-close">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editClientId" name="editClientId">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body modern-edit-body">
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="editPaymentType">Ödeme Türü</label>
                            <select id="editPaymentType" name="payment_type" class="form-control" required>
                                <option value="">Ödeme türü seçiniz</option>
                                <option value="Danışma Ücreti">Danışma Ücreti</option>
                                <option value="Aylık Danışmanlık Ücreti">Aylık Danışmanlık Ücreti</option>
                                <option value="İhtarname Ücreti">İhtarname Ücreti</option>
                                <option value="Dilekçe Ücreti">Dilekçe Ücreti</option>
                                <option value="Dosya Masrafı">Dosya Masrafı</option>
                                <option value="Sözleşme Vekalet Ücreti">Sözleşme Vekalet Ücreti</option>
                                <option value="Yasal Mahkeme Vekalet Ücreti">Yasal Mahkeme Vekalet Ücreti</option>
                                <option value="Diğer">Diğer</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="editEntityType">Kişi/Kurum</label>
                            <select id="editEntityType" name="entity_type" class="form-control" required>
                                <option value="person">Kişi</option>
                                <option value="company">Kurum</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="editNameSurnameRow">
                        <div class="form-group" id="editNameGroup">
                            <label for="editName" id="editNameLabel">Ad</label>
                            <input type="text" id="editName" name="name" class="form-control" required>
                        </div>
                        <div class="form-group" id="editSurnameGroup">
                            <label for="editSurname" id="editSurnameLabel">Soyad</label>
                            <input type="text" id="editSurname" name="surname" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group tc-group">
                            <label for="editTc" id="editTcLabel">TC Kimlik No (İsteğe Bağlı)</label>
                            <input type="text" id="editTc" name="tc" class="form-control" maxlength="20">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group amount-group">
                            <label for="editAmount">Tutar</label>
                            <div class="amount-input">
                                <input type="number" id="editAmount" name="amount" class="form-control amount-input-field" required placeholder="0" step="0.01" min="0">
                                <select id="editCurrency" name="currency" class="form-control currency-select" required>
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editInstallments">Taksit Sayısı</label>
                            <select id="editInstallments" name="installments" class="form-control" required>
                                <option value="0">Taksit Yok</option>
                                {% for i in range(1, 13) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group date-group">
                            <label for="editRegistrationDate">Borç Kayıt Tarihi</label>
                            <input type="date" id="editRegistrationDate" name="registration_date" class="form-control">
                        </div>
                        <div class="form-group date-group">
                            <label for="editDueDate">Son Ödeme Tarihi (İsteğe Bağlı)</label>
                            <input type="date" id="editDueDate" name="due_date" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ödeme Durumu</label>
                            <div class="toggle-container">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="editStatus" name="status">
                                    <label for="editStatus"></label>
                                </div>
                                <span class="status-text">Ödenmedi</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row" id="editPaymentDateRow" style="display: none;">
                        <div class="form-group date-group">
                            <label for="editPaymentDate">Ödeme Tarihi</label>
                            <input type="date" id="editPaymentDate" name="payment_date" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDescription">Açıklama</label>
                            <div class="textarea-container">
                                <textarea id="editDescription" name="description" class="form-control" rows="3" placeholder="Açıklama bulunmuyor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modern-edit-footer">
                    <button type="submit" class="btn modern-save-btn" id="saveEditBtn">
                        <i class="material-icons">save</i>
                        Kaydet
                    </button>
                    <button type="button" class="btn modern-cancel-btn">
                        <i class="material-icons">close</i>
                        Kapat
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- İstatistik Modalı -->
    <div id="statsModal" class="modal">
        <div class="modal-content stats-modal-content">
            <div class="modal-header">
                <h2>Ödeme İstatistikleri</h2>
                <span class="close" id="closeStatsModal">&times;</span>
            </div>
            <div class="modal-body">
                <div class="stats-tabs">
                    <button class="stats-tab-btn active" data-tab="summary"><i class="material-icons">dashboard</i> Özet</button>
                    <button class="stats-tab-btn" data-tab="entity-type"><i class="material-icons">business</i> Kişi/Kurum Analizi</button>
                    <button class="stats-tab-btn" data-tab="payment-dates"><i class="material-icons">event_available</i> Ödeme Tarih Analizi</button>
                    <button class="stats-tab-btn" data-tab="payment-type"><i class="material-icons">category</i> Ödeme Türü Analizi</button>
                    <button class="stats-tab-btn" data-tab="monthly"><i class="material-icons">date_range</i> Aylık Analiz</button>
                    <button class="stats-tab-btn" data-tab="yearly"><i class="material-icons">calendar_today</i> Yıllık Analiz</button>
                    <button class="stats-tab-btn" data-tab="status"><i class="material-icons">assignment</i> Durum Analizi</button>
                    <button class="stats-tab-btn" data-tab="currency"><i class="material-icons">currency_exchange</i> Para Birimi Analizi</button>
                    <button class="stats-tab-btn" data-tab="predictions"><i class="material-icons">analytics</i> Tahminler</button>
                </div>
                
                <div class="stats-content">
                    <!-- ÖZET SEKMESİ -->
                    <div class="stats-tab-content active" id="summary-tab">
                        <!-- Ana İstatistik Kartları (Büyük) -->
                        <div class="modern-stats-grid">
                            <div class="modern-stat-card primary">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper primary-bg">
                                        <i class="material-icons">account_balance_wallet</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Toplam Alacak</span>
                                        <span class="stat-badge">TL Bazlı</span>
                                    </div>
                                </div>
                                <div class="stat-value primary-text" id="totalAmount">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">info</i>
                                    <span>Tüm ödeme kayıtlarının toplamı</span>
                                </div>
                            </div>

                            <div class="modern-stat-card success">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper success-bg">
                                        <i class="material-icons">check_circle</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Tahsil Edilen</span>
                                        <span class="stat-badge">Ödendi</span>
                                    </div>
                                </div>
                                <div class="stat-value success-text" id="totalPaid">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">trending_up</i>
                                    <span id="paidPercentageText">%0</span>
                                </div>
                            </div>

                            <div class="modern-stat-card warning">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper warning-bg">
                                        <i class="material-icons">pending</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Bekleyen Tahsilat</span>
                                        <span class="stat-badge">Ödenmedi</span>
                                    </div>
                                </div>
                                <div class="stat-value warning-text" id="totalUnpaid">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">schedule</i>
                                    <span id="unpaidPercentageText">%0</span>
                                </div>
                            </div>

                            <div class="modern-stat-card info">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper info-bg">
                                        <i class="material-icons">groups</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Toplam Müvekkil</span>
                                        <span class="stat-badge">Aktif</span>
                                    </div>
                                </div>
                                <div class="stat-value info-text" id="clientCount">0</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">person_add</i>
                                    <span>Kayıtlı müvekkil sayısı</span>
                                </div>
                            </div>
                        </div>

                        <!-- Detay Kartları (Simetrik 3+3 Düzen) -->
                        <div class="detail-stats-grid-top">
                            <div class="detail-stat-card">
                                <div class="detail-icon purple-bg">
                                    <i class="material-icons">event_available</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">Gelecek Yıl Beklenen</span>
                                    <span class="detail-value" id="expectedNextYear">0 TL</span>
                                </div>
                            </div>

                            <div class="detail-stat-card">
                                <div class="detail-icon orange-bg">
                                    <i class="material-icons">star</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">En Yüksek Ödeme</span>
                                    <span class="detail-value" id="highestPaymentInfo">-</span>
                                </div>
                            </div>

                            <div class="detail-stat-card">
                                <div class="detail-icon red-bg">
                                    <i class="material-icons">warning</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">Vadesi Geçmiş</span>
                                    <span class="detail-value" id="overdueCount">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="detail-stats-grid-bottom">
                            <div class="detail-stat-card">
                                <div class="detail-icon teal-bg">
                                    <i class="material-icons">format_list_numbered</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">Ort. Taksit Sayısı</span>
                                    <span class="detail-value" id="avgInstallmentInfo">0 / 0</span>
                                </div>
                            </div>

                            <div class="detail-stat-card">
                                <div class="detail-icon indigo-bg">
                                    <i class="material-icons">attach_money</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">USD Bakiye</span>
                                    <span class="detail-value" id="totalAmountUSD">0 USD</span>
                                    <span class="detail-subvalue" id="totalAmountUSDinTL">≈ 0 TL</span>
                                </div>
                            </div>

                            <div class="detail-stat-card">
                                <div class="detail-icon blue-bg">
                                    <i class="material-icons">euro_symbol</i>
                                </div>
                                <div class="detail-content">
                                    <span class="detail-label">EUR Bakiye</span>
                                    <span class="detail-value" id="totalAmountEUR">0 EUR</span>
                                    <span class="detail-subvalue" id="totalAmountEURinTL">≈ 0 TL</span>
                                </div>
                            </div>
                        </div>

                        <!-- Ödeme Durumu Grafiği -->
                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">pie_chart</i> Ödeme Durumu Dağılımı</h3>
                            </div>
                            <div class="status-summary">
                                <div class="status-card paid">
                                    <div class="status-card-title">Ödenmiş Alacaklar</div>
                                    <div class="status-card-value" id="paidPercentage">0%</div>
                                    <div class="status-card-percentage" id="paidClients">0 Müvekkil</div>
                                </div>
                                <div class="status-card unpaid">
                                    <div class="status-card-title">Ödenmemiş Alacaklar</div>
                                    <div class="status-card-value" id="unpaidPercentage">0%</div>
                                    <div class="status-card-percentage" id="unpaidClients">0 Müvekkil</div>
                                </div>
                                <div class="status-card overdue">
                                    <div class="status-card-title">Vadesi Geçmiş Ödemeler</div>
                                    <div class="status-card-value" id="overduePercentage">0%</div>
                                    <div class="status-card-percentage" id="overdueAmount">0 TL</div>
                                </div>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="summaryChart"></canvas>
                            </div>
                            <!-- Ödeme Durumu Detay Tablosu -->
                            <h4 class="table-title" style="margin-top: 20px;"><i class="material-icons">table_chart</i> Durum Detay Tablosu</h4>
                            <div class="detail-table-container">
                                <table class="modern-table" style="width: 100%; margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Para Birimi</th>
                                            <th>Ödenen Tutar</th>
                                            <th>Ödenmemiş Tutar</th>
                                            <th>Vadesi Geçmiş</th>
                                            <th>Toplam</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentStatusTableBody">
                                        <!-- JavaScript ile doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Yıllara Göre Beklenen Ödemeler Tablosu -->
                        <div class="summary-extra-info">
                            <h4>Yıllara Göre Beklenen Ödemeler (Ödenmemiş)</h4>
                            <div id="expectedPaymentsByYearTableContainer">
                                <canvas id="expectedPaymentsByYearChart" class="chart-canvas"></canvas>
                            </div>
                            <!-- Beklenen Ödemeler Detay Tablosu -->
                            <h4 class="table-title" style="margin-top: 20px;"><i class="material-icons">table_chart</i> Yıllık Beklenen Ödemeler Detay</h4>
                            <div class="detail-table-container">
                                <table class="modern-table" style="width: 100%; margin-top: 10px;">
                                    <thead>
                                        <tr>
                                            <th>Yıl</th>
                                            <th>TL</th>
                                            <th>USD</th>
                                            <th>EUR</th>
                                            <th>Toplam (TL Karşılığı)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="expectedPaymentsByYearTableBody">
                                        <!-- JavaScript ile doldurulacak -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Döviz Kuru Notu -->
                        <div class="exchange-rate-note">
                            <div class="note-icon">
                                <i class="material-icons">info</i>
                            </div>
                            <div class="note-content">
                                <strong>Döviz Kurları:</strong>
                                <span id="exchangeRateInfo">USD ve EUR döviz kurları yükleniyor...</span>
                            </div>
                        </div>
                    </div>

                    <!-- KİŞİ/KURUM ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="entity-type-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">business</i> Kişi/Kurum Analizi</h3>
                        </div>
                        
                        <div class="modern-stats-grid">
                            <div class="modern-stat-card primary">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper primary-bg">
                                        <i class="material-icons">person</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Kişi Ödemeleri</span>
                                        <span class="stat-badge">Toplam</span>
                                    </div>
                                </div>
                                <div class="stat-value primary-text" id="personTotalAmount">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">people</i>
                                    <span id="personCountText">0 kişi</span>
                                </div>
                            </div>

                            <div class="modern-stat-card success">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper success-bg">
                                        <i class="material-icons">business</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Kurum Ödemeleri</span>
                                        <span class="stat-badge">Toplam</span>
                                    </div>
                                </div>
                                <div class="stat-value success-text" id="companyTotalAmount">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">domain</i>
                                    <span id="companyCountText">0 kurum</span>
                                </div>
                            </div>

                            <div class="modern-stat-card warning">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper warning-bg">
                                        <i class="material-icons">check_circle</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Kişi - Ödendi</span>
                                        <span class="stat-badge">Tahsil</span>
                                    </div>
                                </div>
                                <div class="stat-value warning-text" id="personPaidAmount">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">trending_up</i>
                                    <span id="personPaidPercentageText">%0</span>
                                </div>
                            </div>

                            <div class="modern-stat-card info">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper info-bg">
                                        <i class="material-icons">verified</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Kurum - Ödendi</span>
                                        <span class="stat-badge">Tahsil</span>
                                    </div>
                                </div>
                                <div class="stat-value info-text" id="companyPaidAmount">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">trending_up</i>
                                    <span id="companyPaidPercentageText">%0</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="margin-top: 20px;">
                            <canvas id="entityTypeChart"></canvas>
                        </div>
                    </div>

                    <!-- ÖDEME TARİH ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="payment-dates-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">event_available</i> Ödeme Tarihleri Analizi</h3>
                        </div>
                        
                        <div class="modern-stats-grid">
                            <div class="modern-stat-card primary">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper primary-bg">
                                        <i class="material-icons">event_available</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Bu Ay Yapılan Ödemeler</span>
                                        <span class="stat-badge">Güncel</span>
                                    </div>
                                </div>
                                <div class="stat-value primary-text" id="thisMonthPayments">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">calendar_today</i>
                                    <span id="thisMonthCountText">0 ödeme</span>
                                </div>
                            </div>

                            <div class="modern-stat-card success">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper success-bg">
                                        <i class="material-icons">date_range</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Bu Yıl Yapılan Ödemeler</span>
                                        <span class="stat-badge">Yıllık</span>
                                    </div>
                                </div>
                                <div class="stat-value success-text" id="thisYearPayments">0 TL</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">event</i>
                                    <span id="thisYearCountText">0 ödeme</span>
                                </div>
                            </div>

                            <div class="modern-stat-card warning">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper warning-bg">
                                        <i class="material-icons">history</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">Ortalama Ödeme Süresi</span>
                                        <span class="stat-badge">Analiz</span>
                                    </div>
                                </div>
                                <div class="stat-value warning-text" id="avgPaymentDuration">0 gün</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">schedule</i>
                                    <span>Kayıt - Ödeme arası</span>
                                </div>
                            </div>

                            <div class="modern-stat-card info">
                                <div class="stat-card-header">
                                    <div class="stat-icon-wrapper info-bg">
                                        <i class="material-icons">speed</i>
                                    </div>
                                    <div class="stat-info">
                                        <span class="stat-label">En Hızlı Ödeme</span>
                                        <span class="stat-badge">Rekor</span>
                                    </div>
                                </div>
                                <div class="stat-value info-text" id="fastestPayment">0 gün</div>
                                <div class="stat-footer">
                                    <i class="material-icons tiny">flash_on</i>
                                    <span id="fastestPaymentClient">-</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="margin-top: 20px;">
                            <canvas id="paymentDatesChart"></canvas>
                        </div>
                    </div>

                    <!-- ÖDEME TÜRÜ ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="payment-type-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">category</i> Ödeme Türüne Göre Gelir Analizi</h3>
                        </div>

                        <!-- Ödeme Türü Kartları -->
                        <div class="payment-type-cards-grid" id="paymentTypeCardsContainer">
                            <!-- Kartlar JavaScript ile eklenecek -->
                        </div>

                        <!-- Ödeme Türü Grafikleri -->
                        <div class="payment-type-charts">
                            <div class="chart-section">
                                <h4 class="chart-subtitle"><i class="material-icons">pie_chart</i> Toplam Gelir Dağılımı</h4>
                                <div class="chart-container medium-chart">
                                    <canvas id="paymentTypeTotalChart"></canvas>
                                </div>
                            </div>
                            <div class="chart-section">
                                <h4 class="chart-subtitle"><i class="material-icons">bar_chart</i> Ödenen vs Beklenen</h4>
                                <div class="chart-container medium-chart">
                                    <canvas id="paymentTypeStatusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Detay Tablosu -->
                        <h3 class="table-title"><i class="material-icons">table_chart</i> Ödeme Türü Detay Tablosu</h3>
                        <div class="detail-table-container" id="paymentTypeTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <!-- AYLIK ANALİZ SEKMESİ -->
                    <div class="stats-tab-content" id="monthly-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">date_range</i> Aylık Ödeme Analizi</h3>
                            <div class="chart-filters">
                                <div class="entity-filter-checkboxes">
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="monthlyPersonFilter" checked>
                                        <span>Kişi</span>
                                    </label>
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="monthlyCompanyFilter" checked>
                                        <span>Kurum</span>
                                    </label>
                                </div>
                                <select id="monthlyYearFilter" class="chart-filter">
                                    <!-- Yıllar JavaScript ile eklenecek -->
                                </select>
                                <select id="monthlyCurrencyFilter" class="chart-filter">
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="ALL">Tüm Para Birimleri</option>
                                </select>
                            </div>
                        </div>

                        <div class="monthly-distribution">
                            <div class="chart-container medium-chart">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Ayı</div>
                                    <div class="data-card-value" id="highestMonth">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Düşük Ay</div>
                                    <div class="data-card-value" id="lowestMonth">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Aylık Ortalama</div>
                                    <div class="data-card-value" id="monthlyAverage">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Toplam Tahsilat</div>
                                    <div class="data-card-value" id="monthlyTotalCollection">0 TL</div>
                                </div>
                            </div>
                        </div>
                        
                        <h3 class="table-title"><i class="material-icons">table_chart</i> Aylık Detay Tablosu</h3>
                        <div class="detail-table-container" id="monthlyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>
                    
                    <!-- YILLIK ANALİZ SEKMESİ -->
                    <div class="stats-tab-content" id="yearly-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">calendar_today</i> Yıllık Ödeme Analizi</h3>
                            <div class="chart-filters">
                                <div class="entity-filter-checkboxes">
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="yearlyPersonFilter" checked>
                                        <span>Kişi</span>
                                    </label>
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="yearlyCompanyFilter" checked>
                                        <span>Kurum</span>
                                    </label>
                                </div>
                                <select id="yearlyCurrencyFilter" class="chart-filter">
                                    <option value="TL">TL</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="ALL">Tüm Para Birimleri</option>
                                </select>
                                <select id="yearlyChartType" class="chart-filter">
                                    <option value="bar">Sütun Grafik</option>
                                    <option value="line">Çizgi Grafik</option>
                                    <option value="area">Alan Grafik</option>
                                </select>
                            </div>
                        </div>

                        <div class="yearly-distribution">
                            <div class="chart-container medium-chart">
                                <canvas id="yearlyChart"></canvas>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Yıl</div>
                                    <div class="data-card-value" id="highestYear">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Yıllık Ortalama</div>
                                    <div class="data-card-value" id="yearlyAverage">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Son Yıl Artış</div>
                                    <div class="data-card-value" id="yearlyGrowth">0%</div>
                                    <div class="trend-indicator">
                                        <i class="material-icons trend-positive">trending_up</i>
                                        <span>Önceki yıla göre</span>
                                    </div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Gelecek Yıl Tahmin</div>
                                    <div class="data-card-value" id="nextYearForecast">0 TL</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Yıllık Detay Tablosu</h3>
                        <div class="detail-table-container" id="yearlyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>
                    
                    <!-- DURUM ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="status-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">assignment</i> Ödeme Durumu Analizi</h3>
                            <div class="chart-filters">
                                <div class="entity-filter-checkboxes">
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="statusPersonFilter" checked>
                                        <span>Kişi</span>
                                    </label>
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="statusCompanyFilter" checked>
                                        <span>Kurum</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="status-summary">
                                <div class="status-card paid">
                                    <div class="status-card-title">Ödenmiş İşlemler</div>
                                    <div class="status-card-value" id="paidTransCount">0</div>
                                    <div class="status-card-percentage" id="paidTransPercentage">0%</div>
                                </div>
                                <div class="status-card unpaid">
                                    <div class="status-card-title">Ödenmemiş İşlemler</div>
                                    <div class="status-card-value" id="unpaidTransCount">0</div>
                                    <div class="status-card-percentage" id="unpaidTransPercentage">0%</div>
                                </div>
                                <div class="status-card overdue">
                                    <div class="status-card-title">Vadesi Geçmiş İşlemler</div>
                                    <div class="status-card-value" id="overdueTransCount">0</div>
                                    <div class="status-card-percentage" id="overdueTransPercentage">0%</div>
                                </div>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="statusChart"></canvas>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">hourglass_empty</i> Vade Durumu Analizi</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">Ortalama Vade Süresi</div>
                                    <div class="data-card-value" id="avgDueTime">0 Gün</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Yakın Ödemeler</div>
                                    <div class="data-card-value" id="nextDueCount">0 Ödeme</div>
                                    <div class="trend-indicator">
                                        <span id="nextDueDate">30 gün içinde</span>
                                    </div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Vadesi En Uzun Geçmiş</div>
                                    <div class="data-card-value" id="mostOverdueInfo">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Toplam Gecikme Süresi</div>
                                    <div class="data-card-value" id="totalOverdueDays">0 Gün</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Durum Özeti Tablosu</h3>
                        <div class="detail-table-container" id="statusTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <!-- PARA BİRİMİ ANALİZİ SEKMESİ -->
                    <div class="stats-tab-content" id="currency-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">currency_exchange</i> Para Birimi Analizi</h3>
                            <div class="chart-filters">
                                <div class="entity-filter-checkboxes">
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="currencyPersonFilter" checked>
                                        <span>Kişi</span>
                                    </label>
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="currencyCompanyFilter" checked>
                                        <span>Kurum</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="currency-distribution">
                            <div class="currency-chart">
                                <div class="chart-container medium-chart">
                                    <canvas id="currencyDistributionChart"></canvas>
                                </div>
                            </div>
                            <div class="currency-chart">
                                <div class="chart-container medium-chart">
                                    <canvas id="currencyStatusChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">assessment</i> Para Birimi Karşılaştırması</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">TL İşlem Sayısı</div>
                                    <div class="data-card-value" id="tryTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">USD İşlem Sayısı</div>
                                    <div class="data-card-value" id="usdTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">EUR İşlem Sayısı</div>
                                    <div class="data-card-value" id="eurTransactionCount">0</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Sık Kullanılan</div>
                                    <div class="data-card-value" id="mostUsedCurrency">-</div>
                                </div>
                            </div>
                        </div>

                        <h3 class="table-title"><i class="material-icons">table_chart</i> Para Birimi Detay Tablosu</h3>
                        <div class="detail-table-container" id="currencyTableContainer">
                            <!-- Tablo JavaScript ile eklenecek -->
                        </div>
                    </div>

                    <!-- TAHMİNLER SEKMESİ -->
                    <div class="stats-tab-content" id="predictions-tab">
                        <div class="analysis-header">
                            <h3 class="analysis-title"><i class="material-icons">analytics</i> Gelecek Tahminleri ve Analizler</h3>
                            <div class="chart-filters">
                                <div class="entity-filter-checkboxes">
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="predictionsPersonFilter" checked>
                                        <span>Kişi</span>
                                    </label>
                                    <label class="filter-checkbox">
                                        <input type="checkbox" id="predictionsCompanyFilter" checked>
                                        <span>Kurum</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="payment-predictions">
                            <h3 class="prediction-title"><i class="material-icons">trending_up</i> Ödeme Tahminleri</h3>
                            <div class="prediction-items">
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 30 Gün</div>
                                    <div class="prediction-value" id="prediction30Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 90 Gün</div>
                                    <div class="prediction-value" id="prediction90Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 180 Gün</div>
                                    <div class="prediction-value" id="prediction180Days">0 TL</div>
                                </div>
                                <div class="prediction-item">
                                    <div class="prediction-label">Sonraki 365 Gün</div>
                                    <div class="prediction-value" id="prediction365Days">0 TL</div>
                                </div>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">show_chart</i> Tahsilat Trendi</h3>
                            </div>
                            <div class="chart-container medium-chart">
                                <canvas id="collectionTrendChart"></canvas>
                            </div>
                        </div>

                        <div class="analysis-section">
                            <div class="analysis-header">
                                <h3 class="analysis-title"><i class="material-icons">compare_arrows</i> Müvekkil Başına Ödeme</h3>
                            </div>
                            <div class="data-cards-container">
                                <div class="data-card">
                                    <div class="data-card-title">Müvekkil Başına Ortalama</div>
                                    <div class="data-card-value" id="avgPerClient">0 TL</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Yüksek Müvekkil</div>
                                    <div class="data-card-value" id="highestClientValue">0 TL</div>
                                    <div class="trend-indicator" id="highestClientName">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">En Düşük Müvekkil</div>
                                    <div class="data-card-value" id="lowestClientValue">0 TL</div>
                                    <div class="trend-indicator" id="lowestClientName">-</div>
                                </div>
                                <div class="data-card">
                                    <div class="data-card-title">Müvekkil Varyasyon</div>
                                    <div class="data-card-value" id="clientVariation">0%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Inline stiller için CSS sınıfları */
        .amount-container {
            display: flex;
            gap: 5px;
        }
        
        .amount-input {
            flex: 3;
            min-width: 150px;
        }
        
        .currency-select {
            flex: 1;
            max-width: 80px;
        }
        
        .stats-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .chart-canvas {
            height: 300px;
            min-height: 250px;
        }
        
        .status-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-container label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Durum rozeti stilleri */
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-align: center;
            min-width: 70px;
            font-size: 0.8rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .status-paid {
            background-color: rgba(76, 175, 80, 0.7) !important; /* Yeşilimsi arka plan */
            color: white !important;                             /* Beyaz metin */
            border: 1px solid rgb(34, 87, 36) !important;      /* Daha koyu tok yeşil çerçeve */
        }
        
        .status-unpaid {
            background-color: rgba(244, 67, 54, 0.7) !important; /* Kırmızımsı arka plan */
            color: white !important;                              /* Beyaz metin */
            border: 1px solid rgb(139, 23, 19) !important;       /* Daha koyu tok kırmızı çerçeve */
        }
        
        .status-badge.status-paid:hover {
            background-color: rgba(76, 175, 80, 0.9);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        .status-badge.status-unpaid:hover {
            background-color: rgba(244, 67, 54, 0.9);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        }
        
        /* Diğer stiller devam ediyor */
        .action-buttons {
            display: flex;
            gap: 5px;
            position: relative;
            z-index: 10;
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            position: relative;
            z-index: 10;
        }
        .edit-btn i {
            color: #2196F3;
        }
        .delete-btn i {
            color: #000;
        }
        
        /* Modern Modal Stilleri */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .modal[style*="display: flex"],
        .modal[style*="display: block"] {
            pointer-events: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        #editModal .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #editModal .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }
        
        #editModal .modal-body {
            padding: 25px;
            overflow-y: visible;
        }
        
        #editModal .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close {
            font-size: 24px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        /* Form Stilleri */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group.tc-group {
            flex: 0 0 200px;
        }
        
        .form-group.date-group {
            flex: 0 0 200px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        /* Tutar Input Grubu */
        .amount-group {
            flex: 2;
            min-width: 250px;
        }
        
        .amount-input {
            display: flex;
            gap: 10px;
        }
        
        .currency-select {
            width: 80px;
            flex-shrink: 0;
        }
        
        /* Toggle Switch Stilleri */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-top: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            display: none;
        }
        
        .toggle-switch label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ff4444;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch label:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + label {
            background-color: #4CAF50;
        }
        
        .toggle-switch input:checked + label:after {
            transform: translateX(30px);
        }
        
        .status-text {
            font-weight: 500;
            color: #666;
        }
        
        /* Buton Stilleri */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d5d5d5;
        }
        
        /* Textarea placeholder stili */
        textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        /* Textarea Stili */
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            position: relative;
            z-index: 10;
        }

        .table-header h2 {
            margin: 0;
        }

        .stats-btn {
            margin-left: auto; /* Butonu sağa yasla */
            background-color: #4CAF50; /* Yeşil arka plan */
            color: white; /* Beyaz ikon */
            border: none;
            border-radius: 50%; /* Tamamen yuvarlak */
            width: 40px; /* Genişlik */
            height: 40px; /* Yükseklik */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s, box-shadow 0.3s;
            position: relative;
            z-index: 10;
        }
        .stats-btn:hover {
            background-color: #367c39; /* Hoverda koyu yeşil */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .modern-add-btn {
            background-color: #2c303c;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(44, 48, 60, 0.2);
        }

        .modern-add-btn:hover {
            background-color: #1a1d24;
            box-shadow: 0 4px 8px rgba(44, 48, 60, 0.3);
            transform: translateY(-1px);
        }

        /* Kayıtlı Müvekkil Seçim Butonu Stilleri */
        .client-type-selector {
            display: flex;
            gap: 12px;
            width: 100%;
        }

        .client-type-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
            font-weight: 500;
            color: #666;
        }

        .client-type-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .client-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .client-type-btn .material-icons {
            font-size: 22px;
        }

        /* Kayıtlı Müvekkil Dropdown Container */
        #registeredClientSection {
            display: none;
        }

        #registeredClientSection.active {
            display: block;
        }

        /* Select2 Özelleştirmesi */
        .select2-container--default .select2-selection--single {
            border: 1px solid #ddd;
            border-radius: 6px;
            height: 42px;
            padding: 6px 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
            color: #333;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 40px;
        }

        .modern-add-btn i {
            font-size: 18px;
        }

        .payment-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        /* Ödeme türlerine özel renkler */
        .payment-type-aylik-danismanlik {
            background-color: #e1f5fe;
            color: #01579b;
            border: 1px solid #0277bd;
        }

        .payment-type-danisma {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        .payment-type-ihtarname {
            background-color: #fff3e0;
            color: #e65100;
        }

        .payment-type-dilekce {
            background-color: #e3f2fd;
            color: #1565c0;
        }

        .payment-type-dosya {
            background-color: #f3e5f5;
            color: #6a1b9a;
        }

        .payment-type-sozlesme {
            background-color: #fce4ec;
            color: #c2185b;
        }

        .payment-type-mahkeme {
            background-color: #e0f2f1;
            color: #00695c;
        }

        .payment-type-diger {
            background-color: #fff9c4;
            color: #f57f17;
        }

        .payment-type-badge-empty {
            color: #999;
            font-style: italic;
        }

        .action-buttons .view-btn {
            background-color: #17a2b8; /* Info mavisi */
            color: white;
        }
        .action-buttons .view-btn:hover {
            background-color: #138496;
        }

        

         /* Modern Edit Modal Styles */
         .modern-edit-modal {
             border: none;
             border-radius: 16px;
             box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
             background: white;
         }

         .modern-edit-header {
             background: linear-gradient(135deg, #2d313c 0%, #3c404d 100%);
             color: white !important;
             border-radius: 16px 16px 0 0;
             border: none;
             padding: 1.5rem 2rem;
         }

         .modern-edit-header h2 {
             color: white !important;
             margin: 0;
             font-size: 1.5rem;
             font-weight: 600;
         }

         .modern-edit-header .modal-icon {
             color: white !important;
             opacity: 0.9;
         }

         .modern-edit-close {
             background: rgba(255, 255, 255, 0.1);
             border: none;
             border-radius: 50%;
             color: white;
             opacity: 0.8;
             transition: all 0.3s ease;
             width: 35px;
             height: 35px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             font-size: 1.2rem;
         }

         .modern-edit-close:hover {
             background: rgba(255, 255, 255, 0.2);
             opacity: 1;
             transform: scale(1.1);
         }

         .modern-edit-body {
             padding: 2rem;
             background: #f8f9fa;
         }

         .modern-edit-body .form-row {
             display: flex;
             gap: 1rem;
             margin-bottom: 1.5rem;
         }

         .modern-edit-body .form-group {
             flex: 1;
         }

         .modern-edit-body .form-group label {
             color: #2d313c;
             font-weight: 600;
             margin-bottom: 0.5rem;
             display: block;
             font-size: 0.9rem;
         }

         .modern-edit-body .form-control {
             border: 2px solid #e9ecef;
             border-radius: 8px;
             padding: 0.75rem;
             transition: all 0.3s ease;
             background: white;
         }

         .modern-edit-body .form-control:focus {
             border-color: #2d313c;
             box-shadow: 0 0 0 0.2rem rgba(45, 49, 60, 0.1);
         }

         .modern-edit-body .amount-input {
             display: flex;
             gap: 0.5rem;
         }

         .modern-edit-body .amount-input input {
             flex: 3;
             min-width: 150px;
         }

         .modern-edit-body .currency-select {
             flex: 1;
             max-width: 80px;
         }

         .modern-edit-body .toggle-container {
             display: flex;
             align-items: center;
             gap: 1rem;
             padding: 0.75rem 0;
         }

         .modern-edit-body .toggle-switch {
             position: relative;
             display: inline-block;
             width: 60px;
             height: 30px;
         }

         .modern-edit-body .toggle-switch input {
             opacity: 0;
             width: 0;
             height: 0;
         }

         .modern-edit-body .toggle-switch label {
             position: absolute;
             cursor: pointer;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background-color: #ccc;
             transition: .4s;
             border-radius: 30px;
         }

         .modern-edit-body .toggle-switch label:before {
             position: absolute;
             content: "";
             height: 22px;
             width: 22px;
             left: 4px;
             bottom: 4px;
             background-color: white;
             transition: .4s;
             border-radius: 50%;
         }

         .modern-edit-body .toggle-switch input:checked + label {
             background-color: #28a745;
         }

         .modern-edit-body .toggle-switch input:checked + label:before {
             transform: translateX(30px);
         }

         .modern-edit-body .status-text {
             color: #495057;
             font-weight: 600;
             margin: 0;
         }

         .modern-edit-body .textarea-container textarea {
             min-height: 100px;
             resize: vertical;
         }

         .modern-edit-footer {
             background: white;
             border-top: 1px solid #e9ecef;
             border-radius: 0 0 16px 16px;
             padding: 1.5rem 2rem;
             display: flex;
             gap: 1rem;
             justify-content: flex-end;
         }

         .modern-save-btn {
             background: linear-gradient(135deg, #2d313c, #3c404d);
             color: white !important;
             border: none;
             border-radius: 8px;
             padding: 0.75rem 1.5rem;
             font-weight: 600;
             display: flex;
             align-items: center;
             gap: 0.5rem;
             transition: all 0.3s ease;
         }

         .modern-save-btn:hover {
             background: linear-gradient(135deg, #3c404d, #4a4e5b);
             transform: translateY(-2px);
             box-shadow: 0 5px 15px rgba(45, 49, 60, 0.3);
             color: white !important;
         }

         .modern-cancel-btn {
             background: #6c757d;
             color: white;
             border: none;
             border-radius: 8px;
             padding: 0.75rem 1.5rem;
             font-weight: 600;
             display: flex;
             align-items: center;
             gap: 0.5rem;
             transition: all 0.3s ease;
         }

         .modern-cancel-btn:hover {
             background: #5a6268;
             transform: translateY(-2px);
             box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
             color: white;
         }

        .sort-icon {
            font-size: 16px;
            margin-left: 4px;
            vertical-align: middle;
        }

        th {
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        /* İstatistik Modalı Stilleri */
        .stats-modal-content {
            max-width: 95%;
            width: 1600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .stats-modal-content .modal-header {
            flex-shrink: 0;
            background-color: #2c3e50;
            color: #fff;
            border-radius: 10px 10px 0 0;
            border-bottom: none;
            position: relative;
        }

        .stats-modal-content .modal-header h2 {
            color: #fff;
            font-weight: 600;
        }

        .stats-modal-content .modal-header .close {
            color: #fff;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .stats-modal-content .modal-header .close:hover {
            opacity: 1;
        }

        .stats-modal-content .modal-body {
            overflow-y: auto;
            padding: 20px;
            flex-grow: 1;
            background-color: #f8f9fa;
        }

        .stats-tabs {
            display: flex;
            overflow-x: auto;
            gap: 5px;
            margin-bottom: 20px;
            background-color: #fff;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }

        .stats-tab-btn {
            padding: 12px 18px;
            font-size: 0.92rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            color: #495057;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .stats-tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .stats-tab-btn:hover::before {
            left: 100%;
        }

        .stats-tab-btn:hover {
            background: linear-gradient(135deg, #e3e8ef 0%, #d4dae3 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #4361ee20;
        }

        .stats-tab-btn.active {
            background: linear-gradient(135deg, #4361ee 0%, #3651d4 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(67, 97, 238, 0.3);
            border-color: #3651d4;
        }

        .stats-tab-btn.active::before {
            display: none;
        }

        .stats-tab-btn .material-icons {
            font-size: 1.1rem;
        }

        /* Dashboard Style Container */
        .stats-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 992px) {
            .stats-summary-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Modern İstatistik Kartları - Ana Grid */
        .modern-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .modern-stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #f0f0f0;
            position: relative;
            overflow: hidden;
        }

        .modern-stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            transition: width 0.3s ease;
        }

        .modern-stat-card.primary::before { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .modern-stat-card.success::before { background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); }
        .modern-stat-card.warning::before { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .modern-stat-card.info::before { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); }

        .modern-stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .modern-stat-card:hover::before {
            width: 6px;
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-icon-wrapper {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stat-icon-wrapper.primary-bg { background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%); }
        .stat-icon-wrapper.success-bg { background: linear-gradient(135deg, #4caf5022 0%, #45a04922 100%); }
        .stat-icon-wrapper.warning-bg { background: linear-gradient(135deg, #ff980022 0%, #f57c0022 100%); }
        .stat-icon-wrapper.info-bg { background: linear-gradient(135deg, #2196f322 0%, #1976d222 100%); }

        .stat-icon-wrapper i {
            font-size: 28px;
        }

        .stat-icon-wrapper.primary-bg i { color: #667eea; }
        .stat-icon-wrapper.success-bg i { color: #4caf50; }
        .stat-icon-wrapper.warning-bg i { color: #ff9800; }
        .stat-icon-wrapper.info-bg i { color: #2196f3; }

        .stat-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            background: #f1f5f9;
            color: #475569;
            width: fit-content;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1;
        }

        .stat-value.primary-text { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-value.success-text { color: #4caf50; }
        .stat-value.warning-text { color: #ff9800; }
        .stat-value.info-text { color: #2196f3; }

        .stat-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .stat-footer i.tiny {
            font-size: 16px;
        }

        /* Detay Kartları Grid - Simetrik 3+3 */
        .detail-stats-grid-top,
        .detail-stats-grid-bottom {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .detail-stats-grid-top,
            .detail-stats-grid-bottom {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .detail-stats-grid-top,
            .detail-stats-grid-bottom {
                grid-template-columns: 1fr;
            }
        }

        .detail-stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .detail-stat-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .detail-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .detail-icon i {
            font-size: 24px;
            color: white;
        }

        .detail-icon.purple-bg { background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); }
        .detail-icon.orange-bg { background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); }
        .detail-icon.red-bg { background: linear-gradient(135deg, #f44336 0%, #e53935 100%); }
        .detail-icon.teal-bg { background: linear-gradient(135deg, #009688 0%, #00796b 100%); }
        .detail-icon.indigo-bg { background: linear-gradient(135deg, #3f51b5 0%, #303f9f 100%); }
        .detail-icon.blue-bg { background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); }

        .detail-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .detail-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
        }

        .detail-subvalue {
            font-size: 0.75rem;
            color: #64748b;
            font-weight: 500;
        }

        /* Döviz Kuru Notu */
        .exchange-rate-note {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-left: 4px solid #4361ee;
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .note-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #4361ee 0%, #3651d4 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .note-icon i {
            color: white;
            font-size: 20px;
        }

        .note-content {
            flex: 1;
            font-size: 0.9rem;
            color: #495057;
        }

        .note-content strong {
            color: #2c3e50;
            margin-right: 8px;
        }

        /* Tablolar için stil */
        .summary-extra-info {
            margin-top: 20px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .expected-by-year-section h4 {
            margin: 0 0 15px 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .detail-table-container {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            background-color: #fff;
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .detail-table th, .detail-table td {
            padding: 10px 12px;
            text-align: left;
        }

        .detail-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 1;
            border-bottom: 2px solid #dee2e6;
        }

        .detail-table tbody tr {
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s;
        }

        .detail-table tbody tr:hover {
            background-color: #f1f3f5;
        }

        .detail-table tbody tr:last-child {
            border-bottom: none;
        }

        /* Grafik stilleri */
        .chart-container {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .chart-container.large-chart {
            height: 45vh;
        }

        .chart-container.medium-chart {
            height: 40vh;
        }

        .chart-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .chart-filter {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ced4da;
            background-color: #fff;
            font-size: 0.9rem;
            color: #495057;
        }

        .entity-filter-checkboxes {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border: 2px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        .filter-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
            color: #495057;
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
            border: 2px solid transparent;
        }

        .filter-checkbox:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-color: #2196F3;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.2);
        }

        .filter-checkbox input[type="checkbox"] {
            position: relative;
            width: 20px;
            height: 20px;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background: white;
            border: 2.5px solid #adb5bd;
            border-radius: 5px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .filter-checkbox input[type="checkbox"]:hover {
            border-color: #4361ee;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .filter-checkbox input[type="checkbox"]:checked {
            background: linear-gradient(135deg, #4361ee 0%, #3651d4 100%);
            border-color: #3651d4;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .filter-checkbox input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }

        .filter-checkbox span {
            line-height: 1;
            transition: color 0.3s;
        }

        .filter-checkbox:hover span {
            color: #2196F3;
        }

        .filter-checkbox input[type="checkbox"]:checked + span {
            color: #4361ee;
            font-weight: 700;
        }

        /* Tab içerik stilleri */
        .stats-tab-content {
            display: none;
        }

        .stats-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .table-title {
            margin: 25px 0 15px 0;
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-title i {
            color: #4361ee;
        }

        /* Yeni veri kartları için stil */
        .data-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .data-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .data-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .data-card-title {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .data-card-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #212529;
        }

        /* Ödeme Türü Kartları */
        .payment-type-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .payment-type-card {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 20px;
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .payment-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .payment-type-card.type-aylik-danismanlik { border-left-color: #01579b; }
        .payment-type-card.type-danisma { border-left-color: #2e7d32; }
        .payment-type-card.type-ihtarname { border-left-color: #e65100; }
        .payment-type-card.type-dilekce { border-left-color: #1565c0; }
        .payment-type-card.type-dosya { border-left-color: #6a1b9a; }
        .payment-type-card.type-sozlesme { border-left-color: #c2185b; }
        .payment-type-card.type-mahkeme { border-left-color: #00695c; }
        .payment-type-card.type-diger { border-left-color: #f57f17; }

        .payment-type-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .payment-type-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .type-aylik-danismanlik .payment-type-card-icon { background-color: #01579b; }
        .type-danisma .payment-type-card-icon { background-color: #2e7d32; }
        .type-ihtarname .payment-type-card-icon { background-color: #e65100; }
        .type-dilekce .payment-type-card-icon { background-color: #1565c0; }
        .type-dosya .payment-type-card-icon { background-color: #6a1b9a; }
        .type-sozlesme .payment-type-card-icon { background-color: #c2185b; }
        .type-mahkeme .payment-type-card-icon { background-color: #00695c; }
        .type-diger .payment-type-card-icon { background-color: #f57f17; }

        .payment-type-card-title {
            font-size: 1rem;
            font-weight: 600;
            color: #343a40;
        }

        .payment-type-card-stats {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .payment-type-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .payment-type-stat-row:last-child {
            border-bottom: none;
        }

        .payment-type-stat-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .payment-type-stat-value {
            font-size: 1rem;
            font-weight: 700;
            color: #212529;
        }

        .payment-type-stat-value.paid {
            color: #4caf50;
        }

        .payment-type-stat-value.unpaid {
            color: #f44336;
        }

        /* Ödeme Türü Grafikleri */
        .payment-type-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .chart-subtitle {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #343a40;
            margin-bottom: 20px;
        }

        .chart-subtitle i {
            font-size: 24px;
            color: #4361ee;
        }

        /* Trend göstergeleri için stil */
        .trend-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .trend-indicator i {
            font-size: 16px;
        }

        .trend-positive {
            color: #4caf50;
        }

        .trend-negative {
            color: #f44336;
        }

        .trend-neutral {
            color: #ff9800;
        }

        /* Yeni analiz kartları */
        .analysis-section {
            margin-top: 30px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 10px;
        }

        .analysis-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-title i {
            color: #4361ee;
        }

        .analysis-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 5px 0 15px 0;
        }

        .monthly-distribution, .yearly-distribution {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .currency-distribution {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }

        .currency-chart {
            flex: 1;
        }

        @media (max-width: 992px) {
            .monthly-distribution, .yearly-distribution {
                grid-template-columns: 1fr;
            }
            
            .currency-distribution {
                flex-direction: column;
            }
        }
        
        /* Scrollbar stil */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c9d6;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8b1c1;
        }

        /* Durum kartları */
        .status-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-card {
            background-color: #fff;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .status-card.paid::before {
            background-color: #4caf50;
        }

        .status-card.unpaid::before {
            background-color: #f44336;
        }

        .status-card.overdue::before {
            background-color: #e91e63;
        }

        .status-card-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .status-card-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #212529;
        }

        .status-card-percentage {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }

        /* Ödeme tahminleri */
        .payment-predictions {
            background: linear-gradient(135deg, #4361ee 0%, #3f51b5 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }

        .prediction-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prediction-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .prediction-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.2s, background-color 0.2s;
        }

        .prediction-item:hover {
            transform: translateY(-3px);
            background-color: rgba(255, 255, 255, 0.15);
        }

        .prediction-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .prediction-value {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Göz ikonunun rengini ve görünürlüğünü belirginleştir */
        .action-buttons .view-btn {
            background-color: #17a2b8; /* Info mavisi - Zaten tanımlı olmalı, emin olalım */
            /* color: white; Bu satır ikona doğrudan uygulanacağı için kaldırılabilir veya kalabilir */
        }

        .action-buttons .view-btn .material-icons {
            color: white;   /* İkon rengi beyaz */
            opacity: 1;     /* İkonun tamamen görünür olmasını sağla */
        }

        /* odemeler.html - Göz ikonu için daha spesifik stil */
        body .content .table-container .data-table .action-buttons .view-btn {
            background-color: transparent !important; /* Arka planı kaldır */
            box-shadow: none !important;
            border: none !important;
            padding: 0.4rem !important;
        }

        body .content .table-container .data-table .action-buttons .view-btn .material-icons {
            color: #007bff !important; /* Mavi renk */
            opacity: 1 !important;
            font-size: 1.2rem !important;
        }

        body .content .table-container .data-table .action-buttons .view-btn:hover .material-icons {
            color: #0056b3 !important; /* Hover durumunda koyu mavi */
        }

        /* Ödeme Detay Modalını en üste taşı */
        #paymentDetailModal {
            z-index: 1060 !important; /* Diğer bootstrap modallarının ve backdrop'un üzerinde olmalı */
        }

        /* ============================================
           KOYU TEMA - ÖDEMELER SAYFASI
           ============================================ */

        [data-theme="dark"] .content {
            background: var(--background-color);
        }

        [data-theme="dark"] .page-title,
        [data-theme="dark"] h1,
        [data-theme="dark"] h2,
        [data-theme="dark"] h3 {
            color: var(--text-color);
        }

        [data-theme="dark"] .table-container {
            background: var(--card-bg);
        }

        [data-theme="dark"] .data-table {
            background: var(--table-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .stats-modal .modal-content {
            background: var(--modal-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .stats-modal .modal-header {
            background: var(--modal-header-bg);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .modal-content h2,
        [data-theme="dark"] .modal-content h3,
        [data-theme="dark"] .modal-content h4 {
            color: var(--text-color);
        }

        [data-theme="dark"] .stats-tab-btn {
            background: var(--background-tertiary);
            color: var(--text-secondary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .stats-tab-btn:hover {
            background: var(--hover-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .stats-tab-btn.active {
            background: var(--primary-color);
            color: var(--text-light);
        }

        [data-theme="dark"] .modern-stat-card {
            background: var(--card-bg);
            border-color: var(--card-border);
        }

        [data-theme="dark"] .stat-label,
        [data-theme="dark"] .stat-value {
            color: var(--text-color);
        }

        [data-theme="dark"] .stat-footer {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .detail-card {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .detail-card-title {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .detail-card-value {
            color: var(--text-color);
        }

        [data-theme="dark"] .exchange-rate-note {
            background: var(--background-tertiary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .exchange-rate-note .note-content {
            color: var(--text-color);
        }

        [data-theme="dark"] .detail-table {
            background: var(--table-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .detail-table th {
            background: var(--table-header-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .detail-table td {
            background: var(--table-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .detail-table tr:hover td {
            background: var(--table-hover-bg);
        }

        [data-theme="dark"] .payment-type-card {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .payment-type-card-title {
            color: var(--text-color);
        }

        [data-theme="dark"] .payment-type-card-value {
            color: var(--text-color);
        }

        [data-theme="dark"] .analysis-section {
            background: var(--card-bg);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .analysis-title {
            color: var(--text-color);
        }

        [data-theme="dark"] .data-card {
            background: var(--background-tertiary);
            border-color: var(--border-color);
        }

        [data-theme="dark"] .data-card-title {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .data-card-value {
            color: var(--text-color);
        }

        [data-theme="dark"] .chart-container {
            background: var(--card-bg);
        }

        [data-theme="dark"] select,
        [data-theme="dark"] .filter-select {
            background: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-color);
        }

        [data-theme="dark"] select option {
            background: var(--input-bg);
            color: var(--text-color);
        }

        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }


    </style>

    <script>
        // Yetki kontrolü değişkenleri
        const hasEditPermission = {{ 'true' if current_user.has_permission('odeme_duzenle') else 'false' }};
        const hasDeletePermission = {{ 'true' if current_user.has_permission('odeme_sil') else 'false' }};
        
        // Global fonksiyonlar
        window.deletePayment = function(button) {
            if (!hasDeletePermission) {
                alert('Ödeme silme yetkiniz bulunmamaktadır.');
                return;
            }
            
            if (confirm('Bu ödemeyi silmek istediğinizden emin misiniz?')) {
                const row = button.closest('tr');
                const clientId = row.getAttribute('data-client-id');
                
                const csrfToken = document.querySelector('input[name="csrf_token"]')?.value || 
                                document.querySelector('meta[name="csrf-token"]')?.content;
                
                if (!csrfToken) {
                    alert('Güvenlik token\'ı bulunamadı. Sayfayı yenileyin.');
                    return;
                }
                
                fetch(`/delete_client/${clientId}`, {
                    method: 'DELETE',  
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Ödeme başarıyla silindi!');
                          row.remove();
                      } else {
                          alert('Silme işlemi başarısız: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
                      }
                  })
                  .catch(error => {
                      alert('Silme işlemi sırasında bir hata oluştu: ' + error.message);
                  });
            }
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // Tablo sıralaması
            // Tablo sıralaması için header'lara event listener ekle
            const sortableHeaders = document.querySelectorAll('.sortable-header');
            sortableHeaders.forEach(header => {
                header.addEventListener('click', function() {
                    const table = this.closest('table');
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const columnIndex = Array.from(this.parentElement.children).indexOf(this);
                    const sortIcon = this.querySelector('.sort-icon');
                    
                    // Mevcut sıralama durumunu kontrol et
                    const currentSort = this.dataset.sort || 'none';
                    let newSort = 'asc';
                    
                    if (currentSort === 'asc') {
                        newSort = 'desc';
                    } else if (currentSort === 'desc') {
                        newSort = 'asc';
                    }
                    
                    // Tüm header'ların sort durumunu sıfırla
                    sortableHeaders.forEach(h => {
                        h.dataset.sort = 'none';
                        const icon = h.querySelector('.sort-icon');
                        if (icon) icon.textContent = 'unfold_more';
                    });
                    
                    // Şu anki header'ın sort durumunu güncelle
                    this.dataset.sort = newSort;
                    if (sortIcon) {
                        sortIcon.textContent = newSort === 'asc' ? 'arrow_upward' : 'arrow_downward';
                    }
                    
                    // Satırları sırala
                    rows.sort((rowA, rowB) => {
                        const cellA = rowA.children[columnIndex];
                        const cellB = rowB.children[columnIndex];
                        
                        if (!cellA || !cellB) return 0;
                        
                        let valueA = cellA.textContent.trim();
                        let valueB = cellB.textContent.trim();
                        
                        // Tarih kontrolü (DD.MM.YYYY formatı)
                        const dateRegex = /^\d{2}\.\d{2}\.\d{4}$/;
                        if (dateRegex.test(valueA) && dateRegex.test(valueB)) {
                            const [dayA, monthA, yearA] = valueA.split('.');
                            const [dayB, monthB, yearB] = valueB.split('.');
                            const dateObjA = new Date(yearA, monthA - 1, dayA);
                            const dateObjB = new Date(yearB, monthB - 1, dayB);
                            return newSort === 'asc' ? dateObjA - dateObjB : dateObjB - dateObjA;
                        }
                        
                        // Tutar kontrolü (1.234,56 TL formatı)
                        const amountRegex = /^[\d.,]+\s*(TL|USD|EUR)$/;
                        if (amountRegex.test(valueA) && amountRegex.test(valueB)) {
                            const numA = parseFloat(valueA.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                            const numB = parseFloat(valueB.replace(/[^\d,]/g, '').replace(',', '.')) || 0;
                            return newSort === 'asc' ? numA - numB : numB - numA;
                        }
                        
                        // Sayı kontrolü
                        const numA = parseFloat(valueA);
                        const numB = parseFloat(valueB);
                        if (!isNaN(numA) && !isNaN(numB)) {
                            return newSort === 'asc' ? numA - numB : numB - numA;
                        }
                        
                        // Metin karşılaştırması
                        return newSort === 'asc' 
                            ? valueA.localeCompare(valueB, 'tr') 
                            : valueB.localeCompare(valueA, 'tr');
                    });
                    
                    // Sıralanmış satırları tabloya tekrar ekle
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
            // ========== TABLO SIRALAMA FONKSİYONLARI SONU ==========

            // LocalStorage'dan açılması gereken bir müvekkil ID'si var mı kontrol et
            const clientIdToOpen = localStorage.getItem('openClientDetailId');
            if (clientIdToOpen) {
                // ID'yi kullandıktan sonra localStorage'dan temizle
                localStorage.removeItem('openClientDetailId');
                
                // İlgili müvekkilin detay butonunu bul ve tıkla
                setTimeout(() => {
                    const viewBtn = document.querySelector(`.view-btn[data-payment-id="${clientIdToOpen}"]`);
                    if (viewBtn) {
                        viewBtn.click();
                    }
                }, 500);
            }

            // Ödeme formunu dinle
            const paymentForm = document.getElementById('paymentForm');
            if (paymentForm) {
                paymentForm.onsubmit = function(event) {
                    event.preventDefault();
                    savePayment(event);
                };
            }
            
            // Düzenleme formunu dinle
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.onsubmit = function(event) {
                    event.preventDefault();
                    const clientIdToUpdate = document.getElementById('editClientId').value;
                    window.updateClient(clientIdToUpdate);
                };
            }
            
            // Modal kapatma butonları için event listener'lar ekle
            const editModalElement = document.getElementById('editModal');
            if (editModalElement) { 
                const closeBtn = editModalElement.querySelector('.close');
                const closeModalBtn = editModalElement.querySelector('.modern-cancel-btn');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function() {
                        editModalElement.style.display = 'none';
                    });
                }
                
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', function() {
                        editModalElement.style.display = 'none';
                    });
                }
                
                // Modalın dışına tıklandığında kapanması için
                window.addEventListener('click', function(event) {
                    if (event.target === editModalElement) {
                        editModalElement.style.display = 'none';
                    }
                });

                // Düzenleme Modalı - Tutar alanı (formatlama KALDIRILDI - ham değer kullanılıyor)
                const editAmountInput = document.getElementById('editAmount');
                if (editAmountInput) {
                    // Sadece boş değer kontrolü
                    editAmountInput.addEventListener('blur', function() {
                        if (this.value === '') {
                            this.value = '0';
                        }
                    });
                }

                // Düzenleme Modalı - Entity type değişikliği
                const editEntityType = document.getElementById('editEntityType');
                const editNameLabel = document.getElementById('editNameLabel');
                const editSurnameLabel = document.getElementById('editSurnameLabel');
                const editTcLabel = document.getElementById('editTcLabel');
                const editName = document.getElementById('editName');
                const editSurname = document.getElementById('editSurname');
                const editNameGroup = document.getElementById('editNameGroup');
                const editSurnameGroup = document.getElementById('editSurnameGroup');

                if (editEntityType) {
                    editEntityType.addEventListener('change', function() {
                        if (this.value === 'company') {
                            editNameLabel.textContent = 'Kurum Adı';
                            editSurnameLabel.textContent = '';
                            editSurnameGroup.style.display = 'none';
                            editSurname.required = false;
                            editNameGroup.classList.add('full-width');
                            editTcLabel.textContent = 'Vergi/Mersis/Ticaret Sicil No (İsteğe Bağlı)';
                        } else {
                            editNameLabel.textContent = 'Ad';
                            editSurnameLabel.textContent = 'Soyad';
                            editSurnameGroup.style.display = 'block';
                            editSurname.required = true;
                            editNameGroup.classList.remove('full-width');
                            editTcLabel.textContent = 'TC Kimlik No (İsteğe Bağlı)';
                        }
                    });
                }

                // Düzenleme Modalı içindeki Ödeme Durumu geçiş anahtarını dinle
                const editStatusCheckbox = editModalElement.querySelector('#editStatus');
                const statusTextSpan = editModalElement.querySelector('.status-text'); // Daha spesifik seçici
                const editPaymentDateRow = document.getElementById('editPaymentDateRow');
                
                if (editStatusCheckbox && statusTextSpan) {
                    editStatusCheckbox.addEventListener('change', function() {
                        statusTextSpan.textContent = this.checked ? 'Ödendi' : 'Ödenmedi';
                        if (editPaymentDateRow) {
                            editPaymentDateRow.style.display = this.checked ? 'flex' : 'none';
                        }
                    });
                }
            }

            // İstatistik butonuna tıklandığında modalı aç
            const statsBtn = document.getElementById('statsButton');
            if (statsBtn) {
                statsBtn.addEventListener('click', function() {
                    const statsModal = document.getElementById('statsModal');
                    if (statsModal) {
                        statsModal.style.display = 'flex';
                        generateStats();
                    }
                });
            }

            // Modal kapatma butonları
            const statsModal = document.getElementById('statsModal');
            if (statsModal) {
                const closeStatsModalBtn = document.getElementById('closeStatsModal');
                if (closeStatsModalBtn) {
                    closeStatsModalBtn.addEventListener('click', function() {
                        statsModal.style.display = 'none';
                    });
                }
                
                // Modalın dışına tıklandığında kapanması için
                window.addEventListener('click', function(event) {
                    if (event.target === statsModal) {
                        statsModal.style.display = 'none';
                    }
                });
            }

            // Tab butonları için event listener'lar
            document.querySelectorAll('.stats-tab-btn').forEach(button => {
                button.addEventListener('click', function() {
                    // Aktif tab butonunu değiştir
                    document.querySelectorAll('.stats-tab-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // İlgili içeriği göster
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.stats-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabName + '-tab').classList.add('active');
                    
                    // İlgili grafiği ve içeriği güncelle
                    updateActiveTab(tabName);
                });
            });

            // TABLO SIRALAMA İŞLEVSELLİĞİ
            const getCellValue = (row, headerId) => {
                let cellIndex;
                switch (headerId) {
                    case 'sort-payment-type': cellIndex = 0; break;
                    case 'sort-name': cellIndex = 1; break;
                    case 'sort-surname': cellIndex = 2; break;
                    case 'sort-tc': cellIndex = 3; break;
                    case 'sort-amount': cellIndex = 4; break;
                    case 'sort-installments': cellIndex = 5; break;
                    case 'sort-registration-date': cellIndex = 6; break;
                    case 'sort-due-date': cellIndex = 7; break;
                    case 'sort-payment-date': cellIndex = 8; break;
                    case 'sort-status': cellIndex = 9; break;
                    default: return '';
                }
                const cell = row.cells[cellIndex];
                return cell ? cell.innerText || cell.textContent : '';
            };

            const parseValue = (value, headerId) => {
                if (headerId === 'sort-amount') {
                    // "10000.0 TL" formatından sayıyı ve para birimini ayır
                    const parts = value.split(' ');
                    const amount = parseFloat(parts[0].replace(/\./g, '').replace(',', '.')); // 10.000,50 -> 10000.50
                    return isNaN(amount) ? 0 : amount; 
                }
                if (headerId === 'sort-installments' || headerId === 'sort-tc') {
                    return parseInt(value, 10) || 0;
                }
                if (headerId === 'sort-registration-date' || headerId === 'sort-due-date' || headerId === 'sort-payment-date') {
                    if (value === '-' || !value) return null; // veya çok eski bir tarih
                    const parts = value.split('.'); // GG.AA.YYYY
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
                return value.toLowerCase(); // Metinler için küçük harfe çevir
            };

            document.querySelectorAll('.data-table th[id^="sort-"]').forEach(headerCell => {
                let currentSortOrder = 'asc'; // Varsayılan sıralama yönü

                headerCell.addEventListener('click', () => {
                    const tableElement = headerCell.closest('table');
                    const tbody = tableElement.querySelector('tbody');
                    const headerId = headerCell.id;
                    const sortIcon = headerCell.querySelector('.sort-icon');

                    // Diğer başlıklardaki sıralama ikonlarını sıfırla
                    document.querySelectorAll('.data-table th[id^="sort-"]').forEach(th => {
                        if (th !== headerCell) {
                            const icon = th.querySelector('.sort-icon');
                            if (icon) icon.textContent = 'unfold_more';
                        }
                    });

                    Array.from(tbody.querySelectorAll('tr'))
                        .sort((rowA, rowB) => {
                            const valA = parseValue(getCellValue(rowA, headerId), headerId);
                            const valB = parseValue(getCellValue(rowB, headerId), headerId);

                            if (valA === null && valB === null) return 0;
                            if (valA === null) return currentSortOrder === 'asc' ? 1 : -1; // Null'ları sona at
                            if (valB === null) return currentSortOrder === 'asc' ? -1 : 1; // Null'ları sona at


                            if (typeof valA === 'number' && typeof valB === 'number') {
                                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
                            } else if (valA instanceof Date && valB instanceof Date) {
                                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
                            } else {
                                // String karşılaştırması
                                if (valA < valB) return currentSortOrder === 'asc' ? -1 : 1;
                                if (valA > valB) return currentSortOrder === 'asc' ? 1 : -1;
                                return 0;
                            }
                        })
                        .forEach(sortedRow => tbody.appendChild(sortedRow));

                    // Sıralama ikonunu ve yönünü güncelle
                    if (currentSortOrder === 'asc') {
                        currentSortOrder = 'desc';
                        if (sortIcon) sortIcon.textContent = 'expand_more'; // Aşağı ok
                    } else {
                        currentSortOrder = 'asc';
                        if (sortIcon) sortIcon.textContent = 'expand_less'; // Yukarı ok
                    }
                });
            });

            // Ödeme Detay Modal'ı açıldığında içeriği yükle
            // const odemeDetayModalElement = document.getElementById('odemeDetayModal'); // ESKİ EVENT LISTENER SİLİNDİ
            // if (odemeDetayModalElement) {
            //     odemeDetayModalElement.addEventListener('shown.bs.modal', async function (event) {
            //         // Tetikleyici butonu al (event.relatedTarget)
            //         const button = event.relatedTarget;
            //         if (button) {
            //             const paymentId = button.getAttribute('data-payment-id');
            //             await loadPaymentDetails(paymentId); 
            //         }
            //     });
            // }
        });

        // deletePayment fonksiyonu ZATEN EN BAŞTA TANIMLANDI
        // Bu kısım gereksiz olduğu için yorum satırına alındı
        console.log('deletePayment zaten tanımlı:', typeof window.deletePayment);

        // Yeni Ödeme Ekle Modal İşlemleri
        const addPaymentBtn = document.getElementById('addPaymentBtn');
        const addPaymentModal = document.getElementById('addPaymentModal');
        const closeAddPaymentModal = document.getElementById('closeAddPaymentModal');
        const cancelAddPaymentBtn = document.getElementById('cancelAddPaymentBtn');
        const addPaymentForm = document.getElementById('addPaymentForm');

        // Tutar formatlama fonksiyonu
        function formatAmountInput(input) {
            let value = input.value;
            
            // Boş ise çık
            if (value === '') {
                return;
            }
            
            // Sadece rakam, nokta ve virgül bırak, diğer karakterleri temizle
            value = value.replace(/[^\d.,]/g, '');
            
            // Eğer değer boş kaldıysa çık
            if (value === '') {
                input.value = '';
                return;
            }
            
            // Nokta ve virgülü standartlaştır (. ve , ikisi de ondalık ayraç olabilir)
            // Önce tüm noktaları geçici olarak kaldır (binlik ayraç olabilir)
            // Son nokta veya virgülü ondalık ayraç olarak kabul et
            let lastDotIndex = value.lastIndexOf('.');
            let lastCommaIndex = value.lastIndexOf(',');
            
            let decimalSeparatorIndex = Math.max(lastDotIndex, lastCommaIndex);
            let integerPart = '';
            let decimalPart = '';
            
            if (decimalSeparatorIndex > -1) {
                integerPart = value.substring(0, decimalSeparatorIndex).replace(/[.,]/g, '');
                decimalPart = value.substring(decimalSeparatorIndex + 1).replace(/[.,]/g, '');
            } else {
                integerPart = value.replace(/[.,]/g, '');
            }
            
            // Decimal part'ı 2 karakterle sınırla
            if (decimalPart.length > 2) {
                decimalPart = decimalPart.substring(0, 2);
            } else if (decimalPart.length === 0 && decimalSeparatorIndex === -1) {
                decimalPart = '00';
            } else {
                decimalPart = decimalPart.padEnd(2, '0');
            }
            
            // Integer part boşsa 0 yap
            if (integerPart === '') {
                integerPart = '0';
            }
            
            // Binlik ayraç ekle
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Formatlanmış değeri input'a yaz
            input.value = integerPart + ',' + decimalPart;
        }

        // Tutar input alanı (formatlama KALDIRILDI - ham değer kullanılıyor)
        const addAmountInput = document.getElementById('addAmount');
        if (addAmountInput) {
            // Sadece boş değer kontrolü
            addAmountInput.addEventListener('blur', function() {
                if (this.value === '') {
                    this.value = '0';
                }
            });
        }

        // Entity type değişikliği için event listener
        const addEntityType = document.getElementById('addEntityType');
        const addNameLabel = document.getElementById('addNameLabel');
        const addSurnameLabel = document.getElementById('addSurnameLabel');
        const addTcLabel = document.getElementById('addTcLabel');
        const addName = document.getElementById('addName');
        const addSurname = document.getElementById('addSurname');
        const addNameGroup = document.getElementById('addNameGroup');
        const addSurnameGroup = document.getElementById('addSurnameGroup');

        if (addEntityType) {
            addEntityType.addEventListener('change', function() {
                if (this.value === 'company') {
                    addNameLabel.textContent = 'Kurum Adı';
                    addSurnameLabel.textContent = '';
                    addSurnameGroup.style.display = 'none';
                    addSurname.required = false;
                    addNameGroup.classList.add('full-width');
                    addTcLabel.textContent = 'Vergi/Mersis/Ticaret Sicil No (İsteğe Bağlı)';
                } else {
                    addNameLabel.textContent = 'Ad';
                    addSurnameLabel.textContent = 'Soyad';
                    addSurnameGroup.style.display = 'block';
                    addSurname.required = true;
                    addNameGroup.classList.remove('full-width');
                    addTcLabel.textContent = 'TC Kimlik No (İsteğe Bağlı)';
                }
            });
        }

        // Status toggle için event listener
        const addStatusCheckbox = document.getElementById('addStatus');
        const statusTextAdd = document.querySelector('.status-text-add');
        const addPaymentDateRow = document.getElementById('addPaymentDateRow');

        if (addStatusCheckbox && statusTextAdd) {
            addStatusCheckbox.addEventListener('change', function() {
                statusTextAdd.textContent = this.checked ? 'Ödendi' : 'Ödenmedi';
                // Ödeme tarihi satırını göster/gizle
                if (addPaymentDateRow) {
                    addPaymentDateRow.style.display = this.checked ? 'flex' : 'none';
                }
            });
        }

        // Modal açma
        if (addPaymentBtn) {
            addPaymentBtn.addEventListener('click', function() {
                addPaymentModal.style.display = 'flex';
                // Select2 initialize et
                if (!$('#registeredClientSelect').hasClass('select2-hidden-accessible')) {
                    loadRegisteredClients();
                }
            });
        }

        // Yeni Müvekkil / Kayıtlı Müvekkil Toggle
        const newClientBtn = document.getElementById('newClientBtn');
        const registeredClientBtn = document.getElementById('registeredClientBtn');
        const registeredClientSection = document.getElementById('registeredClientSection');
        const saveToRegisteredSection = document.getElementById('saveToRegisteredSection');

        if (newClientBtn && registeredClientBtn) {
            newClientBtn.addEventListener('click', function() {
                newClientBtn.classList.add('active');
                registeredClientBtn.classList.remove('active');

                // Kayıtlı müvekkil dropdown'ını gizle
                registeredClientSection.style.display = 'none';

                // "Kayıtlı müvekkile ekle" checkbox'ını göster
                saveToRegisteredSection.style.display = 'block';

                // Müvekkil bilgilerini editable yap
                document.getElementById('addEntityType').disabled = false;
                document.getElementById('addName').disabled = false;
                document.getElementById('addSurname').disabled = false;
                document.getElementById('addTc').disabled = false;

                // Form alanlarını temizle
                document.getElementById('addEntityType').value = 'person';
                document.getElementById('addName').value = '';
                document.getElementById('addSurname').value = '';
                document.getElementById('addTc').value = '';

                // Required attribute'ları geri ekle
                document.getElementById('addName').required = true;
                document.getElementById('addSurname').required = true;
            });

            registeredClientBtn.addEventListener('click', function() {
                registeredClientBtn.classList.add('active');
                newClientBtn.classList.remove('active');

                // Kayıtlı müvekkil dropdown'ını göster
                registeredClientSection.style.display = 'block';

                // "Kayıtlı müvekkile ekle" checkbox'ını gizle
                saveToRegisteredSection.style.display = 'none';

                // Müvekkil bilgilerini disabled yap (kayıtlı müvekkil seçilince otomatik dolacak)
                document.getElementById('addEntityType').disabled = true;
                document.getElementById('addName').disabled = true;
                document.getElementById('addSurname').disabled = true;
                document.getElementById('addTc').disabled = true;

                // Required attribute'ları kaldır (kayıtlı müvekkil seçilecek)
                document.getElementById('addName').required = false;
                document.getElementById('addSurname').required = false;
            });
        }

        // Kayıtlı müvekkilleri yükle ve Select2 initialize et
        function loadRegisteredClients() {
            fetch('/api/get_registered_payment_clients')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = $('#registeredClientSelect');

                        // Mevcut seçenekleri temizle (placeholder hariç)
                        select.find('option:not(:first)').remove();

                        // Yeni seçenekleri ekle
                        data.clients.forEach(client => {
                            const option = new Option(client.display_text, client.id, false, false);
                            // Data attribute'lar ekle (auto-fill için)
                            option.setAttribute('data-entity-type', client.entity_type);
                            option.setAttribute('data-first-name', client.first_name);
                            option.setAttribute('data-surname', client.surname);
                            option.setAttribute('data-identity-number', client.identity_number);
                            select.append(option);
                        });

                        // Select2 initialize et
                        select.select2({
                            placeholder: 'Müvekkil seçiniz veya arayın...',
                            allowClear: true,
                            language: {
                                noResults: function() {
                                    return "Sonuç bulunamadı";
                                },
                                searching: function() {
                                    return "Aranıyor...";
                                }
                            }
                        });

                        // Seçim değiştiğinde auto-fill
                        select.on('change', function() {
                            const selectedOption = $(this).find(':selected');

                            if (selectedOption.val()) {
                                // Seçilen müvekkil bilgilerini form alanlarına doldur
                                const entityType = selectedOption.attr('data-entity-type');
                                const firstName = selectedOption.attr('data-first-name');
                                const surname = selectedOption.attr('data-surname');
                                const identityNumber = selectedOption.attr('data-identity-number');

                                document.getElementById('addEntityType').value = entityType;
                                document.getElementById('addName').value = firstName;
                                document.getElementById('addSurname').value = surname || '';
                                document.getElementById('addTc').value = identityNumber || '';

                                // Entity type değiştiğinde label'ları güncelle
                                if (entityType === 'company') {
                                    document.querySelector('label[for="addName"]').textContent = 'Kurum Adı';
                                    document.querySelector('label[for="addSurname"]').textContent = 'Kurum Ek Bilgi (Opsiyonel)';
                                    document.querySelector('label[for="addTc"]').textContent = 'Vergi/Mersis/Ticaret Sicil No';
                                    document.getElementById('addSurname').required = false;
                                } else {
                                    document.querySelector('label[for="addName"]').textContent = 'Ad';
                                    document.querySelector('label[for="addSurname"]').textContent = 'Soyad';
                                    document.querySelector('label[for="addTc"]').textContent = 'TC Kimlik No';
                                    document.getElementById('addSurname').required = true;
                                }
                            } else {
                                // Seçim temizlenirse form alanlarını da temizle
                                document.getElementById('addEntityType').value = 'person';
                                document.getElementById('addName').value = '';
                                document.getElementById('addSurname').value = '';
                                document.getElementById('addTc').value = '';
                            }
                        });
                    } else {
                        console.error('Kayıtlı müvekkiller yüklenemedi:', data.error);
                    }
                })
                .catch(error => {
                    console.error('API hatası:', error);
                });
        }

        // Modal kapatma
        if (closeAddPaymentModal) {
            closeAddPaymentModal.addEventListener('click', function() {
                addPaymentModal.style.display = 'none';
                addPaymentForm.reset();
            });
        }

        if (cancelAddPaymentBtn) {
            cancelAddPaymentBtn.addEventListener('click', function() {
                addPaymentModal.style.display = 'none';
                addPaymentForm.reset();
            });
        }

        // Modal dışına tıklama - devre dışı bırakıldı (kullanıcı isteği üzerine)
        // window.addEventListener('click', function(event) {
        //     if (event.target == addPaymentModal) {
        //         addPaymentModal.style.display = 'none';
        //         addPaymentForm.reset();
        //     }
        // });

        // Form submit
        if (addPaymentForm) {
            addPaymentForm.addEventListener('submit', function(event) {
                event.preventDefault();

                // Tarih alanlarının dolu olup olmadığını kontrol et
                const registrationDate = document.getElementById('addRegistrationDate').value;

                if (!registrationDate) {
                    alert('Lütfen borç kayıt tarihini doldurun.');
                    return;
                }

                // Tutar kontrolü ve formatlanmış değeri parse et
                const amountFormatted = document.getElementById('addAmount').value.trim();
                // Formatlanmış değeri sayıya çevir: 1.234,56 -> 1234.56
                const amountValue = amountFormatted.replace(/\./g, '').replace(',', '.');
                if (amountValue === '' || isNaN(parseFloat(amountValue))) {
                    alert('Lütfen geçerli bir sayı girin.');
                    return;
                }

                // CSRF token al
                let csrfTokenValue = '';
                if (typeof CSRF_TOKEN !== 'undefined') {
                    csrfTokenValue = CSRF_TOKEN;
                } else {
                    const csrfTokenElement = addPaymentForm.querySelector('input[name="csrf_token"]');
                    csrfTokenValue = csrfTokenElement ? csrfTokenElement.value : '';
                }

                // Form verisini oluştur
                const formData = new FormData();

                // Kayıtlı müvekkil sistemi kontrolü
                const isRegisteredClient = registeredClientBtn.classList.contains('active');
                formData.append('client_type', isRegisteredClient ? 'registered' : 'new');

                if (isRegisteredClient) {
                    // Kayıtlı müvekkil seçildi
                    const selectedClientId = $('#registeredClientSelect').val();
                    if (!selectedClientId) {
                        alert('Lütfen kayıtlı müvekkil seçiniz.');
                        return;
                    }
                    formData.append('registered_client_id', selectedClientId);
                } else {
                    // Yeni müvekkil
                    const saveToRegistered = document.getElementById('saveToRegistered').checked;
                    formData.append('save_to_registered', saveToRegistered ? 'true' : 'false');
                }

                formData.append('payment_type', document.getElementById('paymentType').value);
                formData.append('entity_type', document.getElementById('addEntityType').value);
                formData.append('name', document.getElementById('addName').value);
                // Kurum seçiliyse surname boş gönderilebilir
                const surnameValue = document.getElementById('addSurname').value;
                formData.append('surname', surnameValue || '');
                formData.append('tc', document.getElementById('addTc').value);
                formData.append('amount', amountValue); // Parse edilmiş değeri gönder
                formData.append('currency', document.getElementById('addCurrency').value);
                formData.append('installments', document.getElementById('addInstallments').value);
                formData.append('registration_date', document.getElementById('addRegistrationDate').value);
                
                // Son ödeme tarihi isteğe bağlı
                const dueDate = document.getElementById('addDueDate').value;
                if (dueDate) {
                    formData.append('due_date', dueDate);
                }

                // Ödeme durumunu ekle (checkbox işaretliyse 'paid', değilse 'unpaid')
                const statusCheckbox = document.getElementById('addStatus');
                formData.append('status', statusCheckbox.checked ? 'paid' : 'unpaid');

                // Ödeme tarihi (ödeme durumu ödendi ise)
                if (statusCheckbox.checked) {
                    const paymentDate = document.getElementById('addPaymentDate').value;
                    if (paymentDate) {
                        formData.append('payment_date', paymentDate);
                    }
                }

                const description = document.getElementById('addDescription').value;
                if (description) {
                    formData.append('description', description);
                }

                if (csrfTokenValue) {
                    formData.append('csrf_token', csrfTokenValue);
                }

                // Form verisini gönder
                fetch('/odemeler', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfTokenValue
                    },
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Ödeme kaydedilemedi: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ödeme kaydedilemedi: ' + error.message);
                });
            });
        }

        // Yeni basitleştirilmiş ödeme kaydetme fonksiyonu (eski form için - artık kullanılmıyor ama uyumluluk için kalıyor)
        window.savePayment = function(event) {
            event.preventDefault();
            
            // Tarih alanlarının dolu olup olmadığını kontrol et
            const registrationDate = document.querySelector('[name="registration_date"]').value;
            const dueDate = document.querySelector('[name="due_date"]').value;
            
            if (!registrationDate || !dueDate) {
                alert('Lütfen tarih alanlarını doldurun.');
                return;
            }
            
            // Form verilerini al
            const formElement = document.getElementById('paymentForm');
            const amountInput = document.getElementById('amount');
            let amountValue = amountInput.value.trim();
            
            // Basit sayısal kontrol
            if (amountValue === '' || isNaN(parseFloat(amountValue))) {
                alert('Lütfen geçerli bir sayı girin.');
                return;
            }
            
            // CSRF token al - önce global değişkeni kontrol et, sonra form elemanını
            let csrfTokenValue = '';
            
            // Global CSRF_TOKEN değişkeni varsa kullan
            if (typeof CSRF_TOKEN !== 'undefined') {
                csrfTokenValue = CSRF_TOKEN;
                console.log('Global CSRF Token kullanıldı');
            } else {
                // Form içinden CSRF token al
                const csrfTokenElement = document.querySelector('input[name="csrf_token"]');
                csrfTokenValue = csrfTokenElement ? csrfTokenElement.value : '';
                console.log('Form CSRF Token kullanıldı');
            }
            
            console.log('CSRF Token bulundu:', csrfTokenValue ? 'Evet' : 'Hayır');
            console.log('CSRF Token değeri:', csrfTokenValue.substring(0, 10) + '...');
            
            // Form verisini manuel olarak oluştur
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('surname', document.getElementById('surname').value);
            formData.append('tc', document.getElementById('tc').value);
            formData.append('amount', document.getElementById('amount').value);
            formData.append('currency', document.getElementById('currency').value);
            formData.append('installments', document.getElementById('installments').value);
            formData.append('registration_date', document.getElementById('registration_date').value);
            formData.append('due_date', document.getElementById('due_date').value);
            
            // CSRF token ekle (eğer varsa)
            if (csrfTokenValue) {
                formData.append('csrf_token', csrfTokenValue);
            }
            
            // Form verisini gönder
            fetch('/odemeler', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfTokenValue
                },
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.success) {
                    // Başarılı olduysa sayfayı yenile
                    window.location.reload();
                } else {
                    // Hata mesajını göster
                    alert('Ödeme kaydedilemedi: ' + (data.error || 'Bilinmeyen bir hata oluştu'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Ödeme kaydedilemedi: ' + error.message);
            });
        };

        // Önemli: Düzenleme modalını açma fonksiyonu - formatlamayı yeniden düzenleme
        window.openEditModal = function(button) {
            const modal = document.getElementById('editModal');
            if (!modal) {
                console.error("Düzenleme modalı bulunamadı!");
                return;
            }

            const row = button.closest('tr');
            const clientId = row.getAttribute('data-client-id');

            // Form alanlarını doldur
            document.getElementById('editClientId').value = clientId;
            document.getElementById('editName').value = row.querySelector('td:nth-child(2)').innerText;
            document.getElementById('editSurname').value = row.querySelector('td:nth-child(3)').innerText;
            document.getElementById('editTc').value = row.querySelector('td:nth-child(4)').innerText;

            // Para miktarı ve para birimini data attribute'lardan al (HAM DEĞERLER)
            const amount = row.getAttribute('data-amount');
            const currency = row.getAttribute('data-currency');

            document.getElementById('editAmount').value = amount;
            document.getElementById('editCurrency').value = currency;

            document.getElementById('editInstallments').value = row.querySelector('td:nth-child(6)').innerText;

            // Tarihleri oku ve YYYY-MM-DD formatına çevir
            const registrationDate = row.querySelector('td:nth-child(7)').innerText;
            const dueDate = row.querySelector('td:nth-child(8)').innerText;
            
            // Tarihleri formatla (DD.MM.YYYY -> YYYY-MM-DD)
            if (registrationDate && registrationDate !== '-') {
                const [day, month, year] = registrationDate.split('.');
                document.getElementById('editRegistrationDate').value = `${year}-${month}-${day}`;
            }
            
            if (dueDate && dueDate !== '-') {
                const [day, month, year] = dueDate.split('.');
                document.getElementById('editDueDate').value = `${year}-${month}-${day}`;
            }

            const isPaid = row.querySelector('td:nth-child(10)').textContent.trim() === 'Ödendi';
            document.getElementById('editStatus').checked = isPaid;
            document.querySelector('.status-text').textContent = isPaid ? 'Ödendi' : 'Ödenmedi';

            // Açıklama alanını doldur (eğer varsa)
            const description = row.getAttribute('data-description');
            const descriptionArea = document.getElementById('editDescription');
            descriptionArea.value = description === 'None' ? '' : (description || '');
            
            modal.style.display = 'flex';
        };
        
        // Global fonksiyonlar zaten yukarıda window'a atandı
        // savePayment, openEditModal ve deletePayment global olarak tanımlandı
        // updateClient aşağıda tanımlanacak

        // Döviz kurları için global değişken
        let exchangeRates = {
            USD: 41.60, // Varsayılan kur (Google'dan alınan güncel kur)
            EUR: 48.80, // Varsayılan kur (Google'dan alınan güncel kur)
            apiSource: 'Varsayılan'
        };

        // Güncel döviz kurlarını çek - Backend proxy üzerinden (CORS sorunu çözümü)
        async function fetchExchangeRates() {
            try {
                // Backend proxy endpoint'ini kullan (CORS sorununu çözer)
                const response = await fetch('/api/doviz_kurlari');
                if (response.ok) {
                    const data = await response.json();

                    exchangeRates.USD = parseFloat(data.USD);
                    exchangeRates.EUR = parseFloat(data.EUR);
                    exchangeRates.lastUpdate = data.lastUpdate;
                    exchangeRates.apiSource = data.apiSource;

                    console.log('✅ Döviz kurları güncellendi:', exchangeRates);
                    return;
                }
            } catch (error) {
                console.warn('⚠️ Döviz kuru API başarısız, varsayılan kurlar kullanılıyor:', error);
                exchangeRates.lastUpdate = new Date().toISOString().split('T')[0];
                exchangeRates.apiSource = 'Varsayılan';
            }
        }

        // Müşteri verilerini topla ve özet istatistikleri oluştur
        // Global clients data array (filtreleme için)
        let globalClientsData = [];

        async function generateStats() {
            console.log("İstatistikler hesaplanıyor...");

            // İlk önce döviz kurlarını çek
            await fetchExchangeRates();

            const clients = Array.from(document.querySelectorAll('.data-table tbody tr'));
            
            // Global clients data'yı temizle ve yeniden doldur
            globalClientsData = [];
            
            // Temel değişkenleri başlat
            const currencyTotals = {
                'TL': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 },
                'USD': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 },
                'EUR': { total: 0, paid: 0, unpaid: 0, expectedNextYear: 0, transactions: 0 }
            };

            const monthlyData = {};
            const yearlyData = {};
            const expectedPaymentsByYear = {};
            const clientTotals = {}; // Müvekkil bazlı toplamlar
            
            let highestPayment = { amount: 0, clientName: '-', date: '-', currency: 'TL' };
            let mostOverdue = { days: 0, clientName: '-', amount: 0, currency: 'TL', dueDate: '-' };
            let totalOverdueAmountTL = 0; // *** YENİ: Vadesi geçmiş TL tutarı için ***
            
            // İstatistik sayaçları
            let paidCount = 0;
            let unpaidCount = 0;
            let overdueCount = 0;
            let totalInstallments = 0;
            let paidInstallments = 0;
            let totalOverdueDays = 0;
            
            // Tarih hesaplamaları için
            const years = new Set();
            const currentDate = new Date();
            const currentYear = currentDate.getFullYear();
            const nextYear = currentYear + 1;
            
            // Önümüzdeki dönemler için tahminler
            const predictions = {
                days30: 0,
                days90: 0,
                days180: 0,
                days365: 0
            };
            
            // Son 5 yılı ekle
            for (let i = 0; i < 5; i++) {
                years.add(currentYear - i);
            }
            years.add(nextYear);
            
            // Ödeme türü bazlı istatistikler
            const paymentTypeStats = {};

            // Kişi/Kurum istatistikleri
            const entityStats = {
                person: { total: 0, paid: 0, unpaid: 0, count: 0, paidCount: 0 },
                company: { total: 0, paid: 0, unpaid: 0, count: 0, paidCount: 0 }
            };

            // Ödeme tarihi istatistikleri
            const paymentDateStats = {
                thisMonth: { total: 0, count: 0 },
                thisYear: { total: 0, count: 0 },
                totalDuration: 0,
                durationCount: 0,
                fastestDuration: null,
                fastestClient: '-'
            };

            // Her bir müvekkil için verileri topla
            clients.forEach(client => {
                const clientId = client.getAttribute('data-client-id');
                // Sütun sıralaması: 0=payment_type, 1=name, 2=surname, 3=tc, 4=amount, 5=installments, 6=reg_date, 7=due_date, 8=payment_date, 9=status
                const paymentType = client.querySelector('td:nth-child(1)').textContent.trim();
                const name = client.querySelector('td:nth-child(2)').textContent.trim();
                const surname = client.querySelector('td:nth-child(3)').textContent.trim();
                const clientName = name + ' ' + surname;
                const tcNo = client.querySelector('td:nth-child(4)').textContent.trim();

                // Entity type belirleme: data attribute'dan al
                const entityType = client.getAttribute('data-entity-type') || 'person';

                // Para bilgilerini al ve parse et
                const amountText = client.querySelector('td:nth-child(5)').textContent.trim();
                const parts = amountText.split(' ');
                // Türkçe sayı formatını parse et: "1.234,56" -> 1234.56
                const amountStr = parts[0].replace(/\./g, '').replace(',', '.');
                const amount = parseFloat(amountStr);
                const currency = parts[1] || 'TL';
                
                // Taksit sayısını al
                const installmentsText = client.querySelector('td:nth-child(6)').textContent.trim();
                const installments = (installmentsText === '-' || installmentsText === '') ? 0 : parseInt(installmentsText);

                console.log(`[generateStats] İşlenen Kayıt: Ödeme Türü: ${paymentType}, Ad: ${clientName}, Tutar: ${amount} ${currency}`);

                // currencyTotals içinde para birimi yoksa, tüm alanlarla birlikte başlat
                if (!currencyTotals[currency]) {
                    currencyTotals[currency] = { 
                        total: 0, 
                        paid: 0, 
                        unpaid: 0, 
                        expectedNextYear: 0, // Bu önemli
                        transactions: 0 
                    };
                }

                // Ödeme türü istatistiklerini güncelle
                if (paymentType && paymentType !== '-') {
                    if (!paymentTypeStats[paymentType]) {
                        paymentTypeStats[paymentType] = {
                            total: 0,
                            paid: 0,
                            unpaid: 0,
                            count: 0,
                            paidCount: 0,
                            unpaidCount: 0
                        };
                    }
                }

                // Taksit bilgisini al (zaten yukarıda tanımlandı, tekrar kullan)
                totalInstallments += installments;

                // Ödeme durumu
                const statusText = client.querySelector('td:nth-child(10)').textContent.trim();
                const isPaid = statusText.includes('Ödendi');

                // Tarih bilgilerini al
                const registrationDateText = client.querySelector('td:nth-child(7)').textContent.trim();
                const dueDateText = client.querySelector('td:nth-child(8)').textContent.trim();
                const paymentDateText = client.querySelector('td:nth-child(9)').textContent.trim();
                
                let registrationDate = null;
                let dueDate = null;
                let paymentDate = null;
                
                if (registrationDateText !== '-') {
                    const [day, month, year] = registrationDateText.split('.').map(Number);
                    registrationDate = new Date(year, month - 1, day);
                }
                
                if (dueDateText !== '-') {
                    const [day, month, year] = dueDateText.split('.').map(Number);
                    dueDate = new Date(year, month - 1, day);
                }
                
                if (paymentDateText !== '-') {
                    const [day, month, year] = paymentDateText.split('.').map(Number);
                    paymentDate = new Date(year, month - 1, day);
                }

                // Entity type bilgisini al (surname yukarıda zaten tanımlı)
                // surname zaten yukarıda tanımlandı, tekrar tanımlamaya gerek yok

                // Para birimini TL'ye çevir
                let amountInTL = amount;
                if (currency === 'USD') {
                    amountInTL = amount * parseFloat(exchangeRates.USD);
                } else if (currency === 'EUR') {
                    amountInTL = amount * parseFloat(exchangeRates.EUR);
                }

                // Entity type istatistiklerini güncelle
                if (!isNaN(amountInTL)) {
                    entityStats[entityType].total += amountInTL;
                    entityStats[entityType].count++;

                    if (isPaid) {
                        entityStats[entityType].paid += amountInTL;
                        entityStats[entityType].paidCount++;
                    } else {
                        entityStats[entityType].unpaid += amountInTL;
                    }
                }

                // Ödeme tarihi istatistiklerini güncelle
                if (paymentDate && isPaid) {
                    const paymentMonth = paymentDate.getMonth();
                    const paymentYear = paymentDate.getFullYear();
                    const currentMonth = currentDate.getMonth();
                    const currentYear = currentDate.getFullYear();

                    // Bu ay yapılan ödemeler
                    if (paymentMonth === currentMonth && paymentYear === currentYear) {
                        paymentDateStats.thisMonth.total += amountInTL;
                        paymentDateStats.thisMonth.count++;
                    }

                    // Bu yıl yapılan ödemeler
                    if (paymentYear === currentYear) {
                        paymentDateStats.thisYear.total += amountInTL;
                        paymentDateStats.thisYear.count++;
                    }

                    // Ödeme süresi hesapla (kayıt tarihinden ödeme tarihine)
                    if (registrationDate) {
                        const durationDays = Math.floor((paymentDate - registrationDate) / (1000 * 60 * 60 * 24));
                        if (durationDays >= 0) {
                            paymentDateStats.totalDuration += durationDays;
                            paymentDateStats.durationCount++;

                            // En hızlı ödemeyi bul
                            if (paymentDateStats.fastestDuration === null || durationDays < paymentDateStats.fastestDuration) {
                                paymentDateStats.fastestDuration = durationDays;
                                paymentDateStats.fastestClient = clientName.trim();
                            }
                        }
                    }
                }
                
                // Müvekkil başına toplam hesapla
                if (!clientTotals[clientId]) {
                    clientTotals[clientId] = {
                        name: clientName,
                        tcNo: tcNo,
                        totalAmount: 0,
                        currency: currency
                    };
                }
                clientTotals[clientId].totalAmount += amount;
                
                // Geçerli para birimi yoksa oluştur
                if (!currencyTotals[currency]) {
                    currencyTotals[currency] = { 
                        total: 0, paid: 0, unpaid: 0, 
                        expectedNextYear: 0, transactions: 0 
                    };
                }
                
                // İşlem sayısını artır
                currencyTotals[currency].transactions++;
                
                // Para birimi bazında istatistikleri güncelle
                if (!isNaN(amount)) {
                    currencyTotals[currency].total += amount;

                    // Ödeme türü istatistiklerini güncelle (TÜM PARA BİRİMLERİ - TL'ye çevrilmiş)
                    if (paymentType && paymentType !== '-') {
                        // Para birimini TL'ye çevir
                        let amountInTL = amount;
                        if (currency === 'USD') {
                            amountInTL = amount * parseFloat(exchangeRates.USD);
                        } else if (currency === 'EUR') {
                            amountInTL = amount * parseFloat(exchangeRates.EUR);
                        }

                        paymentTypeStats[paymentType].total += amountInTL;
                        paymentTypeStats[paymentType].count++;
                    }

                    if (isPaid) {
                        currencyTotals[currency].paid += amount;
                        paidCount++;
                        paidInstallments += installments;

                        if (paymentType && paymentType !== '-') {
                            let amountInTL = amount;
                            if (currency === 'USD') {
                                amountInTL = amount * parseFloat(exchangeRates.USD);
                            } else if (currency === 'EUR') {
                                amountInTL = amount * parseFloat(exchangeRates.EUR);
                            }

                            paymentTypeStats[paymentType].paid += amountInTL;
                            paymentTypeStats[paymentType].paidCount++;
                        }
                    } else {
                        currencyTotals[currency].unpaid += amount;
                        unpaidCount++;

                        if (paymentType && paymentType !== '-') {
                            let amountInTL = amount;
                            if (currency === 'USD') {
                                amountInTL = amount * parseFloat(exchangeRates.USD);
                            } else if (currency === 'EUR') {
                                amountInTL = amount * parseFloat(exchangeRates.EUR);
                            }

                            paymentTypeStats[paymentType].unpaid += amountInTL;
                            paymentTypeStats[paymentType].unpaidCount++;
                        }
                        
                        // Vadesi geçmiş ödemeler
                        if (dueDate && dueDate < currentDate) {
                            overdueCount++;
                            
                            // Gecikme süresi (gün)
                            const overdueDays = Math.floor((currentDate - dueDate) / (1000 * 60 * 60 * 24));
                            totalOverdueDays += overdueDays;
                            
                            // En uzun vadesi geçmiş ödemeyi bul
                            if (overdueDays > mostOverdue.days) {
                                mostOverdue = {
                                    days: overdueDays,
                                    clientName: clientName,
                                    amount: amount,
                                    currency: currency,
                                    dueDate: dueDateText
                                };
                            }
                            
                            // *** YENİ: Vadesi geçmiş TL tutarını topla ***
                            if (currency === 'TL') {
                                totalOverdueAmountTL += amount;
                            }
                            // *** BİTTİ: Vadesi geçmiş TL tutarını topla ***
                        }
                        
                        // Gelecek tahminleri için - vadesi yaklaşan ödemeler
                        if (dueDate && dueDate > currentDate) {
                            const daysUntilDue = Math.floor((dueDate - currentDate) / (1000 * 60 * 60 * 24));
                            
                            if (daysUntilDue <= 30) predictions.days30 += amount;
                            if (daysUntilDue <= 90) predictions.days90 += amount;
                            if (daysUntilDue <= 180) predictions.days180 += amount;
                            if (daysUntilDue <= 365) predictions.days365 += amount;
                        }
                        
                        // Yıla göre beklenen ödemeler
                        if (dueDate) {
                            const dueYear = dueDate.getFullYear();
                            if (!expectedPaymentsByYear[dueYear]) {
                                expectedPaymentsByYear[dueYear] = { 
                                    'TL': 0, 'USD': 0, 'EUR': 0 
                                };
                            }
                            expectedPaymentsByYear[dueYear][currency] = 
                                (expectedPaymentsByYear[dueYear][currency] || 0) + amount;
                            
                            if (dueYear === nextYear) {
                                currencyTotals[currency].expectedNextYear += amount;
                            }
                        }
                    }
                    
                    // En yüksek ödemeyi bul (güncel kurlarla)
                    let comparisonAmount = amount;
                    if (currency === 'USD') comparisonAmount *= parseFloat(exchangeRates.USD);
                    if (currency === 'EUR') comparisonAmount *= parseFloat(exchangeRates.EUR);

                    if (comparisonAmount > highestPayment.amount) {
                        highestPayment = {
                            amount: amount,
                            clientName: clientName,
                            date: dueDate ? dueDateText : registrationDateText,
                            currency: currency,
                            displayAmount: comparisonAmount
                        };
                    }
                }
                
                // Aylık ve yıllık verileri güncelle
                if (dueDate) { // registrationDate yerine dueDate kullanılıyor
                    const year = dueDate.getFullYear(); // dueDate kullanılıyor
                    const month = dueDate.getMonth() + 1; // dueDate kullanılıyor
                    years.add(year);
                    
                    // Yıllık veriler
                    if (!yearlyData[year]) {
                        yearlyData[year] = {
                            amount: 0, paid: 0, unpaid: 0,
                            currencies: { 
                                'TL': { total: 0, paid: 0, unpaid: 0 }, 
                                'USD': { total: 0, paid: 0, unpaid: 0 }, 
                                'EUR': { total: 0, paid: 0, unpaid: 0 } 
                            }
                        };
                    }
                    
                    if (!isNaN(amount)) {
                        yearlyData[year].currencies[currency].total += amount;
                        
                        if (isPaid) {
                            yearlyData[year].currencies[currency].paid += amount;
                        } else {
                            yearlyData[year].currencies[currency].unpaid += amount;
                        }
                        
                        // Yıllık genel toplamlar için sadece TL'yi değil,
                        // seçilen para birimine göre veya "ALL" ise tümünü çevirerek hesapla.
                        // Bu kısım createYearlyChart ve updateYearlyCards içinde daha doğru yönetilecek.
                        // Şimdilik TL bazlı bırakıyorum, ancak bu genel mantık ileride değişebilir.
                        if (currency === 'TL') { // Bu koşul daha sonra kaldırılabilir/genelleştirilebilir.
                            yearlyData[year].amount += amount;
                            if (isPaid) yearlyData[year].paid += amount;
                            else yearlyData[year].unpaid += amount;
                        }
                    }
                    
                    // Aylık veriler
                    const yearMonth = `${year}-${String(month).padStart(2, '0')}`;
                    if (!monthlyData[yearMonth]) {
                        monthlyData[yearMonth] = {
                            amount: 0, paid: 0, unpaid: 0,
                            currencies: { 
                                'TL': { total: 0, paid: 0, unpaid: 0 }, 
                                'USD': { total: 0, paid: 0, unpaid: 0 }, 
                                'EUR': { total: 0, paid: 0, unpaid: 0 } 
                            }
                        };
                    }
                    
                    if (!isNaN(amount)) {
                        monthlyData[yearMonth].currencies[currency].total += amount;
                        console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].total güncellendi: ${monthlyData[yearMonth].currencies[currency].total}`); 
                        
                        if (isPaid) {
                            monthlyData[yearMonth].currencies[currency].paid += amount;
                            console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].paid güncellendi: ${monthlyData[yearMonth].currencies[currency].paid}`); 
                        } else {
                            monthlyData[yearMonth].currencies[currency].unpaid += amount;
                            console.log(`[generateStats - dueDate based] monthlyData[${yearMonth}].currencies[${currency}].unpaid güncellendi: ${monthlyData[yearMonth].currencies[currency].unpaid}`); 
                        }
                        
                        // Aylık genel toplamlar için de benzer şekilde, TL bazlı bırakıyorum.
                        // Bu da createMonthlyChart ve updateMonthlyCards içinde daha doğru yönetilecek.
                         if (currency === 'TL') { // Bu koşul daha sonra kaldırılabilir/genelleştirilebilir.
                            monthlyData[yearMonth].amount += amount;
                            if (isPaid) monthlyData[yearMonth].paid += amount;
                            else monthlyData[yearMonth].unpaid += amount;
                        }
                    }
                }
                
                // Global clients data'ya ekle (filtreleme için)
                globalClientsData.push({
                    id: clientId,
                    name: name,
                    surname: surname,
                    clientName: clientName,
                    entityType: entityType,
                    paymentType: paymentType,
                    amount: amount,
                    currency: currency,
                    amountInTL: amountInTL,
                    installments: installments,
                    registrationDate: registrationDate,
                    dueDate: dueDate,
                    paymentDate: paymentDate,
                    isPaid: isPaid,
                    statusText: statusText
                });
            });
            
            // Müvekkil başına ortalama ve varyasyon hesapla
            let highestClient = { id: null, amount: 0, name: '-' };
            let lowestClient = { id: null, amount: Infinity, name: '-' };
            let totalClientAmount = 0;
            
            // Müvekkil istatistiklerini hesapla
            Object.keys(clientTotals).forEach(clientId => {
                const client = clientTotals[clientId];
                totalClientAmount += client.totalAmount;
                
                if (client.totalAmount > highestClient.amount) {
                    highestClient = { 
                        id: clientId, 
                        amount: client.totalAmount, 
                        name: client.name,
                        currency: client.currency
                    };
                }
                
                if (client.totalAmount < lowestClient.amount && client.totalAmount > 0) {
                    lowestClient = { 
                        id: clientId, 
                        amount: client.totalAmount, 
                        name: client.name,
                        currency: client.currency
                    };
                }
            });
            
            const avgPerClient = clients.length > 0 ? totalClientAmount / clients.length : 0;
            const clientVariation = avgPerClient > 0 ? 
                Math.abs((highestClient.amount - lowestClient.amount) / avgPerClient) * 100 : 0;
            
            // Analiz değerlerini hesapla
            const paidPercentage = (paidCount / (paidCount + unpaidCount)) * 100 || 0;
            const unpaidPercentage = 100 - paidPercentage;
            const overduePercentage = unpaidCount > 0 ? (overdueCount / unpaidCount) * 100 : 0;
            
            const avgDueTime = overdueCount > 0 ? totalOverdueDays / overdueCount : 0;
            const avgInstallments = clients.length > 0 ? (totalInstallments / clients.length).toFixed(1) : 0;
            const avgPaidInstallments = paidCount > 0 ? (paidInstallments / paidCount).toFixed(1) : 0;

            // En çok kullanılan para birimi
            const mostUsedCurrency = Object.keys(currencyTotals).reduce((a, b) =>
                currencyTotals[a].transactions > currencyTotals[b].transactions ? a : b);
            
            // Yıl filtresi güncelle
            const yearFilter = document.getElementById('monthlyYearFilter');
            const existingSelectedYear = yearFilter.value;
            yearFilter.innerHTML = '';
            
            const sortedYears = Array.from(years).sort((a, b) => b - a);
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            
            if (sortedYears.includes(parseInt(existingSelectedYear))) {
                yearFilter.value = existingSelectedYear;
            }
            
            // Filtre olaylarını güncelle
            const listenerUpdate = (elementId, handler) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.removeEventListener('change', handler);
                    element.addEventListener('change', handler);
                }
            };
            
            listenerUpdate('monthlyYearFilter', createMonthlyChart);
            listenerUpdate('monthlyCurrencyFilter', createMonthlyChart);
            listenerUpdate('yearlyCurrencyFilter', createYearlyChart);
            listenerUpdate('yearlyChartType', createYearlyChart);
            
            // Verileri global olarak tut
            window.statsData = {
                currencyTotals,
                monthlyData,
                yearlyData,
                expectedPaymentsByYear,
                paidCount,
                unpaidCount,
                overdueCount,
                years: sortedYears,
                highestPayment,
                mostOverdue,
                totalInstallments,
                paidInstallments,
                predictions,
                clientTotals,
                highestClient,
                lowestClient,
                avgPerClient,
                clientVariation,
                totalOverdueAmountTL,
                totalOverdueDays,
                avgDueTime,
                avgInstallments,
                avgPaidInstallments,
                mostUsedCurrency,
                paidPercentage,
                unpaidPercentage,
                overduePercentage,
                clients: clients.length,
                paymentTypeStats,
                entityStats,
                paymentDateStats
            };
            
            // Aktif sekmeye göre ilgili grafik ve tabloyu oluştur
            // const activeTab = document.querySelector('.stats-tab-btn.active').getAttribute('data-tab'); // ESKİ SATIR
            // updateActiveTab(activeTab); // ESKİ SATIR

            // Doğrudan özet sekmesi fonksiyonlarını çağır
            populateSummaryTab(window.statsData);
            // createExpectedPaymentsByYearChart(); // ÇAĞRI BURADAN KALDIRILDI
            createSummaryChart(window.statsData);
            
            // Yeni grafikleri oluştur
            createEntityTypeChart();
            createPaymentDatesChart();
            
            console.log("İstatistikler hesaplandı:", window.statsData);
        }

        // Kişi/Kurum analiz grafiği oluştur
        function createEntityTypeChart() {
            const canvas = document.getElementById('entityTypeChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Eski grafiği varsa yok et
            if (window.entityTypeChartInstance) {
                window.entityTypeChartInstance.destroy();
            }

            const entityStats = window.statsData.entityStats;
            
            window.entityTypeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Kişi Ödemeleri', 'Kurum Ödemeleri'],
                    datasets: [
                        {
                            label: 'Toplam',
                            data: [entityStats.person.total, entityStats.company.total],
                            backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 159, 64, 0.6)'],
                            borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 159, 64, 1)'],
                            borderWidth: 2
                        },
                        {
                            label: 'Ödendi',
                            data: [entityStats.person.paid, entityStats.company.paid],
                            backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)'],
                            borderColor: ['rgba(75, 192, 192, 1)', 'rgba(153, 102, 255, 1)'],
                            borderWidth: 2
                        },
                        {
                            label: 'Ödenmedi',
                            data: [entityStats.person.unpaid, entityStats.company.unpaid],
                            backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(255, 206, 86, 0.6)'],
                            borderColor: ['rgba(255, 99, 132, 1)', 'rgba(255, 206, 86, 1)'],
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR', {
                                        style: 'currency',
                                        currency: 'TRY'
                                    });
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Kişi/Kurum Ödeme Analizi'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Ödeme tarihleri analiz grafiği oluştur
        function createPaymentDatesChart() {
            const canvas = document.getElementById('paymentDatesChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Eski grafiği varsa yok et
            if (window.paymentDatesChartInstance) {
                window.paymentDatesChartInstance.destroy();
            }

            const paymentDateStats = window.statsData.paymentDateStats;
            
            window.paymentDatesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Bu Ay', 'Bu Yıl'],
                    datasets: [{
                        label: 'Yapılan Ödemeler (TL)',
                        data: [paymentDateStats.thisMonth.total, paymentDateStats.thisYear.total],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(54, 162, 235, 0.6)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR', {
                                        style: 'currency',
                                        currency: 'TRY'
                                    });
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ödeme Tarihleri Analizi'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Para birimi dağılım grafiği oluştur
        function createCurrencyDistributionChart(clients) {
            const canvas = document.getElementById('currencyDistributionChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Eski grafiği varsa yok et
            if (window.currencyDistributionChartInstance) {
                window.currencyDistributionChartInstance.destroy();
            }

            // Para birimi dağılımını hesapla
            const currencyData = { TL: 0, USD: 0, EUR: 0 };
            clients.forEach(client => {
                if (client.currency && currencyData.hasOwnProperty(client.currency)) {
                    currencyData[client.currency] += parseFloat(client.amount) || 0;
                }
            });
            
            window.currencyDistributionChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['TL', 'USD', 'EUR'],
                    datasets: [{
                        data: [currencyData.TL, currencyData.USD, currencyData.EUR],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(54, 162, 235, 0.7)',
                            'rgba(255, 206, 86, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Para Birimi Dağılımı'
                        },
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': ' + value.toLocaleString('tr-TR', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    }
                }
            });
        }

        // Para birimi durum grafiği oluştur
        function createCurrencyStatusChart(clients) {
            const canvas = document.getElementById('currencyStatusChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Eski grafiği varsa yok et
            if (window.currencyStatusChartInstance) {
                window.currencyStatusChartInstance.destroy();
            }

            // Para birimi ve durum dağılımını hesapla
            const currencyStats = {
                TL: { paid: 0, unpaid: 0 },
                USD: { paid: 0, unpaid: 0 },
                EUR: { paid: 0, unpaid: 0 }
            };
            
            clients.forEach(client => {
                const currency = client.currency || 'TL';
                const amount = parseFloat(client.amount) || 0;
                if (currencyStats[currency]) {
                    if (client.status === 'Ödendi') {
                        currencyStats[currency].paid += amount;
                    } else {
                        currencyStats[currency].unpaid += amount;
                    }
                }
            });
            
            window.currencyStatusChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['TL', 'USD', 'EUR'],
                    datasets: [
                        {
                            label: 'Ödendi',
                            data: [currencyStats.TL.paid, currencyStats.USD.paid, currencyStats.EUR.paid],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2
                        },
                        {
                            label: 'Ödenmedi',
                            data: [currencyStats.TL.unpaid, currencyStats.USD.unpaid, currencyStats.EUR.unpaid],
                            backgroundColor: 'rgba(255, 99, 132, 0.6)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2
                                    });
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Para Birimi Ödeme Durumu'
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        // Para birimi grafiklerini güncelle
        function updateCurrencyCharts() {
            const filteredClients = getFilteredClients('currency');
            createCurrencyDistributionChart(filteredClients);
            createCurrencyStatusChart(filteredClients);
            updateCurrencyStats(filteredClients);
            populateCurrencyTable();
        }

        // Para birimi istatistiklerini güncelle
        function updateCurrencyStats(clients) {
            const currencyData = { TL: 0, USD: 0, EUR: 0 };
            clients.forEach(client => {
                if (client.currency && currencyData.hasOwnProperty(client.currency)) {
                    currencyData[client.currency] += 1;
                }
            });
            
            const mostUsed = Object.keys(currencyData).reduce((a, b) => 
                currencyData[a] > currencyData[b] ? a : b
            );
            
            document.getElementById('tryTransactionCount').textContent = currencyData.TL;
            document.getElementById('usdTransactionCount').textContent = currencyData.USD;
            document.getElementById('eurTransactionCount').textContent = currencyData.EUR;
            document.getElementById('mostUsedCurrency').textContent = mostUsed;
        }
        
        // Aktif sekmeye göre ilgili içeriği güncelle
        function updateActiveTab(tabName) {
            console.log("[updateActiveTab] Aktif sekme:", tabName, "Veri:", window.statsData);
            if (!window.statsData) {
                console.warn("Genel istatistik verisi (window.statsData) bulunamadı. Sekme güncellemeleri sınırlı olabilir.");
            }

            const clearAndShowMessage = (chartInstanceOrInstances, canvasIdOrIds, tableContainerId, message) => {
                const chartInstances = Array.isArray(chartInstanceOrInstances) ? chartInstanceOrInstances : [chartInstanceOrInstances];
                const canvasIds = Array.isArray(canvasIdOrIds) ? canvasIdOrIds : [canvasIdOrIds];

                canvasIds.forEach((canvasId, index) => {
                    const canvas = document.getElementById(canvasId);
                    const chartInstance = chartInstances[index];
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        if (chartInstance && typeof chartInstance.destroy === 'function') {
                            chartInstance.destroy();
                             // Global referansları da null yapalım
                            if (canvasId === 'monthlyChart') window.monthlyChart = null;
                            else if (canvasId === 'yearlyChart') window.yearlyChart = null;
                            else if (canvasId === 'statusChart') window.statusChart = null;
                            else if (canvasId === 'expectedPaymentsByYearChart') expectedPaymentsChartInstance = null;
                            else if (canvasId === 'currencyDistributionChart') currencyDistributionChartInstance = null;
                            else if (canvasId === 'currencyStatusChart') currencyStatusChartInstance = null;
                            else if (canvasId === 'collectionTrendChart') collectionTrendChartInstance = null;
                        }
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.textAlign = 'center';
                        ctx.font = '14px Segoe UI'; // Mesaj için font ayarı
                        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
                    }
                });
                
                if (tableContainerId) {
                    const tableContainer = document.getElementById(tableContainerId);
                    if (tableContainer) {
                        tableContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${message}</p>`;
                    }
                }
            };
            
            const resetCards = (cardIdsValues) => { 
                Object.keys(cardIdsValues).forEach(cardId => {
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.textContent = cardIdsValues[cardId];
                    }
                });
            };
            
            switch(tabName) {
                case 'summary':
                    populateSummaryTab(window.statsData);
                    createSummaryChart(window.statsData);
                    createExpectedPaymentsByYearChart(); // ÇAĞRI BURAYA EKLENDİ
                    break;
                case 'payment-type':
                    if (window.statsData && window.statsData.paymentTypeStats) {
                        populatePaymentTypeCards();
                        createPaymentTypeCharts();
                        populatePaymentTypeTable();
                    }
                    break;
                case 'monthly':
                    // Aylık analiz için gerekli verileri doğrudan geçir
                    if (window.statsData) {
                        const yearFilter = document.getElementById('monthlyYearFilter');
                        const currencyFilter = document.getElementById('monthlyCurrencyFilter');
                        
                        // Yıl ve para birimi filtrelerinin değerlerini al
                        const yearVal = yearFilter ? yearFilter.value : undefined;
                        const currencyVal = currencyFilter ? currencyFilter.value : undefined;

                        // Değerlerin tanımsız olmadığından emin ol
                        if (typeof yearVal !== 'undefined' && typeof currencyVal !== 'undefined') {
                            createMonthlyChart(window.statsData.monthlyData, yearVal, currencyVal);
                            populateMonthlyTable(window.statsData.monthlyData, yearVal);
                            updateMonthlyCards(window.statsData.monthlyData, yearVal, currencyVal);
                        } else {
                            console.warn("[updateActiveTab - monthly] Yıl veya para birimi filtresi tanımsız.");
                        }
                    }
                    break;
                case 'yearly':
                    createYearlyChart();
                    populateYearlyTable();
                    updateYearlyCards();
                    break;
                case 'status':
                    createStatusChart();
                    populateStatusTable();
                    break;
                case 'currency':
                    if (globalClientsData && globalClientsData.length > 0) {
                        updateCurrencyCharts();
                    } else {
                        clearAndShowMessage(
                            [window.currencyDistributionChartInstance, window.currencyStatusChartInstance],
                            ['currencyDistributionChart', 'currencyStatusChart'], 
                            'currencyTableContainer', 
                            'Para birimi verisi bulunamadı.'
                        );
                         resetCards({
                            'tryTransactionCount': '0', 'usdTransactionCount': '0', 'eurTransactionCount': '0', 'mostUsedCurrency': '-'
                         });
                    }
                    break;
                case 'predictions':
                    if (globalClientsData && globalClientsData.length > 0) {
                        updatePredictionsData();
                        createCollectionTrendChart();
                    }
                    break;
                case 'entity-type':
                    createEntityTypeChart();
                    break;
                case 'payment-dates':
                    createPaymentDatesChart();
                    break;
            }
        }

        // Para birimi biçimlendirme fonksiyonu
        function formatCurrency(amount) {
            amount = parseFloat(amount);
            if (isNaN(amount)) { 
                amount = 0;
            }
            
            // Sayıyı iki ondalık basamağa yuvarla ve string'e çevir
            let parts = amount.toFixed(2).split('.');
            let wholePart = parts[0];
            let decimalPart = parts[1] || '00'; // Ondalık kısım yoksa '00' ekle
            
            // Binlik ayırıcı olarak nokta ekle
            wholePart = wholePart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            // Ondalık ayırıcı olarak virgül kullan
            return wholePart + ',' + decimalPart;
        }

        // Özet grafiği oluştur
        function createSummaryChart(data) {
            const ctx = document.getElementById('summaryChart').getContext('2d');
            
            if (window.summaryChart && typeof window.summaryChart.destroy === 'function') {
                window.summaryChart.destroy();
            }
            
            if (!data || !data.currencyTotals || !data.currencyTotals.TL) { // Daha detaylı kontrol
                console.error("Özet grafik için istatistik verileri (currencyTotals.TL) bulunamadı", data);
                // Grafik alanını temizle ve mesaj göster
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Özet grafik için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            const { currencyTotals } = data;
            const paidAmount = currencyTotals.TL.paid;
            const unpaidAmount = currencyTotals.TL.unpaid;
            const overdueAmount = data.totalOverdueAmountTL || 0;
            
            window.summaryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ödenen', 'Vadesi Gelmemiş', 'Vadesi Geçmiş'],
                    datasets: [{
                        data: [paidAmount, Math.max(0, unpaidAmount - overdueAmount), overdueAmount], // Negatif değer olmaması için Math.max
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(244, 67, 54, 0.8)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(33, 150, 243, 1)',
                            'rgba(244, 67, 54, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 20
                            }
                        },
                        title: {
                            display: true,
                            text: 'Ödeme Durumu Dağılımı (TL)',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        const value = context.parsed;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0; // total 0 kontrolü
                                        label += `${formatCurrency(value)} TL (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Aylık grafik oluştur
        function createMonthlyChart(filteredClients) {
            // Eğer filteredClients parametresi verilmemişse, kişi/kurum filtrelerini kontrol et
            if (!filteredClients) {
                const personChecked = document.getElementById('monthlyPersonFilter')?.checked ?? true;
                const companyChecked = document.getElementById('monthlyCompanyFilter')?.checked ?? true;
                filteredClients = getFilteredClients(personChecked, companyChecked);
            }

            const selectedYear = document.getElementById('monthlyYearFilter').value;
            const selectedCurrency = document.getElementById('monthlyCurrencyFilter').value;
            const ctx = document.getElementById('monthlyChart').getContext('2d');

            if (window.monthlyChart && typeof window.monthlyChart.destroy === 'function') {
                window.monthlyChart.destroy();
                window.monthlyChart = null;
            }

            if (typeof selectedYear === 'undefined' || selectedYear === '' || typeof selectedCurrency === 'undefined') {
                console.warn("[createMonthlyChart] Yıl veya para birimi tanımsız/eksik. Grafik oluşturulmayacak.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Grafik için lütfen yıl ve para birimi seçin.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                updateMonthlyCards();
                populateMonthlyTable(); // Tabloyu da boşalt/güncelle
                return;
            }

            // Filtrelenmiş client'lardan aylık veriyi yeniden hesapla
            const monthlyDataFiltered = {};

            filteredClients.forEach(client => {
                if (!client.registrationDate) return;

                const regDate = client.registrationDate;
                const year = regDate.getFullYear();
                const month = regDate.getMonth() + 1; // 1-12 arası
                const yearMonth = `${year}-${month.toString().padStart(2, '0')}`;

                if (!monthlyDataFiltered[yearMonth]) {
                    monthlyDataFiltered[yearMonth] = {
                        currencies: {}
                    };
                }

                const currency = client.currency;
                if (!monthlyDataFiltered[yearMonth].currencies[currency]) {
                    monthlyDataFiltered[yearMonth].currencies[currency] = {
                        total: 0,
                        paid: 0,
                        unpaid: 0
                    };
                }

                monthlyDataFiltered[yearMonth].currencies[currency].total += client.amount;
                if (client.isPaid) {
                    monthlyDataFiltered[yearMonth].currencies[currency].paid += client.amount;
                } else {
                    monthlyDataFiltered[yearMonth].currencies[currency].unpaid += client.amount;
                }
            });

            const monthlyDataLocal = monthlyDataFiltered;
            
            console.log("[createMonthlyChart] Seçilen Yıl:", selectedYear, "Seçilen Para Birimi:", selectedCurrency); 
            
            const months = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];
            
            // Veri setlerini doğrudan aylık veriden dolduracağız
            const monthlyPaidData = Array(12).fill(0);
            const monthlyUnpaidData = Array(12).fill(0);
            // Toplam tutar için ayrı bir diziye gerek yok, paid ve unpaid toplanarak bulunabilir
            // Ancak grafik için ayrı tutmak daha iyi olabilir, bu yüzden onu da ekliyorum:
            const monthlyTotalData = Array(12).fill(0); 
            let dataFoundForSelectedParameters = false;
            
            for (const key in monthlyDataLocal) {
                // Anahtarın formatı YYYY-AA olmalı
                const parts = key.split('-');
                if (parts.length !== 2) continue;

                const year = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10);

                if (year == selectedYear && month >= 1 && month <= 12) {
                    const monthEntry = monthlyDataLocal[key];
                    if (!monthEntry || !monthEntry.currencies) continue;
                    dataFoundForSelectedParameters = true; 
                    
                    let currentMonthPaid = 0;
                    let currentMonthUnpaid = 0;
                    let currentMonthTotal = 0;

                    if (selectedCurrency === 'ALL') {
                        Object.keys(monthEntry.currencies).forEach(currency => {
                            const currencyData = monthEntry.currencies[currency];
                            let multiplier = 1;
                            // TODO: Dinamik kur alınabilir veya sabit bir varsayım kullanılabilir. Şimdilik sabit.
                            if (currency === 'USD') multiplier = 30; 
                            if (currency === 'EUR') multiplier = 32; 
                            
                            currentMonthPaid += (currencyData.paid || 0) * multiplier;
                            currentMonthUnpaid += (currencyData.unpaid || 0) * multiplier;
                            currentMonthTotal += (currencyData.total || 0) * multiplier;
                        });
                    } else {
                        const currencyData = monthEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentMonthPaid = currencyData.paid || 0;
                            currentMonthUnpaid = currencyData.unpaid || 0;
                            currentMonthTotal = currencyData.total || 0;
                        }
                    }
                    monthlyPaidData[month-1] = currentMonthPaid;
                    monthlyUnpaidData[month-1] = currentMonthUnpaid;
                    monthlyTotalData[month-1] = currentMonthTotal; 
                }
            }

            if (!dataFoundForSelectedParameters) {
                 console.warn(`[createMonthlyChart] ${selectedYear} yılı için veri bulunamadı.`);
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText(`${selectedYear} yılı için veri bulunamadı.`, ctx.canvas.width / 2, ctx.canvas.height / 2);
                 updateMonthlyCards(); 
                 populateMonthlyTable(); // Tabloyu da boşalt/güncelle
                 return;
            }
            
            console.log("[createMonthlyChart] Grafik için veri dizileri:", 
                        "Toplam:", monthlyTotalData, 
                        "Ödenen:", monthlyPaidData, 
                        "Ödenmemiş:", monthlyUnpaidData);

            const colors = {
                total: { bg: 'rgba(54, 162, 235, 0.5)', border: 'rgba(54, 162, 235, 1)' },
                paid: { bg: 'rgba(75, 192, 192, 0.5)', border: 'rgba(75, 192, 192, 1)' },
                unpaid: { bg: 'rgba(255, 99, 132, 0.5)', border: 'rgba(255, 99, 132, 1)' }
            };
            
            window.monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Toplam Tutar',
                            data: monthlyTotalData, // monthlyAmountData -> monthlyTotalData
                            backgroundColor: colors.total.bg,
                            borderColor: colors.total.border,
                            borderWidth: 1
                        },
                        {
                            label: 'Ödenen',
                            data: monthlyPaidData,
                            backgroundColor: colors.paid.bg,
                            borderColor: colors.paid.border,
                            borderWidth: 1
                        },
                        {
                            label: 'Ödenmemiş',
                            data: monthlyUnpaidData,
                            backgroundColor: colors.unpaid.bg,
                            borderColor: colors.unpaid.border,
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Tutar (${selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency})`,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Ay',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `${selectedYear} Yılı Aylık Ödeme Analizi (${selectedCurrency === 'ALL' ? 'Tüm Para Birimleri (TL Yaklaşık)' : selectedCurrency})`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y) + ' ' + 
                                            (selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            updateMonthlyCards();
            populateMonthlyTable(); // Grafik güncellendikten sonra tabloyu da güncelle
        }

        // Aylık analiz kartlarını güncelle
        function updateMonthlyCards() { 
            const monthlyDataLocal = window.statsData && window.statsData.monthlyData;
            const selectedYear = document.getElementById('monthlyYearFilter').value;
            const selectedCurrency = document.getElementById('monthlyCurrencyFilter').value;
            
            const highestMonthEl = document.getElementById('highestMonth');
            const lowestMonthEl = document.getElementById('lowestMonth');
            const monthlyAverageEl = document.getElementById('monthlyAverage');
            const monthlyTotalCollectionEl = document.getElementById('monthlyTotalCollection'); // Bu "Toplam Tahsilat" (Ödenenler)

            if (!highestMonthEl || !lowestMonthEl || !monthlyAverageEl || !monthlyTotalCollectionEl) {
                console.warn("[updateMonthlyCards] Gerekli kart elementleri bulunamadı.");
                return;
            }

            if (!monthlyDataLocal || typeof selectedYear === 'undefined' || selectedYear === '' || typeof selectedCurrency === 'undefined') {
                console.warn("[updateMonthlyCards] Aylık veri, yıl veya para birimi bulunamadı/seçilmedi.");
                highestMonthEl.textContent = '-';
                lowestMonthEl.textContent = '-';
                monthlyAverageEl.textContent = '0 TL'; // Varsayılan para birimi
                monthlyTotalCollectionEl.textContent = '0 TL'; // Varsayılan para birimi
                return;
            }
            
            console.log("[updateMonthlyCards] Seçilen Yıl:", selectedYear, "Seçilen Para Birimi:", selectedCurrency);

            let highestMonthStats = { month: 0, amount: -Infinity }; 
            let lowestMonthStats = { month: 0, amount: Infinity };
            let totalAmountAllMonthsForAverage = 0; // Ortalama için toplam tutar
            let totalPaidAllMonths = 0; // Toplam tahsilat (ödenen)
            let monthsWithDataCount = 0;
            let dataFoundForYear = false;
            
            for (let m = 1; m <= 12; m++) {
                const yearMonthKey = `${selectedYear}-${String(m).padStart(2, '0')}`;
                const monthEntry = monthlyDataLocal[yearMonthKey];
                
                if (!monthEntry || !monthEntry.currencies) continue;
                dataFoundForYear = true;
                
                let currentMonthTotalAmount = 0; // İlgili ayın toplam tutarı (ödenen + ödenmeyen)
                let currentMonthPaidAmount = 0;  // İlgili ayın ödenen tutarı
                
                if (selectedCurrency === 'ALL') {
                    Object.keys(monthEntry.currencies).forEach(currency => {
                        const currencyData = monthEntry.currencies[currency];
                        let multiplier = 1;
                        if (currency === 'USD') multiplier = 30; 
                        if (currency === 'EUR') multiplier = 32; 
                        
                        currentMonthTotalAmount += (currencyData.total || 0) * multiplier;
                        currentMonthPaidAmount += (currencyData.paid || 0) * multiplier;
                    });
                } else {
                    if (monthEntry.currencies[selectedCurrency]) {
                        currentMonthTotalAmount = monthEntry.currencies[selectedCurrency].total || 0;
                        currentMonthPaidAmount = monthEntry.currencies[selectedCurrency].paid || 0;
                    }
                }
                
                // Ay için veri varsa say ve toplamları güncelle
                monthsWithDataCount++; // Veri olan ay sayısını artır
                totalAmountAllMonthsForAverage += currentMonthTotalAmount;
                totalPaidAllMonths += currentMonthPaidAmount;
                
                // En yüksek ve en düşük ay (toplam tutara göre)
                if (currentMonthTotalAmount > highestMonthStats.amount) {
                    highestMonthStats = { month: m, amount: currentMonthTotalAmount };
                }
                if (currentMonthTotalAmount < lowestMonthStats.amount) {
                    lowestMonthStats = { month: m, amount: currentMonthTotalAmount };
                }
            }
            
            const monthsNames = [
                'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
                'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
            ];
            
            const monthlyAverageCalculated = monthsWithDataCount > 0 ? totalAmountAllMonthsForAverage / monthsWithDataCount : 0;
            const displayCurrency = selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency;

            if (!dataFoundForYear) {
                highestMonthEl.textContent = '-';
                lowestMonthEl.textContent = '-';
                monthlyAverageEl.textContent = `0 ${displayCurrency}`;
                monthlyTotalCollectionEl.textContent = `0 ${displayCurrency}`;
                return;
            }

            highestMonthEl.textContent = 
                highestMonthStats.amount > -Infinity && highestMonthStats.month > 0 ? 
                `${monthsNames[highestMonthStats.month-1]} - ${formatCurrency(highestMonthStats.amount)} ${displayCurrency}` : 
                '-';
                
            lowestMonthEl.textContent = 
                lowestMonthStats.amount < Infinity && lowestMonthStats.month > 0 ?
                `${monthsNames[lowestMonthStats.month-1]} - ${formatCurrency(lowestMonthStats.amount)} ${displayCurrency}` : 
                '-';
                
            monthlyAverageEl.textContent = 
                `${formatCurrency(monthlyAverageCalculated)} ${displayCurrency}`;
                
            monthlyTotalCollectionEl.textContent = // Toplam Tahsilat (Ödenenler)
                `${formatCurrency(totalPaidAllMonths)} ${displayCurrency}`;
        }

        // Aylık Analiz Tablosunu Doldur
        function populateMonthlyTable() { 
            const monthlyDataLocal = window.statsData && window.statsData.monthlyData;
            const year = document.getElementById('monthlyYearFilter').value; // Yıl filtresinden al
            const tableContainer = document.getElementById('monthlyTableContainer'); // ID düzeltildi

            if (!tableContainer) {
                console.error("[populateMonthlyTable] Tablo konteyneri 'monthlyTableContainer' bulunamadı.");
                return;
            }
            tableContainer.innerHTML = ''; // Önceki tabloyu temizle

            if (!monthlyDataLocal || typeof year === 'undefined' || year === '') {
                console.warn("[populateMonthlyTable] Aylık veri veya seçili yıl bulunamadı.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Lütfen bir yıl seçin veya veri mevcut değil.</p>';
                return;
            }
            
            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            console.log("[populateMonthlyTable] Seçilen Yıl:", year); 

            ['Ay', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            let dataFoundForTable = false;
            for (let i = 0; i < 12; i++) {
                const monthKey = `${year}-${String(i + 1).padStart(2, '0')}`;
                const monthEntry = monthlyDataLocal[monthKey];
                // console.log(`[populateMonthlyTable] Ay: ${months[i]}, Veri Anahtarı: ${monthKey}, Veri:`, monthEntry ? JSON.stringify(monthEntry.currencies) : "Veri Yok"); 

                const row = tbody.insertRow();
                row.insertCell().textContent = months[i];

                // Her para birimi için varsayılan boş değerler
                let tlTotal = 0, tlPaid = 0, tlUnpaid = 0;
                let usdTotal = 0, usdPaid = 0, usdUnpaid = 0;
                let eurTotal = 0, eurPaid = 0, eurUnpaid = 0;

                if (monthEntry && monthEntry.currencies) {
                    dataFoundForTable = true; // En az bir ay için veri var
                    const currencies = monthEntry.currencies;
                    if (currencies.TL) {
                        tlTotal = currencies.TL.total || 0;
                        tlPaid = currencies.TL.paid || 0;
                        tlUnpaid = currencies.TL.unpaid || 0;
                    }
                    if (currencies.USD) {
                        usdTotal = currencies.USD.total || 0;
                        usdPaid = currencies.USD.paid || 0;
                        usdUnpaid = currencies.USD.unpaid || 0;
                    }
                    if (currencies.EUR) {
                        eurTotal = currencies.EUR.total || 0;
                        eurPaid = currencies.EUR.paid || 0;
                        eurUnpaid = currencies.EUR.unpaid || 0;
                    }
                }
                
                row.insertCell().textContent = formatCurrency(tlTotal);
                row.insertCell().textContent = formatCurrency(tlPaid);
                row.insertCell().textContent = formatCurrency(tlUnpaid);
                row.insertCell().textContent = formatCurrency(usdTotal);
                row.insertCell().textContent = formatCurrency(usdPaid);
                row.insertCell().textContent = formatCurrency(usdUnpaid);
                row.insertCell().textContent = formatCurrency(eurTotal);
                row.insertCell().textContent = formatCurrency(eurPaid);
                row.insertCell().textContent = formatCurrency(eurUnpaid);
            }
            
            if (!dataFoundForTable) {
                 tableContainer.innerHTML = `<p style="text-align:center; padding: 20px;">${year} yılı için gösterilecek aylık detay bulunmamaktadır.</p>`;
            } else {
                tableContainer.appendChild(table);
            }
        }

        // Yıllık grafik oluştur
        function createYearlyChart(filteredClients) {
            // Eğer filteredClients parametresi verilmemişse, kişi/kurum filtrelerini kontrol et
            if (!filteredClients) {
                const personChecked = document.getElementById('yearlyPersonFilter')?.checked ?? true;
                const companyChecked = document.getElementById('yearlyCompanyFilter')?.checked ?? true;
                filteredClients = getFilteredClients(personChecked, companyChecked);
            }

            const ctx = document.getElementById('yearlyChart').getContext('2d');
            const currencyFilterElement = document.getElementById('yearlyCurrencyFilter');
            const chartTypeElement = document.getElementById('yearlyChartType');

            if (window.yearlyChart && typeof window.yearlyChart.destroy === 'function') {
                window.yearlyChart.destroy();
                window.yearlyChart = null;
            }

            const selectedCurrency = currencyFilterElement ? currencyFilterElement.value : 'TL'; // Varsayılan TL
            const chartType = chartTypeElement ? chartTypeElement.value : 'bar'; // Varsayılan bar

            // Filtrelenmiş client'lardan yıllık veriyi yeniden hesapla
            const yearlyDataFiltered = {};
            const yearsSet = new Set();

            filteredClients.forEach(client => {
                if (!client.registrationDate) return;

                const year = client.registrationDate.getFullYear();
                yearsSet.add(year);

                if (!yearlyDataFiltered[year]) {
                    yearlyDataFiltered[year] = {
                        currencies: {}
                    };
                }

                const currency = client.currency;
                if (!yearlyDataFiltered[year].currencies[currency]) {
                    yearlyDataFiltered[year].currencies[currency] = {
                        total: 0,
                        paid: 0,
                        unpaid: 0
                    };
                }

                yearlyDataFiltered[year].currencies[currency].total += client.amount;
                if (client.isPaid) {
                    yearlyDataFiltered[year].currencies[currency].paid += client.amount;
                } else {
                    yearlyDataFiltered[year].currencies[currency].unpaid += client.amount;
                }
            });

            // Yılları küçükten büyüğe sırala
            const years = Array.from(yearsSet).sort((a,b) => a-b);

            if (years.length === 0) {
                console.warn("Yıllık grafik için filtrelenmiş veri bulunamadı.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Filtrelenmiş veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                updateYearlyCards();
                populateYearlyTable();
                return;
            }

            const yearlyTotalData = []; // Toplam tutar (ödenen + ödenmemiş)
            const yearlyPaidData = [];  // Ödenen tutar
            const yearlyUnpaidData = []; // Ödenmemiş (beklenen) tutar

            years.forEach(year => {
                const yearEntry = yearlyDataFiltered[year]; // Filtrelenmiş veriden al

                let currentYearTotal = 0;
                let currentYearPaid = 0;
                let currentYearUnpaid = 0;

                if (yearEntry && yearEntry.currencies) {
                    if (selectedCurrency === 'ALL') {
                        Object.keys(yearEntry.currencies).forEach(currency => {
                            const currencyData = yearEntry.currencies[currency];
                            let multiplier = 1;
                            if (currency === 'USD') multiplier = parseFloat(exchangeRates.USD) || 30;
                            if (currency === 'EUR') multiplier = parseFloat(exchangeRates.EUR) || 32;

                            currentYearTotal += (currencyData.total || 0) * multiplier;
                            currentYearPaid += (currencyData.paid || 0) * multiplier;
                            currentYearUnpaid += (currencyData.unpaid || 0) * multiplier;
                        });
                    } else {
                        const currencyData = yearEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentYearTotal = currencyData.total || 0;
                            currentYearPaid = currencyData.paid || 0;
                            currentYearUnpaid = currencyData.unpaid || 0;
                        }
                    }
                }
                yearlyTotalData.push(currentYearTotal);
                yearlyPaidData.push(currentYearPaid);
                yearlyUnpaidData.push(currentYearUnpaid);
            });
            
            const colors = {
                total: { bg: 'rgba(33, 150, 243, 0.5)', border: 'rgba(33, 150, 243, 1)' },
                paid: { bg: 'rgba(76, 175, 80, 0.5)', border: 'rgba(76, 175, 80, 1)' },
                unpaid: { bg: 'rgba(239, 83, 80, 0.5)', border: 'rgba(239, 83, 80, 1)' }
            };
            
            let chartConfig = {
                type: chartType === 'area' ? 'line' : chartType,
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Toplam Tutar',
                            data: yearlyTotalData, // yearlyAmountData -> yearlyTotalData
                            backgroundColor: colors.total.bg,
                            borderColor: colors.total.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        },
                        {
                            label: 'Ödenen',
                            data: yearlyPaidData,
                            backgroundColor: colors.paid.bg,
                            borderColor: colors.paid.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        },
                        {
                            label: 'Ödenmemiş',
                            data: yearlyUnpaidData,
                            backgroundColor: colors.unpaid.bg,
                            borderColor: colors.unpaid.border,
                            borderWidth: 1,
                            fill: chartType === 'area'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Tutar (${selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency})`,
                                font: {
                                    weight: 'bold'
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Yıl',
                                font: {
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Yıllık Ödeme Analizi (${selectedCurrency === 'ALL' ? 'Tüm Para Birimleri (TL Yaklaşık)' : selectedCurrency})`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y) + ' ' + 
                                            (selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            };
            
            window.yearlyChart = new Chart(ctx, chartConfig);
            updateYearlyCards(); 
            populateYearlyTable(); 
        }

        // Yıllık analiz kartlarını güncelle
        function updateYearlyCards() {
            const highestYearEl = document.getElementById('highestYear');
            const yearlyAverageEl = document.getElementById('yearlyAverage');
            const yearlyGrowthEl = document.getElementById('yearlyGrowth');
            const nextYearForecastEl = document.getElementById('nextYearForecast'); // Bu "Gelecek Yıl Tahmin" (Ödenmemişler)
            const trendIconEl = document.querySelector('#yearlyGrowth + .trend-indicator i');

            // Kritik DOM elementlerinin varlığını kontrol et
            if (!highestYearEl || !yearlyAverageEl || !yearlyGrowthEl || !nextYearForecastEl || !trendIconEl) {
                console.error("[updateYearlyCards] Kritik kart veya trend ikonu elementleri DOM'da bulunamadı. Kart güncellemesi iptal ediliyor.");
                return; 
            }
            
            // Kartları varsayılan boş/sıfır durumuna ayarla
            highestYearEl.textContent = '-';
            yearlyAverageEl.textContent = '0 TL';
            yearlyGrowthEl.textContent = '0%';
            nextYearForecastEl.textContent = '0 TL';
            trendIconEl.className = 'material-icons trend-neutral';
            trendIconEl.textContent = 'trending_flat';

            // window.statsData varlığını ve gerekli alt özellikleri kontrol et
            if (!window.statsData) {
                console.warn("[updateYearlyCards] window.statsData mevcut değil. Kartlar varsayılan boş durumda kalacak.");
                return;
            }
            if (!window.statsData.yearlyData || typeof window.statsData.yearlyData !== 'object') {
                console.warn("[updateYearlyCards] window.statsData.yearlyData mevcut değil veya bir nesne değil. Kartlar varsayılan boş durumda kalacak.", window.statsData.yearlyData);
                return;
            }
            // window.statsData.years boş bir dizi olabilir, bu bir hata değil, veri olmadığı anlamına gelir.
            if (!window.statsData.years || !Array.isArray(window.statsData.years)) {
                console.warn("[updateYearlyCards] window.statsData.years mevcut değil veya bir dizi değil. Kartlar varsayılan boş durumda kalacak.", window.statsData.years);
                return;
            }
            // Eğer yıllar dizisi boşsa, veri yoktur, bu yüzden varsayılan değerler kalır.
             if (window.statsData.years.length === 0) {
                console.log("[updateYearlyCards] window.statsData.years dizisi boş. Yıllık veri yok, kartlar varsayılan durumda kalacak.");
                return;
            }

            console.log("[updateYearlyCards] Kart güncellemeleri için devam ediliyor. yearlyData:", JSON.parse(JSON.stringify(window.statsData.yearlyData)), "years:", window.statsData.years);

            const { yearlyData, years } = window.statsData;
            const selectedCurrency = document.getElementById('yearlyCurrencyFilter').value;
            const displayCurrency = selectedCurrency === 'ALL' ? 'TL (Yaklaşık)' : selectedCurrency;

            let highestYearAmount = -Infinity; 
            let highestYearVal = '-';
            let totalAmountForAllYearsForAverage = 0; 
            let totalPaidLastYear = 0; 
            let totalPaidPreviousYear = 0; 
            let totalUnpaidNextYearForecast = 0; 
            let yearCountForAverage = 0;

            const sortedYears = [...years].sort((a, b) => a - b); 

            sortedYears.forEach((year, index) => {
                const yearEntry = yearlyData[year.toString()];
                if (yearEntry && yearEntry.currencies) {
                    yearCountForAverage++;
                    let currentYearTotalAmount = 0; 
                    let currentYearPaidAmount = 0;  
                    let currentYearUnpaidAmount = 0; 

                    if (selectedCurrency === 'ALL') {
                        Object.keys(yearEntry.currencies).forEach(c => {
                            const currencyData = yearEntry.currencies[c];
                            let multiplier = 1;
                            if (c === 'USD') multiplier = 30;
                            if (c === 'EUR') multiplier = 32;
                            currentYearTotalAmount += (currencyData.total || 0) * multiplier;
                            currentYearPaidAmount += (currencyData.paid || 0) * multiplier;
                            currentYearUnpaidAmount += (currencyData.unpaid || 0) * multiplier;
                        });
                    } else {
                        const currencyData = yearEntry.currencies[selectedCurrency];
                        if (currencyData) {
                            currentYearTotalAmount = currencyData.total || 0;
                            currentYearPaidAmount = currencyData.paid || 0;
                            currentYearUnpaidAmount = currencyData.unpaid || 0;
                        }
                    }
                    
                    totalAmountForAllYearsForAverage += currentYearTotalAmount;

                    if (currentYearTotalAmount > highestYearAmount) {
                        highestYearAmount = currentYearTotalAmount;
                        highestYearVal = year.toString();
                    }

                    if (index === sortedYears.length - 1) { 
                        totalPaidLastYear = currentYearPaidAmount;
                        totalUnpaidNextYearForecast = currentYearUnpaidAmount; 
                    }
                    if (index === sortedYears.length - 2) { 
                        totalPaidPreviousYear = currentYearPaidAmount;
                    }
                }
            });

            const yearlyAverageCalculated = yearCountForAverage > 0 ? totalAmountForAllYearsForAverage / yearCountForAverage : 0;
            highestYearEl.textContent = highestYearVal !== '-' ? `${highestYearVal} - ${formatCurrency(highestYearAmount)} ${displayCurrency}` : '-';
            yearlyAverageEl.textContent = `${formatCurrency(yearlyAverageCalculated)} ${displayCurrency}`;
            nextYearForecastEl.textContent = `${formatCurrency(totalUnpaidNextYearForecast)} ${displayCurrency}`;

            let yearlyGrowthPercentage = 0;
            if (totalPaidPreviousYear > 0) {
                yearlyGrowthPercentage = ((totalPaidLastYear - totalPaidPreviousYear) / totalPaidPreviousYear) * 100;
            } else if (totalPaidLastYear > 0) { 
                yearlyGrowthPercentage = 100;
            } else if (totalPaidLastYear === 0 && totalPaidPreviousYear === 0) { 
                 yearlyGrowthPercentage = 0;
            }

            yearlyGrowthEl.textContent = `${yearlyGrowthPercentage.toFixed(1)}%`;
            
            if (yearlyGrowthPercentage > 0.1) { 
                trendIconEl.className = 'material-icons trend-positive';
                trendIconEl.textContent = 'trending_up';
            } else if (yearlyGrowthPercentage < -0.1) {
                trendIconEl.className = 'material-icons trend-negative';
                trendIconEl.textContent = 'trending_down';
            } else {
                trendIconEl.className = 'material-icons trend-neutral';
                trendIconEl.textContent = 'trending_flat';
            }
            console.log("[updateYearlyCards] Kartlar güncellendi.");
        }

        // Yıllık Analiz Tablosunu Doldur
        function populateYearlyTable() {
            const tableContainer = document.getElementById('yearlyTableContainer'); 
            if (!tableContainer) {
                 console.error("[populateYearlyTable] Tablo konteyneri 'yearlyTableContainer' bulunamadı.");
                 return;
            }
            tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık detay tablosu yükleniyor...</p>'; 

            if (!window.statsData) {
                 console.warn("[populateYearlyTable] window.statsData mevcut değil. Tablo doldurulmayacak.");
                 tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Genel istatistik verisi bulunamadı.</p>';
                 return;
            }
            if (!window.statsData.yearlyData || typeof window.statsData.yearlyData !== 'object') {
                console.warn("[populateYearlyTable] window.statsData.yearlyData mevcut değil veya bir nesne değil. Tabloda veri gösterilmeyecek.", window.statsData.yearlyData);
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık veri bulunamadı (yearlyData eksik veya hatalı).</p>';
                return;
            }
            if (!window.statsData.years || !Array.isArray(window.statsData.years)) { 
                console.warn("[populateYearlyTable] window.statsData.years mevcut değil veya bir dizi değil. Tablo boş olabilir veya veri gösterilmeyebilir.", window.statsData.years);
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Yıllık veri bulunamadı (years listesi eksik veya hatalı).</p>';
                return;
            }

            console.log("[populateYearlyTable] Dolduruluyor. yearlyData:", JSON.parse(JSON.stringify(window.statsData.yearlyData)), "years:", window.statsData.years);

            const { yearlyData, years } = window.statsData;
            
            if (years.length === 0) {
                console.log("[populateYearlyTable] 'years' dizisi boş. Gösterilecek yıllık detay yok.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek yıllık detay bulunmamaktadır.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Yıl', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const sortedYears = [...years].sort((a,b) => b-a); 
            let dataFoundForTable = false;

            sortedYears.forEach(year => {
                const yearKey = year.toString();
                const yearEntry = yearlyData[yearKey];
                const row = tbody.insertRow();
                row.insertCell().textContent = year;

                let tlTotal = 0, tlPaid = 0, tlUnpaid = 0;
                let usdTotal = 0, usdPaid = 0, usdUnpaid = 0;
                let eurTotal = 0, eurPaid = 0, eurUnpaid = 0;

                if (yearEntry && yearEntry.currencies) {
                    dataFoundForTable = true; // Bu yıl için veri bulundu olarak işaretle
                    const currencies = yearEntry.currencies;
                    if (currencies.TL) {
                        tlTotal = currencies.TL.total || 0;
                        tlPaid = currencies.TL.paid || 0;
                        tlUnpaid = currencies.TL.unpaid || 0;
                    }
                    if (currencies.USD) {
                        usdTotal = currencies.USD.total || 0;
                        usdPaid = currencies.USD.paid || 0;
                        usdUnpaid = currencies.USD.unpaid || 0;
                    }
                    if (currencies.EUR) {
                        eurTotal = currencies.EUR.total || 0;
                        eurPaid = currencies.EUR.paid || 0;
                        eurUnpaid = currencies.EUR.unpaid || 0;
                    }
                }
                
                row.insertCell().textContent = formatCurrency(tlTotal);
                row.insertCell().textContent = formatCurrency(tlPaid);
                row.insertCell().textContent = formatCurrency(tlUnpaid);
                row.insertCell().textContent = formatCurrency(usdTotal);
                row.insertCell().textContent = formatCurrency(usdPaid);
                row.insertCell().textContent = formatCurrency(usdUnpaid);
                row.insertCell().textContent = formatCurrency(eurTotal);
                row.insertCell().textContent = formatCurrency(eurPaid);
                row.insertCell().textContent = formatCurrency(eurUnpaid);
            });
            
            if (!dataFoundForTable) { // Eğer döngü boyunca hiçbir yıl için veri bulunamadıysa
                 console.log("[populateYearlyTable] Sıralı yıl listesindeki hiçbir yıl için veri bulunamadı.");
                 tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek yıllık detay bulunmamaktadır.</p>';
            } else {
                tableContainer.appendChild(table);
                console.log("[populateYearlyTable] Tablo başarıyla dolduruldu.");
            }
        }

        // Durum analizi grafiği oluştur
        function createStatusChart(clients) {
            // Eğer clients parametresi verilmediyse, kişi/kurum filtrelerini kontrol et
            if (!clients) {
                const personChecked = document.getElementById('statusPersonFilter')?.checked ?? true;
                const companyChecked = document.getElementById('statusCompanyFilter')?.checked ?? true;
                clients = getFilteredClients(personChecked, companyChecked);
            }

            const ctx = document.getElementById('statusChart').getContext('2d');

            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }

            if (!clients || clients.length === 0) {
                console.warn("Durum analizi için veri bulunamadı");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Durum analizi için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            // Filtrelenmiş client'lardan ödeme durumu sayılarını hesapla
            let paidCount = 0;
            let unpaidCount = 0;
            let overdueCount = 0;
            const currentDate = new Date();

            clients.forEach(client => {
                if (client.isPaid) {
                    paidCount++;
                } else {
                    unpaidCount++;
                    // Vadesi geçmiş mi kontrol et
                    if (client.dueDate && client.dueDate < currentDate) {
                        overdueCount++;
                    }
                }
            });

            // Yüzde hesapla
            const totalCount = paidCount + unpaidCount;
            const paidPercentage = totalCount > 0 ? ((paidCount / totalCount) * 100).toFixed(1) : 0;
            const unpaidPercentage = totalCount > 0 ? ((unpaidCount / totalCount) * 100).toFixed(1) : 0;
            const overduePercentage = unpaidCount > 0 ? ((overdueCount / unpaidCount) * 100).toFixed(1) : 0;

            // Kartları güncelle
            const paidTransCountElement = document.getElementById('paidTransCount');
            if (paidTransCountElement) paidTransCountElement.textContent = paidCount;

            const unpaidTransCountElement = document.getElementById('unpaidTransCount');
            if (unpaidTransCountElement) unpaidTransCountElement.textContent = unpaidCount;

            const overdueTransCountElement = document.getElementById('overdueTransCount');
            if (overdueTransCountElement) overdueTransCountElement.textContent = overdueCount;

            const paidTransPercentageElement = document.getElementById('paidTransPercentage');
            if (paidTransPercentageElement) paidTransPercentageElement.textContent = `${Math.round(paidPercentage)}%`;

            const unpaidTransPercentageElement = document.getElementById('unpaidTransPercentage');
            if (unpaidTransPercentageElement) unpaidTransPercentageElement.textContent = `${Math.round(unpaidPercentage)}%`;

            const overdueTransPercentageElement = document.getElementById('overdueTransPercentage');
            if (overdueTransPercentageElement) overdueTransPercentageElement.textContent = `${Math.round(overduePercentage)}%`;

            if (paidCount === 0 && unpaidCount === 0) {
                 ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                 ctx.textAlign = 'center';
                 ctx.fillText('Ödeme durumu için işlem bulunmuyor.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                 return;
            }

            window.statusChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Ödendi', 'Ödenmedi'],
                    datasets: [{
                        data: [paidCount, unpaidCount],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.7)',
                            'rgba(239, 83, 80, 0.7)'
                        ],
                        borderColor: [
                            'rgba(76, 175, 80, 1)',
                            'rgba(239, 83, 80, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Ödeme Durumuna Göre İşlem Sayısı' 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                    const value = context.parsed || 0;
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `${value} işlem (${percentage}%)`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Özet sekmesini detaylı verilerle doldur
        function populateSummaryTab(data) {
            if (!data) return;

            const { currencyTotals, highestPayment, overdueCount, expectedPaymentsByYear, totalInstallments, paidInstallments, clients, paidCount, unpaidCount, entityStats } = data;

            // Ana kartlar
            document.getElementById('totalAmount').textContent = `${formatCurrency(currencyTotals.TL.total)} TL`;
            document.getElementById('totalPaid').textContent = `${formatCurrency(currencyTotals.TL.paid)} TL`;
            document.getElementById('totalUnpaid').textContent = `${formatCurrency(currencyTotals.TL.unpaid)} TL`;
            document.getElementById('clientCount').textContent = clients || 0;

            // Yüzdelik hesaplamalar
            const totalAmount = currencyTotals.TL.total;
            const paidPercentage = totalAmount > 0 ? ((currencyTotals.TL.paid / totalAmount) * 100).toFixed(1) : 0;
            const unpaidPercentage = totalAmount > 0 ? ((currencyTotals.TL.unpaid / totalAmount) * 100).toFixed(1) : 0;

            document.getElementById('paidPercentageText').textContent = `%${paidPercentage} tahsil edildi`;
            document.getElementById('unpaidPercentageText').textContent = `%${unpaidPercentage} beklemede`;

            // Ödeme Durum Dağılımı Kartları
            const overduePercentage = unpaidCount > 0 ? ((overdueCount / unpaidCount) * 100).toFixed(1) : 0;

            const paidPercentageElement = document.getElementById('paidPercentage');
            if (paidPercentageElement) paidPercentageElement.textContent = `${Math.round(paidPercentage || 0)}%`;

            const unpaidPercentageElement = document.getElementById('unpaidPercentage');
            if (unpaidPercentageElement) unpaidPercentageElement.textContent = `${Math.round(unpaidPercentage || 0)}%`;

            const overduePercentageElement = document.getElementById('overduePercentage');
            if (overduePercentageElement) overduePercentageElement.textContent = `${Math.round(overduePercentage || 0)}%`;

            const paidClientsElement = document.getElementById('paidClients');
            if (paidClientsElement) paidClientsElement.textContent = `${paidCount || 0} Müvekkil`;

            const unpaidClientsElement = document.getElementById('unpaidClients');
            if (unpaidClientsElement) unpaidClientsElement.textContent = `${unpaidCount || 0} Müvekkil`;

            const overdueAmountElement = document.getElementById('overdueAmount');
            if (overdueAmountElement) overdueAmountElement.textContent = `${formatCurrency(data.totalOverdueAmountTL || 0)} TL`;

            // Detay kartları
            document.getElementById('expectedNextYear').textContent = `${formatCurrency(currencyTotals.TL.expectedNextYear)} TL`;
            document.getElementById('highestPaymentInfo').textContent = `${formatCurrency(highestPayment.amount)} ${highestPayment.currency}`;
            document.getElementById('overdueCount').textContent = `${overdueCount} Ödeme`;

            const avgInstallments = clients > 0 ? (totalInstallments / clients).toFixed(1) : 0;
            const avgPaidInstallments = paidCount > 0 ? (paidInstallments / paidCount).toFixed(1) : 0;
            document.getElementById('avgInstallmentInfo').textContent = `${avgInstallments} / ${avgPaidInstallments}`;

            // USD ve EUR bakiyeleri (TL karşılığı ile)
            const usdTotal = currencyTotals.USD.total;
            const eurTotal = currencyTotals.EUR.total;
            const usdInTL = usdTotal * parseFloat(exchangeRates.USD);
            const eurInTL = eurTotal * parseFloat(exchangeRates.EUR);

            document.getElementById('totalAmountUSD').textContent = `${formatCurrency(usdTotal)} USD`;
            document.getElementById('totalAmountUSDinTL').textContent = `≈ ${formatCurrency(usdInTL)} TL (${exchangeRates.USD} ₺/USD)`;

            document.getElementById('totalAmountEUR').textContent = `${formatCurrency(eurTotal)} EUR`;
            document.getElementById('totalAmountEURinTL').textContent = `≈ ${formatCurrency(eurInTL)} TL (${exchangeRates.EUR} ₺/EUR)`;

            // Döviz kuru notunu güncelle
            let updateDateText = 'Tarih bilinmiyor';
            if (exchangeRates.lastUpdate) {
                // API'den gelen tarih formatını Türkçe'ye çevir
                const apiDate = new Date(exchangeRates.lastUpdate);
                if (!isNaN(apiDate.getTime())) {
                    updateDateText = apiDate.toLocaleDateString('tr-TR', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric'
                    });
                } else {
                    updateDateText = exchangeRates.lastUpdate;
                }
            }

            // API kaynağına göre açıklama
            let apiSourceText = '';
            switch(exchangeRates.apiSource) {
                case 'TCMB':
                    apiSourceText = 'T.C. Merkez Bankası - Resmi Kurlar';
                    break;
                case 'GenelPara':
                    apiSourceText = 'GenelPara - Gerçek Zamanlı Piyasa';
                    break;
                case 'Vakıfbank':
                    apiSourceText = 'Vakıfbank - Banka Kurları';
                    break;
                case 'CollectAPI':
                    apiSourceText = 'CollectAPI - TCMB Verisi';
                    break;
                default:
                    apiSourceText = 'Google Referans Kurları';
            }

            document.getElementById('exchangeRateInfo').innerHTML = `
                Güncel kurlar (<strong>${updateDateText}</strong>):
                <strong>1 USD = ${exchangeRates.USD} ₺</strong> |
                <strong>1 EUR = ${exchangeRates.EUR} ₺</strong>
                <span style="font-size: 0.85rem; color: #6c757d; margin-left: 8px;">(${apiSourceText})</span>
            `;

            // Kişi/Kurum istatistiklerini güncelle
            const personPaidPercentage = entityStats.person.total > 0 
                ? ((entityStats.person.paid / entityStats.person.total) * 100).toFixed(1) 
                : 0;
            const companyPaidPercentage = entityStats.company.total > 0 
                ? ((entityStats.company.paid / entityStats.company.total) * 100).toFixed(1) 
                : 0;

            document.getElementById('personTotalAmount').textContent = entityStats.person.total.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('personCountText').textContent = `${entityStats.person.count} kişi`;
            document.getElementById('companyTotalAmount').textContent = entityStats.company.total.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('companyCountText').textContent = `${entityStats.company.count} kurum`;
            document.getElementById('personPaidAmount').textContent = entityStats.person.paid.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('personPaidPercentageText').textContent = `%${personPaidPercentage}`;
            document.getElementById('companyPaidAmount').textContent = entityStats.company.paid.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('companyPaidPercentageText').textContent = `%${companyPaidPercentage}`;

            // Ödeme tarihi istatistiklerini güncelle
            const avgDuration = paymentDateStats.durationCount > 0 
                ? Math.round(paymentDateStats.totalDuration / paymentDateStats.durationCount) 
                : 0;
            
            document.getElementById('thisMonthPayments').textContent = paymentDateStats.thisMonth.total.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('thisMonthCountText').textContent = `${paymentDateStats.thisMonth.count} ödeme`;
            document.getElementById('thisYearPayments').textContent = paymentDateStats.thisYear.total.toLocaleString('tr-TR', {
                style: 'currency',
                currency: 'TRY'
            });
            document.getElementById('thisYearCountText').textContent = `${paymentDateStats.thisYear.count} ödeme`;
            document.getElementById('avgPaymentDuration').textContent = `${avgDuration} gün`;
            document.getElementById('fastestPayment').textContent = paymentDateStats.fastestDuration !== null 
                ? `${paymentDateStats.fastestDuration} gün` 
                : '0 gün';
            document.getElementById('fastestPaymentClient').textContent = paymentDateStats.fastestClient;

            // Yıllara Göre Beklenen Ödemeler Grafiği - canvas elemanını koruyoruz
            // Graf createExpectedPaymentsByYearChart() fonksiyonu tarafından oluşturulacak

            // Detay kartlarını güncelle (window.statsData'dan al)
            if (window.statsData) {
                const {
                    avgDueTime,
                    totalOverdueDays,
                    mostOverdue,
                    avgInstallments,
                    avgPaidInstallments,
                    mostUsedCurrency,
                    avgPerClient,
                    highestClient,
                    lowestClient,
                    clientVariation,
                    paidPercentage,
                    unpaidPercentage,
                    overduePercentage,
                    totalOverdueAmountTL,
                    predictions
                } = window.statsData;

                // Vade Durumu Analizi
                const avgDueElement = document.getElementById('avgDueTime');
                if (avgDueElement) avgDueElement.textContent = `${Math.round(avgDueTime || 0)} Gün`;

                const totalOverdueDaysElement = document.getElementById('totalOverdueDays');
                if (totalOverdueDaysElement) totalOverdueDaysElement.textContent = `${totalOverdueDays || 0} Gün`;

                const mostOverdueElement = document.getElementById('mostOverdueInfo');
                if (mostOverdueElement && mostOverdue && mostOverdue.days > 0) {
                    mostOverdueElement.textContent = `${mostOverdue.clientName} - ${mostOverdue.days} gün`;
                } else if (mostOverdueElement) {
                    mostOverdueElement.textContent = '- (Veri Yok)';
                }

                // Para Birimi Karşılaştırması
                const tryCountElement = document.getElementById('tryTransactionCount');
                if (tryCountElement) tryCountElement.textContent = currencyTotals.TL.transactions || 0;

                const usdCountElement = document.getElementById('usdTransactionCount');
                if (usdCountElement) usdCountElement.textContent = currencyTotals.USD.transactions || 0;

                const eurCountElement = document.getElementById('eurTransactionCount');
                if (eurCountElement) eurCountElement.textContent = currencyTotals.EUR.transactions || 0;

                const mostUsedElement = document.getElementById('mostUsedCurrency');
                if (mostUsedElement) mostUsedElement.textContent = mostUsedCurrency || '-';

                // Müvekkil Başına Ödeme
                const avgPerClientElement = document.getElementById('avgPerClient');
                if (avgPerClientElement) avgPerClientElement.textContent = `${formatCurrency(avgPerClient || 0)} TL`;

                const highestClientValueElement = document.getElementById('highestClientValue');
                if (highestClientValueElement && highestClient && highestClient.id) {
                    highestClientValueElement.textContent = `${formatCurrency(highestClient.amount)} ${highestClient.currency}`;
                } else if (highestClientValueElement) {
                    highestClientValueElement.textContent = '0 TL';
                }

                const highestClientNameElement = document.getElementById('highestClientName');
                if (highestClientNameElement && highestClient && highestClient.id) {
                    highestClientNameElement.textContent = highestClient.name;
                } else if (highestClientNameElement) {
                    highestClientNameElement.textContent = '-';
                }

                const lowestClientValueElement = document.getElementById('lowestClientValue');
                if (lowestClientValueElement && lowestClient && lowestClient.id && lowestClient.amount < Infinity) {
                    lowestClientValueElement.textContent = `${formatCurrency(lowestClient.amount)} ${lowestClient.currency}`;
                } else if (lowestClientValueElement) {
                    lowestClientValueElement.textContent = '0 TL';
                }

                const lowestClientNameElement = document.getElementById('lowestClientName');
                if (lowestClientNameElement && lowestClient && lowestClient.id && lowestClient.amount < Infinity) {
                    lowestClientNameElement.textContent = lowestClient.name;
                } else if (lowestClientNameElement) {
                    lowestClientNameElement.textContent = '-';
                }

                const clientVariationElement = document.getElementById('clientVariation');
                if (clientVariationElement) clientVariationElement.textContent = `${Math.round(clientVariation || 0)}%`;

                // Ödeme Durumu Dağılımı
                const paidPercentageElement = document.getElementById('paidPercentage');
                if (paidPercentageElement) paidPercentageElement.textContent = `${Math.round(paidPercentage || 0)}%`;

                const unpaidPercentageElement = document.getElementById('unpaidPercentage');
                if (unpaidPercentageElement) unpaidPercentageElement.textContent = `${Math.round(unpaidPercentage || 0)}%`;

                const overduePercentageElement = document.getElementById('overduePercentage');
                if (overduePercentageElement) overduePercentageElement.textContent = `${Math.round(overduePercentage || 0)}%`;

                const paidClientsElement = document.getElementById('paidClients');
                if (paidClientsElement) paidClientsElement.textContent = `${paidCount || 0} Müvekkil`;

                const unpaidClientsElement = document.getElementById('unpaidClients');
                if (unpaidClientsElement) unpaidClientsElement.textContent = `${unpaidCount || 0} Müvekkil`;

                const overdueAmountElement = document.getElementById('overdueAmount');
                if (overdueAmountElement) overdueAmountElement.textContent = `${formatCurrency(totalOverdueAmountTL || 0)} TL`;

                // Tahminler
                if (predictions) {
                    const pred30Element = document.getElementById('prediction30Days');
                    if (pred30Element) pred30Element.textContent = `${formatCurrency(predictions.days30 || 0)} TL`;

                    const pred90Element = document.getElementById('prediction90Days');
                    if (pred90Element) pred90Element.textContent = `${formatCurrency(predictions.days90 || 0)} TL`;

                    const pred180Element = document.getElementById('prediction180Days');
                    if (pred180Element) pred180Element.textContent = `${formatCurrency(predictions.days180 || 0)} TL`;

                    const pred365Element = document.getElementById('prediction365Days');
                    if (pred365Element) pred365Element.textContent = `${formatCurrency(predictions.days365 || 0)} TL`;
                }

                // Ödeme İstatistikleri (Durum sekmesi için)
                const paidTransCountElement = document.getElementById('paidTransCount');
                if (paidTransCountElement) paidTransCountElement.textContent = paidCount || 0;

                const unpaidTransCountElement = document.getElementById('unpaidTransCount');
                if (unpaidTransCountElement) unpaidTransCountElement.textContent = unpaidCount || 0;

                const overdueTransCountElement = document.getElementById('overdueTransCount');
                if (overdueTransCountElement) overdueTransCountElement.textContent = overdueCount || 0;

                const paidTransPercentageElement = document.getElementById('paidTransPercentage');
                if (paidTransPercentageElement) paidTransPercentageElement.textContent = `${Math.round(paidPercentage || 0)}%`;

                const unpaidTransPercentageElement = document.getElementById('unpaidTransPercentage');
                if (unpaidTransPercentageElement) unpaidTransPercentageElement.textContent = `${Math.round(unpaidPercentage || 0)}%`;

                const overdueTransPercentageElement = document.getElementById('overdueTransPercentage');
                if (overdueTransPercentageElement) overdueTransPercentageElement.textContent = `${Math.round(overduePercentage || 0)}%`;
            }

            // Ödeme Durum Dağılımı Tablosunu Doldur
            const paymentStatusTableBody = document.getElementById('paymentStatusTableBody');
            if (paymentStatusTableBody && currencyTotals) {
                let tableHTML = '';
                ['TL', 'USD', 'EUR'].forEach(currency => {
                    if (currencyTotals[currency] && currencyTotals[currency].total > 0) {
                        const paidAmount = currencyTotals[currency].paid || 0;
                        const unpaidAmount = currencyTotals[currency].unpaid || 0;
                        const overdueAmount = currency === 'TL' ? (data.totalOverdueAmountTL || 0) : 0;
                        const totalAmount = currencyTotals[currency].total || 0;

                        tableHTML += `
                            <tr>
                                <td><strong>${currency}</strong></td>
                                <td style="color: #4CAF50;">${formatCurrency(paidAmount)} ${currency}</td>
                                <td style="color: #FFC107;">${formatCurrency(unpaidAmount)} ${currency}</td>
                                <td style="color: #F44336;">${formatCurrency(overdueAmount)} ${currency}</td>
                                <td><strong>${formatCurrency(totalAmount)} ${currency}</strong></td>
                            </tr>
                        `;
                    }
                });
                paymentStatusTableBody.innerHTML = tableHTML || '<tr><td colspan="5" style="text-align: center;">Veri bulunamadı</td></tr>';
            }

            // Yıllara Göre Beklenen Ödemeler Tablosunu Doldur
            const expectedPaymentsTableBody = document.getElementById('expectedPaymentsByYearTableBody');
            if (expectedPaymentsTableBody && expectedPaymentsByYear) {
                let tableHTML = '';
                const years = Object.keys(expectedPaymentsByYear).map(Number).sort((a, b) => a - b);

                years.forEach(year => {
                    const yearData = expectedPaymentsByYear[year];
                    const tlAmount = yearData['TL'] || 0;
                    const usdAmount = yearData['USD'] || 0;
                    const eurAmount = yearData['EUR'] || 0;

                    // TL karşılığı hesapla
                    const usdRate = parseFloat(exchangeRates.USD) || 0;
                    const eurRate = parseFloat(exchangeRates.EUR) || 0;
                    const totalInTL = tlAmount + (usdAmount * usdRate) + (eurAmount * eurRate);

                    tableHTML += `
                        <tr>
                            <td><strong>${year}</strong></td>
                            <td>${formatCurrency(tlAmount)} TL</td>
                            <td>${formatCurrency(usdAmount)} USD</td>
                            <td>${formatCurrency(eurAmount)} EUR</td>
                            <td><strong>${formatCurrency(totalInTL)} TL</strong></td>
                        </tr>
                    `;
                });
                expectedPaymentsTableBody.innerHTML = tableHTML || '<tr><td colspan="5" style="text-align: center;">Beklenen ödeme bulunmuyor</td></tr>';
            }
        }

        // Yıllık Analiz Tablosunu Doldur
        function populateYearlyTable() {
            if (!window.statsData || !window.statsData.yearlyData || !window.statsData.years) return;
            const { yearlyData, years } = window.statsData;
            const tableContainer = document.getElementById('yearly-tab').querySelector('.detail-table-container');
            if (!tableContainer) return;

            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Yıl', 'Toplam TL', 'Ödenen TL', 'Beklenen TL', 'Toplam USD', 'Ödenen USD', 'Beklenen USD', 'Toplam EUR', 'Ödenen EUR', 'Beklenen EUR'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            years.forEach(year => {
                const data = yearlyData[year] || { currencies: { TL: {}, USD: {}, EUR: {} } };
                const row = tbody.insertRow();
                row.insertCell().textContent = year;
                row.insertCell().textContent = formatCurrency(data.currencies.TL.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.TL.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.TL.unpaid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.USD.unpaid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.total || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.paid || 0);
                row.insertCell().textContent = formatCurrency(data.currencies.EUR.unpaid || 0);
            });
            tableContainer.appendChild(table);
        }

        // Durum Analizi Tablosunu Doldur
        function populateStatusTable() {
            if (!window.statsData) return;
            const { paidCount, unpaidCount, currencyTotals, overdueCount } = window.statsData;
            const tableContainer = document.getElementById('status-tab').querySelector('.detail-table-container');
            if (!tableContainer) return;

            tableContainer.innerHTML = '';
            const table = document.createElement('table');
            table.className = 'detail-table';
            const tbody = table.createTBody();

            function addRow(label, value) {
                const row = tbody.insertRow();
                row.insertCell().textContent = label;
                row.insertCell().textContent = value;
            }

            addRow('Ödenen Müvekkil Sayısı', paidCount);
            addRow('Ödenmemiş Müvekkil Sayısı', unpaidCount);
            addRow('Vadesi Geçmiş Ödeme Sayısı', overdueCount);
            addRow('Toplam TL Alacak', formatCurrency(currencyTotals.TL.total) + ' TL');
            addRow('Ödenen TL Tutar', formatCurrency(currencyTotals.TL.paid) + ' TL');
            addRow('Beklenen TL Tutar', formatCurrency(currencyTotals.TL.unpaid) + ' TL');
            addRow('Toplam USD Alacak', formatCurrency(currencyTotals.USD.total) + ' USD');
            addRow('Ödenen USD Tutar', formatCurrency(currencyTotals.USD.paid) + ' USD');
            addRow('Beklenen USD Tutar', formatCurrency(currencyTotals.USD.unpaid) + ' USD');
            addRow('Toplam EUR Alacak', formatCurrency(currencyTotals.EUR.total) + ' EUR');
            addRow('Ödenen EUR Tutar', formatCurrency(currencyTotals.EUR.paid) + ' EUR');
            addRow('Beklenen EUR Tutar', formatCurrency(currencyTotals.EUR.unpaid) + ' EUR');

            tableContainer.appendChild(table);
        }

        // *** YENİ FONKSİYON: Yıllara Göre Beklenen Ödemeler Grafiği ***
        let expectedPaymentsChartInstance = null; // Grafik örneğini takip etmek için

        function createExpectedPaymentsByYearChart() {
            const canvasElement = document.getElementById('expectedPaymentsByYearChart'); 
            if (!canvasElement) {
                console.warn("[createExpectedPaymentsByYearChart] Canvas elementi bulunamadı.");
                return; 
            }
            const ctx = canvasElement.getContext('2d');

            if (expectedPaymentsChartInstance && typeof expectedPaymentsChartInstance.destroy === 'function') {
                expectedPaymentsChartInstance.destroy();
                expectedPaymentsChartInstance = null;
            }

            if (!window.statsData || !window.statsData.expectedPaymentsByYear || Object.keys(window.statsData.expectedPaymentsByYear).length === 0) {
                console.log("Yıllara göre beklenen ödeme verisi bulunamadı veya boş.");
                ctx.clearRect(0, 0, canvasElement.width, canvasElement.height); 
                ctx.textAlign = 'center';
                ctx.fillText('Ödenmemiş beklenen ödeme verisi bulunmuyor.', canvasElement.width / 2, canvasElement.height / 2);
                return; 
            }

            const expectedData = window.statsData.expectedPaymentsByYear;
            const years = Object.keys(expectedData).map(Number).sort((a, b) => a - b); 
            
            const amountsTL = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['TL']) || 0); 
            const amountsUSD = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['USD']) || 0); 
            const amountsEUR = years.map(year => (expectedData[year.toString()] && expectedData[year.toString()]['EUR']) || 0); 

            const formatFunc = typeof formatCurrency === 'function' ? formatCurrency : (val) => val;

            expectedPaymentsChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: years, 
                    datasets: [
                        {
                            label: 'TL', 
                            data: amountsTL, 
                            backgroundColor: 'rgba(244, 67, 54, 0.7)', 
                            borderColor: 'rgba(211, 47, 47, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'USD', 
                            data: amountsUSD, 
                            backgroundColor: 'rgba(33, 150, 243, 0.7)', 
                            borderColor: 'rgba(25, 118, 210, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'EUR', 
                            data: amountsEUR, 
                            backgroundColor: 'rgba(76, 175, 80, 0.7)', 
                            borderColor: 'rgba(56, 142, 60, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, 
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) { 
                                    return formatFunc(value); 
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tutar'
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Yıl'
                            }
                        }
                    },
                    plugins: {
                        title: { 
                            display: true,
                            text: 'Yıllara Göre Beklenen Ödenmemiş Ödemeler',
                            font: { size: 14 }
                        },
                        legend: { display: true, position: 'top' }, 
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatFunc(context.parsed.y) + ' ' + context.dataset.label; 
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            console.log("Yıllara göre beklenen ödemeler grafiği oluşturuldu/güncellendi.");
        }
        // *** BİTTİ: Yeni Fonksiyon ***

        // EKSİK FONKSİYON TANIMLARI EKLENİYOR
        function createCurrencyCharts() {
            if (!window.statsData || !window.statsData.currencyTotals) {
                console.warn("[createCurrencyCharts] Para birimi istatistik verileri bulunamadı.");
                // Grafik alanlarını temizle ve mesaj göster
                const ctxDist = document.getElementById('currencyDistributionChart')?.getContext('2d');
                const ctxStatus = document.getElementById('currencyStatusChart')?.getContext('2d');
                if (ctxDist) {
                    ctxDist.clearRect(0, 0, ctxDist.canvas.width, ctxDist.canvas.height);
                    ctxDist.textAlign = 'center';
                    ctxDist.fillText('Dağılım grafiği için veri yok.', ctxDist.canvas.width / 2, ctxDist.canvas.height / 2);
                }
                if (ctxStatus) {
                    ctxStatus.clearRect(0, 0, ctxStatus.canvas.width, ctxStatus.canvas.height);
                    ctxStatus.textAlign = 'center';
                    ctxStatus.fillText('Durum grafiği için veri yok.', ctxStatus.canvas.width / 2, ctxStatus.canvas.height / 2);
                }
                return;
            }

            const { currencyTotals } = window.statsData;
            const currencies = Object.keys(currencyTotals).filter(c => currencyTotals[c] && (currencyTotals[c].total > 0 || currencyTotals[c].transactions > 0)); // Sadece işlem görmüş para birimleri

            // 1. Para Birimi Dağılım Grafiği (Toplam Alacaklara Göre - TL Bazında Yaklaşık)
            const ctxDistribution = document.getElementById('currencyDistributionChart').getContext('2d');
            if (window.currencyDistributionChartInstance) {
                window.currencyDistributionChartInstance.destroy();
            }

            const distributionLabels = [];
            const distributionData = [];
            const distributionColors = [];
            const currencyColorMap = {
                'TL': 'rgba(33, 150, 243, 0.7)',  // Mavi
                'USD': 'rgba(76, 175, 80, 0.7)',  // Yeşil
                'EUR': 'rgba(255, 152, 0, 0.7)', // Turuncu
                'OTHER': 'rgba(158, 158, 158, 0.7)' // Gri
            };

            currencies.forEach(currency => {
                let totalInTL = currencyTotals[currency].total;
                // USD ve EUR'yu yaklaşık TL'ye çevir (varsayımsal kurlar)
                if (currency === 'USD') totalInTL *= 30; 
                if (currency === 'EUR') totalInTL *= 32;
                
                distributionLabels.push(currency);
                distributionData.push(totalInTL);
                distributionColors.push(currencyColorMap[currency] || currencyColorMap['OTHER']);
            });
            
            if (distributionData.every(val => val === 0)) {
                 ctxDistribution.clearRect(0, 0, ctxDistribution.canvas.width, ctxDistribution.canvas.height);
                 ctxDistribution.textAlign = 'center';
                 ctxDistribution.fillText('Para birimi dağılımı için veri yok.', ctxDistribution.canvas.width / 2, ctxDistribution.canvas.height / 2);
            } else {
                window.currencyDistributionChartInstance = new Chart(ctxDistribution, {
                    type: 'doughnut',
                    data: {
                        labels: distributionLabels,
                        datasets: [{
                            data: distributionData,
                            backgroundColor: distributionColors,
                            borderColor: distributionColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Para Birimi Dağılımı (Toplam Alacak - Yaklaşık TL)' },
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) label += ': ';
                                        // Orijinal tutarı ve para birimini göstermek daha iyi olabilir.
                                        // Ancak pasta grafik yüzdelerle çalıştığı için TL çevrimi yapıldı.
                                        // Şimdilik TL karşılığını gösteriyoruz.
                                        if (context.parsed !== null) {
                                            label += formatCurrency(context.parsed) + ' TL (Yaklaşık)';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 2. Para Birimi Durum Grafiği (Ödenen vs Ödenmemiş)
            const ctxStatus = document.getElementById('currencyStatusChart').getContext('2d');
            if (window.currencyStatusChartInstance) {
                window.currencyStatusChartInstance.destroy();
            }

            const statusLabels = currencies;
            const paidData = currencies.map(c => currencyTotals[c].paid);
            const unpaidData = currencies.map(c => currencyTotals[c].unpaid);

            if (paidData.every(val => val === 0) && unpaidData.every(val => val === 0) ) {
                 ctxStatus.clearRect(0, 0, ctxStatus.canvas.width, ctxStatus.canvas.height);
                 ctxStatus.textAlign = 'center';
                 ctxStatus.fillText('Para birimi durumu için veri yok.', ctxStatus.canvas.width / 2, ctxStatus.canvas.height / 2);
            } else {
                window.currencyStatusChartInstance = new Chart(ctxStatus, {
                    type: 'bar',
                    data: {
                        labels: statusLabels,
                        datasets: [
                            {
                                label: 'Ödenen',
                                data: paidData,
                                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Ödenmemiş',
                                data: unpaidData,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Tutar' }, ticks: { callback: formatCurrency }},
                            x: { title: { display: true, text: 'Para Birimi' }}
                        },
                        plugins: {
                            title: { display: true, text: 'Para Birimi Bazında Ödeme Durumları' },
                            legend: { position: 'top' },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) label += ': ';
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y) + ' ' + context.label;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        // Para Birimi Detay Tablosunu Doldur
        function populateCurrencyTable() {
            const tableContainer = document.getElementById('currencyTableContainer');
            if (!tableContainer) {
                console.error("[populateCurrencyTable] Tablo konteyneri 'currencyTableContainer' bulunamadı.");
                return;
            }
            tableContainer.innerHTML = '';

            if (!window.statsData || !window.statsData.currencyTotals) {
                console.warn("[populateCurrencyTable] Para birimi istatistik verileri bulunamadı.");
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Para birimi detay verisi bulunmamaktadır.</p>';
                return;
            }

            const { currencyTotals } = window.statsData;
            const currencies = Object.keys(currencyTotals).filter(c => currencyTotals[c] && (currencyTotals[c].total > 0 || currencyTotals[c].transactions > 0));

            if (currencies.length === 0) {
                tableContainer.innerHTML = '<p style="text-align:center; padding: 20px;">Gösterilecek para birimi detayı bulunmamaktadır.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'detail-table';
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            ['Para Birimi', 'Toplam Alacak', 'Ödenen Tutar', 'Beklenen Tutar', 'İşlem Sayısı'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            currencies.forEach(currency => {
                const data = currencyTotals[currency];
                const row = tbody.insertRow();
                row.insertCell().textContent = currency;
                row.insertCell().textContent = formatCurrency(data.total || 0);
                row.insertCell().textContent = formatCurrency(data.paid || 0);
                row.insertCell().textContent = formatCurrency(data.unpaid || 0);
                row.insertCell().textContent = data.transactions || 0;
            });
            tableContainer.appendChild(table);
        }

        // Tahsilat Trendi Grafiğini Oluştur
        function createCollectionTrendChart() {
            const ctx = document.getElementById('collectionTrendChart')?.getContext('2d');
            if (!ctx) {
                console.warn("[createCollectionTrendChart] Tahsilat trendi için canvas bulunamadı.");
                return;
            }
            if (window.collectionTrendChartInstance) {
                window.collectionTrendChartInstance.destroy();
            }

            if (!window.statsData || !window.statsData.monthlyData) { // Aylık ödenen verilerini kullanacağız
                console.warn("[createCollectionTrendChart] Tahsilat trendi için aylık veri bulunamadı.");
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Tahsilat trendi için veri yok.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const { monthlyData, years } = window.statsData;
            const sortedYears = [...years].sort((a,b) => a-b); // Yılları sırala
            
            const labels = []; // YYYY-AA formatında
            const paidDataTL = []; // Sadece TL ödemeleri veya tümü TL'ye çevrilmiş
            let dataFound = false;

            sortedYears.forEach(year => {
                for (let month = 1; month <= 12; month++) {
                    const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                    const monthEntry = monthlyData[monthKey];
                    let monthPaidAmountTL = 0;

                    if (monthEntry && monthEntry.currencies) {
                        dataFound = true;
                        // Tüm para birimlerindeki ödenenleri TL'ye çevirerek topla
                        Object.keys(monthEntry.currencies).forEach(currency => {
                            const currencyData = monthEntry.currencies[currency];
                            let multiplier = 1;
                            if (currency === 'USD') multiplier = 30;
                            if (currency === 'EUR') multiplier = 32;
                            monthPaidAmountTL += (currencyData.paid || 0) * multiplier;
                        });
                    }
                     // Sadece veri olan ayları ekleyebiliriz veya tüm ayları 0 ile gösterebiliriz.
                     // Şimdilik, içinde bulunduğumuz yıla kadar tüm ayları gösterelim.
                    if (dataFound || (year <= new Date().getFullYear())) { // Eğer geçmişte veri varsa veya mevcut/geçmiş bir yılsa etiketi ekle
                        labels.push(monthKey);
                        paidDataTL.push(monthPaidAmountTL);
                    }
                }
            });
            
            // Eğer hiç veri bulunamadıysa grafiği boş göster
            if (!dataFound || paidDataTL.every(val => val === 0)) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.textAlign = 'center';
                ctx.fillText('Tahsilat trendi için veri bulunamadı.', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            window.collectionTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Tahsilat (Yaklaşık TL)',
                        data: paidDataTL,
                        borderColor: 'rgba(75, 192, 192, 1)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Tutar (Yaklaşık TL)' }, ticks: { callback: formatCurrency }},
                        x: { title: { display: true, text: 'Dönem (Yıl-Ay)' }}
                    },
                    plugins: {
                        title: { display: true, text: 'Aylık Tahsilat Trendi' },
                        legend: { display: false } // Tek dataset olduğu için legend gereksiz olabilir
                    }
                }
            });
        }



        // Diğer event listener'lar ve fonksiyonlar burada kalacak (savePayment, updateClient, openEditModal, deletePayment, generateStats vb.)
        // Global fonksiyonlar zaten yukarıda window'a atandı
        // generateStats ve ilgili fonksiyonlar burada tanımlı olmalı
        // ...

        // Ödeme düzenlemesi tamamlandıktan sonra tekrar detay modalını açmak için
        window.updateClient = async function(client_id) {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            
            // CSRF token'ı al
            let csrfToken = null;
            
            // Global değişkenden al
            if (typeof window.csrf_token !== 'undefined') {
                csrfToken = window.csrf_token;
                console.log('CSRF token global değişkenden alındı:', csrfToken);
            }
            
            // Formdan al
            const formCsrfInput = form.querySelector('input[name="csrf_token"]');
            if (formCsrfInput && formCsrfInput.value) {
                csrfToken = formCsrfInput.value;
                console.log('CSRF token formdan alındı:', csrfToken);
            }
            
            // Meta tag'den al
            const metaCsrf = document.querySelector('meta[name="csrf-token"]');
            if (metaCsrf && metaCsrf.content) {
                csrfToken = metaCsrf.content;
                console.log('CSRF token meta tagden alındı:', csrfToken);
            }
            
            if (!csrfToken) {
                console.error('CSRF token bulunamadı!');
                alert('Güvenlik token\'ı bulunamadı. Sayfayı yenileyin.');
                return;
            }
            
            // Form verilerini JSON'a dönüştür
            const data = {};
            formData.forEach((value, key) => {
                if (key === 'amount') {
                    // Tutar alanında sadece sayısal değeri al - formatlanmış değeri parse et
                    console.log('updateClient DEBUG - Orijinal amount value:', value);
                    
                    // Number input'dan gelen değer zaten doğru formatta (örn: 25000.0)
                    // Sadece parseFloat ile sayıya çevir, hiçbir string manipülasyonu yapma
                    const finalAmount = parseFloat(value).toString() || '0';
                    console.log('updateClient DEBUG - Final amount:', finalAmount);
                    data[key] = finalAmount;
                } else {
                    data[key] = value;
                }
            });

            // CSRF token'ı ekle
            data['csrf_token'] = csrfToken;

            // Ödeme durumunu manuel olarak al ve ekle
            const editStatusCheckbox = document.getElementById('editStatus');
            if (editStatusCheckbox) {
                data['status'] = editStatusCheckbox.checked ? 'Ödendi' : 'Ödenmedi';
            }

            // Açıklama alanını manuel olarak al ve ekle
            const editDescription = document.getElementById('editDescription');
            if (editDescription) {
                data['description'] = editDescription.value || '';
            }

            // Entity type ekle
            const editEntityType = document.getElementById('editEntityType');
            if (editEntityType) {
                data['entity_type'] = editEntityType.value;
            }

            // Payment date ekle (eğer ödeme durumu ödendi ise)
            if (editStatusCheckbox && editStatusCheckbox.checked) {
                const editPaymentDate = document.getElementById('editPaymentDate');
                if (editPaymentDate && editPaymentDate.value) {
                    data['payment_date'] = editPaymentDate.value;
                }
            }
            
            console.log('Gönderilecek veri:', data);
            
            try {
                const response = await fetch(`/update_client/${client_id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Düzenleme modalını kapat
                    closeModal();
                    
                    // İlgili satırı güncelle
                    let row = document.querySelector(`tr[data-client-id="${client_id}"]`);
                    if (!row) {
                        // data-client-id bulunamadıysa data-id'yi dene
                        row = document.querySelector(`tr[data-id="${client_id}"]`);
                    }
                    
                    if (row) {
                        // Ödeme Türü güncelleme (1. sütun - nth-child(1))
                        const paymentTypeCell = row.querySelector('td:nth-child(1)');
                        if (paymentTypeCell && data.payment_type) {
                            // Ödeme türüne göre renk sınıfını belirle
                            let typeClass = '';
                            if (data.payment_type === 'Aylık Danışmanlık Ücreti') typeClass = 'payment-type-aylik-danismanlik';
                            else if (data.payment_type.includes('Danışma')) typeClass = 'payment-type-danisma';
                            else if (data.payment_type.includes('İhtarname')) typeClass = 'payment-type-ihtarname';
                            else if (data.payment_type.includes('Dilekçe')) typeClass = 'payment-type-dilekce';
                            else if (data.payment_type.includes('Dosya')) typeClass = 'payment-type-dosya';
                            else if (data.payment_type.includes('Sözleşme')) typeClass = 'payment-type-sozlesme';
                            else if (data.payment_type.includes('Mahkeme')) typeClass = 'payment-type-mahkeme';
                            else if (data.payment_type.includes('Diğer')) typeClass = 'payment-type-diger';

                            paymentTypeCell.innerHTML = `<span class="payment-type-badge ${typeClass}">${data.payment_type}</span>`;
                        }

                        // Diğer alanları güncelle (sütun sıralaması: 1=payment_type, 2=name, 3=surname, 4=tc, 5=amount, 6=installments, 7=reg_date, 8=due_date, 9=payment_date, 10=status)
                        row.querySelector('td:nth-child(2)').textContent = data.name;
                        row.querySelector('td:nth-child(3)').textContent = data.surname;
                        row.querySelector('td:nth-child(4)').textContent = data.tc;

                        // Tutar güncelleme - Türkçe format ile
                        const amount = parseFloat(data.amount);
                        const formattedAmount = amount.toLocaleString('tr-TR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                        row.querySelector('td:nth-child(5)').textContent = `${formattedAmount} ${data.currency}`;

                        // Data attribute'ları güncelle
                        row.setAttribute('data-amount', data.amount);
                        row.setAttribute('data-currency', data.currency);

                        row.querySelector('td:nth-child(6)').textContent = data.installments;

                        // Tarih güncellemeleri - YYYY-MM-DD formatını DD.MM.YYYY'ye çevir
                        const formatDateForDisplay = (dateStr) => {
                            if (!dateStr || dateStr === '-') return '-';
                            // YYYY-MM-DD formatını kontrol et
                            if (dateStr.includes('-')) {
                                const parts = dateStr.split('-');
                                if (parts.length === 3) {
                                    return `${parts[2]}.${parts[1]}.${parts[0]}`;
                                }
                            }
                            // Zaten DD.MM.YYYY formatında
                            return dateStr;
                        };

                        if (data.registration_date) {
                            row.querySelector('td:nth-child(7)').textContent = formatDateForDisplay(data.registration_date);
                        }
                        if (data.due_date) {
                            row.querySelector('td:nth-child(8)').textContent = formatDateForDisplay(data.due_date);
                        }

                        // Durum güncelleme (10. sütun)
                        const statusCell = row.querySelector('td:nth-child(10)');
                        if (statusCell) {
                            const statusBadge = statusCell.querySelector('.status-badge');
                            if (statusBadge) {
                                if (data.status === 'Ödendi') {
                                    statusBadge.className = 'status-badge status-paid';
                                    statusBadge.textContent = 'Ödendi';
                                } else {
                                    statusBadge.className = 'status-badge status-unpaid';
                                    statusBadge.textContent = 'Ödenmedi';
                                }
                            }
                        }

                        // Açıklama ve ödeme türü data attribute'lerini güncelle
                        if (data.description) {
                            row.setAttribute('data-description', data.description);
                        }
                        if (data.payment_type) {
                            row.setAttribute('data-payment-type', data.payment_type);
                        }
                    }
                    
                    // Başarı mesajı göster
                    showGlobalNotification('Müvekkil bilgileri güncellendi.', 'success');
                    
                    // Sayfa yenilenmeden detay modalını aç
                    setTimeout(() => {
                        const viewBtn = document.querySelector(`.view-btn[data-payment-id="${client_id}"]`);
                        if (viewBtn) {
                            viewBtn.click();
                        }
                    }, 500); // Kısa bir gecikme ekleyerek UI'nin güncellenmesine zaman tanıyoruz
                    
                } else {
                    alert('Hata: ' + (result.error || 'Güncelleme sırasında bir hata oluştu'));
                }
            } catch (error) {
                console.error('Güncelleme hatası:', error);
                alert('Hata: Sunucu iletişim hatası');
            }
        };

        // Modal kapatma fonksiyonu
        function closeModal() {
            // Normal modalı kapat
            const editModalElement = document.getElementById('editModal');
            if (editModalElement) {
                editModalElement.style.display = 'none';
            }
            
            // Bootstrap modalını kapat
            const detailModalElement = document.getElementById('paymentDetailModal');
            if (detailModalElement) {
                const detailModalInstance = bootstrap.Modal.getInstance(detailModalElement);
                if (detailModalInstance) {
                    detailModalInstance.hide();
                }
            }
        }

        // YENİ BASİT VE GÜZEL ÖDEME DETAYLARI MODALI
        document.querySelectorAll('.view-btn').forEach(button => {
            button.addEventListener('click', function() {
                const paymentId = this.getAttribute('data-payment-id');
                showPaymentDetailModal(paymentId);
            });
        });

        function showPaymentDetailModal(paymentId) {
            fetch(`/api/odeme_detay/${paymentId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Hata: ' + data.error);
                        return;
                    }
                    createSimpleModal(data, paymentId);
                })
                .catch(error => {
                    console.error('Hata:', error);
                    alert('Ödeme detayları yüklenirken bir hata oluştu.');
                });
        }

        function createSimpleModal(data, paymentId) {
            const oldModal = document.getElementById('paymentDetailModal');
            if (oldModal) oldModal.remove();

            let displayCurrency = data.currency || 'TL';
            if (displayCurrency.toUpperCase() === 'TL') {
                displayCurrency = 'TRY';
            }

            // Tarihleri DD.MM.YYYY formatına çevir
            const formatDate = (dateStr) => {
                if (!dateStr || dateStr === '-') return 'Belirtilmemiş';
                // YYYY-MM-DD veya DD.MM.YYYY formatını kontrol et
                if (dateStr.includes('-')) {
                    // YYYY-MM-DD formatı
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        return `${parts[2]}.${parts[1]}.${parts[0]}`;
                    }
                }
                // Zaten DD.MM.YYYY formatında
                return dateStr;
            };

            data.registration_date = formatDate(data.registration_date);
            data.due_date = formatDate(data.due_date);

            const modalHtml = `
            <div class="modal fade" id="paymentDetailModal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content modern-payment-modal">
                        <div class="modal-header modern-payment-header">
                            <div class="header-left">
                                <div class="modal-icon">
                                    <i class="material-icons">receipt_long</i>
                                </div>
                                <div class="header-text">
                                    <h5 class="modal-title">Ödeme Detayları</h5>
                                    <p class="modal-subtitle">Müvekkil bilgileri ve ödeme durumu</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close modern-close" data-bs-dismiss="modal" aria-label="Kapat">
                                <i class="material-icons">close</i>
                            </button>
                        </div>
                        <div class="modal-body modern-payment-body">
                            <div class="payment-card main-card">
                                <div class="card-header">
                                    <div class="client-avatar">
                                        <i class="material-icons">account_circle</i>
                                    </div>
                                    <div class="client-details">
                                        <h6 class="client-name">${data.name || 'N/A'} ${data.surname || ''}</h6>
                                        <p class="client-tc">TC: ${data.tc || '-'}</p>
                                    </div>
                                    <div class="payment-status-badge ${data.status === 'Ödendi' ? 'paid' : 'unpaid'}">
                                        <i class="material-icons">${data.status === 'Ödendi' ? 'verified' : 'schedule'}</i>
                                        <span>${data.status === 'Ödendi' ? 'Ödendi' : 'Bekliyor'}</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="amount-section">
                                        <div class="amount-label">Toplam Tutar</div>
                                        <div class="amount-value">
                                            ${parseFloat(data.amount || 0).toLocaleString('tr-TR', {
                                                style: 'currency',
                                                currency: displayCurrency
                                            })}
                                        </div>
                                        <div class="installment-info">${data.installments === 'Taksit Yok' || data.installments === '' || !data.installments ? 'Taksit Yok' : data.installments + ' taksit'}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-card info-card">
                                <div class="info-grid">
                                    <div class="info-item full-width">
                                        <div class="info-icon">
                                            <i class="material-icons">category</i>
                                        </div>
                                        <div class="info-content">
                                            <div class="info-label">Ödeme Türü</div>
                                            <div class="info-value">${data.payment_type || 'Belirtilmemiş'}</div>
                                        </div>
                                    </div>
                                    <div class="info-item date-item">
                                        <div class="info-icon">
                                            <i class="material-icons">event_note</i>
                                        </div>
                                        <div class="info-content">
                                            <div class="info-label">Borç Kayıt Tarihi</div>
                                            <div class="info-value">${data.registration_date || 'Belirtilmemiş'}</div>
                                        </div>
                                    </div>
                                    <div class="info-item date-item">
                                        <div class="info-icon">
                                            <i class="material-icons">schedule</i>
                                        </div>
                                        <div class="info-content">
                                            <div class="info-label">Son Ödeme Tarihi</div>
                                            <div class="info-value due-date-value">${data.due_date || 'Belirtilmemiş'}</div>
                                        </div>
                                    </div>
                                    <div class="info-item full-width">
                                        <div class="info-icon">
                                            <i class="material-icons">description</i>
                                        </div>
                                        <div class="info-content">
                                            <div class="info-label">Açıklama</div>
                                            <div class="info-value description-text">${data.description || 'Bu ödeme için herhangi bir açıklama eklenmemiş.'}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer modern-payment-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="material-icons">close</i>
                                <span>Kapat</span>
                            </button>
                            <button type="button" class="btn btn-primary modern-edit-btn" onclick="editPayment('${paymentId}')" style="display: ${hasEditPermission ? 'inline-flex' : 'none'};">
                                <i class="material-icons">edit</i>
                                <span>Düzenle</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const modal = new bootstrap.Modal(document.getElementById('paymentDetailModal'));
            modal.show();

            document.getElementById('paymentDetailModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        }

        function editPayment(paymentId) {
            // Yetki kontrolü
            if (!hasEditPermission) {
                showGlobalNotification('Ödeme düzenleme yetkiniz bulunmamaktadır.', 'error');
                return;
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('paymentDetailModal'));
            if (modal) modal.hide();

            const editModalElement = document.getElementById('editModal');
            if (editModalElement) {
                editModalElement.style.display = 'flex';
                let targetRow = document.querySelector(`tr[data-client-id="${paymentId}"]`);
                if (!targetRow) {
                    targetRow = document.querySelector(`tr[data-id="${paymentId}"]`);
                }
                if (targetRow) {
                    fillEditForm(targetRow, paymentId);
                }
            }
        }

        function fillEditForm(targetRow, paymentId) {
            document.getElementById('editClientId').value = paymentId;
            // Sütun sıralaması: 0=payment_type, 1=name, 2=surname, 3=tc, 4=amount, 5=installments, 6=reg_date, 7=due_date, 8=payment_date, 9=status

            // Ödeme türünü data attribute'dan al
            const paymentTypeText = targetRow.getAttribute('data-payment-type') || '';
            document.getElementById('editPaymentType').value = paymentTypeText;

            const nameText = targetRow.cells[1].textContent.trim();
            const surnameText = targetRow.cells[2].textContent.trim();

            document.getElementById('editName').value = nameText;
            document.getElementById('editSurname').value = surnameText;
            document.getElementById('editTc').value = targetRow.cells[3].textContent.trim();

            // Entity type'ı belirle (surname boş ise kurum)
            const editEntityType = document.getElementById('editEntityType');
            const editNameLabel = document.getElementById('editNameLabel');
            const editSurnameLabel = document.getElementById('editSurnameLabel');
            const editTcLabel = document.getElementById('editTcLabel');
            const editSurnameGroup = document.getElementById('editSurnameGroup');
            const editNameGroup = document.getElementById('editNameGroup');
            
            const editSurnameInput = document.getElementById('editSurname');
            
            if (surnameText === '' || surnameText === '-') {
                editEntityType.value = 'company';
                editNameLabel.textContent = 'Kurum Adı';
                editSurnameLabel.textContent = '';
                editSurnameGroup.style.display = 'none';
                editSurnameInput.required = false;
                editNameGroup.classList.add('full-width');
                editTcLabel.textContent = 'Vergi/Mersis/Ticaret Sicil No (İsteğe Bağlı)';
            } else {
                editEntityType.value = 'person';
                editNameLabel.textContent = 'Ad';
                editSurnameLabel.textContent = 'Soyad';
                editSurnameGroup.style.display = 'block';
                editSurnameInput.required = true;
                editNameGroup.classList.remove('full-width');
                editTcLabel.textContent = 'TC Kimlik No (İsteğe Bağlı)';
            }

            // Para miktarı ve para birimini data attribute'lardan al (HAM DEĞERLER)
            const amount = targetRow.getAttribute('data-amount');
            const currency = targetRow.getAttribute('data-currency');

            document.getElementById('editAmount').value = amount;
            document.getElementById('editCurrency').value = currency;

            const installmentsText = targetRow.cells[5].textContent.trim();
            document.getElementById('editInstallments').value = installmentsText === '-' ? '0' : installmentsText;

            const regDateText = targetRow.cells[6].textContent.trim();
            if (regDateText && regDateText !== '-') {
                const dateParts = regDateText.split('.');
                if (dateParts.length === 3) {
                    document.getElementById('editRegistrationDate').value =
                        `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                }
            }

            const dueDateText = targetRow.cells[7].textContent.trim();
            if (dueDateText && dueDateText !== '-') {
                const dateParts = dueDateText.split('.');
                if (dateParts.length === 3) {
                    document.getElementById('editDueDate').value =
                        `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                }
            } else {
                document.getElementById('editDueDate').value = '';
            }

            // Payment date (sütun 8)
            const paymentDateText = targetRow.cells[8].textContent.trim();
            const editPaymentDateRow = document.getElementById('editPaymentDateRow');
            if (paymentDateText && paymentDateText !== '-') {
                const dateParts = paymentDateText.split('.');
                if (dateParts.length === 3) {
                    document.getElementById('editPaymentDate').value =
                        `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                    editPaymentDateRow.style.display = 'flex';
                }
            } else {
                document.getElementById('editPaymentDate').value = '';
                editPaymentDateRow.style.display = 'none';
            }

            const isPaid = targetRow.cells[9].textContent.trim().includes('Ödendi');
            const editStatusCheckbox = document.getElementById('editStatus');
            const statusTextSpan = document.querySelector('.status-text');
            
            if (editStatusCheckbox) editStatusCheckbox.checked = isPaid;
            if (statusTextSpan) statusTextSpan.textContent = isPaid ? 'Ödendi' : 'Ödenmedi';
            
            // Ödendi ise payment date row'u göster
            if (isPaid && editPaymentDateRow) {
                editPaymentDateRow.style.display = 'flex';
            }

            const description = targetRow.getAttribute('data-description');
            document.getElementById('editDescription').value =
                description === 'None' || !description ? '' : description;
        }

        // ========== ÖDEME TÜRÜ ANALİZİ FONKSİYONLARI ==========

        function getPaymentTypeClass(typeName) {
            if (!typeName) return 'type-diger';
            if (typeName === 'Aylık Danışmanlık Ücreti') return 'type-aylik-danismanlik'; // Aylık Danışmanlık Ücreti
            if (typeName.includes('Danışma')) return 'type-danisma'; // Danışma Ücreti
            if (typeName.includes('İhtarname')) return 'type-ihtarname';
            if (typeName.includes('Dilekçe')) return 'type-dilekce';
            if (typeName.includes('Dosya')) return 'type-dosya';
            if (typeName.includes('Sözleşme')) return 'type-sozlesme';
            if (typeName.includes('Mahkeme')) return 'type-mahkeme';
            return 'type-diger';
        }

        function getPaymentTypeIcon(typeName) {
            if (!typeName) return 'category';
            if (typeName.includes('Danışma')) return 'support_agent';
            if (typeName.includes('İhtarname')) return 'email';
            if (typeName.includes('Dilekçe')) return 'description';
            if (typeName.includes('Dosya')) return 'folder';
            if (typeName.includes('Sözleşme')) return 'article';
            if (typeName.includes('Mahkeme')) return 'gavel';
            return 'more_horiz';
        }

        function getPaymentTypeColor(typeName) {
            if (!typeName) return '#f57f17';
            if (typeName === 'Aylık Danışmanlık Ücreti') return '#01579b'; // Aylık Danışmanlık Ücreti
            if (typeName.includes('Danışma')) return '#2e7d32'; // Danışma Ücreti
            if (typeName.includes('İhtarname')) return '#e65100';
            if (typeName.includes('Dilekçe')) return '#1565c0';
            if (typeName.includes('Dosya')) return '#6a1b9a';
            if (typeName.includes('Sözleşme')) return '#c2185b';
            if (typeName.includes('Mahkeme')) return '#00695c';
            return '#f57f17'; // Diğer
        }

        function populatePaymentTypeCards() {
            const container = document.getElementById('paymentTypeCardsContainer');
            if (!container) return;

            const stats = window.statsData.paymentTypeStats;
            if (!stats || Object.keys(stats).length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 40px; color: #6c757d;">Henüz ödeme türü verisi bulunmamaktadır.</p>';
                return;
            }

            container.innerHTML = '';

            // Toplam tutara göre sırala
            const sortedTypes = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);

            sortedTypes.forEach(([typeName, data]) => {
                const typeClass = getPaymentTypeClass(typeName);
                const icon = getPaymentTypeIcon(typeName);
                const paidPercentage = data.total > 0 ? ((data.paid / data.total) * 100).toFixed(1) : 0;

                const card = document.createElement('div');
                card.className = `payment-type-card ${typeClass}`;
                card.innerHTML = `
                    <div class="payment-type-card-header">
                        <div class="payment-type-card-icon">
                            <i class="material-icons">${icon}</i>
                        </div>
                        <div class="payment-type-card-title">${typeName}</div>
                    </div>
                    <div class="payment-type-card-stats">
                        <div class="payment-type-stat-row">
                            <span class="payment-type-stat-label">Toplam Gelir</span>
                            <span class="payment-type-stat-value">${data.total.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} TL</span>
                        </div>
                        <div class="payment-type-stat-row">
                            <span class="payment-type-stat-label">Ödenen</span>
                            <span class="payment-type-stat-value paid">${data.paid.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} TL</span>
                        </div>
                        <div class="payment-type-stat-row">
                            <span class="payment-type-stat-label">Beklenen</span>
                            <span class="payment-type-stat-value unpaid">${data.unpaid.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} TL</span>
                        </div>
                        <div class="payment-type-stat-row">
                            <span class="payment-type-stat-label">İşlem Sayısı</span>
                            <span class="payment-type-stat-value">${data.count}</span>
                        </div>
                        <div class="payment-type-stat-row">
                            <span class="payment-type-stat-label">Tahsilat Oranı</span>
                            <span class="payment-type-stat-value" style="color: ${paidPercentage >= 50 ? '#4caf50' : '#f44336'}">%${paidPercentage}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function createPaymentTypeCharts() {
            const stats = window.statsData.paymentTypeStats;
            if (!stats || Object.keys(stats).length === 0) return;

            // 1. Toplam Gelir Dağılımı (Pie Chart)
            const ctxTotal = document.getElementById('paymentTypeTotalChart');
            if (!ctxTotal) return;

            if (window.paymentTypeTotalChartInstance) {
                window.paymentTypeTotalChartInstance.destroy();
            }

            const sortedTypes = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);
            const labels = sortedTypes.map(([name]) => name);
            const totals = sortedTypes.map(([, data]) => data.total);
            const colors = sortedTypes.map(([name]) => getPaymentTypeColor(name));

            window.paymentTypeTotalChartInstance = new Chart(ctxTotal, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: totals,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${context.label}: ${value.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 2. Ödenen vs Beklenen (Bar Chart)
            const ctxStatus = document.getElementById('paymentTypeStatusChart');
            if (!ctxStatus) return;

            if (window.paymentTypeStatusChartInstance) {
                window.paymentTypeStatusChartInstance.destroy();
            }

            const paidData = sortedTypes.map(([, data]) => data.paid);
            const unpaidData = sortedTypes.map(([, data]) => data.unpaid);

            window.paymentTypeStatusChartInstance = new Chart(ctxStatus, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ödenen',
                            data: paidData,
                            backgroundColor: '#4caf50',
                            borderRadius: 6
                        },
                        {
                            label: 'Beklenen',
                            data: unpaidData,
                            backgroundColor: '#f44336',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            stacked: false,
                            grid: { display: false }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR') + ' TL';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function populatePaymentTypeTable() {
            const container = document.getElementById('paymentTypeTableContainer');
            if (!container) return;

            const stats = window.statsData.paymentTypeStats;
            if (!stats || Object.keys(stats).length === 0) {
                container.innerHTML = '<p style="text-align:center; padding: 20px;">Ödeme türü detay verisi bulunmamaktadır.</p>';
                return;
            }

            const sortedTypes = Object.entries(stats).sort((a, b) => b[1].total - a[1].total);

            let tableHTML = `
                <table class="detail-table">
                    <thead>
                        <tr>
                            <th>Ödeme Türü</th>
                            <th>Toplam Gelir</th>
                            <th>Ödenen</th>
                            <th>Beklenen</th>
                            <th>İşlem Sayısı</th>
                            <th>Ödenen İşlem</th>
                            <th>Bekleyen İşlem</th>
                            <th>Tahsilat Oranı</th>
                            <th>Ort. İşlem Tutarı</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            sortedTypes.forEach(([typeName, data]) => {
                const paidPercentage = data.total > 0 ? ((data.paid / data.total) * 100).toFixed(1) : 0;
                const avgTransaction = data.count > 0 ? (data.total / data.count) : 0;
                const color = getPaymentTypeColor(typeName);

                tableHTML += `
                    <tr>
                        <td><span class="payment-type-badge" style="background-color: ${color}22; color: ${color}; border: 1px solid ${color}">${typeName}</span></td>
                        <td><strong>${data.total.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</strong></td>
                        <td style="color: #4caf50;">${data.paid.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                        <td style="color: #f44336;">${data.unpaid.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                        <td>${data.count}</td>
                        <td style="color: #4caf50;">${data.paidCount}</td>
                        <td style="color: #f44336;">${data.unpaidCount}</td>
                        <td><span style="color: ${paidPercentage >= 50 ? '#4caf50' : '#f44336'}; font-weight: 600;">%${paidPercentage}</span></td>
                        <td>${avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                    </tr>
                `;
            });

            // Toplam satırı
            const totalSum = sortedTypes.reduce((sum, [, data]) => sum + data.total, 0);
            const totalPaid = sortedTypes.reduce((sum, [, data]) => sum + data.paid, 0);
            const totalUnpaid = sortedTypes.reduce((sum, [, data]) => sum + data.unpaid, 0);
            const totalCount = sortedTypes.reduce((sum, [, data]) => sum + data.count, 0);
            const totalPaidCount = sortedTypes.reduce((sum, [, data]) => sum + data.paidCount, 0);
            const totalUnpaidCount = sortedTypes.reduce((sum, [, data]) => sum + data.unpaidCount, 0);
            const totalPercentage = totalSum > 0 ? ((totalPaid / totalSum) * 100).toFixed(1) : 0;
            const totalAvg = totalCount > 0 ? (totalSum / totalCount) : 0;

            tableHTML += `
                    <tr style="background-color: #f8f9fa; font-weight: 700;">
                        <td>TOPLAM</td>
                        <td><strong>${totalSum.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</strong></td>
                        <td style="color: #4caf50;">${totalPaid.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                        <td style="color: #f44336;">${totalUnpaid.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                        <td>${totalCount}</td>
                        <td style="color: #4caf50;">${totalPaidCount}</td>
                        <td style="color: #f44336;">${totalUnpaidCount}</td>
                        <td><span style="color: ${totalPercentage >= 50 ? '#4caf50' : '#f44336'}">%${totalPercentage}</span></td>
                        <td>${totalAvg.toLocaleString('tr-TR', {minimumFractionDigits: 2})} TL</td>
                    </tr>
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // ========== ÖDEME TÜRÜ ANALİZİ FONKSİYONLARI SONU ==========

        // ========== EXPORT MODAL FONKSİYONLARI ==========

        // Export modal elementleri
        const exportButton = document.getElementById('exportButton');
        const exportModal = document.getElementById('exportModal');
        const closeExportModal = document.getElementById('closeExportModal');
        const cancelExportBtn = document.getElementById('cancelExportBtn');
        const exportForm = document.getElementById('exportForm');
        const exportFilterType = document.getElementById('exportFilterType');
        const exportDateRangeGroup = document.getElementById('exportDateRangeGroup');
        const exportClientGroup = document.getElementById('exportClientGroup');
        const exportStartDate = document.getElementById('exportStartDate');
        const exportEndDate = document.getElementById('exportEndDate');

        // Export modal aç
        if (exportButton) {
            exportButton.onclick = function() {
                exportModal.style.display = 'flex';
                // Bugünün tarihini varsayılan olarak ayarla
                const today = new Date().toISOString().split('T')[0];
                exportEndDate.value = today;
                // Başlangıç tarihini 1 yıl öncesi yap
                const lastYear = new Date();
                lastYear.setFullYear(lastYear.getFullYear() - 1);
                exportStartDate.value = lastYear.toISOString().split('T')[0];
            };
        }

        // Export modal kapat
        if (closeExportModal) {
            closeExportModal.onclick = function() {
                exportModal.style.display = 'none';
            };
        }

        if (cancelExportBtn) {
            cancelExportBtn.onclick = function() {
                exportModal.style.display = 'none';
            };
        }

        // Filtreleme tipine göre alanları göster/gizle
        if (exportFilterType) {
            exportFilterType.addEventListener('change', function() {
                if (this.value === 'date_range') {
                    exportDateRangeGroup.style.display = 'flex';
                    exportClientGroup.style.display = 'none';
                    exportStartDate.required = true;
                    exportEndDate.required = true;
                    document.getElementById('exportClientSelect').required = false;
                } else if (this.value === 'specific_client') {
                    exportDateRangeGroup.style.display = 'none';
                    exportClientGroup.style.display = 'block';
                    exportStartDate.required = false;
                    exportEndDate.required = false;
                    document.getElementById('exportClientSelect').required = true;
                } else { // all_records
                    exportDateRangeGroup.style.display = 'none';
                    exportClientGroup.style.display = 'none';
                    exportStartDate.required = false;
                    exportEndDate.required = false;
                    document.getElementById('exportClientSelect').required = false;
                }
            });
        }

        // Export form submit
        if (exportForm) {
            exportForm.addEventListener('submit', function(e) {
                e.preventDefault();

                // Form verilerini topla
                const formData = new FormData(exportForm);
                const params = new URLSearchParams();
                
                for (let [key, value] of formData.entries()) {
                    if (value) {
                        params.append(key, value);
                    }
                }

                // Backend'e istek gönder ve dosyayı indir
                const exportUrl = `/export_payments?${params.toString()}`;
                
                // Yeni sekmede aç (PDF için) veya doğrudan indir (Excel için)
                const format = formData.get('format');
                if (format === 'pdf') {
                    window.open(exportUrl, '_blank');
                } else {
                    // Excel için doğrudan indir
                    const link = document.createElement('a');
                    link.href = exportUrl;
                    link.download = `odeme_kayitlari_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                // Modalı kapat
                exportModal.style.display = 'none';
                
                // Başarı mesajı
                alert('Ödeme kayıtları tablosu oluşturuluyor...');
            });
        }

        // ========== EXPORT MODAL FONKSİYONLARI SONU ==========

        // ========== ENTITY FILTER CHECKBOXES EVENT LISTENERS ==========

        // Filtrelenmiş client verilerini döndüren yardımcı fonksiyon
        function getFilteredClients(tabNameOrPersonChecked, companyChecked) {
            // Eğer string ise, tab adı olarak kullan
            if (typeof tabNameOrPersonChecked === 'string') {
                const tabName = tabNameOrPersonChecked;
                let personFilterId, companyFilterId;
                
                switch(tabName) {
                    case 'monthly':
                        personFilterId = 'monthlyPersonFilter';
                        companyFilterId = 'monthlyCompanyFilter';
                        break;
                    case 'yearly':
                        personFilterId = 'yearlyPersonFilter';
                        companyFilterId = 'yearlyCompanyFilter';
                        break;
                    case 'status':
                        personFilterId = 'statusPersonFilter';
                        companyFilterId = 'statusCompanyFilter';
                        break;
                    case 'currency':
                        personFilterId = 'currencyPersonFilter';
                        companyFilterId = 'currencyCompanyFilter';
                        break;
                    case 'predictions':
                        personFilterId = 'predictionsPersonFilter';
                        companyFilterId = 'predictionsCompanyFilter';
                        break;
                    default:
                        return globalClientsData;
                }
                
                const personChecked = document.getElementById(personFilterId)?.checked || false;
                companyChecked = document.getElementById(companyFilterId)?.checked || false;
                
                if (!personChecked && !companyChecked) {
                    return [];
                }
                
                return globalClientsData.filter(client => {
                    if (personChecked && companyChecked) {
                        return true;
                    } else if (personChecked) {
                        return client.entityType === 'person';
                    } else if (companyChecked) {
                        return client.entityType === 'company';
                    }
                    return false;
                });
            }
            
            // Boolean parametreler ise direkt kullan
            const personChecked = tabNameOrPersonChecked;
            
            if (!personChecked && !companyChecked) {
                return [];
            }
            
            return globalClientsData.filter(client => {
                if (personChecked && companyChecked) {
                    return true;
                } else if (personChecked) {
                    return client.entityType === 'person';
                } else if (companyChecked) {
                    return client.entityType === 'company';
                }
                return false;
            });
        }

        // Monthly filter checkbox listeners
        const monthlyPersonFilter = document.getElementById('monthlyPersonFilter');
        const monthlyCompanyFilter = document.getElementById('monthlyCompanyFilter');
        
        if (monthlyPersonFilter && monthlyCompanyFilter) {
            monthlyPersonFilter.addEventListener('change', function() {
                updateMonthlyChart();
            });
            monthlyCompanyFilter.addEventListener('change', function() {
                updateMonthlyChart();
            });
        }

        // Yearly filter checkbox listeners
        const yearlyPersonFilter = document.getElementById('yearlyPersonFilter');
        const yearlyCompanyFilter = document.getElementById('yearlyCompanyFilter');
        
        if (yearlyPersonFilter && yearlyCompanyFilter) {
            yearlyPersonFilter.addEventListener('change', function() {
                updateYearlyChart();
            });
            yearlyCompanyFilter.addEventListener('change', function() {
                updateYearlyChart();
            });
        }

        // Status filter checkbox listeners
        const statusPersonFilter = document.getElementById('statusPersonFilter');
        const statusCompanyFilter = document.getElementById('statusCompanyFilter');
        
        if (statusPersonFilter && statusCompanyFilter) {
            statusPersonFilter.addEventListener('change', function() {
                updateStatusChart();
            });
            statusCompanyFilter.addEventListener('change', function() {
                updateStatusChart();
            });
        }

        // Currency filter checkbox listeners
        const currencyPersonFilter = document.getElementById('currencyPersonFilter');
        const currencyCompanyFilter = document.getElementById('currencyCompanyFilter');
        
        if (currencyPersonFilter && currencyCompanyFilter) {
            currencyPersonFilter.addEventListener('change', function() {
                updateCurrencyCharts();
            });
            currencyCompanyFilter.addEventListener('change', function() {
                updateCurrencyCharts();
            });
        }

        // Predictions filter checkbox listeners
        const predictionsPersonFilter = document.getElementById('predictionsPersonFilter');
        const predictionsCompanyFilter = document.getElementById('predictionsCompanyFilter');
        
        if (predictionsPersonFilter && predictionsCompanyFilter) {
            predictionsPersonFilter.addEventListener('change', function() {
                updatePredictionsData();
            });
            predictionsCompanyFilter.addEventListener('change', function() {
                updatePredictionsData();
            });
        }

        // Update fonksiyonları (bu fonksiyonlar mevcut grafik oluşturma kodlarını tekrar çağıracak)
        function updateMonthlyChart() {
            const personChecked = document.getElementById('monthlyPersonFilter').checked;
            const companyChecked = document.getElementById('monthlyCompanyFilter').checked;
            const filteredClients = getFilteredClients(personChecked, companyChecked);
            
            // Mevcut filter değerlerini koru
            const yearFilter = document.getElementById('monthlyYearFilter').value;
            const currencyFilter = document.getElementById('monthlyCurrencyFilter').value;
            
            // Grafikleri yeniden oluştur
            createMonthlyChart(filteredClients, yearFilter, currencyFilter);
        }

        function updateYearlyChart() {
            const personChecked = document.getElementById('yearlyPersonFilter').checked;
            const companyChecked = document.getElementById('yearlyCompanyFilter').checked;
            const filteredClients = getFilteredClients(personChecked, companyChecked);
            
            const currencyFilter = document.getElementById('yearlyCurrencyFilter').value;
            const chartType = document.getElementById('yearlyChartType').value;
            
            createYearlyChart(filteredClients, currencyFilter, chartType);
        }

        function updateStatusChart() {
            const personChecked = document.getElementById('statusPersonFilter').checked;
            const companyChecked = document.getElementById('statusCompanyFilter').checked;
            const filteredClients = getFilteredClients(personChecked, companyChecked);
            
            createStatusChart(filteredClients);
        }

        function updateCurrencyCharts() {
            const personChecked = document.getElementById('currencyPersonFilter').checked;
            const companyChecked = document.getElementById('currencyCompanyFilter').checked;
            const filteredClients = getFilteredClients(personChecked, companyChecked);
            
            createCurrencyDistributionChart(filteredClients);
            createCurrencyStatusChart(filteredClients);
        }

        // Tahminleri hesapla
        function calculatePredictions(clients) {
            const now = new Date();
            const predictions = {
                days30: 0,
                days90: 0,
                days180: 0,
                days365: 0
            };

            // Müvekkil bazında istatistikler
            const clientStats = {};

            clients.forEach(client => {
                // Sadece ödenmemiş işlemler için tahmin yap
                if (!client.isPaid && client.dueDate) {
                    const daysUntilDue = Math.ceil((client.dueDate - now) / (1000 * 60 * 60 * 24));
                    const amountInTL = client.amountInTL || 0;

                    // Gelecek vadeler için tahmin
                    if (daysUntilDue >= 0 && daysUntilDue <= 30) {
                        predictions.days30 += amountInTL;
                    }
                    if (daysUntilDue >= 0 && daysUntilDue <= 90) {
                        predictions.days90 += amountInTL;
                    }
                    if (daysUntilDue >= 0 && daysUntilDue <= 180) {
                        predictions.days180 += amountInTL;
                    }
                    if (daysUntilDue >= 0 && daysUntilDue <= 365) {
                        predictions.days365 += amountInTL;
                    }
                }

                // Müvekkil başına toplam hesapla
                const clientId = client.id;
                if (!clientStats[clientId]) {
                    clientStats[clientId] = {
                        name: client.clientName,
                        total: 0
                    };
                }
                clientStats[clientId].total += client.amountInTL || 0;
            });

            // Müvekkil istatistiklerini hesapla
            const clientTotals = Object.values(clientStats).map(c => c.total);
            const avgPerClient = clientTotals.length > 0 ? clientTotals.reduce((a, b) => a + b, 0) / clientTotals.length : 0;

            let highestClient = { name: '-', total: 0 };
            let lowestClient = { name: '-', total: Infinity };

            Object.values(clientStats).forEach(client => {
                if (client.total > highestClient.total) {
                    highestClient = client;
                }
                if (client.total < lowestClient.total && client.total > 0) {
                    lowestClient = client;
                }
            });

            if (lowestClient.total === Infinity) {
                lowestClient = { name: '-', total: 0 };
            }

            // Varyasyon hesapla (standart sapma / ortalama)
            const variance = clientTotals.length > 0 ? clientTotals.reduce((sum, val) => sum + Math.pow(val - avgPerClient, 2), 0) / clientTotals.length : 0;
            const stdDev = Math.sqrt(variance);
            const clientVariation = avgPerClient > 0 ? ((stdDev / avgPerClient) * 100).toFixed(1) : 0;

            // Prediction kartlarını güncelle
            document.getElementById('prediction30Days').textContent = formatCurrency(predictions.days30) + ' TL';
            document.getElementById('prediction90Days').textContent = formatCurrency(predictions.days90) + ' TL';
            document.getElementById('prediction180Days').textContent = formatCurrency(predictions.days180) + ' TL';
            document.getElementById('prediction365Days').textContent = formatCurrency(predictions.days365) + ' TL';

            // Müvekkil başına ödeme kartlarını güncelle
            document.getElementById('avgPerClient').textContent = formatCurrency(avgPerClient) + ' TL';
            document.getElementById('highestClientValue').textContent = formatCurrency(highestClient.total) + ' TL';
            document.getElementById('highestClientName').textContent = highestClient.name;
            document.getElementById('lowestClientValue').textContent = formatCurrency(lowestClient.total) + ' TL';
            document.getElementById('lowestClientName').textContent = lowestClient.name;
            document.getElementById('clientVariation').textContent = clientVariation + '%';
        }

        function updatePredictionsData() {
            const personChecked = document.getElementById('predictionsPersonFilter').checked;
            const companyChecked = document.getElementById('predictionsCompanyFilter').checked;
            const filteredClients = getFilteredClients(personChecked, companyChecked);
            
            calculatePredictions(filteredClients);
        }

        // ========== ENTITY FILTER CHECKBOXES EVENT LISTENERS SONU ==========

        // ========== FİLTRELEME SİSTEMİ ==========

        // Filtreleme için kayıtlı müvekkil select2'yi yükle
        function loadFilterRegisteredClients() {
            fetch('/api/get_registered_payment_clients')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = $('#filterRegisteredClient');

                        // Mevcut seçenekleri temizle (placeholder hariç)
                        select.find('option:not(:first)').remove();

                        // Yeni seçenekleri ekle
                        data.clients.forEach(client => {
                            const option = new Option(client.display_text, client.id, false, false);
                            select.append(option);
                        });

                        // Select2 initialize et
                        select.select2({
                            placeholder: 'Tüm Müvekkiller',
                            allowClear: true,
                            language: {
                                noResults: function() {
                                    return "Sonuç bulunamadı";
                                },
                                searching: function() {
                                    return "Aranıyor...";
                                }
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Filtreleme için kayıtlı müvekkiller yüklenirken hata:', error);
                });
        }

        // Sayfa yüklendiğinde filtreleme select2'yi yükle
        loadFilterRegisteredClients();

        // Filtreleme fonksiyonu
        function applyFilters() {
            const entityFilter = document.getElementById('filterEntityType').value;
            const statusFilter = document.getElementById('filterPaymentStatus').value;
            const clientFilter = $('#filterRegisteredClient').val();

            const rows = document.querySelectorAll('.data-table tbody tr');

            rows.forEach(row => {
                let showRow = true;

                // Kişi/Kurum filtresi
                if (entityFilter !== 'all') {
                    const entityType = row.getAttribute('data-entity-type');
                    if (entityType !== entityFilter) {
                        showRow = false;
                    }
                }

                // Ödeme durumu filtresi
                if (statusFilter !== 'all') {
                    const status = row.getAttribute('data-status');
                    const statusMatch = (statusFilter === 'paid' && status === 'Ödendi') ||
                                      (statusFilter === 'unpaid' && status === 'Ödenmedi');
                    if (!statusMatch) {
                        showRow = false;
                    }
                }

                // Kayıtlı müvekkil filtresi
                if (clientFilter) {
                    const paymentClientId = row.getAttribute('data-payment-client-id');
                    if (paymentClientId !== clientFilter) {
                        showRow = false;
                    }
                }

                // Satırı göster/gizle
                row.style.display = showRow ? '' : 'none';
            });
        }

        // Filtre değişikliklerini dinle
        document.getElementById('filterEntityType').addEventListener('change', applyFilters);
        document.getElementById('filterPaymentStatus').addEventListener('change', applyFilters);
        $('#filterRegisteredClient').on('change', applyFilters);

        // Filtreleri temizle butonu
        document.getElementById('clearFiltersBtn').addEventListener('click', function() {
            document.getElementById('filterEntityType').value = 'all';
            document.getElementById('filterPaymentStatus').value = 'all';
            $('#filterRegisteredClient').val('').trigger('change');
            applyFilters();
        });

        // ========== FİLTRELEME SİSTEMİ SONU ==========

    </script>



    <style>
    /* Modern Tablo Tasarımı */
    .modern-table {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: none;
    }

    .modern-header {
        background: linear-gradient(135deg, #2d313c 0%, #3c404d 100%);
        color: white;
    }

    .modern-header th {
        border: none;
        padding: 1rem 0.75rem;
        font-weight: 600;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }

    .header-content {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.5rem;
    }

    .header-content i.material-icons {
        font-size: 1.1rem;
        opacity: 0.7;
    }

    .header-content .sort-icon {
        margin-left: auto;
        opacity: 0.5;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .sortable-header:hover .sort-icon {
        opacity: 1;
        transform: scale(1.1);
    }

    .sortable-header {
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .sortable-header:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .action-header .header-content {
        justify-content: center;
    }

    /* Tablo satırları için modern stil */
    .modern-table tbody tr {
        transition: all 0.3s ease;
        border-bottom: 1px solid #e9ecef;
    }

    .modern-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .modern-table tbody td {
        padding: 1rem 0.75rem;
        vertical-align: middle;
        border: none;
    }

    /* Input boyutları için ek stil */
    .input-group input[type="text"]#amount {
        min-width: 150px !important;
        flex: 3 !important;
    }

    .input-group select#currency {
        max-width: 80px !important;
        flex: 1 !important;
    }

            /* MODERN ÖDEME MODAL CSS */
        .modern-payment-modal {
            border: none;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        .modern-payment-header {
            background: linear-gradient(135deg, #2d313c 0%, #383e4a 100%);
            border: none;
            padding: 24px 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .modal-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .modal-icon .material-icons {
            color: white;
            font-size: 24px;
        }

        .header-text .modal-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0 0 4px 0;
        }

        .modal-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            margin: 0;
        }

        .modern-close {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            padding: 0;
        }

        .modern-close .material-icons {
            color: white;
            font-size: 20px;
        }

        .modern-close:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .modern-payment-body {
            padding: 28px;
            background: #f8f9fa;
        }

        .payment-card {
            background: white;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .main-card .card-header {
            padding: 24px;
            border-bottom: 1px solid #f1f3f4;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .client-avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .client-avatar .material-icons {
            color: #2d313c;
            font-size: 32px;
        }

        .client-details {
            flex: 1;
        }

        .client-name {
            margin: 0 0 4px 0;
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d313c;
        }

        .client-tc {
            margin: 0;
            color: #6c757d;
            font-size: 0.875rem;
        }

        .payment-status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .payment-status-badge.paid {
            background: #d4edda;
            color: #155724;
        }

        .payment-status-badge.unpaid {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-status-badge .material-icons {
            font-size: 18px;
        }

        .main-card .card-body {
            padding: 24px;
        }

        .amount-section {
            text-align: center;
        }

        .amount-label {
            color: #6c757d;
            font-size: 0.875rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .amount-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: #2d313c;
            margin-bottom: 6px;
        }

        .installment-info {
            color: #6c757d;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .info-card {
            padding: 24px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-item {
            display: flex;
            gap: 12px;
        }

        .info-item.full-width {
            grid-column: 1 / -1;
        }

        .info-icon {
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .info-icon .material-icons {
            color: #2d313c;
            font-size: 20px;
        }

        .info-content {
            flex: 1;
        }

        .info-label {
            color: #6c757d;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-value {
            color: #2d313c;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .due-date-value {
            color: #dc3545 !important;
            font-weight: 700;
        }

        .info-item.date-item {
            /* Tarihlerin yan yana görünmesi için */
        }

        .description-text {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #2d313c;
            font-style: italic;
        }

        .modern-payment-footer {
            background: white;
            border: none;
            padding: 20px 28px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modern-payment-footer .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .modern-edit-btn {
            background: #2d313c !important;
            border-color: #2d313c !important;
        }

        .modern-edit-btn:hover {
            background: #3a4048 !important;
            border-color: #3a4048 !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 49, 60, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modern-payment-header {
                padding: 20px;
            }

            .modern-payment-body {
                padding: 20px;
            }

            .main-card .card-header {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .info-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .amount-value {
                font-size: 1.5rem;
            }

            .modern-payment-footer {
                padding: 20px;
                flex-direction: column;
            }
        }
    </style>
{% endblock %}